<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"8.0.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>

  <meta name="description" content="简单记录下">
<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="简单记录下">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="daxun">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Hexo</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Hexo</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">简单记录下</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">daxun</p>
  <div class="site-description" itemprop="description">简单记录下</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
        
          <span class="site-state-item-count">87</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">
      

      
    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/23/%E9%80%86%E5%90%91-HOOK&%E6%B3%A8%E5%85%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/23/%E9%80%86%E5%90%91-HOOK&%E6%B3%A8%E5%85%A5/" class="post-title-link" itemprop="url">逆向-HOOK&注入</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-10-23 19:16:00 / 修改时间：21:57:11" itemprop="dateCreated datePublished" datetime="2022-10-23T19:16:00+08:00">2022-10-23</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>改变代码的执行流程，执行自己的代码</p>
<h4 id="Hook"><a href="#Hook" class="headerlink" title="Hook"></a>Hook</h4><h5 id="Method-Swizzling"><a href="#Method-Swizzling" class="headerlink" title="Method Swizzling"></a>Method Swizzling</h5><p>Objective-C 中调用一个方法，实则是向一个对象发送消息，查找消息的唯一依据是 selector 名字</p>
<p>每个类都有一个方法列表，存放着 selector 和 IMP 的映射关系。IMP 有点类似函数指针，指向具体的 Method 实现</p>
<p>利用 OC runtime 特性，动态改变 SEL 和 IMP 对应关系，达到 OC 方法调用流程改变的目的</p>
<p>method_exchangeImplementation</p>
<blockquote>
<p>ZKSwizzle 库</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">InjectCode</span></span></span><br><span class="line">+(<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="comment">//WCAccountMainLoginViewController onNext</span></span><br><span class="line">    Method onNext = class_getInstanceMethod(objc_getClass(<span class="string">&quot;WCAccountMainLoginViewController&quot;</span>), <span class="keyword">@selector</span>(onNext));</span><br><span class="line">    Method my_next = class_getInstanceMethod(<span class="keyword">self</span>, <span class="keyword">@selector</span>(my_next));</span><br><span class="line">    method_exchangeImplementations(onNext, my_next);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//id self , SEL _cmd</span></span><br><span class="line">-(<span class="keyword">void</span>)my_next&#123;</span><br><span class="line">    <span class="built_in">NSString</span> * pwd = [[[<span class="keyword">self</span> valueForKey:<span class="string">@&quot;_textFieldUserPwdItem&quot;</span>]valueForKey:<span class="string">@&quot;m_textField&quot;</span>] performSelector:<span class="keyword">@selector</span>(text)];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;密码是！%@&quot;</span>,pwd);<span class="comment">//破坏！</span></span><br><span class="line">    <span class="comment">//self:当前方法的调用者！</span></span><br><span class="line">    [<span class="keyword">self</span> my_next];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">+(<span class="keyword">void</span>)load</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//GET &amp; SET</span></span><br><span class="line">    Method onNext = class_getInstanceMethod(objc_getClass(<span class="string">&quot;WCAccountMainLoginViewController&quot;</span>), sel_registerName(<span class="string">&quot;onNext&quot;</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//1.保存原始的IMP</span></span><br><span class="line">    old_onNext = method_getImplementation(onNext);</span><br><span class="line">    <span class="comment">//2.SET</span></span><br><span class="line">    method_setImplementation(onNext, (IMP)my_next);</span><br><span class="line">&#125;</span><br><span class="line">IMP (*old_onNext)(<span class="keyword">id</span> <span class="keyword">self</span>,SEL _cmd);</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> my_next(<span class="keyword">id</span> <span class="keyword">self</span>,SEL _cmd)&#123;</span><br><span class="line">    <span class="built_in">NSString</span> * pwd = [[[<span class="keyword">self</span> valueForKey:<span class="string">@&quot;_textFieldUserPwdItem&quot;</span>]valueForKey:<span class="string">@&quot;m_textField&quot;</span>] performSelector:<span class="keyword">@selector</span>(text)];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;密码是！%@&quot;</span>,pwd);<span class="comment">//破坏！</span></span><br><span class="line">    <span class="comment">//调用原来的方法</span></span><br><span class="line">    old_onNext(<span class="keyword">self</span>,_cmd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="MSHookMessageEx"><a href="#MSHookMessageEx" class="headerlink" title="MSHookMessageEx"></a>MSHookMessageEx</h5><p>Cydia Substrate 框架提供了 MSHookMessageEx 函数，利用运行时机制对 Objective-C 方法进行替换</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">_class：要Hook的OC方法的类名</span></span><br><span class="line"><span class="comment">message：要Hook的OC方法</span></span><br><span class="line"><span class="comment">hook：替换后的实现方法地址</span></span><br><span class="line"><span class="comment">old：原方法的地址，若无须调用原方法，可以设为NULL</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">void</span> MSHookMessageEx(Class _<span class="keyword">class</span>, SEL message, IMP hook, IMP *old)</span><br><span class="line">  </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> (*oldViewDidLoad)(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd);</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> newViewDidLoad(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd)&#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;call %s&quot;</span>, __FUNCTION__);</span><br><span class="line">  (*oldViewDidLoad)(<span class="keyword">self</span>, _cmd);</span><br><span class="line">&#125;</span><br><span class="line">MSHookMessageEx(objc_getClass(<span class="string">&quot;ViewController&quot;</span>),<span class="keyword">@selector</span>(viewDidLoad),</span><br><span class="line">               (IMP)&amp;newViewDidLoad, (IMP*)&amp;oldViewDidLoad);</span><br></pre></td></tr></table></figure>

<p>实际使用中通常不会直接使用 MSHookMessageEx Theos 的 Logos 语法已经对 MSHookMessageEx 进行了封装</p>
<h5 id="Inline-Hook"><a href="#Inline-Hook" class="headerlink" title="Inline Hook"></a>Inline Hook</h5><p>因为 C/C++ 没有运行时机制提供这些高级 API 来直接替换方法实现，所以 Method Swizzling 对它是无效的，需要使用 Inline Hook 才能达到目的。</p>
<p>修改函数的前 N 字节内存，使其跳转到自己编写的函数，这样原函数的逻辑就被新函数接管了，同时还应保存原函数的前 N 字节，以便在需要时能正确恢复原来的汇编代码从而执行原始逻辑</p>
<p>Cydia Substrate 框架提供了 MSHookFunction 函数来完成 InlineHook</p>
<h5 id="MSHookFunction"><a href="#MSHookFunction" class="headerlink" title="MSHookFunction"></a>MSHookFunction</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">symbol：需要hook的地址，该地址不局限于函数头，也可以是函数内部的任意地址</span></span><br><span class="line"><span class="comment">hook：替换后的函数地址</span></span><br><span class="line"><span class="comment">old：保存被Hook函数的原始代码，若不需要调用原函数，可以设为NULL</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">void</span> MSHookFunction(<span class="keyword">void</span> *symbol, <span class="keyword">void</span> *hook, <span class="keyword">void</span> **old)</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *(pfn_getenv)(<span class="keyword">char</span> *key);</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *my_getenv(<span class="keyword">char</span> *key)&#123;</span><br><span class="line">  <span class="keyword">return</span> pfn_getenv(key);</span><br><span class="line">&#125;</span><br><span class="line">%ctor &#123;</span><br><span class="line">  MSHookFunction((<span class="keyword">void</span> *)getenv,(<span class="keyword">void</span> *)&amp;my_getenv, (<span class="keyword">void</span>**)&amp;pfn_getenv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="fishhook"><a href="#fishhook" class="headerlink" title="fishhook"></a>fishhook</h5><p>动态修改链接 MachO 文件的工具，利用 MachO 文件加载原理，通过修改懒加载和非懒加载两个表的指针达到C函数hook的目的</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> rebinding(</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;  <span class="comment">//字符串名称</span></span><br><span class="line">  <span class="keyword">void</span> *replacement; <span class="comment">//替换后的函数</span></span><br><span class="line">  <span class="keyword">void</span> **replaced;	 <span class="comment">//原始函数</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&quot;fishhook&quot;</span></span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *(*orig_getenv)(<span class="keyword">const</span> <span class="keyword">char</span> *name);</span><br><span class="line"><span class="keyword">char</span> *my_getenv(<span class="keyword">const</span> <span class="keyword">char</span> *name)&#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;++++ name=%s&quot;</span>, name);</span><br><span class="line">  <span class="keyword">return</span> orig_getenv(name);</span><br><span class="line">&#125;</span><br><span class="line">__attribute__((constructor) <span class="keyword">static</span> <span class="keyword">void</span> PiaoYun(<span class="keyword">void</span>)) &#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;inject success&quot;</span>);</span><br><span class="line">  rebind_symbols(<span class="keyword">struct</span> rebinding[<span class="number">1</span>]&#123;</span><br><span class="line">    &#123;<span class="string">&quot;getenv&quot;</span>, (<span class="keyword">void</span>*)my_getenv,(<span class="keyword">void</span>**)&amp;orig_getenv&#125;</span><br><span class="line">  &#125;, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import fishhook</span></span><br><span class="line"><span class="comment">//NSLog的定义是 void NSLog(NSString *format, ...)</span></span><br><span class="line"><span class="comment">//原始方法 函数指针 保存原来方法地址</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span>(*sys_nslog)(<span class="built_in">NSString</span> *format, ...);</span><br><span class="line"><span class="comment">//定义一个新的函数</span></span><br><span class="line"><span class="keyword">void</span> myNSLog(<span class="built_in">NSString</span> *format, ...) &#123;</span><br><span class="line">	format = [format stringByAppendingString: <span class="string">@&quot;勾上了 \n&quot;</span>];</span><br><span class="line">	<span class="comment">//调用原始的</span></span><br><span class="line">	sys_nslog(format);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> rebinding &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *name; <span class="comment">//需要hook的函数名称，c字符串</span></span><br><span class="line">  <span class="keyword">void</span> *replacement; <span class="comment">//新函数地址</span></span><br><span class="line">  <span class="keyword">void</span> **replaced; <span class="comment">//原函数地址的指针</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// arg1:存放 rebinding 结构体的数组</span></span><br><span class="line"><span class="comment">// arg2:数组长度</span></span><br><span class="line"><span class="keyword">int</span> rebind_symbols(<span class="keyword">struct</span> rebinding rebindings[], size_t rebindings_nel);</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> rebinding nslog;</span><br><span class="line">nslog.name = <span class="string">&quot;NSLog&quot;</span>;</span><br><span class="line">nslog.replacement = myNSLog;</span><br><span class="line">nslog.replaced = (<span class="keyword">void</span> **)&amp;sys_nslog;<span class="comment">//(void **)是为了不报错</span></span><br><span class="line"><span class="comment">//定义数组</span></span><br><span class="line"><span class="keyword">struct</span> rebinding rebs[<span class="number">1</span>] = &#123;nslog&#125;;</span><br><span class="line">rebind_symbols(rebs, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>



<h5 id="HookZz"><a href="#HookZz" class="headerlink" title="HookZz"></a>HookZz</h5><p>由 jmpews 开发的一套 Hook 框架，支持 iOS、Android 平台下的 ARM、ARM64 架构</p>
<p><a target="_blank" rel="noopener" href="https://github.com/jmpews/HookZz">https://github.com/jmpews/HookZz</a></p>
<p>下载后编译成静态库或动态库即可，可以放到 /opt/theos/vendor 目录下，利用 Theos 的 tweak 模板进行编译、安装</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;hookzz.h&gt;</span></span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *(*orig_getenv)(<span class="keyword">const</span> <span class="keyword">char</span> *name);</span><br><span class="line"><span class="keyword">char</span> *my_getenv(<span class="keyword">const</span> <span class="keyword">char</span> *name)&#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;++++ name=%s&quot;</span>, name);</span><br><span class="line">  <span class="keyword">return</span> orig_getenv(name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> hook_getenv()&#123;</span><br><span class="line">  ZzReplace((<span class="keyword">void</span> *)getenv, (<span class="keyword">void</span>*)my_getenv, (<span class="keyword">void</span>**)&amp;orig_getenv);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__((constructor) <span class="keyword">static</span> <span class="keyword">void</span> PiaoYun(<span class="keyword">void</span>)) &#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;inject success&quot;</span>);</span><br><span class="line">  hook_getenv();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改 Makefile 文件，链接 HookZz 静态库及去掉 CydiaSubstrate 依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HookZzTest_LDFLAGS &#x3D; -lhookzz #链接HookZz</span><br><span class="line">HookZzTest_LOGOS_DEFAULT_GENERATOR &#x3D; internal #不使用CydiaSubstrate</span><br></pre></td></tr></table></figure>

<h4 id="注入"><a href="#注入" class="headerlink" title="注入"></a>注入</h4><h5 id="准备-dylib"><a href="#准备-dylib" class="headerlink" title="准备 dylib"></a>准备 dylib</h5><p>使用 Theos 编译一个 test.dylib 的动态库</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((constructor)) <span class="keyword">static</span> <span class="keyword">void</span> entry() &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;__inject success__&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将生成的 test.dylib 拖入 MachOView，可以看到 LC_LOAD_DYLIB（CydiaSubstrate），即直接编译生成的 dylib 会依赖 CydiaSubstrate，对非越狱系统会因找不到依赖库而闪退</p>
<p>也可以用 otool 查看动态库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ otool -L test.dylib</span><br></pre></td></tr></table></figure>

<p>可以看到依赖 /Library/Frameworks/CydiaSubstrate.framework/CydiaSubstrate </p>
<h6 id="去掉-CydiaSubstrate-依赖"><a href="#去掉-CydiaSubstrate-依赖" class="headerlink" title="去掉 CydiaSubstrate 依赖"></a>去掉 CydiaSubstrate 依赖</h6><p>修改 Makefile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 去掉 CydiaSubstrate 依赖</span><br><span class="line">test_USE_SUBSTRATE &#x3D; NO</span><br><span class="line"></span><br><span class="line"># 添加版本号，用于解决签名后闪退问题</span><br><span class="line">_THEOS_TARGET_LDFLAGS +&#x3D; -current_version 1.0</span><br><span class="line">_THEOS_TARGET_LDFLAGS +&#x3D; -compatibility_version 1.0</span><br></pre></td></tr></table></figure>

<p>再次编译后 test.dylib 文件已经没有了 CydiaSubstrate 依赖了</p>
<h5 id="yololib"><a href="#yololib" class="headerlink" title="yololib"></a>yololib</h5><p>下载地址  <a target="_blank" rel="noopener" href="https://github.com/KJCracks/yololib">https://github.com/KJCracks/yololib</a>   编译后放到 /usr/local/bin 目录下</p>
<p>将 test.dylib 复制到 AVPlayer.app 目录下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yololib .&#x2F;Payload&#x2F;AVPlayer.app&#x2F;AVPlayer test.dylib</span><br></pre></td></tr></table></figure>

<p>执行完，可以用 MachOView 确认下，找到 LC_LOAD_DYLIB（test.dylib），路径值是@executable_path/test.dylib</p>
<h5 id="optool"><a href="#optool" class="headerlink" title="optool"></a>optool</h5><p>optool 功能比 yololib 强大的多，不但能添加动态库，还能将已存在的动态库删除</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git clone https:&#x2F;&#x2F;github.com&#x2F;alexzielenski&#x2F;optool.git</span><br><span class="line">$ cd optool</span><br><span class="line">$ git submodule update --init --recursive #使用 --recursive将子模块全部clone下来</span><br></pre></td></tr></table></figure>

<p>编译后得到可执行文件放到 /usr/local/bin 目录下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#添加dylib依赖</span><br><span class="line">$ optool install -c load -p &quot;@executable_path&#x2F;test.dylib&quot; -t .&#x2F;Payload&#x2F;AVPlayer.app&#x2F;AVPlayer</span><br><span class="line"></span><br><span class="line">#删除依赖</span><br><span class="line">$ optool uninstall -p &quot;@executable_path&#x2F;test.dylib&quot; -t .&#x2F;Payload&#x2F;AVPlayer.app&#x2F;AVPlayer</span><br></pre></td></tr></table></figure>




































      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/21/LLDB-debugserver/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/21/LLDB-debugserver/" class="post-title-link" itemprop="url">未命名</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-10-21 15:26:13" itemprop="dateCreated datePublished" datetime="2022-10-21T15:26:13+08:00">2022-10-21</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-10-22 12:10:40" itemprop="dateModified" datetime="2022-10-22T12:10:40+08:00">2022-10-22</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="debugserver"><a href="#debugserver" class="headerlink" title="debugserver"></a>debugserver</h4><p>LLDB 只能运行在 macOS 上，若要调试 iOS 应用，需要在设备上运行 debugserver </p>
<p>远程调试中，LLDB 可以看作客户端，安装在 macOS 上；debugserver 可以看作服务端，在 iOS 上运行，用于接受 LLDB 命令并执行，再把执行结果返回 LLDB</p>
<p>iOS 设备上没有安装debugserver，设备连接xcode后，debugserver才会被 Xcode 安装到设备的 /Develope/usr/bin 目录下</p>
<p>因为缺少task_for_pid 权限 通过 Xcode 安装的 debugserver 只能调试我们自己的App</p>
<h5 id="debugserver-配置"><a href="#debugserver-配置" class="headerlink" title="debugserver 配置"></a>debugserver 配置</h5><h6 id="配置方式1"><a href="#配置方式1" class="headerlink" title="配置方式1"></a>配置方式1</h6><p>获取 debugserver，将设备上的 debugserver 拷贝到电脑上添加权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ iproxy 2222 22 #进行端口转发</span><br><span class="line">$ scp -P 2222 root@localhost:&#x2F;Developer&#x2F;usr&#x2F;bin&#x2F;debugserver ~&#x2F;Desktop</span><br></pre></td></tr></table></figure>

<p>瘦身，只保留 arm64 平台</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lipo -info debugserver</span><br><span class="line">lipo -thin arm64 debugserver -output debugserver</span><br><span class="line">file debugserver</span><br></pre></td></tr></table></figure>

<p>添加权限 task_for_pid 权限，才能调试其它APP，ldid 在 theos/bin 目录下，或者 brew install ldid</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ldid -e debugserver &#x2F;&#x2F; 查看 debugserver</span><br><span class="line">ldid -e debugserver &gt; entitlement.plist &#x2F;&#x2F;输出 entitlement.plist</span><br></pre></td></tr></table></figure>

<p>打开 entitlement.plist 文件 添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">task_for_pid-allow  Boolean 1</span><br><span class="line">get-task-allow      Boolean 1</span><br></pre></td></tr></table></figure>

<p>重签名 debugserver</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ldid -Sentitlement.plist debugserver &#x2F;&#x2F;重签名</span><br><span class="line">ldid -e debugserver &#x2F;&#x2F;再次查看 debugserver 内容</span><br></pre></td></tr></table></figure>

<p>/Developer/usr/bin目录下的debugserver是只读的 所以将处理好的debugserver拷贝到/usr/bin目录下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -P 2222 debugserver root@localhost:&#x2F;usr&#x2F;bin&#x2F;</span><br></pre></td></tr></table></figure>

<h6 id="配置方式2"><a href="#配置方式2" class="headerlink" title="配置方式2"></a>配置方式2</h6><p>新建 ent.xml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ touch ent.xml</span><br></pre></td></tr></table></figure>

<p>拷贝内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE plist PUBLIC &quot;-&#x2F;&#x2F;Apple&#x2F;&#x2F;DTD PLIST 1.0&#x2F;&#x2F;EN&quot; &quot;http:&#x2F;&#x2F;www.apple.com&#x2F;DTDs&#x2F;PropertyList-1.0.dtd&quot;&gt;</span><br><span class="line">&lt;plist version&#x3D;&quot;1.0&quot;&gt;</span><br><span class="line">&lt;dict&gt;</span><br><span class="line">        &lt;key&gt;com.apple.springboard.debugapplications&lt;&#x2F;key&gt;</span><br><span class="line">        &lt;true&#x2F;&gt;</span><br><span class="line">        &lt;key&gt;get-task-allow&lt;&#x2F;key&gt;</span><br><span class="line">        &lt;true&#x2F;&gt;</span><br><span class="line">        &lt;key&gt;task_for_pid-allow&lt;&#x2F;key&gt;</span><br><span class="line">        &lt;true&#x2F;&gt;</span><br><span class="line">        &lt;key&gt;run-unsigned-code&lt;&#x2F;key&gt;</span><br><span class="line">        &lt;true&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;dict&gt;</span><br><span class="line">&lt;&#x2F;plist&gt;</span><br></pre></td></tr></table></figure>

<p>再用 ent.xml 重签名 debugserver</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldid -Sent.xml debugserver</span><br></pre></td></tr></table></figure>

<ul>
<li>或者用 codesign 来签名</li>
</ul>
<p>新建 ent.plist ，内容是 ent.xml 的内容，再执行 codesign 命令签名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codesign -s - --entitlements ent.plist -f debugserver</span><br></pre></td></tr></table></figure>



<h5 id="debugserver-启动"><a href="#debugserver-启动" class="headerlink" title="debugserver 启动"></a>debugserver 启动</h5><p>ssh 连接上设备</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ iproxy 2222 22</span><br><span class="line">$ ssh -p 2222 root@localhost</span><br></pre></td></tr></table></figure>

<p>iOS设备上，查找应用进程名称</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root# ps -e</span><br></pre></td></tr></table></figure>

<p>debugserver 可以直接启动和附加进程 </p>
<h6 id="启动进程"><a href="#启动进程" class="headerlink" title="启动进程"></a>启动进程</h6><p>启动WeChat进程，并开启1234端口号，等待所有IP地址的LLDB连接</p>
<p>这里如果是iOS12以上系统IP地址只能设置成127.0.0.1，然后使用USB连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root# debugserver -x backboard *:1234 -a WeChat</span><br></pre></td></tr></table></figure>

<h6 id="附加进程"><a href="#附加进程" class="headerlink" title="附加进程"></a>附加进程</h6><p>附加到WeChat进程，并开启1234端口号，等待所有IP地址的LLDB连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root# debugserver *:1234 -a WeChat</span><br></pre></td></tr></table></figure>

<p>启动或附加进程后，iOS 设备就会等待 macOS 终端 LLDB 的接入</p>
<h5 id="LLDB-连接-debugserver"><a href="#LLDB-连接-debugserver" class="headerlink" title="LLDB 连接 debugserver"></a>LLDB 连接 debugserver</h5><p>端口转发</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iproxy 1234 1234</span><br></pre></td></tr></table></figure>

<p>LLDB 连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$lldb</span><br><span class="line">(lldb)process connect connect:127.0.0.1:1234</span><br><span class="line">或者</span><br><span class="line">(lldb)process connect connect:localhost:1234</span><br></pre></td></tr></table></figure>

<p>就连接上 LLDB 调试了，APP 自动处于断点状态，c 继续</p>
<h4 id="LLDB"><a href="#LLDB" class="headerlink" title="LLDB"></a>LLDB</h4><h5 id="ASLR"><a href="#ASLR" class="headerlink" title="ASLR"></a>ASLR</h5><p>获取 ASLR（地址空间布局随机化）偏移值，也叫模块基地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ image list -o -f</span><br></pre></td></tr></table></figure>

<p>由于 ASLR 的存在，实际加载地址每次都会不同，这是 iOS 的一种保护机制</p>
<p>函数实际内存地址 = ASLR 偏移量 + IDA 中显示的文件偏移</p>
<h5 id="断点"><a href="#断点" class="headerlink" title="断点"></a>断点</h5><p>breakpoint 可以简写为 br，设置断点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(lldb) breakpoint set -a 0x10021d084</span><br><span class="line">(lldb) br s -a 0x10021d084  &#x2F;&#x2F;简写 br s</span><br><span class="line">(lldb) continue 					  &#x2F;&#x2F;继续执行，简写 c</span><br><span class="line">(lldb) br list						  &#x2F;&#x2F;列出所有断点</span><br></pre></td></tr></table></figure>

<ul>
<li>禁用/启用/删除断点</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(lldb) br disable 1 &#x2F;&#x2F;后面是断点序号</span><br><span class="line">(lldb) br enable  1</span><br><span class="line">(lldb) br delete  1</span><br><span class="line">(lldb) br delete    &#x2F;&#x2F;清空断点</span><br></pre></td></tr></table></figure>

<ul>
<li>断点上加命令</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(lldb) breakpoint command add 2(断点组号)</span><br><span class="line">&gt; po self</span><br><span class="line">&gt; p self.view</span><br><span class="line">&gt; DONE</span><br></pre></td></tr></table></figure>



<h5 id="给方法添加断点"><a href="#给方法添加断点" class="headerlink" title="给方法添加断点"></a>给方法添加断点</h5><p>-n 是 name 的缩写</p>
<p>p 命令：p 是打印非对象的值，expression 的缩写，打印对象的话会打印对象的地址；如果打印非对象，会打印出基本变量类型的值；也可声明一个变量：p int $a = 10</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(lldb) br [ViewController viewDidLoad]   &#x2F;&#x2F;给类方法添加断点</span><br><span class="line">(lldb) b -[ViewController hankTest1:]</span><br><span class="line">(lldb) br NSLog													 &#x2F;&#x2F;给NSLog方法添加断点</span><br><span class="line">(lldb) br set -n &quot;[ViewController save:]&quot; -n &quot;[ViewCont roller pauseGame:]&quot;</span><br><span class="line">(lldb) br set --selector touchBegan:withEvent: &#x2F;&#x2F;方法断点</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;当前文件方法添加断点</span><br><span class="line">(lldb) set --file ViewController.m --selector touchBegan:withEvent:</span><br><span class="line">&#x2F;&#x2F;遍历查找带Game字段的方法打断点</span><br><span class="line">(lldb) br set -r Game:</span><br></pre></td></tr></table></figure>

<h5 id="单步执行"><a href="#单步执行" class="headerlink" title="单步执行"></a>单步执行</h5><p>si 和 ni 是汇编级别的，s（进入子函数）和 n（单步往下走）是源码级别的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(lldb) nexti 		&#x2F;&#x2F;单步执行，简写 ni</span><br><span class="line">(lldb) setpi	  &#x2F;&#x2F;单步执行，遇到子函数进入，简写 si</span><br><span class="line">(lldb) finish   &#x2F;&#x2F;完成功能并退出子函数，</span><br><span class="line">(lldb) return   &#x2F;&#x2F;直接退出子函数，原始代码不会调用（如反-反调试中跳过检测函数）</span><br></pre></td></tr></table></figure>

<h5 id="寄存器读取修改"><a href="#寄存器读取修改" class="headerlink" title="寄存器读取修改"></a>寄存器读取修改</h5><p>LLDB 中操作寄存器的命令 register</p>
<p>读取寄存器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) register read $x0</span><br></pre></td></tr></table></figure>

<p>修改寄存器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) register write $x4 1</span><br></pre></td></tr></table></figure>

<h5 id="打印操作"><a href="#打印操作" class="headerlink" title="打印操作"></a>打印操作</h5><p>po 命令用于打印 Objective-C 对象，以对象格式打印结果</p>
<p>p 命令输出原生类型（boolean、integer、float）等，可以指定输出格式</p>
<p>expression、expr、e 后面可以执行一段代码</p>
<p>print、prin、pri、p 是 expression –的缩写，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(lldb) po $x0</span><br><span class="line">&lt;XLMemberManager:0x14f6a9f30&gt;</span><br><span class="line">(lldb) po [$0 config]  &#x2F;&#x2F;打印XLMemberManager类的config属性</span><br><span class="line">(lldb) x&#x2F;s $x1			   &#x2F;&#x2F;以字符串读取x1寄存器（打印方法名可以用这个） </span><br><span class="line">(lldb) p(char *)$x1</span><br><span class="line"></span><br><span class="line">(lldb) p self.models.lastObject &#x2F;&#x2F;拿到某个对象</span><br><span class="line">(Person*)$2&#x3D;0x324234</span><br><span class="line">(lldb) p (Person *)self.models.lastObject</span><br><span class="line">(lldb) p $2.name&#x3D;@&quot;hank&quot;			  &#x2F;&#x2F;赋值</span><br><span class="line"></span><br><span class="line">(lldb) p&#x2F;c $5					 &#x2F;&#x2F;字符打印</span><br><span class="line">(lldb) p&#x2F;x $x2				 &#x2F;&#x2F;16进制打印 </span><br><span class="line">(lldb) p&#x2F;d $x3				 &#x2F;&#x2F;十进制打印</span><br><span class="line">(lldb) p&#x2F;t $x4				 &#x2F;&#x2F;二进制打印</span><br></pre></td></tr></table></figure>

<p>LLDB 上可以添加多行代码 alt + 回车</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p Person *p3 &#x3D; [[Person alloc] init];</span><br><span class="line">p3.age &#x3D; 10;</span><br><span class="line">p3.name &#x3D; @&quot;hank&quot;;</span><br></pre></td></tr></table></figure>



<h5 id="内存读写"><a href="#内存读写" class="headerlink" title="内存读写"></a>内存读写</h5><p>LLDB 操作内存命令 memory</p>
<ul>
<li>读取内存</li>
</ul>
<p>-c 指定要读取的字节</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(lldb) memory read $x0</span><br><span class="line">(lldb) memory read 0x0004f7c</span><br><span class="line">(lldb) memory read 0x0004f7c -c 100 </span><br><span class="line">(lldb) memory read 0x0004f7c 0x00004fcc &#x2F;&#x2F;按区间读取</span><br></pre></td></tr></table></figure>

<p>如果被读取的数据超过 1024 字节，就会出现错误，加入 –force 参数即可解决</p>
<ul>
<li>保存数据</li>
</ul>
<p>读取的内存数据可以使用 -outfile 参数保存到文件；如果只需要保存原始字节，加入 –binary</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(lldb) memory read 0x0004f7c -c 1025 --force -outfile &#x2F;tmp&#x2F;1.txt</span><br><span class="line"></span><br><span class="line">(lldb) memory read 0x0004f7c -c 1025 --force --binary -outfile &#x2F;tmp&#x2F;1.bin</span><br></pre></td></tr></table></figure>

<ul>
<li>修改内存</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) memory write 0x0004f7c 0x24</span><br></pre></td></tr></table></figure>

<ul>
<li>内存监视</li>
</ul>
<p>包括访问（read）、写入（write）、读写（read_write）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(lldb) watchpoint set expression -w read -- 0x0004f7c</span><br><span class="line">(lldb) watchpoint set expression -w write -- 0x0004f7c</span><br><span class="line">(lldb) watchpoint set expression -w read_write -- 0x0004f7c</span><br><span class="line">(lldb) watchpoint modify -c &#39;*(char*)0x0004f7c &#x3D;&#x3D; 20&#39;  &#x2F;&#x2F;指定条件监视</span><br></pre></td></tr></table></figure>

<p>和 br 断点一样，watchpoint 也有 disable/enable/delete 参数</p>
<h5 id="反汇编"><a href="#反汇编" class="headerlink" title="反汇编"></a>反汇编</h5><p>disassemble 简写 dis，反汇编指定地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(lldb) dis -a 0x0004f7c   &#x2F;&#x2F;-a 是地址</span><br><span class="line">(lldb) dis -n NSLog			  &#x2F;&#x2F;-n 需要反汇编的函数名称</span><br><span class="line">(lldb) dis -c 10 			    &#x2F;&#x2F;需要显示的指令数，10条</span><br><span class="line">(lldb) dis -s 0x1000066f4 -e 0x100006718 &#x2F;&#x2F;-s起始地址，-e结束地址</span><br></pre></td></tr></table></figure>

<h5 id="调用栈"><a href="#调用栈" class="headerlink" title="调用栈"></a>调用栈</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(lldb) bt</span><br><span class="line">(lldb) bt 2   &#x2F;&#x2F;打印2层调用栈</span><br><span class="line">frame #1 0x000001003a2260 ........</span><br></pre></td></tr></table></figure>

<p>看到 frame，1 对应地址 0x000001003a2260，用这地址减去 ASLR 的偏移量即得到文件的偏移地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p&#x2F;x 0x000001003a2260 - ASLR偏移量</span><br></pre></td></tr></table></figure>

<p>将得到的地址到 IDA 查看验证调用栈的正确性</p>
<h5 id="查找-C-函数"><a href="#查找-C-函数" class="headerlink" title="查找 C 函数"></a>查找 C 函数</h5><p>利用 lookup 查找 C 函数地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) image lookup -r -n ptrace</span><br></pre></td></tr></table></figure>

<p>有时候闪退的时候调用栈可以看到一些地址，用 lookup 查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) image lookup --address 0x0000000100000de0</span><br></pre></td></tr></table></figure>



<h4 id="Chisel"><a href="#Chisel" class="headerlink" title="Chisel"></a>Chisel</h4><p>LLDB 命令插件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">brew install chisel</span><br><span class="line">安装完成提示</span><br><span class="line">&#x3D;&#x3D;&gt; Caveats</span><br><span class="line">Add the following line to ~&#x2F;.lldbinit to load chisel when Xcode launches:</span><br><span class="line">command script import &#x2F;usr&#x2F;local&#x2F;opt&#x2F;chisel&#x2F;libexec&#x2F;fblldb.py</span><br></pre></td></tr></table></figure>

<p>还需要将 LLDB 和 chisel 关联起来，给 lldbinit 注入脚本，终端执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo command script import &#x2F;usr&#x2F;local&#x2F;opt&#x2F;chisel&#x2F;libexec&#x2F;fblldb.py &gt;&gt; ~&#x2F;.lldbinit</span><br></pre></td></tr></table></figure>

<h5 id="pviews"><a href="#pviews" class="headerlink" title="pviews"></a>pviews</h5><p>查看 view 层级</p>
<h5 id="pvc"><a href="#pvc" class="headerlink" title="pvc"></a>pvc</h5><p>打印 ViewController 层级</p>
<h5 id="fv-amp-fvc"><a href="#fv-amp-fvc" class="headerlink" title="fv&amp;fvc"></a>fv&amp;fvc</h5><p>通过类名搜索当前内存中存在的 view 和 viewController 实例的命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(lldb) fv bar</span><br><span class="line">0x7fed1f413e50 CYLTabBar</span><br><span class="line">0x7fed1f4140a0 _UIBarBackground</span><br><span class="line"></span><br><span class="line">(lldb) fvc bar</span><br><span class="line">0x7fed1f880c00 CYLTabBarController</span><br></pre></td></tr></table></figure>

<h5 id="border-amp-unborder"><a href="#border-amp-unborder" class="headerlink" title="border&amp;unborder"></a>border&amp;unborder</h5><p>添加/去除边框</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(lldb) border 0x79ec3140 -c green -w 2</span><br><span class="line">(lldb) unborder 0x148d0e180</span><br></pre></td></tr></table></figure>

<h5 id="pinternals"><a href="#pinternals" class="headerlink" title="pinternals"></a>pinternals</h5><p>这个命令就是打印出来的一个控件（id）类型的内部结构</p>
<h5 id="presponder"><a href="#presponder" class="headerlink" title="presponder"></a>presponder</h5><p>打印出一个集成于UIResponder控件的消息传递链</p>
<h5 id="visualize"><a href="#visualize" class="headerlink" title="visualize"></a>visualize</h5><p>可以使用mac下的预览app打开我们的图片UIImage, CGImageRef格式的图片，甚至view和layer的图片 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(lldb) visualize 0x79ec3140&#x2F;&#x2F;或者变量名，此地址是id类型的</span><br></pre></td></tr></table></figure>

<h5 id="pclass"><a href="#pclass" class="headerlink" title="pclass"></a>pclass</h5><p>打印出一个对象的继承关系</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">UIImageView</span><br><span class="line">	| UIView</span><br><span class="line">	|    | UIResponder</span><br><span class="line">	|    |    | NSObject</span><br></pre></td></tr></table></figure>

<h5 id="hide-amp-show"><a href="#hide-amp-show" class="headerlink" title="hide&amp;show"></a>hide&amp;show</h5><p>显示隐藏对象</p>
<h5 id="pactions"><a href="#pactions" class="headerlink" title="pactions"></a>pactions</h5><p>打印控件响应事件</p>
<h5 id="methods"><a href="#methods" class="headerlink" title="methods"></a>methods</h5><p>临时查看某个类的所有方法和内存地址</p>
<h5 id="search"><a href="#search" class="headerlink" title="search"></a>search</h5><p>类似 Cycript 中的 choose 功能，搜索某个实例对象</p>
<h5 id="bmessage"><a href="#bmessage" class="headerlink" title="bmessage"></a>bmessage</h5><p>对方法名设置断点。</p>
<h5 id="pdata"><a href="#pdata" class="headerlink" title="pdata"></a>pdata</h5><p>打印 NSData 数据</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/20/%E9%80%86%E5%90%91-%E5%B7%A5%E5%85%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/20/%E9%80%86%E5%90%91-%E5%B7%A5%E5%85%B7/" class="post-title-link" itemprop="url">逆向-工具</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-10-20 20:04:13 / 修改时间：20:04:19" itemprop="dateCreated datePublished" datetime="2022-10-20T20:04:13+08:00">2022-10-20</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/18/iOS%E9%BB%91%E5%AE%A2%E6%94%BB%E9%98%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/18/iOS%E9%BB%91%E5%AE%A2%E6%94%BB%E9%98%B2/" class="post-title-link" itemprop="url">iOS黑客攻防</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-10-18 22:00:02 / 修改时间：23:05:40" itemprop="dateCreated datePublished" datetime="2022-10-18T22:00:02+08:00">2022-10-18</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          输入密码
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/10/18/iOS%E9%BB%91%E5%AE%A2%E6%94%BB%E9%98%B2/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/07/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-7JavaScript%E5%8A%A8%E6%80%81%E6%B8%B2%E6%9F%93%E9%A1%B5%E9%9D%A2%E7%88%AC%E5%8F%962/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/07/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-7JavaScript%E5%8A%A8%E6%80%81%E6%B8%B2%E6%9F%93%E9%A1%B5%E9%9D%A2%E7%88%AC%E5%8F%962/" class="post-title-link" itemprop="url">Python3网络爬虫开发实战-7JavaScript动态渲染页面爬取2</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-10-07 15:22:04" itemprop="dateCreated datePublished" datetime="2022-10-07T15:22:04+08:00">2022-10-07</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-10-09 08:57:19" itemprop="dateModified" datetime="2022-10-09T08:57:19+08:00">2022-10-09</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="7-3-Pyppeteer-使用"><a href="#7-3-Pyppeteer-使用" class="headerlink" title="7.3 Pyppeteer 使用"></a>7.3 Pyppeteer 使用</h4><p>Puppeteer 是 Google 基于 Node.js 开发的一个工具，有了它，我们可以利用 JavaScript 控制 Chrome 浏览器的一些操作</p>
<p>Pyppeteer 其实就是 Puppeteer 的 Python 版实现</p>
<p>Pyppeteer 是依赖 Chromium 浏览器运行的，如果第一次运行 Pyppeteer 没有按照 Chromium 浏览器，程序会自动帮我们安装和配置好</p>
<p>Pyppeteer 是基于 Python 的新特性 async 实现的，所以它的一些操作执行也支持异步方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install pyppeteer</span><br></pre></td></tr></table></figure>

<h5 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> pyppeteer <span class="keyword">import</span> launch</span><br><span class="line"><span class="keyword">from</span> pyquery <span class="keyword">import</span> PyQuery <span class="keyword">as</span> pq</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">  browser = <span class="keyword">await</span> launch() <span class="comment">#启动浏览器</span></span><br><span class="line">  page = <span class="keyword">await</span> browser.newPage()</span><br><span class="line">  <span class="keyword">await</span> page.goto(<span class="string">&#x27;https://spa2.scrape.center/&#x27;</span>)  <span class="comment">#访问网站</span></span><br><span class="line">  <span class="keyword">await</span> page.waitForSelector(<span class="string">&#x27;.item .name&#x27;</span>) <span class="comment">#等待节点加载出来</span></span><br><span class="line">  doc = pq(<span class="keyword">await</span> page.content()) </span><br><span class="line">  <span class="comment">#通过pyquery从源码中提取电影名称输出</span></span><br><span class="line">  names = [item.text() <span class="keyword">for</span> item <span class="keyword">in</span> doc(<span class="string">&#x27;.item .name&#x27;</span>).items()]</span><br><span class="line">  print(<span class="string">&#x27;Names&#x27;</span>, names)</span><br><span class="line">  <span class="keyword">await</span> browser.close()</span><br><span class="line"></span><br><span class="line">asyncio.get_event_loop().run_until_complete(main())</span><br></pre></td></tr></table></figure>

<p>利用 Pyppeteer 可以控制浏览器执行几乎所有想实现的操作</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> pyppeteer <span class="keyword">import</span> launch</span><br><span class="line"></span><br><span class="line">width, height = <span class="number">1366</span>,<span class="number">768</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">  browser = <span class="keyword">await</span> launch()</span><br><span class="line">  page = <span class="keyword">await</span> browser.newPage()</span><br><span class="line">  <span class="keyword">await</span> page.setViewport(&#123;<span class="string">&#x27;width&#x27;</span>: width, <span class="string">&#x27;height&#x27;</span>: height&#125;)</span><br><span class="line">  <span class="keyword">await</span> page.goto(<span class="string">&#x27;https://spa2.scrape.center/&#x27;</span>)  <span class="comment">#访问网站</span></span><br><span class="line">  <span class="keyword">await</span> page.waitForSelector(<span class="string">&#x27;.item .name&#x27;</span>) <span class="comment">#等待节点加载出来</span></span><br><span class="line">  <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line">  <span class="keyword">await</span> page.screenshot(path=<span class="string">&#x27;example.png&#x27;</span>)</span><br><span class="line">  dimensions = <span class="keyword">await</span> page.evaluate(<span class="string">&#x27;&#x27;&#x27;()=&gt;&#123;</span></span><br><span class="line"><span class="string">  	return &#123;</span></span><br><span class="line"><span class="string">  		width:document.documentElement.clientWidth,</span></span><br><span class="line"><span class="string">  		height:document.documentElement.clientHeight,</span></span><br><span class="line"><span class="string">  		deviceScaleFactor:window.devicePixelRatio,</span></span><br><span class="line"><span class="string">  	&#125;</span></span><br><span class="line"><span class="string">  &#125;&#x27;&#x27;&#x27;</span>)</span><br><span class="line">  print(dimensions)</span><br><span class="line">  <span class="keyword">await</span> browser.close()</span><br><span class="line"></span><br><span class="line">asyncio.get_event_loop().run_until_complete(main())</span><br></pre></td></tr></table></figure>

<p>API 文档链接 <a target="_blank" rel="noopener" href="https://pyppeteer.github.io/pyppeteer/reference.html">https://pyppeteer.github.io/pyppeteer/reference.html</a></p>
<h5 id="Launch"><a href="#Launch" class="headerlink" title="Launch"></a>Launch</h5><h5 id="无头模式"><a href="#无头模式" class="headerlink" title="无头模式"></a>无头模式</h5><p>设置 handless=False 启动的时候就能看到页面了，默认 True，启动时看不到任何界面</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> launch(handless=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<h5 id="调试模式"><a href="#调试模式" class="headerlink" title="调试模式"></a>调试模式</h5><p>devtool=True 每开启一个页面就会弹出一个调试窗口，如果设置为 True，无头模式就会关闭，界面始终会显现出来</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">browser = <span class="keyword">await</span> launch(devtools=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h5 id="禁用提示条"><a href="#禁用提示条" class="headerlink" title="禁用提示条"></a>禁用提示条</h5><p>浏览器的提示，Chrome 正受到自动测试软件的控制</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">browser = <span class="keyword">await</span> launch(handless=<span class="literal">False</span>, args=[<span class="string">&#x27;--disable-infobars&#x27;</span>])</span><br></pre></td></tr></table></figure>

<h5 id="防止检测"><a href="#防止检测" class="headerlink" title="防止检测"></a>防止检测</h5><p>pyppeteer 的 Page 对象有一个叫作 evaluateOnNewDocument 方法，意思是每次加载网页的时候执行某条语句，这里可以利用它执行隐藏 webdriver 属性的命令</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> pyppeteer <span class="keyword">import</span> launch</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">  browser = <span class="keyword">await</span> launch(handless=<span class="literal">False</span>, args=[<span class="string">&#x27;--disable-infobars&#x27;</span>])</span><br><span class="line">  page = <span class="keyword">await</span> browser.newPage()</span><br><span class="line">  <span class="keyword">await</span> page.evaluateOnNewDocument(<span class="string">&#x27;Object.defineProperty(navigator, &quot;webdriver&quot;,&#123;get:()=&gt; undefined&#125;)&#x27;</span>)</span><br><span class="line">  <span class="keyword">await</span> page.goto(<span class="string">&#x27;https://antispider1.scrape.center/&#x27;</span>)</span><br><span class="line">  <span class="keyword">await</span> asyncio.sleep(<span class="number">100</span>)</span><br><span class="line">  </span><br><span class="line">asyncio.get_event_loop().run_until_complete(main())</span><br></pre></td></tr></table></figure>

<h5 id="页面大小设置"><a href="#页面大小设置" class="headerlink" title="页面大小设置"></a>页面大小设置</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">width, height = <span class="number">1366</span>,<span class="number">768</span></span><br><span class="line"><span class="keyword">await</span> page.setViewPort(&#123;<span class="string">&#x27;width&#x27;</span>: width, <span class="string">&#x27;height&#x27;</span>: height&#125;)</span><br></pre></td></tr></table></figure>

<h5 id="用户数据持久化"><a href="#用户数据持久化" class="headerlink" title="用户数据持久化"></a>用户数据持久化</h5><p>设置用户目录，启动浏览器的时候设置 userDataDir</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> pyppeteer <span class="keyword">import</span> launch</span><br><span class="line"></span><br><span class="line">browser = <span class="keyword">await</span> launch(handless=<span class="literal">False</span>, userDataDir=<span class="string">&#x27;./userdata&#x27;</span>,args=[<span class="string">&#x27;--disable-infobars&#x27;</span>])</span><br><span class="line">  page = <span class="keyword">await</span> browser.newPage()</span><br><span class="line">  <span class="keyword">await</span> page.goto(<span class="string">&#x27;https://www.taobao.com&#x27;</span>)</span><br><span class="line">  <span class="keyword">await</span> asyncio.sleep(<span class="number">100</span>)</span><br><span class="line">  </span><br><span class="line">asyncio.get_event_loop().run_until_complete(main())</span><br></pre></td></tr></table></figure>

<p>运行代码，登录淘宝，可以看到当前运行目录下多了一个 userdata 文件夹，再次运行发现淘宝已处于登录状态</p>
<h5 id="无痕模式"><a href="#无痕模式" class="headerlink" title="无痕模式"></a>无痕模式</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">width, height = <span class="number">1366</span>,<span class="number">768</span></span><br><span class="line">browser = <span class="keyword">await</span> launch(handless=<span class="literal">False</span>,args=[<span class="string">&#x27;--disable-infobars&#x27;</span>], <span class="string">f&#x27;--window-size=<span class="subst">&#123;width&#125;</span>,<span class="subst">&#123;height&#125;</span>&#x27;</span>)</span><br><span class="line">context = <span class="keyword">await</span> browser.createIncognitoBrowserContest()</span><br><span class="line">page = <span class="keyword">await</span> context.newPage()</span><br></pre></td></tr></table></figure>

<h5 id="Page"><a href="#Page" class="headerlink" title="Page"></a>Page</h5><h6 id="选择器"><a href="#选择器" class="headerlink" title="选择器"></a>选择器</h6><p>Page 对象内置了很多用于选取节点的选择器方法。</p>
<p>J 方法：传入一个选择器，就能返回匹配到的第一个节点，等价于 querySelector 方法；</p>
<p>JJ 方法，传入选择器，返回符合选择器的所有节点组成的列表，等价于 querySelectorAll</p>
<p>JJeval() 等价于 querySelectorAllEval()</p>
<p>Jeval() 等价于 querySelectorEval()</p>
<p>Jx() 等价于 xpath()</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> page.waitForSelector(<span class="string">&#x27;.item .name&#x27;</span>)</span><br><span class="line">j_result1 = <span class="keyword">await</span> page.J(<span class="string">&#x27;.item .name&#x27;</span>)</span><br><span class="line">j_result2 = <span class="keyword">await</span> page.querySelector(<span class="string">&#x27;.item .name&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#获取url组成列表</span></span><br><span class="line"><span class="keyword">await</span> page.querySelectorAllEval(<span class="string">&#x27;,item .name&#x27;</span>, <span class="string">&#x27;nodes =&gt; nodes.map(node =&gt; node.href)&#x27;</span>)</span><br><span class="line"><span class="keyword">await</span> page.querySelectorEval(<span class="string">&#x27;.cover&#x27;</span>, <span class="string">&#x27;node =&gt; node.src&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>querySelectorAllEval 接收两个参数一个selector选择器，另一个pageFunction，代表要执行的 JavaScript 方法，这个方法的作用是找出和选择器匹配的节点，然后根据 pageFunction 定义的逻辑从这些节点中抽取出对应的结果并返回</p>
<h6 id="选项操作"><a href="#选项操作" class="headerlink" title="选项操作"></a>选项操作</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pages = <span class="keyword">await</span> browser.pages()</span><br><span class="line">page1 = pages[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">await</span> = page1.bringToFront() <span class="comment">#切换选项卡</span></span><br></pre></td></tr></table></figure>

<h6 id="页面操作"><a href="#页面操作" class="headerlink" title="页面操作"></a>页面操作</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> page.goBack()</span><br><span class="line"><span class="keyword">await</span> page.goFroward()</span><br><span class="line"><span class="keyword">await</span> page.reload()</span><br><span class="line"><span class="keyword">await</span> page.pdf()</span><br><span class="line"><span class="keyword">await</span> page.screenshot()</span><br><span class="line"><span class="keyword">await</span> page.setContent(<span class="string">&#x27;&lt;h2&gt;hello world&lt;/h2&gt;&#x27;</span>)</span><br><span class="line"><span class="keyword">await</span> page.setUserAgent(<span class="string">&#x27;Python&#x27;</span>)</span><br><span class="line"><span class="keyword">await</span> page.setExtraHTTPHeaders(headers=&#123;&#125;)</span><br><span class="line"><span class="keyword">await</span> page.close()</span><br><span class="line"><span class="keyword">await</span> browser.close()</span><br></pre></td></tr></table></figure>

<h6 id="点击"><a href="#点击" class="headerlink" title="点击"></a>点击</h6><p>click 第一个参数是选择器，即哪里操作，第二个参数是几项配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> page.waitForSelector(<span class="string">&#x27;.item .name&#x27;</span>)</span><br><span class="line"><span class="keyword">await</span> page.click(<span class="string">&#x27;.item .name&#x27;</span>, options=&#123;</span><br><span class="line">  <span class="string">&#x27;button&#x27;</span>: <span class="string">&#x27;right&#x27;</span>, <span class="comment">#left、middle、right</span></span><br><span class="line">  <span class="string">&#x27;clickCount&#x27;</span>: <span class="number">1</span>, <span class="comment">#1或2</span></span><br><span class="line">	<span class="string">&#x27;delay&#x27;</span>: <span class="number">3000</span>, <span class="comment">#毫秒 延迟点击</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">await</span> browser.close()</span><br></pre></td></tr></table></figure>

<h6 id="输入文本"><a href="#输入文本" class="headerlink" title="输入文本"></a>输入文本</h6><p>给 type 方法第一个参数传入选择器，第二个参数输入想要输入的内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> page.<span class="built_in">type</span>(<span class="string">&#x27;#q&#x27;</span>, <span class="string">&#x27;iPad&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h6 id="获取信息"><a href="#获取信息" class="headerlink" title="获取信息"></a>获取信息</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> page.content() <span class="comment">#获取源码</span></span><br><span class="line"><span class="keyword">await</span> page.cookies()</span><br></pre></td></tr></table></figure>

<h6 id="执行-JavaScript"><a href="#执行-JavaScript" class="headerlink" title="执行 JavaScript"></a>执行 JavaScript</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">dimensions = <span class="keyword">await</span> page.evaluate(<span class="string">&#x27;&#x27;&#x27;()=&gt;&#123;</span></span><br><span class="line"><span class="string">  return &#123;</span></span><br><span class="line"><span class="string">    width:document.documentElement.clientWidth,</span></span><br><span class="line"><span class="string">    height:document.documentElement.clientHeight,</span></span><br><span class="line"><span class="string">    deviceScaleFactor:window.devicePixelRatio,</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;&#x27;&#x27;</span>)</span><br><span class="line">print(dimensions)</span><br></pre></td></tr></table></figure>

<h6 id="延时等待"><a href="#延时等待" class="headerlink" title="延时等待"></a>延时等待</h6><p>waitForSelector 传入CSS 选择器，如果找到符合条件的节点，就立马返回结果</p>
<p>waitForFunction 等待某个JavaScript 方法执行完毕或返回结果</p>
<p>waitNavigation 等待页面跳转</p>
<p>waitForRequest、waitForResponse 等待特定请求发出，等待特定请求对应的响应</p>
<p>waitFor 通用的等待方法</p>
<p>waitForXPath 等待复合 XPath 的节点加载出来</p>
<h6 id="其他功能"><a href="#其他功能" class="headerlink" title="其他功能"></a>其他功能</h6><p>还有其他功能如键盘事件、鼠标事件、对话框事件等 </p>
<p><a target="_blank" rel="noopener" href="https://miyakogi.github.io/pyppeteer/reference.html">https://miyakogi.github.io/pyppeteer/reference.html</a></p>
<h4 id="7-4-Playwright"><a href="#7-4-Playwright" class="headerlink" title="7.4 Playwright"></a>7.4 Playwright</h4><p>微软2020年初开源的新一代自动化测试工具</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip3 install playwright</span><br><span class="line">playwright install</span><br></pre></td></tr></table></figure>

<p>安装完成后可以使用 Playwright 启动 Chromium、firefox 或 WebKit 浏览器来进行自动化操作</p>
<h5 id="基本使用-1"><a href="#基本使用-1" class="headerlink" title="基本使用"></a>基本使用</h5><p>playwright 支持两种编写模式，一种是和 Pyppeteer 一样的异步模式；一种是和 Selenium 一样的同步模式</p>
<p>同步模式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> playwright.sync_api <span class="keyword">import</span> sync_playwright</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> sync_playwright() <span class="keyword">as</span> p:</span><br><span class="line">  <span class="keyword">for</span> browser_type <span class="keyword">in</span> [p.chromium, p.firefox, p.webkit]</span><br><span class="line">  browser = browser_type.launch(headless=<span class="literal">False</span>)</span><br><span class="line">  page = browser.new_Page()</span><br><span class="line">  page.goto(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line">  page.screenshot(path=<span class="string">f&#x27;screenshot-<span class="subst">&#123;browser_type.name&#125;</span>.png&#x27;</span>)</span><br><span class="line">  print(page.title())</span><br><span class="line">  browser.close()</span><br></pre></td></tr></table></figure>

<p>异步模式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> playwright.sync_api <span class="keyword">import</span> sync_playwright</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span>  </span><br><span class="line">  <span class="keyword">with</span> sync_playwright() <span class="keyword">as</span> p:</span><br><span class="line">    <span class="keyword">for</span> browser_type <span class="keyword">in</span> [p.chromium, p.firefox, p.webkit]</span><br><span class="line">    browser = <span class="keyword">await</span> browser_type.launch()</span><br><span class="line">    page = <span class="keyword">await</span> browser.new_Page()</span><br><span class="line">    page.goto(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line">    page.screenshot(path=<span class="string">f&#x27;screenshot-<span class="subst">&#123;browser_type.name&#125;</span>.png&#x27;</span>)</span><br><span class="line">    print(<span class="keyword">await</span> page.title())</span><br><span class="line">    browser.close()</span><br><span class="line">    </span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>

<h5 id="代码生成"><a href="#代码生成" class="headerlink" title="代码生成"></a>代码生成</h5><p>Playwright 还可以录制我们在浏览器中的操作并自动生成代码，通过 playwright 的命令行调用 codegen 实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">playwright codegen --help</span><br><span class="line">- target 使用语言默认python，代表会生成同步模式的操作代码，如果传入 python-async 则生成异步模式的代码</span><br><span class="line">- o 输出代码文件名称</span><br><span class="line">-b 使用浏览器，默认chromium</span><br><span class="line">-device 可以模拟使用手机浏览器（如iPhone11）</span><br><span class="line">-lang 代表设置浏览器的语言</span><br><span class="line">-timeout 可以设置页面加载的超时时间</span><br><span class="line"></span><br><span class="line">playwright codegen -o script.py -b firefox</span><br></pre></td></tr></table></figure>

<p>运行代码后弹出 Firefox 浏览器，同时右侧输出一个脚本窗口</p>
<h5 id="支持移动端浏览器"><a href="#支持移动端浏览器" class="headerlink" title="支持移动端浏览器"></a>支持移动端浏览器</h5><p>Playwright 的另一个特色就是支持模拟移动端浏览器，例如模拟打开 iPhone12ProMax 上的Safari浏览器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> playwright.sync_api <span class="keyword">import</span> sync_playwright</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> sync_playwright() <span class="keyword">as</span> p:</span><br><span class="line">  iphone_12_pro_max = p.device[<span class="string">&#x27;iPhone 12 Pro Max&#x27;</span>]</span><br><span class="line">  browser = p.webkit.launch(headless=<span class="literal">False</span>)</span><br><span class="line">  context = browser.new_context(</span><br><span class="line">   **iphone_12_pro_max,</span><br><span class="line">    locale=<span class="string">&#x27;zh-CN&#x27;</span></span><br><span class="line">  )</span><br><span class="line">  page = context.new_page()</span><br><span class="line">  page.goto(<span class="string">&#x27;https://www.whatismybrowser.com/&#x27;</span>) <span class="comment">#一个获取浏览器信息的网站</span></span><br><span class="line">  page.wait_for_load_state(state=<span class="string">&#x27;networkidle&#x27;</span>) <span class="comment">#等待页面的某个状态完成 空闲状态完成就是当前页面初始化和数据加载完成</span></span><br><span class="line">  page.screenshot(path=<span class="string">&#x27;browser-iphone.png&#x27;</span>)</span><br><span class="line">  browser.close()</span><br></pre></td></tr></table></figure>

<h5 id="选择器-1"><a href="#选择器-1" class="headerlink" title="选择器"></a>选择器</h5><h6 id="文本选择"><a href="#文本选择" class="headerlink" title="文本选择"></a>文本选择</h6><p>文本选择支持直接使用 text= 这样的语法进行筛选</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">page.click(<span class="string">&#x27;text=Log in&#x27;</span>) <span class="comment">#选择并点击文本内容是Log in的节点</span></span><br></pre></td></tr></table></figure>

<h6 id="CSS选择器"><a href="#CSS选择器" class="headerlink" title="CSS选择器"></a>CSS选择器</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#根据id或者class进行筛选</span></span><br><span class="line">page.click(<span class="string">&quot;button&quot;</span>)</span><br><span class="line">page.click(<span class="string">&quot;#nav-bar .contact-us-item&quot;</span>)</span><br><span class="line"><span class="comment">#根据特定的节点属性筛选</span></span><br><span class="line">page.click(<span class="string">&quot;[data-test=login-button]&quot;</span>)</span><br><span class="line">page.click(<span class="string">&quot;[aria-label=&#x27;Sign in&#x27;]&quot;</span>)</span><br></pre></td></tr></table></figure>

<h6 id="CSS选择器-文本值"><a href="#CSS选择器-文本值" class="headerlink" title="CSS选择器+文本值"></a>CSS选择器+文本值</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#选择文本值中包含Playwright字符串的 article节点</span></span><br><span class="line">page.click(<span class="string">&quot;article:has-text(&#x27;Playwright&#x27;)&quot;</span>)</span><br><span class="line"><span class="comment">#选择id为nav-bar的节点中文本值为 Contact us的节点</span></span><br><span class="line">page.click(<span class="string">&quot;#nav-bar :text(&#x27;Contact us&#x27;)&quot;</span>)</span><br></pre></td></tr></table></figure>

<h6 id="CSS选择器-节点关系"><a href="#CSS选择器-节点关系" class="headerlink" title="CSS选择器+节点关系"></a>CSS选择器+节点关系</h6><p>CSS选择器还可以结合节点关系来筛选节点，例如使用 has 指定另外一个选择器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#选择class为item-description的节点，且节点包含class为item-promo-banner的子节点</span></span><br><span class="line">page.click(<span class="string">&quot;.item-description:has(.item-promo-banner)&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#right-of 指定位于某个节点右侧的节点</span></span><br><span class="line"><span class="comment">#选择input结点，且该节点要位于文本值为Username的节点的右侧</span></span><br><span class="line">page.click(<span class="string">&quot;input:right-of(:text(&#x27;Username&#x27;))&quot;</span>)</span><br></pre></td></tr></table></figure>

<h6 id="XPath"><a href="#XPath" class="headerlink" title="XPath"></a>XPath</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">page.click(<span class="string">&quot;xpath=//button&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>更多关于选择器的用法 <a target="_blank" rel="noopener" href="https://playwright.dev/python/docs/selectors">https://playwright.dev/python/docs/selectors</a></p>
<h5 id="常用操作方法"><a href="#常用操作方法" class="headerlink" title="常用操作方法"></a>常用操作方法</h5><p>Page 对象提供了一个 on 方法，用来监听页面中发生的各个事件，例如close、console、load、request、response 等</p>
<h6 id="事件监听"><a href="#事件监听" class="headerlink" title="事件监听"></a>事件监听</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> playwright.sync_api <span class="keyword">import</span> sync_playwright</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_response</span>(<span class="params">response</span>):</span></span><br><span class="line">  print(<span class="string">f&#x27;Status <span class="subst">&#123;response.status&#125;</span>: <span class="subst">&#123;response.url&#125;</span>&#x27;</span>)<span class="comment">#输出状态码和链接</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> sync_playwright <span class="keyword">as</span> p:</span><br><span class="line">  browser = p.chromium.launch(headless=<span class="literal">False</span>)</span><br><span class="line">  page = browser.new_page()</span><br><span class="line">  page.on(<span class="string">&#x27;response&#x27;</span>, on_response)</span><br><span class="line">  page.goto(<span class="string">&#x27;https://spa6.scrape.center/&#x27;</span>)</span><br><span class="line">  page.wait_for_load_state(<span class="string">&#x27;networkidle&#x27;</span>)</span><br><span class="line">  browser.close()</span><br></pre></td></tr></table></figure>

<p>监听 response 事件，回调方法设置 on_response</p>
<p>可以输出 JSON</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_response</span>(<span class="params">response</span>):</span></span><br><span class="line">  <span class="keyword">if</span> <span class="string">&#x27;/api/movie/&#x27;</span> <span class="keyword">in</span> response.url <span class="keyword">and</span> response.status == <span class="number">200</span>:</span><br><span class="line">    print(response.json())</span><br></pre></td></tr></table></figure>

<h6 id="获取页面源码"><a href="#获取页面源码" class="headerlink" title="获取页面源码"></a>获取页面源码</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">html = page.content()</span><br><span class="line">print(html)</span><br></pre></td></tr></table></figure>

<h6 id="页面点击"><a href="#页面点击" class="headerlink" title="页面点击"></a>页面点击</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">page.click(selector, **kwargs)</span><br><span class="line"></span><br><span class="line">click_count 点击次数默认<span class="number">1</span></span><br><span class="line">timeout 单位秒默认<span class="number">30</span> 等待找到要点击的节点的超时时间</span><br><span class="line">position 传入字典，有x y属性，代表点击位置相对节点左上角的偏移量</span><br><span class="line">force 默认<span class="literal">False</span> 即使按钮设置了不可点击也能强制点击</span><br></pre></td></tr></table></figure>

<p>click 内部执行逻辑，找到Selector匹配的节点，如果没有找到，一直等到直到超时，</p>
<h6 id="文本输入"><a href="#文本输入" class="headerlink" title="文本输入"></a>文本输入</h6><p>第一个参数选择器，第二个参数输入值，还可以通过 timeout 指定查找对应节点的超时时间</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">page.fill(selector, value, **kwargs)</span><br></pre></td></tr></table></figure>

<h6 id="获取节点属性"><a href="#获取节点属性" class="headerlink" title="获取节点属性"></a>获取节点属性</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">page.get_attribute(selector, name, **kwargs)</span><br><span class="line"></span><br><span class="line"><span class="comment">#查找class为name的a节点，name参数传入了href，代表获取超链接内容</span></span><br><span class="line">page.get_attribute(<span class="string">&#x27;a.name&#x27;</span>, <span class="string">&#x27;href&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h6 id="获取多个节点"><a href="#获取多个节点" class="headerlink" title="获取多个节点"></a>获取多个节点</h6><p>query_selector_all</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">elements = page.query_selector_all(<span class="string">&#x27;a.name&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> element <span class="keyword">in</span> elements:</span><br><span class="line">  print(element.get_attribute(<span class="string">&#x27;href&#x27;</span>)) <span class="comment">#节点属性</span></span><br><span class="line">  print(element.text_content()) <span class="comment">#节点文本</span></span><br></pre></td></tr></table></figure>

<h6 id="获取单个节点"><a href="#获取单个节点" class="headerlink" title="获取单个节点"></a>获取单个节点</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">element = page.query_selector(<span class="string">&#x27;a.name&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h6 id="网络劫持"><a href="#网络劫持" class="headerlink" title="网络劫持"></a>网络劫持</h6><p>route，利用这个方法可以实现网络劫持和修改操作，如修改 request 的属性，修改相应结果等</p>
<p>修改请求</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> playwright.sync_api <span class="keyword">import</span> sync_playwright</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> aync_playwright <span class="keyword">as</span> p:</span><br><span class="line">  browser = p.chromium.launch(headless=<span class="literal">False</span>)</span><br><span class="line">  page = browser.new_page()</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">cancel_request</span>(<span class="params">route, request</span>):</span></span><br><span class="line">    route.abort()</span><br><span class="line">    </span><br><span class="line">  page.route(re.<span class="built_in">compile</span>(<span class="string">r&quot;\(.png)|\(.jpg)&quot;</span>), cancel_request) <span class="comment">#包含.png或者.jpg的链接</span></span><br><span class="line">  page.goto(<span class="string">&quot;https://spa6.scrape.center/&quot;</span>)</span><br><span class="line">  page.wait_for_load(<span class="string">&#x27;networkidle&#x27;</span>)</span><br><span class="line">  page.screenshot(path=<span class="string">&#x27;no_picture.png&#x27;</span>)</span><br><span class="line">  browser.close()</span><br></pre></td></tr></table></figure>

<p>修改响应</p>
<p>custom_response.html </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modify_response</span>(<span class="params">reoute, request</span>):</span></span><br><span class="line">  route.fulfill(path=<span class="string">&#x27;./custom_response.html&#x27;</span>)</span><br><span class="line">  </span><br><span class="line">page.route(<span class="string">&#x27;/&#x27;</span>, modify_response)</span><br><span class="line">page.goto(<span class="string">&quot;https://spa6.scrape.center/&quot;</span>)</span><br></pre></td></tr></table></figure>



<h4 id="7-5-使用-Selenium-爬取淘宝商品"><a href="#7-5-使用-Selenium-爬取淘宝商品" class="headerlink" title="7.5 使用 Selenium 爬取淘宝商品"></a>7.5 使用 Selenium 爬取淘宝商品</h4><p>代码 <a target="_blank" rel="noopener" href="https://github.com/Python3WebSpider/TaobaoProduct">https://github.com/Python3WebSpider/TaobaoProduct</a></p>
<p>利用 Selenium 模拟浏览器操作抓取淘宝的商品信息，并将结果保存到MongoDB</p>
<h6 id="获取商品列表"><a href="#获取商品列表" class="headerlink" title="获取商品列表"></a>获取商品列表</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"><span class="keyword">from</span> selenium.common.exceptions <span class="keyword">import</span> TimeoutException</span><br><span class="line"></span><br><span class="line">browser = webdriver.Chrome()</span><br><span class="line">wait = WebDriverWait(browser, <span class="number">10</span>)</span><br><span class="line">KEYWORD = <span class="string">&#x27;iPad&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index_page</span>(<span class="params">page</span>):</span></span><br><span class="line">  <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  抓取索引页</span></span><br><span class="line"><span class="string">  :param page: 页码</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  print(<span class="string">&#x27;正在爬取第&#x27;</span>, page, <span class="string">&#x27;页&#x27;</span>)</span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">      url = <span class="string">&#x27;https://s.taobao.com/search?q=&#x27;</span> + quote(KEYWORD)</span><br><span class="line">      browser.get(url)</span><br><span class="line">      <span class="keyword">if</span> page &gt; <span class="number">1</span>:</span><br><span class="line">          <span class="built_in">input</span> = wait.until(</span><br><span class="line">              EC.presence_of_element_located((By.CSS_SELECTOR, <span class="string">&#x27;#mainsrp-pager div.form &gt; input&#x27;</span>)))</span><br><span class="line">          submit = wait.until(</span><br><span class="line">              EC.element_to_be_clickable((By.CSS_SELECTOR, <span class="string">&#x27;#mainsrp-pager div.form &gt; span.btn.J_Submit&#x27;</span>)))</span><br><span class="line">          <span class="built_in">input</span>.clear()</span><br><span class="line">          <span class="built_in">input</span>.send_keys(page)</span><br><span class="line">          submit.click()</span><br><span class="line">      wait.until(</span><br><span class="line">          EC.text_to_be_present_in_element((By.CSS_SELECTOR, <span class="string">&#x27;#mainsrp-pager li.item.active &gt; span&#x27;</span>), <span class="built_in">str</span>(page)))</span><br><span class="line">      wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, <span class="string">&#x27;.m-itemlist .items .item&#x27;</span>)))</span><br><span class="line">      get_products()</span><br><span class="line">  <span class="keyword">except</span> TimeoutException:</span><br><span class="line">      index_page(page)</span><br></pre></td></tr></table></figure>

<p>定义了 index_page() 方法，抓取商品列表</p>
<p>访问搜索链接，页码大于1就进行跳页操作，否则等待页面加载完成</p>
<p>等待加载使用 WebDriverWait 对象，指定最长等待时间 10 秒，这个时间内匹配了等待条件，也就说页面加载出来了，就立即返回相应结果继续向下执行，否则到了最大时间没加载出来时，抛出异常</p>
<p>等待商品加载出来 presence_of_element_located，传入 CSS 选择器 .m-itemlist .items .item，这选择器对应页面内容是每个商品的信息块</p>
<p>是否跳转到了对应页面，跳转到某一页后页码都会高亮，只需要判断当前高亮的页码数是当前页码即可</p>
<p>text_to_be_present_in_element 会等待指定的文本出现在某个节点里时返回成功，会检测当前高亮的页码节点是不是传过来的页码数</p>
<h6 id="解析商品列表"><a href="#解析商品列表" class="headerlink" title="解析商品列表"></a>解析商品列表</h6><p>直接返回页面源代码，使用pyquery解析</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_products</span>():</span></span><br><span class="line">  <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  提取商品数据</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  html = browser.page_source</span><br><span class="line">  doc = pq(html)</span><br><span class="line">  items = doc(<span class="string">&#x27;#mainsrp-itemlist .items .item&#x27;</span>).items()</span><br><span class="line">  <span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">      product = &#123;</span><br><span class="line">          <span class="string">&#x27;image&#x27;</span>: item.find(<span class="string">&#x27;.pic .img&#x27;</span>).attr(<span class="string">&#x27;data-src&#x27;</span>),</span><br><span class="line">          <span class="string">&#x27;price&#x27;</span>: item.find(<span class="string">&#x27;.price&#x27;</span>).text(),</span><br><span class="line">          <span class="string">&#x27;deal&#x27;</span>: item.find(<span class="string">&#x27;.deal-cnt&#x27;</span>).text(),</span><br><span class="line">          <span class="string">&#x27;title&#x27;</span>: item.find(<span class="string">&#x27;.title&#x27;</span>).text(),</span><br><span class="line">          <span class="string">&#x27;shop&#x27;</span>: item.find(<span class="string">&#x27;.shop&#x27;</span>).text(),</span><br><span class="line">          <span class="string">&#x27;location&#x27;</span>: item.find(<span class="string">&#x27;.location&#x27;</span>).text()</span><br><span class="line">      &#125;</span><br><span class="line">      print(product)</span><br><span class="line">      save_to_mongo(product)</span><br></pre></td></tr></table></figure>

<h6 id="保存到-MongoDB"><a href="#保存到-MongoDB" class="headerlink" title="保存到 MongoDB"></a>保存到 MongoDB</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">MONGO_URL = <span class="string">&#x27;localhost&#x27;</span></span><br><span class="line">MONGO_DB = <span class="string">&#x27;taobao&#x27;</span></span><br><span class="line">MONGO_COLLECTION = <span class="string">&#x27;products&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_to_mongo</span>(<span class="params">result</span>):</span></span><br><span class="line">  <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  保存至MongoDB</span></span><br><span class="line"><span class="string">  :param result: 结果</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">      <span class="keyword">if</span> db[MONGO_COLLECTION].insert(result):</span><br><span class="line">          print(<span class="string">&#x27;存储到MongoDB成功&#x27;</span>)</span><br><span class="line">  <span class="keyword">except</span> Exception:</span><br><span class="line">      print(<span class="string">&#x27;存储到MongoDB失败&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>quote()</p>
<p>单个字符串编码，url 多个字符串编码用 urlencode</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line">KEYWORD = <span class="string">&#x27;ipad&#x27;</span></span><br><span class="line">url = <span class="string">&#x27;https://s.taobao.com/search?q=&#x27;</span> + quote(KEYWORD)</span><br></pre></td></tr></table></figure>

<h6 id="遍历每页"><a href="#遍历每页" class="headerlink" title="遍历每页"></a>遍历每页</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MAX_PAGE = <span class="number">100</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">  <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  遍历每一页</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, MAX_PAGE + <span class="number">1</span>):</span><br><span class="line">      index_page(i)</span><br><span class="line">  browser.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main()</span><br></pre></td></tr></table></figure>





<h6 id="Chrome-Handless-模式"><a href="#Chrome-Handless-模式" class="headerlink" title="Chrome Handless 模式"></a>Chrome Handless 模式</h6><p>Chrome59版本开始已开始支持 Handless 模式，也就是无界面模式，这样爬取的时候就不会弹出浏览器了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chrome_options = webdriver.ChromeOptions()</span><br><span class="line">chrome_options.add_argument(<span class="string">&#x27;--headless&#x27;</span>)</span><br><span class="line">browser = webdriver.Chrome(chrome_options=chrome_options)</span><br></pre></td></tr></table></figure>

<h6 id="Config"><a href="#Config" class="headerlink" title="Config"></a>Config</h6><p>可以把常量设置放 Config.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MONGO_URL = <span class="string">&#x27;localhost&#x27;</span></span><br><span class="line">MONGO_DB = <span class="string">&#x27;taobao&#x27;</span></span><br><span class="line">MONGO_COLLECTION = <span class="string">&#x27;products&#x27;</span></span><br><span class="line">KEYWORD = <span class="string">&#x27;ipad&#x27;</span></span><br><span class="line">MAX_PAGE = <span class="number">100</span></span><br></pre></td></tr></table></figure>

<p>使用 <code>from config import *</code> 导入</p>
<h6 id="对接-Firefox"><a href="#对接-Firefox" class="headerlink" title="对接 Firefox"></a>对接 Firefox</h6><p>只需要更改</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">browser = webdriver.Firefox()</span><br></pre></td></tr></table></figure>



<h4 id="7-6Selenium爬取实战"><a href="#7-6Selenium爬取实战" class="headerlink" title="7.6Selenium爬取实战"></a>7.6Selenium爬取实战</h4><h4 id="7-7Pyppeteer爬取实战"><a href="#7-7Pyppeteer爬取实战" class="headerlink" title="7.7Pyppeteer爬取实战"></a>7.7Pyppeteer爬取实战</h4><h4 id="7-8CSS位置偏移反爬案例"><a href="#7-8CSS位置偏移反爬案例" class="headerlink" title="7.8CSS位置偏移反爬案例"></a>7.8CSS位置偏移反爬案例</h4><h4 id="7-9字体反爬案例"><a href="#7-9字体反爬案例" class="headerlink" title="7.9字体反爬案例"></a>7.9字体反爬案例</h4>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/06/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-7JavaScript%E5%8A%A8%E6%80%81%E6%B8%B2%E6%9F%93%E9%A1%B5%E9%9D%A2%E7%88%AC%E5%8F%961/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/06/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-7JavaScript%E5%8A%A8%E6%80%81%E6%B8%B2%E6%9F%93%E9%A1%B5%E9%9D%A2%E7%88%AC%E5%8F%961/" class="post-title-link" itemprop="url">Python3网络爬虫开发实战-7JavaScript动态渲染页面爬取1</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-10-06 22:07:37" itemprop="dateCreated datePublished" datetime="2022-10-06T22:07:37+08:00">2022-10-06</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-10-09 08:57:19" itemprop="dateModified" datetime="2022-10-09T08:57:19+08:00">2022-10-09</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="7-动态渲染页面爬取"><a href="#7-动态渲染页面爬取" class="headerlink" title="7. 动态渲染页面爬取"></a>7. 动态渲染页面爬取</h4><p>Python 提供了许多模拟浏览器运行的库，如  Selenium、Splash、PyV8、Ghost 等</p>
<p>有些 Ajax 接口含有很多加密参数，难以直接找出其规律，也很难直接分析 Ajax 来抓取，可以使用模拟浏览器运行的方式来实现，不用管 Ajax 接口到底有哪些参数</p>
<h4 id="7-1-Selenium-的使用"><a href="#7-1-Selenium-的使用" class="headerlink" title="7.1 Selenium 的使用"></a>7.1 Selenium 的使用</h4><p>Selenium 是一个自动化测试工具，利用它可以驱动浏览器执行特定的动作，如点击、下拉，同时还可以获取浏览器当前呈现页面的源码，做到可见即可爬</p>
<p>需要配置好 ChromeDriver，安装好 python 的 selenium 库</p>
<h5 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h5><h5 id="声明浏览器对象"><a href="#声明浏览器对象" class="headerlink" title="声明浏览器对象"></a>声明浏览器对象</h5><p>Selenium 支持非常多浏览器，如 Chrome、Firefox等</p>
<p>初始化浏览器对象并赋值为 browser 对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line">browser = webdriver.Chrome()  <span class="comment">#弹出Chrome浏览器</span></span><br><span class="line">browser = webdriver.Safari()</span><br><span class="line">browser = webdriver.Firefox()</span><br></pre></td></tr></table></figure>

<h5 id="访问页面"><a href="#访问页面" class="headerlink" title="访问页面"></a>访问页面</h5><p>调用 get() 来请求页面，传入链接 URL 即可</p>
<p>如 get() 方法访问页面，打印源代码再关闭浏览器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">browser = webdriver.Chrome()  <span class="comment">#弹出Chrome浏览器</span></span><br><span class="line">browser.get(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line">print(browser.page_source)<span class="comment">#打印源代码</span></span><br><span class="line">browser.close()</span><br></pre></td></tr></table></figure>

<h5 id="查找节点"><a href="#查找节点" class="headerlink" title="查找节点"></a>查找节点</h5><p>Selenium 可以驱动浏览器完成各种动作，如填充表单模拟点击等</p>
<h6 id="单个节点-find-element"><a href="#单个节点-find-element" class="headerlink" title="单个节点 find_element"></a>单个节点 find_element</h6><p>比如想获取百度搜索框的这个节点，查看源码找到搜索框</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">imput</span> <span class="attr">id</span>=<span class="string">&quot;kw&quot;</span> <span class="attr">name</span>=<span class="string">&quot;wd&quot;</span> <span class="attr">class</span>=<span class="string">&quot;s_ipt&quot;</span> <span class="attr">value</span> <span class="attr">maxlength</span>=<span class="string">&quot;255&quot;</span> <span class="attr">autocomplete</span>=<span class="string">&quot;off&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>接下来就是获取它了，可以通过 find_element_by_name() 根据 name 值获取，find_element_by_id() 是根据 id 获取，还有根据 XPath、CSS 选择器等获取方式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">browser = webdriver.Chrome()  <span class="comment">#弹出Chrome浏览器</span></span><br><span class="line">browser.get(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line">input_first = browser.find_element_by_id(<span class="string">&#x27;kw&#x27;</span>)</span><br><span class="line">input_second = browser.find_element_by_class_name(<span class="string">&#x27;s_ipt&#x27;</span>)</span><br><span class="line">input_third = browser.find_element_by_name(<span class="string">&#x27;wd&#x27;</span>)</span><br><span class="line">input_forth = browser.find_element_by_xpath(<span class="string">&#x27;//*[@id=&quot;kw&quot;]&#x27;</span>)</span><br><span class="line">input_five  = browser.find_element_by_css_selector(<span class="string">&#x27;#kw&#x27;</span>)</span><br><span class="line">print(input_first, input_second, input_third, input_forth, input_five)</span><br></pre></td></tr></table></figure>

<p>返回结果都是</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;selenium.webdriver.remote.webelement.WebElement (session=<span class="string">&quot;21787490d750c720cf715181e538f416&quot;</span>, element=<span class="string">&quot;b3dcf1e9-05a9-4a1c-8e83-deebd46c2413&quot;</span>)&gt; </span><br></pre></td></tr></table></figure>

<p>获取单个节点可以使用：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">find_element_by_id	find_element_by_name	find_element_by_xpath</span><br><span class="line">find_element_by_link_text	find_element_by_partial_link_text</span><br><span class="line">find_element_by_tag_name	find_element_by_class_name</span><br><span class="line">find_element_by_css_selector</span><br></pre></td></tr></table></figure>



<h6 id="通用方法-find-element"><a href="#通用方法-find-element" class="headerlink" title="通用方法 find_element"></a>通用方法 find_element</h6><p>selenium 还提供了通用的方法 find_element() ，两个参数：查找方式 By 和方式的取值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line">input_first = browser.find_element(By.ID, <span class="string">&#x27;kw&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h6 id="多个节点-find-elements"><a href="#多个节点-find-elements" class="headerlink" title="多个节点  find_elements()"></a>多个节点  find_elements()</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">browser = webdriver.Chrome()  <span class="comment">#弹出Chrome浏览器</span></span><br><span class="line">browser.get(<span class="string">&#x27;https://www.taobao.com&#x27;</span>)</span><br><span class="line"><span class="built_in">list</span> = browser.find.elements_by_css_selector(<span class="string">&#x27;.service-bd li&#x27;</span>)</span><br><span class="line"><span class="comment">#也可直接用 find_elements() 方法来选择</span></span><br><span class="line"><span class="built_in">list</span> = browser.find_elements(By.CSS_SELECTOR, <span class="string">&#x27;.service-bd li&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h6 id="节点交互"><a href="#节点交互" class="headerlink" title="节点交互"></a>节点交互</h6><p>让浏览器执行一些动作，输入文字 send_keys()，清空文字 clear()， 点击按钮 click()</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.remote.webelement <span class="keyword">import</span> WebElement</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="built_in">input</span> = browser.find_element(By.ID, <span class="string">&#x27;kw&#x27;</span>)<span class="comment"># type: WebElement</span></span><br><span class="line"><span class="built_in">input</span>.send_keys(<span class="string">&#x27;iPhone&#x27;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">input</span>.clear()</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">input</span>.send_keys(<span class="string">&#x27;iPad&#x27;</span>)</span><br><span class="line">button = browser.find_element(By.ID, <span class="string">&#x27;su&#x27;</span>) <span class="comment"># type: WebElement</span></span><br><span class="line">button.click()</span><br></pre></td></tr></table></figure>

<p>驱动浏览器打开百度，输入文字，清空搜索，调用 click() 点击搜索</p>
<p>更多操作交互查看 </p>
<p><a target="_blank" rel="noopener" href="https://selenium-python.readthedocs.io/api.html#module-selenium.webdriver.remote.webelement">https://selenium-python.readthedocs.io/api.html#module-selenium.webdriver.remote.webelement</a></p>
<h6 id="动作链"><a href="#动作链" class="headerlink" title="动作链"></a>动作链</h6><p>一些操作没有特定的执行对象，比如鼠标拖拽，键盘按键等，这些动作用另一种方式来执行，就是动作链</p>
<p>拖拽实例</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe frameborder=&quot;0&quot; id=&quot;iframeResult&quot; style=&quot;height: 592.96px;&quot; cd_frame_id_=&quot;8cb7e7ff87254590477aee6f726ea77d&quot;&gt;&lt;/iframe&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver <span class="keyword">import</span> ActionChains</span><br><span class="line"></span><br><span class="line">browser = webdriver.Chrome()</span><br><span class="line">url = <span class="string">&#x27;http://www.runoob.com/try/try.php?filename=jqueryui-api-droppable&#x27;</span></span><br><span class="line">browser.get(url)</span><br><span class="line">browser.switch_to.frame(<span class="string">&#x27;iframeResult&#x27;</span>) <span class="comment">#切换frame</span></span><br><span class="line">source = browser.find_element_by_css_selector(<span class="string">&#x27;#draggable&#x27;</span>)<span class="comment">#拖拽节点</span></span><br><span class="line">target = browser.find_element_by_css_selector(<span class="string">&#x27;#droppable&#x27;</span>)<span class="comment">#拖拽目标节点</span></span><br><span class="line">actions = ActionChains(browser)</span><br><span class="line">actions.drag_and_drop(source, target)</span><br><span class="line">actions.perform()<span class="comment">#执行</span></span><br></pre></td></tr></table></figure>

<p>更多动作链操作</p>
<p><a target="_blank" rel="noopener" href="https://selenium-python.readthedocs.io/api.html#module-selenium.webdriver.common.action_chains">https://selenium-python.readthedocs.io/api.html#module-selenium.webdriver.common.action_chains</a></p>
<h6 id="执行-JavaScript"><a href="#执行-JavaScript" class="headerlink" title="执行 JavaScript"></a>执行 JavaScript</h6><p>利用 execute_script() 将进度条下拉到最底部，然后弹窗</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">browser = webdriver.Chrome()</span><br><span class="line">browser.get(<span class="string">&#x27;https://www.zhihu.com/explore&#x27;</span>)</span><br><span class="line">browser.execute_script(<span class="string">&#x27;window.scrollTo(0, document.body.scrollHeight)&#x27;</span>)</span><br><span class="line">browser.execute_script(<span class="string">&#x27;alert(&quot;To Bottom&quot;)&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="获取节点信息"><a href="#获取节点信息" class="headerlink" title="获取节点信息"></a>获取节点信息</h5><p>前面通过 page_souce 属性获取网页源代码，接着就可以使用解析库（正则、Beautiful Soup、pyquery）等来提取信息</p>
<p>Selenium 已提供了选取节点的方法，返回 WebElement 类型，它也有相关的方法和属性来直接提取节点信息，如属性、文本等。这样就可以不用通过解析源代码来提取信息了</p>
<h6 id="获取属性"><a href="#获取属性" class="headerlink" title="获取属性"></a>获取属性</h6><p>通过 get_attribute() 方法获取节点属性，输入想要获取的属性名</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.remote.webelement <span class="keyword">import</span> WebElement</span><br><span class="line">browser = webdriver.Chrome()</span><br><span class="line">browser.get(<span class="string">&#x27;https://www.zhihu.com/explore&#x27;</span>)</span><br><span class="line">logo = browser.find_element_by_class_name(<span class="string">&#x27;ExploreHomePage-specialsLoginImg&#x27;</span>) <span class="comment"># type: WebElement</span></span><br><span class="line">print(logo)</span><br><span class="line">print(logo.get_attribute(<span class="string">&#x27;class&#x27;</span>))</span><br></pre></td></tr></table></figure>

<h6 id="获取文本值"><a href="#获取文本值" class="headerlink" title="获取文本值"></a>获取文本值</h6><p>每个 WebElement 都有 text 属性，获取到节点内部的文本信息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">logo = browser.find_element_by_class_name(<span class="string">&#x27;ExploreHomePage-ContentSection-header&#x27;</span>) <span class="comment"># type: WebElement</span></span><br><span class="line">print(logo.text)</span><br></pre></td></tr></table></figure>

<h6 id="获取-id、位置、标签名和大小"><a href="#获取-id、位置、标签名和大小" class="headerlink" title="获取 id、位置、标签名和大小"></a>获取 id、位置、标签名和大小</h6><p>id 获取节点id，location 获取该节点在页面中相对位置，tag_name 获取标签名称，size 获取节点大小也就是宽高</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">print(logo.<span class="built_in">id</span>)</span><br><span class="line">print(logo.location)</span><br><span class="line">print(logo.tag_name)</span><br><span class="line">print(logo.size)</span><br></pre></td></tr></table></figure>

<h5 id="切换-Frame"><a href="#切换-Frame" class="headerlink" title="切换 Frame"></a>切换 Frame</h5><p>网页中有一种节点叫作 iframe，也就是子 Frame，相当于页面的子页面</p>
<p>Selenium 打开页面后，默认是在父级 Frame 里面操作，此时如果页面中还有子 Frame，它是不能获取到子Frame 里面的节点的，需要用 switch_to.frame() 方法来切换 Frame</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> selenium.common.exceptions <span class="keyword">import</span> NoSuchElementException</span><br><span class="line"></span><br><span class="line">browser = webdriver.Chrome()</span><br><span class="line">url = <span class="string">&#x27;http://www.runoob.com/try/try.php?filename=jqueryui-api-droppable&#x27;</span></span><br><span class="line">browser.get(url)</span><br><span class="line">browser.switch_to.frame(<span class="string">&#x27;iframeResult&#x27;</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    logo = browser.find_element_by_class_name(<span class="string">&#x27;logo&#x27;</span>)</span><br><span class="line"><span class="keyword">except</span> NoSuchElementException:</span><br><span class="line">    print(<span class="string">&#x27;No Logo&#x27;</span>)</span><br><span class="line">browser.switch_to.parent_frame()</span><br><span class="line">logo = browser.find_element_by_class_name(<span class="string">&#x27;logo&#x27;</span>)</span><br><span class="line">print(logo)</span><br><span class="line">print(logo.text)</span><br><span class="line"><span class="comment">#结果</span></span><br><span class="line">No Logo</span><br><span class="line">&lt;selenium.webdriver.remote.webelement.WebElement (session=<span class="string">&quot;020e37884ff7c4ab42f87a840d6bc616&quot;</span>, element=<span class="string">&quot;d5450a09-946b-4ace-b6b2-f3dd7c0382fd&quot;</span>)&gt;</span><br></pre></td></tr></table></figure>

<p>这里先通过 switch_to.frame 切换到子 Frame里面，尝试获取父级 Frame 里的 logo 节点（这是不能找到的）找不到抛出异常，接着切换回父级 Frame，然后再次重新获取节点，此时成功获取了</p>
<p>所以当页面中包含子 Frame 时，如果想获取子 Frame 中的节点，需要先调用 switch_to.frame 方法切换到对应的 Frame，然后再进行操作</p>
<h5 id="延时等待"><a href="#延时等待" class="headerlink" title="延时等待"></a>延时等待</h5><p>Selenium 中，get 方法会在网页框架加载结束后执行，此时如果获取 page_source，可能并不是浏览器完全加载完成的页面，有些还有额外的 Ajax 请求，需要等待一段时间，确保节点已加载出来</p>
<h6 id="隐式等待"><a href="#隐式等待" class="headerlink" title="隐式等待"></a>隐式等待</h6><p>implicitly_wait</p>
<p>如果 Selenium 没有在 DOM 中找到节点，将继续等待，超出设定时间抛出找不到节点的异常</p>
<p>当查找节点没有立即出现，隐式等待一段时间再查找DOM，默认时间0</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">browser = webdriver.Chrome()</span><br><span class="line">browser.implicitly_wait(<span class="number">10</span>) <span class="comment">#隐式等待</span></span><br><span class="line">browser.get(<span class="string">&#x27;https://www.zhihu.com/explore&#x27;</span>)</span><br><span class="line"><span class="built_in">input</span> = browser.find_element_by_class_name(<span class="string">&#x27;zu-top-add-question&#x27;</span>)</span><br><span class="line">print(<span class="built_in">input</span>)</span><br></pre></td></tr></table></figure>

<h6 id="显式等待"><a href="#显式等待" class="headerlink" title="显式等待"></a>显式等待</h6><p>指定要查找的结点，指定一个最长等待时间，规定时间内加载出来了这个节点，就返回查找节点，超过时间未找到节点抛出异常</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line">browser = webdriver.Chrome()</span><br><span class="line">browser.implicitly_wait(<span class="number">10</span>)<span class="comment"># 指定最长等待时间</span></span><br><span class="line">browser.get(<span class="string">&#x27;https://www.taobao.com/&#x27;</span>)</span><br><span class="line">wait = WebDriverWait(browser, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">input</span> = wait.until(EC.presence_of_element_located(By.ID, <span class="string">&#x27;q&#x27;</span>)) <span class="comment">#节点出现</span></span><br><span class="line">button = wait.until(EC.element_to_be_clickable(By.CSS_SELECTOR, <span class="string">&#x27;.btn-search&#x27;</span>)) <span class="comment">#节点可点击</span></span><br><span class="line">print(<span class="built_in">input</span>, button)</span><br></pre></td></tr></table></figure>

<p>引入 WebDriverWait 对象，指定最长等待时间</p>
<p>调用 until 方法，传入要等待条件 presence_of_element_located 节点出现的意思，参数是节点的定位元组，ID 为 q 的节点搜索框</p>
<p>10秒内搜索框成功加载出来，就返回该节点，超过10秒抛出异常</p>
<p>element_to_be_clickable 可点击，查按钮查找 CSS 选择器 .btn-search ，10秒内它是可点击的，也就是成功加载出来了，就返回这个按钮节点，超过10秒不可点击，也就是没有加载出来，就抛出异常</p>
<h6 id="其它等待条件"><a href="#其它等待条件" class="headerlink" title="其它等待条件"></a>其它等待条件</h6><p>比如判断标题内容，判断某个节点内是否出现了某文字等</p>
<table>
<thead>
<tr>
<th>等待条件</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>title_is</td>
<td>标题是某内容</td>
</tr>
<tr>
<td>title_contains</td>
<td>标题包含某内容</td>
</tr>
<tr>
<td>presence_of_element_loated</td>
<td>节点加载出来，传入定位元组(By.ID,’p’)</td>
</tr>
<tr>
<td>visibility_of_element_located</td>
<td>节点可见，传入定位元组</td>
</tr>
<tr>
<td>visibility_of</td>
<td>可见，传入节点对象</td>
</tr>
<tr>
<td>presence_of_all_elements_located</td>
<td>所有节点加载出来</td>
</tr>
<tr>
<td>text_to_be_present_in_element</td>
<td>某个节点文本包含某文字</td>
</tr>
<tr>
<td>text_to_be_present_in_element_value</td>
<td>某个节点值包含某文字</td>
</tr>
<tr>
<td>frame_to_be_available_and_switch_to_it</td>
<td>加载并切换</td>
</tr>
<tr>
<td>invisibility_of_element_located</td>
<td>节点不可见</td>
</tr>
<tr>
<td>element_to_be_clickable</td>
<td>节点可点击</td>
</tr>
<tr>
<td>staleness_of</td>
<td>判断一个结点是否仍在DOM，可判断页面是否已刷新</td>
</tr>
<tr>
<td>element_to_be_selected</td>
<td>节点可选择，传入节点对象</td>
</tr>
<tr>
<td>element_located_to_be_selected</td>
<td>节点可选择，传入定位元组</td>
</tr>
<tr>
<td>element_selection_state_to_be</td>
<td>传入节点对象及状态，相等返回True，否则返回False</td>
</tr>
<tr>
<td>element_located_selection_state_to_be</td>
<td>传入定位元组及状态，相等返回True，否则返回False</td>
</tr>
<tr>
<td>alert_is_present</td>
<td>是否出现警告</td>
</tr>
</tbody></table>
<p>更多等待条件的参数及用法</p>
<p> <a target="_blank" rel="noopener" href="https://selenium-python.readthedocs.io/api.html#module-selenium.webdriver.support.expected_conditions">https://selenium-python.readthedocs.io/api.html#module-selenium.webdriver.support.expected_conditions</a></p>
<h5 id="前进和后退"><a href="#前进和后退" class="headerlink" title="前进和后退"></a>前进和后退</h5><p>back() 和 forward()</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">browser.back()</span><br><span class="line">browser.forward()</span><br></pre></td></tr></table></figure>

<h5 id="Cookies"><a href="#Cookies" class="headerlink" title="Cookies"></a>Cookies</h5><p>获取、添加、删除 Cookies</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">print(browser.get_cookie())</span><br><span class="line">browser.add_cookie(&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;name&#x27;</span>&#125;)</span><br><span class="line">browser.delete_all_cookies()</span><br></pre></td></tr></table></figure>

<h5 id="选项卡管理"><a href="#选项卡管理" class="headerlink" title="选项卡管理"></a>选项卡管理</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">browser = webdriver.Chrome()</span><br><span class="line">browser.get(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line">browser.execute_script(<span class="string">&#x27;window.open()&#x27;</span>) <span class="comment">#打开新选项卡</span></span><br><span class="line">print(browser.window_handles) <span class="comment">#打印所有选项卡</span></span><br><span class="line">browser.switch_to.window(browser.window_handles[<span class="number">1</span>]) <span class="comment">#切换选项卡</span></span><br><span class="line">browser.get(<span class="string">&#x27;https://www.zhihu.com/explore&#x27;</span>) <span class="comment">#新选项卡打开页面</span></span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">browser.switch_to.window(browser.window_handles[<span class="number">0</span>]) <span class="comment">#切换到第1个选项卡</span></span><br></pre></td></tr></table></figure>

<h5 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h5><p>try except</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.common.exceptions <span class="keyword">import</span> NoSuchElementException, TimeoutException</span><br><span class="line"></span><br><span class="line">browser = webdriver.Chrome()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">  browser.get(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line"><span class="keyword">except</span> TimeoutException:</span><br><span class="line">  print(<span class="string">&#x27;Time Out&#x27;</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">  browser.find_element_by_id(<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line"><span class="keyword">except</span> NoSuchElementException:</span><br><span class="line">  print(<span class="string">&#x27;No Element&#x27;</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">  browser.close()</span><br></pre></td></tr></table></figure>

<p>更多异常类 <a target="_blank" rel="noopener" href="https://selenium-python.readthedocs.io/api.html#module-selenium.common.exceptions">https://selenium-python.readthedocs.io/api.html#module-selenium.common.exceptions</a></p>
<h5 id="反屏蔽"><a href="#反屏蔽" class="headerlink" title="反屏蔽"></a>反屏蔽</h5><p>现在很多网站都增加了对 Selenium 的检测，防止一些爬虫的恶意爬取，检测到 Selenium 打开浏览器，就直接屏蔽</p>
<p>检测原理是检测当前浏览器窗口下 window.navigator 对象中是否包含 webdriver 属性，在正常使用浏览器时这个属性应该是 undefined</p>
<p><a target="_blank" rel="noopener" href="https://antispider1.scrape.center/">https://antispider1.scrape.center/</a></p>
<p>Selenium 中，可以使用 CDP（Chrome 开发工具协议）解决这个问题，利用它可以实现在每个页面刚加载的时候就执行 JavaScript 语句</p>
<p>还可以加入几个选项来隐藏 WebDriver 提示条河自动化扩展信息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver <span class="keyword">import</span> ChromeOptions</span><br><span class="line"></span><br><span class="line">option = ChromeOptions()</span><br><span class="line">option.add_experimental_option(<span class="string">&#x27;excludeSwitches&#x27;</span>, [<span class="string">&#x27;enable-automation&#x27;</span>])</span><br><span class="line">option.add_experimental_option(<span class="string">&#x27;useAutomationExtension&#x27;</span>, <span class="literal">False</span>)</span><br><span class="line">browser = webdriver.Chrome(options=option)</span><br><span class="line">browser.execute_cpd_cmd(<span class="string">&#x27;Page.addScriptToEvaluateOnNewDocument&#x27;</span>,&#123;</span><br><span class="line">  <span class="string">&#x27;source&#x27;</span>:<span class="string">&#x27;Object.defineProperty(navigator, &quot;webdriver&quot;, &#123;get:() =&gt; undefined&#125;)&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line">browser.get(<span class="string">&#x27;htttps://antispider1.scrape.center/&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="无头模式"><a href="#无头模式" class="headerlink" title="无头模式"></a>无头模式</h5><p>可以借助 ChromeOptions 对象开启 Chrome 浏览器的无头模式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver <span class="keyword">import</span> ChromeOptions</span><br><span class="line"></span><br><span class="line">option = ChromeOptions()</span><br><span class="line">option.add_argument(<span class="string">&#x27;--headless&#x27;</span>)</span><br><span class="line">browser = webdriver.Chrome(options=option)</span><br><span class="line">browser.set_window_size(<span class="number">1366</span>,<span class="number">768</span>)</span><br><span class="line">browser.get(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line">browser.get_screenshot_as_file(<span class="string">&#x27;preview.png&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>无头模式下最好设置下窗口大小</p>
<h4 id="7-2-Splash-使用"><a href="#7-2-Splash-使用" class="headerlink" title="7.2 Splash 使用"></a>7.2 Splash 使用</h4><p>Splash Scripts Reference <a target="_blank" rel="noopener" href="https://splash.readthedocs.io/en/stable/scripting-ref.html">https://splash.readthedocs.io/en/stable/scripting-ref.html</a></p>
<p>Splash 是一个 JavaScript 渲染服务，是一个带有 HTTP API 的轻量级浏览器，对接了 Python 中的 Twisted 和 QT 库，利用它同样可以动态渲染页面的抓取</p>
<ul>
<li>Splash 可以实现功能</li>
</ul>
<p>异步方式处理多个网页渲染过程</p>
<p>获取渲染后的页面的源代码或截图</p>
<p>通过关闭图片渲染或者使用 Adblock 规则来加快页面渲染速度</p>
<p>可执行特定的 JavaScript 脚本</p>
<p>可通过 Lua 脚本来控制页面渲染过程</p>
<p>获取渲染的详细过程并通过 HAR（HTTP Archive）格式呈现</p>
<h5 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h5><p>Docker 安装 Splash 后启动，本机 8050 端口运行了 Splash 服务，打开 <a target="_blank" rel="noopener" href="http://localhost:8050/">http://localhost:8050</a> 可以看到 Web 页面，显示一个渲染示例，有个输入框默认 <a target="_blank" rel="noopener" href="http://google.com/">http://google.com</a></p>
<p>修改成百度 <a target="_blank" rel="noopener" href="https://www.baidu.com/">https://www.baidu.com</a> ，点击 Render me 测试渲染</p>
<p>可以看到网页返回结果显示了渲染截图、HAR加载统计数据、网页的源代码</p>
<p>通过 HAR 结果可以看到，Splash 执行了整个网页的渲染过程，包括 CSS、JavaScript 的加载等过程，呈现的页面和在浏览器中得到的结果一致</p>
<p>返回查看入口的脚本 </p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(splash, args)</span></span></span><br><span class="line">  <span class="built_in">assert</span>(splash:go(args.url))</span><br><span class="line">  <span class="built_in">assert</span>(splash:wait(<span class="number">0.5</span>))</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    html = splash:html(),</span><br><span class="line">    png = splash:png(),</span><br><span class="line">    har = splash:har(),</span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>这是用 Lua 语言写的脚本，首先调用 go() 方法去加载页面，然后调用 wait() 方法等待一定时间，最后返回页面的源码、截图、HAR等信息</p>
<h5 id="Splash-Lua-脚本"><a href="#Splash-Lua-脚本" class="headerlink" title="Splash Lua 脚本"></a>Splash Lua 脚本</h5><p>Splash 可以通过 Lua 脚本执行一系列渲染操作，这样就可以用 Splash 来模拟类似 Chrome、PhantomJs 的操作</p>
<h6 id="入口及返回值"><a href="#入口及返回值" class="headerlink" title="入口及返回值"></a>入口及返回值</h6><p>方法的返回值可以是字符形式或者字典形式</p>
<p>evaljs() 方法传入 JavaScript 脚本</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(splash, args)</span></span></span><br><span class="line">  splash:go(args.url)</span><br><span class="line">  splash:wait(<span class="number">0.5</span>)</span><br><span class="line">  <span class="keyword">local</span> title = splash:evaljs(<span class="string">&#x27;document.title&#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span> title</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"># <span class="keyword">return</span> &#123;hello: <span class="string">&quot;world&quot;</span>&#125; </span><br><span class="line"># <span class="keyword">return</span> <span class="string">&#x27;hello&#x27;</span></span><br></pre></td></tr></table></figure>

<h6 id="异步处理"><a href="#异步处理" class="headerlink" title="异步处理"></a>异步处理</h6><p>Splash 支持异步处理，但是没有显式指明回调方法，其回调的跳转是在 Splash 内部完成</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(splash, args)</span></span></span><br><span class="line">  <span class="keyword">local</span> example_urls = &#123;<span class="string">&quot;www.baidu.com&quot;</span>, <span class="string">&quot;www.taobao.com&quot;</span>, <span class="string">&quot;www.zhihu.com&quot;</span>&#125;</span><br><span class="line">  <span class="keyword">local</span> urls = args.urls <span class="keyword">or</span> example_urls</span><br><span class="line">  <span class="keyword">local</span> results = &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> index, url <span class="keyword">in</span> <span class="built_in">ipairs</span>(urls) <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> ok, reason = splash:go(<span class="string">&quot;http://&quot;</span> .. url) #lua字符串拼接</span><br><span class="line">    <span class="keyword">if</span> ok <span class="keyword">then</span></span><br><span class="line">      splash:wait(<span class="number">2</span>)</span><br><span class="line">      results[url] = splash:png()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">return</span> results</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>go() 方法会返回加载页面的结果状态，如果返回错误 ok 变量就为空</p>
<p>Splash 执行到 wait 方法时，会转而处理其他任务，等待指定时间后再回来继续处理</p>
<p>Lua 脚本语法 <a target="_blank" rel="noopener" href="http://www.runoob.com/lua/lua-basic-syntax.html">http://www.runoob.com/lua/lua-basic-syntax.html</a></p>
<h5 id="Splash-对象属性"><a href="#Splash-对象属性" class="headerlink" title="Splash 对象属性"></a>Splash 对象属性</h5><h6 id="args"><a href="#args" class="headerlink" title="args"></a>args</h6><p>该属性可以获取加载时配置的参数</p>
<p>Splash 支持将 main 方法的第二个参数直接设置为 args，第二个参数 args 就相当于 splash.args 属性，下面两个方法是等价的</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(splash, args)</span></span></span><br><span class="line">	<span class="keyword">local</span> url = args.url</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(splash)</span></span></span><br><span class="line">	<span class="keyword">local</span> url = splash.args.url</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="js-enabled"><a href="#js-enabled" class="headerlink" title="js_enabled"></a>js_enabled</h6><p>Splash 的 JavaScript 执行开关，设置为 true 或 false 来控制是否执行 JavaScript，默认开启一般不用设置</p>
<h6 id="resource-timeout"><a href="#resource-timeout" class="headerlink" title="resource_timeout"></a>resource_timeout</h6><p>设置加载超时时间，单位秒，0 或 nil 不检测超时</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">splash.resourcce_timeout = <span class="number">0.1</span></span><br></pre></td></tr></table></figure>

<h6 id="images-enabled"><a href="#images-enabled" class="headerlink" title="images_enabled"></a>images_enabled</h6><p>设置图片是否加载，默认加载，禁用后可以节省流量提高网页加载速度，禁用后可能会影响 JavaScript 渲染，因为禁用后外层DOM节点高度会受影响，进而影响 DOM 节点位置</p>
<p>Splash 使用了缓存，如果一开始加载出来了网页图片，然后禁用图片加载，重新加载页面，之前加载好的图片可能还会显示出来，重启Splash即可</p>
<h6 id="plugins-enabled"><a href="#plugins-enabled" class="headerlink" title="plugins_enabled"></a>plugins_enabled</h6><p>可以控制浏览器插件（如Flash插件）是否开启，默认 false</p>
<h6 id="scroll-postion"><a href="#scroll-postion" class="headerlink" title="scroll_postion"></a>scroll_postion</h6><p>可以控制页面上下或左右滚动</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">splash.scroll_position = &#123;y=<span class="number">400</span>&#125;</span><br><span class="line">splash.scroll_position = &#123;x=<span class="number">200</span>, y=<span class="number">400</span>&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Splash-对象的方法"><a href="#Splash-对象的方法" class="headerlink" title="Splash 对象的方法"></a>Splash 对象的方法</h5><h6 id="go"><a href="#go" class="headerlink" title="go"></a>go</h6><p>请求某个链接，可以模拟GET和POST请求，支持传入请求头、表单</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ok, reason = splash:go&#123;url, baseurl=<span class="literal">nil</span>, headers=<span class="literal">nil</span>, http_method=<span class="string">&quot;GET&quot;</span>, body=<span class="literal">nil</span>, formdata=<span class="literal">nil</span>&#125;</span><br><span class="line"></span><br><span class="line">#baseurl 资源加载相对路径 可选</span><br><span class="line">#body POST请求时的表单数据 Content-<span class="built_in">type</span> 为 application/json</span><br><span class="line">#fordata POST请求时的表单数据 Content-<span class="built_in">type</span> 为 application/x-www-form-urlencoded</span><br></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(splash, args)</span></span></span><br><span class="line">	<span class="keyword">local</span> ok, reason = splash:go&#123;<span class="string">&quot;http://httpbin.org/post&quot;</span>, http_method=<span class="string">&quot;POST&quot;</span>, body=<span class="string">&quot;name=Germey&quot;</span>&#125;</span><br><span class="line">	<span class="keyword">if</span> ok <span class="keyword">then</span></span><br><span class="line">		<span class="keyword">return</span> splash:html() #返回网页源码</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="wait"><a href="#wait" class="headerlink" title="wait"></a>wait</h6><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ok, reason = splash:wait&#123;<span class="built_in">time</span>, cancel_on_redirect=<span class="literal">false</span>, cancel_on_error=<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure>

<p>cancel_on_redirect 可选，默认false，如果发生了重定向就停止等待，并返回重定向结果</p>
<p>cancel_on_error 可选，默认false，如果发生了加载错误，就停止等待</p>
<h6 id="jsfunc"><a href="#jsfunc" class="headerlink" title="jsfunc"></a>jsfunc</h6><p>可以直接调用 JavaScript 定义的方法，调用的方法需要用双中括号包围</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(splash, args)</span></span></span><br><span class="line">  <span class="keyword">local</span> get_div_count = splash:jsfunc(<span class="string">[[</span></span><br><span class="line"><span class="string">  function()&#123;</span></span><br><span class="line"><span class="string">    var body = document.body;</span></span><br><span class="line"><span class="string">    var divs = body.getElementsByTagName(&#x27;div&#x27;);</span></span><br><span class="line"><span class="string">    return divs.length;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  ]]</span>)</span><br><span class="line">  splash:go(<span class="string">&quot;https://www.baidu.com&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> (<span class="string">&quot;There are %s DIVS&quot;</span>):<span class="built_in">format</span>(get_div_count())</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>更多JavaScript 到 Lua 转换细节 <a target="_blank" rel="noopener" href="https://splash.readthedocs.io/en/stable/scripting-ref.html">https://splash.readthedocs.io/en/stable/scripting-ref.html</a></p>
<h6 id="evaljs"><a href="#evaljs" class="headerlink" title="evaljs"></a>evaljs</h6><p>可以执行 JavaScript 代码并返回最后一条 JavaScript 语句的返回结果</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> title = splash:evaljs(<span class="string">&quot;document.title&quot;</span>)</span><br></pre></td></tr></table></figure>

<h6 id="runjs"><a href="#runjs" class="headerlink" title="runjs"></a>runjs</h6><p>可以执行 JavaScript 代码，与 evaljs() 功能类似，但更偏向于执行某些动作或声明某些方法</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">splash:runjs(<span class="string">&quot;foo = function() &#123; return &#x27;bar&#x27; &#125;&quot;</span>) #声明一个JavaScript定义的方法</span><br><span class="line"><span class="keyword">local</span> result = splash:evaljs(<span class="string">&quot;foo()&quot;</span>) #通过evaljs()调用得到结果</span><br></pre></td></tr></table></figure>

<h6 id="autoload"><a href="#autoload" class="headerlink" title="autoload()"></a>autoload()</h6><p>可以设置每个页面访问时自动加载的对象</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ok, reason = splash:autoload&#123;source_or_url, source=<span class="literal">nil</span>, url=<span class="literal">nil</span>&#125;</span><br></pre></td></tr></table></figure>

<p>source_or_url JavaScript 代码或者 JavaScript 库链接</p>
<p>source JavaScript 代码</p>
<p>url JavaScript 库链接</p>
<p>此方法只负责加载 JavaScript 代码或库，不执行任何操作，如果要执行，evaljs()</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(splash, args)</span></span></span><br><span class="line">	splash:autoload(<span class="string">[[</span></span><br><span class="line"><span class="string">  function get_document_title()&#123;</span></span><br><span class="line"><span class="string">    return document.title;</span></span><br><span class="line"><span class="string">  &#125;  </span></span><br><span class="line"><span class="string">  ]]</span>)</span><br><span class="line">  splash:go(<span class="string">&quot;https://www.baidu.com&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> splash:evaljs(<span class="string">&quot;get_document_title()&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>这里用 autoload 声明了一个 JavaScript 方法</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(splash, args)</span></span></span><br><span class="line">	<span class="built_in">assert</span>(splash:autoload(<span class="string">&quot;https://code.jquery.com/jquery-2.1.3.min.js&quot;</span>))</span><br><span class="line">  <span class="built_in">assert</span>(splash:go(<span class="string">&quot;https://www.taobao.com&quot;</span>))</span><br><span class="line">  <span class="keyword">local</span> version = splash:evaljs(<span class="string">&quot;$.fn.jquery&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;JQuery version&#x27;</span> .. version</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="call-later"><a href="#call-later" class="headerlink" title="call_later()"></a>call_later()</h6><p>可以通过设置定时任务和延迟时间来实现任务延迟执行，并且可以在执行前通过 cancel() 方法重新执行特定任务</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timer = splash:call_later(callback, delay)</span><br></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(splash, args)</span></span></span><br><span class="line">  <span class="keyword">local</span> snapshots = &#123;&#125;</span><br><span class="line">  <span class="keyword">local</span> timer = splash:call_later(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    snapshots[<span class="string">&quot;a&quot;</span>] = splash:png()</span><br><span class="line">    splash:wait(<span class="number">1.0</span>)</span><br><span class="line">    snapshots[<span class="string">&quot;b&quot;</span>] = splash:png()</span><br><span class="line">  <span class="keyword">end</span>, <span class="number">1.5</span>)</span><br><span class="line">  <span class="built_in">assert</span>(splash:go(<span class="string">&quot;https://www.baidu.com&quot;</span>))</span><br><span class="line">  splash:wait(<span class="number">3.0</span>)</span><br><span class="line">  timer:reraise()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> snapshots</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>设置了一个定时任务，1.5 秒的时候获取网页截图，等待1秒，2.5秒的时候再获取网页截图</p>
<h6 id="http-get"><a href="#http-get" class="headerlink" title="http_get()"></a>http_get()</h6><p>模拟发送 HTTP 的 GET请求</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response = splash:http_get(url, headers=<span class="literal">nil</span>, follow_redirects=<span class="literal">true</span>)</span><br></pre></td></tr></table></figure>

<p>follow_redirects 是否启动自动重定向 默认 true</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(splash, args)</span></span></span><br><span class="line">	<span class="keyword">local</span> treat = <span class="built_in">require</span>(<span class="string">&quot;treat&quot;</span>)</span><br><span class="line">	<span class="keyword">local</span> response = splash:http_get(<span class="string">&quot;http://httpbin.org/get&quot;</span>)</span><br><span class="line">  	<span class="keyword">return</span> &#123;</span><br><span class="line">      html = treat.as_string(response.body),</span><br><span class="line">      url = response.url,</span><br><span class="line">      <span class="built_in">status</span> = response.<span class="built_in">status</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="http-post"><a href="#http-post" class="headerlink" title="http_post()"></a>http_post()</h6><p>模拟 POST 请求</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response = splash:http_post&#123;url, headers=<span class="literal">nil</span>, follow_redirects=<span class="literal">true</span>, body=<span class="literal">nil</span>&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(splash, args)</span></span></span><br><span class="line">	<span class="keyword">local</span> treat = <span class="built_in">require</span>(<span class="string">&quot;treat&quot;</span>)</span><br><span class="line">  <span class="keyword">local</span> json = <span class="built_in">require</span>(<span class="string">&quot;json&quot;</span>)</span><br><span class="line">	<span class="keyword">local</span> response = splash:http_post&#123;<span class="string">&quot;http://httpbin.org/post&quot;</span>,</span><br><span class="line">  	body=json.encode(&#123;name=<span class="string">&quot;Germey&quot;</span>&#125;),</span><br><span class="line">    headers = &#123;[<span class="string">&quot;content-type&quot;</span>] = <span class="string">&quot;application/json&quot;</span>&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  	<span class="keyword">return</span> &#123;</span><br><span class="line">      html = treat.as_string(response.body),</span><br><span class="line">      url = response.url,</span><br><span class="line">      <span class="built_in">status</span> = response.<span class="built_in">status</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="set-content"><a href="#set-content" class="headerlink" title="set_content()"></a>set_content()</h6><p>用来设置页面内容</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">funciton main(splash)</span><br><span class="line">	<span class="built_in">assert</span>(splash:set_content(<span class="string">&quot;&lt;html&gt;&lt;body&gt;hello&lt;/body&gt;&lt;/html&gt;&quot;</span>))</span><br><span class="line">	<span class="keyword">return</span> splash:png()</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="html"><a href="#html" class="headerlink" title="html"></a>html</h6><p>获取网页源代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return splash:html()</span><br></pre></td></tr></table></figure>

<h6 id="png、jpeg"><a href="#png、jpeg" class="headerlink" title="png、jpeg"></a>png、jpeg</h6><p>获取 PNG/JPEG 格式的页面截图</p>
<h6 id="har"><a href="#har" class="headerlink" title="har"></a>har</h6><p>获取页面加载过程描述信息</p>
<h6 id="url"><a href="#url" class="headerlink" title="url"></a>url</h6><p>获取当前正在访问的URL</p>
<h6 id="get-cookies"><a href="#get-cookies" class="headerlink" title="get_cookies()"></a>get_cookies()</h6><p>获取当前页面的 Cookies</p>
<h6 id="add-cookie"><a href="#add-cookie" class="headerlink" title="add_cookie()"></a>add_cookie()</h6><p>添加 Cookie</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cookies = splash:add_cookie&#123;name, value, <span class="built_in">path</span>=<span class="literal">nil</span>, domain=<span class="literal">nil</span>, expires=<span class="literal">nil</span>, httpOnly=<span class="literal">nil</span>, secure=<span class="literal">nil</span>&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(splash)</span></span></span><br><span class="line">	splash:add_cookie&#123;<span class="string">&quot;sessionid&quot;</span>, <span class="string">&quot;34234jojo&quot;</span>, <span class="string">&quot;/&quot;</span>, domain=<span class="string">&quot;http://example.com&quot;</span>&#125;</span><br><span class="line">  splash:go(<span class="string">&quot;http://example.com&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> splash:html()</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="clear-cookies"><a href="#clear-cookies" class="headerlink" title="clear_cookies()"></a>clear_cookies()</h6><p>清除所有 cookies</p>
<h6 id="get-viewport-size"><a href="#get-viewport-size" class="headerlink" title="get_viewport_size()"></a>get_viewport_size()</h6><p>获取当前浏览器页面的大小，即宽高</p>
<h6 id="set-viewport-size"><a href="#set-viewport-size" class="headerlink" title="set_viewport_size()"></a>set_viewport_size()</h6><p>设置浏览器页面宽高</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">splash:set_viewport(<span class="number">400</span>, <span class="number">700</span>)</span><br></pre></td></tr></table></figure>

<h6 id="set-viewport-full"><a href="#set-viewport-full" class="headerlink" title="set_viewport_full()"></a>set_viewport_full()</h6><p>设置浏览器全屏显示</p>
<h6 id="set-user-agent"><a href="#set-user-agent" class="headerlink" title="set_user_agent"></a>set_user_agent</h6><p>设置浏览器 User-Agent</p>
<h6 id="set-custom-headers"><a href="#set-custom-headers" class="headerlink" title="set_custom_headers()"></a>set_custom_headers()</h6><p>设置请求头</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">splash:set_custom_headers(&#123;</span><br><span class="line">	[<span class="string">&quot;User-Agent&quot;</span>] = <span class="string">&quot;Splash&quot;</span>,</span><br><span class="line">	[<span class="string">&quot;Site&quot;</span>] = <span class="string">&quot;Splash&quot;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h6 id="select"><a href="#select" class="headerlink" title="select"></a>select</h6><p>选中符合条件的第一个节点，如果有多个符合条件只会返回一个，参数是CSS 选择器</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">input</span> = splash:<span class="built_in">select</span>(<span class="string">&quot;#kw&quot;</span>)</span><br><span class="line"><span class="built_in">input</span>:send_text(<span class="string">&#x27;Splash&#x27;</span>)</span><br><span class="line">splash:wait(<span class="number">3</span>)</span><br><span class="line"><span class="keyword">return</span> splash:png()</span><br></pre></td></tr></table></figure>

<h6 id="select-all"><a href="#select-all" class="headerlink" title="select_all()"></a>select_all()</h6><p>选中所有符合条件的节点，参数是CSS 选择器</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">local</span> treat = <span class="built_in">require</span>(<span class="string">&#x27;treat&#x27;</span>)</span><br><span class="line"><span class="built_in">assert</span>(splash:go(<span class="string">&quot;https://quotes.toscrape.com/&quot;</span>))</span><br><span class="line"><span class="keyword">local</span> texts = splash:select_all(<span class="string">&#x27;.quote .text&#x27;</span>)</span><br><span class="line"> <span class="keyword">for</span> index, text <span class="keyword">in</span> <span class="built_in">ipairs</span>(texts) <span class="keyword">do</span></span><br><span class="line">   results[index] = text.node.innerHTML</span><br><span class="line"> <span class="keyword">end</span></span><br><span class="line"> <span class="keyword">return</span> treat.as_array(results)</span><br></pre></td></tr></table></figure>

<p>通过 CSS 选择器选中了节点的正文内容，随后遍历所有节点，将内容获取下来</p>
<h6 id="mouse-click"><a href="#mouse-click" class="headerlink" title="mouse_click"></a>mouse_click</h6><p>可以模拟鼠标点击操作，参数为坐标x和y，也可以直接选中某个节点</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">input</span> = splash:<span class="built_in">select</span>(<span class="string">&#x27;#kw&#x27;</span>)</span><br><span class="line"><span class="built_in">input</span>:send_text(<span class="string">&#x27;Splash&#x27;</span>)</span><br><span class="line">submit = splash:<span class="built_in">select</span>(<span class="string">&#x27;#su&#x27;</span>)</span><br><span class="line">submit:mouse_click()</span><br></pre></td></tr></table></figure>



<p>针对页面元素的API操作 <a target="_blank" rel="noopener" href="https://splash.readthedocs.io/en/stable/scripting-element-object.html">https://splash.readthedocs.io/en/stable/scripting-element-object.html</a></p>
<h5 id="Splash-API-调用"><a href="#Splash-API-调用" class="headerlink" title="Splash API 调用"></a>Splash API 调用</h5><p>如何利用 Splash 渲染页面，Splash 提供了一些 HTTP API 接口，只需要请求这些接口并传递相应的参数即可</p>
<h6 id="render-html"><a href="#render-html" class="headerlink" title="render.html"></a>render.html</h6><p>用于获取 JavaScript 渲染的页面的 HTML 代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:8050&#x2F;render.html?url&#x3D;https:&#x2F;&#x2F;www.baidu.com</span><br></pre></td></tr></table></figure>

<p>传递一个url参数来指定渲染 URL，返回结果即页面渲染后的源代码</p>
<p>Python 实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">url = <span class="string">&#x27;http://localhost:8050/render.html?url=https://www.baidu.com&#x27;</span></span><br><span class="line">response = requests.get(url)</span><br><span class="line">print(respons.text)</span><br></pre></td></tr></table></figure>

<p>此接口还可以指定其它参数 如wait 等待秒数 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url = <span class="string">&#x27;http://localhost:8050/render.html?url=https://www.baidu.com&amp;wait=5&#x27;</span></span><br></pre></td></tr></table></figure>

<p>还支持代理设置、图片加载设置、Headers 设置、请求方法设置</p>
<p>具体用法 <a target="_blank" rel="noopener" href="https://splash.readthedocs.io/en/stable/api.html">https://splash.readthedocs.io/en/stable/api.html</a></p>
<h6 id="render-png"><a href="#render-png" class="headerlink" title="render.png"></a>render.png</h6><p>可以获取网页截图，参数比 render.html 多了几个 比如 width 和 height 来控制宽高</p>
<p>返回 PNG 格式的图片二进制数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:8050&#x2F;render.png?url&#x3D;https:&#x2F;&#x2F;www.baidu.com&amp;wait&#x3D;5&amp;width&#x3D;1000&amp;height&#x3D;700</span><br></pre></td></tr></table></figure>

<p>具体用法 <a target="_blank" rel="noopener" href="https://splash.readthedocs.io/en/stable/api.html">https://splash.readthedocs.io/en/stable/api.html</a></p>
<h6 id="render-jpeg"><a href="#render-jpeg" class="headerlink" title="render.jpeg"></a>render.jpeg</h6><p>和 render.png 类似，返回 JPEG 格式二进制图片</p>
<h6 id="render-har"><a href="#render-har" class="headerlink" title="render.har"></a>render.har</h6><p>获取页面加载的 HAR 数据，JSON 格式的</p>
<h6 id="render-json"><a href="#render-json" class="headerlink" title="render.json"></a>render.json</h6><p>包含了前面接口所有功能，JSON 格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:8050&#x2F;render.json?url&#x3D;http:&#x2F;&#x2F;httpbin.org</span><br></pre></td></tr></table></figure>

<p>可以传入不同的参数控制返回结果，传入html=1 返回结果会增加源代码数据 png=1 增加 PNG 截图数据，传入 har=1 会获得页面 HAR 数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:8050&#x2F;render.json?url&#x3D;http:&#x2F;&#x2F;httpbin.org&amp;html&#x3D;1&amp;png&#x3D;1&amp;har&#x3D;1</span><br></pre></td></tr></table></figure>

<h6 id="execute"><a href="#execute" class="headerlink" title="execute"></a>execute</h6><p>用此接口便可实现与 Lua脚本的对接</p>
<p>如果实现一些交互操作的话，使用 execute 接口</p>
<p>写个简单的脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function main(splash)</span><br><span class="line">	return &#39;hello&#39;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>然后将此接口转化为 URL 编码的字符串，拼接到 execute 接口后面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:8050&#x2F;execute?lua_source&#x3D;function+main%jo342342</span><br></pre></td></tr></table></figure>

<p>lua_source 参数传递了转码后的 Lua 脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line">lua = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">function main(splash)</span></span><br><span class="line"><span class="string">	return &#x27;hello&#x27;</span></span><br><span class="line"><span class="string">end</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">url = <span class="string">&#x27;http://localhost:8050/execute?lua_source=&#x27;</span> + quote(lua)</span><br><span class="line">response = requests.get(url)</span><br></pre></td></tr></table></figure>

<p>返回 JSON 格式，成功获取了请求的 URL、状态码、网页源代码</p>
<h5 id="Splash-负载均衡配置"><a href="#Splash-负载均衡配置" class="headerlink" title="Splash 负载均衡配置"></a>Splash 负载均衡配置</h5><p>具体配置 <a target="_blank" rel="noopener" href="https://setup.scrape.center/splash-loadbalance">https://setup.scrape.center/splash-loadbalance</a></p>
<p>Splash 做页面抓取时，如果爬取的量非常大，任务非常多，用一个Splash服务来处理压力太大，搭建一个负载均衡器把压力分散到服务器上，相当于多台机器多个服务共同参与任务的处理，减小单个 Splash服务的压力</p>
<h6 id="配置-Splash-服务"><a href="#配置-Splash-服务" class="headerlink" title="配置 Splash 服务"></a>配置 Splash 服务</h6><p>要搭建 Splash 负载均衡，首先要有多个 Splash 服务</p>
<p>比如 4台远程主机的 8050 端口上都开启了 Splash 服务，访问其中任何一个服务时，都可以使用 Splash 服务</p>
<h6 id="配置负载均衡"><a href="#配置负载均衡" class="headerlink" title="配置负载均衡"></a>配置负载均衡</h6><p>任意一台带有公网IP 的主机配置负载均衡，主机上装好 Nginx 修改 Nginx 配置文件 nginx.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">	upstream splash &#123;</span><br><span class="line">		least_conn;</span><br><span class="line">		server 41.159.27:8050;</span><br><span class="line">		server 41.159.27:8050;</span><br><span class="line">		server 41.159.27:8050;</span><br><span class="line">		server 41.159.27:8050;</span><br><span class="line">	&#125;</span><br><span class="line">	server&#123;</span><br><span class="line">		listen 8050;</span><br><span class="line">		location &#x2F; &#123;</span><br><span class="line">			proxy_pass http:splash;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>。。。</p>
<p>配置完成后重启 Nginx 服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -s reload</span><br></pre></td></tr></table></figure>

<p>直接访问 Nginx 所在服务器的 8050 端口，即可实现负载均衡了</p>
<h6 id="配置认证"><a href="#配置认证" class="headerlink" title="配置认证"></a>配置认证</h6>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/02/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-11JavaScript%E9%80%86%E5%90%912/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/02/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-11JavaScript%E9%80%86%E5%90%912/" class="post-title-link" itemprop="url">Python3网络爬虫开发实战-11JavaScript逆向2</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-10-02 23:49:23" itemprop="dateCreated datePublished" datetime="2022-10-02T23:49:23+08:00">2022-10-02</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-10-09 08:57:19" itemprop="dateModified" datetime="2022-10-09T08:57:19+08:00">2022-10-09</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>JavaScript Beautifier：<a target="_blank" rel="noopener" href="https://beautifier.io/">https://beautifier.io/</a>  格式化工具</p>
<h4 id="AST"><a href="#AST" class="headerlink" title="AST"></a>AST</h4><p>AST 是源代码的抽象语法结构的树状表示，树上的每个节点都表示源代码中的一种结构</p>
<p>AST 在线解析网站 <a target="_blank" rel="noopener" href="https://astexplorer.net/">https://astexplorer.net/</a></p>
<h4 id="Babel"><a href="#Babel" class="headerlink" title="Babel"></a>Babel</h4><p>JavaScript 语法编译器，内置了很多分析 JavaScript 代码的方法，可以实现 JavaScript 代码到 AST 的转换</p>
<p>安装 Babel 命令行工具 @babel/node</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g @babel&#x2F;node</span><br></pre></td></tr></table></figure>

<p>初始化 Node.js 项目 learn-ast，在 learn-ast 目录下运行初始化命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm init</span><br><span class="line">npm install -D @babel&#x2F;core @babel&#x2F;cli @babel&#x2F;preset-env</span><br></pre></td></tr></table></figure>

<p>运行完毕后，就会生成一个 package.json 文件并在 devDependencies 中列出了刚安装的几个 Node.js 包</p>
<p>接着需要在 learn-ast 目录下创建 .babelrc 文件，内容</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;presets&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;@babel/preset-env&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这就完成了初始化操作</p>
<h5 id="节点类型"><a href="#节点类型" class="headerlink" title="节点类型"></a>节点类型</h5><p>Babel 中所支持的一些类型：</p>
<ul>
<li>Literal</li>
</ul>
<p>字面量，即简单的文字表示，3、”abc”、true 这些都是基本的字面量，又可以进一步分为</p>
<p>RegExpLiteral、NullLiteral、StringLiteral、BooleanLiteral、NumericLiteral、BigIntLiteral 等类型，更确却地代表某一种字面量</p>
<ul>
<li>Identifier</li>
</ul>
<p>标识符，指代一些变量的名称，const name = ‘Germy’，name 就是一个标识符</p>
<ul>
<li>Expressions表达式</li>
</ul>
<p>还有其他类型 Declarations声明、Statements语句、Classes类、Functions方法声明、Modules模块、Program程序</p>
<h5 id="babel-parser"><a href="#babel-parser" class="headerlink" title="@babel/parser"></a>@babel/parser</h5><p>Babel 中的 JavaScript 解析器，也是一个 Node.js 包</p>
<p>parse 方法，支持解析一段 JavaScript 代码，输入一段 JavaScript 代码，输出 JavaScript 代码对应的抽象语法树，即 AST</p>
<p>parseExpression方法，尝试解析单个 JavaScript 表达式并考虑了性能问题，一般直接使用 parse 就够了</p>
<ul>
<li>测试</li>
</ul>
<p>新建 JavaScript 文件，codes/code1.js </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="number">3</span></span><br><span class="line"><span class="keyword">let</span> string = <span class="string">&#x27;hello&#x27;</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; a; i++)&#123;</span><br><span class="line">	string += <span class="string">&#x27;world&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;string&#x27;</span>, string)</span><br></pre></td></tr></table></figure>

<p>新建 basic1.js </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">&quot;@babel/parser&quot;</span></span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&quot;fs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = fs.readFileSync(<span class="string">&#x27;code/code1.js&#x27;</span>,<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> ast = parse(code)</span><br><span class="line"><span class="built_in">console</span>.log(ast)</span><br></pre></td></tr></table></figure>

<p>使用 babel-node 运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">babel-node basic1.js</span><br></pre></td></tr></table></figure>

<p>报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">internal&#x2F;modules&#x2F;cjs&#x2F;loader.js:1032</span><br><span class="line">    throw err;</span><br><span class="line">    ^</span><br><span class="line">Error: Cannot find module &#39;@babel&#x2F;core&#39;</span><br></pre></td></tr></table></figure>

<ul>
<li>解决办法：全局安装core</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g @babel&#x2F;core</span><br></pre></td></tr></table></figure>

<p>转换为 AST 之后，怎样再把 AST 转回 JavaScript 代码？可以借助 generate 方法</p>
<h5 id="babel-generate"><a href="#babel-generate" class="headerlink" title="@babel/generate"></a>@babel/generate</h5><p>提供了 generate 方法将 AST 还原成 JavaScript 代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">&quot;@babel/parser&quot;</span></span><br><span class="line"><span class="keyword">import</span> generate <span class="keyword">from</span> <span class="string">&quot;@babel/generator&quot;</span></span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&quot;fs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = fs.readFileSync(<span class="string">&#x27;code/code1.js&#x27;</span>,<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> ast = parse(code)</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="attr">code</span>: output &#125; = generate(ast)</span><br><span class="line"><span class="built_in">console</span>.log(output)</span><br></pre></td></tr></table></figure>

<p>generate 方法还可以在第二个参数接收一些配置选项，第三个参数可以接收原代码作为输出参考</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> output = generate(ast, &#123;<span class="comment">/*options*/</span>&#125;, code)</span><br></pre></td></tr></table></figure>

<p>比如，想要和原代码维持相同的代码行</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="attr">code</span>:output &#125; = generate(ast, &#123;</span><br><span class="line">	retainLines: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(output)</span><br></pre></td></tr></table></figure>

<p>这时生成的代码中间没有出现空行了，和原来的代码保持一致</p>
<h5 id="babel-traverse"><a href="#babel-traverse" class="headerlink" title="@babel/traverse"></a>@babel/traverse</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -D @babel&#x2F;traverse</span><br></pre></td></tr></table></figure>

<h6 id="遍历"><a href="#遍历" class="headerlink" title="遍历"></a>遍历</h6><p>AST 的遍历使用 @babel/traverse，接收一个 AST，利用 traverse 方法就可以遍历其中的所有节点，遍历方法中，我们便可以对每个节点进行操作了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">&quot;@babel/parser&quot;</span></span><br><span class="line"><span class="keyword">import</span> generate <span class="keyword">from</span> <span class="string">&quot;@babel/generator&quot;</span></span><br><span class="line"><span class="keyword">import</span> traverse <span class="keyword">from</span> <span class="string">&quot;@babel/traverse&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&quot;fs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = fs.readFileSync(<span class="string">&#x27;code/code1.js&#x27;</span>,<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> ast = parse(code)</span><br><span class="line">traverse(ast,&#123;</span><br><span class="line">	<span class="function"><span class="title">enter</span>(<span class="params">path</span>)</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(path)</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>traverse 第二个参数定义了相关处理逻辑，声明了一个 enter 方法，接收 path 参数，这个 enter 方法在每个节点被遍历到时都会被调用，其中 path 里面就包含了当前被遍历到的节点的相关信息，运行查看输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">babel-node basic1.js</span><br></pre></td></tr></table></figure>

<p>输出内容比较复杂，它的类型是 NodePath，拥有 parent、container、node、scope、type 等多个属性</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">NodePath &#123;</span><br><span class="line">  contexts: [</span><br><span class="line">    TraversalContext &#123;</span><br><span class="line">      queue: [<span class="built_in">Array</span>],</span><br><span class="line">      priorityQueue: [],</span><br><span class="line">      parentPath: [NodePath],</span><br><span class="line">      scope: [Scope],</span><br><span class="line">      state: <span class="literal">undefined</span>,</span><br><span class="line">      opts: [<span class="built_in">Object</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  state: <span class="literal">undefined</span>,</span><br><span class="line">  opts: &#123; <span class="attr">enter</span>: [ [<span class="built_in">Function</span>: enter] ], <span class="attr">_exploded</span>: <span class="literal">true</span>, <span class="attr">_verified</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  _traverseFlags: <span class="number">0</span>,</span><br><span class="line">  skipKeys: <span class="literal">null</span>,</span><br><span class="line">  parentPath: NodePath &#123;</span><br></pre></td></tr></table></figure>

<p>比如 node 属性是一个 Node 类型的对象，代表正在遍历的节点，利用 parent 也能获得一个 Node 类型对象，代表该节点的父节点</p>
<h6 id="修改值"><a href="#修改值" class="headerlink" title="修改值"></a>修改值</h6><p>所以可以利用 path.node 拿到当前对应的 Node 对象，利用 path.parent 拿到当前 Node 对象的父节点。我们可以利用它来对 Node 进行一些处理</p>
<p>比如：可以把值变化下，原代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="number">3</span></span><br><span class="line"><span class="keyword">let</span> string = <span class="string">&#x27;hello&#x27;</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; a; i++)&#123;</span><br><span class="line">	string += <span class="string">&#x27;world&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;string&#x27;</span>, string)</span><br></pre></td></tr></table></figure>

<p>想要利用修改 AST 的方式对上面代码修改，变成下面代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="number">5</span></span><br><span class="line"><span class="keyword">let</span> string = <span class="string">&#x27;hi&#x27;</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; a; i++)&#123;</span><br><span class="line">	string += <span class="string">&#x27;world&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;string&#x27;</span>, string)</span><br></pre></td></tr></table></figure>

<p>可以实现这样的逻辑</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">&quot;@babel/parser&quot;</span></span><br><span class="line"><span class="keyword">import</span> generate <span class="keyword">from</span> <span class="string">&quot;@babel/generator&quot;</span></span><br><span class="line"><span class="keyword">import</span> traverse <span class="keyword">from</span> <span class="string">&quot;@babel/traverse&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&quot;fs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = fs.readFileSync(<span class="string">&#x27;code/code1.js&#x27;</span>,<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> ast = parse(code)</span><br><span class="line">traverse(ast,&#123;</span><br><span class="line">	<span class="function"><span class="title">enter</span>(<span class="params">path</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">let</span> node = path.node</span><br><span class="line">		<span class="keyword">if</span> (node.type == <span class="string">&quot;NumericLiteral&quot;</span> &amp;&amp; node.value == <span class="number">3</span>) &#123;</span><br><span class="line">			node.value = <span class="number">5</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (node.type == <span class="string">&quot;StringLiteral&quot;</span> &amp;&amp; node.value == <span class="string">&quot;hello&quot;</span>) &#123;</span><br><span class="line">			node.value = <span class="string">&quot;hi&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="attr">code</span>: output &#125; = generate(ast)</span><br><span class="line"><span class="built_in">console</span>.log(output)</span><br></pre></td></tr></table></figure>

<p>除了定义 enter 方法之外，我们还可以定义对应特定类型的解析方法，这样遇到此类型的节点时，该方法就会被自动调用，单独定义特定类型的解析方法会显得更有条理</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">traverse(ast,&#123;</span><br><span class="line">	<span class="function"><span class="title">NumericLiteral</span>(<span class="params">path</span>)</span>&#123;</span><br><span class="line">		<span class="function"><span class="title">if</span>(<span class="params">path.node.value==<span class="number">3</span></span>)</span>&#123;</span><br><span class="line">			path.node.value = <span class="number">6</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="function"><span class="title">StringLiteral</span>(<span class="params">path</span>)</span>&#123;</span><br><span class="line">		<span class="function"><span class="title">if</span>(<span class="params">path.node.value==<span class="string">&quot;hello&quot;</span></span>)</span>&#123;</span><br><span class="line">			path.node.value = <span class="string">&quot;he&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h6 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h6><p>删除直接调用 remove 即可</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">&quot;@babel/parser&quot;</span></span><br><span class="line"><span class="keyword">import</span> generate <span class="keyword">from</span> <span class="string">&quot;@babel/generator&quot;</span></span><br><span class="line"><span class="keyword">import</span> traverse <span class="keyword">from</span> <span class="string">&quot;@babel/traverse&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&quot;fs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = fs.readFileSync(<span class="string">&#x27;code/code1.js&#x27;</span>,<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> ast = parse(code)</span><br><span class="line">traverse(ast,&#123;</span><br><span class="line">	<span class="function"><span class="title">CallExpression</span>(<span class="params">path</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">let</span> node = path.node</span><br><span class="line">		<span class="keyword">if</span> (</span><br><span class="line">			node.callee.object.name == <span class="string">&quot;console&quot;</span> &amp;&amp;</span><br><span class="line">			node.callee.property.name == <span class="string">&quot;log&quot;</span></span><br><span class="line">		) &#123;</span><br><span class="line">			path.remove()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="attr">code</span>: output &#125; = generate(ast,&#123;</span><br><span class="line">	retainLines: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(output)</span><br></pre></td></tr></table></figure>

<p>这样就删除了所有的 console.log 语句</p>
<p>如果要插入节点，需要先声明一个节点</p>
<h5 id="babel-types"><a href="#babel-types" class="headerlink" title="@babel/types"></a>@babel/types</h5><p>可以使用 types 声明一个新节点</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>想变成</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="number">1</span></span><br><span class="line"><span class="keyword">const</span> b = a + <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>将最终想变成的代码用 AST 解析</p>
<p><img src="/Users/caodaxun/hexo/source/_posts/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-11JavaScript%E9%80%86%E5%90%912/1.png" alt="1"></p>
<p>可以看到第二行的节点结构了，现在需要做的就是构造这个节点，需要从内而外依次构造</p>
<p>整行代码对应的节点是 VariableDeclarator，生成 VariableDeclarator 可以借助 types 的 variableDeclaration 方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//kind: 必须，可以是var let const</span></span><br><span class="line"><span class="comment">//declarations: 必须，是Array&lt;VariableDeclarator&gt; 即 VariableDeclarator </span></span><br><span class="line">t.variableDeclaration(kind, declarations)</span><br></pre></td></tr></table></figure>

<p>kind 可以确定，declarations 的构造借助 types 的 variableDeclarator 方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//id 必须，即 Identifier对象</span></span><br><span class="line"><span class="comment">//init Expression对象，默认空</span></span><br><span class="line">t.variableDeclarrator(id, init)</span><br></pre></td></tr></table></figure>

<p>因此还需要构造 id 和 init。这里 id 就是 b 了，借助 types 的 identifier 方法来构造</p>
<p>对 init，它是 expression，AST中可以看到它是 BinaryExpression 类型，可以借助 type 的 binaryExpression 来构造</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//operator 必须 +|-|*|%|&amp;|&gt; ...</span></span><br><span class="line"><span class="comment">//left、right Expression operator左侧/右侧表达式</span></span><br><span class="line">t.binaryExpression(operator, left, right)</span><br></pre></td></tr></table></figure>

<p>根据 AST 这里的 Expression 可以直接声明为 Identifier 和 NumericLiteral，分别用 types 的 identifier和numbeicLiteral创建。</p>
<p>梳理清楚后，从里到外将代码实现出来，一层层构造，最后就声明了一个 VariableDeclaration 类型的节点</p>
<p>最后调用 path 的 insertAfter 方法便可以成功将节点插入到path对应的节点</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">&quot;@babel/parser&quot;</span></span><br><span class="line"><span class="keyword">import</span> generate <span class="keyword">from</span> <span class="string">&quot;@babel/generator&quot;</span></span><br><span class="line"><span class="keyword">import</span> traverse <span class="keyword">from</span> <span class="string">&quot;@babel/traverse&quot;</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> types <span class="keyword">from</span> <span class="string">&quot;@babel/types&quot;</span></span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&quot;fs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = <span class="string">&#x27;const a = 1;&#x27;</span></span><br><span class="line"><span class="keyword">let</span> ast = parse(code)</span><br><span class="line">traverse(ast,&#123;</span><br><span class="line">	<span class="function"><span class="title">VariableDeclaration</span>(<span class="params">path</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">let</span> init = types.binaryExpression(</span><br><span class="line">			<span class="string">&#x27;+&#x27;</span>,</span><br><span class="line">			types.identifier(<span class="string">&#x27;a&#x27;</span>),</span><br><span class="line">			types.numberLiteral(<span class="number">1</span>)</span><br><span class="line">		)</span><br><span class="line">		<span class="keyword">let</span> declarator = types.variableDeclarator(types.identifier(<span class="string">&#x27;b&#x27;</span>), init)</span><br><span class="line">		<span class="keyword">let</span> declaration = types.variableDeclaration(<span class="string">&#x27;const&#x27;</span>, [declarator])</span><br><span class="line">		path.insertAfter(declaration)</span><br><span class="line">		path.stop()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> output = generate(ast,&#123;</span><br><span class="line">	retainLines: <span class="literal">true</span>,</span><br><span class="line">&#125;).code</span><br><span class="line"><span class="built_in">console</span>.log(output) <span class="comment">//const a = 1;const b = a + 1;</span></span><br></pre></td></tr></table></figure>

<p>更多 types 方法参考 <a target="_blank" rel="noopener" href="https://babeljs.io/docs/en/babel-types#binaryexpression">https://babeljs.io/docs/en/babel-types#binaryexpression</a></p>
<p>很多方法和节点都是对应的，利用方法便可以创建一个节点。</p>
<h4 id="利用AST还原混淆代码"><a href="#利用AST还原混淆代码" class="headerlink" title="利用AST还原混淆代码"></a>利用AST还原混淆代码</h4><h5 id="表达式还原"><a href="#表达式还原" class="headerlink" title="表达式还原"></a>表达式还原</h5><p>混淆的 JavaScript 代码就是把简单的东西复杂化了，比如一个布尔常量 true，被写成 !![]；一个数字，被转化为 parseInt 加一些字符串的拼接</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = !![]</span><br><span class="line"><span class="keyword">const</span> b = <span class="string">&quot;abc&quot;</span> == <span class="string">&quot;bcd&quot;</span></span><br><span class="line"><span class="keyword">const</span> c = (<span class="number">1</span>&lt;&lt;<span class="number">3</span>)|<span class="number">2</span></span><br><span class="line"><span class="keyword">const</span> d = <span class="built_in">parseInt</span>(<span class="string">&quot;5&quot;</span>+<span class="string">&quot;0&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>= 号的右边，其实都是一些表达式的类型，”abc” == “bcd” 就是一个 BinaryExpression，代表布尔类型的结果</p>
<p>将上述代码保存为 code1.js，编写还原代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">&quot;@babel/parser&quot;</span></span><br><span class="line"><span class="keyword">import</span> generate <span class="keyword">from</span> <span class="string">&quot;@babel/generator&quot;</span></span><br><span class="line"><span class="keyword">import</span> traverse <span class="keyword">from</span> <span class="string">&quot;@babel/traverse&quot;</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> types <span class="keyword">from</span> <span class="string">&quot;@babel/types&quot;</span></span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&quot;fs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = fs.readFileSync(<span class="string">&#x27;code/code1.js&#x27;</span>,<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> ast = parse(code)</span><br><span class="line">traverse(ast,&#123;</span><br><span class="line">	<span class="string">&quot;UnaryExpression|BinaryExpression|ConditionalExpression|CallExpression&quot;</span>:(</span><br><span class="line">		path</span><br><span class="line">	) =&gt; &#123;</span><br><span class="line">		<span class="keyword">const</span> &#123; confident, value &#125; = path.evaluate()</span><br><span class="line">		<span class="keyword">if</span> (value == <span class="literal">Infinity</span>||value==-<span class="literal">Infinity</span>) <span class="keyword">return</span></span><br><span class="line">		confident &amp;&amp; path.replaceWith(types.valueToNode(value))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="attr">code</span>: output &#125; = generate(ast)</span><br><span class="line"><span class="built_in">console</span>.log(output)</span><br></pre></td></tr></table></figure>

<p>结果 </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">onst a = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">const</span> b = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">const</span> c = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">const</span> d = <span class="built_in">parseInt</span>(<span class="string">&quot;50&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>利用 traverse 方法对 AST 对象进行遍历，是用 UnaryExpression|BinaryExpression|ConditionalExpression|CallExpression 作为对象的键名，分别用于处理一元表达式、布尔表达式、条件表达式、调用表达式，如果 AST 对应的 path 符合这几种表达式，就会执行定义的回调方法</p>
<p>回调方法中调用 path 的 evaluate 方法，该方法会对 path 对象进行执行，计算所得到的结果，内部实现返回 confident 和 value 字段表示置信度，如果认定结果可信，confident 就是 true</p>
<p>我们可以调用 types 的 replaceWith 方法把执行的结果 value 进行替换，否则不替换</p>
<h5 id="字符串还原"><a href="#字符串还原" class="headerlink" title="字符串还原"></a>字符串还原</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> strings = [<span class="string">&quot;\x68\x65\x6c\x6c\x6f&quot;</span>,<span class="string">&quot;\x77\x6f\x72\x6c\x64&quot;</span>]</span><br></pre></td></tr></table></figure>

<p><img src="/Users/caodaxun/hexo/source/_posts/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-11JavaScript%E9%80%86%E5%90%912/2.png" alt="2"></p>
<p><a target="_blank" rel="noopener" href="https://astexplorer.net/">https://astexplorer.net</a> 转换成 AST，看到两个字符串都被识别为 Literal 类型，都有一个 extra 属性，extra 属性里面有一个 raw 和 rawValue，rawValue 里面值已经被解析出来了</p>
<p>所以只需要将 StringLiteral 中的 raw 替换为 rawValue 即可</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">&quot;@babel/parser&quot;</span></span><br><span class="line"><span class="keyword">import</span> generate <span class="keyword">from</span> <span class="string">&quot;@babel/generator&quot;</span></span><br><span class="line"><span class="keyword">import</span> traverse <span class="keyword">from</span> <span class="string">&quot;@babel/traverse&quot;</span></span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&quot;fs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = fs.readFileSync(<span class="string">&#x27;code/code1.js&#x27;</span>,<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> ast = parse(code)</span><br><span class="line">traverse(ast,&#123;</span><br><span class="line">	<span class="function"><span class="title">StringLiteral</span>(<span class="params">&#123;node&#125;</span>)</span>&#123;</span><br><span class="line">		<span class="function"><span class="title">if</span>(<span class="params">node.extra &amp;&amp; <span class="regexp">/\\[ux]/gi</span>.test(node.extra.raw)</span>)</span>&#123; <span class="comment">//??</span></span><br><span class="line">			node.extra.raw = node.extra.rawValue</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="attr">code</span>: output &#125; = generate(ast)</span><br><span class="line"><span class="built_in">console</span>.log(output)</span><br></pre></td></tr></table></figure>

<h5 id="无用代码删除"><a href="#无用代码删除" class="headerlink" title="无用代码删除"></a>无用代码删除</h5><p>不会被执行的代码其实就是冗余的，加大分析难度</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> _0x16c18d = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!![[]]) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;this&quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;is&quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;dead&quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;code&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> _0x1f7292 = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="string">&quot;xmv2nOdfy2N&quot;</span>.charAt(<span class="number">4</span>) !== <span class="built_in">String</span>.fromCharCode(<span class="number">110</span>)) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;this&quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;is&quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;dead&quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;code&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;nice to meet you&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">_0x16c18d();</span><br><span class="line">_0x1f7292();</span><br></pre></td></tr></table></figure>

<p>代码粘贴到 <a target="_blank" rel="noopener" href="https://astexplorer.net/">https://astexplorer.net</a> 分析</p>
<p><img src="/Users/caodaxun/hexo/source/_posts/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-11JavaScript%E9%80%86%E5%90%912/3.png" alt="3"></p>
<p>选中第一个 if 语句，看到对应的就是一个 IfStatement 节点，有 type、start、end、loc、test、consequent、alternate 这几个属性。</p>
<p>test 就是 if 判定语句 就是 !![[]] ；consequent 就是 if 对应的代码区块，alternate 就是 else 对应代码区块</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">&quot;@babel/parser&quot;</span></span><br><span class="line"><span class="keyword">import</span> generate <span class="keyword">from</span> <span class="string">&quot;@babel/generator&quot;</span></span><br><span class="line"><span class="keyword">import</span> traverse <span class="keyword">from</span> <span class="string">&quot;@babel/traverse&quot;</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> types <span class="keyword">from</span> <span class="string">&quot;@babel/types&quot;</span></span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&quot;fs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = fs.readFileSync(<span class="string">&#x27;code/code1.js&#x27;</span>,<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> ast = parse(code)</span><br><span class="line">traverse(ast,&#123;</span><br><span class="line">	<span class="function"><span class="title">IfStatement</span>(<span class="params">path</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">let</span> &#123;consequent, alternate&#125; = path.node</span><br><span class="line">		<span class="keyword">let</span> testPath = path.get(<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line">		<span class="keyword">const</span> evaluateTest = testPath.evaluateTruthy()</span><br><span class="line">		<span class="keyword">if</span> (evaluateTest == <span class="literal">true</span>)&#123;</span><br><span class="line">			<span class="keyword">if</span> (types.isBlockStatement(consequent))&#123;</span><br><span class="line">				consequent = consequent.body</span><br><span class="line">			&#125;</span><br><span class="line">			path.replaceWithMultiple(consequent)</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (evaluateTest == <span class="literal">false</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (alternate != <span class="literal">null</span>)&#123;</span><br><span class="line">				<span class="keyword">if</span> (types.isBlockStatement(alternate))&#123;</span><br><span class="line">					alternate = alternate.body</span><br><span class="line">				&#125;</span><br><span class="line">				path.replaceWithMultiple(alternate)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        path.remove();</span><br><span class="line">      &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="attr">code</span>: output &#125; = generate(ast)</span><br><span class="line"><span class="built_in">console</span>.log(output)</span><br></pre></td></tr></table></figure>

<p>定义 IfStatement 处理方法，首先获取 path 对应节点 consequent 和 alternate 属性</p>
<p>然后拿到 test 属性对应 path 赋值为 testPath，调用 testPath 的 evaluateTruthy 方法，返回对应 path 的真值。如果为 true 的话，直接将整个 path 替换成 consequent 对应节点</p>
<h5 id="反控制流平坦化"><a href="#反控制流平坦化" class="headerlink" title="反控制流平坦化"></a>反控制流平坦化</h5><p>把原本正常执行的逻辑顺序进行了混淆，通过一些 if else 或者 switch 语句进行拆分，导致不能直观的看到各个区块执行的顺序</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> s = <span class="string">&quot;3|1|2&quot;</span>.split(<span class="string">&quot;|&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> x = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (s[x++]) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;1&quot;</span>:</span><br><span class="line">      <span class="keyword">const</span> a = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;2&quot;</span>:</span><br><span class="line">      <span class="keyword">const</span> b = <span class="number">3</span>;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;3&quot;</span>:</span><br><span class="line">      <span class="keyword">const</span> c = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>AST 分析</p>
<p><img src="/Users/caodaxun/hexo/source/_posts/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-11JavaScript%E9%80%86%E5%90%912/4.png" alt="4"></p>
<p>查看Switch的结构，是一个 SwitchStatement 节点，带有 discriminant 和 cases 两个属性。</p>
<p>discriminant 是判定条件，就是 s[x++]；cases 就是 3 哥 case 语句，对应 3 个 SwitchCase 节点 。。。</p>
<h4 id="特殊混淆案例还原"><a href="#特殊混淆案例还原" class="headerlink" title="特殊混淆案例还原"></a>特殊混淆案例还原</h4><h5 id="AAEncode的还原"><a href="#AAEncode的还原" class="headerlink" title="AAEncode的还原"></a>AAEncode的还原</h5><p>AAEncode 是一种 JavaScript 代码混淆算法，利用它，可以将 JavaScript 代码转换成颜文字表示的 JavaScript</p>
<h5 id="JJEncode的还原"><a href="#JJEncode的还原" class="headerlink" title="JJEncode的还原"></a>JJEncode的还原</h5><p>JJEncode 原理和 AAEncode 大同小异，将 JavaScript 代码转换成颜文字表示的 JavaScript</p>
<h4 id="WebAssembly"><a href="#WebAssembly" class="headerlink" title="WebAssembly"></a>WebAssembly</h4><p>借助 Emscripten 编译工具，能将 C/C++ 文件转成 wasm 格式的文件，JavaScript 可以直接调用该文件执行其中的方法</p>
<p>一些网站会加载一些 wasm 后缀的文件，即原生代码被编译成了 wasm 后缀的文件，JavaScript 通过调用 wasm 文件得到对应的计算结果，然后配合其他 JavaScript 代码实现页面数据的加载和页面渲染</p>
<p>案例：<a target="_blank" rel="noopener" href="https://spa14.scrape.center/">https://spa14.scrape.center</a></p>
<p>加载首页，通过 Network面板分析 Ajax 请求，找到第一页的 Ajax 请求。参数 limit、offset 参数控制分页，sign 参数用来做校验。接下来分析 sign 的生成逻辑</p>
<p>设置一个 Ajax 断点，Source 面板 XHR/fetch Breakpoints 添加一个断点，内容为 /api/movie，刷新会进入断点，再通过 Call Stack 调用栈判断逻辑的入口在 onFetchData 方法里面</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">onFetchData: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> t = <span class="built_in">this</span>;</span><br><span class="line">  <span class="built_in">this</span>.loading = !<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> n = (<span class="built_in">this</span>.page - <span class="number">1</span>) * <span class="built_in">this</span>.limit</span><br><span class="line">    , e = <span class="built_in">this</span>.$wasm.asm.encrypt(n, <span class="built_in">parseInt</span>(<span class="built_in">Math</span>.round((<span class="keyword">new</span> <span class="built_in">Date</span>).getTime() / <span class="number">1e3</span>).toString()));</span><br><span class="line">  <span class="built_in">this</span>.$axios.get(<span class="built_in">this</span>.$store.state.url.index, &#123;</span><br><span class="line">      params: &#123;</span><br><span class="line">          limit: <span class="built_in">this</span>.limit,</span><br><span class="line">          offset: n,</span><br><span class="line">          sign: e</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>sign 值即 e，通过调用 this.$wasm.asm 对象的 encrypt 方法传入 n 和一个时间戳构造出来。</p>
<p>在这个位置断点，重新刷新，查看 this.$wasm.asm 对象，其中它的 [FunctionLocation] 指向了一个位置，Wasm.wasm，跳转进入看到都是一些其他语言写的代码</p>
<h6 id="模拟执行"><a href="#模拟执行" class="headerlink" title="模拟执行"></a>模拟执行</h6><p>Source 面板 js 目录下下载 wasm 文件 Wasm.wasm</p>
<p>下载地址 <a target="_blank" rel="noopener" href="https://spa7.scrape.center/js/Wasm.wasm">https://spa7.scrape.center/js/Wasm.wasm</a></p>
<p>使用 Python 模拟执行 wasm</p>
<h6 id="pywasm"><a href="#pywasm" class="headerlink" title="pywasm"></a>pywasm</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install pywasm</span><br></pre></td></tr></table></figure>

<p>加载Wasm</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pywasm</span><br><span class="line">runtime = pywasm.load(<span class="string">&#x27;./Wasm.wasm&#x27;</span>)</span><br><span class="line">print(runtime)</span><br><span class="line">//&lt;pywasm.Runtime <span class="built_in">object</span> at <span class="number">0x7ff12b199250</span>&gt;</span><br></pre></td></tr></table></figure>

<p>返回结果是一个 pywasm.Runtime 类型的对象</p>
<p>有了这个 Runtime 对象之后，就可以调用它的 exec 方法来模拟执行 Wasm 里面的方法，传入对应的方法名和参数即可。第二个参数是一个列表，代表 encrypt 方法所接收的参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">result = runtime.exec(<span class="string">&#x27;encrypt&#x27;</span>, [<span class="number">1</span>,<span class="number">2</span>])</span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>

<h6 id="wasmer-python"><a href="#wasmer-python" class="headerlink" title="wasmer-python"></a>wasmer-python</h6><p>还可用 wasmer-python 完成同样的操作，功能更强大，提供了更为底层的 API，遇到更复杂的 wasm 可以用这个</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip3 install wasmer</span><br><span class="line">pip3 install wasmer wasmer_compiler_cranelift</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> wasmer <span class="keyword">import</span> engine, Store, Module, Instance</span><br><span class="line"><span class="keyword">from</span> wasmer_compiler_cranelift <span class="keyword">import</span> Compiler</span><br><span class="line"></span><br><span class="line">store = Store(engine.JIT(Compiler))</span><br><span class="line">module = Module(store, <span class="built_in">open</span>(<span class="string">&#x27;Wasm.wasm&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>).read())</span><br><span class="line">instance = Instance(module)</span><br><span class="line">result = instance.exports.encrypt(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>

<p>要读取 wasm 文件，需要先声明一个 Store 对象，然后将 wasm 对象转化为 Module 对象，再将其转化为 Instance 对象</p>
<p>API 用法参考 <a target="_blank" rel="noopener" href="https://wasmerio.github.io/wasmer-python/api/wasmer.html">https://wasmerio.github.io/wasmer-python/api/wasmer.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/02/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-11JavaScript%E9%80%86%E5%90%911/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/02/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-11JavaScript%E9%80%86%E5%90%911/" class="post-title-link" itemprop="url">Python3网络爬虫开发实战-11JavaScript逆向</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-10-02 00:02:54" itemprop="dateCreated datePublished" datetime="2022-10-02T00:02:54+08:00">2022-10-02</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-10-09 08:57:19" itemprop="dateModified" datetime="2022-10-09T08:57:19+08:00">2022-10-09</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="JavaScript-压缩"><a href="#JavaScript-压缩" class="headerlink" title="JavaScript 压缩"></a>JavaScript 压缩</h4><p>去除 JavaScript 代码中不必要的空格、换行等内容，使代码都压缩为几行内容，降低代码可读性，同时提高网站加载速度</p>
<p>目前主流的前端开发技术大多都会利用 webpack、Rolllup 等工具进行打包，webpack、Rollup 会对源代码进行编译和压缩，输出几个打包好的 JavaScript 文件</p>
<p>JavaScript 压缩技术只能在很小程度上起到防护作用</p>
<h4 id="JavaScript-混淆"><a href="#JavaScript-混淆" class="headerlink" title="JavaScript 混淆"></a>JavaScript 混淆</h4><p>使用变量替换、字符串阵列化、控制流平坦化、多态变异、僵尸函数、调试保护等手段，使代码变得难以阅读和分析</p>
<h4 id="JavaScript-加密"><a href="#JavaScript-加密" class="headerlink" title="JavaScript 加密"></a>JavaScript 加密</h4><p>将 JavaScript 代码进行加密，转成人无法阅读或者解析的代码，如借用 WebAssembly 技术，可以直接讲JavaScript代码用C/C++实现，JavaScript调用其变异后形成的文件来执行相应的功能</p>
<p>前端开发中，JavaScript 混淆的主要实现是 javascript-obfuscator 和 terser 这两个库，都能提供一些代码混淆功能，也都有对应的 webpack 和 Rollup 打包工具的插件</p>
<h5 id="javascript-obfuscator"><a href="#javascript-obfuscator" class="headerlink" title="javascript-obfuscator"></a>javascript-obfuscator</h5><p>需要安装 Node.js 12.x 及以上版本</p>
<p>新建文件夹 js-obfuscator，进入文件夹，初始化工作空间</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm init</span><br></pre></td></tr></table></figure>

<p>会提示输入一些信息，输入信息，然后创建 package.json 文件，这就完成项目初始化了。</p>
<p>接下来安装 javascript-obfuscator 库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i -D javascript-obfuscator</span><br></pre></td></tr></table></figure>

<p>完成后看到本地 js-obfuscator 文件夹下生成了一个 node_modules 文件夹，里面就包含了 javascript-obfuscator 这个库</p>
<img src="/Users/caodaxun/hexo/source/_posts/Python3网络爬虫开发实战-11JavaScript逆向1/1.png" alt="1" style="zoom:90%;" />

<p>实现混淆样例：</p>
<p>创建 main.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> code = <span class="string">`</span></span><br><span class="line"><span class="string">	let x = &#x27;1&#x27; + 1</span></span><br><span class="line"><span class="string">	console.log(&#x27;x&#x27;, x)</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="keyword">const</span> options = &#123;</span><br><span class="line">	compact: <span class="literal">false</span>,</span><br><span class="line">	controlFlowFlattening: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obfuscator = <span class="built_in">require</span>(<span class="string">&#x27;javascript-obfuscator&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">obfuscate</span>(<span class="params">code, options</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> obfuscator.obfuscate(code, options).getObfuscatedCode()</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(obfuscate(code, options))</span><br></pre></td></tr></table></figure>

<p>这里定义了两个变量：code，需要被混淆的代码；options，混淆选项</p>
<p>接下来引入 javascript-obfuscator 库，定义一个方法传入 code 和 options 获取混淆后的代码，控制台输出混淆后的代码</p>
<p><img src="/Users/caodaxun/hexo/source/_posts/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-11JavaScript%E9%80%86%E5%90%911/2.png" alt="2"></p>
<h6 id="代码压缩"><a href="#代码压缩" class="headerlink" title="代码压缩"></a>代码压缩</h6><p>参数 compact。压缩后变量名变成了十六进制形式字符串</p>
<h6 id="变量名混淆"><a href="#变量名混淆" class="headerlink" title="变量名混淆"></a>变量名混淆</h6><p>参数 <strong>identifierNamesGenerator</strong>。</p>
<p>通过这个参数可以控制变量名混淆的方式，如设置为 hexadecimal：则会将变量名替换为十六进制形式字符串，如0xabc123；设置为 mangled：将变量名替换为普通简写字符串，如 a、b、c</p>
<p>参数默认值 hexadecimal</p>
<p>参数  <strong>identifiersPrefix</strong> 。</p>
<p>还可以通过设置 <strong>identifiersPrefix</strong> 参数控制混淆后变量前缀</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">identifiersPrefix: &#39;germey&#39;</span><br></pre></td></tr></table></figure>

<p>混淆后的变量前缀加上了自定义的字符串 germey</p>
<p>参数 <strong>renameGlobals</strong> </p>
<p>这个参数可以指定是否混淆全局变量和函数名称，默认值为 false</p>
<h6 id="字符串混淆"><a href="#字符串混淆" class="headerlink" title="字符串混淆"></a>字符串混淆</h6><p>字符串混淆，即将一个字符串声明放到一个数组里，使之无法被直接搜到，可以通过 stringArray 参数来控制，默认为 true</p>
<p>还可以通过 rotateStringArray 参数来控制数组化后结果的元素顺序，默认 true；stringArrayEncoding 参数控制数组的编码形式，默认不开启编码；如果设置为 true 或者 base64，则会使用 base64 编码，如果设置为 rc4，则使用 RC4编码；stringArrayThreshold 控制启用编码的概率，返回0-1 默认值 0.8</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> options = &#123;</span><br><span class="line">	stringArray: <span class="literal">true</span>,</span><br><span class="line">  rotateStringArray: <span class="literal">true</span>,</span><br><span class="line">  stringArrayEncoding: <span class="literal">true</span>,</span><br><span class="line">  stringArrayThreshold: <span class="number">1</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>unicodeEscapeSequence 参数对字符串进行 Unicode 转码</p>
<h6 id="代码自我保护"><a href="#代码自我保护" class="headerlink" title="代码自我保护"></a>代码自我保护</h6><p>设置 selfDefending 参数开启代码自我保护功能，开启后，混淆后的 JavaScript 会强制以一行形式显示。如果将混淆后的代码进行格式化或者重命名，该段代码将无法执行</p>
<h6 id="控制流平坦化"><a href="#控制流平坦化" class="headerlink" title="控制流平坦化"></a>控制流平坦化</h6><p>控制流平坦化就是将代码的执行逻辑混淆，通过 controlFlowFlattening: true 参数</p>
<p>启用后，代码的执行时间会变长，最长达 1.5 倍之多</p>
<p>controlFlowFlatteningThreshold 参数控制比例，范围0-1</p>
<h6 id="无用代码注入"><a href="#无用代码注入" class="headerlink" title="无用代码注入"></a>无用代码注入</h6><p>参数 deadCodeInjection：true 开启。deadCodeInjectionThreshold 参数控制比例，0-1，默认0.4</p>
<h6 id="对象键名替换"><a href="#对象键名替换" class="headerlink" title="对象键名替换"></a>对象键名替换</h6><p>参数 transformObjectKeys：true 开启</p>
<h6 id="禁用控制台输出"><a href="#禁用控制台输出" class="headerlink" title="禁用控制台输出"></a>禁用控制台输出</h6><p>参数 disableConsoleOutput：true 来禁用掉 console.log 输出功能</p>
<h6 id="调试保护"><a href="#调试保护" class="headerlink" title="调试保护"></a>调试保护</h6><p>如果在JavaScript代码中加入 debugger 关键字，那么执行到该位置的时候，就会进入调试模式。如果在代码多个位置都加入 debugger 关键字，或者定义某个逻辑来反复执行 debugger，就会不断进入调试模式，原本的代码就无法顺畅执行了，这个过程可以称为调试保护。</p>
<p>参数 debugProtection：true 开启调试保护机制。debugProtectionInterval 启用无限调试</p>
<h6 id="域名锁定"><a href="#域名锁定" class="headerlink" title="域名锁定"></a>域名锁定</h6><p>domainLock：[‘cuiqingcai.com’] 控制JavaScript代码只能在特定的域名下运行，不能在其它网站运行</p>
<h6 id="特殊编码"><a href="#特殊编码" class="headerlink" title="特殊编码"></a>特殊编码</h6><p>还有些特殊的工具包，如 aaencode、jjencode、jsfuck 等，它们可以对代码进行混淆和编码</p>
<h5 id="WebAssembly"><a href="#WebAssembly" class="headerlink" title="WebAssembly"></a>WebAssembly</h5><p>将一些和兴逻辑使用其他语言（如C/C++语言）来编写，并编译成类似字节码的文件，并通过JavaScript调用执行，从而起到二进制级别的防护作用</p>
<h4 id="浏览器调试"><a href="#浏览器调试" class="headerlink" title="浏览器调试"></a>浏览器调试</h4><p><a target="_blank" rel="noopener" href="https://spa2.scrape.center/">https://spa2.scrape.center</a> 演示</p>
<h5 id="Chrome"><a href="#Chrome" class="headerlink" title="Chrome"></a>Chrome</h5><h6 id="查看节点事件"><a href="#查看节点事件" class="headerlink" title="查看节点事件"></a>查看节点事件</h6><p>打开开发者工具，通过 Elements 面板可以审查页面的节点信息。</p>
<p>右侧的 Styles 选项卡，可以看到节点对应的CSS样式，这里可以自行增删样式，实时预览效果。</p>
<p>Computed 选项卡，可以看到节点的盒子模型，比如内边距、外边距等</p>
<p>Event Listeners 选项卡，可以查看节点已绑定的事件。change：HTML元素改变时会触发；load：浏览器完成页面加载时会触发；click：用户点击HTML元素时会触发</p>
<p>选中切换到第2页的节点，查看绑定事件</p>
<img src="/Users/caodaxun/hexo/source/_posts/Python3网络爬虫开发实战-11JavaScript逆向1/3.png" alt="3" style="zoom:100%;" />

<p>这里有对应事件的代码位置。内容文件名为 chunk-vendors.77daf991.js，后面一个冒号紧跟数字 7，所以对应事件处理函数定义在 chunk-vendors.77daf991.js 文件的第 7 行。点击会跳转到对应的位置。</p>
<h6 id="代码美化"><a href="#代码美化" class="headerlink" title="代码美化"></a>代码美化</h6><p>通过 Event Listeners 找到绑定事件，跳转到代码所在位置。点击代码面板左下角的格式化按钮 <code>&#123;&#125;</code>，格式化代码</p>
<p>会出现一个 chunk-vendors.77daf991.js:formatted 选项卡。</p>
<p><img src="/Users/caodaxun/hexo/source/_posts/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-11JavaScript%E9%80%86%E5%90%911/4.png" alt="4"></p>
<h6 id="断点调试"><a href="#断点调试" class="headerlink" title="断点调试"></a>断点调试</h6><p>添加断点只需点击对应行号，点击第2页的按钮触发断点，看到断点触发，页面中显示 Paused in debugger 提示。</p>
<p><img src="/Users/caodaxun/hexo/source/_posts/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-11JavaScript%E9%80%86%E5%90%911/5.png" alt="5"></p>
<p>Watch面板</p>
<p>这里可以自行添加想要查看的变量和方法，点击右上角+，可以添加任意想要监听的对象</p>
<p>如这里比较关注o.apply 方法，点击添加 o.apply，这里就会把对应的方法定义呈现出来，展开后再点击 FunctionLocation 定位其源码位置。</p>
<p>Console 面板</p>
<p>这里可以输入任意JavaScript代码执行输出对应结果</p>
<h6 id="观察调用栈"><a href="#观察调用栈" class="headerlink" title="观察调用栈"></a>观察调用栈</h6><p>debugger 调试过程中单步执行后，Call Stack 可以查看调用栈</p>
<h6 id="Ajax-断点"><a href="#Ajax-断点" class="headerlink" title="Ajax 断点"></a>Ajax 断点</h6><p>在 Sources 面板下面，找到 XHR/fetch Breakpoints，这里就可以设置 Ajax 断点</p>
<p><img src="/Users/caodaxun/hexo/source/_posts/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-11JavaScript%E9%80%86%E5%90%911/6.png" alt="6"></p>
<p>要设置断点，先要观察 Ajax 请求，点击第2页，在Network面板观察 Ajax 请求是怎样的。</p>
<p>看到请求的URL中包含 <code>/api/movie</code> 这样的内容。所以可以在 XHR/fetch Breakpoints 添加拦截规则，点+号，添加  <code>/api/movie</code></p>
<p>再点击第3页，触发第3页的 Ajax 请求。</p>
<p><img src="/Users/caodaxun/hexo/source/_posts/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-11JavaScript%E9%80%86%E5%90%911/7.png" alt="7"></p>
<p>发现它停到了Ajax最后发送的那个时候。再通过 Call Stack 顺着找到前序调用逻辑，最后找到一个 onFetchData 的方法</p>
<p><img src="/Users/caodaxun/hexo/source/_posts/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-11JavaScript%E9%80%86%E5%90%911/8.png" alt="8"></p>
<p>这里使用 axios 库发起了一个 Ajax 请求，还有 limit、offset、token 这3个参数</p>
<h6 id="改写-JavaScript-文件"><a href="#改写-JavaScript-文件" class="headerlink" title="改写 JavaScript 文件"></a>改写 JavaScript 文件</h6><p>浏览器的 overrides 功能，在 Sources 面板左侧，可以在 Overrides 面板上选定一个本地的文件夹，用于保存需要更改的 JavaScript 文件</p>
<p>在定位到 onFetchData 方法，查看格式化后的代码。</p>
<p>因为格式化后的代码是无法在浏览器中直接修改的，可以将格式化后的代码复制到文本编辑器中，添加一行代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">&#125;).then((<span class="function"><span class="keyword">function</span>(<span class="params">a</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;response&#x27;</span>, a);<span class="comment">//添加一行代码</span></span><br><span class="line">  <span class="keyword">var</span> e = a.data, </span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>接着将修改后的内容替换到原来的JavaScript文件（未格式化的代码）直接替换 JavaScript 的所有内容，保存后 Overrides 选项文件夹里面看到新生成文件。刷新页面看到控制台打印了请求结果</p>
<p>这里还可以增加一些 JavaScript 逻辑，比如直接将变量 a 的结果通过 API 发送到远程服务器，并通过服务器将数据保存下来，这就完成了拦截 Ajax 请求并保存了。</p>
<h4 id="JavaScript-Hook-的使用"><a href="#JavaScript-Hook-的使用" class="headerlink" title="JavaScript Hook 的使用"></a>JavaScript Hook 的使用</h4><p>Tampermonkey 插件也叫油猴，利用它我们几乎可以在网页中执行任何 JavaScript 代码，实现想要的功能</p>
<p><a target="_blank" rel="noopener" href="https://greasyfork.org/zh-CN/scripts">https://greasyfork.org/zh-CN/scripts</a> 可以找到一些实用脚本</p>
<p>API：<a target="_blank" rel="noopener" href="https://www.tampermonkey.net/documentation.php">https://www.tampermonkey.net/documentation.php</a></p>
<p>Hook JavaScript 里的base64编码</p>
<p>btoa 方法，在JavaScript中该方法用于将字符串编码成 base64 字符串。</p>
<h5 id="Tampermonkey-注入"><a href="#Tampermonkey-注入" class="headerlink" title="Tampermonkey 注入"></a>Tampermonkey 注入</h5><p>新建 Tampermonkey 脚本</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@name HookBase64</span></span><br><span class="line"><span class="comment">//@namespace https://login1.scrape.center/ </span></span><br><span class="line"><span class="comment">//@match https://login1.scrape.center/ //脚本生效网址</span></span><br><span class="line"><span class="comment">//@grant none</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="meta">	&#x27;use strict&#x27;</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">hook</span>(<span class="params">object, attr</span>)</span>&#123; <span class="comment">//hook object对象的attr参数</span></span><br><span class="line">    <span class="keyword">var</span> func = object[attr]</span><br><span class="line">    object[attr] = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;hooked&#x27;</span>, object, attr)</span><br><span class="line">      <span class="keyword">var</span> ret = func.apply(object, <span class="built_in">arguments</span>)</span><br><span class="line">      <span class="keyword">debugger</span></span><br><span class="line">      <span class="keyword">return</span> ret</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  hook(<span class="built_in">window</span>, btoa)</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>先把原方法赋值为一个变量 var func = object[attr]，即调用 func 就可以实现和原来相同的功能，接着改写方法的定义，将 object[attr] = function() 改写成一个新的方法，新方法中 func.apply 方法重新调用原来方法，保证前后执行方法不受影响。</p>
<p>自定义方法之后，我们在方法前后加入了自己的代码</p>
<h5 id="控制台注入"><a href="#控制台注入" class="headerlink" title="控制台注入"></a>控制台注入</h5><p>可以将代码复制输入到 控制台，执行完后相当于把 window 的 btoa 方法改写了</p>
<p>控制台测试 btoa(‘germey’)</p>
<h5 id="重写-JavaScript"><a href="#重写-JavaScript" class="headerlink" title="重写 JavaScript"></a>重写 JavaScript</h5><p>Hook 代码在控制台输入的，一旦页面刷新就不生效了</p>
<p>借助 Chrome 的 Overrides 功能，Overrides会在本地生成一个 JavaScript 文件副本，以后每次刷新都会使用副本内容</p>
<p>随便选个 JavaScript 脚本，添加上 Hook 代码，保存</p>
<h4 id="使用Python模拟执行JavaScript"><a href="#使用Python模拟执行JavaScript" class="headerlink" title="使用Python模拟执行JavaScript"></a>使用Python模拟执行JavaScript</h4><p>使用库 PyExecJS</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install pyexecjs</span><br></pre></td></tr></table></figure>

<p>PyExecJS 是用于执行 JavaScript 的，但执行JavaScript的功能还需要依赖JavaScript运行环境，安装好这个库之外，还需要安装一个JavaScript运行环境，Node.js</p>
<p>案例：<a target="_blank" rel="noopener" href="https://spa7.scrape.center/">https://spa7.scrape.center</a></p>
<p>一个NBA球星网站，展示一些球星的基本信息，每张卡片都有个加密字符串</p>
<p>打开开发者工具很容易找到加密字符串的生成逻辑，可以通过断点查看</p>
<p><img src="/Users/caodaxun/hexo/source/_posts/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-11JavaScript%E9%80%86%E5%90%911/9.png" alt="9"></p>
<p>getToken 方法的输入就是单个球员的信息，整个加密逻辑就是提取球员的名字、生日、身高、体重接着进行base64，然后进行DES加密</p>
<p>加密算法依赖 crypto-js 库，使用 CryptoJS 对象来实现加密算法。</p>
<p>执行 crypto-js 库对应的这个 JavaScript 文件（crypto-js.main.js）之后，CryptoJS 就被注入浏览器全局环境下了</p>
<h5 id="模拟调用"><a href="#模拟调用" class="headerlink" title="模拟调用"></a>模拟调用</h5><p>将 getToken 方法改写下，this.key 固定</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getToken</span>(<span class="params">player</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">let</span> key = CryptoJS.enc.Utf8.parse(<span class="string">&#x27;fip...&#x27;</span>)</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为这个方法的模拟执行需要 CryptoJS 这个对象，如果直接调用这个方法，会报 CryptoJS 未定义错误，还需要模拟执行 crypto-js.main.js </p>
<p>所以模拟执行分两步：</p>
<p>模拟执行 crypto-js.main.js 里面的JavaScript，用于声明 CryptoJS 对象</p>
<p>模拟运行 getToken 方法的定义，用于声明 getToken 方法</p>
<p>使用 PyExecJS 模拟执行：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> execjs</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">item = &#123;</span><br><span class="line">  <span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;xx&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;image&#x27;</span>: <span class="string">&#x27;xx.png&#x27;</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line">file = <span class="string">&#x27;crypto.js&#x27;</span></span><br><span class="line"><span class="comment">//使用execjs的get方法获取JavaScript执行环境，赋值为node</span></span><br><span class="line">node = execjs.get()</span><br><span class="line">ctx = node.complie(open(file).read)</span><br><span class="line">js = f<span class="string">&quot;getToken(&#123;json.dumps(item,ensure_ascii=False)&#125;)&quot;</span></span><br><span class="line">print(js)</span><br><span class="line">result = ctx.eval(js)</span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>

<p>调用node的complie方法，传入crypto.js 文件的文本内容，complie 方法会返回一个 JavaScript 的上下文对象，赋值给 ctx。这里可以理解为 ctx 对象里面执行过了 crypto-js.main.js，CryptoJS 就声明好了，然后紧接着 getToken 方法的声明也被执行，所以 getToken 方法也定义好了</p>
<p>定义 js变量，传入球员信息，执行js，返回最终加密字符串</p>
<h4 id="使用Node-js模拟执行JavaScript"><a href="#使用Node-js模拟执行JavaScript" class="headerlink" title="使用Node.js模拟执行JavaScript"></a>使用Node.js模拟执行JavaScript</h4><p>想要计算出每位球星所对应的加密字符串，是要加载 Crypto 库并执行 getToken 方法，这里直接用 Node.js 来实现</p>
<p>把 crypto-js.main.js 文件中的内容复制下来，新建 crypto.js 文件把内容粘贴进去</p>
<p>新建 main.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> CryptoJS = <span class="built_in">require</span>(<span class="string">&quot;./crypto&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getToken</span>(<span class="params">player</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">let</span> key = CryptoJS.enc.Utf8.parse(<span class="string">&#x27;fip...&#x27;</span>)</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> player = &#123;</span><br><span class="line">  <span class="string">&#x27;xx&#x27;</span>: <span class="string">&#x27;xx&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(getToken(player))</span><br></pre></td></tr></table></figure>

<p>直接使用 Node.js 中的 require 方法导入 crypto.js 这个文件，然后将其赋值为 CryptoJS 对象，这样就完成了 CryptoJS 对象的初始化</p>
<p>运行 main.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node main.js</span><br></pre></td></tr></table></figure>

<p>如果想用 Python 来编写整个爬虫，怎么和 Node.js 来对接呢</p>
<p>可以使用 Node.js 把上面算法暴露成一个 HTTP服务就好，这样 Python 直接调用 Node.js 暴露的HTTP 服务，通过 Request Body 传入球员信息，加密字符串通过 HTTP 的 Response 返回</p>
<p>Node.js 中最流行的 HTTP 服务框架 - express</p>
<p>安装 express</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i express</span><br></pre></td></tr></table></figure>

<h4 id="浏览器环境下JavaScript的模拟执行"><a href="#浏览器环境下JavaScript的模拟执行" class="headerlink" title="浏览器环境下JavaScript的模拟执行"></a>浏览器环境下JavaScript的模拟执行</h4><p>使用 playwright 来实现浏览器辅助逆向</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip3 install playwright</span><br><span class="line">playwright install</span><br></pre></td></tr></table></figure>

<p>运行两条命令后，会安装 playwright 库，并安装 Chromium、Firefox、WebKit 三个内核的浏览器供 playwright 直接使用</p>
<p>浏览器中已经把上下文环境和依赖都加载成功了，只需要把局部方法挂在到全局window对象上</p>
<p>利用 playwright 的 Request Interception 机制将想要替换的任意文件进行替换</p>
<p>站点 <a target="_blank" rel="noopener" href="https://spa2.scrape.center/">https://spa2.scrape.center</a> 的 Ajax 请求参数带有一个token</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> token = (<span class="built_in">this</span>.page-<span class="number">1</span>)*<span class="built_in">this</span>.limit,e=<span class="built_in">Object</span>(i[<span class="string">&quot;a&quot;</span>])(<span class="built_in">this</span>.$store.state.url.index,a)</span><br></pre></td></tr></table></figure>

<p>实现 Object(i[“a”]) 的全局挂载，只需要将其赋值给 window 对象的一个属性即可，添加</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.encrypt = <span class="built_in">Object</span>(i[<span class="string">&quot;a&quot;</span>])</span><br></pre></td></tr></table></figure>

<p>接着将修改后的 JavaScript 代码文件保存到本地，命名为 chunk.js</p>
<p>接下来利用 playwright 启动一个浏览器，并使用 Request Interception 将 JavaScript 文件替换</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> playwright.sync_api <span class="keyword">import</span> sync_playwright</span><br><span class="line">BASE_URL = <span class="string">&#x27;https://spa2.scrape.center&#x27;</span></span><br><span class="line">context = sync_playwright().start()</span><br><span class="line">browser = context.chromium.launch()</span><br><span class="line">page = browser.new_page()</span><br><span class="line">page.route(</span><br><span class="line">	<span class="string">&quot;/js/chunk-10192a00.243cb8b7.js&quot;</span>,</span><br><span class="line">  <span class="keyword">lambda</span> route: route.fulfill(path=<span class="string">&quot;./chunk.js&quot;</span>)</span><br><span class="line">)</span><br><span class="line">page.goto(BASE_URL)</span><br></pre></td></tr></table></figure>

<p>首先用 playwright 创建无头浏览器，利用 new_page 创建一个新的页面，并定义了一个关键的路由。</p>
<p>路由第一个参数：原本加载的文件路径。通过请求的Headers 中可以看到 Request URL</p>
<p> <a target="_blank" rel="noopener" href="https://spa2.scrape.center/js/chunk-10192a00.243cb8b7.js">https://spa2.scrape.center/js/chunk-10192a00.243cb8b7.js</a></p>
<p>路由第二个参数：利用 route 的 fulfill 方法指定本地的文件</p>
<p>这样 playwright 加载 /js/chunk-10192a00.243cb8b7.js 文件的时候，其内容就会被替换为我们本地保存的 chunk.js 文件</p>
<ul>
<li>模拟调用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_token</span>(<span class="params">offset</span>):</span></span><br><span class="line">  result = page.evaluate(<span class="string">&#x27;&#x27;&#x27;()=&gt;&#123;</span></span><br><span class="line"><span class="string">  	return window.encrypt(&quot;%s&quot;, &quot;%s&quot;)</span></span><br><span class="line"><span class="string">  &#125;&#x27;&#x27;&#x27;</span> % (<span class="string">&#x27;/api/movie&#x27;</span>, offset))</span><br><span class="line">  <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>
















      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/20/JavaScript%EF%BC%88%E4%B8%89%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/20/JavaScript%EF%BC%88%E4%B8%89%EF%BC%89/" class="post-title-link" itemprop="url">JavaScript（三）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-20 22:26:26" itemprop="dateCreated datePublished" datetime="2022-09-20T22:26:26+08:00">2022-09-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-09-28 17:09:37" itemprop="dateModified" datetime="2022-09-28T17:09:37+08:00">2022-09-28</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="4-面向对象编程"><a href="#4-面向对象编程" class="headerlink" title="4 面向对象编程"></a>4 面向对象编程</h4><p>JavaScript 不区分类和实例的概念，而是通过原型（prototype）来实现面向对象编程</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Student = &#123;</span><br><span class="line">    name: <span class="string">&#x27;Robot&#x27;</span>,</span><br><span class="line">    height: <span class="number">1.2</span>,</span><br><span class="line">    run: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="built_in">this</span>.name + <span class="string">&#x27; is running...&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> xiaoming = &#123;</span><br><span class="line">    name: <span class="string">&#x27;小明&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">xiaoming.__proto__ = Student;</span><br></pre></td></tr></table></figure>

<p>最后一行代码把 xiaoming 的原型指向了对象 Student，看上去 xiaoming 仿佛是从 Student 继承下来的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xiaoming.name;<span class="comment">//‘小明’</span></span><br><span class="line">xiaoming.run();<span class="comment">//小明 is running...</span></span><br></pre></td></tr></table></figure>

<p>xiaoming 有自己的 name 属性，但并没有 run() 方法，run() 是从 Student 继承而来</p>
<p>所谓继承关系不过是把一个对象的原型指向另一个对象</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Bird = &#123;</span><br><span class="line">    fly: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="built_in">this</span>.name + <span class="string">&#x27; is flying...&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">xiaoming.__proto__ = Bird;</span><br></pre></td></tr></table></figure>

<p>在 JavaScript 代码运行时期，可以把 xiaoming 从 Student 变成 Bird，或者变成任何对象</p>
<p>编写 JavaScript 代码时，不要直接用 <code>obj.__proto__</code> 去改变一个对象的原型。<code>Object.create()</code> 方法可以传入一个原型对象，并创建一个基于该原型的新对象，但是新对象什么属性都没有</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 原型对象:</span></span><br><span class="line"><span class="keyword">var</span> Student = &#123;</span><br><span class="line">    name: <span class="string">&#x27;Robot&#x27;</span>,</span><br><span class="line">    height: <span class="number">1.2</span>,</span><br><span class="line">    run: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="built_in">this</span>.name + <span class="string">&#x27; is running...&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createStudent</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 基于Student原型创建一个新对象:</span></span><br><span class="line">    <span class="keyword">var</span> s = <span class="built_in">Object</span>.create(Student);</span><br><span class="line">    <span class="comment">// 初始化新对象:</span></span><br><span class="line">    s.name = name;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> xiaoming = createStudent(<span class="string">&#x27;小明&#x27;</span>);</span><br><span class="line">xiaoming.run(); <span class="comment">// 小明 is running...</span></span><br><span class="line">xiaoming.__proto__ === Student; <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>这是创建原型继承的一种方法</p>
<h5 id="4-1-创建对象"><a href="#4-1-创建对象" class="headerlink" title="4.1 创建对象"></a>4.1 创建对象</h5><p>JavaScript 对每个创建的对象都会设置一个原型，指向它的原型对象</p>
<p>当我们用 object.xxx 访问一个对象的属性时，JavaScript 引擎先在当前对象上查找该属性，如果没有找到，就到其原型对象上找，如果还没有找到，就一直上溯到 Object.prototype 对象，最后如果还没有找到，就只能返回 undefined</p>
<p>例如，创建一个 Array 对象</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br></pre></td></tr></table></figure>

<p>其原型链是</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arr ----&gt; <span class="built_in">Array</span>.prototype ----&gt; <span class="built_in">Object</span>.prototype ----&gt; <span class="literal">null</span></span><br></pre></td></tr></table></figure>

<h6 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h6><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Student</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">    <span class="built_in">this</span>.hello = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        alert(<span class="string">&#x27;Hello, &#x27;</span> + <span class="built_in">this</span>.name + <span class="string">&#x27;!&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> xiaoming = <span class="keyword">new</span> Student(<span class="string">&#x27;小明&#x27;</span>);</span><br><span class="line">xiaoming.name; <span class="comment">// &#x27;小明&#x27;</span></span><br><span class="line">xiaoming.hello(); <span class="comment">// Hello, 小明!</span></span><br></pre></td></tr></table></figure>

<p>如果不写 new，这就是一个普通函数，它返回 undefined，如果写了 new，就变成了一个构造函数，它绑定的 this 指向新创建的对象，并默认返回 this，最后不用写 return this</p>
<p>new Student() 创建的对象还从原型上获得了一个 constructor 属性，它指向 Student 本身</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xiaoming.constructor === Student.prototype.constructor; <span class="comment">// true</span></span><br><span class="line">Student.prototype.constructor === Student; <span class="comment">// true</span></span><br><span class="line"><span class="built_in">Object</span>.getPrototypeOf(xiaoming) === Student.prototype; <span class="comment">// true</span></span><br><span class="line">xiaoming <span class="keyword">instanceof</span> Student; <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>如果又创建了 xiaohong，对象的原型与 xiaoming 是一样的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xiaoming.name; <span class="comment">// &#x27;小明&#x27;</span></span><br><span class="line">xiaohong.name; <span class="comment">// &#x27;小红&#x27;</span></span><br><span class="line">xiaoming.hello; <span class="comment">// function: Student.hello()</span></span><br><span class="line">xiaohong.hello; <span class="comment">// function: Student.hello()</span></span><br><span class="line">xiaoming.hello === xiaohong.hello; <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>xiaoming 与 xiaohong 各自的 hell 是一个函数，但他们是两个不同的函数。如果我们通过 new Student() 创建了很多对象，这些对象的 hell 函数实际上只需要共享同一个函数就可以了，这样可以节省内存</p>
<p>要让创建的对象共享一个 hello 函数，只要把 hello 函数移动到 xiaoming、xiaohong 这些对象共同的原型上九可以了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Student</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Student.prototype.hello = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    alert(<span class="string">&#x27;Hello, &#x27;</span> + <span class="built_in">this</span>.name + <span class="string">&#x27;!&#x27;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>构造函数不要忘记写 new，为了区分普通函数和构造函数，按照约定，构造函数首字母应当大写，普通函数首字母应当小写</p>
<p>我们还可以编写一个 createStudent() 函数，在内部封装所有的 new 操作，一个常用的编程模式像这样</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Student</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.name = props.name || <span class="string">&#x27;匿名&#x27;</span>; <span class="comment">// 默认值为&#x27;匿名&#x27;</span></span><br><span class="line">    <span class="built_in">this</span>.grade = props.grade || <span class="number">1</span>; <span class="comment">// 默认值为1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Student.prototype.hello = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    alert(<span class="string">&#x27;Hello, &#x27;</span> + <span class="built_in">this</span>.name + <span class="string">&#x27;!&#x27;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createStudent</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Student(props || &#123;&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个 createStudent 参数灵活，可以不传，也可以这么传</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xiaoming = createStudent(&#123;</span><br><span class="line">    name: <span class="string">&#x27;小明&#x27;</span></span><br><span class="line">&#125;);</span><br><span class="line">xiaoming.grade; <span class="comment">// 1</span></span><br></pre></td></tr></table></figure>

<p>如果创建的对象有很多属性，只需要传递需要的某些属性，剩下的属性可以用默认值</p>
<h6 id="原型继承"><a href="#原型继承" class="headerlink" title="原型继承"></a>原型继承</h6><p>JavaScript 的原型继承实现方式是</p>
<p>1、定义新的构造函数，并在内部用 call() 调用希望继承的构造函数，并绑定 this</p>
<p>2、借助中间函数 F 实现原型链继承，最好通过封装的 inherits 函数完成</p>
<p>3、继续在新的构造函数的原型上定义新方法</p>
<h5 id="4-2-class-继承"><a href="#4-2-class-继承" class="headerlink" title="4.2 class 继承"></a>4.2 class 继承</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">name</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">hello</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    alert(<span class="string">&#x27;hello,&#x27;</span>+<span class="built_in">this</span>.name+<span class="string">&#x27;!&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>class 的定义包含了构造函数 constructor 和定义在原型对象上的函数 hello()（注意没有function关键字）这就避免了 Student.prototype.hello = function(){…} 这样分散的代码</p>
<p>创建一个 Student 对象</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xiaoming = <span class="keyword">new</span> Student(<span class="string">&#x27;xiaoming&#x27;</span>);</span><br><span class="line">xiaoming.hello();</span><br></pre></td></tr></table></figure>

<h6 id="class-继承"><a href="#class-继承" class="headerlink" title="class 继承"></a>class 继承</h6><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrimaryStudent</span> <span class="keyword">extends</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">name, grade</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">super</span>(name);<span class="comment">//super调用父类构造方法</span></span><br><span class="line">    <span class="built_in">this</span>.grade = grade;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">myGrade</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    alert(<span class="string">&#x27;I am at grade&#x27;</span>+<span class="built_in">this</span>.grade);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-浏览器"><a href="#5-浏览器" class="headerlink" title="5 浏览器"></a>5 浏览器</h4><h5 id="5-1-浏览器对象"><a href="#5-1-浏览器对象" class="headerlink" title="5.1 浏览器对象"></a>5.1 浏览器对象</h5><p>JavaScript 可以获取浏览器提供的很多对象，并进行操作</p>
<h6 id="window"><a href="#window" class="headerlink" title="window"></a>window</h6><p>window 对象不但充当全局作用域，而且表示浏览器窗口</p>
<p>window 有 innerWidth、innerHeight 属性，可以获取浏览器窗口的内部宽度和高度，内部宽高指除去菜单栏、工具栏、边框等占位元素后，用于显示网页的净宽高</p>
<p>对应的还有 outerWidth、outerHeight 获取浏览器窗口的整个宽高</p>
<h6 id="navigator"><a href="#navigator" class="headerlink" title="navigator"></a>navigator</h6><p>navigator 对象表示浏览器的信息</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">navigator.appName;<span class="comment">//浏览器名称</span></span><br><span class="line">navigator.appVersion;<span class="comment">//浏览器版本</span></span><br><span class="line">navigator.language;<span class="comment">//浏览器设置的语言</span></span><br><span class="line">navigator.platform;<span class="comment">//操作系统类型</span></span><br><span class="line">navigator.uaerAgent;<span class="comment">//浏览器设定的User-Agent字符串</span></span><br></pre></td></tr></table></figure>

<p>navigator 的信息可以很容易被用户修改，所以 JavaScript 读取的值不一定是正确的</p>
<p>针对不同浏览器编写不同的代码，用if判断浏览器版本，例如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> width;</span><br><span class="line"><span class="keyword">if</span> (getIEVersion(navigator.userAgent)&lt;<span class="number">9</span>)&#123;</span><br><span class="line">  width = <span class="built_in">document</span>.body.clientWidth;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  width = <span class="built_in">window</span>.innerWidth;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样可能判断不准确，也很难维护，正确方法是充分利用 JavaScript 对不存在属性返回 undefined 的特性</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> width = <span class="built_in">window</span>.innerWidth || <span class="built_in">document</span>.body.clientWidth;</span><br></pre></td></tr></table></figure>

<h6 id="screen"><a href="#screen" class="headerlink" title="screen"></a>screen</h6><p>screen 对象表示屏幕信息</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">screen.width;<span class="comment">//屏幕宽度，以像素为单位</span></span><br><span class="line">screen.colorDepth;<span class="comment">//返回颜色位数，如 8、16、24</span></span><br></pre></td></tr></table></figure>

<h6 id="location"><a href="#location" class="headerlink" title="location"></a>location</h6><p>location 对象表示当前页面的 URL 信息</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//www.example.com:8080/path/index.html?a=1&amp;b=2#TOP</span></span><br><span class="line"></span><br><span class="line">location.protocol;<span class="comment">//http</span></span><br><span class="line">location.host;<span class="comment">//www.example.com</span></span><br><span class="line">location.port;<span class="comment">//8080</span></span><br><span class="line">location.pathname;<span class="comment">// /path/index.html</span></span><br><span class="line">location.search;<span class="comment">// ?a=1&amp;b=2</span></span><br><span class="line">location.hash;<span class="comment">//TOP</span></span><br><span class="line"></span><br><span class="line">location.assign(); <span class="comment">//加载一个新页面</span></span><br><span class="line">location.reload(); <span class="comment">//重新加载当前页面</span></span><br></pre></td></tr></table></figure>

<h6 id="document"><a href="#document" class="headerlink" title="document"></a>document</h6><p>document 对象表示当前页面，由于 HTML 在浏览器中以 DOM 形式表示为树形结构，document 对象就是整个 DOM 树的根节点</p>
<p>document 的 title 属性是从 HTML 文档中的 <code>&lt;title&gt;xxx&lt;/title&gt;</code> 读取的</p>
<p>要查找 DOM 树的某个节点，需要从 document 对象开始查找，最常用的查找是根据 ID 和 Tag Name</p>
<p>document 对象提供 <code>getElementById()</code> 和 <code>getElementByTagName()</code> 可以按 ID 获得一个 DOM 节点 和 按 Tag 名称获得一组 DOM 节点</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> menu = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;drink-menu&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> drinks = <span class="built_in">document</span>.getElementsByTagName(<span class="string">&#x27;dt&#x27;</span>);</span><br><span class="line"><span class="built_in">document</span>.cookie; <span class="comment">//读取当前页面 cookie</span></span><br></pre></td></tr></table></figure>

<p>由于 JavaScript 能读取到页面的 Cookie，在 HTML 页面中可以引入第三方的 JavaScript 代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 当前页面在wwwexample.com --&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;script src=<span class="string">&quot;http://www.foo.com/jquery.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">    ...</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>如果引入的第三方 JavaScript 中存在恶意代码， <code>www.foo.com</code> 网站将直接获取到 <code>www.example.com</code> 网站的用户登录信息</p>
<p>为了解决这个问题，服务器在设置 Cookie 时可以使用 httpOnly，设定了httpOnly 的 Cookie 将不能被 JavaScript 读取</p>
<h6 id="history"><a href="#history" class="headerlink" title="history"></a>history</h6><p>history 对象保存了浏览器的历史记录，JavaScript 可以调用 history 对象的 back()、forward() </p>
<h5 id="5-2-操作-DOM"><a href="#5-2-操作-DOM" class="headerlink" title="5.2  操作 DOM"></a>5.2  操作 DOM</h5><p>操作一个 DOM 节点前，先拿到 DOM 节点，<code>document.getElementById()</code> 、<code>document.getElementsByTagName()</code> 以及 CSS 选择器 <code>document.getElementsByClassName()</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回ID为&#x27;test&#x27;的节点：</span></span><br><span class="line"><span class="keyword">var</span> test = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;test&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 先定位ID为&#x27;test-table&#x27;的节点，再返回其内部所有tr节点：</span></span><br><span class="line"><span class="keyword">var</span> trs = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;test-table&#x27;</span>).getElementsByTagName(<span class="string">&#x27;tr&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 先定位ID为&#x27;test-div&#x27;的节点，再返回其内部所有class包含red的节点：</span></span><br><span class="line"><span class="keyword">var</span> reds = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;test-div&#x27;</span>).getElementsByClassName(<span class="string">&#x27;red&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取节点test下的所有直属子节点:</span></span><br><span class="line"><span class="keyword">var</span> cs = test.children;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取节点test下第一个、最后一个子节点：</span></span><br><span class="line"><span class="keyword">var</span> first = test.firstElementChild;</span><br><span class="line"><span class="keyword">var</span> last = test.lastElementChild;</span><br></pre></td></tr></table></figure>

<p>第二种方法是使用 <code>querySelector()</code> 和 <code>querySelectorAll()</code> ，需要了解 selector 语法，然后使用条件来获取节点，更加方便</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过querySelector获取ID为q1的节点：</span></span><br><span class="line"><span class="keyword">var</span> q1 = <span class="built_in">document</span>.querySelector(<span class="string">&#x27;#q1&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过querySelectorAll获取q1节点内的符合条件的所有节点：</span></span><br><span class="line"><span class="keyword">var</span> ps = q1.querySelectorAll(<span class="string">&#x27;div.highlighted &gt; p&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>低版本 IE&lt;8 不支持  <code>querySelector()</code> 和 <code>querySelectorAll()</code>  IE8仅有限支持</p>
<h6 id="更新-DOM"><a href="#更新-DOM" class="headerlink" title="更新 DOM"></a>更新 DOM</h6><p>一种是修改 inn二HTML 属性，不但可以修改一个 DOM 节点的文本内容，还可以直接通过 HTML片段修改DOM结点内部的子树</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取&lt;p id=&quot;p-id&quot;&gt;...&lt;/p&gt;</span></span><br><span class="line"><span class="keyword">var</span> p = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;p-id&#x27;</span>);</span><br><span class="line"><span class="comment">// 设置文本为abc:</span></span><br><span class="line">p.innerHTML = <span class="string">&#x27;ABC&#x27;</span>; <span class="comment">// &lt;p id=&quot;p-id&quot;&gt;ABC&lt;/p&gt;</span></span><br><span class="line"><span class="comment">// 设置HTML:</span></span><br><span class="line">p.innerHTML = <span class="string">&#x27;ABC &lt;span style=&quot;color:red&quot;&gt;RED&lt;/span&gt; XYZ&#x27;</span>;</span><br><span class="line"><span class="comment">// &lt;p&gt;...&lt;/p&gt;的内部结构已修改</span></span><br></pre></td></tr></table></figure>

<p>第二种是修改 innerText 或 textContent 属性，这样可以自动对字符串进行 HTML 编码，保证无法设置任何 HTML 标签</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取&lt;p id=&quot;p-id&quot;&gt;...&lt;/p&gt;</span></span><br><span class="line"><span class="keyword">var</span> p = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;p-id&#x27;</span>);</span><br><span class="line"><span class="comment">// 设置文本:</span></span><br><span class="line">p.innerText = <span class="string">&#x27;&lt;script&gt;alert(&quot;Hi&quot;)&lt;/script&gt;&#x27;</span>;</span><br><span class="line"><span class="comment">// HTML被自动编码，无法设置一个&lt;script&gt;节点:</span></span><br><span class="line"><span class="comment">// &lt;p id=&quot;p-id&quot;&gt;&amp;lt;script&amp;gt;alert(&quot;Hi&quot;)&amp;lt;/script&amp;gt;&lt;/p&gt;</span></span><br></pre></td></tr></table></figure>

<p>DOM节点的 style 属性对应所有的 CSS，可以直接获取或设置，因为 CSS 允许 font-size 这样的名称，但它并非 JavaScript有效的属性名，所以要在 JavaScript 中改写为驼峰式命名 fontSize</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取&lt;p id=&quot;p-id&quot;&gt;...&lt;/p&gt;</span></span><br><span class="line"><span class="keyword">var</span> p = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;p-id&#x27;</span>);</span><br><span class="line"><span class="comment">// 设置CSS:</span></span><br><span class="line">p.style.color = <span class="string">&#x27;#ff0000&#x27;</span>;</span><br><span class="line">p.style.fontSize = <span class="string">&#x27;20px&#x27;</span>;</span><br><span class="line">p.style.paddingTop = <span class="string">&#x27;2em&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h6 id="插入-DOM"><a href="#插入-DOM" class="headerlink" title="插入 DOM"></a>插入 DOM</h6><p>如果这个DOM节点是空的，例如 <code>&lt;div&gt;&lt;/div&gt;</code>  那么，直接用 <code>innerHTML=&#39;&lt;span&gt;child&lt;/span&gt;&#39;</code> 就可以修改 DOM 节点的内容，相当于插入了新的 DOM节点</p>
<p>如果这个DOM节点不是空的，可以使用 <code>appendChild</code> ，把一子节点添加到父节点的最后一个子节点</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;p id=<span class="string">&quot;js&quot;</span>&gt;JavaScript&lt;/p&gt;</span><br><span class="line">&lt;div id=<span class="string">&quot;list&quot;</span>&gt;</span><br><span class="line">    &lt;p id=<span class="string">&quot;java&quot;</span>&gt;Java&lt;/p&gt;</span><br><span class="line">    &lt;p id=<span class="string">&quot;python&quot;</span>&gt;Python&lt;/p&gt;</span><br><span class="line">    &lt;p id=<span class="string">&quot;scheme&quot;</span>&gt;Scheme&lt;/p&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">    js = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;js&#x27;</span>),</span><br><span class="line">    list = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;list&#x27;</span>);</span><br><span class="line">list.appendChild(js);</span><br><span class="line"><span class="comment">//HTML 结构变成了这样</span></span><br><span class="line">&lt;div id=<span class="string">&quot;list&quot;</span>&gt;</span><br><span class="line">    &lt;p id=<span class="string">&quot;java&quot;</span>&gt;Java&lt;/p&gt;</span><br><span class="line">    &lt;p id=<span class="string">&quot;python&quot;</span>&gt;Python&lt;/p&gt;</span><br><span class="line">    &lt;p id=<span class="string">&quot;scheme&quot;</span>&gt;Scheme&lt;/p&gt;</span><br><span class="line">    &lt;p id=<span class="string">&quot;js&quot;</span>&gt;JavaScript&lt;/p&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>从零创建一个新节点，然后插入到指定位置</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span></span><br><span class="line">    list = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;list&#x27;</span>),</span><br><span class="line">    haskell = <span class="built_in">document</span>.createElement(<span class="string">&#x27;p&#x27;</span>);</span><br><span class="line">haskell.id = <span class="string">&#x27;haskell&#x27;</span>;</span><br><span class="line">haskell.innerText = <span class="string">&#x27;Haskell&#x27;</span>;</span><br><span class="line">list.appendChild(haskell);</span><br><span class="line"></span><br><span class="line">&lt;div id=<span class="string">&quot;list&quot;</span>&gt;</span><br><span class="line">    &lt;p id=<span class="string">&quot;java&quot;</span>&gt;Java&lt;/p&gt;</span><br><span class="line">    &lt;p id=<span class="string">&quot;python&quot;</span>&gt;Python&lt;/p&gt;</span><br><span class="line">    &lt;p id=<span class="string">&quot;scheme&quot;</span>&gt;Scheme&lt;/p&gt;</span><br><span class="line">    &lt;p id=<span class="string">&quot;haskell&quot;</span>&gt;Haskell&lt;/p&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>动态创建一个节点然后添加到DOM树中，例如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> d = <span class="built_in">document</span>.createElement(<span class="string">&#x27;style&#x27;</span>);</span><br><span class="line">d.setAttribute(<span class="string">&#x27;type&#x27;</span>, <span class="string">&#x27;text/css&#x27;</span>);</span><br><span class="line">d.innerHTML = <span class="string">&#x27;p &#123; color: red &#125;&#x27;</span>;</span><br><span class="line"><span class="built_in">document</span>.getElementsByTagName(<span class="string">&#x27;head&#x27;</span>)[<span class="number">0</span>].appendChild(d);</span><br></pre></td></tr></table></figure>

<ul>
<li>insertBefore</li>
</ul>
<p><code>parentElement.insertBefore(newElement, referenceElement);</code> 子节点会插入到 referenceElement 之前</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">&quot;list&quot;</span>&gt;</span><br><span class="line">    &lt;p id=<span class="string">&quot;java&quot;</span>&gt;Java&lt;/p&gt;</span><br><span class="line">    &lt;p id=<span class="string">&quot;python&quot;</span>&gt;Python&lt;/p&gt;</span><br><span class="line">    &lt;p id=<span class="string">&quot;scheme&quot;</span>&gt;Scheme&lt;/p&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"><span class="comment">//haskell插入到python之前</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">    list = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;list&#x27;</span>),</span><br><span class="line">    ref = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;python&#x27;</span>),</span><br><span class="line">    haskell = <span class="built_in">document</span>.createElement(<span class="string">&#x27;p&#x27;</span>);</span><br><span class="line">haskell.id = <span class="string">&#x27;haskell&#x27;</span>;</span><br><span class="line">haskell.innerText = <span class="string">&#x27;Haskell&#x27;</span>;</span><br><span class="line">list.insertBefore(haskell, ref);</span><br></pre></td></tr></table></figure>

<h6 id="删除-DOM"><a href="#删除-DOM" class="headerlink" title="删除 DOM"></a>删除 DOM</h6><p>删除一个节点，首先获得该节点本身以及它的父节点，然后调用父节点的 removeChild </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 拿到待删除节点:</span></span><br><span class="line"><span class="keyword">var</span> self = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;to-be-removed&#x27;</span>);</span><br><span class="line"><span class="comment">// 拿到父节点:</span></span><br><span class="line"><span class="keyword">var</span> parent = self.parentElement;</span><br><span class="line"><span class="comment">// 删除:</span></span><br><span class="line"><span class="keyword">var</span> removed = parent.removeChild(self);</span><br><span class="line">removed === self; <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> parent = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;parent&#x27;</span>);</span><br><span class="line">parent.removeChild(parent.children[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure>

<h5 id="5-3-操作表单"><a href="#5-3-操作表单" class="headerlink" title="5.3 操作表单"></a>5.3 操作表单</h5><p>JavaScript 操作表单和操作DOM类似，因为表单本身也是DOM树</p>
<p>HTML表单的输入控件主要有几种</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type=<span class="string">&quot;text&quot;</span>&gt; <span class="comment">//文本框，用于输入文本</span></span><br><span class="line">&lt;input type=<span class="string">&quot;password&quot;</span>&gt; <span class="comment">//输入口令</span></span><br><span class="line">&lt;input type=<span class="string">&quot;radio&quot;</span>&gt; <span class="comment">//选择一项</span></span><br><span class="line">&lt;input type=<span class="string">&quot;checkbox&quot;</span>&gt; <span class="comment">//选择多项</span></span><br><span class="line">&lt;input type=<span class="string">&quot;hidden&quot;</span>&gt; <span class="comment">//隐藏文本，用户不可见，但表单提交时会把隐藏文本发送到服务器</span></span><br><span class="line">&lt;select&gt; <span class="comment">//下拉框 用于选择一项</span></span><br></pre></td></tr></table></figure>

<h6 id="获取值"><a href="#获取值" class="headerlink" title="获取值"></a>获取值</h6><p>如果获取了 <code>&lt;input&gt;</code> 节点的引用，可以直接调用 value 获得对应的用户输入值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &lt;input type=&quot;text&quot; id=&quot;email&quot;&gt;</span></span><br><span class="line"><span class="keyword">var</span> input = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;email&#x27;</span>);</span><br><span class="line">input.value; <span class="comment">// &#x27;用户输入的值&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这种方式可以应用于 text、password、hidden 及 select，但对于单选框和复选框，value 属性返回的永远是 HTML 预设的值。应该用 checked 判断</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &lt;label&gt;&lt;input type=&quot;radio&quot; name=&quot;weekday&quot; id=&quot;monday&quot; value=&quot;1&quot;&gt; Monday&lt;/label&gt;</span></span><br><span class="line"><span class="comment">// &lt;label&gt;&lt;input type=&quot;radio&quot; name=&quot;weekday&quot; id=&quot;tuesday&quot; value=&quot;2&quot;&gt; Tuesday&lt;/label&gt;</span></span><br><span class="line"><span class="keyword">var</span> mon = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;monday&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> tue = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;tuesday&#x27;</span>);</span><br><span class="line">mon.value; <span class="comment">// &#x27;1&#x27;</span></span><br><span class="line">tue.value; <span class="comment">// &#x27;2&#x27;</span></span><br><span class="line">mon.checked; <span class="comment">// true或者false</span></span><br><span class="line">tue.checked; <span class="comment">// true或者false</span></span><br></pre></td></tr></table></figure>

<h6 id="设置值"><a href="#设置值" class="headerlink" title="设置值"></a>设置值</h6><p> text、password、hidden 及 select 直接设置 value 就可以</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &lt;input type=&quot;text&quot; id=&quot;email&quot;&gt;</span></span><br><span class="line"><span class="keyword">var</span> input = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;email&#x27;</span>);</span><br><span class="line">input.value = <span class="string">&#x27;test@example.com&#x27;</span>; <span class="comment">// 文本框的内容已更新</span></span><br></pre></td></tr></table></figure>

<p>单选框和复选框，设置 checked 为 true 或 false 即可</p>
<h6 id="HTML5"><a href="#HTML5" class="headerlink" title="HTML5"></a>HTML5</h6><p>HTML5新增了大量标准控件，常用的包括 date、datetime、datetime-local、color 等，它们都使用 <code>&lt;input&gt;</code> 标签</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;input type=<span class="string">&quot;date&quot;</span> value=<span class="string">&quot;2021-12-02&quot;</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">&quot;datetime-local&quot;</span> value=<span class="string">&quot;2021-12-02T20:21:12&quot;</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">&quot;color&quot;</span> value=<span class="string">&quot;#ff0000&quot;</span>&gt;</span><br></pre></td></tr></table></figure>

<h6 id="提交表单"><a href="#提交表单" class="headerlink" title="提交表单"></a>提交表单</h6><p>方式一通过 <code>&lt;form&gt;</code> 元素的 <code>submit()</code> 方法提交表单，响应一个 <code>&lt;button&gt;</code> 的 click 事件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- HTML --&gt;</span><br><span class="line">&lt;form id=<span class="string">&quot;test-form&quot;</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;test&quot;</span>&gt;</span><br><span class="line">    &lt;button type=<span class="string">&quot;button&quot;</span> onclick=<span class="string">&quot;doSubmitForm()&quot;</span>&gt;Submit&lt;/button&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doSubmitForm</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> form = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;test-form&#x27;</span>);</span><br><span class="line">    <span class="comment">// 可以在此修改form的input...</span></span><br><span class="line">    <span class="comment">// 提交form:</span></span><br><span class="line">    form.submit();</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>第二种方式，浏览器默认点击 <code>&lt;button type=&quot;submit&quot;&gt;</code> 时提交表单，或者用户在最后输入框按回车键，响应 <code>&lt;form&gt;</code> 本身的 onsubmit 事件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- HTML --&gt;</span><br><span class="line">&lt;form id=<span class="string">&quot;test-form&quot;</span> onsubmit=<span class="string">&quot;return checkForm()&quot;</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;test&quot;</span>&gt;</span><br><span class="line">    &lt;button type=<span class="string">&quot;submit&quot;</span>&gt;Submit&lt;/button&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkForm</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> form = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;test-form&#x27;</span>);</span><br><span class="line">    <span class="comment">// 可以在此修改form的input...</span></span><br><span class="line">    <span class="comment">// 继续下一步:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>return true 来告诉浏览器继续提交，如果 return false 浏览器不会继续提交 form，这种情况通常对应用户输入有误，提示用户错误信息然后终止提交 form</p>
<p>在检查和修改 <code>&lt;input&gt;</code> 时，要充分利用 <code>&lt;input type=&quot;hidden&quot;&gt;</code> 来传递数据</p>
<p>例如：登录表单输入用户名和口令，提交表单时不传输明文口令，而是口令的MD5</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- HTML --&gt;</span><br><span class="line">&lt;form id=<span class="string">&quot;login-form&quot;</span> method=<span class="string">&quot;post&quot;</span> onsubmit=<span class="string">&quot;return checkForm()&quot;</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;text&quot;</span> id=<span class="string">&quot;username&quot;</span> name=<span class="string">&quot;username&quot;</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;password&quot;</span> id=<span class="string">&quot;input-password&quot;</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;hidden&quot;</span> id=<span class="string">&quot;md5-password&quot;</span> name=<span class="string">&quot;password&quot;</span>&gt;</span><br><span class="line">    &lt;button type=<span class="string">&quot;submit&quot;</span>&gt;Submit&lt;/button&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkForm</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> input_pwd = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;input-password&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> md5_pwd = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;md5-password&#x27;</span>);</span><br><span class="line">    <span class="comment">// 把用户输入的明文变为MD5:</span></span><br><span class="line">    md5_pwd.value = toMD5(input_pwd.value);</span><br><span class="line">    <span class="comment">// 继续下一步:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>注意 id 为 md5-password 的 <code>&lt;input&gt;</code> 标记了 name=”password”。而用户输入的 id 为</p>
<p>input-password 的 <code>&lt;input&gt;</code>  没有 name 属性。没有 name 属性的 <code>&lt;input&gt;</code> 的数据不会被提交</p>
<h6 id="操作文件"><a href="#操作文件" class="headerlink" title="操作文件"></a>操作文件</h6><p>HTML表单中，可以上传文件的唯一控件是 <code>&lt;input type=&quot;file&quot;&gt;</code></p>
<p>当一个表单包含  <code>&lt;input type=&quot;file&quot;&gt;</code> 时，表单的 enctype 必须指定为 multipart/form-data，method 必须指定为 post，浏览器才能正确编码并以 multipart/form-data 格式发送表单的数据</p>
<p>出于安全考虑，浏览器只允许用户点击 <code>&lt;input type=&quot;file&quot;&gt;</code> 来选择本地文件，用JavaScript 对 <code>&lt;input type=&quot;file&quot;&gt;</code> 的 value 值赋值没有效果</p>
<p>JavaScript 可以在提交表单时对文件扩展名做检查</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> f = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;test-file-upload&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> filename = f.value; <span class="comment">// &#x27;C:\fakepath\test.png&#x27;</span></span><br><span class="line"><span class="keyword">if</span> (!filename || !(filename.endsWith(<span class="string">&#x27;.jpg&#x27;</span>) || filename.endsWith(<span class="string">&#x27;.png&#x27;</span>) || filename.endsWith(<span class="string">&#x27;.gif&#x27;</span>))) &#123;</span><br><span class="line">    alert(<span class="string">&#x27;Can only upload image file.&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>File API</li>
</ul>
<p>HTML5 的 File API 提供了 File 和 FileReader 两个主要对象，可以获得文件信息并读取文件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span></span><br><span class="line">    fileInput = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;test-image-file&#x27;</span>),</span><br><span class="line">    info = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;test-file-info&#x27;</span>),</span><br><span class="line">    preview = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;test-image-preview&#x27;</span>);</span><br><span class="line"><span class="comment">// 监听change事件:</span></span><br><span class="line">fileInput.addEventListener(<span class="string">&#x27;change&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 清除背景图片:</span></span><br><span class="line">    preview.style.backgroundImage = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="comment">// 检查文件是否选择:</span></span><br><span class="line">    <span class="keyword">if</span> (!fileInput.value) &#123;</span><br><span class="line">        info.innerHTML = <span class="string">&#x27;没有选择文件&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取File引用:</span></span><br><span class="line">    <span class="keyword">var</span> file = fileInput.files[<span class="number">0</span>];</span><br><span class="line">    <span class="comment">// 获取File信息:</span></span><br><span class="line">    info.innerHTML = <span class="string">&#x27;文件: &#x27;</span> + file.name + <span class="string">&#x27;&lt;br&gt;&#x27;</span> +</span><br><span class="line">                     <span class="string">&#x27;大小: &#x27;</span> + file.size + <span class="string">&#x27;&lt;br&gt;&#x27;</span> +</span><br><span class="line">                     <span class="string">&#x27;修改: &#x27;</span> + file.lastModified;</span><br><span class="line">    <span class="keyword">if</span> (file.type !== <span class="string">&#x27;image/jpeg&#x27;</span> &amp;&amp; file.type !== <span class="string">&#x27;image/png&#x27;</span> &amp;&amp; file.type !== <span class="string">&#x27;image/gif&#x27;</span>) &#123;</span><br><span class="line">        alert(<span class="string">&#x27;不是有效的图片文件!&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 读取文件:</span></span><br><span class="line">    <span class="keyword">var</span> reader = <span class="keyword">new</span> FileReader();</span><br><span class="line">    reader.onload = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">      <span class="comment">//文件读取完成后自动调用此函数</span></span><br><span class="line">        <span class="keyword">var</span></span><br><span class="line">            data = e.target.result; <span class="comment">// &#x27;data:image/jpeg;base64,/9j/4AAQSk...(base64编码)...&#x27;            </span></span><br><span class="line">        preview.style.backgroundImage = <span class="string">&#x27;url(&#x27;</span> + data + <span class="string">&#x27;)&#x27;</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 以DataURL的形式读取文件:</span></span><br><span class="line">    reader.readAsDataURL(file);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h5 id="5-4-AJAX"><a href="#5-4-AJAX" class="headerlink" title="5.4 AJAX"></a>5.4 AJAX</h5><p>用 JavaScript 执行异步网络请求</p>
<h5 id="5-5-Promise"><a href="#5-5-Promise" class="headerlink" title="5.5 Promise"></a>5.5 Promise</h5><h5 id="5-6-Canvas"><a href="#5-6-Canvas" class="headerlink" title="5.6 Canvas"></a>5.6 Canvas</h5>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/19/JavaScript%EF%BC%88%E4%BA%8C%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/19/JavaScript%EF%BC%88%E4%BA%8C%EF%BC%89/" class="post-title-link" itemprop="url">JavaScript（二）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-19 09:43:56" itemprop="dateCreated datePublished" datetime="2022-09-19T09:43:56+08:00">2022-09-19</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-09-27 09:03:55" itemprop="dateModified" datetime="2022-09-27T09:03:55+08:00">2022-09-27</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="2-函数"><a href="#2-函数" class="headerlink" title="2 函数"></a>2 函数</h4><h5 id="2-1-定义和调用"><a href="#2-1-定义和调用" class="headerlink" title="2.1 定义和调用"></a>2.1 定义和调用</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">abs</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> -x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二种定义函数的方式</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> abs = <span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> -x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">abs(<span class="number">10</span>);</span><br><span class="line">abs(<span class="number">10</span>,<span class="string">&#x27;blabla&#x27;</span>);</span><br><span class="line">abs();<span class="comment">//返回 NaN，x收到undefined，计算结果NaN</span></span><br></pre></td></tr></table></figure>

<p>function(x){…} 是一个匿名函数，没有函数名，匿名函数赋值给了变量 abs，通过变量 abs 就可以调用该函数</p>
<p>JavaScript 允许传入任意个参数不影响调用，传入参数比定义多也没问题</p>
<p>传入的参数比定义少也没有问题</p>
<p>为避免收到 undefined，可以对参数进行检查</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">abs</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> x !== <span class="string">&#x27;number&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="string">&#x27;Not a number&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="arguments"><a href="#arguments" class="headerlink" title="arguments"></a>arguments</h6><p>函数内部起作用，指向传入的所有参数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">x</span>)</span>&#123;</span><br><span class="line">  <span class="function"><span class="title">for</span>(<span class="params"><span class="keyword">var</span> i=<span class="number">0</span>; i&lt;<span class="built_in">arguments</span>.length; i++</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;arg &#x27;</span> + i + <span class="string">&#x27;=&#x27;</span> + <span class="built_in">arguments</span>[i]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">abs</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">arguments</span>.length === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> x = <span class="built_in">arguments</span>[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">return</span> x &gt;= <span class="number">0</span> ? x : -x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="rest参数"><a href="#rest参数" class="headerlink" title="rest参数"></a>rest参数</h6><p>获取已定义参数之外的参数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">a,b, ...rest</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(rest);</span><br><span class="line">&#125;</span><br><span class="line">foo(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>);<span class="comment">//[3,4,5]</span></span><br><span class="line">foo(<span class="number">1</span>);<span class="comment">//[]</span></span><br></pre></td></tr></table></figure>

<h5 id="2-2-作用域"><a href="#2-2-作用域" class="headerlink" title="2.2 作用域"></a>2.2 作用域</h5><p>不在任何函数内定义的变量具有全局作用域，JavaScript 默认有一个全局对象 window，全局作用域的变量实际上被绑定到 window 的一个属性</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> course = <span class="string">&#x27;Learn JavaScript&#x27;</span></span><br><span class="line">alert(course);</span><br><span class="line">alert(<span class="built_in">window</span>.course);</span><br></pre></td></tr></table></figure>

<p>以变量方式 var foo = function(){} 定义的函数实际上也是一个全局变量，因此顶层函数的定义也被视为一个全局变量，并绑定到 window 对象</p>
<h6 id="名字空间"><a href="#名字空间" class="headerlink" title="名字空间"></a>名字空间</h6><p>全局变量会绑定到 window 上，不同的 JavaScript 文件如果使用了相同的全局变量，或者定义了相同名字的顶层函数，都会造成命名冲突</p>
<p>减少冲突的一个方法是把自己所有变量和函数全部绑定到一个全局变量中，把自己代码全部放入唯一的名字空间 MYAPP 中，减少全局变量冲突的可能</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> MYAPP = &#123;&#125;;<span class="comment">//唯一的全局变量MYAPP</span></span><br><span class="line"><span class="comment">//其它变量</span></span><br><span class="line">MYAPP.name = <span class="string">&#x27;myapp&#x27;</span>;</span><br><span class="line"><span class="comment">//其它函数</span></span><br><span class="line">MYAPP.foo = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;...&#125;;</span><br></pre></td></tr></table></figure>

<h6 id="局部作用域"><a href="#局部作用域" class="headerlink" title="局部作用域"></a>局部作用域</h6><p>JavaScript的变量作用域实际上是函数内部</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;<span class="number">100</span>; i++) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">    i += <span class="number">100</span>; <span class="comment">// 仍然可以引用变量i</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了解决块级作用域，ES6引入了新的关键字 let，用 let 代替 var 可以申明一个块级作用域的变量</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;<span class="number">100</span>; i++) &#123;</span><br><span class="line">        sum += i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// SyntaxError:</span></span><br><span class="line">    i += <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h6><p>通常用全部大写表示这是一个常量 </p>
<p>ES6 标准引入新关键字 const 来定义常量</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> PI = <span class="number">3.14</span></span><br><span class="line"><span class="keyword">const</span> PI1 = <span class="number">3.14</span></span><br><span class="line">PI1 = <span class="number">3</span>;<span class="comment">//某些浏览器不报错，但是无效果</span></span><br></pre></td></tr></table></figure>

<h5 id="2-3-解构赋值"><a href="#2-3-解构赋值" class="headerlink" title="2.3 解构赋值"></a>2.3 解构赋值</h5><p>ES6开始，JavaScript引入了解构赋值，可以同时对一组变量进行赋值，多个变量 [] 括起来</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> [x, y, z] = [<span class="string">&#x27;hello&#x27;</span>, <span class="string">&#x27;JavaScript&#x27;</span>, <span class="string">&#x27;ES6&#x27;</span>];</span><br><span class="line"><span class="keyword">let</span> [x, [y, z]] = [<span class="string">&#x27;hello&#x27;</span>, [<span class="string">&#x27;JavaScript&#x27;</span>, <span class="string">&#x27;ES6&#x27;</span>]];</span><br><span class="line"><span class="comment">//还可忽略某些元素</span></span><br><span class="line"><span class="keyword">let</span> [, , z] = [<span class="string">&#x27;hello&#x27;</span>, <span class="string">&#x27;JavaScript&#x27;</span>, <span class="string">&#x27;ES6&#x27;</span>]; <span class="comment">// 忽略前两个元素，只对z赋值第三个元素</span></span><br></pre></td></tr></table></figure>

<p>如果要从一个对象中取出若干属性，也可以使用解构赋值，便于快速获取对象的指定属性</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">  name: <span class="string">&#x27;小明&#x27;</span>,</span><br><span class="line">  age: <span class="number">20</span>,</span><br><span class="line">  gender: <span class="string">&#x27;male&#x27;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> &#123;name, age&#125; = person;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;name=&#x27;</span> + name + <span class="string">&#x27;, age=&#x27;</span> + age);</span><br></pre></td></tr></table></figure>

<p>对一个对象进行解构赋值时，同样可以直接对嵌套的对象属性进行赋值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">  name: <span class="string">&#x27;小明&#x27;</span>,</span><br><span class="line">  age: <span class="number">20</span>,</span><br><span class="line">  gender: <span class="string">&#x27;male&#x27;</span>,</span><br><span class="line">  address: &#123;</span><br><span class="line">    city: <span class="string">&#x27;Beijing&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> &#123;name, <span class="attr">address</span>: &#123;city&#125;&#125; = person;</span><br></pre></td></tr></table></figure>

<p>使用解构赋值对对象属性进行赋值时，如果对应的属性不存在，变量被赋值为 undefined</p>
<p>如果要使用的变量名和属性名不一致，可以用下面语法获取</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> &#123;name, <span class="attr">age</span>:ageValue&#125; = persion <span class="comment">//把age属性赋值给变量ageValue</span></span><br><span class="line">name;</span><br><span class="line">ageValue;<span class="comment">//20</span></span><br><span class="line">age;<span class="comment">//Uncaught ReferenceError: age is not defined</span></span><br></pre></td></tr></table></figure>

<p>解构赋值还可以使用默认值，避免不存在的属性返回 undefined</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> &#123;name, age=<span class="number">20</span>&#125; = person <span class="comment">//如果person对象没有age属性，默认赋值为20</span></span><br></pre></td></tr></table></figure>

<p>有些时候已经声明了变量，再次赋值的时候报错</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明变量:</span></span><br><span class="line"><span class="keyword">var</span> x, y;</span><br><span class="line"><span class="comment">// 解构赋值:</span></span><br><span class="line">&#123;x, y&#125; = &#123; <span class="attr">name</span>: <span class="string">&#x27;小明&#x27;</span>, <span class="attr">x</span>: <span class="number">100</span>, <span class="attr">y</span>: <span class="number">200</span>&#125;;</span><br><span class="line"><span class="comment">// 语法错误: Uncaught SyntaxError: Unexpected token =</span></span><br></pre></td></tr></table></figure>

<p>JavaScript把 { 开头的语句当作了块处理，于是 = 不再合法，解决用小括号括起来</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(&#123;x, y&#125; = &#123; <span class="attr">name</span>: <span class="string">&#x27;小明&#x27;</span>, <span class="attr">x</span>: <span class="number">100</span>, <span class="attr">y</span>: <span class="number">200</span>&#125;);</span><br></pre></td></tr></table></figure>

<p>如果一个函数接收一个对象作为参数，可以使用解构直接把对象的属性绑定到变量中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">buildDate</span>(<span class="params">&#123;year, month, day, hour=<span class="number">0</span>, minute=<span class="number">0</span>, second=<span class="number">0</span>&#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Date</span>(year + <span class="string">&#x27;-&#x27;</span> + month + <span class="string">&#x27;-&#x27;</span> + day + <span class="string">&#x27; &#x27;</span> + hour + <span class="string">&#x27;:&#x27;</span> + minute + <span class="string">&#x27;:&#x27;</span> + second);</span><br><span class="line">&#125;</span><br><span class="line">buildDate(&#123; <span class="attr">year</span>: <span class="number">2017</span>, <span class="attr">month</span>: <span class="number">1</span>, <span class="attr">day</span>: <span class="number">1</span> &#125;);</span><br><span class="line"><span class="comment">//也可传入其它参数</span></span><br><span class="line">buildDate(&#123; <span class="attr">year</span>: <span class="number">2017</span>, <span class="attr">month</span>: <span class="number">1</span>, <span class="attr">day</span>: <span class="number">1</span>, <span class="attr">hour</span>: <span class="number">20</span>, <span class="attr">minute</span>: <span class="number">15</span> &#125;);</span><br></pre></td></tr></table></figure>

<h5 id="2-4-方法"><a href="#2-4-方法" class="headerlink" title="2.4 方法"></a>2.4 方法</h5><p>绑定到对象上的函数称为方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xiaoming = &#123;</span><br><span class="line">    name: <span class="string">&#x27;小明&#x27;</span>,</span><br><span class="line">    birth: <span class="number">1990</span>,</span><br><span class="line">    age: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> y = <span class="keyword">new</span> <span class="built_in">Date</span>().getFullYear();</span><br><span class="line">        <span class="keyword">return</span> y - <span class="built_in">this</span>.birth;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>方法的内部，this 是一个特殊变量，指向当前对象 xiaoming</p>
<h6 id="apply"><a href="#apply" class="headerlink" title="apply"></a>apply</h6><p>在一个独立的函数调用中，根据是否是strict模式，this 指向 undefined 或 window，还是可以控制 this 的指向的</p>
<p>要指定函数的 this 指向哪个对象，可以用函数本身的 apply 方法。接收两个参数，第一个参数就是需要绑定的 this 变量，第二个参数 Array，表示函数本身的参数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAge</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> y = <span class="keyword">new</span> <span class="built_in">Date</span>().getFullYear();</span><br><span class="line">    <span class="keyword">return</span> y - <span class="built_in">this</span>.birth;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> xiaoming = &#123;</span><br><span class="line">    name: <span class="string">&#x27;小明&#x27;</span>,</span><br><span class="line">    birth: <span class="number">1990</span>,</span><br><span class="line">    age: getAge</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">xiaoming.age(); <span class="comment">// 25</span></span><br><span class="line">getAge(); <span class="comment">// NaN</span></span><br><span class="line">getAge.apply(xiaoming, []); <span class="comment">// 25, this指向xiaoming, 参数为空</span></span><br></pre></td></tr></table></figure>

<p>以对象的方法形式调用 xiaoming.age()，this 指向被调用的对象 xiaoming</p>
<p>如果单独调用 getAge()，此时函数的 this 指向全局对象，也就是 window</p>
<h6 id="call"><a href="#call" class="headerlink" title="call"></a>call</h6><p>和 apply 方法类似，区别是，apply() 把参数打包成 Array 传入，call() 把参数按顺序传入</p>
<p>比如调用 Math.max(3, 5, 4)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Math</span>.max.apply(<span class="literal">null</span>, [<span class="number">3</span>, <span class="number">5</span>, <span class="number">4</span>]); <span class="comment">// 5</span></span><br><span class="line"><span class="built_in">Math</span>.max.call(<span class="literal">null</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">4</span>); <span class="comment">// 5</span></span><br></pre></td></tr></table></figure>

<p>对普通函数调用，通常把 this 绑定为 null</p>
<h6 id="装饰器"><a href="#装饰器" class="headerlink" title="装饰器"></a>装饰器</h6><p>JavaScript的所有对象都是动态的，即使内置的函数，也可以重新指向新的函数</p>
<p>如果要统计代码调用了多少次 parseInt()，可以用自己的函数替换掉默认的 parseInt()</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> oldParseInt = <span class="built_in">parseInt</span>; <span class="comment">// 保存原函数</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.parseInt = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    count += <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> oldParseInt.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>); <span class="comment">// 调用原函数</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="2-5-高阶函数"><a href="#2-5-高阶函数" class="headerlink" title="2.5 高阶函数"></a>2.5 高阶函数</h5><p>一个函数可以接收另一个函数作为参数，称为高阶函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">x, y, f</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> f(x) + f(y);</span><br><span class="line">&#125;</span><br><span class="line">add(-<span class="number">5</span>, <span class="number">6</span>, <span class="built_in">Math</span>.abs);</span><br></pre></td></tr></table></figure>

<h6 id="map"><a href="#map" class="headerlink" title="map"></a>map</h6><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pow</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x * x;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>];</span><br><span class="line"><span class="keyword">var</span> results = arr.map(pow); <span class="comment">// [1, 4, 9, 16, 25, 36, 49, 64, 81]</span></span><br><span class="line">arr.map(<span class="built_in">String</span>);<span class="comment">//转成字符串[&#x27;1&#x27;, &#x27;2&#x27;, &#x27;3&#x27;, &#x27;4&#x27;, &#x27;5&#x27;, &#x27;6&#x27;, &#x27;7&#x27;, &#x27;8&#x27;, &#x27;9&#x27;]</span></span><br></pre></td></tr></table></figure>

<h6 id="reduce"><a href="#reduce" class="headerlink" title="reduce"></a>reduce</h6><p>Array  的 reduce() 把一个函数作用在这个 Array 上。函数接收两个参数，reduce() 把结果继续和序列的下一个元素做累积计算</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[x1, x2, x3, x4].reduce(f) = f(f(f(x1, x2), x3), x4)</span><br></pre></td></tr></table></figure>

<p>对一个 Array 求和</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>];</span><br><span class="line">arr.reduce(<span class="function"><span class="keyword">function</span> (<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x + y;</span><br><span class="line">&#125;); <span class="comment">// 25</span></span><br></pre></td></tr></table></figure>

<h6 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h6><p>Array 的 filter 也接收一个函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">15</span>];</span><br><span class="line"><span class="keyword">var</span> r = arr.filter(<span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x % <span class="number">2</span> !== <span class="number">0</span>;</span><br><span class="line">&#125;);</span><br><span class="line">r; <span class="comment">// [1, 5, 9, 15]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="literal">null</span>, <span class="literal">undefined</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;  &#x27;</span>];</span><br><span class="line"><span class="keyword">var</span> r = arr.filter(<span class="function"><span class="keyword">function</span> (<span class="params">s</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> s &amp;&amp; s.trim(); <span class="comment">// 注意：IE9以下的版本没有trim()方法</span></span><br><span class="line">&#125;);</span><br><span class="line">r; <span class="comment">// [&#x27;A&#x27;, &#x27;B&#x27;, &#x27;C&#x27;]</span></span><br></pre></td></tr></table></figure>

<p>回调函数</p>
<p>filter() 接收的回调函数，可以有多个参数，通常仅使用第一个参数，表示 Array 的某个元素。还可以接收另外两个参数，元素位置和数组本身</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>];</span><br><span class="line"><span class="keyword">var</span> r = arr.filter(<span class="function"><span class="keyword">function</span> (<span class="params">element, index, self</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(element); <span class="comment">// 依次打印&#x27;A&#x27;, &#x27;B&#x27;, &#x27;C&#x27;</span></span><br><span class="line">    <span class="built_in">console</span>.log(index); <span class="comment">// 依次打印0, 1, 2</span></span><br><span class="line">    <span class="built_in">console</span>.log(self); <span class="comment">// self就是变量arr</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//去除重复元素</span></span><br><span class="line">r = arr.filter(<span class="function"><span class="keyword">function</span> (<span class="params">element, index, self</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> self.indexOf(element) === index;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h6 id="sort"><a href="#sort" class="headerlink" title="sort"></a>sort</h6><p>Array 的 sort() 方法默认把所有元素转换为 String 再排序</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">10</span>, <span class="number">20</span>, <span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line">arr.sort(<span class="function"><span class="keyword">function</span> (<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x &lt; y) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (x &gt; y) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;Google&#x27;</span>, <span class="string">&#x27;apple&#x27;</span>, <span class="string">&#x27;Microsoft&#x27;</span>];</span><br><span class="line">arr.sort(<span class="function"><span class="keyword">function</span> (<span class="params">s1, s2</span>) </span>&#123; <span class="comment">//忽略大小写来比较两个字符串</span></span><br><span class="line">    x1 = s1.toUpperCase();</span><br><span class="line">    x2 = s2.toUpperCase();</span><br><span class="line">    <span class="keyword">if</span> (x1 &lt; x2) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (x1 &gt; x2) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;); <span class="comment">// [&#x27;apple&#x27;, &#x27;Google&#x27;, &#x27;Microsoft&#x27;]</span></span><br></pre></td></tr></table></figure>

<h6 id="every"><a href="#every" class="headerlink" title="every"></a>every</h6><p>判断数组的所有元素是否满足测试条件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;Apple&#x27;</span>, <span class="string">&#x27;pear&#x27;</span>, <span class="string">&#x27;orange&#x27;</span>];</span><br><span class="line"><span class="built_in">console</span>.log(arr.every(<span class="function"><span class="keyword">function</span> (<span class="params">s</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> s.length &gt; <span class="number">0</span>;</span><br><span class="line">&#125;)); <span class="comment">// true, 因为每个元素都满足s.length&gt;0</span></span><br></pre></td></tr></table></figure>

<h6 id="find"><a href="#find" class="headerlink" title="find"></a>find</h6><p>查找符合条件的第一个元素，找到返回元素，否则返回 undefined</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;Apple&#x27;</span>, <span class="string">&#x27;pear&#x27;</span>, <span class="string">&#x27;orange&#x27;</span>];</span><br><span class="line"><span class="built_in">console</span>.log(arr.find(<span class="function"><span class="keyword">function</span> (<span class="params">s</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> s.toLowerCase() === s;</span><br><span class="line">&#125;)); <span class="comment">// &#x27;pear&#x27;, 因为pear全部是小写</span></span><br></pre></td></tr></table></figure>

<h6 id="findIndex"><a href="#findIndex" class="headerlink" title="findIndex"></a>findIndex</h6><p>返回符合条件第一个元素的索引，没有找到返回-1</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;Apple&#x27;</span>, <span class="string">&#x27;pear&#x27;</span>, <span class="string">&#x27;orange&#x27;</span>];</span><br><span class="line"><span class="built_in">console</span>.log(arr.findIndex(<span class="function"><span class="keyword">function</span> (<span class="params">s</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> s.toLowerCase() === s;</span><br><span class="line">&#125;)); <span class="comment">// 1, 因为&#x27;pear&#x27;的索引是1</span></span><br></pre></td></tr></table></figure>

<h6 id="forEach"><a href="#forEach" class="headerlink" title="forEach"></a>forEach</h6><p>把每个元素依次作用于传入函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;Apple&#x27;</span>, <span class="string">&#x27;pear&#x27;</span>, <span class="string">&#x27;orange&#x27;</span>];</span><br><span class="line">arr.forEach(<span class="built_in">console</span>.log); <span class="comment">// 依次打印每个元素</span></span><br></pre></td></tr></table></figure>

<h5 id="2-6-闭包"><a href="#2-6-闭包" class="headerlink" title="2.6 闭包"></a>2.6 闭包</h5><p>函数作为返回值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> arr.reduce(<span class="function"><span class="keyword">function</span> (<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> x + y;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">sum([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]); <span class="comment">// 15</span></span><br></pre></td></tr></table></figure>

<p>如果不需要立即求和，可以不返回求和结果，而是返回求和的函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">lazy_sum</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> sum = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> arr.reduce(<span class="function"><span class="keyword">function</span> (<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> x + y;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用 lazy_sum 时返回的不是求和结果，而是求和函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> f = lazy_sum([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]); <span class="comment">// function sum()</span></span><br><span class="line">f();<span class="comment">//15</span></span><br></pre></td></tr></table></figure>

<p>函数 lazy_sum 中又定义了函数 sum，内部函数 sum 可以引用外部函数 lazy_sum 的参数和局部变量，lazy_sum 返回函数 sum 时，相关参数和变量都保存在返回的函数中，这种称为闭包</p>
<p>立即执行的匿名函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x * x;</span><br><span class="line">&#125;)(<span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<h5 id="2-7-箭头函数"><a href="#2-7-箭头函数" class="headerlink" title="2.7 箭头函数"></a>2.7 箭头函数</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">x =&gt; x * x</span><br><span class="line"><span class="comment">//相当于</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x * x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>相当于匿名函数，上面只包含一个表达式，{…} 和 return 都省略掉了。</p>
<p>包含多条语句不能省略</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">x =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (x &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> x * x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> - x * x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果不是一个参数，需要用括号括起来</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 两个参数:</span></span><br><span class="line">(x, y) =&gt; x * x + y * y</span><br><span class="line"></span><br><span class="line"><span class="comment">// 无参数:</span></span><br><span class="line">() =&gt; <span class="number">3.14</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 可变参数:</span></span><br><span class="line">(x, y, ...rest) =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> i, sum = x + y;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;rest.length; i++) &#123;</span><br><span class="line">        sum += rest[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果要返回对象</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">x =&gt; (&#123; <span class="attr">foo</span>: x &#125;)</span><br></pre></td></tr></table></figure>

<h5 id="2-8-generator"><a href="#2-8-generator" class="headerlink" title="2.8 generator"></a>2.8 generator</h5><p>生成器</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">foo</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">yield</span> x + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">yield</span> x + <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">return</span> x + <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>generator 由 function* 定义，除了 return 语句，还可以用 yield 返回多次</p>
<h4 id="3-标准对象"><a href="#3-标准对象" class="headerlink" title="3 标准对象"></a>3 标准对象</h4><p>typeof 获取对象类型，总是返回一个字符串</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typeof</span> <span class="number">123</span>；<span class="comment">//&#x27;number&#x27;</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="literal">NaN</span>; <span class="comment">// &#x27;number&#x27;</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="literal">null</span>; <span class="comment">//&#x27;object&#x27;</span></span><br><span class="line"><span class="keyword">typeof</span> []; <span class="comment">// &#x27;object&#x27;</span></span><br><span class="line"><span class="keyword">typeof</span> &#123;&#125;; <span class="comment">// &#x27;object&#x27;</span></span><br></pre></td></tr></table></figure>

<h5 id="3-1-包装对象"><a href="#3-1-包装对象" class="headerlink" title="3.1 包装对象"></a>3.1 包装对象</h5><p>number、boolean、string 都有包装对象</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> n = <span class="keyword">new</span> <span class="built_in">Number</span>(<span class="number">123</span>); <span class="comment">// 123,生成了新的包装类型</span></span><br><span class="line"><span class="keyword">var</span> b = <span class="keyword">new</span> <span class="built_in">Boolean</span>(<span class="literal">true</span>); <span class="comment">// true,生成了新的包装类型</span></span><br><span class="line"><span class="keyword">var</span> s = <span class="keyword">new</span> <span class="built_in">String</span>(<span class="string">&#x27;str&#x27;</span>); <span class="comment">// &#x27;str&#x27;,生成了新的包装类型</span></span><br></pre></td></tr></table></figure>

<p>包装对象看上去和原来的值一模一样，显示出来也一样，不过类型已经变为 object 了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typeof</span> <span class="keyword">new</span> <span class="built_in">Number</span>(<span class="number">123</span>); <span class="comment">// &#x27;object&#x27;</span></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Number</span>(<span class="number">123</span>) === <span class="number">123</span>; <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>少使用包装对象</p>
<p>如果没有写 new，Number()、Boolean()、String() 被当做普通函数，把任何类型的数据转换为 number、boolean、string 类型</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> n = <span class="built_in">Number</span>(<span class="string">&#x27;123&#x27;</span>); <span class="comment">// 123，相当于parseInt()或parseFloat()</span></span><br><span class="line"><span class="keyword">typeof</span> n; <span class="comment">// &#x27;number&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b = <span class="built_in">Boolean</span>(<span class="string">&#x27;true&#x27;</span>); <span class="comment">// true</span></span><br><span class="line"><span class="keyword">typeof</span> b; <span class="comment">// &#x27;boolean&#x27;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>用parseInt()或parseFloat()转换任意类型到number</p>
<p>用String()来转换任意类型到string，或者直接调用某个对象的toString()方法</p>
<p>typeof操作符可以判断出number、boolean、string、function和undefined</p>
<p>判断Array要使用Array.isArray(arr)</p>
<p>判断null请使用myVar === null</p>
<p>判断某个全局变量是否存在用 typeof window.myVar === ‘undefined’</p>
<p>函数内部判断某个变量是否存在用 typeof myVar === ‘undefined’</p>
</blockquote>
<p>null 和 undefined 没有 toString() 方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">123.</span>toString(); <span class="comment">// SyntaxError</span></span><br><span class="line"><span class="number">123.</span>.toString(); <span class="comment">// &#x27;123&#x27;, 注意是两个点！</span></span><br><span class="line">(<span class="number">123</span>).toString(); <span class="comment">// &#x27;123&#x27;</span></span><br></pre></td></tr></table></figure>

<h5 id="3-2-Date"><a href="#3-2-Date" class="headerlink" title="3.2 Date"></a>3.2 Date</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> now = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">now; <span class="comment">// Wed Jun 24 2015 19:49:22 GMT+0800 (CST)</span></span><br><span class="line">now.getFullYear(); <span class="comment">// 2015, 年份</span></span><br><span class="line">now.getMonth(); <span class="comment">// 5, 月份，注意月份范围是0~11，5表示六月</span></span><br><span class="line">now.getDate(); <span class="comment">// 24, 表示24号</span></span><br><span class="line">now.getDay(); <span class="comment">// 3, 表示星期三</span></span><br><span class="line">now.getHours(); <span class="comment">// 19, 24小时制</span></span><br><span class="line">now.getMinutes(); <span class="comment">// 49, 分钟</span></span><br><span class="line">now.getSeconds(); <span class="comment">// 22, 秒</span></span><br><span class="line">now.getMilliseconds(); <span class="comment">// 875, 毫秒数</span></span><br><span class="line">now.getTime(); <span class="comment">// 1435146562875, 以number形式表示的时间戳</span></span><br></pre></td></tr></table></figure>

<p>创建指定日期和时间的 Date 对象</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> d = <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="number">2015</span>, <span class="number">5</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">15</span>, <span class="number">30</span>, <span class="number">123</span>);</span><br><span class="line">d; <span class="comment">// Fri Jun 19 2015 20:15:30 GMT+0800 (CST)</span></span><br></pre></td></tr></table></figure>

<p>JavaScript 的月份是 0-11，要表示 6 月，传入的值是 5</p>
<p>第二种创建，解析一个符合 ISO 8601 格式的字符串，返回时间戳</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> d = <span class="built_in">Date</span>.parse(<span class="string">&#x27;2015-06-24T19:49:22.875+08:00&#x27;</span>);</span><br><span class="line">d; <span class="comment">// 1435146562875</span></span><br><span class="line"><span class="comment">//时间戳转 Date</span></span><br><span class="line"><span class="keyword">var</span> d = <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="number">1435146562875</span>);</span><br><span class="line">d; <span class="comment">// Wed Jun 24 2015 19:49:22 GMT+0800 (CST)</span></span><br><span class="line">d.getMonth(); <span class="comment">// 5</span></span><br></pre></td></tr></table></figure>

<ul>
<li>时区</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> d = <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="number">1435146562875</span>);</span><br><span class="line">d.toLocaleString(); <span class="comment">// &#x27;2015/6/24 下午7:49:22&#x27;，本地时间（北京时区+8:00），显示的字符串与操作系统设定的格式有关</span></span><br><span class="line">d.toUTCString(); <span class="comment">// &#x27;Wed, 24 Jun 2015 11:49:22 GMT&#x27;，UTC时间，与本地时间相差8小时</span></span><br></pre></td></tr></table></figure>

<h5 id="3-3-RegExp"><a href="#3-3-RegExp" class="headerlink" title="3.3 RegExp"></a>3.3 RegExp</h5><p>\d 可以匹配一个数字，\w 可以匹配一个字母或数字</p>
<p><code>.</code> 可以匹配任意字符</p>
<p><code>*</code> 表示任意个字符（包括0个），用 <code>+</code> 表示至少一个字符，用 <code>?</code> 表示0个或1个字符，用 <code>&#123;n&#125;</code> 表示n个字符</p>
<p><code>&#123;n,m&#125;</code> 表示n-m个字符，<code>\s+</code> 至少一个空格</p>
<p>例如： <code>\d&#123;3&#125;\s+\d&#123;3,8&#125;</code> </p>
<p>\d{3} 表示匹配3个数字，例如 010</p>
<p>\s+ 表示至少一个空格，\d{3,8} 表示3-8个数字。即可以匹配任意个空格隔开带区号的电话号码</p>
<ul>
<li>精确匹配可以用[]表示范围</li>
</ul>
<p><code>[0-9a-zA-Z\_]</code> 匹配一个数字、字母或者下划线</p>
<p><code>[a-zA-Z\_\$][0-9a-zA-Z\_\$]*</code>  可以匹配由字母或下划线、$开头，后接任意个由一个数字、字母或者下划线、$组成的字符串</p>
<p><code>A|B </code> 可以匹配A或B，所以 <code>(J|j)ava(S|s)cript</code> 可以匹配 JavaScript、’Javascript</p>
<p><code>^</code> 表示行的开头，<code>^\d</code> 表示必须以数字开头</p>
<p><code>$</code> 表示行的结束，<code>\d$</code> 表示必须以数字结束</p>
<h6 id="RegExp"><a href="#RegExp" class="headerlink" title="RegExp"></a>RegExp</h6><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> re1 = <span class="regexp">/ABC\-001/</span>;</span><br><span class="line"><span class="keyword">var</span> re2 = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">&#x27;ABC\\-001&#x27;</span>); <span class="comment">//需要转义</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> re = <span class="regexp">/^\d&#123;3&#125;\-\d&#123;3,8&#125;$/</span>;</span><br><span class="line">re.test(<span class="string">&#x27;010-12345&#x27;</span>); <span class="comment">// true</span></span><br><span class="line">re.test(<span class="string">&#x27;010-1234x&#x27;</span>); <span class="comment">// false</span></span><br><span class="line">re.test(<span class="string">&#x27;010 12345&#x27;</span>); <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>RegExp 对象的 test() 方法用于测试给定的字符串是否符合条件</p>
<h6 id="切分字符串"><a href="#切分字符串" class="headerlink" title="切分字符串"></a>切分字符串</h6><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;a b   c&#x27;</span>.split(<span class="string">&#x27; &#x27;</span>); <span class="comment">// [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;&#x27;, &#x27;&#x27;, &#x27;c&#x27;] 无法识别连续空格</span></span><br><span class="line"><span class="string">&#x27;a b   c&#x27;</span>.split(<span class="regexp">/\s+/</span>); <span class="comment">// [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;]</span></span><br><span class="line"><span class="string">&#x27;a,b, c  d&#x27;</span>.split(<span class="regexp">/[\s\,]+/</span>); <span class="comment">// [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;d&#x27;]</span></span><br><span class="line"><span class="string">&#x27;a,b;; c  d&#x27;</span>.split(<span class="regexp">/[\s\,\;]+/</span>); <span class="comment">// [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;d&#x27;]</span></span><br></pre></td></tr></table></figure>

<h6 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h6><p>正则表达式还有提取子串的功能，用()表示的是要提取的分组</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> re = <span class="regexp">/^(\d&#123;3&#125;)-(\d&#123;3,8&#125;)$/</span>;</span><br><span class="line">re.exec(<span class="string">&#x27;010-12345&#x27;</span>); <span class="comment">// [&#x27;010-12345&#x27;, &#x27;010&#x27;, &#x27;12345&#x27;]</span></span><br><span class="line">re.exec(<span class="string">&#x27;010 12345&#x27;</span>); <span class="comment">// null</span></span><br></pre></td></tr></table></figure>

<p>定义了两个组，可以直接从匹配的字符串中提取出区号和本地号码，exec() 方法提取出子串</p>
<h6 id="贪婪匹配"><a href="#贪婪匹配" class="headerlink" title="贪婪匹配"></a>贪婪匹配</h6><p>正则表达式默认是贪婪匹配，匹配尽可能多的字符</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> re = <span class="regexp">/^(\d+)(0*)$/</span>;</span><br><span class="line">re.exec(<span class="string">&#x27;102300&#x27;</span>); <span class="comment">// [&#x27;102300&#x27;, &#x27;102300&#x27;, &#x27;&#x27;]</span></span><br></pre></td></tr></table></figure>

<p>\d+采用贪婪匹配，直接把后面的 0 全部匹配了，<code>0*</code> 只能匹配空字符串了</p>
<p>加个 <code>?</code> 就让 \d+采用非贪婪匹配（尽可能少匹配）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> re = <span class="regexp">/^(\d+?)(0*)$/</span>;</span><br><span class="line">re.exec(<span class="string">&#x27;102300&#x27;</span>); <span class="comment">// [&#x27;102300&#x27;, &#x27;1023&#x27;, &#x27;00&#x27;]</span></span><br></pre></td></tr></table></figure>

<h6 id="全局搜索"><a href="#全局搜索" class="headerlink" title="全局搜索"></a>全局搜索</h6><p>JavaScript 的正则表达式还有几个特殊的标志，最常用的是 g，表示全局匹配</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> r1 = <span class="regexp">/test/g</span>;</span><br><span class="line"><span class="comment">// 等价于:</span></span><br><span class="line"><span class="keyword">var</span> r2 = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">&#x27;test&#x27;</span>, <span class="string">&#x27;g&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>全局匹配可以多次执行 exec() 方法来搜索一个匹配的字符串，指定 g 标志后，每次运行 exec()，正则表达式本身会更新 lastIndex 属性，表示上次匹配到的最后索引</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s = <span class="string">&#x27;JavaScript, VBScript, JScript and ECMAScript&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> re=<span class="regexp">/[a-zA-Z]+Script/g</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用全局匹配:</span></span><br><span class="line">re.exec(s); <span class="comment">// [&#x27;JavaScript&#x27;]</span></span><br><span class="line">re.lastIndex; <span class="comment">// 10</span></span><br><span class="line">re.exec(s); <span class="comment">// [&#x27;VBScript&#x27;]</span></span><br><span class="line">re.lastIndex; <span class="comment">// 20</span></span><br><span class="line">re.exec(s); <span class="comment">// [&#x27;JScript&#x27;]</span></span><br><span class="line">re.lastIndex; <span class="comment">// 29</span></span><br><span class="line">re.exec(s); <span class="comment">// [&#x27;ECMAScript&#x27;]</span></span><br><span class="line">re.lastIndex; <span class="comment">// 44</span></span><br><span class="line">re.exec(s); <span class="comment">// null，直到结束仍没有匹配到</span></span><br></pre></td></tr></table></figure>

<p>正则表达式还可以指定 i 标志，表示忽略大小写，m 标志，表示执行多行匹配</p>
<h5 id="3-4-JSON"><a href="#3-4-JSON" class="headerlink" title="3.4 JSON"></a>3.4 JSON</h5><h6 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h6><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xiaoming = &#123;</span><br><span class="line">    name: <span class="string">&#x27;小明&#x27;</span>,</span><br><span class="line">    age: <span class="number">14</span>,</span><br><span class="line">    gender: <span class="literal">true</span>,</span><br><span class="line">    height: <span class="number">1.65</span>,</span><br><span class="line">    grade: <span class="literal">null</span>,</span><br><span class="line">    <span class="string">&#x27;middle-school&#x27;</span>: <span class="string">&#x27;\&quot;W3C\&quot; Middle School&#x27;</span>,</span><br><span class="line">    skills: [<span class="string">&#x27;JavaScript&#x27;</span>, <span class="string">&#x27;Java&#x27;</span>, <span class="string">&#x27;Python&#x27;</span>, <span class="string">&#x27;Lisp&#x27;</span>]</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> s = <span class="built_in">JSON</span>.stringify(xiaoming);</span><br><span class="line"><span class="built_in">console</span>.log(s);</span><br></pre></td></tr></table></figure>

<p>要输出好看些，可以加上参数，按缩进输出</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">JSON</span>.stringify(xiaoming, <span class="literal">null</span>, <span class="string">&#x27;  &#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>第二个参数用于控制如何筛选对象的键值，如果想输出指定的属性，可以传入 Array</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">JSON</span>.stringify(xiaoming, [<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;skills&#x27;</span>], <span class="string">&#x27;  &#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>还可以传入一个函数，这样对象的每个键值对都会被函数先处理</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">convert</span>(<span class="params">key, value</span>) </span>&#123; </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> value.toUpperCase();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">JSON</span>.stringify(xiaoming, convert, <span class="string">&#x27;  &#x27;</span>);<span class="comment">//把属性值都变成大写</span></span><br></pre></td></tr></table></figure>

<p>如果还想要精确控制如何序列化小明，可以给xiaoming 定义一个 toJSON() 的方法，直接返回 JSON 应该序列化的数据</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xiaoming = &#123;</span><br><span class="line">    name: <span class="string">&#x27;小明&#x27;</span>,</span><br><span class="line">    age: <span class="number">14</span>,</span><br><span class="line">    gender: <span class="literal">true</span>,</span><br><span class="line">    toJSON: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;Name&#x27;</span>: <span class="built_in">this</span>.name,</span><br><span class="line">        <span class="string">&#x27;Age&#x27;</span>: <span class="built_in">this</span>.age</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">JSON</span>.stringfy(xiaoming);</span><br></pre></td></tr></table></figure>

<h6 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h6><p>JSON.parse() 把 JSON 格式的字符串变成一个 JavaScript 对象</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">JSON</span>.parse(<span class="string">&#x27;[1,2,3,true]&#x27;</span>);<span class="comment">//[1,2,3,true]</span></span><br><span class="line"><span class="built_in">JSON</span>.parse(<span class="string">&#x27;123.45&#x27;</span>);<span class="comment">//123.45</span></span><br></pre></td></tr></table></figure>

<p>JSON.parse() 还可以接收一个函数，用来转换解析出的属性</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = <span class="built_in">JSON</span>.parse(<span class="string">&#x27;&#123;&quot;name&quot;:&quot;小明&quot;,&quot;age&quot;:14&#125;&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">key, value</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (key === <span class="string">&#x27;name&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> value + <span class="string">&#x27;同学&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(obj)); <span class="comment">// &#123;name: &#x27;小明同学&#x27;, age: 14&#125;</span></span><br></pre></td></tr></table></figure>
























      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/18/JavaScript%EF%BC%88%E4%B8%80%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/18/JavaScript%EF%BC%88%E4%B8%80%EF%BC%89/" class="post-title-link" itemprop="url">JavaScript（一）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-09-18 16:37:11" itemprop="dateCreated datePublished" datetime="2022-09-18T16:37:11+08:00">2022-09-18</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-09-19 09:33:27" itemprop="dateModified" datetime="2022-09-19T09:33:27+08:00">2022-09-19</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://www.liaoxuefeng.com/wiki/1022910821149312/1023020895584256">廖雪峰JavaScript</a></p>
<h4 id="1-入门"><a href="#1-入门" class="headerlink" title="1 入门"></a>1 入门</h4><p>JavaScript可以嵌套在网页的任何地方，通常把 JavaScript 代码放到 <code>&lt;head&gt;</code> 中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;script&gt;</span><br><span class="line">    alert(<span class="string">&#x27;Hello, world&#x27;</span>);</span><br><span class="line">  &lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  ...</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>可以把 JavaScript 代码放到单独的 .js 文件，HTML 中通过 <code>&lt;script src=&quot;...&quot;&gt;&lt;/script&gt;</code> 引入这个文件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;script src=<span class="string">&quot;/static/js/abc.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  ...</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>可以同个页面中引入多个 .js 文件，还可在页面中多次编写 <code>&lt;script&gt; js代码... &lt;/script&gt;</code> , 浏览器按照顺序依次执行</p>
<p>有时候会看到 <code>&lt;script&gt;</code> 标签还设置了一个 type 属性</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">  ...</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>这个没必要，默认就是 JavaScript 类型的</p>
<h5 id="1-1-基本语法"><a href="#1-1-基本语法" class="headerlink" title="1.1 基本语法"></a>1.1 基本语法</h5><p>JavaScript 语法和 Java 语法类似，每个语句以 ；结束，JavaScript 不强制要求在每个语句结尾加；</p>
<h5 id="1-2-数据类型和变量"><a href="#1-2-数据类型和变量" class="headerlink" title="1.2 数据类型和变量"></a>1.2 数据类型和变量</h5><h6 id="Number"><a href="#Number" class="headerlink" title="Number"></a>Number</h6><p>JavaScript 不区分整数和浮点数，统一用 Number 表示</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">123</span>;  <span class="comment">//整数</span></span><br><span class="line"><span class="number">0.456</span>;<span class="comment">//浮点数</span></span><br><span class="line"><span class="literal">NaN</span>;  <span class="comment">//Not a Number，当无法计算结果时用 NaN 表示</span></span><br><span class="line"><span class="literal">Infinity</span>；<span class="comment">//表示无限大</span></span><br></pre></td></tr></table></figure>

<h6 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h6><p>单引号或双引号括起来的任意文本</p>
<h6 id="布尔值"><a href="#布尔值" class="headerlink" title="布尔值"></a>布尔值</h6><p>true、false 两种值</p>
<h6 id="比较运算符"><a href="#比较运算符" class="headerlink" title="比较运算符"></a>比较运算符</h6><p>==，会自动转换数据类型再比较，很多时候，会得到非常诡异的结果</p>
<p>===，不会自动转换数据类型，如果数据类型不一致，会返回 false，如果一致，再比较</p>
<p>由于JavaScript这个设计缺陷，不要使用 == 比较，坚持使用 === 比较</p>
<p>NaN 这个特殊的 Number 与所有其他值都不相等，唯一能判断 NaN 的方法是通过 isNaN() 函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">NaN</span> === <span class="literal">NaN</span>; <span class="comment">//false</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="literal">NaN</span>);  <span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<p>浮点数比较</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>/<span class="number">3</span> === (<span class="number">1</span>-<span class="number">2</span>/<span class="number">3</span>); <span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>浮点数在运算过程中会产生误差，要比较两个浮点数是否相等，只能计算它们之差的绝对值，看是否小于某个阈值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Math</span>.abs(<span class="number">1</span>/<span class="number">3</span> - (<span class="number">1</span>-<span class="number">2</span>/<span class="number">3</span>)) &lt; <span class="number">0.0000001</span>; <span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<h6 id="null-和-undefined"><a href="#null-和-undefined" class="headerlink" title="null 和 undefined"></a>null 和 undefined</h6><p>null 表示一个空的值，Java 中也用null，Swift 用 nil，Python用None表示</p>
<p>undefined 表示值未定义。仅仅在判断函数参数是否传递的情况下有用</p>
<h6 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h6><p>JavaScript 的数组可以包括任意数据类型</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3.14</span>, <span class="string">&#x27;hello&#x27;</span>, <span class="literal">null</span>, <span class="literal">true</span>];</span><br><span class="line">arr[<span class="number">0</span>]; <span class="comment">//1</span></span><br></pre></td></tr></table></figure>

<p>另一种创建数组的方式通过 Array() 函数实现</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>); <span class="comment">//创建了数组 [1,2,3]</span></span><br></pre></td></tr></table></figure>

<h6 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h6><p>JavaScript 的对象是一组由键-值组成的无序集合</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">  name: <span class="string">&#x27;Bob&#x27;</span>,</span><br><span class="line">  age: <span class="number">20</span>,</span><br><span class="line">  tags: [<span class="string">&#x27;js&#x27;</span>, <span class="string">&#x27;web&#x27;</span>],</span><br><span class="line">  hasCar: <span class="literal">true</span>,</span><br><span class="line">  zipcode: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>键都是字符串类型，值可以是任意数据类型。</p>
<p>每个键又称为对象的属性</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">person.name; <span class="comment">// &#x27;Bob&#x27;</span></span><br><span class="line">person.zipcode; <span class="comment">// null</span></span><br></pre></td></tr></table></figure>

<h6 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h6><p>声明一个变量用 var 语句，同一个变量可以反复赋值，而且可以是不同类型的变量</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a;<span class="comment">//声明了变量a，此时 a 的值为 undefined</span></span><br><span class="line"><span class="keyword">var</span> t = <span class="literal">null</span>;<span class="comment">//t的值是null</span></span><br><span class="line"><span class="keyword">var</span> b = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> c = <span class="number">123</span>;</span><br><span class="line">c = <span class="string">&#x27;abc&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这种变量本身类型不固定的语言称之为动态语言。静态语言在定义变量时必须指定变量类型，Java 是静态语言。</p>
<h6 id="strict-模式"><a href="#strict-模式" class="headerlink" title="strict 模式"></a>strict 模式</h6><p>如果一个变量没有通过 var 声明就被使用，那么该变量就自动被声明为全局变量</p>
<p>ECMA 在后续规范中推出了 strict 模式，strict 模式下运行的 JavaScript，强制通过 var 声明变量，未使用 var 声明的变量就使用的，将导致运行错误</p>
<p>启用 strict 模式的方法是在 JavaScript 代码的第一行写上</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h5 id="1-3-字符串"><a href="#1-3-字符串" class="headerlink" title="1.3 字符串"></a>1.3 字符串</h5><h6 id="多行字符串"><a href="#多行字符串" class="headerlink" title="多行字符串"></a>多行字符串</h6><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">`这是一个</span></span><br><span class="line"><span class="string">多行</span></span><br><span class="line"><span class="string">字符串`</span>;</span><br></pre></td></tr></table></figure>

<h6 id="模板字符串"><a href="#模板字符串" class="headerlink" title="模板字符串"></a>模板字符串</h6><p>多个字符串连接起来，可以用 + 号连接</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">&#x27;小明&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> age = <span class="number">20</span>;</span><br><span class="line"><span class="keyword">var</span> message = <span class="string">&#x27;你好,&#x27;</span> + name + <span class="string">&#x27;，你今年&#x27;</span> + age + <span class="string">&#x27;岁了&#x27;</span></span><br></pre></td></tr></table></figure>

<p>如果多个变量需要连接，用 + 号比较麻烦，ES6 新增了一种模板字符串</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> message = <span class="string">`你好，<span class="subst">$&#123;name&#125;</span>，你今年<span class="subst">$&#123;age&#125;</span>岁了`</span></span><br></pre></td></tr></table></figure>

<p>操作字符串</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s = <span class="string">&#x27;Hello, world&#x27;</span>;</span><br><span class="line">s[<span class="number">0</span>]; <span class="comment">//H</span></span><br><span class="line">s[<span class="number">13</span>]; <span class="comment">//undefined 超出范围的索引不会报错，返回 undefined</span></span><br></pre></td></tr></table></figure>

<p>字符串是不可变的，如果对字符串的某个索引赋值，不会报错，但也没有效果</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s = <span class="string">&#x27;Test&#x27;</span></span><br><span class="line">s[<span class="number">0</span>] = <span class="string">&#x27;X&#x27;</span></span><br><span class="line">alert(s);<span class="comment">//s任然为Test</span></span><br></pre></td></tr></table></figure>

<h6 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h6><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s = <span class="string">&#x27;Hello, world&#x27;</span>;</span><br><span class="line">s.toUpperCase();<span class="comment">//HELLO, WORLD</span></span><br><span class="line">s.toLowerCase();<span class="comment">//hello, world</span></span><br><span class="line">s.indexOf(<span class="string">&#x27;world&#x27;</span>); <span class="comment">//7</span></span><br><span class="line">s.indexOf(<span class="string">&#x27;World&#x27;</span>); <span class="comment">//没有找到指定字符串，返回-1</span></span><br><span class="line">s.substring(<span class="number">0</span>,<span class="number">5</span>); <span class="comment">//hello ，返回索引区间子串，从索引0开始到5，不包括5</span></span><br><span class="line">s.substring(<span class="number">7</span>); <span class="comment">//world，从索引7开始到结束</span></span><br></pre></td></tr></table></figure>

<h5 id="1-4-数组"><a href="#1-4-数组" class="headerlink" title="1.4 数组"></a>1.4 数组</h5><p>JavaScript 的 Array 可以包含任意数据类型</p>
<p>获取长度 length 属性</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3.14</span>, <span class="string">&#x27;Hello&#x27;</span>, <span class="literal">null</span>, <span class="literal">true</span>];</span><br><span class="line">arr.length; <span class="comment">//6</span></span><br></pre></td></tr></table></figure>

<p>给 Array 的 length 赋一个新值会导致 Array 大小的变化</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line">arr.length;<span class="comment">//3</span></span><br><span class="line">arr.length = <span class="number">4</span>;</span><br><span class="line">arr;<span class="comment">//[1,2,3,undefined]</span></span><br><span class="line">arr.length = <span class="number">2</span>;</span><br><span class="line">arr;<span class="comment">//[1,2]</span></span><br></pre></td></tr></table></figure>

<p>修改值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>];</span><br><span class="line">arr[<span class="number">1</span>] = <span class="number">99</span>; <span class="comment">//[&#x27;A&#x27;,99,&#x27;C&#x27;]</span></span><br></pre></td></tr></table></figure>

<p>索引赋值时，索引超过了范围，同样会引起 Array 大小的变化</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line">arr[<span class="number">5</span>] = <span class="string">&#x27;x&#x27;</span></span><br><span class="line">arr;<span class="comment">//[1,2,3,undefined,undefined,&#x27;x&#x27;]</span></span><br></pre></td></tr></table></figure>

<p>编写代码时不建议直接修改 Array 的大小，访问索引时确保索引不会越界</p>
<h6 id="indexOf"><a href="#indexOf" class="headerlink" title="indexOf"></a>indexOf</h6><p>搜索指定元素的位置</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">10</span>,<span class="number">20</span>,<span class="string">&#x27;30&#x27;</span>,<span class="string">&#x27;xyz&#x27;</span>];</span><br><span class="line">arr.indexOf(<span class="number">10</span>);<span class="comment">//元素10的索引为0</span></span><br><span class="line">arr.indexOf(<span class="number">30</span>);<span class="comment">//元素30没有找到返回-1</span></span><br></pre></td></tr></table></figure>

<h6 id="slice"><a href="#slice" class="headerlink" title="slice"></a>slice</h6><p>slice() 就是对应 String 的 substring() 版本，截取 Array 的部分元素，返回一个新的 Array</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>,<span class="string">&#x27;D&#x27;</span>,<span class="string">&#x27;E&#x27;</span>,<span class="string">&#x27;F&#x27;</span>,<span class="string">&#x27;G&#x27;</span>];</span><br><span class="line">arr.slice(<span class="number">0</span>,<span class="number">3</span>);<span class="comment">//从索引0开始，到索引3结束，不包括3 [&#x27;A&#x27;,&#x27;B&#x27;,&#x27;C&#x27;]</span></span><br><span class="line">arr.slice(<span class="number">3</span>);<span class="comment">//从索引3开始到结束 [&#x27;E&#x27;,&#x27;F&#x27;,&#x27;G&#x27;]</span></span><br></pre></td></tr></table></figure>

<p>如果不给 slice() 传递任何参数，就会从头到尾截取所有元素，利用这一点可以很容易复制一个 Array</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> aCopy = arr.slice();</span><br></pre></td></tr></table></figure>

<h6 id="push-和-pop"><a href="#push-和-pop" class="headerlink" title="push 和 pop"></a>push 和 pop</h6><p>push() 向 Array 末尾添加若干元素，pop() 把 Array 最后一个元素删掉</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>,<span class="number">2</span>];</span><br><span class="line">arr.push(<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>);<span class="comment">//[1,2,&#x27;A&#x27;,&#x27;B&#x27;]</span></span><br><span class="line">arr.pop();<span class="comment">//pop()返回&#x27;B&#x27;</span></span><br><span class="line">arr;<span class="comment">//[1,2,&#x27;A&#x27;]</span></span><br><span class="line">arr.pop();arr.pop(),arr.pop();</span><br><span class="line">arr.pop();<span class="comment">//空数组pop不会报错，返回undefined</span></span><br></pre></td></tr></table></figure>

<h6 id="unshift-和-shift"><a href="#unshift-和-shift" class="headerlink" title="unshift 和 shift"></a>unshift 和 shift</h6><p>往 Array 的头部添加若干元素，使用 unshift()，shift() 把 Array 第一个元素删掉</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>,<span class="number">2</span>];</span><br><span class="line">arr.unshift(<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>);<span class="comment">//[&#x27;A&#x27;,&#x27;B&#x27;,1,2]</span></span><br><span class="line">arr.shift();<span class="comment">//返回 ‘A’</span></span><br><span class="line">arr;<span class="comment">//[&#x27;B&#x27;,1,2]</span></span><br><span class="line">arr.shift();arr.shift();arr.shift();</span><br><span class="line">arr.shift();<span class="comment">//空数组shift不会报错，返回undefined</span></span><br></pre></td></tr></table></figure>

<h6 id="sort"><a href="#sort" class="headerlink" title="sort"></a>sort</h6><p>sort() 对当前 Array 进行排序，会直接修改当前 Array 的元素位置，直接调用时，按照默认顺序排序</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>,<span class="string">&#x27;A&#x27;</span>];</span><br><span class="line">arr.sort();</span><br><span class="line">arr;<span class="comment">//[&#x27;A&#x27;,&#x27;B&#x27;,&#x27;C&#x27;]</span></span><br></pre></td></tr></table></figure>

<h6 id="reverse"><a href="#reverse" class="headerlink" title="reverse"></a>reverse</h6><p>reverse() 把整个 Array 的元素反转</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;one&#x27;</span>,<span class="string">&#x27;two&#x27;</span>,<span class="string">&#x27;three&#x27;</span>];</span><br><span class="line">arr.reverse();</span><br><span class="line">arr;<span class="comment">//[&#x27;three&#x27;,&#x27;two&#x27;,&#x27;one&#x27;]</span></span><br></pre></td></tr></table></figure>

<h6 id="slice-1"><a href="#slice-1" class="headerlink" title="slice"></a>slice</h6><p>slice() 是修改 Array 的万能方法，可以从指定的索引开始删除若干个元素，然后再从该位置添加若干个元素</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;Microsoft&#x27;</span>,<span class="string">&#x27;Apple&#x27;</span>,<span class="string">&#x27;Yahoo&#x27;</span>,<span class="string">&#x27;AOL&#x27;</span>,<span class="string">&#x27;Excite&#x27;</span>,<span class="string">&#x27;Oracle&#x27;</span>];</span><br><span class="line">arr.slice(<span class="number">2</span>,<span class="number">3</span>,<span class="string">&#x27;Google&#x27;</span>,<span class="string">&#x27;Facebook&#x27;</span>);<span class="comment">//从索引2开始删除3个元素，再添加两个元素</span></span><br><span class="line"><span class="comment">//[&#x27;Microsoft&#x27;,&#x27;Apple&#x27;,&#x27;Google&#x27;,&#x27;Facebook&#x27;,&#x27;Oracle&#x27;]</span></span><br><span class="line">arr.slice(<span class="number">2</span>,<span class="number">2</span>);<span class="comment">//只删除不添加</span></span><br><span class="line"><span class="comment">//[&#x27;Microsoft&#x27;,&#x27;Apple&#x27;,&#x27;Oracle&#x27;]</span></span><br><span class="line">arr.slice(<span class="number">2</span>,<span class="number">0</span>,<span class="string">&#x27;Google&#x27;</span>,<span class="string">&#x27;Facebook&#x27;</span>);<span class="comment">//只添加不shanc</span></span><br><span class="line"><span class="comment">//[&#x27;Microsoft&#x27;,&#x27;Apple&#x27;,&#x27;Google&#x27;,&#x27;Facebook&#x27;,&#x27;Oracle&#x27;]</span></span><br></pre></td></tr></table></figure>

<h6 id="concat"><a href="#concat" class="headerlink" title="concat"></a>concat</h6><p>concat() 方法把当前的 Array 和 另一个 Array 连接起来，并返回新的 Array</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>];</span><br><span class="line"><span class="keyword">var</span> added = arr.concat([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]);</span><br><span class="line">added;<span class="comment">//返回新的 Array [&#x27;A&#x27;,&#x27;B&#x27;,&#x27;C&#x27;,1,2,3] </span></span><br></pre></td></tr></table></figure>

<p>concat() 方法可以接收任意个元素和 Array，并且自动把 Array 拆开</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arr.concat(<span class="number">1</span>,<span class="number">2</span>,[<span class="number">3</span>,<span class="number">4</span>]);</span><br></pre></td></tr></table></figure>

<h6 id="join"><a href="#join" class="headerlink" title="join"></a>join</h6><p>join() 把当前 Array 的每个元素都用指定的字符串连接起来，然后返回连接后的字符串</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">arr.join(<span class="string">&#x27;-&#x27;</span>);<span class="comment">//&#x27;A-B-C-1-2-3&#x27;</span></span><br></pre></td></tr></table></figure>

<p>如果 Array 的元素不是字符串，将自动转换为字符串后连接</p>
<h6 id="多维数组"><a href="#多维数组" class="headerlink" title="多维数组"></a>多维数组</h6><p>数组的某个元素又是一个数组</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>],[<span class="number">400</span>,<span class="number">500</span>,<span class="number">600</span>],<span class="string">&#x27;-&#x27;</span>];</span><br></pre></td></tr></table></figure>

<h5 id="1-5-对象"><a href="#1-5-对象" class="headerlink" title="1.5 对象"></a>1.5 对象</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">  name: <span class="string">&#x27;Bob&#x27;</span>,</span><br><span class="line">  age: <span class="number">20</span>,</span><br><span class="line">  tags: [<span class="string">&#x27;js&#x27;</span>, <span class="string">&#x27;web&#x27;</span>],</span><br><span class="line">  hasCar: <span class="literal">true</span>,</span><br><span class="line">  zipcode: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="访问属性"><a href="#访问属性" class="headerlink" title="访问属性"></a>访问属性</h6><p>访问属性通过 . 操作符完成，属性名必须是一个有效的变量名，如果属性名包含特殊字符，就必须用 <code>‘ ’</code> 括起来</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> xiaohong = &#123;</span><br><span class="line">    name: <span class="string">&#x27;小红&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;middle-school&#x27;</span>: <span class="string">&#x27;No.1 Middle School&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line">xiaohong[<span class="string">&#x27;middle-school&#x27;</span>]; <span class="comment">// &#x27;No.1 Middle School&#x27;</span></span><br><span class="line">xiaohong[<span class="string">&#x27;name&#x27;</span>]; <span class="comment">// &#x27;小红&#x27;</span></span><br><span class="line">xiaohong.name; <span class="comment">// &#x27;小红&#x27; 更简洁</span></span><br></pre></td></tr></table></figure>

<p>访问不存在的属性不报错，返回 undefined。</p>
<h6 id="添加删除属性"><a href="#添加删除属性" class="headerlink" title="添加删除属性"></a>添加删除属性</h6><p>JavaScript 对象是动态类型，可以自动地给一个对象添加或删除属性</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xiaohong.age;<span class="comment">//undefined</span></span><br><span class="line">xiaohong.age = <span class="number">18</span>;<span class="comment">//新增age属性</span></span><br><span class="line"><span class="keyword">delete</span> xiaohong.age;<span class="comment">//删除age属性</span></span><br><span class="line"><span class="keyword">delete</span> xiaohong.school;<span class="comment">//删除不存在的属性也不会报错</span></span><br></pre></td></tr></table></figure>

<p>检测是否拥有某一个属性，使用 in 操作符</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;name&#x27;</span> <span class="keyword">in</span> xiaohong; <span class="comment">//true</span></span><br><span class="line"><span class="string">&#x27;grade&#x27;</span> <span class="keyword">in</span> xiaohong; <span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>in 判断一个属性存在，这个属性不一定是 xiaohong 的，可能是 xiaohong 继承得到的</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;toString&#x27;</span> <span class="keyword">in</span> xiaohong;<span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<p>toString 定义在 object 对象中，所有对象最终都会在原型链上指向 object，所以 xiaohong 也拥有 toString 属性。</p>
<p>要判断一个属性是否是 xiaohong 自身拥有的，而不是继承得到的，使用 hasOwnProperty() 方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xiaohong.hasOwnProperty(<span class="string">&#x27;name&#x27;</span>); <span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<h5 id="1-6-条件判断"><a href="#1-6-条件判断" class="headerlink" title="1.6 条件判断"></a>1.6 条件判断</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> age = <span class="number">20</span>;</span><br><span class="line"><span class="keyword">if</span> (age &gt;= <span class="number">18</span>) &#123;</span><br><span class="line">	alert(<span class="string">&#x27;adult&#x27;</span>); <span class="comment">//只包含一条语句 &#123;&#125; 也可以省略，建议写上</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	alert(<span class="string">&#x27;teenager&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>JavaScript 把 null、undefined、0、NaN 和空字符串 ‘’ 视为 false，其它一概视为 true</p>
<h5 id="1-7-循环"><a href="#1-7-循环" class="headerlink" title="1.7 循环"></a>1.7 循环</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> i;</span><br><span class="line"><span class="function"><span class="title">for</span>(<span class="params">i=<span class="number">1</span>;i&lt;<span class="number">100</span>;i++</span>)</span>&#123;</span><br><span class="line">  x = x + i;</span><br><span class="line">&#125;</span><br><span class="line">x;</span><br><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;Apple&#x27;</span>,<span class="string">&#x27;Google&#x27;</span>,<span class="string">&#x27;Microsoft&#x27;</span>]</span><br><span class="line"><span class="keyword">var</span> i, x;</span><br><span class="line"><span class="function"><span class="title">for</span>(<span class="params">i=<span class="number">0</span>;i&lt;arr.length;i++</span>)</span>&#123;</span><br><span class="line">  x = arr[i];</span><br><span class="line">  <span class="built_in">console</span>.log(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>for 循环的3个条件都是可以省略的，如果没有退出循环条件，就必须用break语句退出循环</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="title">for</span>(<span class="params">;;</span>)</span>&#123;</span><br><span class="line">  <span class="function"><span class="title">if</span>(<span class="params">x&gt;<span class="number">100</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  x++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="for-…-in"><a href="#for-…-in" class="headerlink" title="for … in"></a>for … in</h6><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> o = &#123;</span><br><span class="line">  name: <span class="string">&#x27;jack&#x27;</span>,</span><br><span class="line">  age: <span class="number">20</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">for</span>(<span class="params"><span class="keyword">var</span> key <span class="keyword">in</span> o</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(key); <span class="comment">//&#x27;name&#x27;, &#x27;age&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">for</span>(<span class="params"><span class="keyword">var</span> key <span class="keyword">in</span> o</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (o.hasOwnProperty(key))&#123;<span class="comment">//过滤掉对象继承的属性</span></span><br><span class="line">    <span class="built_in">console</span>.log(key);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>for … in 对 Array 的循环得到的是 String 而不是 Number</p>
<h6 id="while"><a href="#while" class="headerlink" title="while"></a>while</h6><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> n = <span class="number">99</span>;</span><br><span class="line"><span class="function"><span class="title">while</span>(<span class="params">n&gt;<span class="number">0</span></span>)</span>&#123;</span><br><span class="line">  x = x + n;</span><br><span class="line">  n = n - <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line">x;</span><br></pre></td></tr></table></figure>

<h6 id="do-…-while"><a href="#do-…-while" class="headerlink" title="do … while"></a>do … while</h6><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> n = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">  n = n + <span class="number">1</span>;</span><br><span class="line">&#125; <span class="keyword">while</span> (n &lt; <span class="number">100</span>);</span><br><span class="line">n;</span><br></pre></td></tr></table></figure>

<h5 id="1-8-Map-和-Set"><a href="#1-8-Map-和-Set" class="headerlink" title="1.8 Map 和 Set"></a>1.8 Map 和 Set</h5><p>最新的 ES6 规范引入了新的数据类型 Map</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span></span><br><span class="line"><span class="keyword">var</span> m = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line"><span class="keyword">var</span> s = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br></pre></td></tr></table></figure>

<h6 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h6><p>是一组键值对的数据结构，具有极快的查找速度</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> m = <span class="keyword">new</span> <span class="built_in">Map</span>([[<span class="string">&#x27;Michale&#x27;</span>,<span class="number">95</span>],[<span class="string">&#x27;Bob&#x27;</span>,<span class="number">75</span>],[<span class="string">&#x27;Tracy&#x27;</span>, <span class="number">85</span>]]);</span><br><span class="line">m.get(<span class="string">&#x27;Michale&#x27;</span>);<span class="comment">//95</span></span><br></pre></td></tr></table></figure>

<p>初始化 Map 需要一个二维数组，或者直接初始化一个空 Map</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> m = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">m.set(<span class="string">&#x27;Adam&#x27;</span>,<span class="number">67</span>);<span class="comment">//添加新的key-value</span></span><br><span class="line">m.has(<span class="string">&#x27;Adam&#x27;</span>);<span class="comment">//是否存在key ‘Adam’ true</span></span><br><span class="line">m.get(<span class="string">&#x27;Adam&#x27;</span>);<span class="comment">//67</span></span><br><span class="line">m.delete(<span class="string">&#x27;Adam&#x27;</span>);<span class="comment">//删除key</span></span><br><span class="line">m.get(<span class="string">&#x27;Adam&#x27;</span>);<span class="comment">//undefined</span></span><br></pre></td></tr></table></figure>

<h6 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h6><p>Set 和 Map 类似，也是一组 key 的集合，但不存储 value，key 不能重复</p>
<p>创建 Set，需要提供一个 Array 作为输入，或者直接创建一个空 Set</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s1 = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br><span class="line"><span class="keyword">var</span> s2 = <span class="keyword">new</span> <span class="built_in">Set</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]);<span class="comment">//含1,2,3</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s = <span class="keyword">new</span> <span class="built_in">Set</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="string">&#x27;3&#x27;</span>]);</span><br><span class="line">s;<span class="comment">//Set&#123;1,2,3,&#x27;3&#x27;&#125;</span></span><br><span class="line">s.add(<span class="number">4</span>);<span class="comment">//添加</span></span><br><span class="line">s.delete(<span class="number">3</span>);<span class="comment">//删除</span></span><br></pre></td></tr></table></figure>

<h5 id="1-9-iterable"><a href="#1-9-iterable" class="headerlink" title="1.9 iterable"></a>1.9 iterable</h5><p>遍历 Array 可以采用下标循环，遍历 Map 和 Set 就无法使用下标循环。</p>
<p>ES6 标准引入了新的 iterable 类型，Array、Map 和 Set 都属于 iterable 类型</p>
<p>具有iterable 类型的集合可以通过 for .. of 循环来遍历</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line"><span class="keyword">var</span> b = <span class="keyword">new</span> <span class="built_in">Set</span>([<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>]);</span><br><span class="line"><span class="keyword">var</span> c = <span class="keyword">new</span> <span class="built_in">Map</span>([[<span class="number">1</span>,<span class="string">&#x27;x&#x27;</span>],[<span class="number">2</span>,<span class="string">&#x27;y&#x27;</span>]]);</span><br><span class="line"><span class="function"><span class="title">for</span>(<span class="params"><span class="keyword">var</span> x <span class="keyword">of</span> a</span>)</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">for</span>(<span class="params"><span class="keyword">var</span> x <span class="keyword">of</span> b</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">for</span>(<span class="params"><span class="keyword">var</span> x <span class="keyword">of</span> c</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(x[<span class="number">0</span>]+<span class="string">&#x27;=&#x27;</span>+x[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="forEach"><a href="#forEach" class="headerlink" title="forEach"></a>forEach</h6><p>iterable 内置的 forEach 方法，接收一个函数，每次迭代就自动回调该函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>];</span><br><span class="line">a.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">element, index, array</span>)</span>&#123;</span><br><span class="line">  <span class="comment">//element 当前元素的值</span></span><br><span class="line">  <span class="comment">//index 指向当前索引</span></span><br><span class="line">  <span class="comment">//array 指向Array对象本身</span></span><br><span class="line">  <span class="built_in">console</span>.log(element + <span class="string">&#x27;,index = &#x27;</span> + index);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Set 与 Array 类似，但 Set 没有索引</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s = <span class="keyword">new</span> <span class="built_in">Set</span>([<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>]);</span><br><span class="line">s.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">element, sameElement, set</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(element);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Map 的回调函数参数依次为 value、key 和 map 本身</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> m = <span class="keyword">new</span> <span class="built_in">Map</span>([[<span class="number">1</span>,<span class="string">&#x27;x&#x27;</span>],[<span class="number">2</span>,<span class="string">&#x27;y&#x27;</span>]]);</span><br><span class="line">m.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">value, key, map</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(value);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>如果对某些参数不感兴趣，JavaScript 的函数调用不要求参数必须一致，可以忽略它们，例如只需要获得 Array 的 element</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>];</span><br><span class="line">a.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">element</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(element);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>


















      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/08/%E9%80%86%E5%90%91-MonkeyDev/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/08/%E9%80%86%E5%90%91-MonkeyDev/" class="post-title-link" itemprop="url">逆向-MonkeyDev</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-07-08 12:23:14" itemprop="dateCreated datePublished" datetime="2022-07-08T12:23:14+08:00">2022-07-08</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-10-23 13:59:47" itemprop="dateModified" datetime="2022-10-23T13:59:47+08:00">2022-10-23</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/AloneMonkey/MonkeyDev/wiki/%E5%AE%89%E8%A3%85">MonkeyDev安装</a>  <a target="_blank" rel="noopener" href="https://github.com/AloneMonkey/MonkeyDevSpecs">MonkeyDev插件库</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/AloneMonkey/WeChatPod">WeChatPod</a>    <a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-265106.htm">破解iOS微信骰子和猜拳</a></p>
<p><a target="_blank" rel="noopener" href="http://blog.imjun.net/posts/restore-symbol-of-iOS-app/">恢复符号表</a>  </p>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>确保 Theos 环境已配置好</p>
<p>执行命令安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo &#x2F;bin&#x2F;sh -c &quot;$(curl -fsSL https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;AloneMonkey&#x2F;MonkeyDev&#x2F;master&#x2F;bin&#x2F;md-install)&quot;</span><br></pre></td></tr></table></figure>

<p>安装报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;Applications&#x2F;Xcode.app&#x2F;Contents&#x2F;Developer&#x2F;Platforms&#x2F;MacOSX.platform&#x2F;Developer&#x2F;Library&#x2F;Xcode&#x2F;Specifications&#x2F;MacOSX Package Types.xcspec not found</span><br><span class="line"></span><br><span class="line">解决：</span><br><span class="line">sudo ln -s &#x2F;Applications&#x2F;Xcode.app&#x2F;Contents&#x2F;Developer&#x2F;Platforms&#x2F;MacOSX.platform&#x2F;Developer&#x2F;Library&#x2F;Xcode&#x2F;PrivatePlugIns&#x2F;IDEOSXSupportCore.ideplugin&#x2F;Contents&#x2F;Resources &#x2F;Applications&#x2F;Xcode.app&#x2F;Contents&#x2F;Developer&#x2F;Platforms&#x2F;MacOSX.platform&#x2F;Developer&#x2F;Library&#x2F;Xcode&#x2F;Specifications</span><br></pre></td></tr></table></figure>



<p>卸载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo &#x2F;bin&#x2F;sh -c &quot;$(curl -fsSL https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;AloneMonkey&#x2F;MonkeyDev&#x2F;master&#x2F;bin&#x2F;md-uninstall)&quot;</span><br></pre></td></tr></table></figure>

<p>更新</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo &#x2F;bin&#x2F;sh -c &quot;$(curl -fsSL https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;AloneMonkey&#x2F;MonkeyDev&#x2F;master&#x2F;bin&#x2F;md-update)&quot;</span><br></pre></td></tr></table></figure>

<p>安装成功后 MonkeyDev 模板</p>
<p>![图 1](逆向-MonkeyDev/图 1.png)</p>
<h4 id="Logos-Tweak"><a href="#Logos-Tweak" class="headerlink" title="Logos Tweak"></a>Logos Tweak</h4><h5 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h5><p>Xcode 无法识别 .xm文件导致代码无法高亮，需要在Xcode界面右侧设置 Type 为 Objective-C++Source</p>
<p>.xm 文件相当于 Theos 工程中的 Tweak.xm，直接写 Logos 语法即可，编译时会通过 logos.pl 转换成 .mm 文件</p>
<p>目会自动链接 <code>CydiaSubstrate.framework</code> 无需再手动链接</p>
<p>项目的一些配置在 Build Settings 列表下面 User-Defined</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MonkeyDevBuildPackageOnAnyBuild     每次build都生成deb包</span><br><span class="line">MonkeyDevCopyOnBuild    build的时将deb包拷贝到设备的&#x2F;var&#x2F;root&#x2F;MonkeyDevBuilds&#x2F;目录</span><br><span class="line">MonkeyDevDeviceIP       目标设备的ip地址，默认USB连接，localhost</span><br><span class="line">MonkeyDevDevicePort     目标设备的端口，默认22(做了端口映射填映射的端口)</span><br><span class="line">MonkeyDevDevicePassword   目标设备的ssh登录密码，默认为空使用免密码登录</span><br><span class="line">MonkeyDevInstallOnAnyBuild            每次build都将deb安装到设备</span><br><span class="line">MonkeyDevInstallOnProfiling             点击Profile才将deb安装到设备</span><br><span class="line">MonkeyDevKillProcessOnInstall         安装的时候杀掉指定的进程，填写进程名</span><br><span class="line">MonkeyDevClearUiCacheOnInstall    安装时 clear uicache</span><br><span class="line">MonkeyDevPath              MonkeyDev的安装路径，默认的，不用修改</span><br><span class="line">MonkeyDevTheosPath    theos的安装路径</span><br></pre></td></tr></table></figure>

<p>Command + B 安装提示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Showing Recent Messages</span><br><span class="line">An empty identity is not valid when signing a binary for the product type &#39;Dynamic Library&#39;</span><br></pre></td></tr></table></figure>

<p>BuildSettings-User-Defined 添加 key CODE_SIGNING_ALLOWED NO</p>
<ul>
<li>Debug 模式安装</li>
</ul>
<p>Command+B自动安装到手机</p>
<ul>
<li>Release 模式安装</li>
</ul>
<p>Command+Shift+i，这种方式不会看到 Log</p>
<ul>
<li>查看 Log 输出</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ brew install libimobiledevice</span><br><span class="line">$ idevicesyslog | grep &#39;xxx&#39;</span><br></pre></td></tr></table></figure>

<p>或者自带的 console.app 查看</p>
<h4 id="非越狱APP集成"><a href="#非越狱APP集成" class="headerlink" title="非越狱APP集成"></a>非越狱APP集成</h4><p>创建 iOS 项目选择 MonkeyApp，越狱设备可以在 Target APP 填写目标 APP 的名字或 bundle id，工具将自动使用 frida-ios-dump 提取 ipa 文件（需要按 frida-ios-dump 的 README 配置好环境）</p>
<p><code>/opt/MonkeyDev/bin/dump.py</code> 可以指定 ip、port 及 password</p>
<p>创建项目名为 MonkeyApp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Config cycript的一些脚本下载以及methodtrace配置代码</span><br><span class="line">AntiAntiDebug 这里面是反反调试的代码</span><br><span class="line">fishhook 自动集成的fishhook模块</span><br></pre></td></tr></table></figure>

<p>项目已自动集成了 RevealServer.framework 和 libcycript.dylib，如果选择 Release 编译是不会集成的</p>
<h5 id="MDConfig-plist"><a href="#MDConfig-plist" class="headerlink" title="MDConfig.plist"></a>MDConfig.plist</h5><p><a target="_blank" rel="noopener" href="https://github.com/omxcodec/OCMethodTrace/blob/master/README.md">https://github.com/omxcodec/OCMethodTrace/blob/master/README.md</a></p>
<ul>
<li>class-dump</li>
</ul>
<p>工程集成了 class-dump 导出可执行文件 OC 头文件，build settings，MONKEYDEV_CLASS_DUMP YES</p>
<ul>
<li>增加自己的库 </li>
</ul>
<p>将需要注入的 dylib 或 framework 拷贝到 frameworks 目录下，静态库的话，直接添加，指定 search path，和正常开发没啥区别。</p>
<p>动态库本身的 install_path，可以通过 install_name_tool -id 修改其为 @executable_path/Frameworks/xxx</p>
<ul>
<li><p>集成网络 cy 脚本</p>
</li>
<li><p>更改名字和bundleid</p>
</li>
</ul>
<p>直接在Xcode进行设置，想使用原来的 bundleid 进行重签，设置 build settings， MONKEYDEV_DEFAULT_BUNDLEID 为 YES</p>
<ul>
<li>生成IPA</li>
</ul>
<p>运行之后在源代码 LatestBuild 目录 双击 createIPA.command</p>
<ul>
<li>支持 CocoaPods 集成第三方库</li>
</ul>
<p>需要设置 use_frameworks!  动态库方式，再执行 pod install</p>
<h5 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h5><p>MonkeyApp运行后可以直接断点调试，但是每次修改调试都要重新运行安装，比较麻烦。</p>
<p>Logos Tweak 也可以 Xcode 调试。重签安装被调试的应用</p>
<p>Xcode - Debug - Attach to Process by PID or Name</p>
<h4 id="CaptainHook-Tweak"><a href="#CaptainHook-Tweak" class="headerlink" title="CaptainHook Tweak"></a>CaptainHook Tweak</h4><p>（不易上手）</p>
<p>Logos Tweak 和 CaptainHook Tweak 都支持通过 Cocoapods 的方式集成，记得以静态库的方式集成</p>
<p>所以记得把 Podfile 中的 #use_frameworks! 注释掉，否则 Tweak 不生效</p>
<p>CaptainHook 无须依赖 Cydia Substrate 框架，直接导入 CaptainHook.h 头文件后使用里面的宏来进行 Hook</p>
<p><a target="_blank" rel="noopener" href="https://github.com/rpetrich/CaptainHook/wiki">https://github.com/rpetrich/CaptainHook/wiki</a></p>
<p>Hook OC 方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.CHDeclareClass声明一个类</span></span><br><span class="line"><span class="comment">//2.使用CHLoadClass()或者CHLoadLateClass()在 CHConstructor 中加载声明的类</span></span><br><span class="line"><span class="comment">//3.CHOptimizedMethod()来Hook目标函数</span></span><br><span class="line"><span class="comment">//4.CHHook()在CHConstructor中注册Hook</span></span><br><span class="line"><span class="comment">//5.CHSuper()调用Hook原函数逻辑</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&quot;CaptainHook/CaptainHook.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">CHDeclareClass(XLMemberManager);<span class="comment">//1 声明类</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//3 hook目标函数</span></span><br><span class="line"><span class="comment">//-(void)loginByUserName:(id)arg1 password:(id)arg2 verifyCode:(id)arg3 verifyKey:(id)arg4 finishBlock:(CDUnknownBlockType)arg5;</span></span><br><span class="line">CHOptimizedMethod(<span class="number">5</span>, <span class="keyword">self</span>, <span class="keyword">void</span>, XLMemberManager, loginByUserName, <span class="keyword">id</span>, arg1, password, <span class="keyword">id</span>, arg2, verifyCode, <span class="keyword">id</span>, arg3, verifyKey, <span class="keyword">id</span>, arg4, finishBlock, <span class="keyword">id</span>, arg5) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;userName:%@ password:%@ verifyCode:%@ verifyKey:%@&quot;</span>, arg1, arg2, arg3, arg4);</span><br><span class="line">    <span class="comment">//5 调用原来方法</span></span><br><span class="line">    <span class="keyword">return</span> CHSuper(<span class="number">5</span>, XLMemberManager, loginByUserName, arg1, password, arg2, verifyCode, arg3, verifyKey, arg4, finishBlock, arg5);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CHConstructor &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;__inject success__&quot;</span>);</span><br><span class="line">        <span class="comment">//2 加载声明的类</span></span><br><span class="line">        CHLoadLateClass(XLMemberManager);</span><br><span class="line">        <span class="comment">//4 注册hook 5个参数</span></span><br><span class="line">        CHHook(<span class="number">5</span>, XLMemberManager, loginByUserName, password, verifyCode, verifyKey, finishBlock);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ZKSwizzle"><a href="#ZKSwizzle" class="headerlink" title="ZKSwizzle"></a>ZKSwizzle</h4><p><a target="_blank" rel="noopener" href="https://github.com/alexzielenski/ZKSwizzle">https://github.com/alexzielenski/ZKSwizzle</a></p>
<p>语法接近 Theos</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;ZKSwizzle&#x2F;ZKSwizzle.h&quot;</span><br><span class="line">hook(XLMemberManager);</span><br><span class="line">-(void)loginByUserName:(id)arg1 password:(id)arg2 verifyCode:(id)arg3 verifyKey:(id)arg4 finishBlock:(void(^__nullable)(void))arg5 &#123;</span><br><span class="line">  NSLog(@&quot;userName:%@ password:%@ verifyCode:%@ verifyKey:%@&quot;, arg1, arg2, arg3, arg4);</span><br><span class="line">  &#x2F;&#x2F;调用原方法</span><br><span class="line">  ZKOrig(void, arg1, arg2, arg3, arg4, arg5);</span><br><span class="line">&#125;</span><br><span class="line">endhook</span><br><span class="line"></span><br><span class="line">ctor &#123;</span><br><span class="line">  NSLog(@&quot;__inject success__&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：finishBlock 的类型不能用 id 代替，改为 void(^__nullable)(void) 即可</p>
<h4 id="Command-line-Took"><a href="#Command-line-Took" class="headerlink" title="Command-line Took"></a>Command-line Took</h4><h4 id="Logify"><a href="#Logify" class="headerlink" title="Logify"></a>Logify</h4><p>Theos 自带的工具</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ logify.pl xxx.h &gt; xxx.xm</span><br></pre></td></tr></table></figure>

<h4 id="ANYMethodLog"><a href="#ANYMethodLog" class="headerlink" title="ANYMethodLog"></a>ANYMethodLog</h4><p><a target="_blank" rel="noopener" href="https://github.com/qhd/ANYMethodLog">https://github.com/qhd/ANYMethodLog</a></p>
<p>用途和 Logify 相似，可控度更高，只需要了解一个类</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* aClass 要打印的类</span></span><br><span class="line"><span class="comment">* condition 根据此 block 来决定是否追踪方法（sel 是方法名）</span></span><br><span class="line"><span class="comment">* before 方法调用前会调用该 block（target 是检测的对象，sel 是方法名，args 是参数列表，deep 是调用层级）</span></span><br><span class="line"><span class="comment">* after 法调用后会调用该 block（interval 是执行方法的耗时，retValue 是返回值）</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">+ (<span class="keyword">void</span>)logMethodWithClass:(Class)aClass</span><br><span class="line">                 condition:(<span class="built_in">BOOL</span>(^)(SEL sel)) condition</span><br><span class="line">                    before:(<span class="keyword">void</span>(^)(<span class="keyword">id</span> target, SEL sel, <span class="built_in">NSArray</span> *args, <span class="keyword">int</span> deep)) before</span><br><span class="line">                     after:(<span class="keyword">void</span>(^)(<span class="keyword">id</span> target, SEL sel, <span class="built_in">NSArray</span> *args, <span class="built_in">NSTimeInterval</span> interval, <span class="keyword">int</span> deep, <span class="keyword">id</span> retValue)) after;</span><br></pre></td></tr></table></figure>

<p>放到 %ctor</p>
<ol>
<li>打印一个类定义的所有方法，包括公开方法和私有方法</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">%ctor &#123;</span><br><span class="line">  [ANYMethodLog logMethodWithClass:[<span class="built_in">UIViewController</span> <span class="keyword">class</span>] condition:^<span class="built_in">BOOL</span>(SEL sel) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;method:%@&quot;</span>, <span class="built_in">NSStringFromSelector</span>(sel));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">	&#125; before:<span class="literal">nil</span> after:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>打印运行过程中调用了哪些方法</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[ANYMethodLog logMethodWithClass:[<span class="built_in">UIViewController</span> <span class="keyword">class</span>] condition:^<span class="built_in">BOOL</span>(SEL sel) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125; before:^(<span class="keyword">id</span> target, SEL sel, <span class="built_in">NSArray</span> *args, <span class="keyword">int</span> deep) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;target:%@ sel:%@&quot;</span>, target, <span class="built_in">NSStringFromSelector</span>(sel));</span><br><span class="line">&#125; after:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>打印特定几个方法的调用顺序</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[ANYMethodLog logMethodWithClass:[<span class="built_in">UIViewController</span> <span class="keyword">class</span>] condition:^<span class="built_in">BOOL</span>(SEL sel) &#123;</span><br><span class="line">    <span class="built_in">NSArray</span> *whiteList = @[<span class="string">@&quot;loadView&quot;</span>, </span><br><span class="line">                           <span class="string">@&quot;viewWillAppear:&quot;</span>,</span><br><span class="line">                           <span class="string">@&quot;viewDidAppear:&quot;</span>, </span><br><span class="line">                           <span class="string">@&quot;viewWillDisappear:&quot;</span>];</span><br><span class="line">    <span class="keyword">return</span> [whiteList containsObject:<span class="built_in">NSStringFromSelector</span>(sel)];</span><br><span class="line">&#125; before:^(<span class="keyword">id</span> target, SEL sel, <span class="built_in">NSArray</span> *args, <span class="keyword">int</span> deep) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;target:%@ sel:%@&quot;</span>, target, <span class="built_in">NSStringFromSelector</span>(sel));</span><br><span class="line">&#125; after:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>打印调用方法的参数值</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[ANYMethodLog logMethodWithClass:<span class="built_in">NSClassFromString</span>(<span class="string">@&quot;UIViewController&quot;</span>) condition:^<span class="built_in">BOOL</span>(SEL sel) &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSStringFromSelector</span>(sel) isEqualToString:<span class="string">@&quot;viewWillAppear:&quot;</span>];</span><br><span class="line">&#125; before:^(<span class="keyword">id</span> target, SEL sel, <span class="built_in">NSArray</span> *args, <span class="keyword">int</span> deep) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;before target:%@ sel:%@ args:%@&quot;</span>, target, <span class="built_in">NSStringFromSelector</span>(sel), args);</span><br><span class="line">&#125; after:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>打印某个方法调用前后的变化</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[ANYMethodLog logMethodWithClass:<span class="built_in">NSClassFromString</span>(<span class="string">@&quot;ListController&quot;</span>) condition:^<span class="built_in">BOOL</span>(SEL sel) &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSStringFromSelector</span>(sel) isEqualToString:<span class="string">@&quot;changeBackground&quot;</span>];</span><br><span class="line">&#125; before:^(<span class="keyword">id</span> target, SEL sel, <span class="built_in">NSArray</span> *args, <span class="keyword">int</span> deep) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;before background color:%@&quot;</span>, [(ListController *)target view].backgroundColor);</span><br><span class="line">&#125; after:^(<span class="keyword">id</span> target, SEL sel, <span class="built_in">NSArray</span> *args, <span class="built_in">NSTimeInterval</span> interval, <span class="keyword">int</span> deep, <span class="keyword">id</span> retValue) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;after background color:%@&quot;</span>, [(ListController *)target view].backgroundColor);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>打印某个方法调用的耗时</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[ANYMethodLog logMethodWithClass:<span class="built_in">NSClassFromString</span>(<span class="string">@&quot;ListController&quot;</span>) condition:^<span class="built_in">BOOL</span>(SEL sel) &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSStringFromSelector</span>(sel) isEqualToString:<span class="string">@&quot;changeBackground&quot;</span>];</span><br><span class="line">&#125; before:^(<span class="keyword">id</span> target, SEL sel, <span class="built_in">NSArray</span> *args, <span class="keyword">int</span> deep) &#123;</span><br><span class="line">&#125; after:^(<span class="keyword">id</span> target, SEL sel, <span class="built_in">NSArray</span> *args, <span class="built_in">NSTimeInterval</span> interval, <span class="keyword">int</span> deep, <span class="keyword">id</span> retValue) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;interval::%@&quot;</span>, [@(interval) stringValue]);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>追踪方法调用顺序</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[ANYMethodLog logMethodWithClass:<span class="built_in">NSClassFromString</span>(<span class="string">@&quot;ListController&quot;</span>) condition:^<span class="built_in">BOOL</span>(SEL sel) &#123;</span><br><span class="line">    <span class="keyword">return</span>  <span class="literal">YES</span>;</span><br><span class="line">&#125; before:^(<span class="keyword">id</span> target, SEL sel, <span class="built_in">NSArray</span> *args, <span class="keyword">int</span> deep) &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *selector = <span class="built_in">NSStringFromSelector</span>(sel);</span><br><span class="line">    <span class="built_in">NSArray</span> *selectorArrary = [selector componentsSeparatedByString:<span class="string">@&quot;:&quot;</span>];</span><br><span class="line">    selectorArrary = [selectorArrary filteredArrayUsingPredicate:[<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@&quot;length &gt; 0&quot;</span>]];</span><br><span class="line">    <span class="built_in">NSMutableString</span> *selectorString = [<span class="built_in">NSMutableString</span> new];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; selectorArrary.count; i++) &#123;</span><br><span class="line">        [selectorString appendFormat:<span class="string">@&quot;%@:%@ &quot;</span>, selectorArrary[i], args[i]];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSMutableString</span> *deepString = [<span class="built_in">NSMutableString</span> new];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; deep; i++) &#123;</span><br><span class="line">        [deepString appendString:<span class="string">@&quot;-&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@[%@ %@]&quot;</span>, deepString , target, selectorString);</span><br><span class="line">&#125; after:^(<span class="keyword">id</span> target, SEL sel, <span class="built_in">NSArray</span> *args, <span class="built_in">NSTimeInterval</span> interval, <span class="keyword">int</span> deep, <span class="keyword">id</span> retValue) &#123;</span><br><span class="line">    <span class="built_in">NSMutableString</span> *deepString = [<span class="built_in">NSMutableString</span> new];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; deep; i++) &#123;</span><br><span class="line">        [deepString appendString:<span class="string">@&quot;-&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ret:%@&quot;</span>, deepString, retValue);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<p>实际使用时，需要在 Makefile加入 ANYMethodLog.m </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iThunderHelper_FILES &#x3D; Tweak.xm ANYMethodLog.m </span><br></pre></td></tr></table></figure>

<h4 id="BigBang"><a href="#BigBang" class="headerlink" title="BigBang"></a>BigBang</h4><p>功能比较专一，主要用来 Hook 某个类的所有方法，打印所有方法的执行顺序</p>
<p><a target="_blank" rel="noopener" href="https://github.com/codesourse/BigBang">https://github.com/codesourse/BigBang</a></p>
<p>使用只需一个代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[BigBang hookClass:@&quot;XLMberManager&quot;]</span><br></pre></td></tr></table></figure>

<p>使用时注意，放在只会执行一次的函数里，避免多次 Hook，%ctor</p>
<p>Makefile 中添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iThunderHelper_FILES &#x3D; Tweak.xm BigBang.m </span><br></pre></td></tr></table></figure>





<h4 id="报错"><a href="#报错" class="headerlink" title="报错"></a>报错</h4><ol>
<li>安装插件后报错再安装报 dpkg 错误</li>
</ol>
<p>ssh 连接到设备 <code>ps -e | grep dpkg</code></p>
<p>kill dpkg端口号</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/04/%E9%80%86%E5%90%91-Theos/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/04/%E9%80%86%E5%90%91-Theos/" class="post-title-link" itemprop="url">逆向-Theos</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-07-04 17:45:49" itemprop="dateCreated datePublished" datetime="2022-07-04T17:45:49+08:00">2022-07-04</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-10-23 19:06:45" itemprop="dateModified" datetime="2022-10-23T19:06:45+08:00">2022-10-23</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/ludashi/p/5714095.html">逆向工程之Theos</a></p>
<p><a target="_blank" rel="noopener" href="https://theos.dev/docs/logos">Tweak Logos</a></p>
<p>Theos 一个跨平台的越狱开发工具包</p>
<p>Theos 相当于对 Cydia Substrate 的封装，因而能实现对 Object-C 运行时的 Hook，也能实现对 C 语言函数的 Hook</p>
<h4 id="Theos-安装"><a href="#Theos-安装" class="headerlink" title="Theos 安装"></a>Theos 安装</h4><h5 id="安装-ldid"><a href="#安装-ldid" class="headerlink" title="安装 ldid"></a>安装 ldid</h5><p>Theos 开发中，iOS 文件的签名由 ldid 工具来完成，ldid 取代了 Xcode 自带的 codesign</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew instll ldid</span><br></pre></td></tr></table></figure>

<p>或者下载 <a target="_blank" rel="noopener" href="http://joedj.net/ldid">http://joedj.net/ldid</a> 放到 /opt/theos/bin 目录下，添加执行权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod 777 &#x2F;opt&#x2F;theos&#x2F;bin&#x2F;ldid</span><br></pre></td></tr></table></figure>

<ul>
<li>安装 xz、lzma（没装）</li>
</ul>
<p>两种压缩模块，为了后面 <code>make package</code> 能顺利通过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ brew install xz</span><br><span class="line">$ sudo cpan IO::Compress::Lzma</span><br></pre></td></tr></table></figure>

<h5 id="安装-dpkg，dpkg-deb"><a href="#安装-dpkg，dpkg-deb" class="headerlink" title="安装 dpkg，dpkg-deb"></a>安装 dpkg，dpkg-deb</h5><p>可以使用 dpkg 制作 deb，Theos开发的插件都会以deb的格式进行发布</p>
<p>有了 dpkg-deb，Theos才能正确把工程打包成 deb 文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew install dpkg</span><br><span class="line">brew install dpkg-deb</span><br></pre></td></tr></table></figure>

<ul>
<li>添加环境变量</li>
</ul>
<p>.bash_profile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export THEOS&#x3D;&#x2F;opt&#x2F;theos</span><br><span class="line">export PATH&#x3D;$PATH:$THEOS&#x2F;bin</span><br></pre></td></tr></table></figure>

<h5 id="安装-theos"><a href="#安装-theos" class="headerlink" title="安装 theos"></a>安装 theos</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo git clone --recursive https:&#x2F;&#x2F;github.com&#x2F;theos&#x2F;theos.git $THEOS</span><br></pre></td></tr></table></figure>

<ul>
<li>设置 $THEOS 用户组权限</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo chown -R $(id -u):$(id -g) $THEOS</span><br></pre></td></tr></table></figure>

<p>最后 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ source ~&#x2F;.bash_profile</span><br></pre></td></tr></table></figure>

<h4 id="常用模块"><a href="#常用模块" class="headerlink" title="常用模块"></a>常用模块</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$THEOS&#x2F;bin&#x2F;nic.pl</span><br><span class="line">NIC 2.0 - New Instance Creator</span><br><span class="line">------------------------------</span><br><span class="line">  [1.] iphone&#x2F;activator_event</span><br><span class="line">  [2.] iphone&#x2F;application_modern</span><br><span class="line">  [3.] iphone&#x2F;application_swift</span><br><span class="line">  [4.] iphone&#x2F;flipswitch_switch</span><br><span class="line">  [5.] iphone&#x2F;framework</span><br><span class="line">  [6.] iphone&#x2F;library</span><br><span class="line">  [7.] iphone&#x2F;preference_bundle_modern</span><br><span class="line">  [8.] iphone&#x2F;tool</span><br><span class="line">  [9.] iphone&#x2F;tool_swift</span><br><span class="line">  [10.] iphone&#x2F;tweak</span><br><span class="line">  [11.] iphone&#x2F;xpc_service</span><br><span class="line">Choose a Template (required):</span><br></pre></td></tr></table></figure>

<p>tweak：插件模板</p>
<p>tool：命令行工具模板</p>
<p>application：系统级应用模板</p>
<p>xpc_service：XPC 服务模板</p>
<h4 id="Tweak插件开发"><a href="#Tweak插件开发" class="headerlink" title="Tweak插件开发"></a>Tweak插件开发</h4><p>iOS 越狱平台下的插件称为 tweak。实质就是 iOS 平台的动态库 dylib，利用 Cydia Substrate 提供的组件进行加载，完成特定功能</p>
<p>所有 Tweak 都保存在 /Library/MobileSubstrate/DynamicLibraries 目录，Tweak 后缀名为 .dylib</p>
<p>终端输入 nic.pl，工程模板选择 [10.] iphone/tweak，创建一个 tweak 工程</p>
<ul>
<li>配置参数</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Project Name (required): 项目名称</span><br><span class="line">Package Name [com.yourcompany.langjitweak]: 包名</span><br><span class="line">Author&#x2F;Maintainer Name 作者名字，默认当前登录用户名</span><br><span class="line">[iphone&#x2F;tweak] MobileSubstrate Bundle filter: 注入应用的BundleID</span><br><span class="line">[iphone&#x2F;tweak] List of applications to terminate upon installation (space-separated, &#39;-&#39; for none) [SpringBoard]: 安装成功后需结束的进程，默认SpringBoard，不需要结束任务进程输入 -</span><br></pre></td></tr></table></figure>

<p>为了方便修改，可以在生成的文件夹新建 Xcode 项目，将文件拖入 Xcode 项目编辑</p>
<ul>
<li>目录结构</li>
</ul>
<p>![图片 1](逆向-Theos/图片 1.png)</p>
<h5 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h5><p>指定工程用到源文件、框架、库等信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">#引入Makefile的公共文件</span><br><span class="line">include $(THEOS)&#x2F;makefiles&#x2F;common.mk  </span><br><span class="line">#指定处理器架构 多个架构空格分开 最新的A12处理器设备还需要arm64e</span><br><span class="line">ARCHS&#x3D;arm64 arm64e</span><br><span class="line"></span><br><span class="line">#指定目标规范 A12处理器设备指定SDK版本必须大于10.1</span><br><span class="line">#指定目标平台为iOS，编译器为clang，使用10.2版本SDK编译该tweak，编译后的程序只能在8.0及以上系统运行</span><br><span class="line"></span><br><span class="line">TARGET &#x3D; iphone:clang:10.2:8.0</span><br><span class="line">#可以省略编译类型 SDK设置为latest 指定Tweak支持的系统版本</span><br><span class="line">TARGET &#x3D; iphone:latest:8.0</span><br><span class="line"></span><br><span class="line">#指定的项目名称</span><br><span class="line">TWEAK_NAME &#x3D; iThunderHelper		</span><br><span class="line">iThunderHelper_CFLAGS &#x3D; -fobjc-arc</span><br><span class="line"></span><br><span class="line">#tweak包含的源文件(头文件除外)多个文件空格分开</span><br><span class="line">#如 iThunderHelper_FILES &#x3D; Tweak.xm ANYMethodLog.m PYG.m</span><br><span class="line">iThunderHelper_FILES &#x3D; Tweak.xm				</span><br><span class="line"></span><br><span class="line">#根据不同工程类型指定.mk文件，tweak工程是tweak.mk 还可以填入 application.mk及tool.mk</span><br><span class="line">include $(THEOS_MAKE_PATH)&#x2F;tweak.mk</span><br><span class="line"></span><br><span class="line">#导入Framework</span><br><span class="line">iThunderHelper_FRAMEWORKS &#x3D; UIKit</span><br><span class="line"></span><br><span class="line">#导入私有Framework</span><br><span class="line">iThunderHelper_PRIVATE_FRAMEWORKS &#x3D; ChatKit</span><br><span class="line"></span><br><span class="line">#链接动态库 libz.dylib和libsqlite.dylib</span><br><span class="line">iThunderHelper_LDFLAGS &#x3D; -lz -lsqlite</span><br><span class="line"></span><br><span class="line">iThunderHelper_LIBRARIES &#x3D; rocketbootstrap</span><br><span class="line"></span><br><span class="line">#这里做了端口映射 需要iproxy 2222 22</span><br><span class="line">THEOS_DEVICE_IP &#x3D; localhost</span><br><span class="line">THEOS_DEVICE_PORT &#x3D; 2222  </span><br><span class="line">或者</span><br><span class="line">THEOS_DEVICE_IP &#x3D; IP地址 </span><br><span class="line"></span><br><span class="line">#安装后执行的命令</span><br><span class="line">after-install::  </span><br><span class="line">	install.exec &quot;kill -9 MobileSMS&quot;</span><br></pre></td></tr></table></figure>

<h5 id="Tweak-xm"><a href="#Tweak-xm" class="headerlink" title="Tweak.xm"></a>Tweak.xm</h5><p> 生成的默认源文件，后缀 .xm 表示支持 Logos 和 C/C++语法，如果后缀为 .x ，说明源文件支持 Logos和C语法</p>
<h5 id="control"><a href="#control" class="headerlink" title="control"></a>control</h5><p>deb 包的必备文件，记录 deb 包管理系统所需的基本信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Package: com.ithunderhelper #deb包的唯一ID</span><br><span class="line">Name: ithunderhelper #描述tweak名字</span><br><span class="line"></span><br><span class="line">#deb包的依赖项，多个依赖逗号隔开，指定版本号则在后面用括号标注</span><br><span class="line"># Depends: mobilesubstrate, com.rpetrich.rocketbootstrap(&gt;&#x3D;1.0.2)</span><br><span class="line">Depends: mobilesubstrate </span><br><span class="line"></span><br><span class="line">Version: 0.0.1	#deb包当前版本</span><br><span class="line">Architecture: iphoneos-arm #描述deb包的架构，不可修改</span><br><span class="line">Description: An awesome MobileSubstrate tweak!  #对tweak的简要描述</span><br><span class="line">Maintainer: cao #deb包维护人员</span><br><span class="line">Author: cao  #描述tweak的开发者</span><br><span class="line">Section: Tweaks #deb包所属类别</span><br></pre></td></tr></table></figure>

<h5 id="iThunderHelper-plist"><a href="#iThunderHelper-plist" class="headerlink" title="iThunderHelper.plist"></a>iThunderHelper.plist</h5><p> tweak的作用对象</p>
<h5 id="编译打包安装"><a href="#编译打包安装" class="headerlink" title="编译打包安装"></a>编译打包安装</h5><ul>
<li>编译</li>
</ul>
<p>编译 make，从日志看到 Theos 完成了预处理、编译、链接、签名一系列动作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br></pre></td></tr></table></figure>

<p>编译生成 dylib 文件保存在 .theos/obj/debug/ 文件夹下</p>
<p>arm64和armv7分别有相应架构的 dylib 文件，外层的dylib 则是所有架构合并后的</p>
<ul>
<li>指定编译模式</li>
</ul>
<p>tweak 默认编译模式是 debug，如果想改为 release，只需要指定 DEBUG=0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ DEBUG&#x3D;0 make</span><br></pre></td></tr></table></figure>

<ul>
<li>打包</li>
</ul>
<p>make package 会先执行 make 命令，然后执行 dpkg-deb 命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make package</span><br></pre></td></tr></table></figure>

<p>在 ./packages 目录生成一个 deb 包</p>
<ul>
<li>安装</li>
</ul>
<p>图形安装：</p>
<p>可以把 deb 通过爱思助手或者 scp 拷贝到设备指定目录，iFile 找到 deb 包，进入文件详情，点击安装</p>
<p>命令行安装：</p>
<p>scp 拷贝到设备，再利用 dpkg 命令安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ dpkg -i xxx.deb</span><br></pre></td></tr></table></figure>

<p>通过Theos安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make package install</span><br></pre></td></tr></table></figure>

<h4 id="Logos语法"><a href="#Logos语法" class="headerlink" title="Logos语法"></a>Logos语法</h4><h5 id="hook"><a href="#hook" class="headerlink" title="%hook"></a>%hook</h5><p>指定需要hook的Class 以%end结尾</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%hook MainViewController</span><br><span class="line"><span class="comment">//hook的方法</span></span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<h5 id="log"><a href="#log" class="headerlink" title="%log"></a>%log</h5><p>打印类名、函数、参数等信息</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%log((<span class="built_in">NSString</span> *)<span class="string">@&quot;tutuTest&quot;</span>, (<span class="built_in">NSString</span> *)<span class="string">@&quot;Debug&quot;</span>);</span><br></pre></td></tr></table></figure>

<h5 id="orig"><a href="#orig" class="headerlink" title="%orig"></a>%orig</h5><p>执行原始代码</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//可以有返回值 </span></span><br><span class="line"><span class="keyword">id</span> value = %orig;</span><br><span class="line"><span class="comment">//调用原来方法 </span></span><br><span class="line"><span class="keyword">id</span> value = %orig(arg1);</span><br><span class="line"></span><br><span class="line"><span class="comment">//%orig还可以更改原始函数的参数  %orig(参数)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//将arg的参数修改为change arg2</span></span><br><span class="line">%orig(<span class="string">@&quot;change arg2&quot;</span>, arg2); </span><br></pre></td></tr></table></figure>

<h5 id="group"><a href="#group" class="headerlink" title="%group"></a>%group</h5><p>将hook分组，便于代码管理及按条件初始化，以%end结尾</p>
<p>一个 %group 可以包含多个%hook，不属于某个自定义group的%hook会被归类到%group _ungrouped中</p>
<p>如果定义了group 那么一定要写%init(group)</p>
<p>%init初始化某个%group 必须在%hook或%ctor内调用</p>
<p>调用了%init，%group才能起作用</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">%group group1</span><br><span class="line">%hook ViewController</span><br><span class="line">-(<span class="keyword">void</span>)loginBtnCloick:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;111&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">%end</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%group group2</span><br><span class="line">%hook ViewController</span><br><span class="line">-(<span class="keyword">void</span>)loginBtnCloick:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;222&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">%end</span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<p>group需要初始化</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">%ctor &#123;</span><br><span class="line"> <span class="built_in">NSString</span> *v = [[<span class="built_in">UIDevice</span> currentDevice] systemVersion];</span><br><span class="line"> <span class="keyword">if</span>(v.doubleValue &gt; <span class="number">11.0</span>) &#123;</span><br><span class="line">    %init(group1)；</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    %init(group2)；</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%hook TargetClass</span><br><span class="line">- (<span class="keyword">void</span>)targetMethod &#123;</span><br><span class="line">  <span class="built_in">NSString</span> *v = [[<span class="built_in">UIDevice</span> currentDevice] systemVersion];</span><br><span class="line"> <span class="keyword">if</span>(v.doubleValue &gt; <span class="number">11.0</span>) &#123;</span><br><span class="line">    %init(group1)；</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    %init(group2)；</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<h5 id="ctor"><a href="#ctor" class="headerlink" title="%ctor"></a>%ctor</h5><p>完成初始化工作 没定义会隐式生成 构造函数，构造函数</p>
<p>一般可以用来初始化%group 不需要%end结尾</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">%hook SpringBoard</span><br><span class="line"><span class="comment">//hook方法</span></span><br><span class="line">%end</span><br><span class="line">%ctor &#123;</span><br><span class="line">    %init(_ungrouped); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="dtor"><a href="#dtor" class="headerlink" title="%dtor"></a>%dtor</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%dtor &#123;</span><br><span class="line">    <span class="comment">//析构</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="new"><a href="#new" class="headerlink" title="%new"></a>%new</h5><p>给现有class添加新函数</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">%hook XLMemberManager</span><br><span class="line"><span class="comment">//hook方法</span></span><br><span class="line"><span class="comment">//%new 不用%end  写在%hook类内部</span></span><br><span class="line">%new</span><br><span class="line">- (<span class="keyword">void</span>)newmethod &#123;</span><br><span class="line">&#125;</span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<p>添加了新方法，使用 [self newmethod] 调用会报错。</p>
<p>只需要加个定义，骗过编译器</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">XLMemberManager</span></span></span><br><span class="line">- (<span class="keyword">void</span>)newmethod;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h5 id="c"><a href="#c" class="headerlink" title="%c"></a>%c</h5><p>动态获取一个类的定义 相当于objc_getClass 或 NSClassFroming</p>
<p>获取某个类 %c(ViewController)</p>
<p>然后可以调用类方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">XLMemberConfigure</span></span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line">...</span><br><span class="line">XLMemberConfigure *configure = [[%c(XLMemberConfigure) alloc] init];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;memberConfigure=%@&quot;</span>, configure);</span><br></pre></td></tr></table></figure>

<h5 id="property"><a href="#property" class="headerlink" title="%property"></a>%property</h5><p>添加属性</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%subclass MyObject: <span class="built_in">NSObject</span></span><br><span class="line">%property (<span class="keyword">nonatomic</span>, <span class="keyword">retain</span>) <span class="built_in">NSString</span> *someValue;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h5 id="subclass"><a href="#subclass" class="headerlink" title="%subclass"></a>%subclass</h5><p>运行时创建子类</p>
<p>父类中不存在的方法用%new说明符，要实例化新类的一个对象用%c运算符</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">%subclass MyObject : <span class="built_in">NSObject</span></span><br><span class="line">- (<span class="keyword">id</span>)init &#123;</span><br><span class="line">	<span class="keyword">self</span> = %orig;</span><br><span class="line">	[<span class="keyword">self</span> setSomeValue:<span class="string">@&quot;value&quot;</span>];</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//the following two new methods act as `@property (nonatomic, retain) id someValue;`</span></span><br><span class="line">%new</span><br><span class="line">- (<span class="keyword">id</span>)someValue &#123;</span><br><span class="line">	<span class="keyword">return</span> objc_getAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(someValue));</span><br><span class="line">&#125;</span><br><span class="line">%new</span><br><span class="line">- (<span class="keyword">void</span>)setSomeValue:(<span class="keyword">id</span>)value &#123;</span><br><span class="line">	objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(someValue), value, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">&#125;</span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<h5 id="hookf"><a href="#hookf" class="headerlink" title="%hookf"></a>%hookf</h5><p>给指定函数生成Hook，是对 MSHookFunction() 函数的包装格式</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//rtype：返回值</span></span><br><span class="line"><span class="comment">//symbolName：原函数地址</span></span><br><span class="line">%hookf(rtype, symbolName, args...)&#123;...&#125;</span><br></pre></td></tr></table></figure>

<p>symbolName 可以传入函数地址或者函数符号</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//传入地址</span></span><br><span class="line">FILE *fopen(<span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">const</span> <span class="keyword">char</span> *mode);</span><br><span class="line">%hookf(File *, fopen, <span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">const</span> <span class="keyword">char</span> *mode) &#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;fopen hooked&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(path[<span class="number">0</span>] !=<span class="string">&#x27;/&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> %orig;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果将 symbolName 作为字符串传入，那么函数将被动态查找</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FILE *fopen(<span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">const</span> <span class="keyword">char</span> *mode);</span><br><span class="line">%hookf(File *, <span class="string">&quot;_open&quot;</span>, <span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">const</span> <span class="keyword">char</span> *mode) &#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;fopen hooked&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(path[<span class="number">0</span>] !=<span class="string">&#x27;/&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> %orig;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Logos-Tip"><a href="#Logos-Tip" class="headerlink" title="Logos Tip"></a>Logos Tip</h4><h5 id="获取类成员变量"><a href="#获取类成员变量" class="headerlink" title="获取类成员变量"></a>获取类成员变量</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用substitute提供的MSHookIvar</span></span><br><span class="line"><span class="built_in">UIView</span> *_anyView = MSHookIvar&lt;<span class="built_in">UIView</span>*&gt;(<span class="keyword">self</span>,<span class="string">&quot;_view&quot;</span>);</span><br><span class="line">_anyView.backgroundColor = [<span class="built_in">UIColor</span> redColor];</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用原生valueForKey</span></span><br><span class="line">XLMemberConfigure *config = [<span class="keyword">self</span> valueForKey:<span class="string">@&quot;_config&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用ZKSwizzle提供的ZKHookIvar</span></span><br><span class="line"><span class="meta">#import ZKSwizzle<span class="meta-string">&quot;&quot;</span></span></span><br><span class="line"><span class="built_in">NSString</span> *deviceMode = ZKHookIvar(config, <span class="built_in">NSString</span> *, <span class="string">&quot;_deviceModel&quot;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>打印参数Class</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">void</span>)showLuckyMoneyWithPickingStatus:(<span class="built_in">NSObject</span> *)arg1 withController:(<span class="keyword">id</span>)arg2 delegate:(<span class="keyword">id</span>)arg3</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">NSLog</span>(<span class="string">@&quot;status = %@, className = %@&quot;</span>,arg1,<span class="built_in">NSStringFromClass</span>(arg1.class));</span><br><span class="line">	%log; %orig;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>方法声明</li>
</ul>
<p>需要在注入的类里面调用某个方法 添加方法的声明就可以了 </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">P1HomeNearbyViewController</span> : <span class="title">UIViewController</span></span></span><br><span class="line">- (<span class="keyword">void</span>)takeAction:(<span class="keyword">id</span>)arg1 withEvent:(<span class="keyword">id</span>)arg2;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>也可以不用写父类 </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">P1HomeNearbyViewController</span></span></span><br><span class="line">- (<span class="keyword">void</span>)takeAction:(<span class="keyword">id</span>)arg1 withEvent:(<span class="keyword">id</span>)arg2;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>再 hook P1HomeNearbyViewController的 takeAction 方法里就可以直接用self 否则会self报错</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)takeAction:(<span class="keyword">id</span>)arg1 withEvent:(<span class="keyword">id</span>)arg2 &#123;</span><br><span class="line">  dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">1.0</span> * <span class="built_in">NSEC_PER_SEC</span>)),      dispatch_get_main_queue(), ^&#123;</span><br><span class="line">      [<span class="keyword">self</span> takeAction:arg1 withEvent:arg2];</span><br><span class="line">  &#125;);</span><br><span class="line">  %log;</span><br><span class="line">  %or&#125;ig;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>类声明</li>
</ul>
<p>为了通过编译，有些类需要声明，可以创建 .h 头文件，内容都是从 class-dump 出来的文件拷贝</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">PSSpecifier</span>:<span class="title">NSObject</span> </span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">retain</span>) <span class="keyword">id</span> target;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">PSSpecifier</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>Tweak.xm </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&quot;PSSpecifier.h&quot;</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>修改返回值</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//能否预览 直接1可以预览</span></span><br><span class="line">- (_Bool )canPreview &#123;</span><br><span class="line">  %log;</span><br><span class="line">  _Bool r = %orig;</span><br><span class="line">  r = <span class="number">1</span>;<span class="comment">//返回1</span></span><br><span class="line">  HBLogDebug(<span class="string">@&quot; = %d&quot;</span>, r);</span><br><span class="line">  <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>注释方法</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)timerAction:(<span class="keyword">id</span>)arg1 &#123;</span><br><span class="line">  %log;</span><br><span class="line">  <span class="comment">//%orig;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>阻止alertcontroller弹窗</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加方法声明 重写presentViewController方法 阻止alertController显示</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">LivePlayBackVC</span> : <span class="title">UIViewController</span></span></span><br><span class="line">- (<span class="keyword">void</span>)presentViewController:(<span class="built_in">UIViewController</span> *)present animated:(<span class="built_in">BOOL</span>)animated completion:(<span class="keyword">void</span> (^ _Nullable)(<span class="keyword">void</span>))completion;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line">  </span><br><span class="line">%hook LivePlayBackVC</span><br><span class="line">- (<span class="keyword">void</span>)presentViewController:(<span class="built_in">UIViewController</span> *)present animated:(<span class="built_in">BOOL</span>)animated completion:(<span class="keyword">void</span> (^ _Nullable)(<span class="keyword">void</span>))completion&#123;</span><br><span class="line">    HBLogDebug(<span class="string">@&quot;presentViewController&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<ul>
<li>控制器跳转 </li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TBBuyStandardViewController *vc = [[%c(TBBuyStandardViewController) alloc] initWithNavigatorURL:arg1 query: arg2];</span><br></pre></td></tr></table></figure>

<h4 id="命令行工具开发"><a href="#命令行工具开发" class="headerlink" title="命令行工具开发"></a>命令行工具开发</h4><p>Theos 提供的 tool 模板用来编写命令行工具，Cydia Substrate 自带的 cynject 工具就是例子</p>
<p>编写小工具，根据输入进程名查找 PID （等同于ps -ax | grep xxx）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$THEOS&#x2F;bin&#x2F;nic.pl</span><br><span class="line">NIC 2.0 - New Instance Creator</span><br><span class="line">------------------------------</span><br><span class="line">[8.] iphone&#x2F;tool</span><br><span class="line">Choose a Template (required): 8</span><br><span class="line">Project Name (required): FindProcess</span><br><span class="line">Package Name [com.yourcompany.findprocess]:com.FindProcess</span><br><span class="line">Author&#x2F;Maintainer Name [midland]:</span><br><span class="line">Instantiating iphone&#x2F;tool in findprocess&#x2F;...</span><br><span class="line">Done.</span><br></pre></td></tr></table></figure>

<p>创建 tool 工程，接下来步骤和 tweak 类似，打开 main.mm 修改代码…</p>
<p>由于使用了纯 C 代码，输入 make 命令直接编译会出现错误，需将 main.mm 修改为 main.c</p>
<p>同时修改 Makefile 中的 findprocess_FILES 一行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">findprocess_FILES &#x3D; main.c</span><br></pre></td></tr></table></figure>

<p>DEBUG=0 make package install 将命令行工具安装到设备</p>
<p>如果提示 THEOS_DEVICE_IP 问题，添加环境变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export THEOS_DEVICE_IP&#x3D;192.168.0.101</span><br></pre></td></tr></table></figure>



<ul>
<li>兼容 iOS11-iOS13</li>
</ul>
<p>编译好的包在 iOS11-iOS13 可能出现 <code>killed:9</code> 错误</p>
<p>新建 ent.xml</p>
<img src="逆向-Theos/图片 2.png" alt="图片 2" style="zoom:80%;" />

<p>修改 Makefile，配置 CODESIGN_FLAGS 参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">findprocess_CODESIGN_FLAGS &#x3D; -S.&#x2F;ent.xml</span><br></pre></td></tr></table></figure>

<p>修改安装路径（不是必须的）命令行工具默认安装到 /usr/bin 目录，该路径可以修改配置 INSTALL_PATH 参数即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">findprocess_INSERT_PATH&#x3D; &#x2F;bin</span><br></pre></td></tr></table></figure>

<p>重新编译安装后 Cydia 里路径被改为 /bin 了</p>
<img src="逆向-Theos/图片 3.png" alt="图片 3" style="zoom:50%;" />

<p>测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~root# findprocess WeChat</span><br></pre></td></tr></table></figure>

<h4 id="系统应用开发"><a href="#系统应用开发" class="headerlink" title="系统应用开发"></a>系统应用开发</h4><p>Theos 提供的 application 模板用来开发系统级应用比如 Filza，权限更高无法通过常规方式删除</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$THEOS&#x2F;bin&#x2F;nic.pl</span><br><span class="line">NIC 2.0 - New Instance Creator</span><br><span class="line">------------------------------</span><br><span class="line">[2.] iphone&#x2F;application_modern</span><br><span class="line">Choose a Template (required): 2</span><br><span class="line">Project Name (required): bookApp</span><br><span class="line">Package Name [com.yourcompany.bookapp]: com.bookApp</span><br><span class="line">Author&#x2F;Maintainer Name [midland]:</span><br><span class="line">[iphone&#x2F;application_modern] Class name prefix (two or more characters) [XX]:CD</span><br></pre></td></tr></table></figure>

<p>生成文件</p>
<img src="逆向-Theos/图片 4.png" alt="图片 4" style="zoom:90%;" />

<p>修改文件 CDRootViewController.m 内容</p>
<img src="逆向-Theos/图片 5.png" alt="图片 5" style="zoom:80%;" />

<p>代码在视图中间添加 Test 按钮，单机按钮，获取进程权限，然后打开keychain数据库，由于使用了 sqlite3，所以需要修改 Makefile，增加 xxx_LDFLAGS参数将其链接进来</p>
<img src="逆向-Theos/图片 6.png" alt="图片 6" style="zoom:70%;" />

<p>after-install 是 deb 文件安装后执行的命令。第二条命令是结束进程</p>
<p>DEBUG=0 make package install 编译安装到设备</p>
<p>运行日志 getuid 和 geteuid 都返回了501（mobile权限）代码执行失败</p>
<ul>
<li>以root权限运行（iOS11以下）</li>
</ul>
<p>Linux下可以使用 setuid(0)及setgid(0)提升权限，打开 main.m 修改如下</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[]) &#123;</span><br><span class="line">	<span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        setuid(<span class="number">0</span>);</span><br><span class="line">        setgid(<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, <span class="built_in">NSStringFromClass</span>(CDAppDelegate.class));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译安装后闪退了，这是因为backboardd以mobile权限运行不能加载要求root权限的程序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~root# ps aux | grep backboardd</span><br><span class="line">mobile 2438 0.6 1.0 .....</span><br></pre></td></tr></table></figure>

<p>换句话说，崩溃是好事，说明提升成功了，对 iOS11 以下的系统处理方法比较复杂</p>
<p>。。。</p>
<ul>
<li>以root权限运行（iOS11、iOS12）</li>
<li>以root权限运行（iOS13）</li>
</ul>
<h4 id="守护进程开发"><a href="#守护进程开发" class="headerlink" title="守护进程开发"></a>守护进程开发</h4><p>守护进程是一个运行在系统后台、不受前台用户交互影响的进程，通常，守护进程以字母 d 结尾</p>
<p>其实就是一个命令行程序和一个 plist 文件构成</p>
<p>syslogd 是处理系统日志的后台，afc2d是文件服务的后台进程等</p>
<p>编写一个简单 pygioserbookd 守护进程，启动时打印一行日志，并往 tmp 目录写入 pp.log 文件后常驻后台</p>
<p>选择 tool 模板创建工程</p>
<p>修改 main.mm</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp) &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *str = <span class="string">@&quot;[PYGiOSBook] 守护进程启动成功&quot;</span>;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, str);</span><br><span class="line">    [str writeToFile:<span class="string">@&quot;/tmp/pp.log&quot;</span> atomically:<span class="literal">YES</span> encoding:<span class="built_in">NSUTF8StringEncoding</span> error:<span class="literal">nil</span>];</span><br><span class="line">    <span class="comment">//保持运行</span></span><br><span class="line">    <span class="built_in">CFRunLoopRun</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>安装到设备，测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root# pygioserbookd</span><br></pre></td></tr></table></figure>

<h5 id="守护进程配置"><a href="#守护进程配置" class="headerlink" title="守护进程配置"></a>守护进程配置</h5><p>新建 com.pygioserbookd.plist </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE plist PUBLIC &quot;-&#x2F;&#x2F;Apple&#x2F;&#x2F;DTD PLIST 1.0&#x2F;&#x2F;EN&quot; &quot;http:&#x2F;&#x2F;www.apple.com&#x2F;DTDs&#x2F;PropertyList-1.0.dtd&quot;&gt;</span><br><span class="line">&lt;plist version&#x3D;&quot;1.0&quot;&gt;</span><br><span class="line">&lt;dict&gt;</span><br><span class="line">	&lt;key&gt;RunAtLoad&lt;&#x2F;key&gt;</span><br><span class="line">	&lt;string&gt;true&lt;&#x2F;string&gt;</span><br><span class="line">	&lt;key&gt;Program&lt;&#x2F;key&gt;</span><br><span class="line">	&lt;string&gt;&#x2F;usr&#x2F;bin&#x2F;pygioserbookd&lt;&#x2F;string&gt;</span><br><span class="line">	&lt;key&gt;Label&lt;&#x2F;key&gt;</span><br><span class="line">	&lt;string&gt;com.pygioserbookd&lt;&#x2F;string&gt;</span><br><span class="line">&lt;&#x2F;dict&gt;</span><br><span class="line">&lt;&#x2F;plist&gt;</span><br></pre></td></tr></table></figure>

<p>Label：守护进程唯一标识</p>
<p>Program：对应的可执行文件</p>
<p>RunAtLoad：加载的同时启动</p>
<p>如果后台进程需要其它的参数，只需要在文件中增加类似下面的键值对即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;key&gt;ProgramArguments&lt;&#x2F;key&gt;</span><br><span class="line">&lt;array&gt;</span><br><span class="line">	&lt;string&gt;-m&lt;&#x2F;string&gt;</span><br><span class="line">	&lt;string&gt;-i&lt;&#x2F;string&gt;</span><br><span class="line">	&lt;string&gt;其它参数&lt;&#x2F;string&gt;</span><br><span class="line">&lt;&#x2F;array&gt;</span><br></pre></td></tr></table></figure>

<p>iOS 的根进程是 launchd，它会在开机时检查 /System/Library/LaunchDaemons 和 /Library/LaunchDaemons 目录下所有符合条件的 plist 文件。</p>
<p>所以把 com.pygioserbookd.plist 文件放到上面任意目录下，输入 reboot 重启设备（又要重新越狱），查看发现 pygioserbookd 已随系统启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root# ps aux | grep pygioserbookd</span><br></pre></td></tr></table></figure>

<p>也可以不重启，iOS 提供了 launchctl 命令行工具。用于显示、加载、卸载、启动和关闭守护进程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;获取信息</span><br><span class="line">&#x2F;&#x2F;第一列进程ID，如果显示 - 说明已加载，但没运行</span><br><span class="line">&#x2F;&#x2F;第二列上次退出的状态码，0成功，正数错误退出，负数收到信号后退出</span><br><span class="line">&#x2F;&#x2F;第三列守护进程唯一标识</span><br><span class="line">root# launchctl list  </span><br><span class="line">-   78 com.apple.networkd_priv</span><br><span class="line">258 0  com.apple.apsd</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;加载&#x2F;卸载（load&#x2F;unload）</span><br><span class="line">root# launchctl load &#x2F;Library&#x2F;LaunchDaemons&#x2F;com.pygioserbookd.plist</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;启动&#x2F;停止（start&#x2F;stop）</span><br><span class="line">root# launchctl start com.pygioserbookd</span><br></pre></td></tr></table></figure>

<h5 id="自动部署"><a href="#自动部署" class="headerlink" title="自动部署"></a>自动部署</h5><p>编写好守护进程，处理那些 plist 文件需要人工干预来处理，这里利用 Theos 的 layout 功能来完成自动部署</p>
<p>工程目录下创建 layout 文件夹，theos 在打包时会将其中的内容按照路径添加到 deb 包中</p>
<p>1、先将 com.pygioserbookd.plist 文件放到 layout/Library/LaunchDaemons 文件夹内</p>
<p>2、新建 DEBIAN 文件夹并将 control 移进来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir .&#x2F;layout&#x2F;DEBIAN</span><br><span class="line">$ mv control .&#x2F;layout&#x2F;DEBIAN</span><br></pre></td></tr></table></figure>

<p>3、在 DEBIAN 文件夹中分别新建 postinst、preinst、prerm 文件，各自内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#postinst deb包安装完成后所需的配置工作</span><br><span class="line">#!bin&#x2F;sh</span><br><span class="line">launchctl load &#x2F;Library&#x2F;LaunchDaemons&#x2F;com.pygioserbookd.plist</span><br><span class="line"></span><br><span class="line">#preinst 解压前执行的脚本</span><br><span class="line">#!bin&#x2F;sh</span><br><span class="line">launchctl unload &#x2F;Library&#x2F;LaunchDaemons&#x2F;com.pygioserbookd.plist 2&gt;&amp;1 &gt; &#x2F;dev&#x2F;null</span><br><span class="line"></span><br><span class="line">#prerm 卸载deb包前执行</span><br><span class="line">#!bin&#x2F;sh</span><br><span class="line">launchctl unload &#x2F;Library&#x2F;LaunchDaemons&#x2F;com.pygioserbookd.plist</span><br></pre></td></tr></table></figure>

<p>这几个脚本分别用于 deb 包安装前后的一些处理，其实是吧人工执行 launchctl 命令的过程用脚本代替</p>
<p>make package 打包后，所有文件已经按照 layout 的结构打包进去了。</p>
<p>利用 layout 能方便地将所有需要集成的文件统一进行处理</p>
<p>make package install 安装完后通过 launchctl list 查看 pygioserbookd 是还未启动的</p>
<ul>
<li>报错问题</li>
</ul>
<p>make package 之后提示 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ERROR: maintainer script &#39;preinst&#39; has bad permissions 644 (must be &gt;&#x3D;0555 and &lt;&#x3D;0775)</span><br><span class="line"></span><br><span class="line">#添加权限</span><br><span class="line">chmod 755 preinst</span><br><span class="line">chmod 755 postinst</span><br><span class="line">chmod 755 prerm</span><br></pre></td></tr></table></figure>





<h4 id="增加系统设置项"><a href="#增加系统设置项" class="headerlink" title="增加系统设置项"></a>增加系统设置项</h4><p>PreferenceLoader 是一个开源的基础依赖包，越狱插件的系统设置菜单就是由它提供，Cydia 搜索安装 PreferenceLoader</p>
<p>进入系统设置时 PreferenceLoader 会从 /Library/PreferenceLoader/Preferences/ 目录下解析符合规则的 plist 文件，并生成响应的控件动态添加到系统设置</p>
<p><a target="_blank" rel="noopener" href="http://iphonedevwiki.net/index.php/PreferenceBundles">http://iphonedevwiki.net/index.php/PreferenceBundles</a></p>
<p><a target="_blank" rel="noopener" href="https://iphonedev.wiki/index.php/Preferences_specifier_plist">https://iphonedev.wiki/index.php/Preferences_specifier_plist</a></p>
<p>theos 选择 iphone/preference_bundle_modern 模板</p>
<blockquote>
<p>需要引用私有库 Preferences，编译提示找不到路径</p>
</blockquote>
<h4 id="进程间通信"><a href="#进程间通信" class="headerlink" title="进程间通信"></a>进程间通信</h4><p>进程间通信（IPC）就是在不同进程之间传播或交换信息，正向开发中只能使用苹果公司提供 URLScheme，应用之间互相调用并且传送简单字符的一种机制</p>
<h5 id="Notification通信"><a href="#Notification通信" class="headerlink" title="Notification通信"></a>Notification通信</h5><p>CFNotificationCenterGetDarwinNotifyCenter() 有一个 userinfo 参数，但实际上无法传递，总是为 nil，不适合传递参数</p>
<h5 id="XPC通信"><a href="#XPC通信" class="headerlink" title="XPC通信"></a>XPC通信</h5><p>仅限于系统级别应用，如果用普通应用是不可达的</p>
<h5 id="RocketBootstrap通信"><a href="#RocketBootstrap通信" class="headerlink" title="RocketBootstrap通信"></a>RocketBootstrap通信</h5><p><a target="_blank" rel="noopener" href="https://iphonedev.wiki/index.php/RocketBootstrap#CPDistributedMessagingCenter_Example">RocketBootstrap</a></p>
<p>私有框架 APPSupport 中存在一个 CPDistributedMessagingCenter（分布式消息传递中心）使用简单的消息和字典来提供不同进程之间的通信</p>
<p>RocketBootstrap 就是在其上进行封装，越过沙盒限制，给越狱环境提供稳定的进程通信服务，cydia 中搜索安装即可</p>
<p>RocketBootstrap 要求在权限比较高的进程中启动一个服务，再通过发送通知的方式越过沙盒，因此创建一个 tweak 并注入 SpringBoard进程</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;rocketbootstrap/rocketbootstrap.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;AppSupport/CPDistributedMessagingCenter.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">%group HookSpringBoard</span><br><span class="line"></span><br><span class="line">%hook SpringBoard</span><br><span class="line">- (<span class="keyword">void</span>)applicationDidFinishLaunching:(<span class="keyword">id</span>)application &#123;</span><br><span class="line">    %orig;</span><br><span class="line">    CPDistributedMessagingCenter *c = [%c(CPDistributedMessagingCenter) centerNamed:<span class="string">@&quot;MyCPCenter&quot;</span>];</span><br><span class="line">    rocketbootstrap_distributedmessagingcenter_apply(c);</span><br><span class="line">    [c runServerOnCurrentThread];</span><br><span class="line">    [c registerForMessageName:<span class="string">@&quot;MyCPCenterNoti&quot;</span> target: <span class="keyword">self</span> selector:<span class="keyword">@selector</span>(handleMessage:withUserInfo:)];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;注册监听&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//收到沙盒内发的消息时弹出对话框</span></span><br><span class="line">%new</span><br><span class="line">- (<span class="keyword">void</span>)handleMessage:(<span class="built_in">NSString</span> *)name withUserInfo:(<span class="built_in">NSDictionary</span> *)userInfo &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;handleMessage withUserInfo&quot;</span>);</span><br><span class="line">    <span class="built_in">NSString</span> *action = userInfo[<span class="string">@&quot;action&quot;</span>];</span><br><span class="line">    <span class="keyword">if</span> ([action isEqualToString:<span class="string">@&quot;AlertView&quot;</span>]) &#123;</span><br><span class="line">        <span class="built_in">NSString</span> *nsInfo = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;book=%@, author=%@&quot;</span>, userInfo[<span class="string">@&quot;book&quot;</span>], userInfo[<span class="string">@&quot;author&quot;</span>]];</span><br><span class="line">        <span class="built_in">UIAlertView</span> *alert = [[<span class="built_in">UIAlertView</span> alloc] initWithTitle:<span class="string">@&quot;来自应用沙盒的消息&quot;</span> message:nsInfo delegate:<span class="literal">nil</span> cancelButtonTitle:<span class="string">@&quot;确定&quot;</span> otherButtonTitles: <span class="literal">nil</span>, <span class="literal">nil</span>];</span><br><span class="line">        [alert show];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%ctor &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;__[PYGiOSReBook] inject success__&quot;</span>);</span><br><span class="line">    <span class="built_in">NSString</span> *bundleIdentifier = [[<span class="built_in">NSBundle</span> mainBundle] bundleIdentifier];</span><br><span class="line">    <span class="keyword">if</span> ([bundleIdentifier isEqualToString:<span class="string">@&quot;com.apple.springboard&quot;</span>]) &#123;</span><br><span class="line">        %init(HookSpringBoard);</span><br><span class="line">    &#125;</span><br><span class="line">    %init;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改 Makefile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">include $(THEOS)&#x2F;makefiles&#x2F;common.mk</span><br><span class="line"></span><br><span class="line">TWEAK_NAME &#x3D; RocketBootstrapTest</span><br><span class="line"></span><br><span class="line">RocketBootstrapTest_FILES &#x3D; Tweak.xm</span><br><span class="line">RocketBootstrapTest_CFLAGS &#x3D; -fobjc-arc</span><br><span class="line"></span><br><span class="line">include $(THEOS_MAKE_PATH)&#x2F;tweak.mk</span><br><span class="line"></span><br><span class="line">ARCHS &#x3D; arm64</span><br><span class="line">RocketBootstrapTest_LIBRARIES &#x3D; rocketbootstrap</span><br><span class="line">RocketBootstrapTest_PRIVATE_FRAMEWORKS &#x3D; AppSupport</span><br></pre></td></tr></table></figure>

<p>还需要添加 AppSupport 框架，可以在 <a target="_blank" rel="noopener" href="https://github.com/theos/sdks">https://github.com/theos/sdks</a>  找到SDK 版本，选择和自己 SDK 接近的版本就可以了</p>
<p>下载的 SDK 两种使用方法：</p>
<p>1、如选择 iPhoneOS14.5，将整个 iPhoneOS14.5.sdk 文件夹复制到 $THEOS/sdks 目录下</p>
<p>修改 Makefile 的 TARGET 字段，强制指定 SDK 为下载版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TARGET &#x3D; iphone:14.5:8.0</span><br></pre></td></tr></table></figure>

<p>2、将 iPhoneOS14.5.sdk/System/Library/PrivateFrameworks 目录下找到所需要的私有库（也可以全部选择）复制到目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;Applications&#x2F;Xcode.app&#x2F;Contents&#x2F;Developer&#x2F;Platforms&#x2F;iPhoneOS.platform&#x2F;Developer&#x2F;SDKs&#x2F;iPhoneOS.sdk&#x2F;System&#x2F;Library&#x2F;PrivateFr-ameworks</span><br><span class="line">（书上写的是PrivateFr-ameworks 不知道是不是写错了是 PrivateFrameworks）</span><br></pre></td></tr></table></figure>

<blockquote>
<p>两种方式都没成功，make 编译找不到库 ld: framework not found AppSupport</p>
</blockquote>
<ul>
<li>发送消息</li>
</ul>
<p>Xcode 新建项目，</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;rocketbootstrap/rocketbootstrap.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;AppSupport/CPDistributedMessagingCenter.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSMutableDictionary</span> *userInfo = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">userInfo[<span class="string">@&quot;action&quot;</span>] = <span class="string">@&quot;AlertView&quot;</span>;</span><br><span class="line">userInfo[<span class="string">@&quot;book&quot;</span>] = <span class="string">@&quot;book1&quot;</span>;</span><br><span class="line">userInfo[<span class="string">@&quot;author&quot;</span>] = <span class="string">@&quot;author1&quot;</span>;</span><br><span class="line">CPDistributedMessagingCenter *c = [CPDistributedMessagingCenter centerNamed:<span class="string">@&quot;MyCPCenter&quot;</span>];</span><br><span class="line">rocketbootstrap_distributedmessagingcenter_apply(c);</span><br><span class="line">[c sendMessageName:<span class="string">@&quot;MyCPCenterNoti&quot;</span> userInfo:userInfo];</span><br></pre></td></tr></table></figure>

<p>还要配置头文件路径。Build Setting - Header Search Paths 添加 /opt/theos/vendor/include</p>
<p>接着将 /opt/theos/vendor/lib/librocketbootstrap.tbd 动态库添加到项目</p>
<blockquote>
<p>#import &lt;AppSupport/CPDistributedMessagingCenter.h&gt; 找不到文件，只能把 AppSupport.framework 拖入项目，新建了两个项目一个注册监听，一个发送消息，测试结果两个app间没收到消息，有空再试</p>
</blockquote>
<h4 id="deb重打包"><a href="#deb重打包" class="headerlink" title="deb重打包"></a>deb重打包</h4><p>有时候需要对别人 deb 包进行修改破解限制，就需要 deb 重打包</p>
<p>新建必要目录，存放解包后的文件及打包后的文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir extract</span><br><span class="line">$ mkdir extract&#x2F;DEBIAN</span><br><span class="line">$ mkdir build</span><br></pre></td></tr></table></figure>

<h5 id="安装-dpkg"><a href="#安装-dpkg" class="headerlink" title="安装 dpkg"></a>安装 dpkg</h5><p>安装 <a target="_blank" rel="noopener" href="https://www.macports.org/install.php">MacPorts</a> 软件包管理软件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo port install dpkg</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew install dpkg</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ dpkg-deb -c deb文件 &#x2F;&#x2F;显示文件列表</span><br><span class="line">$ dpkg-deb -X deb文件 输出路径 &#x2F;&#x2F;解压获取到Library中文件，里面有dylib</span><br><span class="line">$ dpkg-deb -e deb文件 输出路径 &#x2F;&#x2F;解压获取到Control文件</span><br><span class="line">$ dpkg-deb -R deb文件 输出路径 &#x2F;&#x2F;获取到 dylib和control文件</span><br><span class="line">$ dpkg-deb -b 通过-解压出来的文件 xxx.deb &#x2F;&#x2F;打包生成deb</span><br></pre></td></tr></table></figure>

<h5 id="解包"><a href="#解包" class="headerlink" title="解包"></a>解包</h5><p>-X参数可以提取deb包中的所有文件到 extract，-e 参数可以提取deb包中的控制信息到extract/DEBIAN</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ dpkg -X .&#x2F;xxx.deb extract</span><br><span class="line">$ dpkg -e .&#x2F;xxx.deb extract&#x2F;DEBIAN</span><br></pre></td></tr></table></figure>

<ul>
<li>重新打包成deb</li>
</ul>
<p>检查目录是否存在 .DS_Store 文件删除，再设置用户组权限打包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo chown -R root:wheel .&#x2F;extract</span><br><span class="line">$ dpkg-deb -b extract&#x2F; build&#x2F; </span><br><span class="line">#如果安装报错将打包命令修改成如下 </span><br><span class="line">$ dpkg-deb -Z gzip -b extract&#x2F; build&#x2F;</span><br></pre></td></tr></table></figure>



<p>dpkg 可以在 iOS 设备上安装 deb 包，SSH 到设备</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dpkg -i &#x2F;var&#x2F;mobile&#x2F;Cydown&#x2F;test.deb</span><br></pre></td></tr></table></figure>





<h4 id="报错修改"><a href="#报错修改" class="headerlink" title="报错修改"></a>报错修改</h4><p>make package install</p>
<ol>
<li>提示 <code>obsolete compression type &#39;lzma&#39;; use xz instead</code></li>
</ol>
<p>解决：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">到theos目录 HTEOS&#x2F;makefiles&#x2F;package&#x2F;deb.mk</span><br><span class="line">第六行的THEOSPLATFORM_DPKG_DEB_COMPRESSION?&#x3D;lzma 把lzma改成xz就可以了</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>提示 <code>dpkg: error processing /tmp/_theos_install.deb (--install):</code></li>
</ol>
<p>解决：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">到目录 THEOS&#x2F;makefiles&#x2F;package&#x2F;deb.mk</span><br><span class="line">vim 进入 注释这一行</span><br><span class="line">#$(ECHO_NOTHING)COPYFILE_DISABLE&#x3D;1 $(FAKEROOT) -r $(_THEOS_PLATFORM_DPKG_DEB) -Z$(_THEOS_PLATFORM_DPKG_DEB_COMPRESSION) -b &quot;$(THEOS_STAGING_DIR)&quot; &quot;$(_THEOS_DEB_PACKAGE_FILENAME)&quot;$(ECHO_END)</span><br><span class="line">添加 </span><br><span class="line">$(ECHO_NOTHING)COPYFILE_DISABLE&#x3D;1 $(FAKEROOT) -r dpkg-deb -Zgzip -b &quot;$(THEOS_STAGING_DIR)&quot; &quot;$(_THEOS_DEB_PACKAGE_FILENAME)&quot; $(STDERR_NULL_REDIRECT)$(ECHO_END)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>Showing Recent Messages</p>
<p>An empty identity is not valid when signing a binary for the product type ‘Dynamic Library’.</p>
</li>
</ol>
<p>解决：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BuildSettings-User-Defined 添加 key CODE_SIGNING_ALLOWED NO</span><br></pre></td></tr></table></figure>










      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/20/%E9%80%86%E5%90%91-Frida%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/20/%E9%80%86%E5%90%91-Frida%E8%AE%B0%E5%BD%95/" class="post-title-link" itemprop="url">逆向-Frida记录</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-06-20 10:57:17" itemprop="dateCreated datePublished" datetime="2022-06-20T10:57:17+08:00">2022-06-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-07-18 17:46:26" itemprop="dateModified" datetime="2022-07-18T17:46:26+08:00">2022-07-18</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="py脚本"><a href="#py脚本" class="headerlink" title="py脚本"></a>py脚本</h4><h5 id="start-frida-py"><a href="#start-frida-py" class="headerlink" title="start_frida.py"></a>start_frida.py</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">bundle = <span class="string">&#x27;com.highaltitudehacks.dvia&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#sys.argv[1] 第一个参数 </span></span><br><span class="line"><span class="keyword">with</span> codecs.<span class="built_in">open</span>(sys.argv[<span class="number">1</span>], <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    source = f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment">#f = open(sys.argv[1], &#x27;r&#x27;) #打开frida脚本</span></span><br><span class="line"><span class="comment">#source = f.read() #读取frida脚本</span></span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device(<span class="number">1000</span>) <span class="comment">#连接usb设备 1000表示超时</span></span><br><span class="line">pid = device.spawn(bundle) <span class="comment">#启动指定bundleId的app</span></span><br><span class="line">session = device.attach(pid)  <span class="comment">#附加到app</span></span><br><span class="line">script = session.create_script(source) <span class="comment">#创建frida javaScript脚本</span></span><br><span class="line">script.load() <span class="comment">#load脚本到app进程中 这样即注入成功</span></span><br><span class="line">device.resume(pid) <span class="comment">#恢复app运行</span></span><br><span class="line">sys.stdin.read()<span class="comment">#读取打印日志</span></span><br></pre></td></tr></table></figure>



<h4 id="1"><a href="#1" class="headerlink" title="1"></a>1</h4><h5 id="hello-world-js"><a href="#hello-world-js" class="headerlink" title="hello_world.js"></a>hello_world.js</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;hello world&#x27;</span>);</span><br><span class="line">    <span class="comment">//或者send打印</span></span><br><span class="line">	  <span class="comment">//end(&#x27;send hello world&#x27;)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ python3.8 start_frida.py hello_world.js</span><br><span class="line">#打印 hello world</span><br></pre></td></tr></table></figure>

<h5 id="log-allClass-js"><a href="#log-allClass-js" class="headerlink" title="log_allClass.js"></a>log_allClass.js</h5><ul>
<li>打印应用中所有的 class 文件</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ObjC.classes 加载的所有OC类</span></span><br><span class="line"><span class="keyword">if</span> (ObjC.available) &#123; <span class="comment">//OC类加载完成</span></span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">&#x27;\n[*] Starting Hooking&#x27;</span>)</span><br><span class="line">	 <span class="keyword">for</span> (<span class="keyword">var</span> className <span class="keyword">in</span> ObjC.classes) &#123;</span><br><span class="line">		 <span class="keyword">if</span> (ObjC.classes.hasOwnProperty(className)) &#123;</span><br><span class="line">			 <span class="built_in">console</span>.log(className)</span><br><span class="line">		 &#125;</span><br><span class="line">	 &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ python3.8 start_frida.py log_allClass.js</span><br><span class="line">#内容打印太多了 可以加 grep</span><br><span class="line">$ python3.8 start_frida.py log_allClass.js | grep Jailbreak</span><br><span class="line">JailbreakDetectionVC</span><br></pre></td></tr></table></figure>

<h5 id="hook-DIVA-app"><a href="#hook-DIVA-app" class="headerlink" title="hook DIVA app"></a>hook DIVA app</h5><p>app下载地址 <a target="_blank" rel="noopener" href="https://github.com/prateek147/DVIA">https://github.com/prateek147/DVIA</a></p>
<p>里面有个越狱检测功能</p>
<p>查找包含越狱英文名的文件和方法，越狱 JailBroke 或 JailBreak</p>
<p>eval() 函数计算 JavaScript 字符串，并把它作为脚本代码来执行</p>
<h5 id="log-allJailMethods-js"><a href="#log-allJailMethods-js" class="headerlink" title="log_allJailMethods.js"></a>log_allJailMethods.js</h5><ul>
<li>打印包含越狱关键字类和方法</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">var</span> className <span class="keyword">in</span> ObjC.classes) &#123;</span><br><span class="line">		<span class="keyword">if</span> (className.toLowerCase().indexOf(<span class="string">&#x27;jail&#x27;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;[#]ClassName--------&gt;&#x27;</span> + className)</span><br><span class="line">      </span><br><span class="line">			<span class="comment">//获取类的所有方法</span></span><br><span class="line">			<span class="keyword">var</span> methods = <span class="built_in">eval</span>(<span class="string">&#x27;ObjC.classes.&#x27;</span> + className + <span class="string">&#x27;.$methods&#x27;</span>)</span><br><span class="line">      </span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; methods.length; i++) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="keyword">if</span> (methods[i].toLowerCase().indexOf(<span class="string">&#x27;jail&#x27;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">						<span class="built_in">console</span>.log(<span class="string">&#x27;[-]&#x27;</span> + methods[i])</span><br><span class="line">					&#125;</span><br><span class="line">				&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">					<span class="built_in">console</span>.log(<span class="string">&#x27;[!] Exception:&#x27;</span> + err.message)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行python脚本 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ python3.8 start_frida.py log_allJailMethods.js</span><br><span class="line"></span><br><span class="line">[#]ClassName--------&gt;JailbreakDetectionVC</span><br><span class="line">[-]- isJailbroken</span><br><span class="line">[-]- jailbreakTest1Tapped:</span><br><span class="line">[-]- jailbreakTest2Tapped:</span><br></pre></td></tr></table></figure>

<h5 id="find-threadTrace-js"><a href="#find-threadTrace-js" class="headerlink" title="find_threadTrace.js"></a>find_threadTrace.js</h5><ul>
<li>跟踪越狱检测方法调用</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//跟踪越狱检测方法调用 修改返回值</span></span><br><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;\n[*] Starting Hooking&#x27;</span>);</span><br><span class="line">	<span class="keyword">var</span> class_name = <span class="string">&#x27;JailbreakDetectionVC&#x27;</span></span><br><span class="line">	<span class="keyword">var</span> method_name = <span class="string">&#x27;- isJailbroken&#x27;</span></span><br><span class="line">	<span class="comment">//通过ObjC.classes返回当前注册类的映射表找到想要hook的类名、方法名</span></span><br><span class="line">	<span class="keyword">var</span> hooking = ObjC.classes[class_name][method_name]</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;className:&#x27;</span>+class_name+<span class="string">&#x27; methodName: &#x27;</span>+method_name)</span><br><span class="line">	Interceptor.attach(hooking.implementation,&#123;</span><br><span class="line">		onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">			<span class="comment">//args[0]:self</span></span><br><span class="line">			<span class="comment">//args[1]:The selector</span></span><br><span class="line">			<span class="comment">//args[2]:方法的第一个参数开始</span></span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;hook success&#x27;</span>)</span><br><span class="line">			<span class="built_in">this</span>.class_name = ObjC.Object(args[<span class="number">0</span>]).toString()</span><br><span class="line">			<span class="built_in">this</span>.method_name = ObjC.selectorAsString(args[<span class="number">1</span>])</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;onEnter args[0] class_name: &#x27;</span> + <span class="built_in">this</span>.class_name)</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;onEnter args[1] method_name: &#x27;</span> + <span class="built_in">this</span>.method_name)</span><br><span class="line">			<span class="comment">//打印函数调用栈</span></span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;isJailbroken called from:\n&#x27;</span> + Thread.backtrace(<span class="built_in">this</span>.context, Backtracer.ACCURATE).map(DebugSymbol.fromAddress).join(<span class="string">&#x27;\n\t&#x27;</span>))</span><br><span class="line">		&#125;, </span><br><span class="line">		onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;Return value of: &#x27;</span>)</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27; &#x27;</span> + <span class="built_in">this</span>.class_name + <span class="string">&#x27;--&gt;&#x27;</span> + <span class="built_in">this</span>.method_name)</span><br><span class="line">			<span class="comment">//返回值类型</span></span><br><span class="line">			<span class="keyword">var</span> typeValue = <span class="built_in">Object</span>.prototype.toString.call(retval)</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;\t[-] Type of return value: &#x27;</span> + typeValue)</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;\t[-] Return value: &#x27;</span>, retval)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ python3.8 start_frida.py find_threadTrace.js</span><br><span class="line"></span><br><span class="line">[*] Starting Hooking</span><br><span class="line">className:JailbreakDetectionVC methodName: - isJailbroken</span><br><span class="line">hook success</span><br><span class="line">onEnter args[0] class_name: &lt;JailbreakDetectionVC: 0x12100c9d0&gt;</span><br><span class="line">onEnter args[1] method_name: isJailbroken</span><br><span class="line">isJailbroken called from:</span><br><span class="line">0x1006e1770 &#x2F;private&#x2F;var&#x2F;containers&#x2F;Bundle&#x2F;Application&#x2F;4259E6F5-A16E-4275-B615-62B05D26F2D9&#x2F;DamnVulnerableIOSApp.app&#x2F;DamnVulnerableIOSApp!-[JailbreakDetectionVC jailbreakTest1Tapped:]</span><br><span class="line">	0x184c926c4 UIKitCore!-[UIApplication sendAction:to:from:forEvent:]</span><br><span class="line">	0x1845c4a80 UIKitCore!-[UIControl sendAction:to:forEvent:]</span><br><span class="line">	0x1845c4dd0 UIKitCore!-[UIControl _sendActionsForEvents:withEvent:]</span><br><span class="line">	0x1845c364c UIKitCore!-[UIControl touchesEnded:withEvent:]</span><br><span class="line">	0x184cd0588 UIKitCore!-[UIWindow _sendTouchesForEvent:]</span><br><span class="line">	0x184cd1ea8 UIKitCore!-[UIWindow sendEvent:]</span><br><span class="line">	0x184cab948 UIKitCore!-[UIApplication sendEvent:]</span><br><span class="line">	0x184d34dc0 UIKitCore!__dispatchPreprocessedEventFromEventQueue</span><br><span class="line">	0x184d397d4 UIKitCore!__processEventQueue</span><br><span class="line">	0x184d30bd4 UIKitCore!__eventFetcherSourceCallback</span><br><span class="line">	0x182224848 CoreFoundation!__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__</span><br><span class="line">	0x182224744 CoreFoundation!__CFRunLoopDoSource0</span><br><span class="line">	0x182223a48 CoreFoundation!__CFRunLoopDoSources0</span><br><span class="line">	0x18221da28 CoreFoundation!__CFRunLoopRun</span><br><span class="line">	0x18221d1c0 CoreFoundation!CFRunLoopRunSpecific</span><br><span class="line">Return value of:</span><br><span class="line"> &lt;JailbreakDetectionVC: 0x12100c9d0&gt;--&gt;isJailbroken</span><br><span class="line">	[-] Type of return value: [object Object]</span><br><span class="line">	[-] Return value:  0x1</span><br></pre></td></tr></table></figure>

<h6 id="修改返回值"><a href="#修改返回值" class="headerlink" title="修改返回值"></a>修改返回值</h6><p>将 0x1 修改成 0x0</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ptr(0x0) ptr定义一个指针 指针地址为0x0</span></span><br><span class="line">onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>) </span>&#123;</span><br><span class="line">  retval.replace(ptr(<span class="number">0x0</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="修改返回字符串"><a href="#修改返回字符串" class="headerlink" title="修改返回字符串"></a>修改返回字符串</h6><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">onLeave: function(retval)&#123;</span><br><span class="line">			console.log(<span class="string">&#x27;Return value of: &#x27;</span>)</span><br><span class="line">			<span class="comment">//返回值类型</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.key_value == <span class="string">&#x27;MT_Device_UUIDString&#x27;</span>) &#123;</span><br><span class="line">			    var newuuid = ObjC.classes.NSString.stringWithString_(<span class="string">&quot;12244386&quot;</span>)</span><br><span class="line">          retval.replace(newuuid)</span><br><span class="line">			&#125;</span><br><span class="line">			var typeValue = Object.prototype.toString.call(retval)</span><br><span class="line">			console.log(<span class="string">&#x27;\t[-] Type of return value: &#x27;</span> + typeValue)</span><br><span class="line">			console.log(<span class="string">&#x27;\t[-] Return value: &#x27;</span>, retval)</span><br><span class="line">			console.log(<span class="string">&#x27;\t[-] value: &#x27;</span>, ObjC.Object(retval).toString())</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>



<h5 id="enumerate-modules-js"><a href="#enumerate-modules-js" class="headerlink" title="enumerate_modules.js"></a>enumerate_modules.js</h5><ul>
<li>打印进程所有模块信息</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;\n[*] Starting Hooking&#x27;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">var</span> base_addr = Module.findBaseAddress(<span class="string">&#x27;CMake&#x27;</span>)</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;base_addr: &#x27;</span>+base_addr)</span><br><span class="line">  </span><br><span class="line">	Process.enumerateModules(&#123;</span><br><span class="line">		onMatch: <span class="function"><span class="keyword">function</span>(<span class="params"><span class="built_in">module</span></span>) </span>&#123;</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;Module name:&#x27;</span> + <span class="built_in">module</span>.name + <span class="string">&#x27;-&#x27;</span> + <span class="string">&#x27;Base Address:&#x27;</span> + <span class="built_in">module</span>.base);</span><br><span class="line">		&#125;,</span><br><span class="line">		onComplete: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ python3.8 cmake.py enumerate_modules.js</span><br><span class="line"></span><br><span class="line">[*] Starting Hooking</span><br><span class="line">base_addr: 0x102178000</span><br><span class="line">Module name:CMake-Base Address:0x100f54000</span><br><span class="line">Module name:substitute-inserter.dylib-Base Address:0x1010ac000</span><br><span class="line">Module name:Foundation-Base Address:0x1834f6000</span><br><span class="line">Module name:libobjc.A.dylib-Base Address:0x196d01000</span><br><span class="line">Module name:libSystem.B.dylib-Base Address:0x1b2c5c000</span><br><span class="line">Module name:CoreFoundation-Base Address:0x182181000</span><br><span class="line">Module name:UIKit-Base Address:0x1b6d1f000</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>模块基地址 Module name:CMake-Base Address:0x100f54000</p>
<h4 id="弹窗显示"><a href="#弹窗显示" class="headerlink" title="弹窗显示"></a>弹窗显示</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; NSString &#125; = ObjC.classes;</span><br><span class="line">  <span class="keyword">var</span> UIAlertController = ObjC.classes.UIAlertController;</span><br><span class="line">  <span class="keyword">var</span> UIAlertAction = ObjC.classes.UIAlertAction;</span><br><span class="line">  <span class="keyword">var</span> UIApplication = ObjC.classes.UIApplication;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 弹窗</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">showAlert</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> alertHandler = <span class="keyword">new</span> ObjC.Block(&#123; <span class="attr">retType</span>: <span class="string">&#x27;void&#x27;</span>, <span class="attr">argTypes</span>: [<span class="string">&#x27;object&#x27;</span>], <span class="attr">implementation</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125; &#125;);</span><br><span class="line"></span><br><span class="line">    ObjC.schedule(ObjC.mainQueue, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> alert = UIAlertController.alertControllerWithTitle_message_preferredStyle_(<span class="string">&#x27;LinXunFeng&#x27;</span>, <span class="string">&#x27;欢迎关注公众号：FSA全栈行动\n博客：https://fullstackaction.com&#x27;</span>, <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">var</span> defaultAction = UIAlertAction.actionWithTitle_style_handler_(<span class="string">&#x27;OK&#x27;</span>, <span class="number">0</span>, alertHandler);</span><br><span class="line">      alert.addAction_(defaultAction);</span><br><span class="line">      UIApplication.sharedApplication().keyWindow().rootViewController().presentViewController_animated_completion_(alert, <span class="literal">true</span>, NULL);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 播放系统声音</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">playSystemSound</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> playSound = <span class="keyword">new</span> NativeFunction(Module.findExportByName(<span class="string">&#x27;AudioToolbox&#x27;</span>, <span class="string">&#x27;AudioServicesPlaySystemSound&#x27;</span>), <span class="string">&#x27;void&#x27;</span>, [<span class="string">&#x27;int&#x27;</span>])</span><br><span class="line">    playSound(<span class="number">1111</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> didTap = ObjC.classes.T1TranslateButton[<span class="string">&#x27;- _didTap:forEvent:&#x27;</span>]</span><br><span class="line">  <span class="keyword">var</span> setTitle = ObjC.classes.T1TranslateButton[<span class="string">&#x27;- setTitleText:&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 保留旧实现</span></span><br><span class="line">  <span class="keyword">var</span> didTapOldImp = didTap.implementation</span><br><span class="line"></span><br><span class="line">  <span class="comment">// hook</span></span><br><span class="line">  Interceptor.attach(setTitleOldImp, &#123;</span><br><span class="line">    onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">      args[<span class="number">2</span>] = ptr(NSString.stringWithString_(<span class="string">&quot;Hello LinXunFeng，点击我来弹个窗和听个曲吧&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 覆盖实现</span></span><br><span class="line">  didTap.implementation = ObjC.implement(setTitle, <span class="function"><span class="keyword">function</span>(<span class="params">handle, selector, arg1, arg2</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 调用旧实现</span></span><br><span class="line">    <span class="comment">// didTapOldImp(handle, selector, arg1, arg2)</span></span><br><span class="line"></span><br><span class="line">    playSystemSound()</span><br><span class="line">    showAlert()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/18/%E9%80%86%E5%90%91-Frida%E7%BB%95%E8%BF%87iOS%E5%8F%8D%E8%B0%83%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/18/%E9%80%86%E5%90%91-Frida%E7%BB%95%E8%BF%87iOS%E5%8F%8D%E8%B0%83%E8%AF%95/" class="post-title-link" itemprop="url">逆向-Frida绕过iOS反调试</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-06-18 00:08:34 / 修改时间：15:43:34" itemprop="dateCreated datePublished" datetime="2022-06-18T00:08:34+08:00">2022-06-18</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>macOS</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ iproxy 2222 22 #端口转发</span><br><span class="line">$ ssh -p 2222 root@localhost</span><br></pre></td></tr></table></figure>

<p>iOS设备上，查找应用进程名称</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root# ps -e</span><br><span class="line">8082 ??   0:16.32 &#x2F;var&#x2F;containers&#x2F;Bundle&#x2F;Application&#x2F;XXXX&#x2F;XinHuaShe.app&#x2F;XinHuaShe</span><br></pre></td></tr></table></figure>

<p>启动 debugserver 附加到 XinHuaShe 进程，监听 1234 端口，等待电脑端 LLDB 接入</p>
<p>debugserver 主机IP地址:端口号 -a 应用进程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root# debugserver *:1234 -a XinHuaShe</span><br><span class="line">Attaching to process XinHuaShe...</span><br><span class="line">Segmentation fault: 11</span><br></pre></td></tr></table></figure>

<p>提示 <code>Segmentation fault: 11</code> 了 ，APP 做了反调试的防护</p>
<p>目前公开的反动态调试的防护就 ptrace</p>
<p>启动 APP</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root# debugserver -x posix *:1234 &#x2F;var&#x2F;containers&#x2F;Bundle&#x2F;Application&#x2F;CB03D455-A7BC-4762-84C6-3FAE31A3C67C&#x2F;XinHuaShe.app&#x2F;XinHuaShe</span><br></pre></td></tr></table></figure>

<p>电脑端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ iproxy 1234 1234</span><br><span class="line">$ lldb</span><br><span class="line">(lldb) process connect connect:&#x2F;&#x2F;localhost:1234 &#x2F;&#x2F;手机IP地址</span><br><span class="line">error: failed to get reply to handshake packet  &#x2F;&#x2F;报错了</span><br></pre></td></tr></table></figure>

<p>修改启动debugserver</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root# debugserver -x posix localhost:1234 &#x2F;var&#x2F;containers&#x2F;Bundle&#x2F;Application&#x2F;CB03D455-A7BC-4762-84C6-3FAE31A3C67C&#x2F;XinHuaShe.app&#x2F;XinHuaShe</span><br></pre></td></tr></table></figure>

<p>继续</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">$ lldb</span><br><span class="line">(lldb) process connect connect:&#x2F;&#x2F;localhost:1234 &#x2F;&#x2F;手机IP地址</span><br><span class="line"></span><br><span class="line">Process 9824 stopped</span><br><span class="line">* thread #1, stop reason &#x3D; signal SIGSTOP</span><br><span class="line">    frame #0: 0x0000000108c91000 dyld&#96; _dyld_start</span><br><span class="line">dyld&#96;_dyld_start:</span><br><span class="line">-&gt;  0x108c91000 &lt;+0&gt;:  mov    x28, sp</span><br><span class="line">    0x108c91004 &lt;+4&gt;:  and    sp, x28, #0xfffffffffffffff0</span><br><span class="line">    0x108c91008 &lt;+8&gt;:  mov    x0, #0x0</span><br><span class="line">    0x108c9100c &lt;+12&gt;: mov    x1, #0x0</span><br><span class="line">    0x108c91010 &lt;+16&gt;: stp    x1, x0, [sp, #-0x10]!</span><br><span class="line">    0x108c91014 &lt;+20&gt;: mov    x29, sp</span><br><span class="line">    0x108c91018 &lt;+24&gt;: sub    sp, sp, #0x10             ; &#x3D;0x10</span><br><span class="line">    0x108c9101c &lt;+28&gt;: ldr    x0, [x28]</span><br><span class="line">Target 0: (XinHuaShe) stopped.</span><br><span class="line"></span><br><span class="line">(lldb) c</span><br><span class="line">Process 9824 resuming</span><br><span class="line">Process 9824 exited with status &#x3D; 45 (0x0000002d) &#x2F;&#x2F;直接退出了</span><br><span class="line"></span><br><span class="line">(lldb) b ptrace &#x2F;&#x2F;给ptrace下断点</span><br><span class="line">Breakpoint 1: no locations (pending).</span><br><span class="line">WARNING:  Unable to resolve breakpoint to any actual locations.</span><br><span class="line">(lldb) c</span><br><span class="line">Process 9841 resuming</span><br><span class="line">1 location added to breakpoint 1</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;打印调用栈</span><br><span class="line">(lldb) bt</span><br><span class="line">error: invalid thread</span><br><span class="line">external version is 20200929_18:15:57_6075104</span><br><span class="line">Object_Creator constructor</span><br><span class="line">Process 9841 stopped</span><br><span class="line">* thread #1, queue &#x3D; &#39;com.apple.main-thread&#39;, stop reason &#x3D; breakpoint 1.1</span><br><span class="line">    frame #0: 0x00000001b02a33b0 libsystem_kernel.dylib&#96; __ptrace</span><br><span class="line">libsystem_kernel.dylib&#96;__ptrace:</span><br><span class="line">-&gt;  0x1b02a33b0 &lt;+0&gt;:  adrp   x9, 213850</span><br><span class="line">    0x1b02a33b4 &lt;+4&gt;:  add    x9, x9, #0x110            ; &#x3D;0x110</span><br><span class="line">    0x1b02a33b8 &lt;+8&gt;:  str    wzr, [x9]</span><br><span class="line">    0x1b02a33bc &lt;+12&gt;: mov    x16, #0x1a</span><br><span class="line">    0x1b02a33c0 &lt;+16&gt;: svc    #0x80</span><br><span class="line">    0x1b02a33c4 &lt;+20&gt;: b.lo   0x1b02a33e4               ; &lt;+52&gt;</span><br><span class="line">    0x1b02a33c8 &lt;+24&gt;: pacibsp</span><br><span class="line">    0x1b02a33cc &lt;+28&gt;: stp    x29, x30, [sp, #-0x10]!</span><br><span class="line">Target 0: (XinHuaShe) stopped.</span><br></pre></td></tr></table></figure>

<p>x30 寄存器也叫 lr 寄存器，打印返回地址 p/x $lr</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p&#x2F;x $lr</span><br><span class="line">(unsigned long) $0 &#x3D; 0x00000001003139e0</span><br><span class="line">(lldb) image list -o -f</span><br><span class="line">[  0] 0x0000000000254000 &#x2F;private&#x2F;var&#x2F;containers&#x2F;Bundle&#x2F;Application&#x2F;CB03D455-A7BC-4762-84C6-3FAE31A3C67C&#x2F;XinHuaShe.app&#x2F;XinHuaShe(0x0000000100254000)</span><br></pre></td></tr></table></figure>

<p>地址转换下  0x00000001003139e0 - 0x0000000000254000 = 0x1000BF9E0</p>
<p>IDA 中查找 0x1000BF9E0 地址</p>
<img src="逆向-Frida绕过iOS反调试/图片 1.png" alt="图片 1" style="zoom:100%;" />

<p>这段代码的含义就明显了，动态调用 ptrace，达到反动态调试的目的</p>
<p>这段函数位于 sub_1000BF9A0 内部</p>
<p>定位到函数右键 Jump to xref</p>
<p>看到 sub_1000BF9A0 的显示调用这地址 start+20</p>
<p>![图片 2](逆向-Frida绕过iOS反调试/图片 2.png)</p>
<p>双击 start+20 查看实现，它是 start 函数，在 start 函数中动态调用 ptrace 函数来达到反动态调试的目的</p>
<ul>
<li>去掉 sub_1000BF9A0</li>
</ul>
<ol>
<li>可以用 tweak 的方式</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;substrate.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;mach-o/dyld.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> (*old_sub_ACF0)(<span class="keyword">void</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> new_sub_ACF0(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// old_sub_ACF0();</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;iOSRE: anti-anti-debugging&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%ctor &#123;</span><br><span class="line">  <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> _sub_ACF0 = (_dyld_get_image_vmaddr_slide(<span class="number">0</span>) + <span class="number">0xACF0</span>) | <span class="number">0x1</span>;</span><br><span class="line">    <span class="keyword">if</span> (_sub_ACF0) <span class="built_in">NSLog</span>(<span class="string">@&quot;iOSRE: Found sub_ACF0!&quot;</span>);</span><br><span class="line">    MSHookFunction((<span class="keyword">void</span> *)_sub_ACF0, (<span class="keyword">void</span> *)&amp;new_sub_ACF0, (<span class="keyword">void</span> **)&amp;old_sub_ACF0);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>使用 fishhook</li>
<li>Frida replace 掉 sub_1000BF9A0 函数</li>
</ol>
<p>hook.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取函数地址</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_rva</span>(<span class="params"><span class="built_in">module</span>, offset</span>) </span>&#123;</span><br><span class="line">	<span class="comment">//获取基地址</span></span><br><span class="line">	<span class="keyword">var</span> base_addr = Module.findBaseAddress(<span class="built_in">module</span>)</span><br><span class="line">	<span class="comment">//函数地址 = 基地址+偏移地址</span></span><br><span class="line">	<span class="keyword">var</span> target_addr = base_addr.add(offset) </span><br><span class="line">	<span class="keyword">if</span> (Process.arch == <span class="string">&#x27;arm&#x27;</span>) &#123; <span class="comment">//如果是32位地址+1</span></span><br><span class="line">		<span class="keyword">return</span> target_addr.add(<span class="number">1</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> target_addr</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ObjC.available) &#123; <span class="comment">//OC类加载完成</span></span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;\n[*] Starting Hooking&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> target_addr = get_rva(<span class="string">&#x27;XinHuaShe&#x27;</span>, <span class="number">0xBF9A0</span>)</span><br><span class="line">	<span class="comment">//NativeCallback(func, returnType, argTypes[,abi])</span></span><br><span class="line">	<span class="comment">//或者不用参数</span></span><br><span class="line">	Interceptor.replace(ptr(target_addr), <span class="keyword">new</span> NativeCallback(<span class="function"><span class="keyword">function</span>(<span class="params">argc, argv</span>)</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;hook sub_ptrace bypass&#x27;</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">	&#125;, int, [int, int]))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>hook.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">bundle = <span class="string">&#x27;com.xinhuamm.d0001&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#sys.argv[1] 第一个参数 </span></span><br><span class="line"><span class="keyword">with</span> codecs.<span class="built_in">open</span>(sys.argv[<span class="number">1</span>], <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    source = f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment">#f = open(sys.argv[1], &#x27;r&#x27;) #打开frida脚本</span></span><br><span class="line"><span class="comment">#source = f.read() #读取frida脚本</span></span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device(<span class="number">1000</span>) <span class="comment">#连接usb设备 1000表示超时</span></span><br><span class="line">pid = device.spawn(bundle) <span class="comment">#启动指定bundleId的app</span></span><br><span class="line">session = device.attach(pid)  <span class="comment">#附加到app</span></span><br><span class="line">script = session.create_script(source) <span class="comment">#创建frida javaScript脚本</span></span><br><span class="line">script.load() <span class="comment">#load脚本到app进程中 这样即注入成功</span></span><br><span class="line">device.resume(pid) <span class="comment">#恢复app运行</span></span><br><span class="line">sys.stdin.read()<span class="comment">#读取打印日志</span></span><br></pre></td></tr></table></figure>

<p>执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3.8 hook.py hook.js</span><br></pre></td></tr></table></figure>

<p>报错 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Failed to spawn: the request to open &quot;com.xinhuamm.d0001&quot; failed.</span><br></pre></td></tr></table></figure>

















<p><a target="_blank" rel="noopener" href="https://la0s.github.io/2019/03/07/anti_ptrace/">Frida绕过iOS反调试</a></p>
<p><a target="_blank" rel="noopener" href="https://iosre.com/t/7-2-0-ios/770">干掉高德地图反动态调试</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/17/%E9%80%86%E5%90%91-Frida-RPC%E8%B0%83%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/17/%E9%80%86%E5%90%91-Frida-RPC%E8%B0%83%E7%94%A8/" class="post-title-link" itemprop="url">逆向-Frida RPC调用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-06-17 16:39:38" itemprop="dateCreated datePublished" datetime="2022-06-17T16:39:38+08:00">2022-06-17</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-07-18 17:55:16" itemprop="dateModified" datetime="2022-07-18T17:55:16+08:00">2022-07-18</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Frida 提供了 RPC（远程过程调用）功能，开发人员可以将封装好的任意函数指定为 RPC函数，提供给Python使用。</p>
<p>比如应用中存在一个加密函数，开发者不想分析它的实现，只是想调用它来得到结果，则可以将此加密函数导出，利用Python来调用它</p>
<p>利用 rpc.exports={} 导出RPC函数，多个函数间用逗号分隔</p>
<h4 id="1"><a href="#1" class="headerlink" title="1"></a>1</h4><p>定义 CoreClass 类里面 4 个方法 </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSString</span> *)getDeviceId &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">@&quot;e10adc3949ba59abbe56e057f20f883e&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">NSString</span> *)httpPost:(<span class="built_in">NSURL</span> *)url &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;URL: %@&quot;</span>, url);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">@&quot;test&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span>*)encrypt:(<span class="built_in">NSData</span>*)data key:(<span class="built_in">NSString</span>*)key&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;data: %@&quot;</span>, data);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;key: %@&quot;</span>, key);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">@&quot;encrypt successed!&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span>*)decrypt:(<span class="built_in">NSString</span>*)str key:(<span class="built_in">NSString</span>*)key&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;str: %@&quot;</span>, str);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;key: %@&quot;</span>, key);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">@&quot;decrypt successed!&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>现在要在 JS 里调用这 4 个方法</li>
</ul>
<p>实例方法需要初始化一个实例</p>
<p>类方法不需要初始化实例，在方法名称后面加上一个 _ 就可以调用了</p>
<p>JS 脚本: rpc.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;\n[*] Starting Hooking&#x27;</span>)</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">var</span> coreClass = ObjC.classes.CoreClass.alloc()</span><br><span class="line">		<span class="comment">//JS调用OC实例方法</span></span><br><span class="line">		<span class="keyword">var</span> deviceId = coreClass[<span class="string">&#x27;- getDeviceId&#x27;</span>].call(coreClass)</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;deviceId: &#x27;</span>+deviceId)</span><br><span class="line">		<span class="comment">//JS调用OC类方法</span></span><br><span class="line">		<span class="keyword">var</span> url = ObjC.classes.NSURL.URLWithString_(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line">		<span class="keyword">var</span> retString = ObjC.classes.CoreClass.httpPost_(url)</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;retString: &#x27;</span>+retString)</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">var</span> str = ObjC.classes.NSString.stringWithString_(<span class="string">&#x27;testStr&#x27;</span>)</span><br><span class="line">		<span class="comment">//NSData *data = [str dataUsingEncoding:NSUTF8StringEncoding]</span></span><br><span class="line">		<span class="keyword">var</span> data = str.dataUsingEncoding_(<span class="number">4</span>)</span><br><span class="line">		<span class="keyword">var</span> key = ObjC.classes.NSString.stringWithString_(<span class="string">&#x27;key&#x27;</span>)</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">var</span> encryptString = coreClass[<span class="string">&#x27;- encrypt:key:&#x27;</span>].call(coreClass, decryptStr, key2)</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;encryptString: &#x27;</span>+encryptString)</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ python3.8 cmake.py rpc.js</span><br><span class="line"></span><br><span class="line">[*] Starting Hooking</span><br><span class="line">deviceId: e10adc3949ba59abbe56e057f20f883e</span><br><span class="line">retString: test</span><br><span class="line">encryptString: encrypt successed!</span><br><span class="line">decryptString: decrypt successed!</span><br></pre></td></tr></table></figure>

<p>接下来将代码导出给 Python 使用，JS 代码里定义 4 个函数</p>
<p>getDeviceId、httpPost、encrypt、decrypt，4个函数分别代表了调用目标进程的4个OC方法，然后用 rpc.exports 将 4 个函数导出</p>
<p>rpc.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;\n[*] Starting Hooking&#x27;</span>)</span><br><span class="line">	</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getHomeDirectory</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> NSHomeDirectory = <span class="keyword">new</span> NativeFunction(ptr(Module.findExportByName(<span class="string">&quot;Foundation&quot;</span>, <span class="string">&quot;NSHomeDirectory&quot;</span>)), <span class="string">&#x27;pointer&#x27;</span>, [])</span><br><span class="line">    <span class="keyword">var</span> path = <span class="keyword">new</span> ObjC.Object(NSHomeDirectory());</span><br><span class="line">    <span class="keyword">return</span> path.toString()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDeviceId</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">var</span> coreClass = ObjC.classes.CoreClass.alloc()</span><br><span class="line">		<span class="keyword">var</span> deviceId = coreClass[<span class="string">&#x27;- getDeviceId&#x27;</span>].call(coreClass)</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;deviceId: &#x27;</span>+deviceId)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">httpPost</span>(<span class="params">inputurl</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">var</span> url = ObjC.classes.NSURL.URLWithString_(inputurl)</span><br><span class="line">		<span class="keyword">var</span> retString = ObjC.classes.CoreClass.httpPost_(url)</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;retString: &#x27;</span>+retString)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">encrypt</span>(<span class="params">inputstr, inputkey</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">var</span> coreClass = ObjC.classes.CoreClass.alloc()</span><br><span class="line">		<span class="keyword">var</span> str = ObjC.classes.NSString.stringWithString_(inputstr)</span><br><span class="line">		<span class="comment">//NSData *data = [str dataUsingEncoding:NSUTF8StringEncoding]</span></span><br><span class="line">		<span class="keyword">var</span> data = str.dataUsingEncoding_(<span class="number">4</span>)</span><br><span class="line">		<span class="keyword">var</span> key = ObjC.classes.NSString.stringWithString_(inputkey)</span><br><span class="line">		<span class="keyword">var</span> encryptString = coreClass[<span class="string">&#x27;- encrypt:key:&#x27;</span>].call(coreClass, data, key)</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;encryptString: &#x27;</span>+encryptString)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">decrypt</span>(<span class="params">inputstr, inputkey</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">var</span> coreClass = ObjC.classes.CoreClass.alloc()</span><br><span class="line">		<span class="keyword">var</span> decryptStr = ObjC.classes.NSString.stringWithString_(inputstr)</span><br><span class="line">		<span class="keyword">var</span> key2 = ObjC.classes.NSString.stringWithString_(inputkey)</span><br><span class="line">		<span class="keyword">var</span> decryptString = coreClass[<span class="string">&#x27;- decrypt:key:&#x27;</span>].call(coreClass, decryptStr, key2)</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;decryptString: &#x27;</span>+decryptString)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	rpc.exports = &#123;</span><br><span class="line">    gethomedirectory: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="comment">// homedirectory 必须小写</span></span><br><span class="line">      <span class="keyword">return</span> getHomeDirectory()</span><br><span class="line">    &#125;,</span><br><span class="line">		deviceid: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			getDeviceId()</span><br><span class="line">		&#125;,</span><br><span class="line">		httppost: <span class="function"><span class="keyword">function</span>(<span class="params">inputurl</span>)</span>&#123;</span><br><span class="line">			httpPost(inputurl)</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="function"><span class="title">encrypt</span>(<span class="params">inputstr, inputkey</span>)</span>&#123;</span><br><span class="line">			encrypt(inputstr, inputkey)</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="function"><span class="title">decrypt</span>(<span class="params">inputstr, inputkey</span>)</span>&#123;</span><br><span class="line">			decrypt(inputstr, inputkey)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Python调用 cmake.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">bundle = <span class="string">&#x27;com.CMake&#x27;</span></span><br><span class="line"></span><br><span class="line">print(sys.argv[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> codecs.<span class="built_in">open</span>(sys.argv[<span class="number">1</span>], <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    source = f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment">#f = open(s, &#x27;r&#x27;) #打开frida脚本</span></span><br><span class="line"><span class="comment">#source = f.read() #读取frida脚本</span></span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device(<span class="number">1000</span>) <span class="comment">#连接usb设备 1000表示超时</span></span><br><span class="line">pid = device.spawn(bundle) <span class="comment">#启动指定bundleId的app</span></span><br><span class="line">session = device.attach(pid)  <span class="comment">#附加到app</span></span><br><span class="line">script = session.create_script(source) <span class="comment">#创建frida javaScript脚本</span></span><br><span class="line">script.load() <span class="comment">#load脚本到app进程中 这样即注入成功</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#rpc调用</span></span><br><span class="line">rpc = script.exports</span><br><span class="line">rpc.deviceid()</span><br><span class="line">rpc.httppost(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line">rpc.encrypt(<span class="string">&#x27;str1&#x27;</span>, <span class="string">&#x27;key1&#x27;</span>)</span><br><span class="line">rpc.decrypt(<span class="string">&#x27;str2&#x27;</span>, <span class="string">&#x27;key2&#x27;</span>)</span><br><span class="line"></span><br><span class="line">print(rpc.homeDirectory())</span><br><span class="line"></span><br><span class="line">device.resume(pid) <span class="comment">#恢复app运行</span></span><br><span class="line">sys.stdin.read()<span class="comment">#读取打印日志</span></span><br></pre></td></tr></table></figure>

<h4 id="2"><a href="#2" class="headerlink" title="2"></a>2</h4><p>rpc.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//打开URL</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">openURL</span>(<span class="params">url</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> UIApplication = ObjC.classes.UIApplication.sharedApplication();</span><br><span class="line">  <span class="keyword">var</span> toOpen = ObjC.classes.NSURL.URLWithString_(url);</span><br><span class="line">  <span class="keyword">return</span> UIApplication.openURL_(toOpen);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//播放系统声音</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">playSystemSound</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">new</span> NativeFunction(Module.ExportByName(<span class="string">&#x27;AudioToolbox&#x27;</span>,<span class="string">&#x27;AudioServicesPlaySystemSound&#x27;</span>),<span class="string">&#x27;void&#x27;</span>,[<span class="string">&#x27;int&#x27;</span>])(<span class="number">1111</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//导出RPC函数</span></span><br><span class="line">rpc.exports = &#123;</span><br><span class="line">  openUrl: <span class="function"><span class="keyword">function</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">    openURL(url);</span><br><span class="line">  &#125;,</span><br><span class="line">  sound: <span class="function"><span class="title">fucntion</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  	playSystemSound();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>rpc.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  <span class="comment">#附加到目标进程</span></span><br><span class="line">  session = frida.get_usb_device().attach(<span class="string">u&#x27;App Store&#x27;</span>)</span><br><span class="line">  <span class="comment">#读取JS脚本</span></span><br><span class="line">  <span class="keyword">with</span> codecs.<span class="built_in">open</span>(<span class="string">&#x27;./rpc.js&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    souce = f.read()</span><br><span class="line">    </span><br><span class="line">  script = session.create_script(source)</span><br><span class="line">  script.load()</span><br><span class="line">  rpc = script.exports</span><br><span class="line">  rpc.openurl(<span class="string">&quot;https://www.chinapyg.com&quot;</span>);</span><br><span class="line">  rpc.sound()</span><br><span class="line">  session.detach()</span><br></pre></td></tr></table></figure>

<p>本例的JS脚本导出了两个RPC函数，程序启动后执行rpc.py脚本将rpc.js文件注入</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/17/%E9%80%86%E5%90%91-Frida%E6%8B%A6%E6%88%AAsub-xxx%E5%87%BD%E6%95%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/17/%E9%80%86%E5%90%91-Frida%E6%8B%A6%E6%88%AAsub-xxx%E5%87%BD%E6%95%B0/" class="post-title-link" itemprop="url">逆向-Frida拦截sub_xxx函数</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-06-17 14:50:27" itemprop="dateCreated datePublished" datetime="2022-06-17T14:50:27+08:00">2022-06-17</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-06-18 15:43:47" itemprop="dateModified" datetime="2022-06-18T15:43:47+08:00">2022-06-18</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>IDA 里看到的 <code>sub_1000061B4</code>  这种类型的函数是没有符号的，所以 IDA 解析时就显示 <code>sub_1000061B4</code></p>
<p>1000061B4 是 IDA 读取到的函数地址</p>
<p>定义一个函数</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> add(<span class="keyword">int</span> num1, <span class="keyword">int</span> num2) &#123;</span><br><span class="line">    <span class="keyword">int</span> sum = num1 + num2;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    <span class="keyword">int</span> sum = add(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;1+1=%d&quot;</span>, sum);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译后将可执行文件拖入 IDA，显示定义的函数是这种 </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall add(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2) &#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(a1 + a2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先去掉符号 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ strip -x &#x2F;Users&#x2F;xxx&#x2F;Desktop&#x2F;CMake&#x2F;CMake.app&#x2F;CMake</span><br></pre></td></tr></table></figure>

<p>再将可执行文件拖入 IDA</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall sub_1000061B4(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2) &#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(a1 + a2);</span><br><span class="line">&#125;</span><br><span class="line">sub_1000061B4(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="built_in">CFSTR</span>(<span class="string">&quot;1+1=%d&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>编写 Frida 脚本</p>
<p>IDA 上 C 函数偏移地址 0x61B4 </p>
<h4 id="cmake-js"><a href="#cmake-js" class="headerlink" title="cmake.js"></a>cmake.js</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_rva</span>(<span class="params"><span class="built_in">module</span>, offset</span>) </span>&#123;</span><br><span class="line">	<span class="comment">//获取基地址</span></span><br><span class="line">	<span class="keyword">var</span> base_addr = Module.findBaseAddress(<span class="built_in">module</span>)</span><br><span class="line">	<span class="comment">//函数地址 = 基地址+偏移地址</span></span><br><span class="line">	<span class="keyword">var</span> target_addr = base_addr.add(offset) </span><br><span class="line">	<span class="keyword">if</span> (Process.arch == <span class="string">&#x27;arm&#x27;</span>) &#123; <span class="comment">//如果是32位地址+1</span></span><br><span class="line">		<span class="keyword">return</span> target_addr.add(<span class="number">1</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> target_addr</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;\n[*] Starting Hooking&#x27;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">var</span> target_addr = get_rva(<span class="string">&#x27;CMake&#x27;</span>, <span class="number">0x61B4</span>)</span><br><span class="line">	</span><br><span class="line">	Interceptor.attach(ptr(target_addr), &#123;</span><br><span class="line">		onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;onEnter&#x27;</span>);</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;num1: &#x27;</span>+args[<span class="number">0</span>])</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;num2: &#x27;</span>+args[<span class="number">1</span>])</span><br><span class="line">		&#125;, </span><br><span class="line">		onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>) </span>&#123;</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;onLeave&#x27;</span>)</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;Return value: &#x27;</span>+retval)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ python3.8 cmake.py cmake.js</span><br><span class="line"></span><br><span class="line">[*] Starting Hooking</span><br><span class="line">onEnter</span><br><span class="line">num1: 0x1</span><br><span class="line">num2: 0x2</span><br><span class="line">onLeave</span><br><span class="line">Return value: 0x3</span><br></pre></td></tr></table></figure>

<p>可以看到输入 1 + 2 结果 3</p>
<h4 id="cmake-py"><a href="#cmake-py" class="headerlink" title="cmake.py"></a>cmake.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">bundle = <span class="string">&#x27;com.CMake&#x27;</span></span><br><span class="line"></span><br><span class="line">print(sys.argv[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> codecs.<span class="built_in">open</span>(sys.argv[<span class="number">1</span>], <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    source = f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment">#f = open(s, &#x27;r&#x27;) #打开frida脚本</span></span><br><span class="line"><span class="comment">#source = f.read() #读取frida脚本</span></span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device(<span class="number">1000</span>) <span class="comment">#连接usb设备 1000表示超时</span></span><br><span class="line">pid = device.spawn(bundle) <span class="comment">#启动指定bundleId的app</span></span><br><span class="line">session = device.attach(pid)  <span class="comment">#附加到app</span></span><br><span class="line">script = session.create_script(source) <span class="comment">#创建frida javaScript脚本</span></span><br><span class="line">script.load() <span class="comment">#load脚本到app进程中 这样即注入成功</span></span><br><span class="line">device.resume(pid) <span class="comment">#恢复app运行</span></span><br><span class="line">sys.stdin.read()<span class="comment">#读取打印日志</span></span><br></pre></td></tr></table></figure>

























<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42400619/article/details/113385014?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165544788016782184643503%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&request_id=165544788016782184643503&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-6-113385014-null-null.nonecase&utm_term=frida+%E5%AE%9E%E6%88%98&spm=1018.2226.3001.4450">Frida如何拦截sub_xxx函数</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/13/%E9%80%86%E5%90%91-Frida/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/13/%E9%80%86%E5%90%91-Frida/" class="post-title-link" itemprop="url">逆向-Frida</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-06-13 18:26:37" itemprop="dateCreated datePublished" datetime="2022-06-13T18:26:37+08:00">2022-06-13</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-10-21 08:44:04" itemprop="dateModified" datetime="2022-10-21T08:44:04+08:00">2022-10-21</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://frida.re/docs/home/">https://frida.re/docs/home/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.frida.re/docs/javascript-api">https://www.frida.re/docs/javascript-api</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.kanxue.com/article-342.htm">JavaScript API 一</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.kanxue.com/article-414.htm">JavaScript API 二</a></p>
<p><a target="_blank" rel="noopener" href="https://www.dazhuanlan.com/workant/topics/1230751">非越狱环境使用Frida</a>   </p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/86c1ca71e73a">Frida集成到iOS项目</a></p>
<p><a target="_blank" rel="noopener" href="https://codeshare.frida.re/">https://codeshare.frida.re/</a> 中其它共享的脚本， <code>$ frida --codeshare 脚本路径 -f YOUR_BINARY </code> 将其加载进来</p>
<p>Frida 跨平台的轻量级 Hook 框架，基于Python和JavaScript</p>
<p>使用 Frida 可以获取进程详细信息、拦截和调用指定函数、注入代码、修改参数、从iOS应用程序中dump类和类方法信息等</p>
<h4 id="Frida-安装"><a href="#Frida-安装" class="headerlink" title="Frida 安装"></a>Frida 安装</h4><ul>
<li>iOS 端</li>
</ul>
<p>Cydia 添加源 <a target="_blank" rel="noopener" href="https://build.frida.re/">https://build.frida.re/</a> 安装 Frida for A12+ devices，最新版本 14.2.13</p>
<ul>
<li>macOS 端</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo pip3 install frida</span><br><span class="line">$ sudo pip3 install frida-tools</span><br><span class="line">$ frida --version</span><br><span class="line">#升级</span><br><span class="line">$ sudo pip3 install frida --upgrade</span><br><span class="line">$ sudo pip3 install frida-tools --upgrade</span><br><span class="line"></span><br><span class="line">frida                 15.1.3</span><br><span class="line">frida-tools           10.6.2</span><br></pre></td></tr></table></figure>

<h4 id="Frida"><a href="#Frida" class="headerlink" title="Frida"></a>Frida</h4><p>frada-tools 里面还提供了五个使用工具：frida-discover、frida-kill、friaa-ls-devices、frida-ps 以及 frida-trace</p>
<p><code>.bash_profile</code> 添加环境变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">export frida-discover&#x3D;&#39;&#x2F;Library&#x2F;Frameworks&#x2F;Python.framework&#x2F;Versions&#x2F;3.8&#x2F;bin&#x2F;frida-discover&#39;</span><br><span class="line">export frida-kill&#x3D;&#39;&#x2F;Library&#x2F;Frameworks&#x2F;Python.framework&#x2F;Versions&#x2F;3.8&#x2F;bin&#x2F;frida-kill&#39;</span><br><span class="line">export frida-trace&#x3D;&#39;&#x2F;Library&#x2F;Frameworks&#x2F;Python.framework&#x2F;Versions&#x2F;3.8&#x2F;bin&#x2F;frida-trace&#39;</span><br><span class="line">export frida-ps&#x3D;&#39;&#x2F;Library&#x2F;Frameworks&#x2F;Python.framework&#x2F;Versions&#x2F;3.8&#x2F;bin&#x2F;frida-ps&#39;</span><br><span class="line">export frida-ls-devices&#x3D;&#39;&#x2F;Library&#x2F;Frameworks&#x2F;Python.framework&#x2F;Versions&#x2F;3.8&#x2F;bin&#x2F;frida-ls-devices&#39;</span><br></pre></td></tr></table></figure>



<p>这些工具都是基于 Frida 的 Python 接口实现的</p>
<p>使用帮助 <a target="_blank" rel="noopener" href="https://frida.re/docs/home/">https://frida.re/docs/home/</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ which frida</span><br><span class="line">&#x2F;Library&#x2F;Frameworks&#x2F;Python.framework&#x2F;Versions&#x2F;3.8&#x2F;bin&#x2F;frida</span><br></pre></td></tr></table></figure>

<h5 id="获取可用设备列表"><a href="#获取可用设备列表" class="headerlink" title="获取可用设备列表"></a>获取可用设备列表</h5><p>frida-ls-devices 获取到 id 之后就可以在 frida-ps 等工具中使用了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># &#x2F;Library&#x2F;Frameworks&#x2F;Python.framework&#x2F;Versions&#x2F;3.8&#x2F;bin 目录</span><br><span class="line">$ frida-ls-devices</span><br><span class="line">Id                                        Type    Name</span><br><span class="line">----------------------------------------  ------  ------------</span><br><span class="line">local                                     local   Local System</span><br><span class="line">4ce52917e9a0932f3c821e2418a03d2a993c5650  usb     iPhone</span><br><span class="line">socket                                    remote  Local Socket</span><br></pre></td></tr></table></figure>

<h5 id="获取设备进程列表"><a href="#获取设备进程列表" class="headerlink" title="获取设备进程列表"></a>获取设备进程列表</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ frida-ps --help</span><br><span class="line">-U	连接到USB设备</span><br><span class="line">-D  如果有多个USB设备，可以用该选项指定设备UDID</span><br><span class="line">-R&#x2F;-H 连接到远程frida-server,主要用于远程调试</span><br><span class="line">-a  仅显示正在运行的应用</span><br><span class="line">-i  显示所有已安装的应用</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#连接到设备查看进程列表</span><br><span class="line">$ frida-ps -U </span><br><span class="line"> 845      ASPCarryLog</span><br><span class="line">1032      AppNotification</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">#连接到设备查看正在运行的应用</span><br><span class="line">$ frida-ps -U -a</span><br><span class="line">或者</span><br><span class="line">$ frida-ps -Ua</span><br><span class="line"></span><br><span class="line">#指定查看某个设备</span><br><span class="line">$ frida-ps -D 00008030-001C19C12281802E</span><br></pre></td></tr></table></figure>

<h5 id="结束设备上某个进程"><a href="#结束设备上某个进程" class="headerlink" title="结束设备上某个进程"></a>结束设备上某个进程</h5><p>frida-kill</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ frida-kill -U &lt;PID&gt;&#x2F;&lt;Name&gt;</span><br><span class="line">$ frida-kill -D &lt;DEVICE-ID&gt; &lt;PID&gt;&#x2F;&lt;Name&gt;</span><br><span class="line"></span><br><span class="line">$ frida-kill -U 2441</span><br><span class="line">$ frida-kill -U 微信</span><br></pre></td></tr></table></figure>

<h4 id="跟踪函数-方法调用-frida-trace"><a href="#跟踪函数-方法调用-frida-trace" class="headerlink" title="跟踪函数/方法调用 frida-trace"></a>跟踪函数/方法调用 frida-trace</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ frida-trace -h</span><br></pre></td></tr></table></figure>

<h5 id="跟踪函数调用"><a href="#跟踪函数调用" class="headerlink" title="跟踪函数调用"></a>跟踪函数调用</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ frida-trace -U -i compress -i &quot;recv*&quot; -x &quot;recvmsg*&quot; -x recvfrom 微信</span><br><span class="line"></span><br><span class="line">跟踪名为compress的函数和recv开头的函数</span><br><span class="line">排除recvmsg开头的函数和名为recvfrom的函数，模糊匹配内容要用双引号</span><br><span class="line"></span><br><span class="line">-i 表示包含某个函数</span><br><span class="line">-x 表示排查某个函数，都支持模糊匹配，可以组合使用</span><br><span class="line">命令执行后会生成基本JS文件，仅输出一些日志，开发者可以根据需要修改它们</span><br></pre></td></tr></table></figure>

<p>上面是附加到目标进程再操作，如果要强制启动进程进行跟踪，可以使用 -f 选项加上 BundleID</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ frida-trace -U -f com.tencent.xin -i compress -i &quot;recv*&quot; -x &quot;recvmsg*&quot; -x recvfrom</span><br></pre></td></tr></table></figure>

<p>跟踪后，在当前目录会生成一个<code> __handlers__</code> 文件夹，里面就是 frida-trace 自动生成的 js 脚本文件</p>
<img src="逆向-Frida/frida-trace.png" alt="frida-trace" style="zoom:80%;" />

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//跟踪函数调用后会生成对应跟踪函数的 js 文件</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="title">onEnter</span>(<span class="params">log, args, state</span>)</span> &#123;</span><br><span class="line">    log(<span class="string">`+[LCdes encryptUseDES:<span class="subst">$&#123;args[<span class="number">2</span>]&#125;</span> key:<span class="subst">$&#123;args[<span class="number">3</span>]&#125;</span>]`</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">onLeave</span>(<span class="params">log, retval, state</span>)</span> &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>frida-trace 启动时不会覆盖已有脚本文件，所以可以随时修改这些 JS 文件来添加自己的功能</p>
<h5 id="跟踪OC方法调用"><a href="#跟踪OC方法调用" class="headerlink" title="跟踪OC方法调用"></a>跟踪OC方法调用</h5><p>-m 表示包含某个方法</p>
<p>-M 表示排除某个方法，支持模糊匹配，可以组合使用</p>
<img src="逆向-Frida/图片 2.png" alt="图片 2" style="zoom:80%;" />

<h5 id="跟踪导出函数"><a href="#跟踪导出函数" class="headerlink" title="跟踪导出函数"></a>跟踪导出函数</h5><p>-I 表示包含某个模块</p>
<p>-X 表示排除某个模块，支持模糊匹配，可以混合使用</p>
<p>![图片 3](逆向-Frida/图片 3.png)</p>
<h5 id="跟踪导入函数"><a href="#跟踪导入函数" class="headerlink" title="跟踪导入函数"></a>跟踪导入函数</h5><p>-t 表示包含某个模块</p>
<p>-T 表示包含主程序</p>
<p>![图片 4](逆向-Frida/图片 4.png)</p>
<h5 id="跟踪偏移地址"><a href="#跟踪偏移地址" class="headerlink" title="跟踪偏移地址"></a>跟踪偏移地址</h5><p>-a 添加模块内偏移地址的监控，”MODULE!OFFSET“</p>
<p>由于 macOS 终端会把 ！转义，所以需要输入 <code>\!</code> 才能正常使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#对Aweme模块中偏移地址为0x2A65CCC的函数进行追踪</span><br><span class="line">$ frida-trace -U -f com.ss.iphone.ugc.Aweme -a Aweme\!2A65CCC</span><br></pre></td></tr></table></figure>

<h5 id="跟踪调用栈"><a href="#跟踪调用栈" class="headerlink" title="跟踪调用栈"></a>跟踪调用栈</h5><p>利用 Frida 可以非常方便跟踪某个方法的调用栈，只需要在 JS 里面添加下面代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log(<span class="string">&#x27;\tBacktrace:\n\t&#x27;</span> + Thread.backtrace(<span class="built_in">this</span>.context, Backtracer.ACCURATE).map(DebugSymbol.fromAddress).join(<span class="string">&#x27;\n\t&#x27;</span>));</span><br></pre></td></tr></table></figure>

<h4 id="进入交互模式"><a href="#进入交互模式" class="headerlink" title="进入交互模式"></a>进入交互模式</h4><p>进入交互模式两种方法</p>
<ul>
<li>通过应用名或PID附加</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ frida -U 微信</span><br><span class="line">$ frida -U -p PID</span><br></pre></td></tr></table></figure>

<ul>
<li>直接启动进程</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ frida -U -f com.tencent.xin</span><br><span class="line">#或者不中断应用程序启动</span><br><span class="line">$ frida -U -f com.tencent.xin --no-pause</span><br></pre></td></tr></table></figure>

<p>进入交互模式后就可以访问目标进程的所有属性、方法</p>
<h4 id="Frida使用"><a href="#Frida使用" class="headerlink" title="Frida使用"></a>Frida使用</h4><h5 id="加载脚本"><a href="#加载脚本" class="headerlink" title="加载脚本"></a>加载脚本</h5><p>越狱英文名 JailBroke 或 JailBreak，使用关键词 jail 对当前进程的所有类及方法进行检索。</p>
<p>Frida 提供的 JavaScript API 里面，由 <code>ObjC.classes</code> 能得到当前应用中所有已经注册的类，对它进行遍历就可以得到符合要求的类名</p>
<p>写一段JS代码</p>
<p><code>ObjC.classes.XXXClass.$methods</code> 就可以得到 XXXClass 类的所有方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//筛选符合要求的类及方法</span></span><br><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">var</span> className <span class="keyword">in</span> ObjC.classes) &#123;</span><br><span class="line">		<span class="keyword">if</span> (className.toLowerCase().indexOf(<span class="string">&#x27;jail&#x27;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;[#]ClassName--------&gt;&#x27;</span> + className)</span><br><span class="line"></span><br><span class="line">			<span class="keyword">var</span> methods = <span class="built_in">eval</span>(<span class="string">&#x27;ObjC.classes.&#x27;</span> + className + <span class="string">&#x27;.$methods&#x27;</span>) <span class="comment">//类中所有方法</span></span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; methods.length; i++) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="keyword">if</span> (methods[i].toLowerCase().indexOf(<span class="string">&#x27;jail&#x27;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">						<span class="built_in">console</span>.log(<span class="string">&#x27;[-]&#x27;</span> + methods[i])</span><br><span class="line">					&#125;</span><br><span class="line">				&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">					<span class="built_in">console</span>.log(<span class="string">&#x27;[!] Exception:&#x27;</span> + err.message)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>两种方法加载。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#-l 选项加载脚本</span><br><span class="line">$ frida -U -l WeChat.js 微信</span><br><span class="line"></span><br><span class="line">#或者</span><br><span class="line">#进入交互界面后使用%load 手动加载脚本</span><br><span class="line">[iPhone::微信]-&gt; %load path&#x2F;to&#x2F;WeChat.js</span><br><span class="line"></span><br><span class="line">#结果</span><br><span class="line">Attaching...</span><br><span class="line">[#]ClassName--------&gt;JailBreakHelper</span><br><span class="line">[-]+ getJailbreakRootDir</span><br><span class="line">[-]+ getJailbreakPath</span><br><span class="line">[-]+ JailBroken</span><br><span class="line">[-]- IsJailBreak</span><br><span class="line">[-]- HasInstallJailbreakPlugin:</span><br></pre></td></tr></table></figure>

<p>从输出信息可以看到一个 JailBreakHelper 类</p>
<h5 id="拦截函数参数返回值"><a href="#拦截函数参数返回值" class="headerlink" title="拦截函数参数返回值"></a>拦截函数参数返回值</h5><p>Frida 提供的 JavaScript API 里面有一个 <code>Interceptor</code> 拦截器，将它附加到某个函数后，可以在调用前和调用后分别进行拦截，以获取函数的参数和返回值</p>
<p>编写脚本</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjC.available) &#123; <span class="comment">//判断Object-C类方法是否已经加载进来</span></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">var</span> className = <span class="string">&#x27;JailBreakHelper&#x27;</span>;</span><br><span class="line">		<span class="keyword">var</span> methodNames = [<span class="string">&#x27;+ JailBroken&#x27;</span>, <span class="string">&#x27;- IsJailBreak&#x27;</span>];</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">var</span> index <span class="keyword">in</span> methodNames) &#123;</span><br><span class="line">			<span class="keyword">var</span> methodName = methodNames[index];</span><br><span class="line">			<span class="keyword">var</span> hook = <span class="built_in">eval</span>(<span class="string">&#x27;ObjC.classes.&#x27;</span> + className + <span class="string">&#x27;[&quot;&#x27;</span> + methodName + <span class="string">&#x27;&quot;]&#x27;</span>);</span><br><span class="line">			<span class="comment">//或者 var hook = ObjC.classes[class_name][method_name] 比较清楚</span></span><br><span class="line">      </span><br><span class="line">			Interceptor.attach(hook.implementation,&#123;</span><br><span class="line">				onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">					<span class="built_in">console</span>.log(<span class="string">&#x27;===onEnter===&#x27;</span>);</span><br><span class="line">					<span class="built_in">console</span>.log(<span class="string">&#x27;className:&#x27;</span> + className);</span><br><span class="line">					<span class="built_in">console</span>.log(<span class="string">&#x27;Method Name:&#x27;</span> + methodName);</span><br><span class="line">					<span class="built_in">console</span>.log(<span class="string">&#x27;======&#x27;</span>);</span><br><span class="line">				&#125;,</span><br><span class="line">				onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>) </span>&#123;</span><br><span class="line">					<span class="built_in">console</span>.log(<span class="string">&#x27;===onLeave===&#x27;</span>);</span><br><span class="line">					<span class="built_in">console</span>.log(<span class="string">&#x27;className:&#x27;</span> + className);</span><br><span class="line">					<span class="built_in">console</span>.log(<span class="string">&#x27;Method Name:&#x27;</span> + methodName);</span><br><span class="line">					<span class="built_in">console</span>.log(<span class="string">&#x27;\t[-] Return Value:&#x27;</span> + retval);</span><br><span class="line">					<span class="built_in">console</span>.log(<span class="string">&#x27;======&#x27;</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;[!] Exception:&#x27;</span> + err.message);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击微信的支付处方方法，打印结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;&#x3D;onEnter&#x3D;&#x3D;&#x3D;</span><br><span class="line">className:JailBreakHelper</span><br><span class="line">Method Name:- IsJailBreak</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;&#x3D;onLeave&#x3D;&#x3D;&#x3D;</span><br><span class="line">className:JailBreakHelper</span><br><span class="line">Method Name:- IsJailBreak</span><br><span class="line">        [-] Return Value:0x1</span><br></pre></td></tr></table></figure>

<p>onEnter 和 onLeave 是两个回调函数，分别处理原始方法调用前和后的逻辑。</p>
<p>Frida 支持脚本热更新，当 JS 文件被修改并保存后，能够实时生效</p>
<p>修改脚本将返回值改成NO</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		Interceptor.attach(ObjC.classes.JailBreakHelper[<span class="string">&#x27;- IsJailBreak&#x27;</span>].implementation, &#123;</span><br><span class="line">			onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>) </span>&#123;</span><br><span class="line">				<span class="built_in">console</span>.log(<span class="string">&#x27;return = NO&#x27;</span>);</span><br><span class="line">				retval.replace(ptr(<span class="number">0x0</span>));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;[!] Exception:&#x27;</span> + err.message);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="JS脚本"><a href="#JS脚本" class="headerlink" title="JS脚本"></a>JS脚本</h4><h5 id="打印参数"><a href="#打印参数" class="headerlink" title="打印参数"></a>打印参数</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;0--: &#x27;</span> + ObjC.Object(args[<span class="number">0</span>]).toString())</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;arg[2] -&gt;&quot;</span> + <span class="keyword">new</span> ObjC.Object(args[<span class="number">2</span>]))</span><br></pre></td></tr></table></figure>

<p>如果变量类型不确定，可以使用如下代码确定类型</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;Type of args[2] -&gt; &quot;</span> + <span class="keyword">new</span> ObjC.Object(args[<span class="number">2</span>]).$className)</span><br></pre></td></tr></table></figure>

<h5 id="常用数据类型转换"><a href="#常用数据类型转换" class="headerlink" title="常用数据类型转换"></a>常用数据类型转换</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//NSData转String</span></span><br><span class="line"><span class="keyword">var</span> data = <span class="keyword">new</span> ObjC.Object(args[<span class="number">2</span>]);</span><br><span class="line">Memory.readUtf8String(data.bytes(), data.length());</span><br><span class="line"></span><br><span class="line"><span class="comment">//NSData转二进制数据</span></span><br><span class="line"><span class="keyword">var</span> data = <span class="keyword">new</span> ObjC.Object(args[<span class="number">2</span>]);</span><br><span class="line">Memory.readByteArray(data.bytes(), data.length());</span><br><span class="line"></span><br><span class="line"><span class="comment">//遍历NSArray</span></span><br><span class="line"><span class="keyword">var</span> array = <span class="keyword">new</span> ObjC.Object(args[<span class="number">2</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Be sure to use valueOf() as NSUInteger is a Number in</span></span><br><span class="line"><span class="comment"> * 32-bit processes, and UInt64 in 64-bit processes. This</span></span><br><span class="line"><span class="comment"> * coerces it into a Number in the latter case.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> count = array.count().valueOf();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i !== count; i++) &#123;</span><br><span class="line">  <span class="keyword">var</span> element = array.objectAtIndex_(i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//遍历NSDictionary</span></span><br><span class="line"><span class="keyword">var</span> dict = <span class="keyword">new</span> ObjC.Object(args[<span class="number">2</span>]);</span><br><span class="line"><span class="keyword">var</span> enumerator = dict.keyEnumerator();</span><br><span class="line"><span class="keyword">var</span> key;</span><br><span class="line"><span class="keyword">while</span> ((key = enumerator.nextObject()) !== <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> value = dict.objectForKey_(key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> param_dict = ObjC.classes.NSMutableDictionary.alloc().init();</span><br><span class="line">param_dict.setObject_forKey_(body,<span class="string">&quot;body&quot;</span>);</span><br><span class="line"></span><br><span class="line">NSArray *arr3 = [NSArray arrayWithObjects:@<span class="string">&quot;one&quot;</span>,@<span class="string">&quot;two&quot;</span>,@<span class="number">1</span>, nil];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> param_Key_Array = ObjC.classes.NSMutableArray.arrayWithObject_(sBody);</span><br><span class="line">param_Key_Array.addObject_(sClient);</span><br><span class="line">param_Key_Array.addObject_(sClientVersion);</span><br><span class="line">param_Key_Array.addObject_(sFunctionId);</span><br><span class="line">param_Key_Array.addObject_(sOpenudid);</span><br><span class="line"></span><br><span class="line"><span class="comment">//读一个结构体</span></span><br><span class="line">Memory.readU32(args[<span class="number">0</span>].add(<span class="number">4</span>));</span><br></pre></td></tr></table></figure>

<h5 id="常用脚本"><a href="#常用脚本" class="headerlink" title="常用脚本"></a>常用脚本</h5><ul>
<li>枚举所有类</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> className <span class="keyword">in</span> ObjC.classes) &#123;</span><br><span class="line">  <span class="keyword">if</span> (ObjC.classes.hasOwnProperty(className)) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(className);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>枚举一个类的所有method</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> className = <span class="string">&quot;NSURL&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> methods = <span class="built_in">eval</span>(<span class="string">&#x27;ObjC.classes.&#x27;</span> + className + <span class="string">&#x27;.$methods&#x27;</span>); <span class="comment">//一个类的所有方法</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; methods.length; i++) &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (methods[i].indexOf(<span class="string">&quot;fileURLWithPath&quot;</span>) &gt; -<span class="number">1</span>)</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;[-] &quot;</span>+methods[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="title">catch</span>(<span class="params">err</span>)</span> &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;[!] Exception1: &quot;</span> + err.message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">catch</span>(<span class="params">err</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;[!] Exception2: &quot;</span> + err.message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>打印调用栈</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">log, args, state</span>) </span>&#123;</span><br><span class="line">    log(<span class="string">&#x27;\tBacktrace:\n\t&#x27;</span> + Thread.backtrace(<span class="built_in">this</span>.context,Backtracer.ACCURATE).map(DebugSymbol.fromAddress).join(<span class="string">&#x27;\n\t&#x27;</span>));</span><br><span class="line">  &#125;,</span><br><span class="line">  onLeave: <span class="function"><span class="keyword">function</span> (<span class="params">log, retval, state</span>) </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>hook 一个method</li>
</ul>
<blockquote>
<p>打印参数注意</p>
<p>args[0]：self</p>
<p>args[1]：The selector (openURL:)</p>
<p>args[2]：The first param</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjC.available)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> className = <span class="string">&quot;JailbreakDetectionVC&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> funcName = <span class="string">&quot;- isJailbroken&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> hook = <span class="built_in">eval</span>(<span class="string">&#x27;ObjC.classes.&#x27;</span> + className + <span class="string">&#x27;[&quot;&#x27;</span> + funcName + <span class="string">&#x27;&quot;]&#x27;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;[*] Class Name: &quot;</span> + className);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;[*] Method Name: &quot;</span> + funcName);</span><br><span class="line">        Interceptor.attach(hook.implementation, &#123;</span><br><span class="line">          onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;aaaa&quot;</span>);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;param:&quot;</span>+args[<span class="number">2</span>]+<span class="string">&quot; type:&quot;</span>+<span class="keyword">typeof</span> args[<span class="number">2</span>]);</span><br><span class="line">          &#125;,</span><br><span class="line">          onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;Return value-&gt; (type:&quot;</span>+<span class="keyword">typeof</span> retval+<span class="string">&quot;,value:&quot;</span>+retval+<span class="string">&quot;)&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//修改返回值</span></span><br><span class="line">            newretval = ptr(<span class="string">&quot;0x0&quot;</span>)</span><br><span class="line">            retval.replace(newretval)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(err)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;[!] Exception2: &quot;</span> + err.message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="调用函数"><a href="#调用函数" class="headerlink" title="调用函数"></a>调用函数</h5><ul>
<li>函数名以”+”开头的，如：“+ URLWithString:”，可以直接通过类名调用方法，相当于java中的static函数</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ObjC.classes.NSString.stringWithString_(<span class="string">&quot;MacOS&quot;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>函数名以“-”开头的需要找到一个实例化的对象，然后再调用方法</li>
</ul>
<p>1、如果内存中没有这样的对象<br>这种情况需要手动生成一个实例,用法为ObjC.classes.类名.alloc()</p>
<p>2、如果内存中存在实例化后的对象<br>这种情况需要先找出一个类的实例,使用var tmp=ObjC.chooseSync(ObjC.classes.类名),例如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ObjC.chooseSync(ObjC.classes.PARSHealthPedometer10thHomeViewController)[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>

<p>其中[0]表示取找到的实例中的第一个实例,可根据实际情况换成其他的实例。<br>调用函数时，以my_obj <code>- requestUploadWithSure</code> 的函数，如果有参数直接附在括号中</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//var my_obj=ObjC.chooseSync(ObjC.classes.PARSHealthPedometer10thHomeViewController)[0]</span></span><br><span class="line">        <span class="keyword">var</span> my_obj=ObjC.classes.PARSHealthPedometer10thHomeViewController.alloc()</span><br><span class="line">        my_obj[<span class="string">&quot;- requestUploadWithSure:&quot;</span>](<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">catch</span>(<span class="params">err</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;[!] Exception2: &quot;</span> + err.message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Objective-C Runtime is not available!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">console.log(<span class="string">&quot;init success&quot;</span>);</span><br><span class="line">function SendTextMessage(wxid, msg) &#123;</span><br><span class="line">    var message = ObjC.chooseSync(ObjC.classes.MessageService)[<span class="number">0</span>]</span><br><span class="line">    var username = ObjC.classes.CUtility.GetCurrentUserName();</span><br><span class="line">    console.log(username)</span><br><span class="line">    console.log(<span class="string">&quot;Type of arg[0] -&gt; &quot;</span> + message)</span><br><span class="line">    var toUsrName = ObjC.classes.NSString.stringWithString_(wxid);</span><br><span class="line">    var msgText = ObjC.classes.NSString.stringWithString_(msg);</span><br><span class="line">    message[<span class="string">&quot;- SendTextMessage:toUsrName:msgText:atUserList:&quot;</span>](username, toUsrName, msgText, null);</span><br><span class="line">&#125;</span><br><span class="line">SendTextMessage(<span class="string">&quot;filehelper&quot;</span>,<span class="string">&quot;主动调用发送信息！&quot;</span>)</span><br></pre></td></tr></table></figure>







<h4 id="Python-交互"><a href="#Python-交互" class="headerlink" title="Python 交互"></a>Python 交互</h4><p>Frida 提供了 Python 和 JS 脚本的交互</p>
<h5 id="获取设备"><a href="#获取设备" class="headerlink" title="获取设备"></a>获取设备</h5><p>DeviceManager 类获取设备信息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 获取设备管理器</span></span><br><span class="line">    deviceManager = frida.get_device_manager()</span><br><span class="line">    <span class="comment"># 枚举所有连接的设备</span></span><br><span class="line">    print(deviceManager.enumerate_devices())</span><br><span class="line">    <span class="comment"># 根据UDID获取设备</span></span><br><span class="line">    print(deviceManager.get_device(<span class="string">&#x27;00008030-001C19C12281802E&#x27;</span>))</span><br><span class="line">    <span class="comment"># 获取当前连接设备</span></span><br><span class="line">    print(deviceManager.get_usb_device())</span><br><span class="line"></span><br><span class="line"><span class="comment">#输出 </span></span><br><span class="line"><span class="comment">#[Device(id=&quot;local&quot;, name=&quot;Local System&quot;, type=&#x27;local&#x27;), Device(id=&quot;socket&quot;, name=&quot;Local Socket&quot;, type=&#x27;remote&#x27;), Device(id=&quot;00008030-001C19C12281802E&quot;, name=&quot;iPhone&quot;, type=&#x27;usb&#x27;)]</span></span><br><span class="line"><span class="comment">#Device(id=&quot;00008030-001C19C12281802E&quot;, name=&quot;iPhone&quot;, type=&#x27;usb&#x27;)</span></span><br><span class="line"><span class="comment">#Device(id=&quot;00008030-001C19C12281802E&quot;, name=&quot;iPhone&quot;, type=&#x27;usb&#x27;)</span></span><br></pre></td></tr></table></figure>

<h5 id="附加进程"><a href="#附加进程" class="headerlink" title="附加进程"></a>附加进程</h5><p>attach() 附加目标进程，返回一个 Session 实例，参数支持进程名和PID</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">from</span> frida.core <span class="keyword">import</span> Device</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    device = frida.get_usb_device() <span class="comment"># type: Device</span></span><br><span class="line">    session = device.attach(<span class="string">u&#x27;微信&#x27;</span>)</span><br><span class="line">    print(session)</span><br><span class="line">    </span><br><span class="line"><span class="comment">#Session(pid=3608)</span></span><br></pre></td></tr></table></figure>

<h5 id="启动进程"><a href="#启动进程" class="headerlink" title="启动进程"></a>启动进程</h5><p>spawn() 启动进程，此时进程处于挂起状态，需要配合 resume() 才能唤醒，这时还可以使用 attach() 附加上去</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">from</span> frida.core <span class="keyword">import</span> Device</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    device = frida.get_usb_device() <span class="comment"># type: Device</span></span><br><span class="line">    pid = device.spawn(<span class="string">&#x27;com.tencent.xin&#x27;</span>)</span><br><span class="line">    <span class="comment">#session = device.attach(pid)</span></span><br><span class="line">    device.resume(pid)</span><br></pre></td></tr></table></figure>

<p>device.spawn()  允许带参数执行，下面代码传入 url 参数后会启动 Safari 并打开网站</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pid &#x3D; device.spawn(&#39;com.apple.mobilesafari&#39;, url&#x3D;&quot;https:&#x2F;&#x2F;www.chinapyg.com&quot;)</span><br></pre></td></tr></table></figure>

<h5 id="脱离进程"><a href="#脱离进程" class="headerlink" title="脱离进程"></a>脱离进程</h5><p>得到 Session 并操作完毕后，需要使用 detach() 脱离进程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session.detach()</span><br></pre></td></tr></table></figure>

<h5 id="注入JS脚本"><a href="#注入JS脚本" class="headerlink" title="注入JS脚本"></a>注入JS脚本</h5><p>得到Session就可以使用 create_script() 创建一个脚本对象，然后调用 load() 方法将脚本载入。此时 python 的任务完成，主要工作就交给 JS 了</p>
<ul>
<li>枚举指定进程的所有模块信息</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">from</span> frida.core <span class="keyword">import</span> Device</span><br><span class="line"><span class="keyword">from</span> frida.core <span class="keyword">import</span> Session</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">enumerateModules</span>(<span class="params">target_process</span>):</span></span><br><span class="line">    session = frida.get_usb_device().attach(target_process) <span class="comment"># type: Session</span></span><br><span class="line">    script = session.create_script(</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Process.enumerateModules(&#123;</span></span><br><span class="line"><span class="string">        onMatch: function(module) &#123;</span></span><br><span class="line"><span class="string">            console.log(&#x27;Module name:&#x27; + module.name + &#x27;-&#x27; + &#x27;Base Address:&#x27; + module.base);</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        onComplete: function() &#123;&#125;</span></span><br><span class="line"><span class="string">    &#125;)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    )</span><br><span class="line">    script.load()</span><br><span class="line">    session.detach()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    enumerateModules(<span class="string">&#x27;微信&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>可以将JS脚本嵌套在Python源文件中，也可以将JS保存到专门文件中再读取</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> codecs  </span><br><span class="line">...</span><br><span class="line"><span class="keyword">with</span> codecs.<span class="built_in">open</span>(<span class="string">&#x27;./WeChat.js&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">   source = f.read()</span><br><span class="line">script = session.create_script(source)</span><br></pre></td></tr></table></figure>

<ul>
<li>获取应用沙河路径</li>
</ul>
<img src="逆向-Frida/图片 6.png" alt="图片 6" style="zoom:80%;" />

<h6 id="Python与JS交互传值"><a href="#Python与JS交互传值" class="headerlink" title="Python与JS交互传值"></a>Python与JS交互传值</h6><ul>
<li>获取指定进程的指定模块信息</li>
</ul>
<p>上面JS脚本都是不需要传递参数，需要参数时，Python与JS如何交互</p>
<p>Script 类可以设置回调函数，用来处理JS端传来的消息；JS端设置 recv() 的回调来接收Python端的消息</p>
<img src="逆向-Frida/图片 7.png" alt="图片 7" style="zoom:40%;" />

<img src="逆向-Frida/图片 8.png" alt="图片 8" style="zoom:90%;" />

<img src="逆向-Frida/图片 9.png" alt="图片 9" style="zoom:80%;" />

<p>g_event是保证同步的，Python端使用script.post()将参数发送出去之后就调用g_event.wait()进入等待状态，当JS处理完成后，会将status设为“success”，再使用send()发送给Python端设置的on_message()回调，最终在payload_message()函数中完成逻辑处理，当识别到status为“success”后，调用g_event.set()使主线程继续执行</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//通用hook</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hookClassMethod</span>(<span class="params">classname, methodname, infotip</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">var</span> hooking = ObjC.classes[classname][methodname]</span><br><span class="line">			Interceptor.attach(hooking.implementation,&#123;</span><br><span class="line">			onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">				<span class="comment">//args[0]:self</span></span><br><span class="line">				<span class="comment">//args[1]:The selector</span></span><br><span class="line">				<span class="comment">//args[2]:方法的第一个参数开始</span></span><br><span class="line">				<span class="built_in">console</span>.log(<span class="string">&#x27;\n&#x27;</span> + infotip + <span class="string">&#x27; Hook Success&#x27;</span>)</span><br><span class="line">				<span class="built_in">this</span>.class_name  = ObjC.Object(args[<span class="number">0</span>]).toString()</span><br><span class="line">				<span class="built_in">this</span>.method_name = ObjC.selectorAsString(args[<span class="number">1</span>])</span><br><span class="line">				<span class="built_in">console</span>.log(<span class="string">&#x27;\t[-] &#x27;</span> + <span class="string">&#x27;onEnter args[0] class_name: &#x27;</span> + <span class="built_in">this</span>.class_name)</span><br><span class="line">				<span class="built_in">console</span>.log(<span class="string">&#x27;\t[-] &#x27;</span> + <span class="string">&#x27;onEnter args[1] method_name: &#x27;</span> + <span class="built_in">this</span>.method_name)</span><br><span class="line">			&#125;,</span><br><span class="line">			onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;</span><br><span class="line">				<span class="built_in">console</span>.log(<span class="string">&#x27;\t[-]Return value: &#x27;</span>)</span><br><span class="line">				<span class="comment">//返回值类型</span></span><br><span class="line">				<span class="keyword">var</span> typeValue = <span class="built_in">Object</span>.prototype.toString.call(retval)</span><br><span class="line">				<span class="built_in">console</span>.log(<span class="string">&#x27;\t[-] Type of return value: &#x27;</span> + typeValue)</span><br><span class="line">				<span class="built_in">console</span>.log(<span class="string">&#x27;\t[-] Return value: &#x27;</span>, retval)</span><br><span class="line">				<span class="built_in">console</span>.log(<span class="string">&#x27;\t[-] &#x27;</span> + <span class="string">&#x27;返回值: &#x27;</span> + ObjC.Object(retval).toString())</span><br><span class="line"></span><br><span class="line">                send(&#123;<span class="attr">msg</span>: ObjC.Object(retval).toString()&#125;)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;<span class="function"><span class="title">catch</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&quot;\t[!] &quot;</span> + infotip + <span class="string">&quot; Exception: &quot;</span> + err.message);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handle_py_message</span>(<span class="params">message</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;接收到python发送的消息&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> (message[<span class="string">&#x27;cmd&#x27;</span>] == <span class="string">&#x27;cmd111&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">//根据cmd调用js方法</span></span><br><span class="line">        <span class="built_in">console</span>.log(message[<span class="string">&#x27;cmd&#x27;</span>])</span><br><span class="line">    &#125;</span><br><span class="line">    send(&#123;<span class="attr">status</span>: <span class="string">&#x27;success&#x27;</span>&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ObjC.available) &#123; <span class="comment">//OC类加载完成</span></span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;\n[*] Starting Hooking&#x27;</span>)</span><br><span class="line">	hookClassMethod(<span class="string">&#x27;SGSCorpusPageView&#x27;</span>, <span class="string">&#x27;- pageDataList&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>)</span><br><span class="line">	recv(handle_py_message)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">bundle = <span class="string">&#x27;com.sogou.sogouinput&#x27;</span></span><br><span class="line"></span><br><span class="line">g_event = threading.Event()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">payload_message</span>(<span class="params">payload</span>):</span></span><br><span class="line">	<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">	处理消息逻辑</span></span><br><span class="line"><span class="string">	:param payload:</span></span><br><span class="line"><span class="string">	:return:</span></span><br><span class="line"><span class="string">	&#x27;&#x27;&#x27;</span></span><br><span class="line">	<span class="keyword">if</span> <span class="string">&#x27;msg&#x27;</span> <span class="keyword">in</span> payload:</span><br><span class="line">		print(payload[<span class="string">&#x27;msg&#x27;</span>])</span><br><span class="line">	<span class="keyword">if</span> <span class="string">&#x27;status&#x27;</span> <span class="keyword">in</span> payload:</span><br><span class="line">		<span class="keyword">if</span> payload[<span class="string">&#x27;status&#x27;</span>] == <span class="string">&#x27;success&#x27;</span>:</span><br><span class="line">			<span class="comment">#调用g_event.set()使主线程继续执行</span></span><br><span class="line">			g_event.<span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_js_message</span>(<span class="params">message, data</span>):</span></span><br><span class="line">	<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">	接收到JS消息</span></span><br><span class="line"><span class="string">	&#123;&#x27;type&#x27;: &#x27;send&#x27;, &#x27;payload&#x27;: &#123;&#x27;status&#x27;: &#x27;success&#x27;&#125;&#125;</span></span><br><span class="line"><span class="string">	:param message:</span></span><br><span class="line"><span class="string">	:return:</span></span><br><span class="line"><span class="string">	&#x27;&#x27;&#x27;</span></span><br><span class="line">	<span class="comment"># print(message)</span></span><br><span class="line">	<span class="comment"># print(data)</span></span><br><span class="line">	<span class="keyword">if</span> message[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;send&#x27;</span>:</span><br><span class="line">		payload_message(message[<span class="string">&#x27;payload&#x27;</span>])</span><br><span class="line">	<span class="keyword">elif</span> message[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;error&#x27;</span>:</span><br><span class="line">		print(message[<span class="string">&#x27;stack&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> codecs.<span class="built_in">open</span>(<span class="string">&#x27;sougou.js&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    source = f.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	device = frida.get_usb_device(<span class="number">1000</span>) <span class="comment">#连接usb设备 1000表示超时</span></span><br><span class="line">	pid = device.spawn(bundle) <span class="comment">#启动指定bundleId的app</span></span><br><span class="line">	session = device.attach(pid)  <span class="comment">#附加到app</span></span><br><span class="line">	<span class="comment"># 创建frida javaScript脚本</span></span><br><span class="line">	script = session.create_script(source) <span class="comment"># type: frida.core.Script</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">#参数：信号single 回调callback， single固定message</span></span><br><span class="line">	script.on(<span class="string">&#x27;message&#x27;</span>, handle_js_message)</span><br><span class="line">	script.load() <span class="comment">#load脚本到app进程中 这样即注入成功</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">#发送消息</span></span><br><span class="line">	script.post(&#123;<span class="string">&#x27;cmd&#x27;</span>: <span class="string">&#x27;cmd111&#x27;</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;nameValue&#x27;</span>&#125;)</span><br><span class="line">	<span class="comment">#消息发送给JS后，调用g_event.wait进入等待 当JS处理完成后，会将status设为“success”</span></span><br><span class="line">	g_event.wait()</span><br><span class="line"></span><br><span class="line">	device.resume(pid) <span class="comment">#恢复app运行</span></span><br><span class="line">	sys.stdin.read()<span class="comment">#读取打印日志</span></span><br></pre></td></tr></table></figure>





<h6 id="JS脚本-1"><a href="#JS脚本-1" class="headerlink" title="JS脚本"></a>JS脚本</h6><p>hook.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;hello world&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>hook.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"></span><br><span class="line">bundle = <span class="string">&#x27;com.CMake&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    device = frida.get_usb_device()</span><br><span class="line">    pid = device.spawn(bundle) <span class="comment">#启动指定bundleid进程</span></span><br><span class="line">    session = device.attach(pid) <span class="comment">#附加app</span></span><br><span class="line">    <span class="keyword">with</span> codecs.<span class="built_in">open</span>(<span class="string">&#x27;./hook.js&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        source = f.read() <span class="comment">#读取脚本文件</span></span><br><span class="line">    script = session.create_script(source) <span class="comment">#创建 frida JavaScript脚本</span></span><br><span class="line">    script.load() <span class="comment">#加载脚本</span></span><br><span class="line">    device.resume(pid) <span class="comment">#唤醒回复app运行</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">#云行后打印 hello world</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>可以用来代替 vmmap 来获取加载基地址</p>
</blockquote>
<h6 id="拦截某个类的所有方法"><a href="#拦截某个类的所有方法" class="headerlink" title="拦截某个类的所有方法"></a>拦截某个类的所有方法</h6><p>API里提供了ApiResolver接口，能够根据正则表达式获取符合条件的所有方法</p>
<p>获取微信红包相关的 WCRedEnvelopesLogicMgr 类的所有方法，JS代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> resolver = <span class="keyword">new</span> ApiResolver(<span class="string">&#x27;objc&#x27;</span>);<span class="comment">//创建已加载OC类方法的API查找器</span></span><br><span class="line"><span class="keyword">var</span> matches = resolver.enumerateMatches(<span class="string">&#x27;*[WCRedEnvelopesLogicMgr *]&#x27;</span>, &#123;</span><br><span class="line">  onMatch: <span class="function"><span class="keyword">function</span>(<span class="params">match</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(match[<span class="string">&#x27;name&#x27;</span>] + <span class="string">&#x27;:&#x27;</span> + match[<span class="string">&#x27;address&#x27;</span>]);</span><br><span class="line">  &#125;,</span><br><span class="line">  onComplete: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//再attach</span></span><br><span class="line">Interceptor.attach(ptr(matches[<span class="number">0</span>][<span class="string">&#x27;address&#x27;</span>]), &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>eg: 绕过AFNetworking证书校验</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> resolver = <span class="keyword">new</span> ApiResolver(<span class="string">&#x27;objc&#x27;</span>);<span class="comment">//创建已加载Object-C类方法的API查找器</span></span><br><span class="line">	<span class="keyword">var</span> matches = resolver.enumerateMatchesSync(<span class="string">&quot;-[AFSecurityPolicy evaluateServerTrust:forDomain:]&quot;</span>);<span class="comment">//查找evaluateServerTrust:forDomain函数，返回数组类型</span></span><br><span class="line">	<span class="keyword">if</span> (matches.lenght == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&quot;\n[E] -[AFSecurityPolicy evaluateServerTrust:forDomain:] is not found!\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	Interceptor.attach(ptr(matches[<span class="number">0</span>][<span class="string">&quot;address&quot;</span>]),&#123;</span><br><span class="line">			onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>) </span>&#123;</span><br><span class="line">				<span class="built_in">console</span>.log(<span class="string">&quot;[I] -[AFSecurityPolicy evaluateServerTrust:forDomain:] hits!&quot;</span>);</span><br><span class="line">				retval.replace(<span class="number">1</span>);<span class="comment">//将返回值修改为1</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	);</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&quot;[I] -[AFSecurityPolicy evaluateServerTrust:forDomain:] is hooked!\n&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main();</span><br></pre></td></tr></table></figure>



<p>脚本执行后，将 WCRedEnvelopesLogicMgr 类的所有方法和内存地址都打印出来了</p>
<p>获取所有方法后，可以使用 Interceptor.attach() 对每个方法进行拦截，然后打印参数和返回值</p>
<img src="逆向-Frida/图片 10.png" alt="图片 10" style="zoom:80%;" />

<img src="逆向-Frida/图片 11.png" alt="图片 11" style="zoom:40%;" />

<p>将拦截器中将调用的方法、传入参数及返回值都打印出来，就可以分析调用顺序了</p>
<h6 id="拦截C函数"><a href="#拦截C函数" class="headerlink" title="拦截C函数"></a>拦截C函数</h6><p>逆向分析时会遇到 sub_xxx 的C函数，如果要获取参数除了动态调试，还可以用 Frida 来操作</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_rva</span>(<span class="params"><span class="built_in">module</span>, offset</span>) </span>&#123;</span><br><span class="line">	<span class="comment">//获取基地址</span></span><br><span class="line">	<span class="keyword">var</span> base_addr = Module.findBaseAddress(<span class="built_in">module</span>)</span><br><span class="line">	<span class="comment">//函数地址 = 基地址+偏移地址</span></span><br><span class="line">	<span class="keyword">var</span> target_addr = base_addr.add(offset) </span><br><span class="line">	<span class="keyword">if</span> (Process.arch == <span class="string">&#x27;arm&#x27;</span>) &#123; <span class="comment">//如果是32位地址+1</span></span><br><span class="line">		<span class="keyword">return</span> target_addr.add(<span class="number">1</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> target_addr</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//函数偏移地址 可以通过 IDA 查看</span></span><br><span class="line"><span class="keyword">var</span> target_addr = get_rva(<span class="string">&#x27;mars&#x27;</span>, <span class="number">0x23adf6</span>);</span><br><span class="line">Interceptor.attach(ptr(target_addr), &#123;</span><br><span class="line">  onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;mars::stn::MMTLsCtrlInfo::IsMMTLSEnabled=&#x27;</span> + Memory.readU8(args[<span class="number">0</span>].add(<span class="number">8</span>)));</span><br><span class="line">  &#125;,</span><br><span class="line">  onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>) </span>&#123;</span><br><span class="line">    retval.replace(ptr(<span class="number">0</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>0x23adf6 是C函数的偏移地址，args[0].add(8) 相当于ARM指令的 LDRB W0, [X0,#8] 也就是访问第一个成员变量</p>
<p>。。</p>
<h6 id="替换原方法"><a href="#替换原方法" class="headerlink" title="替换原方法"></a>替换原方法</h6><p>Interceptor.attach() 拦截目标后，可以打印参数、修改返回值，但无法阻止方法的执行</p>
<p>例如，某个类存在一个 update 方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)update:(<span class="keyword">id</span>)args;</span><br></pre></td></tr></table></figure>

<p>当需要准确知道是否因为这个方法的执行而导致页面发生了变化时，可以将原方法替换掉进行测试</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">update.implementation = ObjC.implement(update, <span class="function"><span class="keyword">function</span>(<span class="params">handle,selector,args</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> self = ObjC.Object(handle);</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;self:&#x27;</span> + self);</span><br><span class="line">	<span class="comment">//这样原始方法就不会被执行，也就达到了屏蔽的效果</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>如果要在某个时刻调回原方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//先获取原方法</span></span><br><span class="line"><span class="keyword">var</span> oldImp = update.implementation;</span><br><span class="line"><span class="comment">//需要的时候调用</span></span><br><span class="line">oldImp(handle,selector,args);</span><br></pre></td></tr></table></figure>

<p>对于C函数，操作稍微复杂些，需要使用NativeFunction定义原函数与新函数，然后使用 Interceptor.replace() 进行替换</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> dlopenPtr = Module.findExportByName(<span class="literal">null</span>, <span class="string">&#x27;dlopen&#x27;</span>)</span><br><span class="line"><span class="keyword">var</span> dlopen = <span class="keyword">new</span> NativeFunction(dlopenPtr, <span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>])</span><br><span class="line">Interceptor.replace(dlopenPtr, <span class="keyword">new</span> NativeCallBack(<span class="function"><span class="keyword">function</span>(<span class="params">path, mode</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//新函数逻辑</span></span><br><span class="line">  <span class="keyword">var</span> name = Memory.readUtf8String(path)</span><br><span class="line">  <span class="keyword">if</span> (name != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;name:&#x27;</span> + name)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//调用原函数</span></span><br><span class="line">  <span class="keyword">return</span> dlopen(path, mode)</span><br><span class="line">&#125;,<span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]))</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h6 id="替换原方法-replace"><a href="#替换原方法-replace" class="headerlink" title="替换原方法 replace"></a>替换原方法 replace</h6><p>Interceptor.replace(target, replacement)</p>
<p>replacement 是 NativeCallback 类型</p>
<p>new NativeCallback(func, returnType, argTypes[,abi]) //函数 返回值 参数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> target_addr = get_rva(<span class="string">&#x27;XinHuaShe&#x27;</span>, <span class="number">0xBF9A0</span>)</span><br><span class="line">	<span class="comment">//NativeCallback(func, returnType, argTypes[,abi])</span></span><br><span class="line">	<span class="comment">//或者不用参数</span></span><br><span class="line">	Interceptor.replace(ptr(target_addr), <span class="keyword">new</span> NativeCallback(<span class="function"><span class="keyword">function</span>(<span class="params">argc, argv</span>)</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;hook sub_ptrace bypass&#x27;</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">	&#125;, int, [int, int]))</span><br></pre></td></tr></table></figure>

<h6 id="替换原方法-1"><a href="#替换原方法-1" class="headerlink" title="替换原方法"></a>替换原方法</h6><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//didTap 需要传递两个参数 ObjC.implement回调中也需要两个参数</span></span><br><span class="line"><span class="keyword">var</span> didTap = ObjC.classes.T1TranslateButton[<span class="string">&#x27;- _didTap:forEvent:&#x27;</span>]</span><br><span class="line"><span class="keyword">var</span> didTapOldImp = didTap.implementation</span><br><span class="line"></span><br><span class="line"><span class="comment">// 覆盖实现</span></span><br><span class="line">didTap.implementation = ObjC.implement(setTitle, <span class="function"><span class="keyword">function</span>(<span class="params">handle, selector, arg1, arg2</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> self = ObjC.Object(handle)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;self -- &quot;</span>, self) </span><br><span class="line"></span><br><span class="line">  <span class="comment">// 调用旧实现</span></span><br><span class="line">  <span class="comment">// didTapOldImp(handle, selector, arg1, arg2)</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>





<h5 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">Module模块</span><br><span class="line">Module.findExportByName(moduleName|null, exportName)</span><br><span class="line">	moduleName：lib名字</span><br><span class="line">	exportName：函数名字</span><br><span class="line">	返回exportName的地址</span><br><span class="line">Module.findBaseAddress(moduleName)</span><br><span class="line">	moduleName：lib名字</span><br><span class="line">	返回lib的基地址</span><br><span class="line"></span><br><span class="line">Process模块</span><br><span class="line">Process.findModuleByAddress(address)</span><br><span class="line">	address：lib的指针地址</span><br><span class="line">	返回一个Module对象</span><br><span class="line"></span><br><span class="line">Momery模块</span><br><span class="line">Memory.readCString(pointer)</span><br><span class="line">	pointer:指针地址</span><br><span class="line">	把pointer还原成字符串</span><br><span class="line">Memory.readUtf8String(pointer);</span><br><span class="line">Memory.readAnsiString(pointer)</span><br><span class="line"></span><br><span class="line">Interceptor模块：监听</span><br><span class="line">.attach(target, callbacks)</span><br><span class="line">	target:指针地址</span><br><span class="line">	callbacks:回调函数</span><br><span class="line">		onEnter</span><br><span class="line">		onLeave</span><br><span class="line"></span><br><span class="line">使用objection</span><br><span class="line">ios hooking watchmethod“+[RSAencryptString:privateKey:]”–dump-args</span><br><span class="line">ios hooking watchmethod“+[RSAencryptString:privateKey:]”–dump-return</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><h5 id="加密参数打印"><a href="#加密参数打印" class="headerlink" title="加密参数打印"></a>加密参数打印</h5><p>下载工程 <a target="_blank" rel="noopener" href="https://github.com/GuanlinORZ/friDemo">https://github.com/GuanlinORZ/friDemo</a> 或加代理下载 <a target="_blank" rel="noopener" href="https://gh.fakev.cn/GuanlinORZ/friDemo">https://gh.fakev.cn/GuanlinORZ/friDemo</a></p>
<p>跟踪函数</p>
<p>分析 CCCrypt 函数的加密</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CCCryptorStatus CCCrypt( </span><br><span class="line">  CCOperation op, <span class="comment">//kCCEncrypt为加密，kCCDecrypt为解密 </span></span><br><span class="line">  CCAlgorithm alg, <span class="comment">//加密方式 kCCAlgorithmAES128为AES加密</span></span><br><span class="line">  CCOptions options, <span class="comment">//增充方式</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">void</span> *key,   <span class="comment">//密钥</span></span><br><span class="line">  size_t keyLength,  <span class="comment">//密钥长度</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">void</span> *iv,    <span class="comment">// IV</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">void</span> *dataIn, <span class="comment">//待加密的原文</span></span><br><span class="line">  size_t dataInLength, <span class="comment">//原文长度</span></span><br><span class="line">  <span class="keyword">void</span> *dataOut,       <span class="comment">//加密后输出的数据</span></span><br><span class="line">  size_t dataOutAvailable,  </span><br><span class="line">  size_t *dataOutMoved)</span><br></pre></td></tr></table></figure>

<p>运行项目，跟踪函数调用</p>
<p>点击项目按钮，调用加密方法，可以看到跟踪函数调用的参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#-i 跟踪函数</span><br><span class="line">$ frida-trace -U -i CCCrypt DesDemo </span><br><span class="line">Instrumenting...</span><br><span class="line">CCCrypt: Auto-generated handler at &quot;&#x2F;Users&#x2F;xxx&#x2F;Desktop&#x2F;WeChat&#x2F;__handlers__&#x2F;libcommonCrypto.dylib&#x2F;CCCrypt.js&quot;</span><br><span class="line">Started tracing 1 function. Press Ctrl+C to stop.</span><br><span class="line">           &#x2F;* TID 0x103 *&#x2F;</span><br><span class="line">  9217 ms  CCCrypt(op&#x3D;0x0, alg&#x3D;0x1, options&#x3D;0x1, key&#x3D;0x102363d50, keyLength&#x3D;0x8, iv&#x3D;0x16daa4e20, dataIn&#x3D;0x280a01531, dataInLength&#x3D;0xa, dataOut&#x3D;0x16daa4e28, dataOutAvailable&#x3D;0x400, dataOutMoved&#x3D;0x16daa4de0)</span><br></pre></td></tr></table></figure>

<p>并且生成了 handlers/CCCrypt.js 文件</p>
<p>有两个函数，onEnter 是进入函数时会执行的代码，onLeave是函数执行完离开时会执行的代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="title">onEnter</span>(<span class="params">log, args, state</span>)</span> &#123;</span><br><span class="line">    log(<span class="string">`CCCrypt(op=<span class="subst">$&#123;args[<span class="number">0</span>]&#125;</span>, alg=<span class="subst">$&#123;args[<span class="number">1</span>]&#125;</span>, options=<span class="subst">$&#123;args[<span class="number">2</span>]&#125;</span>, key=<span class="subst">$&#123;args[<span class="number">3</span>]&#125;</span>, keyLength=<span class="subst">$&#123;args[<span class="number">4</span>]&#125;</span>, iv=<span class="subst">$&#123;args[<span class="number">5</span>]&#125;</span>, dataIn=<span class="subst">$&#123;args[<span class="number">6</span>]&#125;</span>, dataInLength=<span class="subst">$&#123;args[<span class="number">7</span>]&#125;</span>, dataOut=<span class="subst">$&#123;args[<span class="number">8</span>]&#125;</span>, dataOutAvailable=<span class="subst">$&#123;args[<span class="number">9</span>]&#125;</span>, dataOutMoved=<span class="subst">$&#123;args[<span class="number">10</span>]&#125;</span>)`</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">onLeave</span>(<span class="params">log, retval, state</span>)</span> &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改内容 </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">log, args, state</span>) </span>&#123;</span><br><span class="line">    log(<span class="string">&#x27;CCCrypt(&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;op=&#x27;</span> + args[<span class="number">0</span>] +</span><br><span class="line">      <span class="string">&#x27;, alg=&#x27;</span> + args[<span class="number">1</span>] +</span><br><span class="line">      <span class="string">&#x27;, options=&#x27;</span> + args[<span class="number">2</span>] +</span><br><span class="line">      <span class="string">&#x27;, key=&#x27;</span> + args[<span class="number">3</span>] +</span><br><span class="line">      <span class="string">&#x27;, keyLength=&#x27;</span> + args[<span class="number">4</span>] +</span><br><span class="line">      <span class="string">&#x27;, iv=&#x27;</span> + args[<span class="number">5</span>] +</span><br><span class="line">      <span class="string">&#x27;, dataIn=&#x27;</span> + args[<span class="number">6</span>] +</span><br><span class="line">      <span class="string">&#x27;, dataInLength=&#x27;</span> + args[<span class="number">7</span>] +</span><br><span class="line">      <span class="string">&#x27;, dataOut=&#x27;</span> + args[<span class="number">8</span>] +</span><br><span class="line">      <span class="string">&#x27;, dataOutAvailable=&#x27;</span> + args[<span class="number">9</span>] +</span><br><span class="line">      <span class="string">&#x27;, dataOutMoved=&#x27;</span> + args[<span class="number">10</span>] +</span><br><span class="line">    <span class="string">&#x27;)&#x27;</span>);</span><br><span class="line">    <span class="comment">//保存参数</span></span><br><span class="line">    <span class="built_in">this</span>.operation   = args[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">this</span>.CCAlgorithm = args[<span class="number">1</span>]</span><br><span class="line">    <span class="built_in">this</span>.CCOptions   = args[<span class="number">2</span>]</span><br><span class="line">    <span class="built_in">this</span>.keyBytes    = args[<span class="number">3</span>]</span><br><span class="line">    <span class="built_in">this</span>.keyLength   = args[<span class="number">4</span>]</span><br><span class="line">    <span class="built_in">this</span>.ivBuffer    = args[<span class="number">5</span>]</span><br><span class="line">    <span class="built_in">this</span>.inBuffer    = args[<span class="number">6</span>]</span><br><span class="line">    <span class="built_in">this</span>.inLength    = args[<span class="number">7</span>]</span><br><span class="line">    <span class="built_in">this</span>.outBuffer   = args[<span class="number">8</span>]</span><br><span class="line">    <span class="built_in">this</span>.outLength   = args[<span class="number">9</span>]</span><br><span class="line">    <span class="built_in">this</span>.outCountPtr = args[<span class="number">10</span>]</span><br><span class="line">    <span class="comment">//this.operation == 0 代表是加密</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.operation == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">//打印加密前的原文</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;In buffer:&quot;</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(hexdump(ptr(<span class="built_in">this</span>.inBuffer), &#123;</span><br><span class="line">            length: <span class="built_in">this</span>.inLength.toInt32(),</span><br><span class="line">            header: <span class="literal">true</span>,</span><br><span class="line">            ansi: <span class="literal">true</span></span><br><span class="line">        &#125;))</span><br><span class="line">        <span class="comment">//打印密钥</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;Key: &quot;</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(hexdump(ptr(<span class="built_in">this</span>.keyBytes), &#123;</span><br><span class="line">            length: <span class="built_in">this</span>.keyLength.toInt32(),</span><br><span class="line">            header: <span class="literal">true</span>,</span><br><span class="line">            ansi: <span class="literal">true</span></span><br><span class="line">        &#125;))</span><br><span class="line">        <span class="comment">//打印 IV</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;IV: &quot;</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(hexdump(ptr(<span class="built_in">this</span>.ivBuffer), &#123;</span><br><span class="line">            length: <span class="built_in">this</span>.keyLength.toInt32(),</span><br><span class="line">            header: <span class="literal">true</span>,</span><br><span class="line">            ansi: <span class="literal">true</span></span><br><span class="line">        &#125;))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  onLeave: <span class="function"><span class="keyword">function</span> (<span class="params">log, retval, state</span>) </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">ptr(s) 定义一个指针 指针地址为s </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">operation: 0x0代表加密，0x1代表解密</span></span><br><span class="line"><span class="comment">enum &#123;</span></span><br><span class="line"><span class="comment">	kCCEncrypt = 0,	</span></span><br><span class="line"><span class="comment">	kCCDecrypt = 1	</span></span><br><span class="line"><span class="comment">&#125;;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">CCAlgorithm: 0x0指加密方式是AES加密，0x1指DES加密，0x2指3DES加密</span></span><br><span class="line"><span class="comment">enum &#123;</span></span><br><span class="line"><span class="comment">	kCCAlgorithmAES128 = 0,</span></span><br><span class="line"><span class="comment">	kCCAlgorithmAES    = 0,</span></span><br><span class="line"><span class="comment">	kCCAlgorithmDES    = 1,</span></span><br><span class="line"><span class="comment">	kCCAlgorithm3DES   = 2,		</span></span><br><span class="line"><span class="comment">	kCCAlgorithmCAST   = 3,		</span></span><br><span class="line"><span class="comment">	kCCAlgorithmRC4    = 4,</span></span><br><span class="line"><span class="comment">	kCCAlgorithmRC2	   = 5	</span></span><br><span class="line"><span class="comment">&#125;;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">CCOptions: 0x1指模式是CBC，通常0x3指ECB</span></span><br><span class="line"><span class="comment">enum &#123;</span></span><br><span class="line"><span class="comment">	kCCOptionPKCS7Padding	= 0x0001,</span></span><br><span class="line"><span class="comment">	kCCOptionECBMode	= 0x0002</span></span><br><span class="line"><span class="comment">&#125;;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//或者使用 Interceptor.attach</span></span><br><span class="line">Interceptor.attach(Module.findExportByName(<span class="string">&#x27;libcommonCrypto.dylib&#x27;</span>, <span class="string">&#x27;CCCrypt&#x27;</span>), &#123;</span><br><span class="line">    onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// Save the arguments</span></span><br><span class="line">        <span class="built_in">this</span>.operation   = args[<span class="number">0</span>]</span><br><span class="line">        <span class="built_in">this</span>.CCAlgorithm = args[<span class="number">1</span>]</span><br><span class="line">        <span class="built_in">this</span>.CCOptions   = args[<span class="number">2</span>]</span><br><span class="line">        <span class="built_in">this</span>.keyBytes    = args[<span class="number">3</span>]</span><br><span class="line">        <span class="built_in">this</span>.keyLength   = args[<span class="number">4</span>]</span><br><span class="line">        <span class="built_in">this</span>.ivBuffer    = args[<span class="number">5</span>]</span><br><span class="line">        <span class="built_in">this</span>.inBuffer    = args[<span class="number">6</span>]</span><br><span class="line">        <span class="built_in">this</span>.inLength    = args[<span class="number">7</span>]</span><br><span class="line">        <span class="built_in">this</span>.outBuffer   = args[<span class="number">8</span>]</span><br><span class="line">        <span class="built_in">this</span>.outLength   = args[<span class="number">9</span>]</span><br><span class="line">        <span class="built_in">this</span>.outCountPtr = args[<span class="number">10</span>]</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;CCCrypt(&#x27;</span> + </span><br><span class="line">            <span class="string">&#x27;operation: &#x27;</span>   + <span class="built_in">this</span>.operation    +<span class="string">&#x27;, &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;CCAlgorithm: &#x27;</span> + <span class="built_in">this</span>.CCAlgorithm  +<span class="string">&#x27;, &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;CCOptions: &#x27;</span>   + <span class="built_in">this</span>.CCOptions    +<span class="string">&#x27;, &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;keyBytes: &#x27;</span>    + <span class="built_in">this</span>.keyBytes     +<span class="string">&#x27;, &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;keyLength: &#x27;</span>   + <span class="built_in">this</span>.keyLength    +<span class="string">&#x27;, &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;ivBuffer: &#x27;</span>    + <span class="built_in">this</span>.ivBuffer     +<span class="string">&#x27;, &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;inBuffer: &#x27;</span>    + <span class="built_in">this</span>.inBuffer     +<span class="string">&#x27;, &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;inLength: &#x27;</span>    + <span class="built_in">this</span>.inLength     +<span class="string">&#x27;, &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;outBuffer: &#x27;</span>   + <span class="built_in">this</span>.outBuffer    +<span class="string">&#x27;, &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;outLength: &#x27;</span>   + <span class="built_in">this</span>.outLength    +<span class="string">&#x27;, &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;outCountPtr: &#x27;</span> + <span class="built_in">this</span>.outCountPtr  +<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.operation == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Show the buffers here if this an encryption operation</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;In buffer:&quot;</span>)</span><br><span class="line">            <span class="built_in">console</span>.log(hexdump(ptr(<span class="built_in">this</span>.inBuffer), &#123;</span><br><span class="line">                length: <span class="built_in">this</span>.inLength.toInt32(),</span><br><span class="line">                header: <span class="literal">true</span>,</span><br><span class="line">                ansi: <span class="literal">true</span></span><br><span class="line">            &#125;))</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;Key: &quot;</span>)</span><br><span class="line">            <span class="built_in">console</span>.log(hexdump(ptr(<span class="built_in">this</span>.keyBytes), &#123;</span><br><span class="line">                length: <span class="built_in">this</span>.keyLength.toInt32(),</span><br><span class="line">                header: <span class="literal">true</span>,</span><br><span class="line">                ansi: <span class="literal">true</span></span><br><span class="line">            &#125;))</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;IV: &quot;</span>)</span><br><span class="line">            <span class="built_in">console</span>.log(hexdump(ptr(<span class="built_in">this</span>.ivBuffer), &#123;</span><br><span class="line">                length: <span class="built_in">this</span>.keyLength.toInt32(),</span><br><span class="line">                header: <span class="literal">true</span>,</span><br><span class="line">                ansi: <span class="literal">true</span></span><br><span class="line">            &#125;))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    onLeave: <span class="function"><span class="keyword">function</span> (<span class="params">retVal</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.operation == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// Show the buffers here if this a decryption operation</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;Out buffer:&quot;</span>)</span><br><span class="line">            <span class="built_in">console</span>.log(hexdump(ptr(<span class="built_in">this</span>.outBuffer), &#123;</span><br><span class="line">                length: Memory.readUInt(<span class="built_in">this</span>.outCountPtr),</span><br><span class="line">                header: <span class="literal">true</span>,</span><br><span class="line">                ansi: <span class="literal">true</span></span><br><span class="line">            &#125;))</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;Key: &quot;</span>)</span><br><span class="line">            <span class="built_in">console</span>.log(hexdump(ptr(<span class="built_in">this</span>.keyBytes), &#123;</span><br><span class="line">                length: <span class="built_in">this</span>.keyLength.toInt32(),</span><br><span class="line">                header: <span class="literal">true</span>,</span><br><span class="line">                ansi: <span class="literal">true</span></span><br><span class="line">            &#125;))</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;IV: &quot;</span>)</span><br><span class="line">            <span class="built_in">console</span>.log(hexdump(ptr(<span class="built_in">this</span>.ivBuffer), &#123;</span><br><span class="line">                length: <span class="built_in">this</span>.keyLength.toInt32(),</span><br><span class="line">                header: <span class="literal">true</span>,</span><br><span class="line">                ansi: <span class="literal">true</span></span><br><span class="line">            &#125;))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//hexdump 打印内存中的地址</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">var libc = Module.findBaseAddress(&#x27;libc.so&#x27;);</span></span><br><span class="line"><span class="comment">console.log(hexdump(libc, &#123;</span></span><br><span class="line"><span class="comment">  offset: 0,</span></span><br><span class="line"><span class="comment">  length: 64,</span></span><br><span class="line"><span class="comment">  header: true,</span></span><br><span class="line"><span class="comment">  ansi: true</span></span><br><span class="line"><span class="comment">&#125;));</span></span><br><span class="line"><span class="comment">           0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F  0123456789ABCDEF</span></span><br><span class="line"><span class="comment">00000000  7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00  .ELF............</span></span><br><span class="line"><span class="comment">00000010  03 00 28 00 01 00 00 00 00 00 00 00 34 00 00 00  ..(.........4...</span></span><br><span class="line"><span class="comment">00000020  34 a8 04 00 00 00 00 05 34 00 20 00 08 00 28 00  4.......4. ...(.</span></span><br><span class="line"><span class="comment">00000030  1e 00 1d 00 06 00 00 00 34 00 00 00 34 00 00 00  ........4...4...</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>再次执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ frida-trace -U -i CCCrypt DesDemo</span><br><span class="line"></span><br><span class="line">Started tracing 1 function. Press Ctrl+C to stop.</span><br><span class="line">In buffer:</span><br><span class="line">            0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F  0123456789ABCDEF</span><br><span class="line">280a14451  72 32 34 33 34 33 34 33 34 33                    r243434343</span><br><span class="line">Key:</span><br><span class="line">            0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F  0123456789ABCDEF</span><br><span class="line">102363d50  78 78 78 78 00 21 2a 27                          xxxx.!*&#39;</span><br><span class="line">IV:</span><br><span class="line">            0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F  0123456789ABCDEF</span><br><span class="line">16daa4e20  12 34 56 78 90 ab cd ef                          .4Vx....</span><br><span class="line">           &#x2F;* TID 0x103 *&#x2F;</span><br><span class="line">  1813 ms  CCCrypt(op&#x3D;0x0, alg&#x3D;0x1, options&#x3D;0x1, key&#x3D;0x102363d50, keyLength&#x3D;0x8, iv&#x3D;0x16daa4e20, dataIn&#x3D;0x280a14451, dataInLength&#x3D;0xa, dataOut&#x3D;0x16daa4e28, dataOutAvailable&#x3D;0x400, dataOutMoved&#x3D;0x16daa4de0)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;可以看到加密前字符串 r243434343</span><br></pre></td></tr></table></figure>

<p>CC_MD5 </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">CC_MD5(fooData, (CC_LONG)strlen(fooData), result);</span><br><span class="line"></span><br><span class="line"><span class="comment">//参数1:要加密的字符串</span></span><br><span class="line"><span class="comment">//参数2: 获取要加密字符串的长度</span></span><br><span class="line"><span class="comment">//参数3: 接收结果的数组</span></span><br><span class="line"><span class="comment">//返回一个32位长度的加密后的字符串</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//js</span></span><br><span class="line">&#123;</span><br><span class="line">  onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">log, args, state</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//将md5参数转成字符串并打印</span></span><br><span class="line">    <span class="keyword">var</span> md5_data = args[<span class="number">0</span>].readUtf8String();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;MD5-参数值:&#x27;</span>);</span><br><span class="line">    <span class="built_in">console</span>.error(md5_data);</span><br><span class="line">  &#125;, </span><br><span class="line">  onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">log, retval, state</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//将md5返回值转码为32位字符串并打印</span></span><br><span class="line">    <span class="keyword">var</span> md5_digest = hexdump(retval, &#123;<span class="attr">length</span>: <span class="number">16</span>&#125;);</span><br><span class="line">    <span class="keyword">var</span> hexified = <span class="string">&quot; &quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> raw_array = md5_digest.split(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> a=<span class="number">0</span>;a&lt; raw_array.length,a++)&#123;</span><br><span class="line">      <span class="keyword">var</span> line_array = raw_array[a].split(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> b=<span class="number">1</span>;b&lt;line_array.length-<span class="number">1</span>;b++)&#123;</span><br><span class="line">        <span class="function"><span class="title">if</span>(<span class="params">line_array[b].length==<span class="number">2</span></span>)</span>&#123;</span><br><span class="line">          hexified+=line_array[b];</span><br><span class="line">          hexified=hexified.trim()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;MD5-返回值:&#x27;</span>);</span><br><span class="line">    <span class="built_in">console</span>.error(hexified+<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="修改入参-返回值"><a href="#修改入参-返回值" class="headerlink" title="修改入参/返回值"></a>修改入参/返回值</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line">onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;\t[-] &#x27;</span> + <span class="string">&#x27;onEnter args[0] class_name: &#x27;</span> + ObjC.Object(args[<span class="number">0</span>]).toString())</span><br><span class="line">	<span class="keyword">var</span> newval = ObjC.classes.NSString.stringWithString_(<span class="string">&quot;root/0;debug/0;proxy/0;inject/0&quot;</span>)</span><br><span class="line">  args[<span class="number">0</span>] = newval</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;\t[-] &#x27;</span> + <span class="string">&#x27;onEnter args[0] class_name: &#x27;</span> + ObjC.Object(args[<span class="number">0</span>]).toString())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> newuuid = ObjC.classes.NSString.stringWithString_(<span class="string">&quot;32427210-7773-7679-3993-A3F7-E85D212D7D91&quot;</span>)</span><br><span class="line">  retval.replace(newuuid)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="打印"><a href="#打印" class="headerlink" title="打印"></a>打印</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var str &#x3D; new ObjC.Object(ptr(args[2])).toString();</span><br><span class="line">console.log(&#39;[*] str:] -&gt;&#39; , str);</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>













<p><a target="_blank" rel="noopener" href="https://la0s.github.io/2018/12/07/iOS_Crypto/">破解iOS加密数据</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/la0s/Frida-scripts">Frida-scripts  (base64|MD5|SHA1)</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/dpnishant/appmon/tree/master/scripts/iOS/Crypto">appmon project 提供的 scripts</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/theart42/hack.lu/blob/master/IOS/Notes/05-Crypt/00-crypto-hooks.md">hack.lu 的 scripts</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/13/%E9%80%86%E5%90%91-%E7%A0%B8%E5%A3%B3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/13/%E9%80%86%E5%90%91-%E7%A0%B8%E5%A3%B3/" class="post-title-link" itemprop="url">逆向-砸壳</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-06-13 15:12:38" itemprop="dateCreated datePublished" datetime="2022-06-13T15:12:38+08:00">2022-06-13</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-10-22 11:26:00" itemprop="dateModified" datetime="2022-10-22T11:26:00+08:00">2022-10-22</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%80%86%E5%90%91/" itemprop="url" rel="index"><span itemprop="name">逆向</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id=""><a href="#" class="headerlink" title=""></a></h4><p>脱壳原理</p>
<p>dyld加载MachO文件，将MachO文件导出</p>
<h4 id="检测是否加壳"><a href="#检测是否加壳" class="headerlink" title="检测是否加壳"></a>检测是否加壳</h4><ul>
<li>使用 otool</li>
</ul>
<p>otool 可以看到二进制文件的信息有个 crypt，cryptid = 1 已加壳，crypt = 0，未加壳</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">otool -l WeChat | grep crypt</span><br></pre></td></tr></table></figure>

<ul>
<li>使用 MachOView 查看</li>
</ul>
<p>可执行文件拖入 MachOView 展开 Load Commands 节点 LC_ENCRYPTION_INFO_64</p>
<p>可以看到 Crypt ID</p>
<img src="逆向-砸壳/WeChatc7de80a199f342265e06ba9817134a60.png" alt="WeChatc7de80a199f342265e06ba9817134a60" style="zoom:80%;" />

<h4 id="脱壳"><a href="#脱壳" class="headerlink" title="脱壳"></a>脱壳</h4><h5 id="Clutch"><a href="#Clutch" class="headerlink" title="Clutch"></a>Clutch</h5><blockquote>
<p>使用问题比较多，好多砸壳失败的</p>
</blockquote>
<p>全自动脱壳工具，原理是应用运行时的内存数据按照一定格式导出，并重新打包为 ipa 文件</p>
<ul>
<li>安装</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/KJCracks/Clutch/releases">https://github.com/KJCracks/Clutch/releases</a> 下载最新版 Clutch 2.0.4</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ iproxy 2222 22 #端口转发</span><br><span class="line">#macOS执行</span><br><span class="line">$ scp -p 2222 -r .&#x2F;Clutch root@localhost:&#x2F;usr&#x2F;bin&#x2F;</span><br><span class="line">#iOS设备执行</span><br><span class="line">$ chmod +x &#x2F;usr&#x2F;bin&#x2F;Clutch</span><br></pre></td></tr></table></figure>

<p>输入 Clutch，输出了帮助信息则安装配置成功</p>
<ul>
<li>Clutch</li>
</ul>
<p>Clutch -i 参数打印所有应用列表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root# Clutch -i</span><br><span class="line">Installed apps:</span><br><span class="line">1:  今日头条 &lt;com.ss.iphone.article.News&gt;</span><br></pre></td></tr></table></figure>

<p>脱壳</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root# Clutch -d com.ss.iphone.article.News</span><br></pre></td></tr></table></figure>

<p>脱壳完成后的 ipa 包在 <code>/private/var/mobile/Documents/Dumped</code> 路径</p>
<p>再拷贝到电脑</p>
<h5 id="dumpedcrypted"><a href="#dumpedcrypted" class="headerlink" title="dumpedcrypted"></a>dumpedcrypted</h5><p>脱壳原理：程序运行过程中将代码段里的数据 dump 下来</p>
<ul>
<li>编译  dumpdecrypted</li>
</ul>
<p>下载 <a target="_blank" rel="noopener" href="https://github.com/stefanesser/dumpdecrypted">https://github.com/stefanesser/dumpdecrypted</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd dumpdecrypted-master</span><br><span class="line">$ make</span><br></pre></td></tr></table></figure>

<p>生成 dumpdecrypted.dylib</p>
<ul>
<li>给 dumpdecrypted.dylib 重签名 </li>
</ul>
<p>可以使用 ldid 签名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldid -S dumpdecrypted.dylib</span><br></pre></td></tr></table></figure>

<p>或者使用 codesign 签名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codesign -f -s - .&#x2F;dumpdecrypted.dylib</span><br></pre></td></tr></table></figure>

<ul>
<li>拷贝 dumpdecrypted.dylib 到设备</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ scp -P2222 .&#x2F;dumpdecrypted.dylib root@localhost:&#x2F;usr&#x2F;bin&#x2F;</span><br></pre></td></tr></table></figure>

<ul>
<li>dumpdecrypted 脱壳</li>
</ul>
<p>查找路径和进程ID</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cd &#x2F;temp</span><br><span class="line">$ ps -e | grep WhatsApp</span><br><span class="line">#或者</span><br><span class="line">$ ps -ax | grep WhatsApp</span><br><span class="line">$ ps -aux | grep WhatsApp</span><br></pre></td></tr></table></figure>

<p>使用 DYLD_INSERT_LIBRARIES 环境变量将 dumpdecrypted.dylib 注入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DYLD_INSERT_LIBRARIES&#x3D;&#x2F;usr&#x2F;lib&#x2F;dumpdecrypted.dylib &#x2F;var&#x2F;mobile&#x2F;Containers&#x2F;Bundle&#x2F;Application&#x2F;1C8620F5-AFB5-46F8-9283-5FF70F4ADB5D&#x2F;WhatsApp.app&#x2F;WhatsApp</span><br></pre></td></tr></table></figure>

<p>生成 WhatsApp.decrypted 为脱壳后的文件，将文件拷贝到电脑</p>
<p>有些包是多架构的需要抽取指定架构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lipo AppStore.decrypted -thin arm64 -output AppStore.arm64</span><br></pre></td></tr></table></figure>

<h5 id="frida-ios-dump"><a href="#frida-ios-dump" class="headerlink" title="frida-ios-dump"></a>frida-ios-dump</h5><p>通过注入 JS 实现内存 dump，然后利用 Python 自动复制到 macOS生成ipa文件</p>
<p>原理和 dumpdecrypted 一样，都是通过把内存中已解密的数据 dump 再修复 Mach-O</p>
<ul>
<li>安装 frida</li>
</ul>
<p>iOS 设备 添加 Cydia 源：<a target="_blank" rel="noopener" href="https://build.frida.re/">https://build.frida.re</a>  安装 Frida for A12+ devices</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#macOS安装frida</span><br><span class="line">$ sudo pip install frida</span><br><span class="line">#如果报错</span><br><span class="line">$ sudo pip install frida -upgrade -ignore-installed six</span><br></pre></td></tr></table></figure>

<ul>
<li>配置 frida-ios-dump 环境</li>
</ul>
<p>下载 <a target="_blank" rel="noopener" href="https://github.com/AloneMonkey/frida-ios-dump">https://github.com/AloneMonkey/frida-ios-dump</a> 放到 /opt/dump 目录</p>
<p>安装依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo pip install -r requirements.txt --upgrade</span><br></pre></td></tr></table></figure>

<p>可以添加别名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ vim ~&#x2F;.bash_profile</span><br><span class="line">$ alias dump.py&#x3D;“&#x2F;opt&#x2F;dump&#x2F;frida-ios-dump-3.x&#x2F;dump.py”</span><br><span class="line">$ source ~&#x2F;.bash_profile</span><br></pre></td></tr></table></figure>

<ul>
<li>砸壳</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#端口转发</span><br><span class="line">$ iproxy 2222 22</span><br><span class="line">#列出所有应用</span><br><span class="line">$ python3.8 dump.py -l</span><br><span class="line">#砸壳</span><br><span class="line">$ python3.8 dump.py com.moutai.mall</span><br></pre></td></tr></table></figure>

<h5 id="DumpDecrypter（推荐）"><a href="#DumpDecrypter（推荐）" class="headerlink" title="DumpDecrypter（推荐）"></a>DumpDecrypter（推荐）</h5><p>Cydia - Cydiakk中文源，搜索 DumpDecrypter 可以一键砸壳</p>
<h5 id="修复闪退"><a href="#修复闪退" class="headerlink" title="修复闪退"></a>修复闪退</h5><p>脱壳后的 ipa 包安装后闪退</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#解压ipa包</span><br><span class="line">$ unzip decrypted-app.ipa</span><br><span class="line">#导出ent.xml</span><br><span class="line">$ codesign -d --entitlements - .&#x2F;Payload&#x2F;WhatsApp.app &gt; emt.xml</span><br><span class="line">#codesign重签名</span><br><span class="line">$ codesign -s - --entitlements ent.xml -f .&#x2F;Payload&#x2F;WhatsApp.app&#x2F;WhatsApp</span><br><span class="line">#压缩成新ipa包</span><br><span class="line">$ zip -r WhatsApp_ok.ipa Payload</span><br></pre></td></tr></table></figure>

<h5 id="LLDB-手动砸壳"><a href="#LLDB-手动砸壳" class="headerlink" title="LLDB 手动砸壳"></a>LLDB 手动砸壳</h5><p>LLDB手动脱壳实现原理是从内存中 dump 出解密后的数据，并修复 Mach-O 头部。</p>
<p>点击 APP 启动，内核开始读取 MachO，查看 MachO 是否被加密</p>
<p>如果没有加密，直接交给 dyld 加载并运行</p>
<p>如果加密，则需要内核解密，得到解密后的 MachO 文件，再交给 dyld 加载运行</p>
<ul>
<li>SSH 连接设备</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ iproxy 2222 22</span><br><span class="line">$ ssh -p 2222 root@localhost</span><br></pre></td></tr></table></figure>

<p>ps 命令找到目标路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ps -e | grep SogouInput</span><br><span class="line">4096 ??  0:04.69 &#x2F;var&#x2F;containers&#x2F;Bundle&#x2F;Application&#x2F;3546467A-CBFD-45D6-B27C-04682210031E&#x2F;SogouInput.app&#x2F;SogouInput</span><br></pre></td></tr></table></figure>

<ul>
<li>拷贝到桌面</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ scp -r -P 2222 root@localhost:&#x2F;var&#x2F;containers&#x2F;Bundle&#x2F;Application&#x2F;3546467A-CBFD-45D6-B27C-04682210031E&#x2F;SogouInput.app ~&#x2F;Desktop</span><br></pre></td></tr></table></figure>

<ul>
<li>查看是否加密</li>
</ul>
<p>要在内存中解密二进制文件，就需要知道加密数据的偏移量及大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">otool -l SogouInput | grep crypt</span><br><span class="line"> cryptoff 6299648  &#x2F;&#x2F;文件偏移</span><br><span class="line">cryptsize 4096		 &#x2F;&#x2F;加密文件大小</span><br><span class="line">  cryptid 1			   &#x2F;&#x2F;是否加密</span><br></pre></td></tr></table></figure>

<p>MachO 从位置 6299648（十进制） 开始后的 4096（十进制） 字节都被加密了</p>
<ul>
<li>开始脱壳</li>
</ul>
<p>LLDB 附加进程，然后获取 APP 的内存加载地址</p>
<ul>
<li>LLDB 连接</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iproxy 1234 1234</span><br></pre></td></tr></table></figure>

<p>设备上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debugserver *:1234 -a SogouInput</span><br></pre></td></tr></table></figure>

<p>Mac</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lldb</span><br><span class="line">(lldb) process connect connect:&#x2F;&#x2F;localhost:1234</span><br><span class="line">(lldb) image list -o -f  </span><br><span class="line">[  0] 0x0000000004e0c000 &#x2F;private&#x2F;var&#x2F;containers&#x2F;Bundle&#x2F;Application&#x2F;3546467A-CBFD-45D6-B27C-04682210031E&#x2F;SogouInput.app&#x2F;SogouInput(0x0000000104e0c000)</span><br></pre></td></tr></table></figure>

<p>image list 查看 APP 在内存中的偏移 ASLR 为 0x0000000104e0c000</p>
<p>如果这边遇到报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error: rejecting incoming connection from ::ffff:127.0.0.1 (expecting ::1)</span><br></pre></td></tr></table></figure>

<p>debugserver 连接改成 <code>debugserver 127.0.0.1:1234 -a SogouInput</code></p>
<ul>
<li>Dump出解密部分二进制文件</li>
</ul>
<p>利用 memory 命令从内存中dump出解密后的二进制数据，保存到文件</p>
<p>读取内存中的数据拷贝出来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;memory read --force --outfile 输出文件目录名称 --binary --count 加密文件的大小 ASLR+文件偏移 </span><br><span class="line">(--force 按字节读取意思)</span><br><span class="line">memory read --force --outfile .&#x2F;decrypted.bin --binary --count 4096 0x0000000104e0c000+6299648</span><br></pre></td></tr></table></figure>

<p>此时发现多了一个 decrypted.bin 文件</p>
<ul>
<li>修复文件</li>
</ul>
<p>dump 出来的数据没有 Mach-O 头部的信息，需要修复才能使用。将 dump 出来的数据重新写回脱壳前的文件，以替换加密的数据</p>
<ul>
<li>dd 指令将Dump出的二进制文件写入MachO文件</li>
</ul>
<p>指定大小文件写入另外一个文件里面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;dd seek&#x3D;文件偏移 bs&#x3D;单位为1字节 conv&#x3D;转换方式（保留未被截取部分的内容）if&#x3D;输入文件地址 of&#x3D;输出文件地址</span><br><span class="line">&#x2F;&#x2F;~&#x2F;Desktop目录</span><br><span class="line">dd seek&#x3D;6299648 bs&#x3D;1 conv&#x3D;notrunc if&#x3D;.&#x2F;decrypted.bin of&#x3D;.&#x2F;SogouInput.app&#x2F;SogouInput</span><br></pre></td></tr></table></figure>

<ul>
<li>更改 cycript 为 0，最后一步修改加密标记</li>
</ul>
<p>MachOView 打开 SogouInput</p>
<p>在 Load Command - LC_ENCRYPTION_INFO_64 可以看到 Crypt ID 值为 1</p>
<p>修改 Crypt ID 的 Data 0000001 改为 0000000，保存再次查看是否加密</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">otool -l SogouInput.app&#x2F;SogouInput | grep crypt</span><br><span class="line">     cryptoff 6299648</span><br><span class="line">    cryptsize 4096</span><br><span class="line">      cryptid 0</span><br></pre></td></tr></table></figure>

<p>利用 class-dump 导出头文件测试下能不能导出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class-dump -H &#x2F;Users&#x2F;midland_whk&#x2F;Desktop&#x2F;SogouInput.app&#x2F;SogouInput -o &#x2F;Users&#x2F;midland_whk&#x2F;Desktop&#x2F;header&#x2F;</span><br></pre></td></tr></table></figure>






































      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/13/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/13/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/" class="post-title-link" itemprop="url">逆向-汇编</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-06-13 11:44:38" itemprop="dateCreated datePublished" datetime="2022-06-13T11:44:38+08:00">2022-06-13</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-10-19 14:47:52" itemprop="dateModified" datetime="2022-10-19T14:47:52+08:00">2022-10-19</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="通用寄存器"><a href="#通用寄存器" class="headerlink" title="通用寄存器"></a>通用寄存器</h4><p>ARM64 有 31 个通用寄存器，每个寄存器可以存取一个 64 位的数据</p>
<p>使用 X0 ~ X30 时，它就是一个 64 位的数据</p>
<p>使用 W0 ~ W30 时，实际访问的是这些寄存器的低 32 位，写入时会将高 32 位清 0 </p>
<p>32 位寄存器并不是独立存在的，比如 W0 是 X0 的低 32 位</p>
<img src="逆向-汇编/通用寄存器.png" alt="通用寄存器" style="zoom:60%;" />



<p>Xcode 重新命名了 X29 X30 叫 fp  lr，除了 X0~X30寄存器外，还有一个 SP 寄存器。</p>
<h5 id="X0-X7"><a href="#X0-X7" class="headerlink" title="X0 ~ X7"></a>X0 ~ X7</h5><p>用来传递函数的参数，如果有更多的参数则使用栈来传递；X0 也用来存放函数的返回值</p>
<h5 id="SP寄存器"><a href="#SP寄存器" class="headerlink" title="SP寄存器"></a>SP寄存器</h5><p>Stack Pointer，栈指针寄存器，指向栈的顶部</p>
<h5 id="FP寄存器"><a href="#FP寄存器" class="headerlink" title="FP寄存器"></a>FP寄存器</h5><p>Frame Pointer，即 X29，帧指针寄存器，指向栈的底部</p>
<h5 id="LR寄存器"><a href="#LR寄存器" class="headerlink" title="LR寄存器"></a>LR寄存器</h5><p>Link Register，即 X30，链接寄存器，存储着函数调用完成时的返回地址，用来做函数调用栈跟踪</p>
<h5 id="PC寄存器"><a href="#PC寄存器" class="headerlink" title="PC寄存器"></a>PC寄存器</h5><p>指令指针寄存器，保存的是将要执行的下一条指令的内存地址</p>
<p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/PC%E5%AF%84%E5%AD%98%E5%99%A8.png" alt="PC寄存器"></p>
<h4 id="寄存器操作"><a href="#寄存器操作" class="headerlink" title="寄存器操作"></a>寄存器操作</h4><ul>
<li>读取寄存器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ register read				#读取整个寄存器</span><br><span class="line">x0 &#x3D; 0x....</span><br><span class="line">x1 &#x3D; 0x....</span><br><span class="line">$ register read $x0		#读取 x0 寄存器</span><br></pre></td></tr></table></figure>

<ul>
<li>修改寄存器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ register write $x1 1</span><br><span class="line">$ register read $x1</span><br></pre></td></tr></table></figure>

<ul>
<li>打印操作</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ po $x1			#打印 OC 对象</span><br><span class="line">$ x&#x2F;s $x1	    #将 X1 寄存器的C字符串打印出来 打印出调用方法名字</span><br><span class="line"></span><br><span class="line">$ p&#x2F;x $x7		  #p命令输出原生类型</span><br><span class="line">$ p&#x2F;d $x7</span><br></pre></td></tr></table></figure>

<ul>
<li>内存读写</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># -c 参数指定要读取的字节</span><br><span class="line">$ memory read $x0  #读取内存  如果读取数据超过1024字节会报错 加 --force 参数</span><br><span class="line">$ memory read 0x0000.. 0x0000.. #按区间读取</span><br><span class="line"></span><br><span class="line">#--outfile 读取的内存数据保存到文件</span><br><span class="line">$ memory read 0x000... -c 1025 --force -outfile &#x2F;tmp&#x2F;1.txt</span><br><span class="line"></span><br><span class="line">$ memory write 0x00.. 0x24 #修改成 0x24</span><br></pre></td></tr></table></figure>

<ul>
<li>反汇编</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ dis -a 0x00.. #反汇编指定地址</span><br></pre></td></tr></table></figure>

<ul>
<li>调用栈</li>
</ul>
<p>这里看到 frame， ru #1 0x000..f04</p>
<p>用这个地址减去 ASLR 的偏移量即可得到文件的偏移地址 </p>
<p>在 IDA 中取搜索这个文件偏移地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ bt</span><br><span class="line">$ bt 2  #指定打印 2 层</span><br></pre></td></tr></table></figure>

<ul>
<li>单步命令</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ni  #单步执行 遇到子函数不进入，会执行到下一行</span><br><span class="line">$ si  #单步执行 遇到子函数进入</span><br><span class="line">$ finish 完成功能并退出子函数，如在 objc_msgSend 函数内任何地址输入finish，会完成objc_msgSend的原始调用</span><br><span class="line">$ return 和finish不同会直接退出子函数，原始代码流程不会调用，该命令通常在反-反调试时用于跳过检测函数</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x104f227bB &lt;+8&gt;: mov W8, #-0x1</span><br></pre></td></tr></table></figure>

<p>加了#号表示常数，将 -1 赋值给 w8</p>
<p>orr 按位或</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/<span class="regexp">/读取 x9 寄存器值</span></span><br><span class="line"><span class="regexp">(lldb)register read $x9</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 修改 pc 寄存器的指向位置</span></span><br><span class="line"><span class="regexp">(lldb)register write $pc 0x182a367b8</span></span><br><span class="line"><span class="regexp">(lldb)register read $pc</span></span><br></pre></td></tr></table></figure>

<p>我们可以通过改变 pc寄存器 的内容来控制 CPU 执行目标指令</p>
<ul>
<li>mov 指令，可以用来修改大部分寄存器的值（不能用于设置pc的值）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov x0, #10</span><br><span class="line">mov x1, #20</span><br></pre></td></tr></table></figure>

<ul>
<li>bl 指令</li>
</ul>
<p>转移（跳转指令）</p>
<ul>
<li>ret 指令</li>
</ul>
<p>默认使用 lr（X30）寄存器的值</p>
<ul>
<li>Xcode 新建汇编代码</li>
</ul>
<p>Xcode 新建选择 Assembly File，命名为 asm.s </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;标号 告诉编译器生成的二进制机器码会保存到代码段</span><br><span class="line">.text</span><br><span class="line">&#x2F;&#x2F;告诉编译器 全局标号暴露给外面 _A _B</span><br><span class="line">.global _A,_B</span><br><span class="line"></span><br><span class="line">_A:</span><br><span class="line">    &#x2F;&#x2F;将a0存入到x0寄存器</span><br><span class="line">    mov x0,#0xa0</span><br><span class="line">    mov x1,#0x00</span><br><span class="line">    &#x2F;&#x2F;x0和#0x14加法运算 结果放到x1</span><br><span class="line">    add x1, x0, #0x14</span><br><span class="line">    &#x2F;&#x2F;跳转到B</span><br><span class="line">    bl _B</span><br><span class="line">    mov x0,#0x0</span><br><span class="line">    ret</span><br><span class="line">_B:</span><br><span class="line">    add x0, x0, #0x10</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>

<p>调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">int A(); &#x2F;&#x2F;声明</span><br><span class="line">int main(int argc,char *argv[])&#123;</span><br><span class="line">  A(); &#x2F;&#x2F;调用</span><br><span class="line">  @autoreleasepool&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以在调用处 A(); 打断点调试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-&gt; 0x10031a7f0 &lt;+24&gt;: bl 0x10031ab44</span><br></pre></td></tr></table></figure>

<p>s 指令进入，就到了上面的汇编指令了，ni 按汇编指令一步步往下走</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(lldb)s</span><br><span class="line">(lldb)ni</span><br></pre></td></tr></table></figure>

<ul>
<li>LR 寄存器</li>
</ul>
<p>也称为 X30 寄存器，指向返回地址，存储函数调用完成时的返回地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-&gt; 0x10439ab38 &lt;+4&gt;: bl   0x10439ab44</span><br><span class="line">	 0x10439ab3c &lt;+8&gt;: mov  x0, #0xaaaa</span><br></pre></td></tr></table></figure>

<p>lr 值就是 0x10439ab3c</p>
<h4 id="状态寄存器-CPSR"><a href="#状态寄存器-CPSR" class="headerlink" title="状态寄存器 CPSR"></a>状态寄存器 CPSR</h4><p>状态寄存器用来保存指令运行结果的一些信息，比如相加结果是否溢出、是否为0及是否为负数，和其它寄存器不一样，其它寄存器是用来存放数据的，都是整个寄存器具有一个含义</p>
<p>而 CPSR 寄存器是按位起作用，每一位都有专门含义</p>
<p>CPSR 寄存器是 32 位的</p>
<ul>
<li>低 8 位（包括 I、F、T 和 M[0-4]）称为控制位，程序无法修改，除非 CPU 运行与特权模式下，程序才能修改</li>
<li>N、Z、C、V 均为条件码标志位，内容可被算术或逻辑运算的结果所改变，并且可以决定某条指令是否被执行</li>
</ul>
<img src="逆向-汇编/图片.png" alt="15201620642085" style="zoom:70%;" />

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">funcC</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> b = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (a == b) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;a == b&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;a != b&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>if(a == b)</code>   处打断点调试，查看汇编代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b.ne 0x102fc68f8  &#x2F;&#x2F;带条件的跳转</span><br></pre></td></tr></table></figure>

<p>断点到 b.ne 后，查看 CPSR 寄存器</p>
<p>控制台 选择All Variable 可以看到寄存器的参数<br>查看 cpsr 寄存器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cpsr &#x3D; (unsigned int) 0x80000000</span><br></pre></td></tr></table></figure>

<p>第一个16进制位是 8，代表 N、Z、C、V  这 4 个二进制位</p>
<p> 16 进制 0x8，转换成二进制就是 1000 （可以用计算器计算）</p>
<p>正常流程结果是打印 <code>a != b</code></p>
<p>现在将修改 cpsr 寄存器的值为 0100 就是 0x4</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(lldb) register write cpsr <span class="number">0x40000000</span></span><br><span class="line">(lldb) register read cpsr</span><br><span class="line">cpsr = <span class="number">0x40000000</span></span><br><span class="line">(lldb) c</span><br><span class="line">a == b</span><br></pre></td></tr></table></figure>

<h5 id="N"><a href="#N" class="headerlink" title="N"></a>N</h5><p>符号标志位，两个有符号整数进行运算时，N=1 表示结果为负数；N=0 表示运行结果为正数或0</p>
<h5 id="Z"><a href="#Z" class="headerlink" title="Z"></a>Z</h5><p>0 标志位，Z=1 表示运算结果为零；Z=0 表示运算结果为非领</p>
<h5 id="C"><a href="#C" class="headerlink" title="C"></a>C</h5><p>进位标志位</p>
<p>加法运算：运算结果产生了进位 C=1 ，否则 C=0</p>
<p>减法运算：运算时产生了借位 C=0，否则 C=1</p>
<h5 id="V"><a href="#V" class="headerlink" title="V"></a>V</h5><p>溢出标志位，V=1 表示符号位溢出</p>
<p>正数+正数为负数 溢出</p>
<p>负数+负数为正数 溢出</p>
<p>正数+负数 不可能溢出</p>
<h4 id="常见ARM64指令集"><a href="#常见ARM64指令集" class="headerlink" title="常见ARM64指令集"></a>常见ARM64指令集</h4><h5 id="算术指令"><a href="#算术指令" class="headerlink" title="算术指令"></a>算术指令</h5><p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E5%B8%B8%E7%94%A8%E7%AE%97%E6%9C%AF%E6%8C%87%E4%BB%A4.png" alt="常用算术指令"></p>
<h5 id="跳转指令"><a href="#跳转指令" class="headerlink" title="跳转指令"></a>跳转指令</h5><p>条件跳转<img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E5%B8%B8%E7%94%A8%E8%B7%B3%E8%BD%AC%E6%8C%87%E4%BB%A4.png" alt="常用跳转指令"></p>
<p>无条件跳转</p>
<p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E6%97%A0%E6%9D%A1%E4%BB%B6%E8%B7%B3%E8%BD%AC.png" alt="无条件跳转"></p>
<h5 id="逻辑指令"><a href="#逻辑指令" class="headerlink" title="逻辑指令"></a>逻辑指令</h5><p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E5%B8%B8%E7%94%A8%E9%80%BB%E8%BE%91%E6%8C%87%E4%BB%A4.png" alt="常用逻辑指令"></p>
<h5 id="数据传输指令"><a href="#数据传输指令" class="headerlink" title="数据传输指令"></a>数据传输指令</h5><p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E6%8C%87%E4%BB%A4.png" alt="常用数据传输指令"></p>
<h5 id="地址偏移指令"><a href="#地址偏移指令" class="headerlink" title="地址偏移指令"></a>地址偏移指令</h5><p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E5%B8%B8%E7%94%A8%E5%9C%B0%E5%9D%80%E5%81%8F%E7%A7%BB%E6%8C%87%E4%BB%A4.png" alt="常用地址偏移指令"></p>
<h5 id="移位运算指令"><a href="#移位运算指令" class="headerlink" title="移位运算指令"></a>移位运算指令</h5><p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E5%B8%B8%E7%94%A8%E7%A7%BB%E4%BD%8D%E8%BF%90%E7%AE%97%E6%8C%87%E4%BB%A4.png" alt="常用移位运算指令"></p>
<h5 id="加载-存储指令"><a href="#加载-存储指令" class="headerlink" title="加载/存储指令"></a>加载/存储指令</h5><p>加载/存储指令都是成对出现的</p>
<p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E5%B8%B8%E7%94%A8%E5%8A%A0%E8%BD%BD:%E5%AD%98%E5%82%A8%E6%8C%87%E4%BB%A41.png" alt="常用加载:存储指令1"></p>
<p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E5%B8%B8%E7%94%A8%E5%8A%A0%E8%BD%BD:%E5%AD%98%E5%82%A8%E6%8C%87%E4%BB%A42.png" alt="常用加载:存储指令2"></p>
<p>ARM 指令的一个重要特点是可以条件执行，每条 ARM 指令的条件码域包含 4 位条件码，共16种</p>
<p>几乎所有指令均根据 CPSR 中条件码的状态和指令条件码域的设置有条件地执行，当指令执行条件满足时，指令被执行，否则被忽略</p>
<p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E6%8C%87%E4%BB%A4%E6%9D%A1%E4%BB%B6%E7%A0%81.png" alt="指令条件码"></p>
<h4 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h4><p>栈的增长方向是从高地址到低地址的。栈低是高地址，栈顶是低地址</p>
<p>后进先出，高地址向低地址扩展数据结构</p>
<img src="逆向-汇编/栈.png" alt="栈" style="zoom:50%;" />



<ul>
<li>str（store register）指令</li>
</ul>
<p>将数据从寄存器中读出来，存到内存</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">str w0,[x8]  w0取出放到x8所指向的地方</span><br></pre></td></tr></table></figure>

<ul>
<li>ldr（load register） 指令</li>
</ul>
<p>将数据从内存中读出来，存到寄存器中</p>
<p>str 和 ldr 的变种 ldp 和 stp 还可以操作 2 个寄存器</p>
<p><u>函数的调用会开辟栈帧，在AArch64 中，函数的参数是通过 X0~X7 传递的</u></p>
<p>函数的返回值使用 X0 寄存器保存</p>
<p>X1 是方法名，X2是第一个参数</p>
<p>编译器生成汇编时，首先会计算所需要的栈空间大小。</p>
<p>方法的头部通过 <u>向下</u> 移动SP指针在栈上分配空间，把当前FP和LR保存起来</p>
<p>方法的尾部恢复栈上的FP和LR到寄存器，然后向上移动栈指针SP，来释放栈上的内存。这两部分其实也是为了保持栈平衡，前面开辟了多少空间，调用结束后就需要归还多少，从而恢复成函数调用前的样子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sub sp, sp, #0x20 ;拉伸栈空间</span><br><span class="line">stp x29, x30, [sp, #0x20] ;保存x29(FP)和x30(LR)寄存器</span><br><span class="line">add x29, sp, #0x20 	; 抬高栈底</span><br><span class="line">...</span><br><span class="line">ldp x29,x30,[sp, #0x20] ;还原x29和x30</span><br><span class="line">add sp, sp, #0x30 ;释放栈空间</span><br></pre></td></tr></table></figure>









<ul>
<li>函数嵌套调用：会将 X29、X30寄存器入栈保护</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">int g &#x3D; 12;</span><br><span class="line"></span><br><span class="line">int func(int a, int b)&#123;</span><br><span class="line">    printf(&quot;haha&quot;);</span><br><span class="line">    int c &#x3D; a + g;</span><br><span class="line">    return c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc, char * argv[]) &#123;</span><br><span class="line">    func(10, 20);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>printf(&quot;haha&quot;)</code> 处打断点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">	  0x102732730 &lt;+20&gt;: adrp   x0, 1</span><br><span class="line">    0x102732734 &lt;+24&gt;: add    x0, x0, #0xf2b      ; &#x3D;0xf2b </span><br><span class="line">-&gt;  0x102732738 &lt;+28&gt;: bl     0x102732a7c         ; symbol stub for: printf</span><br></pre></td></tr></table></figure>

<p>X0 存储的是第一个参数，动态调试可以直接打印 X0 的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(lldb) register read $x0</span><br><span class="line">      x0 &#x3D; 0x0000000102733f2b  &quot;haha&quot;</span><br></pre></td></tr></table></figure>

<p>分析</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">0x102732730 &lt;+20&gt;: adrp   x0, 1</span><br><span class="line">adrp 就是 address page, 每一页就是 4k，4k就是 12 位</span><br><span class="line">意思是</span><br><span class="line">将 1 左移 12 位，(1后面补上12个0) -&gt; 0x1000 (用计算器)</span><br><span class="line">将当前 pc 寄存器值 0x102732730，低 12 位清 0 -&gt; 0x102732000</span><br><span class="line">相加赋值给 X0 0x102732000+0x1000 &#x3D; 0x102733000</span><br><span class="line"></span><br><span class="line">0x102732734 &lt;+24&gt;: add    x0, x0, #0xf2b      ; &#x3D;0xf2b</span><br><span class="line">X0 加上 0xf2b </span><br><span class="line">(lldb) p&#x2F;x 0x102733000+0xf2b</span><br><span class="line">(long) $0 &#x3D; 0x0000000102733f2b</span><br><span class="line">常量地址就找到了 -&gt; p (char*)0x0000000102733f2b</span><br><span class="line">(char *) $3 &#x3D; 0x0000000102733f2b &quot;haha&quot;</span><br></pre></td></tr></table></figure>



<h4 id="循环选择判断"><a href="#循环选择判断" class="headerlink" title="循环选择判断"></a>循环选择判断</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmp w0, w1</span><br></pre></td></tr></table></figure>

<p>cmp 比较指令</p>
<p>BL标号：跳转到标号处执行<br>B.GT 比较结果是大于，执行标号，否则不跳转<br>B.GE 比较结果是大于等于，执行标号，否则不跳转<br>B.GQ 比较结果是等于，执行标号，否则不跳转<br>B.HI 比较结果是无符号大于，执行标号，否则不跳转</p>
<p>b.le 小于等于<br>b.lt 小于</p>
<p>dowhile循环：判断条件在后面，满足条件往前跳<br>while循环：判断条件在里面，不满足就往外跳</p>
<h4 id="Objc汇编机制"><a href="#Objc汇编机制" class="headerlink" title="Objc汇编机制"></a>Objc汇编机制</h4><p>OC 中 X0 寄存器保存了对象本身</p>
<p>X1 寄存器保存了方法名</p>
<p>X2 ~ X7 开始是参数，其它参数通过栈传递，由于是 64 位的程序，所以每 8 个字节一组</p>
<h4 id="ARM64"><a href="#ARM64" class="headerlink" title="ARM64"></a>ARM64</h4><p>汇编代码里以点 . 开头的关键字不是指令而是助记符，也叫作伪指令，它不会被编译成机器码，作用是告诉编译器做一些特殊的操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.extern 声明外部函数</span><br><span class="line">.align  字节对齐的方式，如4字节对齐 .align 4</span><br><span class="line">.data   数据段，用于存储需要用到的数据</span><br><span class="line">.text   代码段，告诉编译器代码生成的二进制机器码会保存在代码段</span><br><span class="line">.global 表示一个全局符号</span><br></pre></td></tr></table></figure>





<h4 id="内联汇编"><a href="#内联汇编" class="headerlink" title="内联汇编"></a>内联汇编</h4><p>高级语言中嵌入汇编代码，这种方式称为内联汇编</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">asm &#123;volatile&#125;(&quot;汇编语句模板&quot;</span><br><span class="line">	:输出(可选)</span><br><span class="line">	:输入(可选)</span><br><span class="line">	:会被破坏的寄存器(可选)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>包含 4 个部分，各部分用 ：分隔。汇编语句模板必不可少，其它三部分可选，如果使用了后面部分，而前面部分为空，也需要用 ：分隔，相应部分内容为空</p>
<p>参数 volatile 可选，如果用了它，则告诉编译器不允许对该内联汇编进行优化，否则启动优化选项(-O)进行编译时，汇编代码会被编译器优化的面目全非</p>
<p>Xcode 写个加法函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">int arm_sum(int a, int b) &#123;</span><br><span class="line">    int sum &#x3D; 0;</span><br><span class="line">    asm volatile(</span><br><span class="line">                &quot;add %w0, %w1, %w2&quot; </span><br><span class="line">                 : &quot;&#x3D;r&quot; (sum)</span><br><span class="line">                 : &quot;r&quot; (a), &quot;r&quot; (b)</span><br><span class="line">                 :);</span><br><span class="line">    return sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一行：汇编语句模板 %w0, %w1, %w2 代表指令的操作数，称为占位符。内联汇编根据它们将C语言表达式与指令操作数对应起来</p>
<p>模板后面的小括号内是C语言表达式</p>
<p>上面表达式有3个 sum、a、b，按照出现顺序分别与指令操作数%0、%1、%2 对应，操作数最多只能有10个。百分号 % 后面的字母表示这个变量的位宽，w 表示 32 位，x 表示 64 位。</p>
<p>第二行：输出参数，= 号表示，sum是输出操作符，r 表示需要将 sum 与某个通用寄存器相关联</p>
<p>第三行：输入参数，r 表示该表达式需要先放入某个寄存器，然后在指令中使用该寄存器参与运算</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#汇编指令，如果多句用\t\n来分割</span><br><span class="line">asm(</span><br><span class="line">&quot;mov x0,1\t\n&quot;</span><br><span class="line">&quot;mov x1,2\t\n&quot;</span><br><span class="line">...</span><br><span class="line">)</span><br></pre></td></tr></table></figure>







<h4 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h4><p>在反汇编代码窗口输入分号，就能够添加注释</p>
<h4 id="Hopper"><a href="#Hopper" class="headerlink" title="Hopper"></a>Hopper</h4><p>在反汇编窗口输入分号能够对代码添加注释，使用 shift+; 组合键可以在代码所在的行后面添加注释</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>





  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">daxun</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  <script src="/js/local-search.js"></script>















  








  

  

</body>
</html>
