<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Block</title>
    <url>/2021/05/19/Block/</url>
    <content><![CDATA[<h5 id="Block"><a href="#Block" class="headerlink" title="Block"></a>Block</h5><ul>
<li>将<code>函数</code>及其<code>执行上下文（函数执行环境）</code>封装起来的<code>对象</code></li>
<li>Block内部有<code>isa</code> 指针，所以说其本质也是OC对象</li>
<li>Block的调用即是<code>函数的调用</code></li>
</ul>
<p>新建方法</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">void</span>(^blk)(<span class="keyword">void</span>) = ^&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;MCBlock&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">    blk();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 <code>clang</code> 编译器编译 <code>clang -rewrite-objc main.m</code>  将代码转换成 <code>C++</code> 源码</p>
<h5 id="main-block-impl-0"><a href="#main-block-impl-0" class="headerlink" title="__main_block_impl_0"></a>__main_block_impl_0</h5><p>编译后的代码</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">main_block_impl_0</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> <span class="title">impl</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span>* <span class="title">Desc</span>;</span></span><br><span class="line">  __main_block_impl_0(<span class="keyword">void</span> *fp, struct __main_block_desc_0 *desc, <span class="keyword">int</span> flags=<span class="number">0</span>) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;MCBlock&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span> &#123;</span></span><br><span class="line">  <span class="keyword">size_t</span> reserved;</span><br><span class="line">  <span class="keyword">size_t</span> Block_size;</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(struct __main_block_impl_0)&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">void</span>(*blk)(<span class="keyword">void</span>) = ((<span class="keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA));</span><br><span class="line">    ((<span class="keyword">void</span> (*)(__block_impl *))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先看 <code>Block</code> 语法部分</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">^&#123;</span><br><span class="line">    printf(&quot;MCBlock&quot;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>转换后的源码</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;MCBlock&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过 <code>Block</code> 使用的匿名函数实际上被作为简单的 C 语言函数来处理，<code>__main_block_func_0</code>  <code>main</code> 是 <code>Block</code> 语法所属的函数名，<code>0</code> 是 <code>Block</code> 语法在该函数出现的顺序值</p>
<p><code>__cself</code> 相当于指向自身实例的变量 <code>self</code> ，是指向 <code>Block</code> 值的变量</p>
<p>参数声明部分，结构体 <code>__main_block_impl_0</code> 声明如下：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">main_block_impl_0</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> <span class="title">impl</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span>* <span class="title">Desc</span>;</span></span><br><span class="line">  __main_block_impl_0(<span class="keyword">void</span> *fp, struct __main_block_desc_0 *desc, <span class="keyword">int</span> flags=<span class="number">0</span>) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>转换后的源码中，一并写入了其构造函数，除去构造函数，该结构体有两个成员变量</p>
<p>第一个成员变量 <code>struct __block_impl impl</code></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> &#123;</span></span><br><span class="line">  <span class="keyword">void</span> *isa;</span><br><span class="line">  <span class="keyword">int</span> Flags; 		 <span class="comment">//标记位</span></span><br><span class="line">  <span class="keyword">int</span> Reserved;	 <span class="comment">//预留位</span></span><br><span class="line">  <span class="keyword">void</span> *FuncPtr; <span class="comment">//函数指针</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>第二个成员变量 <code>struct __main_block_desc_0* Desc</code></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span> &#123;</span></span><br><span class="line">  <span class="keyword">size_t</span> reserved;		<span class="comment">//预留位</span></span><br><span class="line">  <span class="keyword">size_t</span> Block_size;	<span class="comment">//结构体大小</span></span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(struct __main_block_impl_0)&#125;;</span><br></pre></td></tr></table></figure>

<p>再看下 <code>__main_block_impl_0</code> 构造函数部分</p>
<p>先看下函数的调用 </p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span>(*blk)(<span class="keyword">void</span>) = ((<span class="keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA));</span><br></pre></td></tr></table></figure>

<p>转换比较多，去掉转换部分</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">main_block_impl_0</span> *<span class="title">blk</span> =</span> </span><br><span class="line">  __main_block_impl_0(__main_block_func_0, &amp;__main_block_desc_0_DATA)</span><br></pre></td></tr></table></figure>

<p>第一个参数是 C 语言函数指针，第二个参数 block 描述</p>
<p>结构体根据构造函数，会像下面进行初始化</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">Flags = <span class="number">0</span>;</span><br><span class="line">Reserved = <span class="number">0</span>;</span><br><span class="line">FuncPtr = __main_block_func_0;</span><br><span class="line">Desc = &amp;__main_block_desc_0_DATA;</span><br></pre></td></tr></table></figure>

<p>将函数指针 <code>__main_block_func_0</code> 赋值给成员变量 <code>FuncPtr</code></p>
<p>使用 <code>Block</code> 的部分</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">blk();</span><br></pre></td></tr></table></figure>

<p>转换成源代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">((void (*)(__block_impl *))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk);</span><br><span class="line">    return 0;</span><br></pre></td></tr></table></figure>

<p>去掉转换的部分</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">(*blk-&gt;impl.FuncPtr)(blk);</span><br></pre></td></tr></table></figure>

<p>通过函数指针找到函数执行体，这就是简单的使用函数指针调用函数</p>
<h5 id="捕获变量"><a href="#捕获变量" class="headerlink" title="捕获变量"></a>捕获变量</h5><ul>
<li>Block捕获值，内部结构体会新增同名成员变量，保存传进来的值</li>
<li>对基本数据类型的局部变量捕获其值</li>
<li>对于对象类型的局部变量连同所有权修饰符一起截获</li>
<li>以指针形式截获静态局部变量</li>
<li>不截获全局变量、静态全局变量</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;全局变量</span><br><span class="line">int global_var &#x3D; 4;</span><br><span class="line">&#x2F;&#x2F;静态全局变量</span><br><span class="line">static int static_global_var &#x3D; 5;</span><br><span class="line">- (void)method</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F;基本数据类型局部变量</span><br><span class="line">    int var &#x3D; 1;</span><br><span class="line">    &#x2F;&#x2F;对象类型局部变量</span><br><span class="line">    __unsafe_unretained id unsafe_obj &#x3D; nil;</span><br><span class="line">    __strong id strong_obj &#x3D; nil;</span><br><span class="line">    &#x2F;&#x2F;静态局部变量</span><br><span class="line">    static int static_var &#x3D; 3;</span><br><span class="line">    void(^Block)(void) &#x3D; ^(void) &#123;</span><br><span class="line">        NSLog(@&quot;局部变量&lt;基本数据类型&gt; var %d&quot;, var);</span><br><span class="line">        NSLog(@&quot;局部变量&lt;__unsafe_unretained 对象类型&gt; var %@&quot;, unsafe_obj);</span><br><span class="line">        NSLog(@&quot;局部变量&lt;__strong 对象类型&gt; var %@&quot;, strong_obj);</span><br><span class="line">        NSLog(@&quot;静态变量 %d&quot;, static_var);</span><br><span class="line">        NSLog(@&quot;全局变量 %d&quot;, global_var);</span><br><span class="line">        NSLog(@&quot;静态全局变量 %d&quot;, static_global_var);</span><br><span class="line">    &#125;;</span><br><span class="line">    Block();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>clang</code> 编译源码 </p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> global_var = <span class="number">4</span>;</span><br><span class="line"><span class="comment">//对全局变量、静态全局变量不截获</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> static_global_var = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">MCBlock__method_block_impl_0</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> <span class="title">impl</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">MCBlock__method_block_desc_0</span>* <span class="title">Desc</span>;</span></span><br><span class="line">  <span class="keyword">int</span> var; <span class="comment">//捕获局部变量</span></span><br><span class="line">  __unsafe_unretained id unsafe_obj;<span class="comment">//连同所有权修饰符一起截获</span></span><br><span class="line">  __strong id strong_obj;</span><br><span class="line">  <span class="keyword">int</span> *static_var; <span class="comment">//以指针针形式截获静态局部变量</span></span><br><span class="line">  __MCBlock__method_block_impl_0(<span class="keyword">void</span> *fp, struct __MCBlock__method_block_desc_0 *desc, <span class="keyword">int</span> _var, __unsafe_unretained id _unsafe_obj, __strong id _strong_obj, <span class="keyword">int</span> *_static_var, <span class="keyword">int</span> flags=<span class="number">0</span>) : var(_var), unsafe_obj(_unsafe_obj), strong_obj(_strong_obj), static_var(_static_var) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> dmy = <span class="number">256</span>;</span><br><span class="line">    <span class="keyword">int</span> val = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *fmt = <span class="string">&quot;val = %d&quot;</span>;</span><br><span class="line">    <span class="keyword">void</span> (^blk)(<span class="keyword">void</span>) = ^&#123; <span class="built_in">printf</span>(fmt, val); &#125;;</span><br><span class="line">    val = <span class="number">2</span>;</span><br><span class="line">    fmt = <span class="string">&quot;value changed. val = %d&quot;</span>;</span><br><span class="line">    blk();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果 <code>val = 10</code></p>
<p><code>clang</code> 编译源码 </p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">main_block_impl_0</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> <span class="title">impl</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span>* <span class="title">Desc</span>;</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *fmt;</span><br><span class="line">  <span class="keyword">int</span> val;</span><br><span class="line">  __main_block_impl_0(<span class="keyword">void</span> *fp, struct __main_block_desc_0 *desc, <span class="keyword">const</span> <span class="keyword">char</span> *_fmt, <span class="keyword">int</span> _val, <span class="keyword">int</span> flags=<span class="number">0</span>) : fmt(_fmt), val(_val) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *fmt = __cself-&gt;fmt; <span class="comment">// bound by copy</span></span><br><span class="line">  <span class="keyword">int</span> val = __cself-&gt;val; <span class="comment">// bound by copy</span></span><br><span class="line"> <span class="built_in">printf</span>(fmt, val); &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span> &#123;</span></span><br><span class="line">  <span class="keyword">size_t</span> reserved;</span><br><span class="line">  <span class="keyword">size_t</span> Block_size;</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(struct __main_block_impl_0)&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> dmy = <span class="number">256</span>;</span><br><span class="line">    <span class="keyword">int</span> val = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *fmt = <span class="string">&quot;val = %d&quot;</span>;</span><br><span class="line">    <span class="keyword">void</span> (*blk)(<span class="keyword">void</span>) = ((<span class="keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, fmt, val));</span><br><span class="line">    val = <span class="number">2</span>;</span><br><span class="line">    fmt = <span class="string">&quot;value changed. val = %d&quot;</span>;</span><br><span class="line">    ((<span class="keyword">void</span> (*)(__block_impl *))((__block_impl *)blk)-&gt;FuncPtr)((__block_impl *)blk);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">IMAGE_INFO</span> &#123;</span> <span class="keyword">unsigned</span> version; <span class="keyword">unsigned</span> flag; &#125; _OBJC_IMAGE_INFO = &#123; <span class="number">0</span>, <span class="number">2</span> &#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到 <code>Block</code> 语法表达式中使用的局部变量追加到了 <code>__main_block_impl_0</code> 中</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">main_block_impl_0</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> <span class="title">impl</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span>* <span class="title">Desc</span>;</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *fmt;</span><br><span class="line">  <span class="keyword">int</span> val;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>Block</code> 的匿名函数实现</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">^&#123; <span class="built_in">printf</span>(fmt, val); &#125;;</span><br></pre></td></tr></table></figure>

<p>转换成以下函数</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *fmt = __cself-&gt;fmt; <span class="comment">// bound by copy</span></span><br><span class="line">  <span class="keyword">int</span> val = __cself-&gt;val; <span class="comment">// bound by copy</span></span><br><span class="line"> <span class="built_in">printf</span>(fmt, val); &#125;</span><br></pre></td></tr></table></figure>

<p>执行 <code>Block</code> 时，<code>Block</code> 语法表达式中使用的局部变量被保存到 <code>Block</code> 的结构体实例（ 即<code>Block</code> 自身）中</p>
<h5 id="block"><a href="#block" class="headerlink" title="__block"></a>__block</h5><p><code>__block</code> 说明符类似于 <code>auto</code> <code>static</code> 用于指定将变量值设置到哪个存储域中</p>
<p>例如，<code>auto</code> 表示作为自动变量存储在栈中，<code>static</code> 表示作为静态变量存储在数据区中</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    __block <span class="keyword">int</span> val = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">void</span> (^blk)(<span class="keyword">void</span>) = ^&#123;val = <span class="number">1</span>;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>clang</code> 编译后</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">Block_byref_val_0</span> &#123;</span></span><br><span class="line">  <span class="keyword">void</span> *__isa;</span><br><span class="line">__Block_byref_val_0 *__forwarding;</span><br><span class="line"> <span class="keyword">int</span> __flags;</span><br><span class="line"> <span class="keyword">int</span> __size;</span><br><span class="line"> <span class="keyword">int</span> val;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">main_block_impl_0</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">block_impl</span> <span class="title">impl</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span>* <span class="title">Desc</span>;</span></span><br><span class="line">  __Block_byref_val_0 *val; <span class="comment">// by ref</span></span><br><span class="line">  __main_block_impl_0(<span class="keyword">void</span> *fp, struct __main_block_desc_0 *desc, __Block_byref_val_0 *_val, <span class="keyword">int</span> flags=<span class="number">0</span>) : val(_val-&gt;__forwarding) &#123;</span><br><span class="line">    impl.isa = &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags = flags;</span><br><span class="line">    impl.FuncPtr = fp;</span><br><span class="line">    Desc = desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</span><br><span class="line">  __Block_byref_val_0 *val = __cself-&gt;val; <span class="comment">// bound by ref</span></span><br><span class="line">(val-&gt;__forwarding-&gt;val) = <span class="number">1</span>;&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_copy_0(struct __main_block_impl_0*dst, struct __main_block_impl_0*src) &#123;_Block_object_assign((<span class="keyword">void</span>*)&amp;dst-&gt;val, (<span class="keyword">void</span>*)src-&gt;val, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_dispose_0(struct __main_block_impl_0*src) &#123;_Block_object_dispose((<span class="keyword">void</span>*)src-&gt;val, <span class="number">8</span><span class="comment">/*BLOCK_FIELD_IS_BYREF*/</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> __<span class="title">main_block_desc_0</span> &#123;</span></span><br><span class="line">  <span class="keyword">size_t</span> reserved;</span><br><span class="line">  <span class="keyword">size_t</span> Block_size;</span><br><span class="line">  <span class="keyword">void</span> (*copy)(struct __main_block_impl_0*, struct __main_block_impl_0*);</span><br><span class="line">  <span class="keyword">void</span> (*dispose)(struct __main_block_impl_0*);</span><br><span class="line">&#125; __main_block_desc_0_DATA = &#123; <span class="number">0</span>, <span class="keyword">sizeof</span>(struct __main_block_impl_0), __main_block_copy_0, __main_block_dispose_0&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    __attribute__((__blocks__(byref))) __Block_byref_val_0 val = &#123;(<span class="keyword">void</span>*)<span class="number">0</span>,(__Block_byref_val_0 *)&amp;val, <span class="number">0</span>, <span class="keyword">sizeof</span>(__Block_byref_val_0), <span class="number">10</span>&#125;;</span><br><span class="line">    <span class="keyword">void</span> (*blk)(<span class="keyword">void</span>) = ((<span class="keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, (__Block_byref_val_0 *)&amp;val, <span class="number">570425344</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看声明部分 </p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">__attribute__((__blocks__(byref))) __Block_byref_val_0 val = &#123;(<span class="keyword">void</span>*)<span class="number">0</span>,(__Block_byref_val_0 *)&amp;val, <span class="number">0</span>, <span class="keyword">sizeof</span>(__Block_byref_val_0), <span class="number">10</span>&#125;;</span><br></pre></td></tr></table></figure>

<p>简化后</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">__Block_byref_val_0 val = &#123;<span class="number">0</span>,&amp;val, <span class="number">0</span>, <span class="keyword">sizeof</span>(__Block_byref_val_0), <span class="number">10</span>&#125;;</span><br></pre></td></tr></table></figure>

<p>局部变量加上 <code>__block</code> 修饰后，变成了结构体实例 <code>__Block_byref_val_0</code> ，保存原始变量的指针和值</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">Block_byref_val_0</span> &#123;</span></span><br><span class="line">  <span class="keyword">void</span> *__isa;</span><br><span class="line">__Block_byref_val_0 *__forwarding;</span><br><span class="line"> <span class="keyword">int</span> __flags;</span><br><span class="line"> <span class="keyword">int</span> __size;</span><br><span class="line"> <span class="keyword">int</span> val;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>调用</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> (*blk)(<span class="keyword">void</span>) = ((<span class="keyword">void</span> (*)())&amp;__main_block_impl_0((<span class="keyword">void</span> *)__main_block_func_0, &amp;__main_block_desc_0_DATA, (__Block_byref_val_0 *)&amp;val, <span class="number">570425344</span>));</span><br></pre></td></tr></table></figure>

<p><code>__main_block_impl_0</code> 中，将变量 <code>val</code> 生成的结构体对象的指针地址，传给 <code>Block</code> ，然后 <code>Block</code> 内部就可以对外界的变量进行操作了</p>
<p>查看给 <code>__block</code> 变量赋值部分 <code>^&#123;val = 1;&#125;;</code></p>
<p>转换后的源码</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</span><br><span class="line">  __Block_byref_val_0 *val = __cself-&gt;val; <span class="comment">// bound by ref</span></span><br><span class="line">(val-&gt;__forwarding-&gt;val) = <span class="number">1</span>;&#125;</span><br></pre></td></tr></table></figure>

<p><code>__Block_byref_val_0</code> 结构体实例的成员变量 <code>__forwarding</code> 持有指向该实例自身的指针。</p>
<p>通过成员变量 <code>__forwarding</code> 访问成员变量 <code>val</code></p>
<p><img src="/2021/05/19/Block/forwarding.png" alt="forwarding"></p>
<ul>
<li>一般情况下，对被截获的变量进行赋值操作需要添加 <code>__block</code> 修饰符</li>
<li>基本数据类型和对象类型的局部变量进行赋值时需要加 <code>__block</code> 修饰符</li>
<li>静态局部变量、静态全局变量、全局变量，进行赋值时不需要加 <code>__block</code> 修饰符</li>
</ul>
<h5 id="Block类型"><a href="#Block类型" class="headerlink" title="Block类型"></a>Block类型</h5><ul>
<li>_NSConcreteGlobalBlock（NSGlobalBlock）全局 <code>Block</code> ，存储在程序的数据区（.data区）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">void(^blk)(void) &#x3D; ^&#123;</span><br><span class="line">    printf(&quot;MCBlock\n&quot;);</span><br><span class="line">&#125;;</span><br><span class="line">NSLog(@&quot;%@&quot;, blk);</span><br></pre></td></tr></table></figure>

<p>此时的 <code>Block</code> 无参也无返回值，属于全局 <code>Block</code> </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;__NSGlobalBlock__: 0x100004030&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>_NSConcreteStackBlock（NSStackBlock）栈 <code>Block</code> ，存放在栈上</p>
</li>
<li><p>_NSConcreteMallocBlock（NSMallocBlock）堆 <code>Block </code>，存储在堆上</p>
</li>
</ul>
<p>不使用外部变量的 Block 是全局 Block</p>
<p>使用外部变量并且未进行 copy 操作的 Block 是栈 Block</p>
<p>对栈 Block 进行 copy 操作，就是堆 Block，对全局 Block 进行 copy，仍是全局 Block</p>
<p>对 Block 的 copy 操作</p>
<p><img src="/2021/05/19/Block/copy.png" alt="copy"></p>
<p>对栈上Block进行copy操作，copy结果-&gt;在堆上产生一个Block</p>
<p><img src="/2021/05/19/Block/block2.png" alt="block2"></p>
<p><code>Block</code>  在栈上时 <code>__Block_byref_val_0</code> 结构体内 <code>__forwarding</code> 指针指向结构体自己</p>
<p><code>Block</code> 被复制到堆中时，<code>__Block_byref_val_0</code> 结构体也被复制到堆中一份</p>
<p>栈上 <code>__Block_byref_val_0</code> 结构体中的  <code>__forwarding</code>  指针指向堆中 <code>__Block_byref_val_0</code> 结构体</p>
<p>堆上  <code>__Block_byref_val_0</code> 结构体中的  <code>__forwarding</code>  指针指向结构体自己</p>
<ul>
<li><code>__forwarding</code> 指针存在的意义：</li>
</ul>
<p>不论在任何内存位置，都可以顺利访问同一个 <code>__block</code> 变量</p>
<p>无论 <code>__block</code> 变量配置在栈上还是堆上时，都能正确的访问 <code>__block</code> 变量</p>
]]></content>
  </entry>
  <entry>
    <title>Flutter.cn</title>
    <url>/2022/02/16/FlutterCn%EF%BC%88%E4%B8%80%EF%BC%89Flutter%E5%B8%83%E5%B1%80/</url>
    <content><![CDATA[<h4 id="横向或纵向布局多个-widgets"><a href="#横向或纵向布局多个-widgets" class="headerlink" title="横向或纵向布局多个 widgets"></a>横向或纵向布局多个 widgets</h4><p>可以指定 Row 或 Column 如何在水平或者垂直方向上对齐其子项</p>
<p>可以指定子 widgets 如何占用 Row 或 Column 的可用空间</p>
<h5 id="对齐widgets"><a href="#对齐widgets" class="headerlink" title="对齐widgets"></a>对齐widgets</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/rendering.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  <span class="comment">//设置为true，可以看到可视布局</span></span><br><span class="line">  debugPaintSizeEnabled = <span class="keyword">true</span>;</span><br><span class="line">  runApp(<span class="keyword">const</span> LayoutDemo());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LayoutDemo</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> LayoutDemo(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> MaterialApp(</span><br><span class="line">      title: <span class="string">&#x27;Flutter layout demo&#x27;</span>,</span><br><span class="line">      home: Scaffold(</span><br><span class="line">        appBar: AppBar(</span><br><span class="line">          title: Text(<span class="string">&#x27;Flutter layout demo&#x27;</span>),</span><br><span class="line">        ),</span><br><span class="line">        body: Center(</span><br><span class="line">          child: buildRow(),</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//设置主轴对齐方式为spaceEvenly，会将剩余空间在每个图像之间、之前和之后均匀划分</span></span><br><span class="line">  Widget buildRow() =&gt;</span><br><span class="line">      Row(</span><br><span class="line">        mainAxisAlignment: MainAxisAlignment.spaceEvenly,</span><br><span class="line">        children: [</span><br><span class="line">          Image.asset(<span class="string">&#x27;img/pic1.jpg&#x27;</span>),</span><br><span class="line">          Image.asset(<span class="string">&#x27;img/pic2.jpg&#x27;</span>),</span><br><span class="line">          Image.asset(<span class="string">&#x27;img/pic3.jpg&#x27;</span>),</span><br><span class="line">        ],</span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line">  Widget buildColumn() =&gt;</span><br><span class="line">      Column(</span><br><span class="line">        mainAxisAlignment: MainAxisAlignment.spaceEvenly,</span><br><span class="line">        children: [</span><br><span class="line">          Image.asset(<span class="string">&#x27;img/pic1.jpg&#x27;</span>),</span><br><span class="line">          Image.asset(<span class="string">&#x27;img/pic2.jpg&#x27;</span>),</span><br><span class="line">          Image.asset(<span class="string">&#x27;img/pic3.jpg&#x27;</span>),</span><br><span class="line">        ],</span><br><span class="line">      );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="调整widgets大小"><a href="#调整widgets大小" class="headerlink" title="调整widgets大小"></a>调整widgets大小</h5><p>当某个布局太大而超出屏幕时，受影响的边缘会出现黄色和黑色条纹图案</p>
<p>通过使用 Expanded widget 可以调整 widgets 的大小以适合行或列</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Row(</span><br><span class="line">  crossAxisAlignment: CrossAxisAlignment.center,</span><br><span class="line">  children: [</span><br><span class="line">    Expanded(</span><br><span class="line">      child: Image.asset(<span class="string">&#x27;images/pic1.jpg&#x27;</span>),</span><br><span class="line">    ),</span><br><span class="line">    Expanded(</span><br><span class="line">      child: Image.asset(<span class="string">&#x27;images/pic2.jpg&#x27;</span>),</span><br><span class="line">    ),</span><br><span class="line">    Expanded(</span><br><span class="line">      child: Image.asset(<span class="string">&#x27;images/pic3.jpg&#x27;</span>),</span><br><span class="line">    ),</span><br><span class="line">  ],</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>想要一个 widget 占用空间是兄弟项的两倍，可以使用 Expanded widget 的 flex 属性</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Row(</span><br><span class="line">  crossAxisAlignment: CrossAxisAlignment.center,</span><br><span class="line">  children: [</span><br><span class="line">    Expanded(</span><br><span class="line">      child: Image.asset(<span class="string">&#x27;images/pic1.jpg&#x27;</span>),</span><br><span class="line">    ),</span><br><span class="line">    Expanded(</span><br><span class="line">      flex: <span class="number">2</span>,</span><br><span class="line">      child: Image.asset(<span class="string">&#x27;images/pic2.jpg&#x27;</span>),</span><br><span class="line">    ),</span><br><span class="line">    Expanded(</span><br><span class="line">      child: Image.asset(<span class="string">&#x27;images/pic3.jpg&#x27;</span>),</span><br><span class="line">    ),</span><br><span class="line">  ],</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><img src="/FlutterCn%EF%BC%88%E4%B8%80%EF%BC%89Flutter%E5%B8%83%E5%B1%80/WeChat648aa69a2338cc1da9a5cdded93f8f16.png" alt="WeChat648aa69a2338cc1da9a5cdded93f8f16"></p>
<h5 id="组合widgets"><a href="#组合widgets" class="headerlink" title="组合widgets"></a>组合widgets</h5><p>默认情况下，行或列沿其主轴会占用尽可能多的空间，如果要将子项紧密组合在一起，将 mainAxisSize 设置为 MainAxisSize.min </p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Row(</span><br><span class="line">  mainAxisSize: MainAxisSize.min,</span><br><span class="line">  children: [</span><br><span class="line">    Icon(Icons.star, color: Colors.green[<span class="number">500</span>]),</span><br><span class="line">    Icon(Icons.star, color: Colors.green[<span class="number">500</span>]),</span><br><span class="line">    Icon(Icons.star, color: Colors.green[<span class="number">500</span>]),</span><br><span class="line">    <span class="keyword">const</span> Icon(Icons.star, color: Colors.black),</span><br><span class="line">    <span class="keyword">const</span> Icon(Icons.star, color: Colors.black),</span><br><span class="line">  ],</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><img src="/FlutterCn%EF%BC%88%E4%B8%80%EF%BC%89Flutter%E5%B8%83%E5%B1%80/WeChat9db897d81b3faa8300e97c87f80796cb.png" alt="WeChat9db897d81b3faa8300e97c87f80796cb"></p>
<h5 id="嵌套行和列"><a href="#嵌套行和列" class="headerlink" title="嵌套行和列"></a>嵌套行和列</h5><blockquote>
<p>为了最大限度地减少高度嵌套的布局代码可能导致的视觉错乱，可以在变量和函数中实现UI的各个部分</p>
</blockquote>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> stars = Row(</span><br><span class="line">  mainAxisSize: MainAxisSize.min,</span><br><span class="line">  children: [</span><br><span class="line">    Icon(Icons.star, color: Colors.green[<span class="number">500</span>]),</span><br><span class="line">    Icon(Icons.star, color: Colors.green[<span class="number">500</span>]),</span><br><span class="line">    Icon(Icons.star, color: Colors.green[<span class="number">500</span>]),</span><br><span class="line">    <span class="keyword">const</span> Icon(Icons.star, color: Colors.black),</span><br><span class="line">    <span class="keyword">const</span> Icon(Icons.star, color: Colors.black),</span><br><span class="line">  ],</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> ratings = Container(</span><br><span class="line">  padding: <span class="keyword">const</span> EdgeInsets.all(<span class="number">20</span>),</span><br><span class="line">  child: Row(</span><br><span class="line">    mainAxisAlignment: MainAxisAlignment.spaceEvenly,</span><br><span class="line">    children: [</span><br><span class="line">      stars,</span><br><span class="line">      <span class="keyword">const</span> Text(</span><br><span class="line">        <span class="string">&#x27;170 Reviews&#x27;</span>,</span><br><span class="line">        style: TextStyle(</span><br><span class="line">          color: Colors.black,</span><br><span class="line">          fontWeight: FontWeight.w800,</span><br><span class="line">          fontFamily: <span class="string">&#x27;Roboto&#x27;</span>,</span><br><span class="line">          letterSpacing: <span class="number">0.5</span>,</span><br><span class="line">          fontSize: <span class="number">20</span>,</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    ],</span><br><span class="line">  ),</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h4 id="通用布局-widgets"><a href="#通用布局-widgets" class="headerlink" title="通用布局 widgets"></a>通用布局 widgets</h4><p>下面 widget 会分为两类：widgets 库中的标准 widgets 和 Material 库中的 widgets，任何app都可以使用 widget库，但是 Material 库中的组件只能在 Material app 中使用</p>
<h5 id="标准-widgets"><a href="#标准-widgets" class="headerlink" title="标准 widgets"></a>标准 widgets</h5><p>Container：向 widget 增加 padding、margins、borders、background color 或者其他的“装饰”</p>
<p>GridView：将 widget 展示为一个可滚动的网格</p>
<p>ListView：将 widget 展示为一个可滚动的列表</p>
<p>Stack：将 widget 覆盖在另一个的上面</p>
<h5 id="Material-widgets"><a href="#Material-widgets" class="headerlink" title="Material widgets"></a>Material widgets</h5><p>Card：将相关信息整理到一个有圆角和阴影的盒子中</p>
<p>ListTitle：将最多三行的文本、可选的导语以及后面的图标组织在一行中</p>
<h5 id="Container"><a href="#Container" class="headerlink" title="Container"></a>Container</h5><p>许多布局都可以随意的用 Container，它可以将使用了 padding 或者增加了 borders/margins 的 widget 分开。你可以通过将整个布局放到一个 Container 中，并且改变它的背景色或者图片，来改变设备的背景</p>
<p>增加 padding、margins、borders<br>改变背景色或者图片<br>只包含一个子 widget，但是这个子 widget 可以是行、列或者是 widget 树的根 widget</p>
<p><img src="/FlutterCn%EF%BC%88%E4%B8%80%EF%BC%89Flutter%E5%B8%83%E5%B1%80/WeChatdc556c1945581f068555467d6a960f5b.png" alt="WeChatdc556c1945581f068555467d6a960f5b"></p>
<h5 id="GridView"><a href="#GridView" class="headerlink" title="GridView"></a>GridView</h5><p>GridView 将 widget 作为二维列表展示，提供了两个预制的列表，或者可以自定义网格，GridView 检测到内容太长而无法适应渲染盒时，就会自动支持滚动</p>
<p>GridView.count 允许你制定列的数量 GridView.extent 允许你制定单元格最大宽度</p>
<p>demo：gird_and_list、Flutter Gallery 中的  <a href="https://github.com/flutter/flutter/blob/master/dev/integration_tests/flutter_gallery/lib/demo/material/grid_list_demo.dart">grid_list_demo.dart</a></p>
<h4 id="国际化"><a href="#国际化" class="headerlink" title="国际化"></a>国际化</h4><p><a href="https://dart.cn/guides">Dart中文文档</a></p>
<p><a href="https://flutter.cn/docs/development/ui/widgets/layout">布局 Layout widgets</a></p>
<p><a href="https://flutter.cn/docs/development/ui/widgets/material">Material组件 Material Components widgets</a></p>
<p><a href="https://flutter.cn/docs/development/ui/advanced/gestures">Flutter中的手势</a></p>
<p><a href="https://flutter.cn/docs/development/tools/devtools/inspector#debugging-layout-issues-visually">使用Flutter inspector工具</a></p>
]]></content>
      <categories>
        <category>Flutter</category>
      </categories>
      <tags>
        <tag>Flutter</tag>
      </tags>
  </entry>
  <entry>
    <title>Flutter (一) 环境配置</title>
    <url>/2021/10/12/Flutter%EF%BC%88%E4%B8%80%EF%BC%89%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<h4 id="安装-Android-Studio"><a href="#安装-Android-Studio" class="headerlink" title="安装 Android Studio"></a>安装 Android Studio</h4><p><a href="%5Bhttps://developer.android.google.cn/studio%5D(https://links.jianshu.com/go?to=https://developer.android.google.cn/studio)">下载地址</a></p>
<p><a href="%5Bhttps://www.cnblogs.com/mengtaoadmin/p/11184052.html%5D(https://links.jianshu.com/go?to=https://www.cnblogs.com/mengtaoadmin/p/11184052.html)">Mac 上安装 Android Studio</a></p>
<h4 id="下载-Flutter-SDK"><a href="#下载-Flutter-SDK" class="headerlink" title="下载 Flutter SDK"></a>下载 Flutter SDK</h4><ul>
<li><p>方式1：<a href="https://flutter.dev/docs/get-started/install/macos">官网下载</a></p>
</li>
<li><p>方式2：</p>
</li>
</ul>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">git clone -b beta <span class="symbol">https:</span>/<span class="regexp">/github.com/flutter</span><span class="regexp">/flutter.git</span></span><br></pre></td></tr></table></figure>

<p>放在 opt 目录下 <code>/opt/flutter</code></p>
<h4 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h4><p><code>./zshrc</code> 中配置环境变量，配置完成后执行 <code>source ~/.zshrc</code></p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment">#Flutter 镜像配置</span></span><br><span class="line">export PUB_HOSTED_URL=<span class="symbol">https:</span>/<span class="regexp">/pub.flutter-io.cn</span></span><br><span class="line"><span class="regexp">export FLUTTER_STORAGE_BASE_URL=https:/</span><span class="regexp">/storage.flutter-io.cn</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">#Flutter 配置</span></span><br><span class="line"><span class="regexp">export FLUTTER=/opt</span><span class="regexp">/flutter/bin</span></span><br><span class="line">export PATH=$FLUTTER<span class="symbol">:</span>$PATH</span><br></pre></td></tr></table></figure>

<p>Flutter 有一个 doctor 检测指令，查看配置是否完成</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">flutter doctor</span><br></pre></td></tr></table></figure>

<p>报错</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">[!] Android toolchain - develop <span class="keyword">for</span> Android devices (Android SDK version <span class="number">31.0</span>.<span class="number">0</span>)</span><br><span class="line">    ✗ cmdline-tools component is missing</span><br><span class="line">      Run <span class="string">`path/to/sdkmanager --install &quot;cmdline-tools;latest&quot;`</span></span><br><span class="line">      See <span class="symbol">https:</span>/<span class="regexp">/developer.android.com/studio</span><span class="regexp">/command-line for more details.</span></span><br><span class="line"><span class="regexp">    ✗ Android license status unknown.</span></span><br><span class="line"><span class="regexp">      Run `flutter doctor --android-licenses` to accept the SDK licenses.</span></span><br><span class="line"><span class="regexp">      See https:/</span><span class="regexp">/flutter.dev/docs</span><span class="regexp">/get-started/install</span><span class="regexp">/macos#android-setup for more details.</span></span><br></pre></td></tr></table></figure>

<ul>
<li>解决 cmdline-tools component is missing 问题</li>
</ul>
<p>打开 Android Studio，Preferences-Appearance &amp; Beahvior-System Settings-Android SDK-SDK Tools</p>
<p>勾选 Android SDK Command-line Tools (latest)  OK</p>
<ul>
<li>解决 Android license status unknown 问题</li>
</ul>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">flutter doctor --android-licenses</span><br><span class="line"><span class="comment">#然后一直选择y</span></span><br></pre></td></tr></table></figure>

<ul>
<li>安装 Flutter 插件</li>
</ul>
<p>Preferences-Plugins 找到 Flutter 插件安装</p>
<p><a href="https://flutterchina.club/setup-macos/">Flutter中文网搭建Flutter开发环境</a><br><a href="https://www.jianshu.com/p/7662c2b1501f">Flutter专题目录汇总</a><br><a href="https://flutter.dev/docs">Flutter 官方文档: </a><br><a href="https://github.com/flutter/flutter">Flutter github 地址: </a><br><a href="https://flutterchina.club/">Flutter 中文网: </a><br><a href="https://juejin.im/tag/Flutter">Flutter 掘金标签: </a><br><a href="https://zhuanlan.zhihu.com/p/37232700">Flutter 仿写项目</a></p>
<p><a href="https://github.com/alibaba/flutter-go">阿里巴巴 flutter-go</a>：包含 flutter 常用140+组件的demo演示与中文文档<br><a href="https://gitee.com/qingdongmeng/flutter-do">老孟flutter</a><br><a href="https://docs.flutter.dev/development/tools/sdk/releases?tab=macos">Flutter SDK releases</a></p>
<p><a href="https://github.com/flutter/samples">Flutter samples</a></p>
]]></content>
      <categories>
        <category>Flutter</category>
      </categories>
      <tags>
        <tag>Flutter</tag>
      </tags>
  </entry>
  <entry>
    <title>FXForms</title>
    <url>/2021/12/06/FXForms/</url>
    <content><![CDATA[<h4 id="FXForms"><a href="#FXForms" class="headerlink" title="FXForms"></a>FXForms</h4><p>FXForms 框架提供了一个 FXFormViewController 视图控制器类，可以直接写继承于这个类的 ViewController 来便捷创建表单界面</p>
<p>FxForms 是通过节点配置的方式来进行表单创建的，表单中的每一个 Cell 都是一个节点</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@interface RootFormViewController : FXFormViewController</span><br><span class="line">@end</span><br><span class="line">@implementation RootFormViewController</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">  	&#x2F;&#x2F;节点信息设置</span><br><span class="line">    self.formController.form &#x3D; [MyForm new];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<h5 id="配置节点"><a href="#配置节点" class="headerlink" title="配置节点"></a>配置节点</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@interface MyForm : NSObject&lt;FXForm&gt;</span><br><span class="line">@property (nonatomic, copy) NSString *email;</span><br><span class="line">@property (nonatomic, copy) NSString *password;</span><br><span class="line">@property (nonatomic, assign) BOOL remember;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<p>上面的 MyForm 类定义了一些属性，如果不进行节点信息配置，FXForms 会自动根据节点属性来推断节点类型，NSString 类型的属性会被自动推断成带文本框的 Cell，BOOL 类型的属性会被自动推断成带 UISwitch 控件的 Cell</p>
<p><img src="/FXForms/WeChat8a22183ff8df3019ca8b1cca696d5910.png" alt="WeChat8a22183ff8df3019ca8b1cca696d5910"></p>
<h5 id="配置节点属性"><a href="#配置节点属性" class="headerlink" title="配置节点属性"></a>配置节点属性</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@implementation MyForm</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;方法名必须是 属性名+Field 返回为NSDictionary字典 字典中为节点的配置信息</span><br><span class="line">- (NSDictionary *)emailField &#123;</span><br><span class="line">    &#x2F;&#x2F;配置节点的类型 点击后 将弹出时间选择控件</span><br><span class="line">    return @&#123;FXFormFieldType: FXFormFieldTypeDate&#125;;</span><br><span class="line">&#125;</span><br><span class="line">- (NSDictionary *)passwordField &#123;</span><br><span class="line">    &#x2F;&#x2F;设置节点名称</span><br><span class="line">    return @&#123;FXFormFieldTitle: @&quot;名称&quot;&#125;;</span><br><span class="line">&#125;</span><br><span class="line">- (NSDictionary *)rememberField &#123;</span><br><span class="line">    &#x2F;&#x2F;设置节点头视图名称</span><br><span class="line">    return @&#123;FXFormFieldHeader: @&quot;配置&quot;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<h5 id="返回字典中可以配置的属性"><a href="#返回字典中可以配置的属性" class="headerlink" title="返回字典中可以配置的属性"></a>返回字典中可以配置的属性</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;配置此节点的标识符</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldKey;</span><br><span class="line">&#x2F;&#x2F;配置此节点的类型</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldType; </span><br><span class="line">&#x2F;&#x2F;指定当前节点属性对应的类 (一般不需设置)</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldClass;</span><br><span class="line">&#x2F;&#x2F;设置当前节点对应的cell类</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldCell;</span><br><span class="line">&#x2F;&#x2F;设置当前节点显示的名称(不设置默认为驼峰的属性名 eg:Email)</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldTitle;</span><br><span class="line">&#x2F;&#x2F;设置当前节点的placeHolder</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldPlaceholder;</span><br><span class="line">&#x2F;&#x2F;设置节点上默认显示的文字</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldDefaultValue; </span><br><span class="line">&#x2F;&#x2F;设置选项数组 这个属性的设置 必须配合特定配型的cell使用</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldOptions;</span><br><span class="line">&#x2F;&#x2F;如果某个节点是一个数组 则FXFormFieldTemplate可以用来设置数组中节点的属性</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldTemplate;</span><br><span class="line">&#x2F;&#x2F;进行类型转换</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldValueTransformer;</span><br><span class="line">&#x2F;&#x2F;设置节点的触发方法</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldAction;</span><br><span class="line">&#x2F;&#x2F;连接StoryboardSegue</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldSegue;</span><br><span class="line">&#x2F;&#x2F;设置节点头部内容</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldHeader;</span><br><span class="line">&#x2F;&#x2F;设置节点尾部内容</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldFooter;</span><br><span class="line">&#x2F;&#x2F;设置是否是内嵌节点 对于父节点或者数组类界定 这个如果设置为@YES 则会在当前界面中展示表单 如果设置为@NO，则会在新的视图控制器中展示</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldInline;</span><br><span class="line">&#x2F;&#x2F;对于数组类型的节点，设置是否支持排序 设置为@YES则为支持排序</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldSortable;</span><br><span class="line">&#x2F;&#x2F;设置选中cell后跳转的ViewController</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldViewController;</span><br></pre></td></tr></table></figure>

<h5 id="节点类型"><a href="#节点类型" class="headerlink" title="节点类型"></a>节点类型</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;默认的节点类型</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldTypeDefault;</span><br><span class="line">&#x2F;&#x2F;文本标签节点类型</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldTypeLabel;</span><br><span class="line">&#x2F;&#x2F;输入框节点类型</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldTypeText;</span><br><span class="line">&#x2F;&#x2F;长文本输入节点类型</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldTypeLongText; </span><br><span class="line">&#x2F;&#x2F;URL节点类型</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldTypeURL;</span><br><span class="line">&#x2F;&#x2F;Email节点类型</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldTypeEmail; </span><br><span class="line">&#x2F;&#x2F;号码节点类型</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldTypePhone; </span><br><span class="line">&#x2F;&#x2F;密码框节点类型</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldTypePassword;</span><br><span class="line">&#x2F;&#x2F;数字节点类型</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldTypeNumber;</span><br><span class="line">&#x2F;&#x2F;只允许输入整数的节点类型</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldTypeInteger;</span><br><span class="line">&#x2F;&#x2F;无符号整数节点类型</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldTypeUnsigned; </span><br><span class="line">&#x2F;&#x2F;浮点节点类型</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldTypeFloat;</span><br><span class="line">&#x2F;&#x2F;BOOL节点类型 默认带UISwitch控件</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldTypeBoolean;</span><br><span class="line">&#x2F;&#x2F;选项节点类型 默认带对号符号</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldTypeOption;</span><br><span class="line">&#x2F;&#x2F;日期节点类型</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldTypeDate;</span><br><span class="line">&#x2F;&#x2F;时间节点类型</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldTypeTime;</span><br><span class="line">&#x2F;&#x2F;日期时间节点类型</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldTypeDateTime;</span><br><span class="line">&#x2F;&#x2F;图片节点类型</span><br><span class="line">UIKIT_EXTERN NSString *const FXFormFieldTypeImage;</span><br></pre></td></tr></table></figure>

<h5 id="FXForms中也提供了许多封装好的cell"><a href="#FXForms中也提供了许多封装好的cell" class="headerlink" title="FXForms中也提供了许多封装好的cell"></a>FXForms中也提供了许多封装好的cell</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;默认的cell</span><br><span class="line">@interface FXFormDefaultCell : FXFormBaseCell</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;带文本输入框的cell</span><br><span class="line">@interface FXFormTextFieldCell : FXFormBaseCell</span><br><span class="line">@property (nonatomic, readonly) UITextField *textField;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;带文本输入视图的cell</span><br><span class="line">@interface FXFormTextViewCell : FXFormBaseCell</span><br><span class="line">@property (nonatomic, readonly) UITextView *textView;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;带UISwitch控件的cell</span><br><span class="line">@interface FXFormSwitchCell : FXFormBaseCell</span><br><span class="line">@property (nonatomic, readonly) UISwitch *switchControl;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;带UIStepper控件的cell</span><br><span class="line">@interface FXFormStepperCell : FXFormBaseCell</span><br><span class="line">@property (nonatomic, readonly) UIStepper *stepper;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;带UISlider控件的cell</span><br><span class="line">@interface FXFormSliderCell : FXFormBaseCell</span><br><span class="line">@property (nonatomic, readonly) UISlider *slider;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;带日期选择控件的cell</span><br><span class="line">@interface FXFormDatePickerCell : FXFormBaseCell</span><br><span class="line">@property (nonatomic, readonly) UIDatePicker *datePicker;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;带图片选择控件的cell</span><br><span class="line">@interface FXFormImagePickerCell : FXFormBaseCell</span><br><span class="line">@property (nonatomic, readonly) UIImageView *imagePickerView;</span><br><span class="line">@property (nonatomic, readonly) UIImagePickerController *imagePickerController;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;带自定义PickerView的cell</span><br><span class="line">@interface FXFormOptionPickerCell : FXFormBaseCell</span><br><span class="line">@property (nonatomic, readonly) UIPickerView *pickerView;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;带UISegmentedControl控件的cell</span><br><span class="line">@interface FXFormOptionSegmentsCell : FXFormBaseCell</span><br><span class="line">@property (nonatomic, readonly) UISegmentedControl *segmentedControl;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<h5 id="通过协议方式进行节点配置"><a href="#通过协议方式进行节点配置" class="headerlink" title="通过协议方式进行节点配置"></a>通过协议方式进行节点配置</h5><p>也可以不创建属性，使用 FXForms 协议的方法，完成节点的创建和配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@implementation MyForm</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;创建与配置节点</span><br><span class="line">- (NSArray *)fields</span><br><span class="line">&#123;</span><br><span class="line">    return @[</span><br><span class="line">             &#x2F;&#x2F;这里面配置字典的方法和属性字典的配置方法一一致</span><br><span class="line">             @&#123;FXFormFieldKey: @&quot;email&quot;, FXFormFieldTitle: @&quot;email&quot;&#125;,</span><br><span class="line">             @&#123;FXFormFieldKey: @&quot;phone&quot;, FXFormFieldTitle: @&quot;phone&quot;&#125;,</span><br><span class="line">             @&#123;FXFormFieldKey: @&quot;address&quot;, FXFormFieldTitle: @&quot;address&quot;&#125;,</span><br><span class="line">             @&#123;FXFormFieldKey: @&quot;name&quot;, FXFormFieldTitle: @&quot;name&quot;&#125;</span><br><span class="line">             ];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<p>fields 方法中可以直接进行节点的创建和配置</p>
<p>FXForms 协议中还提供了两个方法</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;这个方法用于配置额外的节点，如果需要某些节点不对应任何属性，可以在这个方法中配置</span><br><span class="line">- (NSArray *)extraFields;</span><br><span class="line">&#x2F;&#x2F;这个方法需要返回一个字符串数组，如果需要某些属性不对应节点，即有属性的存在，但是不生成cell，可以将属性名传入返回</span><br><span class="line">- (NSArray *)excludedFields;</span><br></pre></td></tr></table></figure>

<p>节点还可以进行复合，将一个节点的配置作为属性，设置给另一个节点配置类</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;子节点信息配置类</span><br><span class="line">@interface SubForm : NSObject&lt;FXForm&gt;</span><br><span class="line">@property(nonatomic,assign)NSInteger age;</span><br><span class="line">@property(nonatomic,assign)NSDate * date;</span><br><span class="line">@end</span><br><span class="line">@implementation SubForm</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;父节点信息配置类</span><br><span class="line">@interface MyForm : NSObject&lt;FXForm&gt;</span><br><span class="line">@property(nonatomic,strong)NSString * email;</span><br><span class="line">@property(nonatomic,strong)NSString * passwd;</span><br><span class="line">@property(nonatomic,assign)BOOL rememberMe;</span><br><span class="line">&#x2F;&#x2F;其中有属性为子节点</span><br><span class="line">@property(nonatomic,strong)SubForm * subForm;</span><br><span class="line">@end</span><br><span class="line">@implementation MyForm</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<h5 id="自定义视图"><a href="#自定义视图" class="headerlink" title="自定义视图"></a>自定义视图</h5><p>创建的视图控制器不是继承于 FXFormViewController，也可以使用 FXForms 来快捷创建表单视图，需要遵守 FXFormControllerDelegate 协议</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@interface ViewController : UIViewController&lt;FXFormControllerDelegate&gt;</span><br><span class="line">&#x2F;&#x2F;系统的tableView</span><br><span class="line">@property(nonatomic,strong)UITableView * tableView;</span><br><span class="line">&#x2F;&#x2F;FX表单控制器</span><br><span class="line">@property(nonatomic,strong)FXFormController * formController;</span><br><span class="line">@end</span><br><span class="line">@implementation ViewController</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    self.tableView &#x3D; [[UITableView alloc]initWithFrame:self.view.frame style:UITableViewStyleGrouped];</span><br><span class="line">    self.formController &#x3D; [[FXFormController alloc] init];</span><br><span class="line">    self.formController.tableView &#x3D; self.tableView;</span><br><span class="line">    self.formController.delegate &#x3D; self;</span><br><span class="line">    self.formController.form &#x3D; [[MyForm alloc] init];</span><br><span class="line">    [self.view addSubview:self.tableView];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<h5 id="Cell-属性设置"><a href="#Cell-属性设置" class="headerlink" title="Cell 属性设置"></a>Cell 属性设置</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-(NSDictionary *)passwdField&#123;</span><br><span class="line">    return @&#123;@&quot;textLabel.textColor&quot;:[UIColor redColor]&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="ViewController-页面跳转"><a href="#ViewController-页面跳转" class="headerlink" title="ViewController 页面跳转"></a>ViewController 页面跳转</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@interface RegistrationForm : NSObject &lt;FXForm&gt;</span><br><span class="line">@property (nonatomic, readonly) TermsViewController *termsAndConditions;</span><br><span class="line">@property (nonatomic, readonly) PrivacyPolicyViewController *privacyPolicy;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@implementation RegistrationForm</span><br><span class="line">- (NSArray *)fields</span><br><span class="line">&#123;</span><br><span class="line">    return @[</span><br><span class="line">    	@&#123;FXFormFieldKey: @&quot;termsAndConditions&quot;, FXFormFieldHeader: @&quot;Legal&quot;&#125;,</span><br><span class="line">    	@&quot;privacyPolicy&quot;,</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<p><img src="/FXForms/WeChat49fb789e1986ffb8541ec06c2e2c0ae4.png" alt="WeChat49fb789e1986ffb8541ec06c2e2c0ae4"></p>
<p>点击跳转到 TermsViewController 控制器</p>
<h5 id="点击事件"><a href="#点击事件" class="headerlink" title="点击事件"></a>点击事件</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@implementation RegistrationForm</span><br><span class="line">- (NSArray *)fields</span><br><span class="line">&#123;</span><br><span class="line">    return @[</span><br><span class="line">    	@&#123;FXFormFieldTitle: @&quot;Submit&quot;, FXFormFieldHeader: @&quot;&quot;, FXFormFieldAction: @&quot;submitRegistrationForm:&quot;&#125;</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@interface RootFormViewController : FXFormViewController</span><br><span class="line">@end</span><br><span class="line">  </span><br><span class="line">@implementation RootFormViewController</span><br><span class="line">- (void)submitRegistrationForm:(UITableViewCell&lt;FXFormFieldCell&gt; *)cell</span><br><span class="line">&#123;</span><br><span class="line">  	&#x2F;&#x2F;获取表单数据</span><br><span class="line">  	RegistrationForm *form &#x3D; cell.field.form;</span><br><span class="line">&#125;</span><br><span class="line">@end </span><br><span class="line"></span><br></pre></td></tr></table></figure>











<p><a href="%5Bhttps://github.com/nicklockwood/FXForms%5D(https://www.oschina.net/action/GoToLink?url=https://github.com/nicklockwood/FXForms)">FxForms</a></p>
<p><a href="https://my.oschina.net/u/2340880/blog/705221">iOS中表单视图 FXForms</a></p>
]]></content>
  </entry>
  <entry>
    <title>Flutter（二）Hello Flutter</title>
    <url>/2021/10/12/Flutter%EF%BC%88%E4%BA%8C%EF%BC%89Hello-Flutter/</url>
    <content><![CDATA[<h4 id="创建-Flutter-工程"><a href="#创建-Flutter-工程" class="headerlink" title="创建 Flutter 工程"></a>创建 Flutter 工程</h4><p>Android Studio - New Flutter Project </p>
<p>Project Type：</p>
<ul>
<li><p>Application：创建一个 Flutter 应用工程</p>
</li>
<li><p>Plugin：为了给 Android 和 iOS 提供插件应用（暴露的接口）的时候使用</p>
</li>
<li><p>Package：创建一个 Dart 组件发布到 pub 来提供便捷开发，类似一些第三方库</p>
</li>
<li><p>Module：一般用来做混合开发，嵌入到 Android 和 iOS 工程中</p>
</li>
</ul>
<p>终端命令行方式创建：</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">flutter create flutter_demo</span><br></pre></td></tr></table></figure>

<p>运行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">flutter run</span><br></pre></td></tr></table></figure>



<ul>
<li>添加安卓模拟器</li>
</ul>
<p>AVD Manager 添加模拟器</p>
<p>选择安卓模拟器运行卡在 <code>Running Gradle task &#39;assembleDebug&#39;...</code></p>
<p>原因是 Gradle 的 Maven 仓库在国外</p>
<p>修改项目下的 build .gradle 文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">google()</span><br><span class="line">mavenCentral()</span><br></pre></td></tr></table></figure>

<p>修改为阿里云镜像</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">maven &#123; url <span class="string">&#x27;https://maven.aliyun.com/repository/google&#x27;</span> &#125;</span><br><span class="line">maven &#123; url <span class="string">&#x27;https://maven.aliyun.com/repository/jcenter&#x27;</span> &#125;</span><br><span class="line">maven &#123; url <span class="string">&#x27;http://maven.aliyun.com/nexus/content/groups/public&#x27;</span> &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    ext.kotlin_version = <span class="string">&#x27;1.3.50&#x27;</span></span><br><span class="line">    repositories &#123;</span><br><span class="line">        /<span class="regexp">/google()</span></span><br><span class="line"><span class="regexp">        /</span><span class="regexp">/mavenCentral()</span></span><br><span class="line"><span class="regexp">	 maven &#123; url &#x27;https:/</span><span class="regexp">/maven.aliyun.com/repository</span><span class="regexp">/google&#x27; &#125;</span></span><br><span class="line"><span class="regexp">	 maven &#123; url &#x27;https:/</span><span class="regexp">/maven.aliyun.com/repository</span><span class="regexp">/jcenter&#x27; &#125;</span></span><br><span class="line"><span class="regexp">	 maven &#123; url &#x27;http:/</span><span class="regexp">/maven.aliyun.com/nexus</span><span class="regexp">/content/groups</span><span class="regexp">/public&#x27; &#125;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">    dependencies &#123;</span></span><br><span class="line"><span class="regexp">        classpath &#x27;com.android.tools.build:gradle:4.1.0&#x27;</span></span><br><span class="line"><span class="regexp">        classpath &quot;org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version&quot;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">allprojects &#123;</span></span><br><span class="line"><span class="regexp">    repositories &#123;</span></span><br><span class="line"><span class="regexp">        /</span><span class="regexp">/google()</span></span><br><span class="line"><span class="regexp">        /</span><span class="regexp">/mavenCentral()</span></span><br><span class="line"><span class="regexp">	 maven &#123; url &#x27;https:/</span><span class="regexp">/maven.aliyun.com/repository</span><span class="regexp">/google&#x27; &#125;</span></span><br><span class="line"><span class="regexp">	 maven &#123; url &#x27;https:/</span><span class="regexp">/maven.aliyun.com/repository</span><span class="regexp">/jcenter&#x27; &#125;</span></span><br><span class="line"><span class="regexp">	 maven &#123; url &#x27;http:/</span><span class="regexp">/maven.aliyun.com/nexus</span><span class="regexp">/content/groups</span><span class="regexp">/public&#x27; &#125;</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>

<p>修改 Flutter 安装目录中的 flutter.gradle 文件</p>
<p><code>/opt/flutter/packages/flutter_tools/gradle/flutter.gradle</code></p>
<h4 id="快捷键"><a href="#快捷键" class="headerlink" title="快捷键"></a>快捷键</h4><p><code>Command + o</code> : 全局搜索</p>
<p><code>command + option + l</code> : 格式化代码</p>
<p><code>command + l</code> : 注释代码</p>
<p><code>command + -</code> : 折叠和展开代码</p>
<p><code>command + [</code> : 代码返回</p>
<p><code>command + ]</code> : 代码前进</p>
<p><code>cmd + C / cmd + delete</code> : 删除行</p>
<p><code>ctr + alt + I</code>: 自动缩进对齐</p>
<p><code>opt + sft + up/down</code> : 上下移动代码</p>
<p><code>ctrl + tab</code>: 切换文件</p>
<p><code>shift + command + enter</code> : 行尾自动添加分号，if后面自动加“(){ }”</p>
<p><code>cmd + N</code> : 快速生成getter／setter方法，构造方法，toString()方法等</p>
<p><code>cmd + J</code> : 快速生成模版代码块，如if,while,return</p>
<p><code>opt + cmd + T</code> : Surround with快速调出if,for,try…catch,while等环绕代码</p>
<p><code>opt + ctr + o</code>: 删除未使用的import</p>
<p><code>option + enter</code>: 自动导入用到的包</p>
<p><code>stless</code>: 创建新的 <code>StatelessWidget</code></p>
<p><code>stful</code>: 创建新的 <code>StatefulWidget</code></p>
<h4 id="Flutter-工程"><a href="#Flutter-工程" class="headerlink" title="Flutter 工程"></a>Flutter 工程</h4><figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">/<span class="regexp">/导入系统包，作用类似 #import &lt;UIKit/</span>UIKit.h&gt;</span><br><span class="line">import <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> main() =&gt; runApp(<span class="keyword">new</span> MyApp());</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MaterialApp(</span><br><span class="line">      title: <span class="string">&#x27;Welcome to Flutter&#x27;</span>,</span><br><span class="line">      home: <span class="keyword">new</span> Scaffold(</span><br><span class="line">        appBar: <span class="keyword">new</span> AppBar(</span><br><span class="line">          title: <span class="keyword">new</span> Text(<span class="string">&#x27;Welcome to Flutter&#x27;</span>),</span><br><span class="line">        ),</span><br><span class="line">        body: <span class="keyword">new</span> Center(</span><br><span class="line">          child: <span class="keyword">new</span> Text(<span class="string">&#x27;Hello World&#x27;</span>),</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>创建一个 Material APP ，Material 是一种标准的移动端和 web 端的视觉设计语言</p>
</li>
<li><p>man 函数使用了 =&gt; 符号，这是 Dart 中单行函数或方法的简写</p>
</li>
<li><p>该程序继承了 StatelessWidget，将会使本身也成为一个 widget</p>
</li>
<li><p>Scaffold 是 Material APP，中提供的一个 widget，它提供了默认的导航栏、标题和包含主屏幕 widget 树的 body 属性</p>
</li>
<li><p>widget 的主要工作是提供一个 build() 方法来描述如果根据其它较低级别的 widget 来显示自己</p>
</li>
</ul>
<h5 id="文本组件-Text-Widget"><a href="#文本组件-Text-Widget" class="headerlink" title="文本组件 Text Widget"></a>文本组件 Text Widget</h5><p>main.dart</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;Model/base_widget.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;Model/hello_flutter_demo.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;Model/listView_demo.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() =&gt; runApp(App());</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> MaterialApp(</span><br><span class="line">      debugShowCheckedModeBanner: <span class="keyword">false</span>,<span class="comment">//右上角 debug 角标显示</span></span><br><span class="line">      home: Home(),</span><br><span class="line">      theme: ThemeData(</span><br><span class="line">        primaryColor: Colors.blue, <span class="comment">//主题颜色</span></span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Home</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(<span class="comment">//类似 nav</span></span><br><span class="line">      backgroundColor: Colors.grey[<span class="number">100</span>], <span class="comment">//页面背景颜色</span></span><br><span class="line">      appBar: AppBar(<span class="comment">// 导航栏</span></span><br><span class="line">        title: Text(<span class="string">&quot;Demo&quot;</span>),</span><br><span class="line">        foregroundColor: Colors.black,  <span class="comment">//appBar上标题文字背景</span></span><br><span class="line">        backgroundColor: Colors.yellow, <span class="comment">//AppBar背景</span></span><br><span class="line">      ),</span><br><span class="line">      body: MyWidget(),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>hello_flutter_demo.dart</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyWidget</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">final</span> _textStyle = TextStyle(color: Colors.red, fontSize: <span class="number">40</span>, fontWeight: FontWeight.bold);</span><br><span class="line">    <span class="keyword">return</span> Center(</span><br><span class="line">      child: Text(</span><br><span class="line">          <span class="string">&quot;Hello Flutter&quot;</span>,</span><br><span class="line">          textDirection: TextDirection.ltr,</span><br><span class="line">          style: _textStyle),</span><br><span class="line">      );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>base_widget.dart</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/cupertino.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/painting.dart&#x27;</span>;</span><br><span class="line"><span class="comment">//文本显示</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextDemo</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> TextStyle _textStyle = TextStyle(</span><br><span class="line">    fontSize: <span class="number">16.0</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> _title = <span class="string">&quot;标题&quot;</span>;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> _name  = <span class="string">&quot;名字&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Text(</span><br><span class="line">      <span class="string">&quot;《<span class="subst">$&#123; _title &#125;</span>》-- <span class="subst">$_name</span> 123445&quot;</span>,</span><br><span class="line">      textAlign: TextAlign.center,</span><br><span class="line">      style: _textStyle,</span><br><span class="line">      maxLines: <span class="number">4</span>,</span><br><span class="line">      overflow: TextOverflow.ellipsis,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//富文本显示</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RichTextDemo</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> RichText(</span><br><span class="line">      text: TextSpan(</span><br><span class="line">        text: <span class="string">&quot;富文本文字测试&quot;</span>,</span><br><span class="line">        style: TextStyle(fontSize: <span class="number">30</span>, color: Colors.black),</span><br><span class="line">        children: &lt;TextSpan&gt; [</span><br><span class="line">          TextSpan(</span><br><span class="line">            text: <span class="string">&quot;文本1&quot;</span>,</span><br><span class="line">            style: TextStyle(fontSize: <span class="number">10</span>, color: Colors.red),</span><br><span class="line">          ),</span><br><span class="line">          TextSpan(</span><br><span class="line">            text: <span class="string">&quot;文本2&quot;</span>,</span><br><span class="line">            style: TextStyle(fontSize: <span class="number">15</span>, color: Colors.green),</span><br><span class="line">          ),</span><br><span class="line">          TextSpan(</span><br><span class="line">            text: <span class="string">&quot;文本3&quot;</span>,</span><br><span class="line">            style: TextStyle(fontSize: <span class="number">20</span>, color: Colors.blue),</span><br><span class="line">          ),</span><br><span class="line">        ],</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseWidgetDmoe</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Container(</span><br><span class="line">      color: Colors.yellow,</span><br><span class="line">      child: Row(</span><br><span class="line">        children: &lt;Widget&gt;[</span><br><span class="line">          Container(</span><br><span class="line">            width: <span class="number">100</span>,</span><br><span class="line">            height: <span class="number">100</span>,</span><br><span class="line">            <span class="comment">//padding: EdgeInsets.only(left: 30, right: 30, top: 10, bottom: 10),</span></span><br><span class="line">            padding: EdgeInsets.all(<span class="number">30</span>),</span><br><span class="line">            color: Colors.red,</span><br><span class="line">            child: Icon(</span><br><span class="line">              Icons.add,</span><br><span class="line">              size: <span class="number">45</span>,</span><br><span class="line">            ),</span><br><span class="line">          ),</span><br><span class="line">        ],</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/10/12/Flutter%EF%BC%88%E4%BA%8C%EF%BC%89Hello-Flutter/richText.jpg" alt="richText"></p>
<p>Text 的构造方法</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> Text(<span class="keyword">this</span>.data, &#123;  <span class="comment">//Text显示的内容</span></span><br><span class="line">Key key,</span><br><span class="line"><span class="keyword">this</span>.style, <span class="comment">//Text显示的样式</span></span><br><span class="line"><span class="keyword">this</span>.textAlign,<span class="comment">//文本应该如何水平对齐,TextAlign.start,end 或者center</span></span><br><span class="line"><span class="keyword">this</span>.textDirection, <span class="comment">//文本方向,TextDirection.ltr\TextDirection.rtl</span></span><br><span class="line"><span class="keyword">this</span>.locale,</span><br><span class="line"><span class="keyword">this</span>.softWrap,  <span class="comment">//是否自动换行，若为false，文字将不考虑容器大小，单行显示，超出屏幕部分将默认截断处理</span></span><br><span class="line"><span class="keyword">this</span>.overflow, <span class="comment">//当文字超出屏幕的时候，如何处理,TextOverflow.clip(裁剪)\TextOverflow.fade(渐隐)\TextOverflow.ellipsis(省略号)</span></span><br><span class="line"><span class="keyword">this</span>.textScaleFactor, <span class="comment">//字体显示倍率，上面的例子使用的字体大小是20.0，将字体设置成10.0，然后倍率为2</span></span><br><span class="line"><span class="keyword">this</span>.maxLines, <span class="comment">//最大行数设置</span></span><br><span class="line"><span class="keyword">this</span>.semanticsLabel,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>TextStyle 属性</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> TextStyle(&#123;</span><br><span class="line">  <span class="keyword">this</span>.inherit: <span class="keyword">true</span>,  <span class="comment">// 为false的时候不显示</span></span><br><span class="line">  <span class="keyword">this</span>.color,          <span class="comment">// 颜色 </span></span><br><span class="line">  <span class="keyword">this</span>.fontSize,       <span class="comment">// 字号</span></span><br><span class="line">  <span class="keyword">this</span>.fontWeight,     <span class="comment">// 字重，加粗也用这个字段  FontWeight.w700</span></span><br><span class="line">  <span class="keyword">this</span>.fontStyle,      <span class="comment">// FontStyle.normal  FontStyle.italic斜体</span></span><br><span class="line">  <span class="keyword">this</span>.letterSpacing,  <span class="comment">// 字符间距  就是单个字母或者汉字之间的间隔，可以是负数</span></span><br><span class="line">  <span class="keyword">this</span>.wordSpacing,    <span class="comment">// 字间距 句字之间的间距</span></span><br><span class="line">  <span class="keyword">this</span>.textBaseline,   <span class="comment">// 基线，两个值，字面意思是一个用来排字母的，一人用来排表意字的（类似中文）</span></span><br><span class="line">  <span class="keyword">this</span>.height,         <span class="comment">// 当用来Text控件上时，行高（会乘以fontSize,所以不以设置过大）</span></span><br><span class="line">  <span class="keyword">this</span>.decoration,     <span class="comment">// 添加上划线，下划线，删除线 </span></span><br><span class="line">  <span class="keyword">this</span>.decorationColor,<span class="comment">// 划线的颜色</span></span><br><span class="line">  <span class="keyword">this</span>.decorationStyle,<span class="comment">// 这个style可能控制画实线，虚线，两条线，点, 波浪线等</span></span><br><span class="line">  <span class="keyword">this</span>.debugLabel,</span><br><span class="line">  <span class="built_in">String</span> fontFamily,   <span class="comment">// 字体</span></span><br><span class="line">  <span class="built_in">String</span> package,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h5 id="列表-ListView"><a href="#列表-ListView" class="headerlink" title="列表 ListView"></a>列表 ListView</h5><p>Car.dart</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> Car(&#123;</span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">this</span>.name,</span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">this</span>.imageUrl,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> name;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> imageUrl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//模型数组</span></span><br><span class="line"><span class="keyword">final</span> <span class="built_in">List</span>&lt;Car&gt; datas = [</span><br><span class="line">  Car(</span><br><span class="line">    name: <span class="string">&#x27;保时捷918 Spyder&#x27;</span>,</span><br><span class="line">    imageUrl:</span><br><span class="line">    <span class="string">&#x27;https://upload-images.jianshu.io/upload_images/2990730-7d8be6ebc4c7c95b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&#x27;</span>,</span><br><span class="line">  ),</span><br><span class="line">  Car(</span><br><span class="line">    name: <span class="string">&#x27;兰博基尼Aventador&#x27;</span>,</span><br><span class="line">    imageUrl:</span><br><span class="line">    <span class="string">&#x27;https://upload-images.jianshu.io/upload_images/2990730-e3bfd824f30afaac?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240&#x27;</span>,</span><br><span class="line">  )</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>listView_demo.dart</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;Car.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListViewDemo</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  Widget _cellForRow(BuildContext contex, <span class="built_in">int</span> index) &#123;</span><br><span class="line">    <span class="keyword">return</span> Container(</span><br><span class="line">      color: Colors.white,</span><br><span class="line">      margin: EdgeInsets.all(<span class="number">10</span>),</span><br><span class="line">      child: Column(</span><br><span class="line">        children: [</span><br><span class="line">          Image.network(</span><br><span class="line">              datas[index].imageUrl</span><br><span class="line">          ),</span><br><span class="line">          SizedBox(</span><br><span class="line">            height: <span class="number">10</span>,</span><br><span class="line">          ),</span><br><span class="line">          Text(</span><br><span class="line">              datas[index].name,</span><br><span class="line">              style: TextStyle(</span><br><span class="line">                fontWeight: FontWeight.w400,</span><br><span class="line">                fontSize: <span class="number">18</span>,</span><br><span class="line">                fontStyle: FontStyle.values[<span class="number">1</span>],</span><br><span class="line">              ),</span><br><span class="line">          ),</span><br><span class="line">          Container(height: <span class="number">20</span>,)</span><br><span class="line">        ],</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> ListView.builder(</span><br><span class="line">      itemCount: datas.length,</span><br><span class="line">      itemBuilder: _cellForRow,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/10/12/Flutter%EF%BC%88%E4%BA%8C%EF%BC%89Hello-Flutter/listView.jpg" alt="listView"></p>
<h5 id="使用-packages"><a href="#使用-packages" class="headerlink" title="使用 packages"></a>使用 packages</h5><p>pubspec 文件管理 Flutter 应用程序的 assets（资源，如图片、package等）在 pubspec.yaml 中，将 english_word 添加到依赖项列表</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="symbol">dependencies:</span></span><br><span class="line">  <span class="symbol">flutter:</span></span><br><span class="line">    <span class="symbol">sdk:</span> flutter</span><br><span class="line"></span><br><span class="line">  <span class="symbol">cupertino_icons:</span> ^<span class="number">0</span>.<span class="number">1.0</span></span><br><span class="line">  <span class="symbol">english_words:</span> ^<span class="number">4.0</span>.<span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>Android Studio 编辑器视图中查看 pubspec.yaml 时，点击右上角 Pub get，将会将依赖包安装到项目，可以在控制台看到 flutter package get </p>
<p>或者在 Terminal 中输入 flutter package get  安装依赖包</p>
<p>安装成功后在 lib/main.dart 中，引入 english_words</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:english_words/english_words.dart&#x27;</span>;</span><br></pre></td></tr></table></figure>



<h4 id="报错问题"><a href="#报错问题" class="headerlink" title="报错问题"></a>报错问题</h4><h5 id="1-flutter-pub-get-安装包卡住"><a href="#1-flutter-pub-get-安装包卡住" class="headerlink" title="1. flutter pub get 安装包卡住"></a>1. flutter pub get 安装包卡住</h5><p>网上好多说需要配置国内镜像就可以了，在 <code>~/.bash_profile</code> 添加 </p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 官方提供的国内镜像</span></span><br><span class="line">export PUB_HOSTED_URL=<span class="symbol">https:</span>/<span class="regexp">/pub.flutter-io.cn</span></span><br><span class="line"><span class="regexp">export FLUTTER_STORAGE_BASE_URL=https:/</span><span class="regexp">/storage.flutter-io.cn</span></span><br></pre></td></tr></table></figure>

<p><code>source ~/.bash_profile</code></p>
<p>可配置了还是会卡住，直接下载 package 配置本地路径了</p>
<p><code>https://pub.flutter-io.cn</code> 搜索包 <code>english_word</code> 下载最新版本</p>
<p> 放到项目目录 <code>plugin/english_words</code></p>
<p>pubspec.yaml 中配置包路径</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="symbol">dependencies:</span></span><br><span class="line">  <span class="symbol">flutter:</span></span><br><span class="line">    <span class="symbol">sdk:</span> flutter</span><br><span class="line"></span><br><span class="line">  <span class="symbol">cupertino_icons:</span> ^<span class="number">0</span>.<span class="number">1.0</span></span><br><span class="line">  <span class="symbol">english_words:</span> </span><br><span class="line">  	<span class="symbol">path:</span>  plugin/english_words/</span><br></pre></td></tr></table></figure>











<p><a href="https://gitee.com/other_other/flutter.git">hello_flutter</a></p>
<p><a href="https://www.jianshu.com/p/41f1d9d6079c">配置Flutter环境ForMac</a></p>
]]></content>
      <categories>
        <category>Flutter</category>
      </categories>
      <tags>
        <tag>Flutter</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo+GitHub 搭建博客</title>
    <url>/2020/11/17/Hexo-GitHub-%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/</url>
    <content><![CDATA[<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>安装node.js</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">brew install node</span><br></pre></td></tr></table></figure>
<p>查看版本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">node -v</span><br></pre></td></tr></table></figure>
<p>npm是node.js的包管理工具</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm -v</span><br></pre></td></tr></table></figure>
<p>Hexo是一个快速、简洁高效博客框架</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install -g hexo-cli</span><br></pre></td></tr></table></figure>
<p>安装完成后桌面建一个blog文件夹</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd ~&#x2F;Desktop &amp;&amp; mkdir blog &amp;&amp; cd blog</span><br></pre></td></tr></table></figure>
<p>初始化</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo init</span><br></pre></td></tr></table></figure>
<p>安装依赖包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install</span><br></pre></td></tr></table></figure>
<p>新建的框架目录如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">|--_config.yml      &#x2F;&#x2F;网站的配置信息</span><br><span class="line">|--package.json     &#x2F;&#x2F;项目包信息</span><br><span class="line">|--scaffolds        &#x2F;&#x2F;模板文件，Hexo根据scaffolds中的模板来新建文件</span><br><span class="line">|--source           &#x2F;&#x2F;存放用户资源的地方</span><br><span class="line">|  |--_drafts       &#x2F;&#x2F;存放草稿</span><br><span class="line">|  |--_posts        &#x2F;&#x2F;存放文章</span><br><span class="line">|--themes           &#x2F;&#x2F;主题文件夹</span><br></pre></td></tr></table></figure>
<h4 id="部署到GitHub-Pages"><a href="#部署到GitHub-Pages" class="headerlink" title="部署到GitHub Pages"></a>部署到GitHub Pages</h4><p>安装 hexo-deployer-git工具</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure>
<p>修改_config.yml中的配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">deploy:</span><br><span class="line">  type: git</span><br><span class="line">  repo: https:&#x2F;&#x2F;github.com&#x2F;caodaxun&#x2F;caodaxun.github.io</span><br><span class="line">  branch: master</span><br></pre></td></tr></table></figure>
<p>运行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo clean &amp;&amp; hexo deploy</span><br></pre></td></tr></table></figure>
<p>查看 <code>https://caodaxun.github.io</code> 是否部署成功</p>
<h4 id="安装-NexT-主题"><a href="#安装-NexT-主题" class="headerlink" title="安装 NexT 主题"></a>安装 NexT 主题</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;theme-next&#x2F;hexo-theme-next themes&#x2F;next</span><br></pre></td></tr></table></figure>
<p>主题更新</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm update hexo-theme-next</span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd themes&#x2F;next &amp;&amp; git pull</span><br></pre></td></tr></table></figure>

<h4 id="发布文章"><a href="#发布文章" class="headerlink" title="发布文章"></a>发布文章</h4><h5 id="配置添加文章自动打开编辑器"><a href="#配置添加文章自动打开编辑器" class="headerlink" title="配置添加文章自动打开编辑器"></a>配置添加文章自动打开编辑器</h5><p>blog 目录下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mkdir scripts &amp;&amp; touch open.js</span><br></pre></td></tr></table></figure>

<p>添加代码保存</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var exec &#x3D; require(&#39;child_process&#39;).exec;</span><br><span class="line">hexo.on(&#39;new&#39;, function(data)&#123;</span><br><span class="line">    exec(&#39;open -a &quot;&#x2F;Applications&#x2F;Typora.app&quot; &#39; + data.path);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>新建文章  <code>hexo new &quot;Test&quot;</code>  会自动打开 Typora 编辑器</p>
<p>写完后生成静态网页部署到 <code>github</code> 上</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo g -d				#直接生成页面发布</span><br></pre></td></tr></table></figure>

<h5 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h5><p>调试的时候可以边修改，边刷新查看</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo clean			#清除缓存</span><br><span class="line">hexo g				#生成静态页面</span><br><span class="line">hexo s --debug  #调试模式 http:&#x2F;&#x2F;localhost:4000&#x2F;进行访问</span><br></pre></td></tr></table></figure>

<p>调试模式有时会出现端口占用情况</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo lsof -i :4000</span><br><span class="line">sudo kill -9 进程PID</span><br></pre></td></tr></table></figure>

<h5 id="添加图片"><a href="#添加图片" class="headerlink" title="添加图片"></a>添加图片</h5><p>安装插件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install hexo-renderer-marked</span><br></pre></td></tr></table></figure>

<p>修改  <code>config.yml</code>  配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">post_asset_folder: true</span><br><span class="line">marked:</span><br><span class="line">  prependRoot: true</span><br><span class="line">  postAsset: true</span><br></pre></td></tr></table></figure>

<p>之后就可以使用 <code>![图片](image.jpg)</code> 访问图片了</p>
<h4 id="主题配置"><a href="#主题配置" class="headerlink" title="主题配置"></a>主题配置</h4><h5 id="添加菜单"><a href="#添加菜单" class="headerlink" title="添加菜单"></a>添加菜单</h5><p><code>hexo new page</code>添加页面，添加后文件在 <code>source/</code> 目录下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">hexo new page &quot;categories&quot;</span><br><span class="line">hexo new page &quot;tags&quot;</span><br><span class="line">hexo new about &quot;about&quot;</span><br></pre></td></tr></table></figure>

<p>配置标签</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: 标签</span><br><span class="line">date: 2020-11-18 12:42:18</span><br><span class="line">type: &quot;tags&quot;</span><br><span class="line">---</span><br></pre></td></tr></table></figure>

<p>配置分类</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: 分类</span><br><span class="line">date: 2020-11-18 12:31:50</span><br><span class="line">type: &quot;categories&quot;</span><br><span class="line">---</span><br></pre></td></tr></table></figure>

<p>给文章配置分类和标签</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: 测试下</span><br><span class="line">date: 2020-11-17 15:02:26</span><br><span class="line">tags: </span><br><span class="line">    - 标签1</span><br><span class="line">categories: </span><br><span class="line">    - 分类1</span><br><span class="line">---</span><br></pre></td></tr></table></figure>

<p>修改主题配置<code>themes/next/_ocnfig.yml</code>，|| 后面的是图片名</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">menu:</span><br><span class="line">    home: &#x2F; || fa fa-home</span><br><span class="line">    archives: &#x2F;archives || fa fa-archive</span><br><span class="line">    categories: &#x2F;categories || fa fa-th</span><br><span class="line">    tags: &#x2F;tags || fa fa-tags</span><br><span class="line">    about: &#x2F;about || fa fa-user</span><br></pre></td></tr></table></figure>

<h5 id="添加搜索功能"><a href="#添加搜索功能" class="headerlink" title="添加搜索功能"></a>添加搜索功能</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install hexo-generator-searchdb --save</span><br></pre></td></tr></table></figure>

<p><code>config.yml</code> 新增</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">search:</span><br><span class="line">  path: search.xml</span><br><span class="line">  field: post</span><br><span class="line">  format: html</span><br><span class="line">  limit: 10000</span><br></pre></td></tr></table></figure>

<p>修改主题配置文件 <code>themes/next/_config.yml</code> 修改 <code>local_search</code>的 <code>enable</code> 为<code>true</code></p>
<h5 id="添加背景动画"><a href="#添加背景动画" class="headerlink" title="添加背景动画"></a>添加背景动画</h5><p>进入 <code>Hexo</code> ，带 <code>scaffolds  source  themes  _config.yml  package.json</code>目录</p>
<p>新建 <code>footer.swig</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;script color&#x3D;&quot;0,0,255&quot; opacity&#x3D;&quot;0.5&quot; zIndex&#x3D;&quot;-1&quot; count&#x3D;&quot;99&quot; src&#x3D;&quot;https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;npm&#x2F;canvas-nest.js@1&#x2F;dist&#x2F;canvas-nest.js&quot;&gt;&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p><code>themes/next/_config.yml</code> 修改 <code>custom_file_path</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">footer: source&#x2F;_data&#x2F;footer.swig</span><br></pre></td></tr></table></figure>

<p>查看图：</p>
<p><img src="/2020/11/17/Hexo-GitHub-%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2/%E8%83%8C%E6%99%AF.png" alt="背景"></p>
<h4 id="文章加密"><a href="#文章加密" class="headerlink" title="文章加密"></a>文章加密</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install hexo-blog-encrypt --save</span><br></pre></td></tr></table></figure>

<p>或者直接在 <code>package.json</code> 中直接配置依赖，再 <code>npm install</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;hexo-blog-encrypt&quot;: &quot;3.0.13&quot;,</span><br></pre></td></tr></table></figure>

<p><code>config.yml</code>中添加 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#Security</span><br><span class="line">encrypt:</span><br><span class="line">    enable: true</span><br></pre></td></tr></table></figure>

<p>将<code>password</code>添加到文章信息头</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">title: Hello World</span><br><span class="line">password: xxxxxx</span><br><span class="line">abstract: 输入密码</span><br><span class="line">message: 输入密码</span><br></pre></td></tr></table></figure>

<h4 id="备份博客源文件"><a href="#备份博客源文件" class="headerlink" title="备份博客源文件"></a>备份博客源文件</h4><p>直接放码云了，码云上新建仓库 Hexo</p>
<p>本地新建同名文件 Hexo</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd Hexo </span><br><span class="line">git init</span><br></pre></td></tr></table></figure>
<p>本地和远程绑定 &amp;&amp; 拉取远程代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git remote add origin https:&#x2F;&#x2F;gitee.com&#x2F;xxxx&#x2F;hexo.git</span><br><span class="line">git pull origin master</span><br></pre></td></tr></table></figure>

<p>新建或修改 <code>.gitignore</code> 文件，加入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">*.log</span><br><span class="line">public&#x2F;</span><br><span class="line">.deploy*&#x2F;</span><br></pre></td></tr></table></figure>

<p>把 Blog 里面的代码拖到 Hexo 文件，提交到码云</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git add .</span><br><span class="line">git commit -m &quot;提交备份&quot;</span><br><span class="line">git push origin master</span><br></pre></td></tr></table></figure>

<p>远程代码有更新时</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git pull origin master</span><br></pre></td></tr></table></figure>

<p>还是直接用 SourceTree 工具吧，Git命令一段时间不用就会忘</p>
<h4 id="报错问题"><a href="#报错问题" class="headerlink" title="报错问题"></a>报错问题</h4><ul>
<li>SSL_ERROR_SYSCALL in connection to github.com:443</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">fatal: unable to access &#39;https:&#x2F;&#x2F;github.com&#x2F;caodaxun&#x2F;caodaxun.github.io&#x2F;&#39;: LibreSSL SSL_connect: SSL_ERROR_SYSCALL in connection to github.com:443</span><br><span class="line">FATAL &#123;</span><br><span class="line">  err: Error: Spawn failed</span><br><span class="line">      at ChildProcess.&lt;anonymous&gt; (&#x2F;Users&#x2F;xx&#x2F;Desktop&#x2F;Hexo&#x2F;node_modules&#x2F;hexo-deployer-git&#x2F;node_modules&#x2F;hexo-util&#x2F;lib&#x2F;spawn.js:51:21)</span><br><span class="line">      at ChildProcess.emit (events.js:310:20)</span><br><span class="line">      at Process.ChildProcess._handle.onexit (internal&#x2F;child_process.js:275:12) &#123;</span><br><span class="line">    code: 128</span><br><span class="line">  &#125;</span><br><span class="line">&#125; Something&#39;s wrong. Maybe you can find the solution here: %s https:&#x2F;&#x2F;hexo.io&#x2F;docs&#x2F;troubleshooting.html</span><br></pre></td></tr></table></figure>

<p>解决：</p>
<p>把 hexo 项目根目录下的 _config.yml 文件中把仓库地址 https 改为 ssh 地址</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ssh-keygen -t ed25519-sk -C &quot;your_email@example.com&quot;</span><br></pre></td></tr></table></figure>

<p>直接回车，会在 <code>~/.ssh</code> 目录生成 <code>id_ed25519</code> 和 <code>id_ed25519.pub</code> 文件</p>
<p>拷贝文件内容 <code>pbcopy &lt; ~/.ssh/id_ed25519.pub</code> 或直接打开拷贝，到 git 上添加 sshkey</p>
<p><a href="https://hexo.io/zh-cn/docs/">Hexo</a></p>
<p><a href="https://github.com/theme-next/hexo-theme-next">theme-next</a></p>
]]></content>
  </entry>
  <entry>
    <title>KVO KVC</title>
    <url>/2021/07/06/KVO-KVC/</url>
    <content><![CDATA[<h4 id="KVC"><a href="#KVC" class="headerlink" title="KVC"></a>KVC</h4><p><code>KVC</code> 键值编码，一种间接访问对象属性的机制，通过字符串访问对象属性</p>
<h5 id="setValue-forKey"><a href="#setValue-forKey" class="headerlink" title="setValue:forKey"></a>setValue:forKey</h5><p>查找对应 key 的 setter 方法，顺序为：<code>set&lt;Key&gt; -&gt; _set&lt;Key&gt; -&gt; setIs&lt;Key&gt;</code></p>
<p>查找到则直接设置属性的 value</p>
<p>如果没有，检查 <code>accessInstanceVariableDirectly</code> 是否允许访问成员变量</p>
<p>如果 YES，则查找实例变量，顺序为：<code>_&lt;Key&gt; -&gt; _is&lt;Key&gt; -&gt; &lt;Key&gt; -&gt; &lt;isKey&gt;</code></p>
<p>找到实例变量则赋值，否则执行 <code>setValueforUndefineKey:</code> 方法，抛出 <code>NSUndefinedKeyException</code></p>
<h5 id="valueforKey"><a href="#valueforKey" class="headerlink" title="valueforKey:"></a>valueforKey:</h5><p>查找对应 key 的 getter 方法，顺序为：<code>get&lt;Key&gt; -&gt; &lt;key&gt; -&gt; is&lt;Key&gt; -&gt; _&lt;Key&gt;</code></p>
<p>查找到直接返回结果</p>
<p>如果没有，检查 <code>accessInstanceVariableDirectly</code> 是否允许访问成员变量</p>
<p>如果 YES，则查找实例变量，顺序为：<code>_&lt;Key&gt; -&gt; _is&lt;Key&gt; -&gt; &lt;Key&gt; -&gt; &lt;isKey&gt;</code></p>
<p>查找到直接返回结果，否则执行 <code>valueForUndefinedKey:</code> 方法，抛出 <code>NSUndefinedKeyException</code></p>
<h4 id="KVO"><a href="#KVO" class="headerlink" title="KVO"></a>KVO</h4><p><code>KeyValueObserving</code> 键值观察者，可以监听对象属性的改变</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">self.person &#x3D; [[LGPerson alloc] init];</span><br><span class="line">self.person.age &#x3D; 1;</span><br><span class="line">NSKeyValueObservingOptions options &#x3D; NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld;</span><br><span class="line">[self.person addObserver:self forKeyPath:@&quot;age&quot; options:options context:@&quot;1&quot;];</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event &#123;</span><br><span class="line">    self.person.age &#x3D; 20;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change context:(void *)context &#123;</span><br><span class="line">    NSLog(@&quot;%@ %@ %@ %@&quot;, keyPath, object, change, context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加观察者后，KVO 会在运行时动态创建一个子类 <code>NSKVONotifing_XXX</code>，将对象的 isa 指向新创建的类</p>
<p>修改对象属性时，会先调用子类 <code>NSKVONotifing_XXX</code> 的 setter 方法</p>
<p>子类 setter 内部会调用：</p>
<ol>
<li><code>willChangeValueForKey:</code></li>
<li>父类原来的 setter</li>
<li><code>didChangeValueForKey:</code></li>
<li>内部会触发监听器的监听方法 <code>(observeValueForKeyPath:ofObject:change:context:)</code></li>
</ol>
<h4 id="Swift-KVO"><a href="#Swift-KVO" class="headerlink" title="Swift KVO"></a>Swift KVO</h4><p>kVO 是一个纯 OC 特性，swift class 需要在声明时加 <code>@objcMembers</code> 关键字</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@objcMembers class OCClass: NSObject &#123;</span><br><span class="line">    dynamic var name: String</span><br><span class="line">    init(name: String) &#123;</span><br><span class="line">        self.name &#x3D; name</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>观察的闭包需要强引用，否则函数离开这个观察闭包后会被回收</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var occlass: OCClass?</span><br><span class="line">var observation: NSKeyValueObservation?</span><br><span class="line">  </span><br><span class="line">occlass &#x3D; OCClass(name: &quot;aa&quot;)</span><br><span class="line">observation &#x3D; occlass!.observe(\.name) &#123; obj, changed in</span><br><span class="line">    let new &#x3D; obj.name</span><br><span class="line">    print(&quot;new:\(new)&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">override func touchesBegan(_ touches: Set&lt;UITouch&gt;, with event: UIEvent?) &#123;</span><br><span class="line">    occlass?.name &#x3D; &quot;1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h4 id="面试题"><a href="#面试题" class="headerlink" title="面试题"></a>面试题</h4><h5 id="1、直接修改成员变量会触发-KVO-吗"><a href="#1、直接修改成员变量会触发-KVO-吗" class="headerlink" title="1、直接修改成员变量会触发 KVO 吗"></a>1、直接修改成员变量会触发 KVO 吗</h5><p>不会，没有调用重写后的 set 方法</p>
<h5 id="2、手动触发-KVO"><a href="#2、手动触发-KVO" class="headerlink" title="2、手动触发 KVO"></a>2、手动触发 KVO</h5><p>手动调用 <code>willChangeValueForKey:</code> ，<code>didChangeValueForKey:</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[self.person willChangeValueForKey:@&quot;age&quot;];</span><br><span class="line">self.person-&gt;_age &#x3D; 2;</span><br><span class="line">[self.person didChangeValueForKey:@&quot;age&quot;];</span><br></pre></td></tr></table></figure>

<h5 id="3、如何对可变数组进行-KVO"><a href="#3、如何对可变数组进行-KVO" class="headerlink" title="3、如何对可变数组进行 KVO"></a>3、如何对可变数组进行 KVO</h5><p>可变数组添加元素 <code>addObject:</code> 是不会调用 <code>setter</code> 方法的，不会触发 KVO 通知回调</p>
<p>需要使用 <code>mutableArrayValueForKey</code> 获取要操作的可变数组，添加元素</p>
<p>  <code>[[self mutableArrayValueForKey:@“arr”] addObject:item]</code> </p>
]]></content>
  </entry>
  <entry>
    <title>OC对象底层原理</title>
    <url>/2020/11/19/OC%E5%AF%B9%E8%B1%A1%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<blockquote>
<p><code>NSObject</code> 对象的底层就是一个包含了一个指针的结构体，那么它的大小是不是就是8字节（64位下指针类型占8个字节）？</p>
</blockquote>
<h4 id="class-getInstanceSize"><a href="#class-getInstanceSize" class="headerlink" title="class_getInstanceSize"></a>class_getInstanceSize</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#import &lt;objc&#x2F;runtime.h&gt;</span><br></pre></td></tr></table></figure>

<p><code>class_getInstanceSize ()</code>可以计算一个类的实例对象实际所需要的空间大小，也就是计算类所对应的结构体的大小</p>
<p>系统在为类的结构体分配内存时内存对齐，以一个指针的长度作为对齐系数，64位系统指针长度为8个字节，类所对应的结构体，头部肯定是一个 <code>isa</code> 指针</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">size_t size &#x3D; class_getInstanceSize([NSObject class]);</span><br><span class="line">NSLog(@&quot;NSObject对象大小：%zd&quot;, size); &#x2F;&#x2F;8</span><br></pre></td></tr></table></figure>

<h4 id="malloc-size"><a href="#malloc-size" class="headerlink" title="malloc_size()"></a>malloc_size()</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#import &lt;malloc&#x2F;malloc.h&gt;</span><br></pre></td></tr></table></figure>

<p><code>malloc_size()</code>，函数的参数是一个指针，可以计算指针所指向内存空间的大小</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">NSObject *obj &#x3D; [[NSObject alloc] init];</span><br><span class="line">size_t size2 &#x3D; malloc_size((__bridge const void *)(obj));</span><br><span class="line">NSLog(@&quot;对象obj所指向的的内存空间大小：%zd&quot;,size2); &#x2F;&#x2F;16</span><br></pre></td></tr></table></figure>

<p>系统为实例对象分配的内存空间，最小为16个字节</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">size_t</span> <span class="title">instanceSize</span><span class="params">(<span class="keyword">size_t</span> extraBytes)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//实例对象内部成员变量所占空间大小 extraBytes通常为0</span></span><br><span class="line">    <span class="keyword">size_t</span> size = alignedInstanceSize() + extraBytes;</span><br><span class="line">    <span class="comment">// CF requires all objects be at least 16 bytes.</span></span><br><span class="line">    <span class="keyword">if</span> (size &lt; <span class="number">16</span>) size = <span class="number">16</span>; <span class="comment">//系统为该实例对象分配的内存空间大小</span></span><br><span class="line">    <span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h4><p><code>class_getInstanceSize</code> 获取类的实例对象内存大小，本质就是获取实例对象中成员变量的内存大小</p>
<p><code>malloc_size</code> 得到一个指针所指向的内存空间的大小，系统实际分配内存，利用这个可以得到对象所占用的内存大小</p>
<p><code>sizeof()</code> 获取数据类型或变量占用空间大小，这是一个运算符</p>
<p><code>[NSObject alloc]</code> 之后，系统为其分配了16个字节的内存，最终 <code>obj</code> 对象实际使用了其中8个字节内存（也就是其内部的那个 <code>isa</code> 指针所用的8个字节，64位系统下）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@interface Student : NSObject</span><br><span class="line">&#123;</span><br><span class="line">   @public</span><br><span class="line">    int _age;   &#x2F;&#x2F;4个字节</span><br><span class="line">    int _no;    &#x2F;&#x2F;4个字节</span><br><span class="line">    int _grade; &#x2F;&#x2F;4个字节</span><br><span class="line">&#125; </span><br><span class="line">Student *std &#x3D; [[Student alloc] init];</span><br><span class="line">size_t size &#x3D; class_getInstanceSize([Student class]); &#x2F;&#x2F;24</span><br><span class="line">size_t size &#x3D; malloc_size((__bridge const void *)(std)); &#x2F;&#x2F;32</span><br></pre></td></tr></table></figure>

<p><code>Student</code> 结构体所有成员变量所需要的总空间为20个字节，根据内存对齐的原则，最后结构体所需要的空间应该是8的倍数，也就是24个字节；实际系统分配内存大小是16的倍数32个字节</p>
<h4 id="LLDB查看内存"><a href="#LLDB查看内存" class="headerlink" title="LLDB查看内存"></a>LLDB查看内存</h4><p><img src="/2020/11/19/OC%E5%AF%B9%E8%B1%A1%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/alloc.png" alt="alloc"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0x281442fa0-0x281442fa0-0x281442fa0</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">(lldb) po p</span><br><span class="line">&lt;LGPerson: <span class="number">0x281442fa0</span>&gt;</span><br><span class="line">(lldb) x p</span><br><span class="line"><span class="number">0x281442fa0</span>: <span class="number">2</span>d <span class="number">17</span> d7 <span class="number">02</span> a1 <span class="number">41</span> <span class="number">00</span> <span class="number">00</span> <span class="number">28</span> c0 d6 <span class="number">02</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  -....A..(.......</span><br><span class="line"><span class="number">0x281442fb0</span>: <span class="number">0</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">64</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  ........d.......</span><br><span class="line">(lldb) po <span class="number">0x0a</span></span><br><span class="line"><span class="number">10</span></span><br><span class="line">(lldb) po <span class="number">0x64</span></span><br><span class="line"><span class="number">100</span></span><br><span class="line">(lldb) po <span class="number">0x0102d6c028</span></span><br><span class="line">a</span><br></pre></td></tr></table></figure>

<p>前8位<code>2d 17 d7 02 a1 41 00 00</code> 是<code>isa</code>的内存8个字节</p>
<p><code>0a 00 00 00</code> 是 <code>age</code> 占4个字节</p>
<p><code>64 00 00 00</code> 是 <code>height</code> 占4个字节</p>
<p><code>28 c0 d6 02 01 00 00 00</code> 是 <code>name</code> 占8个字节</p>
<h4 id="alloc-init"><a href="#alloc-init" class="headerlink" title="alloc init"></a>alloc init</h4><img src="allocinit.png" alt="allocinit" style="zoom:80%;" />

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+ (id)alloc &#123;</span><br><span class="line">    return _objc_rootAlloc(self);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">_objc_rootAlloc(Class cls)</span><br><span class="line">&#123;</span><br><span class="line">    return callAlloc(cls, false&#x2F;*checkNil*&#x2F;, true&#x2F;*allocWithZone*&#x2F;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">static ALWAYS_INLINE id</span><br><span class="line">callAlloc(Class cls, bool checkNil, bool allocWithZone&#x3D;false)</span><br><span class="line">&#123;</span><br><span class="line">#if __OBJC2__</span><br><span class="line">    if (slowpath(checkNil &amp;&amp; !cls)) return nil;</span><br><span class="line">    if (fastpath(!cls-&gt;ISA()-&gt;hasCustomAWZ())) &#123;</span><br><span class="line">        return _objc_rootAllocWithZone(cls, nil);</span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; No shortcuts available.</span><br><span class="line">    if (allocWithZone) &#123;</span><br><span class="line">        return ((id(*)(id, SEL, struct _NSZone *))objc_msgSend)(cls, @selector(allocWithZone:), nil);</span><br><span class="line">    &#125;</span><br><span class="line">    return ((id(*)(id, SEL))objc_msgSend)(cls, @selector(alloc));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">id</span><br><span class="line">_objc_rootAllocWithZone(Class cls, malloc_zone_t *zone __unused)&#x2F;&#x2F; alloc 源码 第四步</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; allocWithZone under __OBJC2__ ignores the zone parameter</span><br><span class="line">    &#x2F;&#x2F;zone 参数不再使用 类创建实例内存空间</span><br><span class="line">    return _class_createInstanceFromZone(cls, 0, nil,</span><br><span class="line">                                         OBJECT_CONSTRUCT_CALL_BADALLOC);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>alloc 的核心操作：</p>
<p><code>cls-&gt;instanceSize</code>：计算需要开辟内存空间大小</p>
<p><code>calloc</code>：申请内存，返回指针地址</p>
<p><code>objc-&gt;initInstanceIsa</code>：将类与 isa 关联</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">static ALWAYS_INLINE id</span><br><span class="line">_class_createInstanceFromZone(Class cls, size_t extraBytes, void *zone,</span><br><span class="line">                              int construct_flags &#x3D; OBJECT_CONSTRUCT_NONE,</span><br><span class="line">                              bool cxxConstruct &#x3D; true,</span><br><span class="line">                              size_t *outAllocatedSize &#x3D; nil)&#x2F;&#x2F; alloc 源码 第五步</span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(cls-&gt;isRealized()); &#x2F;&#x2F;检查是否已经实现</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Read class&#39;s info bits all at once for performance</span><br><span class="line">    &#x2F;&#x2F;一次性读取类的位信息以提高性能</span><br><span class="line">    bool hasCxxCtor &#x3D; cxxConstruct &amp;&amp; cls-&gt;hasCxxCtor();</span><br><span class="line">    bool hasCxxDtor &#x3D; cls-&gt;hasCxxDtor();</span><br><span class="line">    bool fast &#x3D; cls-&gt;canAllocNonpointer();</span><br><span class="line">    size_t size;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;计算需要开辟的内存大小，传入的extraBytes 为 0</span><br><span class="line">    size &#x3D; cls-&gt;instanceSize(extraBytes);</span><br><span class="line">    if (outAllocatedSize) *outAllocatedSize &#x3D; size;</span><br><span class="line"></span><br><span class="line">    id obj;</span><br><span class="line">    if (zone) &#123;</span><br><span class="line">        obj &#x3D; (id)malloc_zone_calloc((malloc_zone_t *)zone, 1, size);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        &#x2F;&#x2F;申请内存</span><br><span class="line">        obj &#x3D; (id)calloc(1, size);</span><br><span class="line">    &#125;</span><br><span class="line">    if (slowpath(!obj)) &#123;</span><br><span class="line">        if (construct_flags &amp; OBJECT_CONSTRUCT_CALL_BADALLOC) &#123;</span><br><span class="line">            return _objc_callBadAllocHandler(cls);</span><br><span class="line">        &#125;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!zone &amp;&amp; fast) &#123;</span><br><span class="line">        &#x2F;&#x2F;将 cls类 与 obj指针（即isa） 关联</span><br><span class="line">        obj-&gt;initInstanceIsa(cls, hasCxxDtor);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        &#x2F;&#x2F; Use raw pointer isa on the assumption that they might be</span><br><span class="line">        &#x2F;&#x2F; doing something weird with the zone or RR.</span><br><span class="line">        obj-&gt;initIsa(cls);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (fastpath(!hasCxxCtor)) &#123;</span><br><span class="line">        return obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    construct_flags |&#x3D; OBJECT_CONSTRUCT_FREE_ONFAILURE;</span><br><span class="line">    return object_cxxConstructFromClass(obj, cls, construct_flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p><a href="https://blog.csdn.net/u013480070/article/details/88365141">OC对象的本质（上）：OC对象的底层实现原理</a><br><a href="https://opensource.apple.com/tarballs/objc4/">objc4-781</a><br><a href="https://juejin.im/post/5d9c829df265da5ba46f49c9#heading-8">objc4-756.2源码编译</a><br><a href="https://www.jianshu.com/p/d4f4769eaa1a">macOS 10.15最新objc源码编译调试</a></p>
]]></content>
  </entry>
  <entry>
    <title>Python</title>
    <url>/2021/03/02/Python/</url>
    <content><![CDATA[<p><a href="https://www.liaoxuefeng.com/wiki/1016959663602400">廖雪峰 Python 教程</a> </p>
<p><a href="https://edu.csdn.net/notebook/python/week09/">https://edu.csdn.net/notebook/python/week09/</a></p>
<h4 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h4><h5 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h5><ul>
<li>整数</li>
</ul>
<p>Python 允许在数字中间以 _ 分隔 10_000_000_000 和 10000000000 是一样的，十六进制也可以写成 0xa1b2_c3d4</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">s = <span class="built_in">input</span>(<span class="string">&#x27;birth: &#x27;</span>)</span><br><span class="line">birth = <span class="built_in">int</span>(s)</span><br></pre></td></tr></table></figure>

<ul>
<li>字符串</li>
</ul>
<p>单引号或者双引号括起来的任意文本</p>
<p><code>r&#39;&#39; </code> 表示 <code>&#39;&#39;</code>  内部的字符串不转义</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(<span class="string">&#x27;I\&#x27;m \&quot;OK\&quot;!&#x27;</span>) <span class="comment"># I&#x27;m &quot;OK&quot;!</span></span><br><span class="line">print(<span class="string">r&#x27;\\\t\\&#x27;</span>) 		  <span class="comment"># \\\t\\</span></span><br></pre></td></tr></table></figure>

<ul>
<li>多行输出</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#&#x27;&#x27;&#x27;...&#x27;&#x27;&#x27; 格式表示多行输出</span></span><br><span class="line">print(<span class="string">&#x27;&#x27;&#x27;line1</span></span><br><span class="line"><span class="string">line2</span></span><br><span class="line"><span class="string">line3&#x27;&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>输入 </li>
</ul>
<p>Python 提供了一个 input()，可以让用户输入字符串，并存放到一个变量里</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">name = <span class="built_in">input</span>()</span><br><span class="line">print(name)</span><br><span class="line"><span class="comment">#字符串提示输入 </span></span><br><span class="line">name = <span class="built_in">input</span>(<span class="string">&#x27;please enter your name: &#x27;</span>)</span><br><span class="line"><span class="comment">#please enter your name: J</span></span><br></pre></td></tr></table></figure>

<ul>
<li>布尔值</li>
</ul>
<p>True、False，布尔值可以用 and、or、not 运算</p>
<ul>
<li>空值 </li>
</ul>
<p>None</p>
<ul>
<li>运算符</li>
</ul>
<p>除法 / 结果浮点数；地板除 // 结果取整数部分；求余 % 取余数部分</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">10</span>/<span class="number">3</span>  <span class="comment">#3.3333333333333335</span></span><br><span class="line"><span class="number">9</span>/<span class="number">3</span>   <span class="comment">#3.0</span></span><br><span class="line"><span class="number">10</span>//<span class="number">3</span> <span class="comment">#3</span></span><br><span class="line"><span class="number">10</span>%<span class="number">3</span>  <span class="comment">#1</span></span><br></pre></td></tr></table></figure>

<ul>
<li>变量</li>
</ul>
<p>同一个变量可以反复赋值，而且可以是不同类型的变量</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = <span class="number">123</span></span><br><span class="line">a = <span class="string">&#x27;abc&#x27;</span></span><br><span class="line">print(a)</span><br></pre></td></tr></table></figure>

<ul>
<li>常量 </li>
</ul>
<p>用全部大写的变量名表示常量只是一个习惯上的用法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">PI = <span class="number">3.1415926</span></span><br></pre></td></tr></table></figure>

<h5 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h5><ul>
<li>%格式化</li>
</ul>
<p>% 运算符就是用来格式化字符串的</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(<span class="string">&#x27;Hello, %s&#x27;</span> % <span class="string">&#x27;world&#x27;</span>)</span><br><span class="line"><span class="comment">#Hello, world</span></span><br><span class="line">print(<span class="string">&#x27;Age: %s. Gender: %s&#x27;</span> % (<span class="number">25</span>, <span class="literal">True</span>))</span><br></pre></td></tr></table></figure>

<p>占位符：%d 整数  %f 浮点数 %s 字符串 %x 十六进制数</p>
<p>如果字符串里面有 % ，需要转义</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;growth rate: %d %%&#x27;</span> % <span class="number">7</span></span><br></pre></td></tr></table></figure>

<p>字符串长度 len()</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">len</span>(<span class="string">&#x27;ABC&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>format() 格式化</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(<span class="string">&#x27;Hello, &#123;0&#125;, 成绩提升了 &#123;1:.1f&#125;&#x27;</span>.<span class="built_in">format</span>(<span class="string">&#x27;小明&#x27;</span>, <span class="number">17.56</span>))</span><br><span class="line"><span class="comment">#Hello, 小明, 成绩提升了 17.6</span></span><br></pre></td></tr></table></figure>

<ul>
<li>f-string 格式化</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#字符串如果包含&#123;xxx&#125;，就会以对应的变量替换</span></span><br><span class="line">name = <span class="string">&#x27;小明&#x27;</span></span><br><span class="line">value = <span class="number">17.65</span></span><br><span class="line">print(<span class="string">f&#x27;Hello, <span class="subst">&#123;name&#125;</span>, 成绩提升了 <span class="subst">&#123;value:<span class="number">.1</span>f&#125;</span>&#x27;</span>)</span><br><span class="line"><span class="comment">#Hello, 小明, 成绩提升了 17.6</span></span><br></pre></td></tr></table></figure>

<p>python 源代码通常开头写上这两行</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br></pre></td></tr></table></figure>

<p>第一行注释是为了告诉Linux/OS X系统，这是一个Python可执行程序，Windows系统会忽略这个注释；</p>
<p>第二行注释是为了告诉Python解释器，按照UTF-8编码读取源代码，否则，你在源代码中写的中文输出可能会有乱码</p>
<h5 id="list-列表"><a href="#list-列表" class="headerlink" title="list 列表"></a>list 列表</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">classmate = [<span class="string">&#x27;Michael&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>]</span><br><span class="line">print(classmate, <span class="built_in">len</span>(classmate), classmate[<span class="number">0</span>])</span><br></pre></td></tr></table></figure>

<p>索引访问元素，取最后一个元素 <code>classmate[-1]</code> 倒数第 2 个 <code>classmate[-2]</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#追加元素</span></span><br><span class="line">classmate.append(<span class="string">&#x27;Adam&#x27;</span>)</span><br><span class="line"><span class="comment">#插入元素到指定位置</span></span><br><span class="line">classmate.insert(<span class="number">1</span>, <span class="string">&#x27;Jack&#x27;</span>)</span><br><span class="line"><span class="comment">#删除最后元素</span></span><br><span class="line">classmate.pop()</span><br><span class="line"><span class="comment">#删除指定位置元素</span></span><br><span class="line">classmate.pop(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#替换元素</span></span><br><span class="line">classmate[<span class="number">1</span>] = <span class="string">&#x27;Sarah&#x27;</span></span><br></pre></td></tr></table></figure>

<p>list 里面元素类型可以不同，list 元素也可以是 list，取的时候  <code>s[2][1]</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">L = [<span class="string">&#x27;Apple&#x27;</span>, <span class="number">123</span>, <span class="literal">True</span>]</span><br><span class="line">s = [<span class="string">&#x27;python&#x27;</span>, <span class="string">&#x27;java&#x27;</span>, [<span class="string">&#x27;asp&#x27;</span>, <span class="string">&#x27;php&#x27;</span>], <span class="string">&#x27;scheme&#x27;</span>]</span><br><span class="line">a = []</span><br></pre></td></tr></table></figure>

<h5 id="tuple-元组"><a href="#tuple-元组" class="headerlink" title="tuple 元组"></a>tuple 元组</h5><p>初始化后不能修改，如果 tuple 有元素是 list， list 可以变</p>
<p>获取元素的方法和 list 一样</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">classmates = (<span class="string">&#x27;Michael&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;Tracy&#x27;</span>)</span><br><span class="line">print(classmates[<span class="number">0</span>],classmates[<span class="number">-1</span>])</span><br><span class="line">t = () <span class="comment">#空tuple</span></span><br><span class="line">t = (<span class="number">1</span>,) <span class="comment">#只有 1 个元素的 tuple，加一个逗号消除歧义</span></span><br><span class="line">a = (<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>])</span><br><span class="line">a[<span class="number">2</span>][<span class="number">0</span>] = <span class="string">&#x27;X&#x27;</span></span><br></pre></td></tr></table></figure>

<h5 id="条件判断"><a href="#条件判断" class="headerlink" title="条件判断"></a>条件判断</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">age = <span class="number">3</span></span><br><span class="line"><span class="keyword">if</span> age &gt;= <span class="number">18</span>:</span><br><span class="line">    print(<span class="string">&#x27;adult&#x27;</span>)</span><br><span class="line"><span class="keyword">elif</span> age &gt;= <span class="number">6</span>:</span><br><span class="line">    print(<span class="string">&#x27;teenager&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">&#x27;kid&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> x:</span><br><span class="line">    print(<span class="string">&#x27;True&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">names = [<span class="string">&#x27;Michael&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;Tracy&#x27;</span>]</span><br><span class="line"><span class="keyword">for</span> name <span class="keyword">in</span> names:</span><br><span class="line">    print(name)</span><br></pre></td></tr></table></figure>

<p>range() 函数，可以生成一个整数序列，通过 list() 函数可以转换成 list</p>
<p>range(5) 生成的序列是从0开始小于5的整数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">5</span>))</span><br><span class="line">[<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]</span><br></pre></td></tr></table></figure>

<h5 id="dict"><a href="#dict" class="headerlink" title="dict"></a>dict</h5><p>get() 方法，如果 key 不存在，可以返回 None，或者自己指定的 value</p>
<p>pop(key) 删除一个 key，对应 value也会从 dict 删除</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">d = &#123;<span class="string">&#x27;Michael&#x27;</span>: <span class="number">95</span>, <span class="string">&#x27;Bob&#x27;</span>: <span class="number">75</span>, <span class="string">&#x27;Tracy&#x27;</span>: <span class="number">85</span>&#125;</span><br><span class="line">d.get(<span class="string">&#x27;Thomas&#x27;</span>)</span><br><span class="line">d.get(<span class="string">&#x27;Thomas&#x27;</span>, <span class="number">-1</span>) </span><br><span class="line">d.pop(<span class="string">&#x27;Bob&#x27;</span>)</span><br><span class="line">d[<span class="string">&#x27;Adam&#x27;</span>] = <span class="number">67</span></span><br></pre></td></tr></table></figure>

<p>检查是否包含key</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="string">&#x27;city&#x27;</span> <span class="keyword">in</span> kw:</span><br><span class="line">	<span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h5 id="set-集合"><a href="#set-集合" class="headerlink" title="set 集合"></a>set 集合</h5><p>没有重复的 key，重复元素会自动过滤</p>
<p>add(key) 添加元素，可以重复添加，但不会有效果</p>
<p>remove(key) 删除元素</p>
<p>两个 set 可以做数学意义上的交集&amp;、并集 |</p>
<p>创建一个 set 需要提供一个 list 作为集合</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">s = <span class="built_in">set</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]) <span class="comment">#&#123;1, 2, 3&#125;</span></span><br><span class="line">s = <span class="built_in">set</span>([<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>]) <span class="comment">#&#123;1, 2, 3&#125;</span></span><br><span class="line">s.add(<span class="number">4</span>)</span><br><span class="line">s1 = <span class="built_in">set</span>([<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])</span><br><span class="line">s &amp; s1 <span class="comment">#&#123;2, 3&#125;</span></span><br><span class="line">s | s1 <span class="comment">#&#123;1, 2, 3, 4&#125;</span></span><br></pre></td></tr></table></figure>

<h4 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h4><h5 id="定义函数"><a href="#定义函数" class="headerlink" title="定义函数"></a>定义函数</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_abs</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="keyword">if</span> x &gt;= <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> -x</span><br></pre></td></tr></table></figure>

<p>定义空函数什么也不做，pass 用来做占位符，还没写好的函数可以先放一个 pass</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nop</span>():</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>参数类型检查 isinstance 内置函数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_abs</span>(<span class="params">x</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(x, (<span class="built_in">int</span>, <span class="built_in">float</span>)): <span class="comment">#判断整数或浮点数</span></span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&#x27;bad operand type&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> x &gt;= <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> x</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> -x</span><br></pre></td></tr></table></figure>

<h5 id="返回多个值"><a href="#返回多个值" class="headerlink" title="返回多个值"></a>返回多个值</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">move</span>(<span class="params">x, y, step, angle=<span class="number">0</span></span>):</span></span><br><span class="line">    nx = x + step * math.cos(angle)</span><br><span class="line">    ny = y - step * math.sin(angle)</span><br><span class="line">    <span class="keyword">return</span> nx, ny</span><br></pre></td></tr></table></figure>

<p>同时获得返回值，返回一个tuple</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x, y = move(<span class="number">100</span>, <span class="number">100</span>, <span class="number">60</span>, math.pi / <span class="number">6</span>)</span><br></pre></td></tr></table></figure>

<h5 id="默认参数"><a href="#默认参数" class="headerlink" title="默认参数"></a>默认参数</h5><p>调用 power(5)，power(5, 3)</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">power</span>(<span class="params">x, n=<span class="number">2</span></span>):</span></span><br><span class="line">    s = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> n &gt; <span class="number">0</span>:</span><br><span class="line">        n = n - <span class="number">1</span></span><br><span class="line">        s = s * x</span><br><span class="line">    <span class="keyword">return</span> s</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">enroll</span>(<span class="params">name, gender, age=<span class="number">6</span>, city=<span class="string">&#x27;Beijing&#x27;</span></span>):</span></span><br><span class="line">    print(<span class="string">&#x27;name:&#x27;</span>, name)</span><br><span class="line">    print(<span class="string">&#x27;gender:&#x27;</span>, gender)</span><br><span class="line">    print(<span class="string">&#x27;age:&#x27;</span>, age)</span><br><span class="line">    print(<span class="string">&#x27;city:&#x27;</span>, city)</span><br><span class="line"></span><br><span class="line">enroll(<span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, <span class="number">7</span>) city参数依然是默认</span><br><span class="line">enroll(<span class="string">&#x27;Adam&#x27;</span>, <span class="string">&#x27;M&#x27;</span>, city=<span class="string">&#x27;Tianjin’) age默认 city用传的值</span></span><br></pre></td></tr></table></figure>

<h5 id="可变参数"><a href="#可变参数" class="headerlink" title="可变参数"></a>可变参数</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calc</span>(<span class="params">numbers</span>):</span></span><br><span class="line">    <span class="built_in">sum</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> numbers:</span><br><span class="line">        <span class="built_in">sum</span> = <span class="built_in">sum</span> + n * n</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sum</span></span><br></pre></td></tr></table></figure>

<p>调用的时候传入 list 或 tuple</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">calc([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])</span><br><span class="line">calc((<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>))</span><br></pre></td></tr></table></figure>

<p>改成可变参数，参数前面加一个 * ，函数内部 nubmers 接收的是一个 tuple</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">calc</span>(<span class="params">*numbers</span>):</span></span><br><span class="line">    <span class="built_in">sum</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> numbers:</span><br><span class="line">        <span class="built_in">sum</span> = <span class="built_in">sum</span> + n * n</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sum</span></span><br></pre></td></tr></table></figure>

<p>调用可以传任意参数，或者 0 个参数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">calc(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">calc()</span><br></pre></td></tr></table></figure>

<p>如果有一个list ，调用可变参数，list 前面加一个 * 把 list 的元素变成可变参数传进去</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">nums = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">calc(*nums)</span><br></pre></td></tr></table></figure>

<h5 id="关键字参数"><a href="#关键字参数" class="headerlink" title="关键字参数"></a>关键字参数</h5><p>除了必选参数 name 和 age 外，还接受关键字参数 kw</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">person</span>(<span class="params">name, age, **kw</span>):</span></span><br><span class="line">  	print(<span class="string">&#x27;name:&#x27;</span>, name, <span class="string">&#x27;age:&#x27;</span>, age, <span class="string">&#x27;other:&#x27;</span>, kw)</span><br></pre></td></tr></table></figure>

<p>可以传入任意个数关键字参数，关键字参数在函数内部自动组装为一个 dict</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">person(<span class="string">&#x27;Bob&#x27;</span>, <span class="number">35</span>, city=<span class="string">&#x27;Beijing&#x27;</span>)</span><br><span class="line">person(<span class="string">&#x27;Adam&#x27;</span>, <span class="number">45</span>, gender=<span class="string">&#x27;M&#x27;</span>, job=<span class="string">&#x27;Engineer&#x27;</span>)</span><br><span class="line"></span><br><span class="line">extra = &#123;<span class="string">&#x27;city&#x27;</span>: <span class="string">&#x27;Beijing&#x27;</span>, <span class="string">&#x27;job&#x27;</span>: <span class="string">&#x27;Engineer&#x27;</span>&#125;</span><br><span class="line">person(<span class="string">&#x27;Jack&#x27;</span>, <span class="number">24</span>, city=extra[<span class="string">&#x27;city&#x27;</span>], job=extra[<span class="string">&#x27;job&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">#上面调用可以简化成</span></span><br><span class="line"><span class="comment">#**extra表示把 extra dict 所有 key-value 用关键字参数传入到函数的**Kw参数，kw 将获得一个 dict</span></span><br><span class="line">person(<span class="string">&#x27;Jack&#x27;</span>, <span class="number">24</span>, **extra)</span><br><span class="line"><span class="comment">#name: Jack age: 24 other: &#123;&#x27;city&#x27;: &#x27;Beijing&#x27;, &#x27;job&#x27;: &#x27;Engineer&#x27;&#125;</span></span><br></pre></td></tr></table></figure>

<p>检查参数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">person</span>(<span class="params">name, age, **kw</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;city&#x27;</span> <span class="keyword">in</span> kw:</span><br><span class="line">        <span class="comment"># 有city参数</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;job&#x27;</span> <span class="keyword">in</span> kw:</span><br><span class="line">        <span class="comment"># 有job参数</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    print(<span class="string">&#x27;name:&#x27;</span>, name, <span class="string">&#x27;age:&#x27;</span>, age, <span class="string">&#x27;other:&#x27;</span>, kw)</span><br></pre></td></tr></table></figure>

<h5 id="命名关键字参数"><a href="#命名关键字参数" class="headerlink" title="命名关键字参数"></a>命名关键字参数</h5><p>限制关键字参数名字</p>
<p>命名关键字参数，需要一个特殊分隔符 <code>*</code> ， <code>*</code> 后面的参数被视为命名关键字参数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">person</span>(<span class="params">name, age, *, city, job</span>):</span></span><br><span class="line">    print(name, age, city, job)</span><br><span class="line">    </span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>person(<span class="string">&#x27;Jack&#x27;</span>, <span class="number">24</span>, city=<span class="string">&#x27;Beijing&#x27;</span>, job=<span class="string">&#x27;Engineer&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>如果已经有一个可变参数，后面命名关键字参数就不需要特殊分隔符 * 了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">person</span>(<span class="params">name, age, *args, city, job</span>):</span></span><br><span class="line">    print(name, age, args, city, job)</span><br></pre></td></tr></table></figure>

<p>调用需要加参数名字</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">person(<span class="string">&#x27;Jack&#x27;</span>, <span class="number">24</span>, job=<span class="string">&#x27;Engineer&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="参数组合"><a href="#参数组合" class="headerlink" title="参数组合"></a>参数组合</h5><p>必选参数、默认参数、可变参数、命名关键字参数、关键字参数，5种参数可以组合使用</p>
<p>顺序必须是：必选参数、默认参数、可变参数、命名关键字参数、关键字参数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f1</span>(<span class="params">a, b, c=<span class="number">0</span>, *args, **kw</span>):</span></span><br><span class="line">    print(<span class="string">&#x27;a =&#x27;</span>, a, <span class="string">&#x27;b =&#x27;</span>, b, <span class="string">&#x27;c =&#x27;</span>, c, <span class="string">&#x27;args =&#x27;</span>, args, <span class="string">&#x27;kw =&#x27;</span>, kw)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f2</span>(<span class="params">a, b, c=<span class="number">0</span>, *, d, **kw</span>):</span></span><br><span class="line">    print(<span class="string">&#x27;a =&#x27;</span>, a, <span class="string">&#x27;b =&#x27;</span>, b, <span class="string">&#x27;c =&#x27;</span>, c, <span class="string">&#x27;d =&#x27;</span>, d, <span class="string">&#x27;kw =&#x27;</span>, kw)</span><br></pre></td></tr></table></figure>

<p>不要用太多组合，否则理解性很差</p>
<h4 id="高级特性"><a href="#高级特性" class="headerlink" title="高级特性"></a>高级特性</h4><h5 id="切片"><a href="#切片" class="headerlink" title="切片"></a>切片</h5><p>L[0:3] 从索引 0 开始取，直到索引 3 为止，不包括 3，如果第一个索引是0，可以省略 L[:3]</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">L = [<span class="string">&#x27;Michael&#x27;</span>, <span class="string">&#x27;Sarah&#x27;</span>, <span class="string">&#x27;Tracy&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;Jack&#x27;</span>]</span><br><span class="line">print(L[<span class="number">0</span>:<span class="number">3</span>]) <span class="comment">#[&#x27;Michael&#x27;, &#x27;Sarah&#x27;, &#x27;Tracy&#x27;]</span></span><br><span class="line">print(L[:<span class="number">3</span>])</span><br></pre></td></tr></table></figure>

<p>支持倒数切片 L[-1] 取倒数第一个元素</p>
<p>0-99的数列</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">L = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">100</span>))</span><br><span class="line">L[:<span class="number">10</span>]    <span class="comment">#取前10个数 0-9</span></span><br><span class="line">L[<span class="number">-10</span>:]   <span class="comment">#取后10个数</span></span><br><span class="line">L[<span class="number">10</span>：<span class="number">20</span>] <span class="comment">#取前11-20个数</span></span><br><span class="line">L[:<span class="number">10</span>:<span class="number">2</span>]  <span class="comment">#前10个数每两个取一个</span></span><br><span class="line">L[::<span class="number">5</span>]		<span class="comment">#所有数每5个取一个</span></span><br><span class="line">L[:]			<span class="comment">#原样复制一个 list</span></span><br></pre></td></tr></table></figure>

<p>tuple 和 str 也可以用切片操作</p>
<h5 id="迭代"><a href="#迭代" class="headerlink" title="迭代"></a>迭代</h5><p>给定一个 list 或 tuple，我们可以通过 for 循环来遍历这个 list 或 tuple，这种遍历称为迭代</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">d = &#123;<span class="string">&#x27;a&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;b&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;c&#x27;</span>: <span class="number">3</span>&#125;</span><br><span class="line"><span class="keyword">for</span> key <span class="keyword">in</span> d:</span><br><span class="line">	print(key)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">for</span> value <span class="keyword">in</span> d.values() <span class="comment">#迭代value</span></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> d.items() <span class="comment">#同时迭代key value</span></span><br></pre></td></tr></table></figure>

<p>使用<code>for</code>循环时，只要作用于一个可迭代对象，<code>for</code>循环就可以正常运行</p>
<p>通过 collections 模块的 Iterable 类型判断对象是否可迭代</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> collections.abc <span class="keyword">import</span> Iterable</span><br><span class="line"><span class="built_in">isinstance</span>(<span class="string">&#x27;abc&#x27;</span>, Iterable) <span class="comment">#str是否是可迭代 True</span></span><br><span class="line"><span class="built_in">isinstance</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], Iterable) <span class="comment">#list是否是可迭代 True</span></span><br></pre></td></tr></table></figure>

<p>python 内置的 enumerate 函数可以把一个 list 变成索引-元素对</p>
<p>这样就可以在 for 循环中同时迭代索引和元素</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i, value <span class="keyword">in</span> <span class="built_in">enumerate</span>([<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>]):</span><br><span class="line">	print(i, value)</span><br></pre></td></tr></table></figure>

<h5 id="列表生成式"><a href="#列表生成式" class="headerlink" title="列表生成式"></a>列表生成式</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>L = [<span class="string">&#x27;Hello&#x27;</span>, <span class="string">&#x27;World&#x27;</span>, <span class="string">&#x27;IBM&#x27;</span>, <span class="string">&#x27;Apple&#x27;</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>[s.lower() <span class="keyword">for</span> s <span class="keyword">in</span> L]</span><br><span class="line">[<span class="string">&#x27;hello&#x27;</span>, <span class="string">&#x27;world&#x27;</span>, <span class="string">&#x27;ibm&#x27;</span>, <span class="string">&#x27;apple&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>要生成 [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">1</span>, <span class="number">11</span>))</span><br><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>]</span><br></pre></td></tr></table></figure>

<p>生成 [1x1, 2x2, 3x3, …, 10x10]</p>
<p>生成列表时 把要生成的元素x*x放到前面 后面for循环就可以把list创建出来</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>[x * x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">11</span>)]</span><br><span class="line">[<span class="number">1</span>, <span class="number">4</span>, <span class="number">9</span>, <span class="number">16</span>, <span class="number">25</span>, <span class="number">36</span>, <span class="number">49</span>, <span class="number">64</span>, <span class="number">81</span>, <span class="number">100</span>]</span><br></pre></td></tr></table></figure>

<p>循环后面还可以加上 if 判断</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[x * x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">11</span>) <span class="keyword">if</span> x % <span class="number">2</span> == <span class="number">0</span>]</span><br></pre></td></tr></table></figure>

<p>还可以使用两层循环</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>[m + n <span class="keyword">for</span> m <span class="keyword">in</span> <span class="string">&#x27;ABC&#x27;</span> <span class="keyword">for</span> n <span class="keyword">in</span> <span class="string">&#x27;XYZ&#x27;</span>]</span><br><span class="line">[<span class="string">&#x27;AX&#x27;</span>, <span class="string">&#x27;AY&#x27;</span>, <span class="string">&#x27;AZ&#x27;</span>, <span class="string">&#x27;BX&#x27;</span>, <span class="string">&#x27;BY&#x27;</span>, <span class="string">&#x27;BZ&#x27;</span>, <span class="string">&#x27;CX&#x27;</span>, <span class="string">&#x27;CY&#x27;</span>, <span class="string">&#x27;CZ&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h5 id="生成器-generator"><a href="#生成器-generator" class="headerlink" title="生成器 generator"></a>生成器 generator</h5><p>列表的元素可以按照某种算法推算出来，一边循环一边计算的机制，称为生成器：generator</p>
<ul>
<li>把列表生成式的 [] 改成 ()，就创建了一个 generator</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">g = (x * x <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>))</span><br><span class="line">print(g) //&lt;generator <span class="built_in">object</span> &lt;genexpr&gt; at <span class="number">0x7f9c13a0bba0</span>&gt;</span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> g:</span><br><span class="line">    print(n)</span><br></pre></td></tr></table></figure>

<p>创建了一个 generator 后，基本上不会调用 next()，而是通过 for 循环来迭代它</p>
<ul>
<li>定义 generator 的另一种方法</li>
</ul>
<p>如果一个函数定义中包含 yield 关键字，这个函数就不再是一个普通函数，而是一个 generator</p>
<p>generator 在每次调用 next() 的时候执行，遇到 yield 语句返回，再次执行的时候从上次返回的 yield 语句处继续执行</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">odd</span>():</span></span><br><span class="line">    print(<span class="string">&#x27;step 1&#x27;</span>)</span><br><span class="line">    <span class="keyword">yield</span> <span class="number">1</span></span><br><span class="line">    print(<span class="string">&#x27;step 2&#x27;</span>)</span><br><span class="line">    <span class="keyword">yield</span>(<span class="number">3</span>)</span><br><span class="line">    print(<span class="string">&#x27;step 3&#x27;</span>)</span><br><span class="line">    <span class="keyword">yield</span>(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>

<p>调用时首先生成一个 generator 对象 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">o = odd()</span><br><span class="line"><span class="built_in">next</span>(o) <span class="comment">#1</span></span><br><span class="line"><span class="built_in">next</span>(o) <span class="comment">#3</span></span><br></pre></td></tr></table></figure>

<h5 id="迭代器-Iterator"><a href="#迭代器-Iterator" class="headerlink" title="迭代器 Iterator"></a>迭代器 Iterator</h5><p>可直接作用于 for 循环的对象称为可迭代对象： <code>Iterable</code></p>
<p>使用 isinstance()，判断一个对象是否是 Iterable</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> collections.abc <span class="keyword">import</span> Iterable</span><br><span class="line"><span class="built_in">isinstance</span>([], Iterable)</span><br><span class="line"><span class="built_in">isinstance</span>(<span class="string">&#x27;abc&#x27;</span>, Iterable)</span><br></pre></td></tr></table></figure>

<p>生成器不但可以作用于 for 循环，还可以被 next() 函数不断调用返回下一个值，知道最后抛出 StopIteration 错误表示无法继续返回下一个值</p>
<p>可以被 next() 函数调用并返回下一个值的对象称为迭代器：<code> Iterator</code></p>
<p>把 list、dict、str 等 Iterable 变成 Iterator 可以使用 iter() 函数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">isinstance</span>(<span class="built_in">iter</span>(<span class="string">&#x27;abc&#x27;</span>), Iterator)</span><br></pre></td></tr></table></figure>



<h5 id="函数式编程"><a href="#函数式编程" class="headerlink" title="函数式编程"></a>函数式编程</h5><ul>
<li>高阶函数</li>
</ul>
<p>map()</p>
<p><code>map()</code>  函数接收两个参数，一个是函数，一个是 Iterable。map 将传入的函数依次作用到序列的每个元素，并把结果作为新的 Iterator 返回</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span>(<span class="params">x</span>):</span></span><br><span class="line">	<span class="keyword">return</span> x*x</span><br><span class="line">r = <span class="built_in">map</span>(f, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>])</span><br><span class="line">print(<span class="built_in">list</span>(r))</span><br><span class="line"><span class="comment">#[1, 4, 9, 16]</span></span><br></pre></td></tr></table></figure>

<p>结果 r 是一个 Iterator，Iterator 是惰性序列，通过 list 函数把它整个序列都计算出来并返回list</p>
<p>把list所有数字转换为字符串</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">list</span>(<span class="built_in">map</span>(<span class="built_in">str</span>, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]))</span><br><span class="line"><span class="comment">#[&#x27;1&#x27;, &#x27;2&#x27;, &#x27;3&#x27;, &#x27;4&#x27;, &#x27;5&#x27;, &#x27;6&#x27;, &#x27;7&#x27;, &#x27;8&#x27;, &#x27;9&#x27;]</span></span><br></pre></td></tr></table></figure>

<p>reduce()</p>
<p>把一个函数作用在一个序列上，这个函数必须接收两个参数，reduce 把结果继续和序列的下一个元素做累积计算</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x, y</span>):</span></span><br><span class="line">	<span class="keyword">return</span> x + y</span><br><span class="line">reduce(add, [<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>]) <span class="comment">#25</span></span><br></pre></td></tr></table></figure>

<p>str 转 int</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> reduce</span><br><span class="line"></span><br><span class="line">DIGITS = &#123;<span class="string">&#x27;0&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;1&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;2&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;3&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;4&#x27;</span>: <span class="number">4</span>, <span class="string">&#x27;5&#x27;</span>: <span class="number">5</span>, <span class="string">&#x27;6&#x27;</span>: <span class="number">6</span>, <span class="string">&#x27;7&#x27;</span>: <span class="number">7</span>, <span class="string">&#x27;8&#x27;</span>: <span class="number">8</span>, <span class="string">&#x27;9&#x27;</span>: <span class="number">9</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str2int</span>(<span class="params">s</span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">fn</span>(<span class="params">x, y</span>):</span></span><br><span class="line">      <span class="keyword">return</span> x * <span class="number">10</span> + y</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">char2num</span>(<span class="params">s</span>):</span></span><br><span class="line">      <span class="keyword">return</span> DIGITS[s]</span><br><span class="line">  <span class="keyword">return</span> reduce(fn, <span class="built_in">map</span>(char2num, s))</span><br></pre></td></tr></table></figure>

<p>用 lambda 函数进一步简化</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> reduce</span><br><span class="line"></span><br><span class="line">DIGITS = &#123;<span class="string">&#x27;0&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;1&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;2&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;3&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;4&#x27;</span>: <span class="number">4</span>, <span class="string">&#x27;5&#x27;</span>: <span class="number">5</span>, <span class="string">&#x27;6&#x27;</span>: <span class="number">6</span>, <span class="string">&#x27;7&#x27;</span>: <span class="number">7</span>, <span class="string">&#x27;8&#x27;</span>: <span class="number">8</span>, <span class="string">&#x27;9&#x27;</span>: <span class="number">9</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">char2num</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="keyword">return</span> DIGITS[s]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str2int</span>(<span class="params">s</span>):</span></span><br><span class="line">    <span class="keyword">return</span> reduce(<span class="keyword">lambda</span> x, y: x * <span class="number">10</span> + y, <span class="built_in">map</span>(char2num, s))</span><br></pre></td></tr></table></figure>

<p>filter()</p>
<p>接收一个函数和一个序列，把传入的函数依次作用于每个元素，然后根据返回值是 True 还是 False 决定保留还是丢弃该元素</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_odd</span>(<span class="params">n</span>):</span></span><br><span class="line">  <span class="keyword">return</span> n % <span class="number">2</span> == <span class="number">1</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">not_empty</span>(<span class="params">s</span>):</span></span><br><span class="line">  <span class="keyword">return</span> s <span class="keyword">and</span> s.strip()</span><br><span class="line"></span><br><span class="line"><span class="built_in">list</span>(<span class="built_in">filter</span>(is_odd, [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>]))</span><br><span class="line"><span class="built_in">list</span>(<span class="built_in">filter</span>(not_empty, [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="literal">None</span>])) <span class="comment">#A</span></span><br></pre></td></tr></table></figure>

<p>sorted()</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sorted</span>([<span class="number">36</span>, <span class="number">5</span>, <span class="number">-12</span>, <span class="number">9</span>, <span class="number">-21</span>])</span><br><span class="line"><span class="comment">#[-21, -12, 5, 9, 36]</span></span><br></pre></td></tr></table></figure>

<p>可以接收一个 key 函数来实现自定义排序</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sorted</span>([<span class="number">36</span>, <span class="number">5</span>, <span class="number">-12</span>, <span class="number">9</span>, <span class="number">-21</span>], key=<span class="built_in">abs</span>)</span><br><span class="line"><span class="comment">#[5, 9, -12, -21, 36]</span></span><br><span class="line"><span class="built_in">sorted</span>([<span class="string">&#x27;bob&#x27;</span>, <span class="string">&#x27;about&#x27;</span>, <span class="string">&#x27;Zoo&#x27;</span>, <span class="string">&#x27;Credit&#x27;</span>], key=<span class="built_in">str</span>.lower)</span><br><span class="line"><span class="comment">#[&#x27;about&#x27;, &#x27;bob&#x27;, &#x27;Credit&#x27;, &#x27;Zoo&#x27;]</span></span><br><span class="line"><span class="comment">#反向排序</span></span><br><span class="line"><span class="built_in">sorted</span>([<span class="string">&#x27;bob&#x27;</span>, <span class="string">&#x27;about&#x27;</span>, <span class="string">&#x27;Zoo&#x27;</span>, <span class="string">&#x27;Credit&#x27;</span>], key=<span class="built_in">str</span>.lower, reverse=<span class="literal">True</span>)</span><br><span class="line"><span class="comment">#[&#x27;Zoo&#x27;, &#x27;Credit&#x27;, &#x27;bob&#x27;, &#x27;about&#x27;]</span></span><br></pre></td></tr></table></figure>

<ul>
<li>返回函数</li>
</ul>
<p>函数作为返回值</p>
<p>不需要立刻求和，而是在后面的代码中，根据需要再计算</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lazy_sum</span>(<span class="params">*args</span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">sum</span>():</span></span><br><span class="line">      ax = <span class="number">0</span></span><br><span class="line">      <span class="keyword">for</span> n <span class="keyword">in</span> args:</span><br><span class="line">          ax = ax + n</span><br><span class="line">      <span class="keyword">return</span> ax</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">sum</span></span><br><span class="line">f = lazy_sum(<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>)</span><br><span class="line">f()</span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="匿名函数"><a href="#匿名函数" class="headerlink" title="匿名函数"></a>匿名函数</h6></li>
</ul>
<p>在传入函数时，有时候，不需要显式的定义函数，直接传入匿名函数更方便</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">list</span>(<span class="built_in">map</span>(<span class="keyword">lambda</span> x: x * x, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]))</span><br></pre></td></tr></table></figure>

<p>匿名函数实际上就是</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span>(<span class="params">x</span>):</span></span><br><span class="line">	<span class="keyword">return</span> x * x</span><br></pre></td></tr></table></figure>

<p>关键字 lambda 表示匿名函数，冒号前面的 x 表示函数参数</p>
<p>匿名函数也是一个函数对象，也可以把匿名函数赋值给一个变量，再利用变量来调用函数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">f = <span class="keyword">lambda</span> x: x*x</span><br><span class="line">f(<span class="number">5</span>) <span class="comment">#25</span></span><br></pre></td></tr></table></figure>

<p>同样可以把匿名函数作为返回值</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build</span>(<span class="params">x, y</span>):</span></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">lambda</span>: x*x+y*y</span><br></pre></td></tr></table></figure>

<h6 id="装饰器"><a href="#装饰器" class="headerlink" title="装饰器"></a>装饰器</h6><p>函数对象有一个  <code>__name__</code>  属性，可以拿到函数的名字</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">now</span>():</span></span><br><span class="line">	print(<span class="string">&#x27;2015-3-25&#x27;</span>)</span><br><span class="line">now.__name__  <span class="comment">#&#x27;now&#x27;</span></span><br></pre></td></tr></table></figure>

<p>假设要增强 now 的功能，比如调用前后自动打印日志，但又不希望修改 now 函数的定义</p>
<p>代码运行期间动态增加功能的方式，称为装饰器 Decorator</p>
<p>定义一个打印日志的 decorator</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log</span>(<span class="params">func</span>):</span></span><br><span class="line"><span class="meta">  @functools.wraps(func)</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args, **kw</span>):</span></span><br><span class="line">		print(<span class="string">&#x27;call %s():&#x27;</span> % func.__name__)</span><br><span class="line">		<span class="keyword">return</span> func(*args, **kw) <span class="comment">#先打印日志 再调用原始函数</span></span><br><span class="line">	<span class="keyword">return</span> wrapper</span><br></pre></td></tr></table></figure>

<p>借助 Python 的 @ 语法，把 decorator 置于函数的定义处</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@log</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">now</span>():</span>:</span><br><span class="line">	print(<span class="string">&#x27;2015-3-25&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>调用 now 函数，不仅会运行 now() 函数本身，还会在运行 now 函数前打印一行日志</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">now()</span><br><span class="line"><span class="comment">#call now():</span></span><br><span class="line"><span class="comment">#2015-3-25</span></span><br></pre></td></tr></table></figure>

<p>把 @log 放到 now() 函数的定义处，相当于执行了语句</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">now = log(now)</span><br></pre></td></tr></table></figure>

<p>log() 是一个 decorator，返回一个函数</p>
<ul>
<li>偏函数</li>
</ul>
<p>Python 的 functools 模块提供了很多有用的功能，其中一个就是偏函数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> functools</span><br><span class="line">int2 = functools.partial(<span class="built_in">int</span>, base=<span class="number">2</span>)</span><br><span class="line"><span class="comment">#固定 int 函数的关键字参数 base=2</span></span><br><span class="line">int2(<span class="string">&#x27;1000000&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>把一个函数的某些参数给固定住，也就是设置默认值，返回一个新的函数</p>
<p>相当于</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">int2</span>(<span class="params">x, base=<span class="number">2</span></span>)</span></span><br><span class="line"><span class="function">	<span class="title">return</span> <span class="title">int</span>(<span class="params">x, base</span>)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">max2 = functools.partial(<span class="built_in">max</span>, <span class="number">10</span>)</span><br><span class="line"><span class="comment">#实际上把10作为 *args的一部分自动加到左边</span></span><br><span class="line">max2(<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>)</span><br><span class="line"><span class="comment">#相当于</span></span><br><span class="line">args = (<span class="number">10</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>)</span><br><span class="line"><span class="built_in">max</span>(*args) <span class="comment">#*args 加*号 args作为可变参数传入</span></span><br></pre></td></tr></table></figure>

<p>当函数的参数个数太多，需要简化时，使用 functools.partial 可以创建一个新的函数</p>
<h5 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h5><p>一个 .py 文件就称之为一个模块</p>
<p>按目录来组织模块的方法，称为包 Package</p>
<p>一个 abc.py 的文件就叫 abc 模块，如果这模块名字和其他模块冲突了，可以通过包来组织模块，避免冲突</p>
<p>用包来组织模块，每个包目录下都有一个 <code>__init__.py</code>，文件，必须存在，否则 python 就把这个目录当成一个普通目录，而不是一个包，可以是空文件</p>
<ul>
<li>使用模块</li>
</ul>
<p>以内建的 sys 模块为例， 编写一个 hello 模块</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-  </span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27; a test module &#x27;</span> <span class="comment"># 任何模块代码的第一个字符串都被视为模块的文档注释</span></span><br><span class="line"></span><br><span class="line">__author__ = <span class="string">&#x27;Michael Liao&#x27;</span>  <span class="comment">#把作者写进去</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">    args = sys.argv</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(args)==<span class="number">1</span>:</span><br><span class="line">        print(<span class="string">&#x27;Hello, world!&#x27;</span>)</span><br><span class="line">    <span class="keyword">elif</span> <span class="built_in">len</span>(args)==<span class="number">2</span>:</span><br><span class="line">        print(<span class="string">&#x27;Hello, %s!&#x27;</span> % args[<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">&#x27;Too many arguments!&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    test()</span><br></pre></td></tr></table></figure>

<p>第 1 行 第 2 行是标准注释</p>
<p>第一行注释可以让这个 hello.py 文件直接在 Unix/Linux/Mac 上运行</p>
<p>第二行注释表示.py 文件本身使用标准 utf-8 编码</p>
<p>sys 模块有一个 argv 变量，用 list 存储了命令行的所有参数。argv 至少有一个参数，因为第一个参数永远是该 .py 文件的名称</p>
<p>例如 python3 hello.py 获得 sys.argv 就是 <code> [&#39;hello.py&#39;]</code></p>
<p>运行 python3 hello.py Michael 获得 sys.argv 就是 <code> [&#39;hello.py&#39;, &#39;Michael&#39;]</code></p>
<ul>
<li>作用域</li>
</ul>
<p><code>__xxx__</code> 这样的变量是特殊变量，可以被直接引用，但是有特殊用途</p>
<p><code>_xx</code>  <code>__xx</code> 这样的函数或者变量就是非公开的，不应该被直接引用</p>
<h6 id="安装第三方模块"><a href="#安装第三方模块" class="headerlink" title="安装第三方模块"></a>安装第三方模块</h6><p>第三方库都会在Python官方的 <a href="http://pypi.python.org/">http://pypi.python.org</a> 网站注册</p>
<p>安装第三方库用 pip 一个个安装费时费力，还需要考虑兼容性，推荐直接使用 Anaconda，内置了许多常用的第三方库，装上 Anaconda 就相当于把数十个第三方模块自动安装好了</p>
<p>Anaconda 安装的第三方模块会安装在 Anaconda 自己的路径下，不影响系统已安装的Python目录</p>
<ul>
<li>模块搜索路径</li>
</ul>
<p>加载一个模块时，Python 会在指定的路径下搜索对应的 .py 文件，如果找不到就会报错</p>
<p>Python解释器会搜索当前目录、所有已安装的内置模块和第三方模块，搜索路径存放在<code>sys</code>模块的<code>path</code>变量中</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.path</span><br><span class="line"><span class="comment">#[&#x27;&#x27;, &#x27;/Library/Frameworks/Python.framework/Versions/3.6/lib/python36.zip&#x27;, &#x27;/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6&#x27;, ..., &#x27;/Library/Frameworks/Python.framework/Versions/3.6/lib/python3.6/site-packages&#x27;]</span></span><br></pre></td></tr></table></figure>

<h4 id="logging"><a href="#logging" class="headerlink" title="logging"></a>logging</h4><ul>
<li>简单使用 </li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logging.basicConfig(kevek=logging.INFO, <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s-%(levelname)s: %(message)s&#x27;</span>)</span><br><span class="line">...</span><br><span class="line">logging.info(<span class="string">&#x27;scraping %s&#x27;</span>, URL)</span><br><span class="line">logging.info(<span class="string">&#x27;total time %s seconds&#x27;</span>, end_time - start_time)</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">filename 保存日志文件</span></span><br><span class="line"><span class="string">filemode &#x27;w&#x27;打开新文件覆盖 默认&#x27;a&#x27;追加输入</span></span><br><span class="line"><span class="string">level 默认INFO</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">logging.basicConfig(filename=<span class="string">&#x27;xxx.log&#x27;</span>, filemode=<span class="string">&#x27;w&#x27;</span>, level=logging.INFO)</span><br><span class="line">logging.warning(<span class="string">&#x27;warning&#x27;</span>)</span><br><span class="line">logging.info(<span class="string">&#x27;info&#x27;</span>)</span><br><span class="line">logging.error(<span class="string">&#x27;error&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>创建 Logger 记录器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">logger &#x3D; logging.getLogger()</span><br></pre></td></tr></table></figure>

<p>设置日志级别</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">logger.setLevel(logging.INFO)</span><br></pre></td></tr></table></figure>

<ul>
<li>Handler 处理器</li>
</ul>
<p>常用三种 StreamHandler、FileHandler、NullHandler</p>
<p>创建 StreamHandler 之后，可以设置日志级别，设置格式化器 Formatter，增加或删除过滤器</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">console_handler = logging.StreamHandler()</span><br><span class="line"><span class="comment"># 指定日志级别 低于WARN级别日志将被忽略</span></span><br><span class="line">console_handler.setLevel(logging.WARN)</span><br><span class="line"><span class="comment"># 设置一个格式化器 formatter</span></span><br><span class="line">console_handler.setFormatter(formatter_name)</span><br><span class="line"><span class="comment"># 增加过滤器</span></span><br><span class="line">console_handler.addFilter(filter_name)</span><br><span class="line"><span class="comment"># 删除过滤器</span></span><br><span class="line">console_handler.removeFilter(filter_name)</span><br></pre></td></tr></table></figure>



<p>jd_logger.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> logging.handlers</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">日志模块</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">LOG_FILENAME = <span class="string">&#x27;../jd_seckill.log&#x27;</span></span><br><span class="line">logger = logging.getLogger()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_logger</span>():</span></span><br><span class="line">    logger.setLevel(logging.INFO)</span><br><span class="line">    formatter = logging.Formatter(<span class="string">&#x27;%(asctime)s - %(process)d-%(threadName)s - &#x27;</span></span><br><span class="line">                                  <span class="string">&#x27;%(pathname)s[line:%(lineno)d] - %(levelname)s: %(message)s&#x27;</span>)</span><br><span class="line">    console_handler = logging.StreamHandler()</span><br><span class="line">    console_handler.setFormatter(formatter)</span><br><span class="line">    logger.addHandler(console_handler)</span><br><span class="line">    </span><br><span class="line">    file_handler = logging.handlers.RotatingFileHandler(</span><br><span class="line">        LOG_FILENAME, maxBytes=<span class="number">10485760</span>, backupCount=<span class="number">5</span>, encoding=<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    file_handler.setFormatter(formatter)</span><br><span class="line">    logger.addHandler(file_handler)</span><br><span class="line">set_logger()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">LOG_FILENAME = <span class="string">&#x27;../jd_seckill.log&#x27;</span></span><br><span class="line">logger = logging.getLogger()</span><br><span class="line">logger.setLevel(logging.DEBUG)</span><br><span class="line"></span><br><span class="line">formatter = logging.Formatter(<span class="string">&#x27;%(asctime)s - %(funcName)s - line:[%(lineno)d] - %(levelname)s:%(message)s&#x27;</span>)</span><br><span class="line"></span><br><span class="line">consoleHandler = logging.StreamHandler()</span><br><span class="line">consoleHandler.setFormatter(formatter)</span><br><span class="line">consoleHandler.setLevel(logging.INFO)</span><br><span class="line"></span><br><span class="line">fileHandler = logging.FileHandler(LOG_FILENAME, encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">fileHandler.setFormatter(formatter)</span><br><span class="line">fileHandler.setLevel(logging.DEBUG)</span><br><span class="line"></span><br><span class="line">logger.addHandler(consoleHandler)</span><br><span class="line">logger.addHandler(fileHandler)</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">%(levelno)s 打印日志级别的数值 </span><br><span class="line">%(levelname)s 打印日志级别名称</span><br><span class="line">%(pathname)s 打印当前执行程序的路径 </span><br><span class="line">%(filename)s 打印当前执行程序名称</span><br><span class="line">%(funcName)s 打印日志的当前函数 </span><br><span class="line">%(lineno)d 打印日志的当前行号 </span><br><span class="line">%(asctime)s 打印日志的时间 </span><br><span class="line">%(thread)d 打印线程<span class="built_in">id</span> </span><br><span class="line">%(threadName)s 打印线程名称</span><br><span class="line">%(process)d 打印进程ID</span><br><span class="line">%(message)s 打印日志信息</span><br></pre></td></tr></table></figure>



<h4 id="configparser"><a href="#configparser" class="headerlink" title="configparser"></a>configparser</h4><h4 id="time"><a href="#time" class="headerlink" title="time"></a>time</h4><ul>
<li>时间戳 </li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line">ticks = time.time()</span><br><span class="line">print(ticks) <span class="comment">#1650849507.429631</span></span><br></pre></td></tr></table></figure>

<p>很多Python函数用一个元组装起来的9组数字处理时间 struct_time </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tm_year   <span class="comment">#4位数年 2022</span></span><br><span class="line">tm_mon    <span class="comment">#月 1到12</span></span><br><span class="line">tm_mday		<span class="comment">#日 1到31</span></span><br><span class="line">tm_hour   <span class="comment">#小时 0到23</span></span><br><span class="line">tm_min		<span class="comment">#分钟 0到59</span></span><br><span class="line">tm_sec		<span class="comment">#秒数 0到61 (60或61 是闰秒)</span></span><br><span class="line">tm_wday		<span class="comment">#一周的第几天 0到6（0是周一）</span></span><br><span class="line">tm_yday		<span class="comment">#一年的第几天 1到366</span></span><br><span class="line">tm_isdst  <span class="comment">#是否为夏令时 1夏令时 0不是 -1未知 默认-1</span></span><br></pre></td></tr></table></figure>

<ul>
<li>localtime </li>
</ul>
<p>接收时间戳，返回当地时间下的事件元组，时间戳获取时间元组 struct_time</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">localtime = time.localtime(time.time())</span><br><span class="line">print(localtime)</span><br><span class="line">print(time.localtime()) <span class="comment">#结果一样</span></span><br><span class="line"><span class="comment">#time.struct_time(tm_year=2022, tm_mon=4, tm_mday=25, tm_hour=9, tm_min=27, tm_sec=34, tm_wday=0, tm_yday=115, tm_isdst=0)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>asctime </li>
</ul>
<p>接受时间元组，返回格式化 <code>Mon Apr 25 09:29:59 2022</code> 形式的24个字符字符串</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">localtime = time.asctime(time.localtime())</span><br><span class="line">print(localtime) </span><br><span class="line"><span class="comment">#Mon Apr 25 09:29:59 2022</span></span><br></pre></td></tr></table></figure>

<ul>
<li>strftime 格式化日期</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(time.strftime(<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>, time.localtime()))</span><br><span class="line"><span class="comment">#2022-04-25 09:34:11</span></span><br><span class="line">print(time.strftime(<span class="string">&#x27;%a %b %d %H:%M:%S %Y&#x27;</span>, time.localtime()))</span><br><span class="line"><span class="comment">#Mon Apr 25 09:35:53 2022</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#格式化时间转为 struct_time</span></span><br><span class="line">timeStr = time.strftime(<span class="string">&#x27;%Y-%m-%d&#x27;</span>, time.localtime()) <span class="comment">#2022-05-23</span></span><br><span class="line">struct_time = time.strptime(timeStr, <span class="string">&#x27;%Y-%m-%d&#x27;</span>) <span class="comment">#time.struct_time(tm_year=2022, tm_mon=5, tm_mday=23, tm_hour=0, tm_min=0, tm_sec=0, tm_wday=0, tm_yday=143, tm_isdst=-1)</span></span><br><span class="line">print(time.mktime(struct_time)*<span class="number">1000</span>) <span class="comment">#1653235200000</span></span><br></pre></td></tr></table></figure>

<p>输出日历</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(calendar.month(<span class="number">2022</span>, <span class="number">4</span>))</span><br><span class="line">     April <span class="number">2022</span></span><br><span class="line">Mo Tu We Th Fr Sa Su</span><br><span class="line">             <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span></span><br><span class="line"> <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span> <span class="number">10</span></span><br><span class="line"><span class="number">11</span> <span class="number">12</span> <span class="number">13</span> <span class="number">14</span> <span class="number">15</span> <span class="number">16</span> <span class="number">17</span></span><br><span class="line"><span class="number">18</span> <span class="number">19</span> <span class="number">20</span> <span class="number">21</span> <span class="number">22</span> <span class="number">23</span> <span class="number">24</span></span><br><span class="line"><span class="number">25</span> <span class="number">26</span> <span class="number">27</span> <span class="number">28</span> <span class="number">29</span> <span class="number">30</span></span><br></pre></td></tr></table></figure>

<ul>
<li>sleep 推迟调用线程的运行</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">time.sleep(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>

<h4 id="os"><a href="#os" class="headerlink" title="os"></a>os</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> mkdir</span><br><span class="line"><span class="keyword">from</span> os.path <span class="keyword">import</span> exists</span><br><span class="line">RESULT_URL = <span class="string">&#x27;results&#x27;</span></span><br><span class="line">exists(RESULT_URL) <span class="keyword">or</span> makedirs(RESULT_URL)</span><br></pre></td></tr></table></figure>





















<h4 id="面向对象编程"><a href="#面向对象编程" class="headerlink" title="面向对象编程"></a>面向对象编程</h4><h5 id="类和实例"><a href="#类和实例" class="headerlink" title="类和实例"></a>类和实例</h5><p>(object) 表示从哪个类继承下来的</p>
<p>第一个参数固定self 表示创建实例本身</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span>(<span class="params"><span class="built_in">object</span></span>):</span> </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, score</span>):</span></span><br><span class="line">        self.name = name</span><br><span class="line">        self.score = score</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">print_score</span>(<span class="params">self</span>):</span></span><br><span class="line">        print(<span class="string">&#x27;%s: %s&#x27;</span> % (self.name, self.score))</span><br></pre></td></tr></table></figure>

<p>有了init方法 创建实例的时候就不能传空参数了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">bart = Student(<span class="string">&#x27;Bart&#x27;</span>, <span class="number">59</span>)</span><br></pre></td></tr></table></figure>

<h5 id="访问限制"><a href="#访问限制" class="headerlink" title="访问限制"></a>访问限制</h5><p>如果要让内部属性不被外部访问，名称前加两个下划线 <code>__</code>，就变成私有变量，这样外部就不能访问了，如果要外部访问可以增加 get 方法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name, score</span>):</span></span><br><span class="line">      self.__name = name</span><br><span class="line">      self.__score = score</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">print_score</span>(<span class="params">self</span>):</span></span><br><span class="line">      print(<span class="string">&#x27;%s: %s&#x27;</span> % (self.__name, self.__score))</span><br></pre></td></tr></table></figure>

<p>添加 get set 方法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_name</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">return</span> self.__name</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_score</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">return</span> self.__score</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_score</span>(<span class="params">self, score</span>):</span></span><br><span class="line">    self.__score = score</span><br></pre></td></tr></table></figure>

<ul>
<li>对象信息</li>
</ul>
<p>type()  判断对象类型、isinstance() 判断class 类型</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">type</span>(<span class="number">123</span>) <span class="comment"># &lt;class &#x27;int&#x27;&gt;</span></span><br></pre></td></tr></table></figure>

<p>判断对象是否函数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> types</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fn</span>():</span></span><br><span class="line">	<span class="keyword">pass</span></span><br><span class="line"><span class="built_in">type</span>(fn)==types.FunctionType <span class="comment">#True</span></span><br></pre></td></tr></table></figure>

<p>获取对象所有属性和方法 dir()， 返回包含字符串的 list</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">dir</span>(<span class="string">&#x27;ABC&#x27;</span>)</span><br><span class="line"><span class="comment">#[&#x27;__add__&#x27;, &#x27;__class__&#x27;,..., &#x27;__subclasshook__&#x27;, &#x27;capitalize&#x27;, &#x27;casefold&#x27;,..., &#x27;zfill&#x27;]</span></span><br></pre></td></tr></table></figure>

<p>配合<code>getattr()</code>、<code>setattr()</code>以及<code>hasattr()</code>，我们可以直接操作一个对象的状态</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">obj = MyObject()</span><br><span class="line"><span class="built_in">hasattr</span>(obj, <span class="string">&#x27;x&#x27;</span>) <span class="comment"># 有属性&#x27;x&#x27;吗？</span></span><br><span class="line"><span class="built_in">setattr</span>(obj, <span class="string">&#x27;y&#x27;</span>, <span class="number">19</span>) <span class="comment"># 设置一个属性&#x27;y&#x27;</span></span><br><span class="line"><span class="built_in">getattr</span>(obj, <span class="string">&#x27;y&#x27;</span>) <span class="comment"># 获取属性&#x27;y&#x27;</span></span><br><span class="line">obj.y <span class="comment"># 获取属性&#x27;y&#x27;</span></span><br><span class="line"><span class="built_in">getattr</span>(obj, <span class="string">&#x27;z&#x27;</span>, <span class="number">404</span>) <span class="comment"># 获取属性&#x27;z&#x27;，如果不存在，返回默认值404</span></span><br></pre></td></tr></table></figure>





<ul>
<li>实例属性和类属性</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    name = <span class="string">&#x27;Student&#x27;</span> <span class="comment"># 类属性</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name</span>):</span></span><br><span class="line">      self.name = name <span class="comment">#实例属性</span></span><br></pre></td></tr></table></figure>

<h4 id="面向对象高级编程"><a href="#面向对象高级编程" class="headerlink" title="面向对象高级编程"></a>面向对象高级编程</h4><h5 id="slots"><a href="#slots" class="headerlink" title="slots"></a><strong>slots</strong></h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">s = Student()</span><br><span class="line">s.name = <span class="string">&#x27;Michael&#x27;</span> <span class="comment">#动态给实例绑定属性</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_age</span>(<span class="params">self, age</span>):</span></span><br><span class="line">  self.age = age</span><br><span class="line">  </span><br><span class="line"><span class="keyword">from</span> types <span class="keyword">import</span> MethodType</span><br><span class="line">s.set_age = MethodType(set_age, s) <span class="comment">#给实例绑定一个方法</span></span><br><span class="line">s.set_age(<span class="number">25</span>) <span class="comment">#调用实例方法</span></span><br></pre></td></tr></table></figure>

<p>但是给一个实例绑定的方法，对另一个实例不起作用</p>
<p>Python允许在定义class的时候，定义一个特殊的<code>__slots__</code>变量，来限制该class实例能添加的属性</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    __slots__ = (<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;age&#x27;</span>) <span class="comment"># 用tuple定义允许绑定的属性名称</span></span><br></pre></td></tr></table></figure>

<p>使用<code>__slots__</code>要注意，<code>__slots__</code>定义的属性仅对当前类实例起作用，对继承的子类是不起作用的</p>
<h5 id="property"><a href="#property" class="headerlink" title="@property"></a>@property</h5><h5 id="多重继承"><a href="#多重继承" class="headerlink" title="多重继承"></a>多重继承</h5><h5 id="定制类"><a href="#定制类" class="headerlink" title="定制类"></a>定制类</h5><h5 id="使用枚举"><a href="#使用枚举" class="headerlink" title="使用枚举"></a>使用枚举</h5><p>使用元类</p>
<h4 id="错误、调试和测试"><a href="#错误、调试和测试" class="headerlink" title="错误、调试和测试"></a>错误、调试和测试</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    print(<span class="string">&#x27;try...&#x27;</span>)</span><br><span class="line">    r = <span class="number">10</span> / <span class="built_in">int</span>(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    print(<span class="string">&#x27;result:&#x27;</span>, r)</span><br><span class="line"><span class="keyword">except</span> ValueError <span class="keyword">as</span> e:</span><br><span class="line">    print(<span class="string">&#x27;ValueError:&#x27;</span>, e)</span><br><span class="line"><span class="keyword">except</span> ZeroDivisionError <span class="keyword">as</span> e:</span><br><span class="line">    print(<span class="string">&#x27;ZeroDivisionError:&#x27;</span>, e)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    print(<span class="string">&#x27;finally...&#x27;</span>)</span><br><span class="line">print(<span class="string">&#x27;END&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>Python 所有的错误都是从 BaseException 类派生的</p>
<p>常见的错误类型和继承关系 <a href="https://docs.python.org/3/library/exceptions.html#exception-hierarchy">https://docs.python.org/3/library/exceptions.html#exception-hierarchy</a></p>
<ul>
<li>记录错误</li>
</ul>
<p>内置的 logging 模块可以非常容易的记录错误，</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># err_logging.py</span><br><span class="line">import logging</span><br><span class="line"></span><br><span class="line">def foo(s):</span><br><span class="line">    return 10 &#x2F; int(s)</span><br><span class="line">def bar(s):</span><br><span class="line">    return foo(s) * 2</span><br><span class="line">def main():</span><br><span class="line">    try:</span><br><span class="line">        bar(&#39;0&#39;)</span><br><span class="line">    except Exception as e:</span><br><span class="line">        logging.exception(e)</span><br><span class="line">main()</span><br><span class="line">print(&#39;END&#39;)</span><br></pre></td></tr></table></figure>

<p>通过配置 loging 还可以把错误记录到日志文件里</p>
<p>抛出错误</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># err_raise.py</span><br><span class="line">class FooError(ValueError):</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line">def foo(s):</span><br><span class="line">    n &#x3D; int(s)</span><br><span class="line">    if n&#x3D;&#x3D;0:</span><br><span class="line">        raise FooError(&#39;invalid value: %s&#39; % s)</span><br><span class="line">    return 10 &#x2F; n</span><br><span class="line"></span><br><span class="line">foo(&#39;0&#39;)</span><br></pre></td></tr></table></figure>



<h4 id="IO编程"><a href="#IO编程" class="headerlink" title="IO编程"></a>IO编程</h4><h5 id="文件读写"><a href="#文件读写" class="headerlink" title="文件读写"></a>文件读写</h5><ul>
<li>读文件</li>
</ul>
<p>使用 Python 内置 open() 函数，传入文件名和标识符，r 表示读，如果文件不存在 open 函数会抛出 IOError 错误</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">f = <span class="built_in">open</span>(<span class="string">&#x27;/Users/michael/test.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">f.read()</span><br><span class="line">f.close()</span><br></pre></td></tr></table></figure>

<p>如果文件打开成功，接下来调用 read() 方法可以一次读取文件的全部内容</p>
<p>close() 方法关闭文件，文件使用完毕后必须关闭，因为文件对象会占用操作系统资源</p>
<p>Python 引入了 with 语句自动帮我们调用 close() 方法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;/path/to/file&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    print(f.read())</span><br></pre></td></tr></table></figure>

<p>read 会一次读取文件全部内容，如果文件太大内存就爆了，可以反复调用 read(size) 方法，每次最多读取 size 字节的内容</p>
<p>调用 readline() 每次读取一行内容，readlines() 一次读取所有内容并按行返回 list</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> f.readlines():</span><br><span class="line">    print(line.strip()) <span class="comment"># 把末尾的&#x27;\n&#x27;删掉</span></span><br></pre></td></tr></table></figure>

<p>写文件</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;/Users/michael/test.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">&#x27;Hello, world!&#x27;</span>)</span><br></pre></td></tr></table></figure>

















































]]></content>
  </entry>
  <entry>
    <title>Runtime底层原理</title>
    <url>/2020/12/01/Runtime%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<h4 id="通过SEL找到IMP"><a href="#通过SEL找到IMP" class="headerlink" title="通过SEL找到IMP"></a>通过SEL找到IMP</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">BOOL class_respondsToSelector(Class cls, SEL sel)</span><br><span class="line">&#123;</span><br><span class="line">    return class_respondsToSelector_inst(cls, sel, nil);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p><a href="https://opensource.apple.com/tarballs/objc4/">苹果源码下载地址</a></p>
]]></content>
  </entry>
  <entry>
    <title>RxSwift（一）</title>
    <url>/2021/09/03/RxSwift%EF%BC%88%E4%B8%80%EF%BC%89/</url>
    <content><![CDATA[<h4 id="1-Observable"><a href="#1-Observable" class="headerlink" title="1 Observable"></a>1 Observable</h4><p><code>Observable&lt;T&gt;</code> 可观察序列 可以异步地产生一系列的Event(事件)</p>
<p>这些Event还可以携带数据</p>
<p>还需要有一个 Observer(订阅者)来订阅它，这样这个订阅者才能接收 <code>Observable&lt;T&gt;</code> 发出的Event</p>
<h5 id="1-1-创建Observable序列"><a href="#1-1-创建Observable序列" class="headerlink" title="1.1 创建Observable序列"></a>1.1 创建Observable序列</h5><ol>
<li>just() 方法</li>
</ol>
<p>传入一个默认值初始化，下面指定了这个Observable所发出的事件携带的数据类型必须是Int类型的</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let observable &#x3D; Observable&lt;Int&gt;.just(5)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>of() 方法</li>
</ol>
<p>接收可变数量的参数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let observable &#x3D; Observable.of(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>from() 方法</li>
</ol>
<p>接收数组参数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let observable &#x3D; Observable.from([&quot;A&quot;, &quot;B&quot;])</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>empty()方法</li>
</ol>
<p>创建一个空内容的Observable序列</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let observable &#x3D; Observable&lt;Int&gt;.empty()</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>never()方法</li>
</ol>
<p>创建永远不会发出Event的Observable</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let observable &#x3D; Observable&lt;Int&gt;.never()</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>error()方法</li>
</ol>
<p>不做任何操作，只发送error的Observable</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">enum MyError: Error &#123;</span><br><span class="line">   case A</span><br><span class="line">   case B</span><br><span class="line">&#125;</span><br><span class="line">let observable &#x3D; Observable&lt;Int&gt;.error(MyError.A)</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>range()方法</li>
</ol>
<p>指定起始值和结束值，创建范围内所有值作为初始值的 Observable 序列，下面两种方法创建的 Observable 序列都是一样的</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;使用range()</span><br><span class="line">let observable &#x3D; Observable.range(start: 1, count: 5)</span><br><span class="line">&#x2F;&#x2F;使用of()</span><br><span class="line">let observable &#x3D; Observable.of(1, 2, 3 ,4 ,5)</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>repeatElement()方法</li>
</ol>
<p>创建可以无限发送给定元素的Event的Observable序列，永不终止</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let observable &#x3D; Observable.repeatElement(1)</span><br></pre></td></tr></table></figure>

<ol start="9">
<li>generate()方法</li>
</ol>
<p>只有当提供的所有判断条件为true的时候才会给出动作的Observable序列，下面两种方法创建的 Observable 序列都是一样的</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let observable &#x3D; Observable.generate(</span><br><span class="line">    initialState: 0,</span><br><span class="line">    condition: &#123; $0 &lt;&#x3D; 10 &#125;,</span><br><span class="line">    iterate: &#123; $0 + 2&#125;</span><br><span class="line">)</span><br><span class="line">let observable &#x3D; Observable.of(0 , 2 ,4 ,6 ,8 ,10)</span><br></pre></td></tr></table></figure>

<ol start="10">
<li>creat()方法</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let observable &#x3D; Observable&lt;String&gt;.create &#123; observer in</span><br><span class="line">    observer.onNext(&quot;hangge.com&quot;)</span><br><span class="line">    observer.onCompleted()</span><br><span class="line">    return Disposables.create()</span><br><span class="line">&#125;</span><br><span class="line">observable.subscribe(&#123;</span><br><span class="line">    print($0)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="11">
<li>defferred()方法</li>
</ol>
<p>相当于创建一个Observable工厂，传入一个block来延迟执行Observable序列创建行为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var isOdd &#x3D; true</span><br><span class="line">&#x2F;&#x2F;使用 deferred 方法延迟 Observable 序列的初始化</span><br><span class="line">let factory: Observable&lt;Int&gt; &#x3D; Observable.deferred &#123;</span><br><span class="line">    isOdd &#x3D; !isOdd</span><br><span class="line">    &#x2F;&#x2F;根据isOdd参数，决定创建并返回的是奇数Observable、还是偶数Observable</span><br><span class="line">    if isOdd &#123;</span><br><span class="line">        return Observable.of(1, 3, 5, 7)</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return Observable.of(2, 4, 6, 8)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;第1次订阅测试</span><br><span class="line">factory.subscribe(&#123; event in</span><br><span class="line">    print(&quot;\(isOdd)&quot;, event)</span><br><span class="line">&#125;)</span><br><span class="line">&#x2F;&#x2F;第2次订阅测试</span><br><span class="line">factory.subscribe(&#123; event in</span><br><span class="line">    print(&quot;\(isOdd)&quot;, event)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ol start="12">
<li>interval()方法</li>
</ol>
<p>每隔一段特定时间，发出索引数的元素</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let observable &#x3D; Observable&lt;Int&gt;.interval(RxTimeInterval.seconds(1), scheduler: MainScheduler.instance)</span><br><span class="line">  </span><br><span class="line">observable.subscribe &#123; event in</span><br><span class="line">    print(event)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="13">
<li>timer()</li>
</ol>
<p>两种用法，一种是创建的 Observable 序列经过设定时间后，产生唯一元素</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let observable &#x3D; Observable&lt;Int&gt;.timer(RxTimeInterval.seconds(5), scheduler: MainScheduler.instance)</span><br><span class="line">observable.subscribe &#123; event in</span><br><span class="line">    print(event)</span><br><span class="line">&#125;</span><br><span class="line">结果：</span><br><span class="line">next(0)</span><br><span class="line">completed</span><br></pre></td></tr></table></figure>

<p>另一种是创建的 Observable 序列在经过设定时间后，每隔一段时间产生一个元素</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;5秒后，每隔1秒发出一个元素</span><br><span class="line">let observable &#x3D; Observable&lt;Int&gt;.timer(RxTimeInterval.seconds(5), period: RxTimeInterval.seconds(1), scheduler: MainScheduler.instance)</span><br><span class="line">observable.subscribe &#123; event in</span><br><span class="line">    print(event)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="1-2-订阅-Observable"><a href="#1-2-订阅-Observable" class="headerlink" title="1.2 订阅 Observable"></a>1.2 订阅 Observable</h5><p>有了Observable，还要使用subscribe()来订阅它，接收它发出的Event</p>
<ul>
<li>第一种</li>
</ul>
<p>使用 subscribe() 订阅 Observable 对象，数据发送完毕后自动发一个 .completed 时间出来</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let observable &#x3D; Observable.of(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;)</span><br><span class="line">observable.subscribe &#123; event in</span><br><span class="line">  	&#x2F;&#x2F;想要获取event数据，可以通过event.element</span><br><span class="line">  	print(event)</span><br><span class="line">&#125;</span><br><span class="line">结果：</span><br><span class="line">next(A)</span><br><span class="line">next(B)</span><br><span class="line">next(C)</span><br><span class="line">completed</span><br></pre></td></tr></table></figure>

<ul>
<li>第二种</li>
</ul>
<p>对event进行分类，通过不同block处理不同event，会把event的数据直接解包出来</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let observable &#x3D; Observable.of(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;)</span><br><span class="line">observable.subscribe &#123; element in</span><br><span class="line">    print(element)</span><br><span class="line">&#125; onError: &#123; error in</span><br><span class="line">    print(error)</span><br><span class="line">&#125; onCompleted: &#123;</span><br><span class="line">    print(&quot;completed&quot;)</span><br><span class="line">&#125; onDisposed: &#123;</span><br><span class="line">    print(&quot;disposed&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="1-3-监听事件生命周期"><a href="#1-3-监听事件生命周期" class="headerlink" title="1.3 监听事件生命周期"></a>1.3 监听事件生命周期</h5><p>doOn方法监听事件生命周期，会在事件发送前被调用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">observable.do(onNext: &#123; (element) in</span><br><span class="line">    print(element)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h5 id="1-4-Observable-销毁"><a href="#1-4-Observable-销毁" class="headerlink" title="1.4 Observable 销毁"></a>1.4 Observable 销毁</h5><ol>
<li>通过dispose()取消订阅</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let subscription &#x3D; observable.subscribe &#123; (event) in</span><br><span class="line">    print(event)</span><br><span class="line">&#125;</span><br><span class="line">subscription.dispose()</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>DisposeBag</li>
</ol>
<p>DisposeBag会在自己快要dealloc的时候，对里面所有订阅行为都调用dispose()方法</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let observable &#x3D; Observable.of(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;)</span><br><span class="line">let disposeBag &#x3D; DisposeBag()</span><br><span class="line">observable.subscribe &#123; (event) in</span><br><span class="line">    print(event)</span><br><span class="line">&#125;.disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h4 id="2-观察者"><a href="#2-观察者" class="headerlink" title="2 观察者"></a>2 观察者</h4><p>观察者（Observer）作用就是监听事件，对事件作出响应，或者说任何响应事件的行为都是观察者</p>
<h5 id="2-1-subscribe、bind方法中创建观察者"><a href="#2-1-subscribe、bind方法中创建观察者" class="headerlink" title="2.1 subscribe、bind方法中创建观察者"></a>2.1 subscribe、bind方法中创建观察者</h5><p>最直接的方法就是在subscribe方法后描述事件发生时，需要如何作出响应</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">observable.subscribe(onNext: &#123; element in</span><br><span class="line">    print(element)</span><br><span class="line">&#125;, onError: &#123; error in</span><br><span class="line">    print(error)</span><br><span class="line">&#125;, onCompleted: &#123;</span><br><span class="line">    print(&quot;completed&quot;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>bind</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let observable &#x3D; Observable&lt;Int&gt;.interval(RxTimeInterval.seconds(1),</span><br><span class="line">                                          scheduler: MainScheduler.instance)</span><br><span class="line">observable</span><br><span class="line">    .map &#123; &quot;当前索引数:\($0)&quot; &#125;</span><br><span class="line">    .bind &#123; [weak self] (text) in</span><br><span class="line">        self?.label.text &#x3D; text</span><br><span class="line">    &#125;</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h5 id="2-2-使用-AnyObserver-创建观察者"><a href="#2-2-使用-AnyObserver-创建观察者" class="headerlink" title="2.2 使用 AnyObserver 创建观察者"></a>2.2 使用 AnyObserver 创建观察者</h5><p>配合 subscribe 使用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let observer: AnyObserver&lt;String&gt; &#x3D; AnyObserver &#123; event in</span><br><span class="line">    switch event &#123;</span><br><span class="line">    case .next(let data):</span><br><span class="line">        print(data)</span><br><span class="line">    case .error(let error):</span><br><span class="line">        print(error)</span><br><span class="line">    case .completed:</span><br><span class="line">        print(&quot;complete&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">let observable &#x3D; Observable.of(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;)</span><br><span class="line">observable.subscribe(observer)</span><br></pre></td></tr></table></figure>

<p>配合 bindTo 使用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let observer: AnyObserver&lt;String&gt; &#x3D; AnyObserver &#123;[weak self] event in</span><br><span class="line">    switch event &#123;</span><br><span class="line">    case .next(let text):</span><br><span class="line">        self?.label.text &#x3D; text</span><br><span class="line">    default:</span><br><span class="line">        break</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let observable &#x3D; Observable&lt;Int&gt;.interval(RxTimeInterval.seconds(1),</span><br><span class="line">                                          scheduler: MainScheduler.instance)</span><br><span class="line">observable</span><br><span class="line">    .map &#123; &quot;当前索引数:\($0)&quot; &#125;</span><br><span class="line">    .bind(to: observer)</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h5 id="2-3-使用-Binder-创建观察者"><a href="#2-3-使用-Binder-创建观察者" class="headerlink" title="2.3 使用 Binder 创建观察者"></a>2.3 使用 Binder 创建观察者</h5><p>Binder不会处理错误事件<br>确保绑定都是在给定的Schedule上执行，默认MainSchedule</p>
<p>上面示例中，label 文字显示就是一个典型的观察者，它在响应事件时，只会处理 next 事件，且更新 UI 的操作需要在主线程上执行，更好的方案是使用 Binder</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let observer: Binder&lt;String&gt; &#x3D; Binder(label) &#123; view, text in</span><br><span class="line">	  view.text &#x3D; text</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">observable</span><br><span class="line">    .map &#123; &quot;当前索引数：\($0 )&quot;&#125;</span><br><span class="line">    .bind(to: observer)</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<ul>
<li>Binder 在 RxCocoa 中的应用</li>
</ul>
<p>RxCocoa 对许多 UI 控件进行扩展，利用 Binder 将控件属性变成观察者</p>
<h5 id="2-4-自定义可绑定属性"><a href="#2-4-自定义可绑定属性" class="headerlink" title="2.4 自定义可绑定属性"></a>2.4 自定义可绑定属性</h5><p>方法一： 通过对 UI 类进行扩展</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">extension UILabel &#123;</span><br><span class="line">    public var fontSize: Binder&lt;CGFloat&gt; &#123;</span><br><span class="line">        return Binder(self) &#123; label, fontSize in</span><br><span class="line">            label.font &#x3D; UIFont.systemFont(ofSize: fontSize)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>方法二：通过对 Reactive 类进行扩展</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">extension Reactive where Base: UILabel &#123;</span><br><span class="line">    public var fontSize: Binder&lt;CGFloat&gt; &#123;</span><br><span class="line">        return Binder(self.base) &#123; label, fontSize in</span><br><span class="line">            label.font &#x3D; UIFont.systemFont(ofSize: fontSize)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-Subject"><a href="#3-Subject" class="headerlink" title="3 Subject"></a>3 Subject</h4><p>创建Observable的时候要预先把将要发出的数据都准备好，等到有人订阅时再将数据通过Event发送出去<br>但有时希望Observable动态的获得或者产生新数据，再通过Event发送出去-这些使用Subject来实现</p>
<p>Subject既是订阅者，也是Observable<br>订阅者：因为它能动态接收新值<br>又是一个Observable：因为当Subjects有了新值后，就会通过Event将新值发送给所有订阅者</p>
<h5 id="3-1-PublishSubject"><a href="#3-1-PublishSubject" class="headerlink" title="3.1 PublishSubject"></a>3.1 PublishSubject</h5><p>不需要初始值就能创建<br>PublishSubject的订阅者，可以收到订阅后Subject发出的新的Event，不会收到订阅前发出的Event</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let subject &#x3D; PublishSubject&lt;String&gt;()</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;没有任何订阅者 这条不会输出</span><br><span class="line">subject.onNext(&quot;11&quot;)</span><br><span class="line"></span><br><span class="line">subject.subscribe(onNext: &#123; string in</span><br><span class="line">    print(&quot;第一次订阅：&quot;, string)</span><br><span class="line">&#125;, onCompleted: &#123;</span><br><span class="line">    print(&quot;第一次订阅：completed&quot;)</span><br><span class="line">&#125;).disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;有订阅会输出</span><br><span class="line">subject.onNext(&quot;22&quot;)</span><br><span class="line"></span><br><span class="line">subject.subscribe(onNext: &#123; string in</span><br><span class="line">    print(&quot;第二次订阅：&quot;, string)</span><br><span class="line">&#125;, onCompleted: &#123;</span><br><span class="line">    print(&quot;第二次订阅：completed&quot;)</span><br><span class="line">&#125;).disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;有订阅会输出</span><br><span class="line">subject.onNext(&quot;33&quot;)</span><br><span class="line">subject.onCompleted()</span><br><span class="line">subject.onNext(&quot;44&quot;)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;完成后所有订阅(包括结束后订阅) 都能收到 complete 事件</span><br><span class="line">subject.subscribe(onNext: &#123; string in</span><br><span class="line">    print(&quot;第三次订阅：&quot;, string)</span><br><span class="line">&#125;, onCompleted: &#123;</span><br><span class="line">    print(&quot;第三次订阅：completed&quot;)</span><br><span class="line">&#125;).disposed(by: disposeBag)</span><br><span class="line">  </span><br><span class="line">结果</span><br><span class="line">第一次订阅： 22</span><br><span class="line">第一次订阅： 33</span><br><span class="line">第二次订阅： 33</span><br><span class="line">第一次订阅：completed</span><br><span class="line">第二次订阅：completed</span><br><span class="line">第三次订阅：completed</span><br></pre></td></tr></table></figure>

<h5 id="3-2-BehaviorSubject"><a href="#3-2-BehaviorSubject" class="headerlink" title="3.2 BehaviorSubject"></a>3.2 BehaviorSubject</h5><p>BehaviorSubject需要通过初始值创建<br>订阅者订阅它的时候，立即收到BehaviorSubject发出的Event，之后正常一样收到之后发出的新的Event</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let subject &#x3D; BehaviorSubject(value: &quot;111&quot;)</span><br><span class="line"></span><br><span class="line">subject.subscribe(onNext: &#123; string in</span><br><span class="line">    print(&quot;第1次订阅：&quot;, string)</span><br><span class="line">&#125;).disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">subject.onNext(&quot;222&quot;)</span><br><span class="line">&#x2F;&#x2F;发送error</span><br><span class="line">subject.onError(NSError(domain: &quot;local&quot;, code: 0, userInfo: nil))</span><br><span class="line"></span><br><span class="line">subject.subscribe(onNext: &#123; string in</span><br><span class="line">    print(&quot;第2次订阅：&quot;, string)</span><br><span class="line">&#125;).disposed(by: disposeBag)</span><br><span class="line">  </span><br><span class="line">输出</span><br><span class="line">第1次订阅： 111</span><br><span class="line">第1次订阅： 222</span><br><span class="line">Unhandled error happened: Error Domain&#x3D;local Code&#x3D;0 &quot;(null)&quot;</span><br><span class="line">Unhandled error happened: Error Domain&#x3D;local Code&#x3D;0 &quot;(null)&quot;</span><br></pre></td></tr></table></figure>

<h5 id="3-3-ReplaySubject"><a href="#3-3-ReplaySubject" class="headerlink" title="3.3 ReplaySubject"></a>3.3 ReplaySubject</h5><p>创建时需要设置一个bufferSize，表示对发送过的Event的缓存个数</p>
<p>如bufferSize设置为2，发出3个.next的Event，那么后面两个会缓存起来，如果一个Subject订阅了这个 ReplaySubject，那立即会收到缓存的两个.next的Event</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let subject &#x3D; ReplaySubject&lt;String&gt;.create(bufferSize: 2)</span><br><span class="line">        </span><br><span class="line">subject.onNext(&quot;111&quot;)</span><br><span class="line">subject.onNext(&quot;222&quot;)</span><br><span class="line">subject.onNext(&quot;333&quot;)</span><br><span class="line"></span><br><span class="line">subject.subscribe &#123; event in</span><br><span class="line">    print(&quot;第1次订阅：&quot;, event)</span><br><span class="line">&#125;.disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">subject.onNext(&quot;444&quot;)</span><br><span class="line"></span><br><span class="line">subject.subscribe &#123; event in</span><br><span class="line">    print(&quot;第2次订阅：&quot;, event)</span><br><span class="line">&#125;.disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">subject.onCompleted()</span><br><span class="line"></span><br><span class="line">subject.subscribe &#123; event in</span><br><span class="line">    print(&quot;第3次订阅：&quot;, event)</span><br><span class="line">&#125;.disposed(by: disposeBag)</span><br><span class="line">  </span><br><span class="line">结果：</span><br><span class="line">第1次订阅： next(222)</span><br><span class="line">第1次订阅： next(333)</span><br><span class="line">第1次订阅： next(444)</span><br><span class="line">第2次订阅： next(333)</span><br><span class="line">第2次订阅： next(444)</span><br><span class="line">第1次订阅： completed</span><br><span class="line">第2次订阅： completed</span><br><span class="line">第3次订阅： next(333)</span><br><span class="line">第3次订阅： next(444)</span><br><span class="line">第3次订阅： completed</span><br></pre></td></tr></table></figure>

<h5 id="3-4-BehaviorRelay"><a href="#3-4-BehaviorRelay" class="headerlink" title="3.4 BehaviorRelay"></a>3.4 BehaviorRelay</h5><p>BehaviorRelay 有一个 value 属性，我们通过这个属性可以获取最新值。而通过它的 accept() 方法可以对值进行修改</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let subject &#x3D; BehaviorRelay&lt;String&gt;(value: &quot;111&quot;)</span><br><span class="line">&#x2F;&#x2F;修改value值</span><br><span class="line">subject.accept(&quot;222&quot;)</span><br><span class="line">subject.subscribe &#123;</span><br><span class="line">    print(&quot;第1次订阅：&quot;, $0)</span><br><span class="line">&#125;.disposed(by: disposeBag)</span><br><span class="line">subject.accept(&quot;333&quot;)</span><br><span class="line">subject.subscribe &#123;</span><br><span class="line">    print(&quot;第2次订阅：&quot;, $0)</span><br><span class="line">&#125;.disposed(by: disposeBag)</span><br><span class="line">subject.accept(&quot;444&quot;)</span><br><span class="line">  </span><br><span class="line">结果：</span><br><span class="line">第1次订阅： next(222)</span><br><span class="line">第1次订阅： next(333)</span><br><span class="line">第2次订阅： next(333)</span><br><span class="line">第1次订阅： next(444)</span><br><span class="line">第2次订阅： next(444)</span><br></pre></td></tr></table></figure>

<h4 id=""><a href="#" class="headerlink" title=""></a></h4>]]></content>
  </entry>
  <entry>
    <title>RxSwift（四）</title>
    <url>/2021/09/09/RxSwift%EF%BC%88%E5%9B%9B%EF%BC%89/</url>
    <content><![CDATA[<h4 id="1-URLSession"><a href="#1-URLSession" class="headerlink" title="1 URLSession"></a>1 URLSession</h4><h5 id="1-1-rx-response-请求数据"><a href="#1-1-rx-response-请求数据" class="headerlink" title="1.1 rx.response 请求数据"></a>1.1 rx.response 请求数据</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let urlString &#x3D; &quot;https:&#x2F;&#x2F;www.douban.com&#x2F;j&#x2F;app&#x2F;radio&#x2F;channels&quot;</span><br><span class="line">let url &#x3D; URL(string: urlString)!</span><br><span class="line">let request &#x3D; URLRequest(url: url)</span><br><span class="line">URLSession.shared.rx.response(request: request)</span><br><span class="line">    .subscribe(onNext: &#123; (response, data) in</span><br><span class="line">        if 200 ..&lt; 300 ~&#x3D; response.statusCode &#123;</span><br><span class="line">            let str &#x3D; String(data: data, encoding: String.Encoding.utf8)</span><br><span class="line">            print(&quot;返回数据：\(str ?? &quot;&quot;)&quot;)</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            print(&quot;请求失败&quot;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h5 id="1-2-rx-data"><a href="#1-2-rx-data" class="headerlink" title="1.2 rx.data"></a>1.2 rx.data</h5><p>如果不需要获取底层 response，只需知道是否请求成功，以及返回结果，建议使用 rx.data</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">URLSession.shared.rx.data(request: request)</span><br><span class="line">    .subscribe(onNext: &#123; data in</span><br><span class="line">        print(&quot;请求成功&quot;)</span><br><span class="line">    &#125;, onError: &#123; error in</span><br><span class="line">        print(&quot;请求失败：&quot;, error)</span><br><span class="line">    &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<p>将结果转换为JSON</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">URLSession.shared.rx.data(request: request)</span><br><span class="line">    .map &#123;</span><br><span class="line">        try JSONSerialization.jsonObject(with: $0, options: .allowFragments) as! [String: Any]</span><br><span class="line">    &#125;</span><br><span class="line">    .subscribe(onNext: &#123; data in</span><br><span class="line">        print(&quot;请求成功&quot;)</span><br><span class="line">    &#125;, onError: &#123; error in</span><br><span class="line">        print(&quot;请求失败：&quot;, error)</span><br><span class="line">    &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h5 id="1-3-手动发起-取消请求"><a href="#1-3-手动发起-取消请求" class="headerlink" title="1.3 手动发起/取消请求"></a>1.3 手动发起/取消请求</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">startButton.rx.tap</span><br><span class="line">    .flatMap &#123;</span><br><span class="line">        URLSession.shared.rx.data(request: request)</span><br><span class="line">            .takeUntil(self.cancelButton.rx.tap)</span><br><span class="line">    &#125;</span><br><span class="line">    .subscribe(onNext: &#123; data in</span><br><span class="line">    &#125;, onError: &#123;error in</span><br><span class="line">        print(&quot;请求失败：&quot;, error)</span><br><span class="line">    &#125;).disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h5 id="1-4-转JSON"><a href="#1-4-转JSON" class="headerlink" title="1.4 转JSON"></a>1.4 转JSON</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">URLSession.shared.rx.data(request: request)</span><br><span class="line">    .map &#123;</span><br><span class="line">        try JSONSerialization.jsonObject(with: $0, options: .allowFragments) as! [String: Any]</span><br><span class="line">    &#125;</span><br><span class="line">    .subscribe(onNext: &#123; data in</span><br><span class="line">        print(&quot;请求成功&quot;)</span><br><span class="line">    &#125;, onError: &#123; error in</span><br><span class="line">        print(&quot;请求失败：&quot;, error)</span><br><span class="line">    &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<p>直接使用 rx.json</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">URLSession.shared.rx.json(request: request)</span><br><span class="line">    .subscribe(onNext: &#123; data in</span><br><span class="line">        let json &#x3D; data as! [String: Any]</span><br><span class="line">        print(&quot;请求成功&quot;)</span><br><span class="line">    &#125;, onError: &#123; error in</span><br><span class="line">        print(&quot;请求失败：&quot;, error)</span><br><span class="line">    &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

































<p><a href="https://www.hangge.com/blog/cache/detail_2010.html">URLSession使用</a></p>
]]></content>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2020/11/14/hello-world/</url>
    <content><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <div class="hbe-input-container">
  <input type="password" id="hbePass" placeholder="" />
    <label for="hbePass">输入密码</label>
    <div class="bottom-line"></div>
  </div>
  <script id="hbeData" type="hbeData" data-hmacdigest="48e31149c438b31829246723271e19d6d0977e5f2df026e3e65f815a03a2237e">ccbf2489ed1a233f216cac1e5dda3d49363c641c556918697fb036546f666b01c7abc45d1943ee9d3408364bd5f46f8570100184557ff9fee405fe56e18b4fd58e086651cbf73064170efc9aedd861898b24a00cfcc3fee3b474b0b571c30f593250c8f7c8c24e627500f5e8c161baa4c36a516fbada282e10e2387441140a89de99961057f1486af8d17c1f891e290c2c1c5834a44d398955fca41b52fb113d52fce8c82f3f05d861bc4bac05e6bedc4f572f4aef60c81250f6758ca5c6611de62bf8a78acd96a3d3f49673040ff9a410ba932192472a21992fc57c329690bc2c930b6950232c8079bcc8ddac7252699cfb36533216ae373b44d02cb7dbb4a1bbdf2a5e938afd1e3e78bf0916f51f3b449809c5267d2fe5850bd5d31e97afbf96342e61c7f87ee5a43ab33c86fe76453bc1072ce91df88fe7bca55722dc893aaf79418c66ff77d76ac7d6699810b133b7758a0be14aef449fd343ef1376fec2a73cd20c02d407df46c6ab7fd86511af99f4916779688c557125b40cbc82d9a249aa9b9e285ae0fb9e258cabb6cce3597958eeb95ab18ec0b3c07943c054b7b28bc0f4f77ba12cb76eee3df04b6b4ff322bd34c093a1c4ab7d9db74fc47592f389f280fefcce7fd4e0fce2945368e91bbeb02eb882822c402116acb46283ed0d86be720cb21722ff1f1cb64b8756d3214951ec4c7e97d97d203d97dbef79d7fda19260dd8e107b7339d846d15442a16ed2459d3ee85104594bf30ef9aec082bc407db0dabf770cb13f65cbdba76e70922c7bef6362c59fc80949ce7d9362744c5ef31b35189aef8be5acdca2c5630d0b36c5804884fc0f5827390f969081366873895550e5ef0e82b9eb65951d778000a330e3194c8f9f8760736124680b64ae82376e8245dc6a52c348f70707047ec801acee613dc826321cf7be399c6c2efe2f3fd80523450630915846b4b1f409c6629c786e98d35f0fc7e1a816a62ee722c313c88d72c14770f86767afd07db1628b298924f7d1e6fb6a03372460f87fce293ab1b6e0c50abce375e6d257dc17edc2a955339e6d4fda9309e309b1f2b9e9d35744b8003e3945d5d1467a4b6bf791e7218e4bba0ce339c6ebfc4016ae63e6674c7be5dc978290a08f4f716affb3615ca0e7120135937acc9a0b5e398ce3bbf3db2b275da049032ea9e66e3b782e646fdbdb15914c5832bd0a25a6d0158a32e028fc89aa33fb2fc29d6f8cfb3a98eff80dbcdac046c93720fe854e9273d01aa0c4ae930aa312a87b272dc0351862bdbfc193657968cea438ace70d5ebb7ab440132f23c9807c6578b6139577b6089bf5b4a7c8cdc25fdbee69dfa8ecaeae3a7a28773f198292b0ea59234da65d8a450898ca3d913d2963c1cf324a597995654a144129bb631716b4b6d5b6d8af08ccf3ee99a36d6a0d00d2dfe87511b5e02ba24d990270cf8819a771ed282e1e762932d29fed355bb5900992107c58998647ce327deca6f8edc198581d008eef7bcc94e4422e5162140b60d115ce3c7ee1da3a8a2769d893f4f863c11bbb4c569591d9f1e86ac8ca7fba4a32182c227ad1f6861891b0d89fa4fb3630e25b844fe195228b85308437f5837a88715f2cb9061d4b8000559c6cd3e78f26b8a165765edc61e9eced4d00290061df3e6cdf03e381feafa39a22b783b5f1a5014eed3d2eb4f70fc18be3336ee03f928d26ea73ad8db238230805141c010104611b1bd269170cae8b6d493bbb2288ca13eeabd3100001e5d6e58c66704754be022a30f20ad2a09153260f2508c8f045e52b3a8520d86cf8d0eaf119c65c86c19e05117bd7c8c2b01a8fe78afb98efb0fd2f5ac5f0eeff18deb100a7645ab8f847d1d96de3bcea8223f0d3881da12b14ea767d6b15ad3d1f33eb8bf7c3dffb0f430b05470c25ea80b0933240dfe7bbfbd3767ceacec4430b8b51d7fe5c5afb271f4dd9c68c35dab8d49b6961c6255924f086a97d759c62a41111625b6c2ae4331fea540e7c5c95ba470756f6989f333a022cdcd55dbd1f05fc27cff68bc5aed07e3a2f37fd360a452ddf3555b1d2c86a8f8c6d06ed0c880b442a8aade2daf8b853f1a7447abfad5194047ac1436768deaf8b5f1265cf0bf5827fe5fdc314b6768bfcc490c7847a1de34fd40603b110af9c537d5de2d9bdfd12ed8f874e96a3d23749f72a795ffcfdcb3bf0469b756e4a1f3743014ccff1530ea0e7904e54ac5774b30fdaa4d582307ab5db6baf258a4ef88d5cf8e294a1e261967f3a27604463e1f3612a35ebd64104d0fa22f156db0b1995d7333fe3190f9c0ffb110aabec61f094c42124de30bfa166d8be884a7171ec575847b6666abe260e2bab7686ac226fc4ac854d179ddf1f48170785db3ef2fa21a17e8a9db4eaa21888fac829f404a16b097bd856e6bf1873bd7c73b75dfc413449f4c0f5639eaa8fe917ab368adf6c856f915c73065650719b2ec5fb9554b37b99057f6a9526f2b59978c1b56d3973053c71d19305c6ca2d8d730502ffc827d96b0f1c223816bdbb0018a2f4f9e5dba04a37f46f19f8a5dec321967b545d7399d0b6918c7d0fa1bf31b0e39b99c32e5533bd1e2499dae2ae1b2d959c3938fdcc3e39b4546fcc002366877219e177edfd62f7e36e35294885c03bf00b1cb0747c738c590a06c722854d814ab789a4a43662901dac610b95d092f2ce434158fb263384edbf59a3e9d2cec30ee92ab9492bab918b91af9f17ca807f71d4c5be3bcf364108e4d627cfa7ebc57651920ecc15922ef17ac102540b079fe215fd5163653f5b7b6ea6ed73f60bf967106bbc92b3c45e62e5ad90ede233f1f7587e39f508b7fb753c2f4bf27848107f2d0ca317e340e0f6c607fb8dbb9ce76aa8a4238fed6070fe07fc019d3eaa2c467e5d9c283e4ab975bf55cc61447621e30fa9b1476c028e5e68c25abdeadd97e791862cb281862cdd08488563233f8d9f0cbb47288714475f334669a8f84793164754abb59541e7d3b2595354c9f7283c4e56169190a61faeb83f93c149e8c83fd3c58cbfdaab6e304139ff97c5604fa4d714abf41c48d02b4600a4975bd758f60d689f319fdb9b5bb067800250c9b0185cc260993e3e711981</script>
</div>
<script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>Encrypt</category>
      </categories>
      <tags>
        <tag>Encrypt</tag>
      </tags>
  </entry>
  <entry>
    <title>objc-781编译</title>
    <url>/2020/12/04/objc-781%E7%BC%96%E8%AF%91/</url>
    <content><![CDATA[<h4 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">macOS 10.15.7</span><br><span class="line"></span><br><span class="line">Xcode 11.3.1</span><br><span class="line"></span><br><span class="line">objc4-781</span><br></pre></td></tr></table></figure>



<h4 id="Runtime源码下载"><a href="#Runtime源码下载" class="headerlink" title="Runtime源码下载"></a>Runtime源码下载</h4><p><a href="https://opensource.apple.com/">Apple Open Source</a> 选择最新 <code>macOS</code> 系统 <code>10.15.6</code> ，搜索 <code>objc</code> 看到最新 <code>objc4</code>文件为 <code>objc4-787.1</code>，右边可以直接下载压缩包</p>
<p><img src="/2020/12/04/objc-781%E7%BC%96%E8%AF%91/AppleOpenSource.jpg" alt="AppleOpenSource"></p>
<p>可以下载历史版本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">https:&#x2F;&#x2F;opensource.apple.com&#x2F;tarballs&#x2F;objc4&#x2F;</span><br></pre></td></tr></table></figure>



<h4 id="下载依赖文件"><a href="#下载依赖文件" class="headerlink" title="下载依赖文件"></a>下载依赖文件</h4><p><img src="/2020/12/04/objc-781%E7%BC%96%E8%AF%91/%E4%BE%9D%E8%B5%96%E6%96%87%E4%BB%B6.png" alt="依赖文件"></p>
<h4 id="Runtime源码编译"><a href="#Runtime源码编译" class="headerlink" title="Runtime源码编译"></a>Runtime源码编译</h4><p>【1】<code>unable to find sdk macosx.internal</code></p>
<p><img src="/2020/12/04/objc-781%E7%BC%96%E8%AF%91/macosx.jpg" alt="macosx"></p>
<p>修改 <code>Base SDK</code> 选择 <code>macOS</code></p>
<p><img src="/2020/12/04/objc-781%E7%BC%96%E8%AF%91/baseSDK.png" alt="baseSDK"></p>
<p>【2】<code>file not foud</code></p>
<p>【2.1】<code>sys/reason.h file not found objc-os.h</code></p>
<p>根目录创建 <code>Common</code> 文件夹，创建 <code>sys</code> 文件 ，加入文件 <code>xnu-6153141.1/bsd/sys/reason.h</code></p>
<p>设置文件检索路径，<code>Header Search Path</code> 添加 <code>$(SRCROOT)/Common</code></p>
<p><img src="/2020/12/04/objc-781%E7%BC%96%E8%AF%91/searchPath.png" alt="searchPath"></p>
<p>【2.2】其它 <code>file not found</code></p>
<ul>
<li>mach-o/dyld_priv.h file not found`</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dyld-750.6&#x2F;include&#x2F;mach-o&#x2F;dyld_priv.h</span><br></pre></td></tr></table></figure>

<ul>
<li><code>os/lock_private.h file not found</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">libplatform-220.100.1&#x2F;private&#x2F;os&#x2F;lock_private.h</span><br></pre></td></tr></table></figure>

<ul>
<li><code>os/base_private.h file not found</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">libplatform-220.100.1&#x2F;private&#x2F;os&#x2F;base_private.h</span><br></pre></td></tr></table></figure>

<ul>
<li><code>pthread/tsd_private.h file not found</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">libpthread-416.100.3&#x2F;private&#x2F;tsd_private.h</span><br></pre></td></tr></table></figure>

<ul>
<li><code>System/machine/cpu_capabilities.h file not found</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xnu-6153.141.1&#x2F;osfmk&#x2F;machine&#x2F;cpu_capabilities.h</span><br></pre></td></tr></table></figure>

<ul>
<li><code>os/tsd.h file not found</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xnu-6153.141.1&#x2F;libsyscall&#x2F;os&#x2F;tsd.h</span><br></pre></td></tr></table></figure>

<ul>
<li><code>pthread/spinlock_private.h file not found</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">libpthread-416.100.3&#x2F;private&#x2F;spinlock_private.h</span><br></pre></td></tr></table></figure>

<ul>
<li><code>System/pthread_machdep.h file not found</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Libc-583&#x2F;pthreads&#x2F;pthread_machdep.h</span><br></pre></td></tr></table></figure>

<ul>
<li><code>CrashReporterClient.h file not found</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Libc-997.90.3&#x2F;include&#x2F;CrashReporterClient.h</span><br></pre></td></tr></table></figure>

<ul>
<li><code>objc-shared-cache.h file not found</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dyld-750.6&#x2F;include&#x2F;objc-shared-cache.h</span><br></pre></td></tr></table></figure>

<ul>
<li><code>_simple.h file not found</code> </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">libplatform-220.100.1&#x2F;private&#x2F;_simple.h</span><br></pre></td></tr></table></figure>

<ul>
<li><code>kern/restartable.h file not found</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xnu-6153.141.1&#x2F;osfmk&#x2F;kern&#x2F;restartable.h</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Block_private.h file not found</code> </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">libclosure-74&#x2F;Block_private.h</span><br></pre></td></tr></table></figure>



<p>【3】<code>pthread_machdep.h</code> 3处报错</p>
<p>将 193 行</p>
<p> <code>typedef int pthread_lock_t;</code></p>
<p>到 244 行</p>
<p><code>#define _pthread_setspecific_direct(key, val) pthread_setspecific(key, val)</code> 注释</p>
<p>替换为</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#if TARGET_IPHONE_SIMULATOR || defined(__ppc__) || defined(__ppc64__) || \</span><br><span class="line">    (defined(__arm__) &amp;&amp; !defined(_ARM_ARCH_7) &amp;&amp; defined(_ARM_ARCH_6) &amp;&amp; defined(__thumb__))</span><br><span class="line">#define _pthread_getspecific_direct(key) pthread_getspecific((key))</span><br><span class="line">#define _pthread_setspecific_direct(key, val) pthread_setspecific((key), (val))</span><br><span class="line">#else</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>





<p>【4】<code>dyld_priv.h</code> 报错 <code>Expected&#39;,&#39;</code></p>
<p> 删掉 <code>, bridgeos(3.0)</code></p>
<p>【5】<code>lock_private.h</code> 报错 <code>Expected&#39;,&#39;</code></p>
<p>删掉 <code>, bridgeos(4.0)</code></p>
<p>【6】<code>Use of undeclared identifier &#39;DYLD_MACOSX_VERSION_10_11&#39;</code></p>
<p><code>dyld_priv.h</code> 顶部加入宏</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#define DYLD_MACOSX_VERSION_10_11 0x000A0B00</span><br><span class="line">#define DYLD_MACOSX_VERSION_10_12 0x000A0C00</span><br><span class="line">#define DYLD_MACOSX_VERSION_10_13 0x000A0D00</span><br><span class="line">#define DYLD_MACOSX_VERSION_10_14 0x000A0E00</span><br></pre></td></tr></table></figure>



<p>【7】<code>Use of undeclared identifier &#39;CRGetCrashLogMessage&#39;</code></p>
<p><code>target -&gt; Build Setting -&gt; Preprocessor Macros</code></p>
<p> 添加 <code>LIBC_NO_LIBCRASHREPORTERCLIENT</code></p>
<p><img src="/2020/12/04/objc-781%E7%BC%96%E8%AF%91/macros.png" alt="macros"></p>
<p>【8】<code>Mismatch in debug-ness macros</code></p>
<p>注释 <code>#error mismatch in debug-ness macros</code></p>
<p>【9】</p>
<p><code>can&#39;t open order file: /Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX11.0.sdk/AppleInternal/OrderFiles/libobjc.order</code></p>
<p><code>target -&gt; Build Settings</code> 搜索 <code>Order File</code> 添加 <code>$(SRCROOT)/libobjc.order</code></p>
<p>【10】<code>library not found for -lCrashReporterClient</code></p>
<p><code>target -&gt; Build Settings -&gt; Other Linker Flags</code> 删掉  <code>CrashReporterClient</code></p>
<p>【11】<code>SDK &quot;macosx.internal&quot; cannot be located</code></p>
<p><code>target -&gt; objc -&gt; Build Phase -&gt; Run Script(markgc)</code> 将脚本的 <code>macosx.internal</code> 修改为 <code>macosx</code></p>
<p>Build Success</p>
<h4 id="编译调试"><a href="#编译调试" class="headerlink" title="编译调试"></a>编译调试</h4><p>新建 <code>Target</code> 来进行调试</p>
<ul>
<li><code>File -&gt; New -&gt; Target</code> <code>Test</code></li>
</ul>
<p><img src="/2020/12/04/objc-781%E7%BC%96%E8%AF%91/target.png" alt="target"></p>
<ul>
<li>绑定二进制依赖关系</li>
</ul>
<p><code>TARGETS -&gt; Test -&gt; Build Phases</code></p>
<p> <img src="/2020/12/04/objc-781%E7%BC%96%E8%AF%91/depend.png" alt="target"></p>
<p>还需要设置 <code>target -&gt; objc -&gt; Build Settings -&gt; Enable Hardened Runtime -&gt; NO</code></p>
<p>注意 <code>Compile Sources</code> 中 <code>main.m</code> 位置在前面</p>
<p><img src="/2020/12/04/objc-781%E7%BC%96%E8%AF%91/compile.png" alt="compile"></p>
<p><a href="https://opensource.apple.com/release/mac-os-x-1062.html">Libc-583</a></p>
<p><a href="https://opensource.apple.com/release/os-x-1095.html"> Libc-997.90.3</a></p>
<p><a href="https://opensource.apple.com/release/macos-10156.html">dyld-750.6</a></p>
<p><a href="https://opensource.apple.com/release/macos-10156.html">libauto-187</a></p>
<p><a href="https://opensource.apple.com/release/macos-10156.html">libclosure-74</a></p>
<p><a href="https://opensource.apple.com/release/macos-10156.html">libdispatch-1173.100.2</a></p>
<p><a href="https://opensource.apple.com/release/macos-10156.html">xnu-6153.141.1</a></p>
<p><a href="https://opensource.apple.com/release/macos-10156.html">libpthread-416.100.3</a></p>
<p><a href="https://opensource.apple.com/release/macos-10156.html">libplatform-220.100.1</a></p>
<p><a href="https://opensource.apple.com/release/os-x-1095.html">launchd-842.92.1</a></p>
<p><a href="https://www.jianshu.com/p/28150fa0c085">objc4-750编译</a></p>
<p><a href="https://gitee.com/other_other/objc-781.git">objc4-781可编译代码</a></p>
<p><a href="https://github.com/chenjialin1016/objc4-debugTest">xcode12 objc4-781可编译代码</a></p>
]]></content>
  </entry>
  <entry>
    <title>_objc_init</title>
    <url>/2020/12/25/objc-init/</url>
    <content><![CDATA[<h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p>什么时候调用 <code>load</code></p>
<p>子类和父类及分类 <code>load</code> 方法调用顺序</p>
<p>子类和父类及分类 <code>initialize</code> 方法调用顺序</p>
<p><code>load</code> 方法调用是在应用程序 <code>main</code> 函数之前，应用启动时 <code>dyld</code> 处理完 <code>image</code> 镜像文件，通过回调传给 <code>runtime</code> ，交由 <code>runtime</code> 在 <code>load_images</code> 方法中调用</p>
<p>从系统库 <code>libSystem</code> 的 <code>runtime</code> 的入口函数 <code>_objc_init</code> 开始</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> _objc_init(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">bool</span> initialized = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (initialized) <span class="keyword">return</span>;</span><br><span class="line">    initialized = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// fixme defer initialization until an objc-using image is found?</span></span><br><span class="line">    <span class="comment">//读取影响运行时的环境变量</span></span><br><span class="line">    environ_init();</span><br><span class="line">    tls_init();</span><br><span class="line">    <span class="comment">//运行C C++静态构造函数</span></span><br><span class="line">    static_init();</span><br><span class="line">    runtime_init();</span><br><span class="line">    <span class="comment">//初始化libobjc的异常处理系统</span></span><br><span class="line">    exception_init();</span><br><span class="line">    cache_init();</span><br><span class="line">    _imp_implementationWithBlock_init();</span><br><span class="line">		<span class="comment">//注册回调函数</span></span><br><span class="line">    _dyld_objc_notify_register(&amp;map_images, load_images, unmap_image);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __OBJC2__</span></span><br><span class="line">    didCallDyldNotifyRegister = <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="map-images"><a href="#map-images" class="headerlink" title="map_images"></a>map_images</h4><p>主要将 Mach-O 中的类信息加载到内存</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">map_images(<span class="keyword">unsigned</span> count, <span class="keyword">const</span> <span class="keyword">char</span> * <span class="keyword">const</span> paths[],</span><br><span class="line">           <span class="keyword">const</span> struct mach_header * <span class="keyword">const</span> mhdrs[])</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">mutex_locker_t</span> <span class="title">lock</span><span class="params">(runtimeLock)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> map_images_nolock(count, paths, mhdrs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>map_images_nolock</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> </span><br><span class="line">map_images_nolock(<span class="keyword">unsigned</span> mhCount, <span class="keyword">const</span> <span class="keyword">char</span> * <span class="keyword">const</span> mhPaths[],</span><br><span class="line">                  <span class="keyword">const</span> struct mach_header * <span class="keyword">const</span> mhdrs[])</span><br><span class="line">&#123;</span><br><span class="line">		... <span class="comment">//省略代码</span></span><br><span class="line">		<span class="keyword">if</span> (hCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      	<span class="comment">//读取镜像文件</span></span><br><span class="line">        _read_images(hList, hCount, totalClasses, unoptimizedTotalClasses);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="read-images"><a href="#read-images" class="headerlink" title="_read_images"></a>_read_images</h5><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> _read_images(header_info **hList, <span class="keyword">uint32_t</span> hCount, <span class="keyword">int</span> totalClasses, <span class="keyword">int</span> unoptimizedTotalClasses)</span><br><span class="line">&#123;</span><br><span class="line">		...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>_read_images</code> 内部做了几件事情</p>
<p>【1】重新初始化 <code>TaggedPointer</code> 环境，创建 <code>gdb_objc_realized_classes</code> 表</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!doneOnce) &#123;</span><br><span class="line">    doneOnce = YES;</span><br><span class="line">    launchTime = YES;</span><br><span class="line">    <span class="keyword">if</span> (DisableTaggedPointers) &#123;</span><br><span class="line">        disableTaggedPointers();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    initializeTaggedPointerObfuscator();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (PrintConnecting) &#123;</span><br><span class="line">        _objc_inform(<span class="string">&quot;CLASS: found %d classes during launch&quot;</span>, totalClasses);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// namedClasses</span></span><br><span class="line">    <span class="comment">// Preoptimized classes don&#x27;t go in this table.</span></span><br><span class="line">    <span class="comment">// 4/3 is NXMapTable&#x27;s load factor</span></span><br><span class="line">    <span class="keyword">int</span> namedClassesSize = </span><br><span class="line">        (isPreoptimized() ? unoptimizedTotalClasses : totalClasses) * <span class="number">4</span> / <span class="number">3</span>;</span><br><span class="line">    gdb_objc_realized_classes =</span><br><span class="line">        NXCreateMapTable(NXStrValueMapPrototype, namedClassesSize);</span><br><span class="line"></span><br><span class="line">    ts.<span class="built_in">log</span>(<span class="string">&quot;IMAGE TIMES: first time tasks&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>。。。</p>
<h4 id="loadImages"><a href="#loadImages" class="headerlink" title="loadImages"></a>loadImages</h4><p>【1】进入 <code>load_images</code> 方法</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">load_images(<span class="keyword">const</span> <span class="keyword">char</span> *path __unused, <span class="keyword">const</span> struct mach_header *mh)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!didInitialAttachCategories &amp;&amp; didCallDyldNotifyRegister) &#123;</span><br><span class="line">        didInitialAttachCategories = <span class="literal">true</span>;</span><br><span class="line">        loadAllCategories();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Return without taking locks if there are no +load methods here.</span></span><br><span class="line">    <span class="keyword">if</span> (!hasLoadMethods((<span class="keyword">const</span> headerType *)mh)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">recursive_mutex_locker_t</span> <span class="title">lock</span><span class="params">(loadMethodLock)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Discover load methods</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">mutex_locker_t</span> <span class="title">lock2</span><span class="params">(runtimeLock)</span></span>;</span><br><span class="line">        prepare_load_methods((<span class="keyword">const</span> headerType *)mh);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Call +load methods (without runtimeLock - re-entrant)</span></span><br><span class="line">    call_load_methods();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>prepare</code> 加载完所有 <code>load</code>   -&gt;  <code>call_load_methods()</code> 调用 <code>load</code> 方法</p>
<h5 id="prepare-load-methods"><a href="#prepare-load-methods" class="headerlink" title="prepare_load_methods"></a><code>prepare_load_methods</code></h5><p>【2】<code>prepare_load_methods</code> 实现</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">prepare_load_methods</span><span class="params">(<span class="keyword">const</span> headerType *mhdr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> count, i;</span><br><span class="line"></span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line">		<span class="comment">//拿到当前类的列表</span></span><br><span class="line">    <span class="keyword">classref_t</span> <span class="keyword">const</span> *classlist = </span><br><span class="line">        _getObjc2NonlazyClassList(mhdr, &amp;count);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        schedule_class_load(remapClass(classlist[i]));</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">//拿到分类列表</span></span><br><span class="line">    <span class="keyword">category_t</span> * <span class="keyword">const</span> *categorylist = _getObjc2NonlazyCategoryList(mhdr, &amp;count);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        <span class="keyword">category_t</span> *cat = categorylist[i];</span><br><span class="line">        Class cls = remapClass(cat-&gt;cls);</span><br><span class="line">        <span class="keyword">if</span> (!cls) <span class="keyword">continue</span>;  <span class="comment">// category for ignored weak-linked class</span></span><br><span class="line">        <span class="keyword">if</span> (cls-&gt;isSwiftStable()) &#123;</span><br><span class="line">            _objc_fatal(<span class="string">&quot;Swift class extensions and categories on Swift &quot;</span></span><br><span class="line">                        <span class="string">&quot;classes are not allowed to have +load methods&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        realizeClassWithoutSwift(cls, nil);</span><br><span class="line">        ASSERT(cls-&gt;ISA()-&gt;isRealized());</span><br><span class="line">        add_category_to_loadable_list(cat);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>【2.1】进入 <code>schedule_class_load</code> 方法</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">schedule_class_load</span><span class="params">(Class cls)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!cls) <span class="keyword">return</span>;</span><br><span class="line">    ASSERT(cls-&gt;isRealized());  <span class="comment">// _read_images should realize</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cls-&gt;data()-&gt;flags &amp; RW_LOADED) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Ensure superclass-first ordering 递归加载 类 父类</span></span><br><span class="line">    schedule_class_load(cls-&gt;superclass);</span><br><span class="line"></span><br><span class="line">    add_class_to_loadable_list(cls);</span><br><span class="line">    cls-&gt;setInfo(RW_LOADED); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>递归加载类、父类，加载完毕后添加到 <code>loadable_list</code> 表，</p>
<p>继续查看 <code>add_class_to_loadable_list</code> 方法</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_class_to_loadable_list</span><span class="params">(Class cls)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    IMP method;</span><br><span class="line"></span><br><span class="line">    loadMethodLock.assertLocked();</span><br><span class="line"></span><br><span class="line">    method = cls-&gt;getLoadMethod();</span><br><span class="line">    <span class="keyword">if</span> (!method) <span class="keyword">return</span>;  <span class="comment">// Don&#x27;t bother if cls has no +load method</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (PrintLoading) &#123;</span><br><span class="line">        _objc_inform(<span class="string">&quot;LOAD: class &#x27;%s&#x27; scheduled for +load&quot;</span>, </span><br><span class="line">                     cls-&gt;nameForLogging());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (loadable_classes_used == loadable_classes_allocated) &#123;</span><br><span class="line">        loadable_classes_allocated = loadable_classes_allocated*<span class="number">2</span> + <span class="number">16</span>;</span><br><span class="line">        loadable_classes = (struct loadable_class *)</span><br><span class="line">            <span class="built_in">realloc</span>(loadable_classes,</span><br><span class="line">                              loadable_classes_allocated *</span><br><span class="line">                              <span class="keyword">sizeof</span>(struct loadable_class));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    loadable_classes[loadable_classes_used].cls = cls;</span><br><span class="line">    loadable_classes[loadable_classes_used].method = method;</span><br><span class="line">    loadable_classes_used++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">loadable_class</span> &#123;</span></span><br><span class="line">    Class cls;  <span class="comment">// may be nil</span></span><br><span class="line">    IMP method;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>loadable_list</code> 表中存储的结构体 <code>loadable_class</code> ，包含当前类 <code>cls</code> ，和该类的 <code>load</code> 方法 <code>IMP</code></p>
<p><code>method = cls-&gt;getLoadMethod();</code> 就是获取到该类的 <code>load</code> 方法</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">IMP </span><br><span class="line">objc_class::getLoadMethod()</span><br><span class="line">&#123;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">method_list_t</span> *mlist;</span><br><span class="line"></span><br><span class="line">    ASSERT(isRealized());</span><br><span class="line">    ASSERT(ISA()-&gt;isRealized());</span><br><span class="line">    ASSERT(!isMetaClass());</span><br><span class="line">    ASSERT(ISA()-&gt;isMetaClass());</span><br><span class="line"></span><br><span class="line">    mlist = ISA()-&gt;data()-&gt;ro()-&gt;baseMethods();</span><br><span class="line">    <span class="keyword">if</span> (mlist) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span>&amp; meth : *mlist) &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">char</span> *name = sel_cname(meth.name);</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">0</span> == <span class="built_in">strcmp</span>(name, <span class="string">&quot;load&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> meth.imp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> nil;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以 <code>schedule_class_load</code> 就是先获取父类，再递归调用 <code>schedule_class_load</code> 方法，把父类的父类 -&gt; 父类 -&gt; 子类，这些类和的 <code>load</code> 方法加入到 <code>loadable_classes</code> 表中</p>
<p>所以类的 <code>+(load)</code> 方法执行顺序：是从父类到子类</p>
<p>回到【2】在执行 <code>schedule_class_load</code> 添加完类后，继续处理分类，分类调用 <code>_category_getLoadMethod</code> 方法获取到分类中重写的 <code>load</code> 方法，调用 <code>add_category_to_loadable_list</code> 方法，把分类和分类的 <code>load</code> 方法添加到 <code>loadable_categories</code> 表中</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">loadable_category</span> &#123;</span></span><br><span class="line">    Category cat;  <span class="comment">// may be nil</span></span><br><span class="line">    IMP method;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><p>总结 <code>prepare_load_methods</code>：</p>
<p>1、处理类：递归先父类再子类，获取类和类的<code>load</code> 方法，合成结构体 <code>loadable_class</code> ，添加到 <code>loadable_classes</code> 表中</p>
<p>2、处理分类：获取分类<code>load</code> 方法，合成结构体 <code>loadable_category</code> ，添加到 <code>loadable_categories</code> 表中</p>
<h5 id="call-load-methods"><a href="#call-load-methods" class="headerlink" title="call_load_methods"></a>call_load_methods</h5><p>【3】进入 <code>call_load_methods</code> 方法，<code>load</code> 方法的调用部分</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">call_load_methods</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">bool</span> loading = NO;</span><br><span class="line">    <span class="keyword">bool</span> more_categories;</span><br><span class="line"></span><br><span class="line">    loadMethodLock.assertLocked();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Re-entrant calls do nothing; the outermost call will finish the job.</span></span><br><span class="line">    <span class="keyword">if</span> (loading) <span class="keyword">return</span>;</span><br><span class="line">    loading = YES;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> *pool = objc_autoreleasePoolPush();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// 1. Repeatedly call class +loads until there aren&#x27;t any more</span></span><br><span class="line">        <span class="keyword">while</span> (loadable_classes_used &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            call_class_loads();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. Call category +loads ONCE</span></span><br><span class="line">        more_categories = call_category_loads();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. Run more +loads if there are classes OR more untried categories</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (loadable_classes_used &gt; <span class="number">0</span>  ||  more_categories);</span><br><span class="line"></span><br><span class="line">    objc_autoreleasePoolPop(pool);</span><br><span class="line"></span><br><span class="line">    loading = NO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看到有个 <code>do-while</code> 循环，<code>do-while</code> 循环里面会产生很多临时变量和函数，放到自动释放池里面，节省内存</p>
<p><code>do-while</code> 循环体部分可以看到 <code>load</code> 方法的调用是先调用主类，再调用分类的；下面<code>call_class_loads</code> 方法内</p>
<p>部从 <code>loadable_classes</code> 获取到类调用 <code>load</code> 方法也是先父类再子类</p>
<p>【3.1】查看 <code>call_class_loads</code> 方法实现</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">call_class_loads</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Detach current loadable list.</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">loadable_class</span> *<span class="title">classes</span> =</span> loadable_classes;</span><br><span class="line">    <span class="keyword">int</span> used = loadable_classes_used;</span><br><span class="line">    loadable_classes = nil;</span><br><span class="line">    loadable_classes_allocated = <span class="number">0</span>;</span><br><span class="line">    loadable_classes_used = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Call all +loads for the detached list.</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; used; i++) &#123;</span><br><span class="line">        Class cls = classes[i].cls;</span><br><span class="line">        <span class="keyword">load_method_t</span> load_method = (<span class="keyword">load_method_t</span>)classes[i].method;</span><br><span class="line">        <span class="keyword">if</span> (!cls) <span class="keyword">continue</span>; </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (PrintLoading) &#123;</span><br><span class="line">            _objc_inform(<span class="string">&quot;LOAD: +[%s load]\n&quot;</span>, cls-&gt;nameForLogging());</span><br><span class="line">        &#125;</span><br><span class="line">        (*load_method)(cls, @selector(load));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Destroy the detached list.</span></span><br><span class="line">    <span class="keyword">if</span> (classes) <span class="built_in">free</span>(classes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从之前存储好的标 <code>loadable_classes</code> 中取出 <code>Class</code> 和 对应的 <code>load</code> 方法，直接调用</p>
<p>【3.2】<code>call_category_loads</code></p>
<p>从 <code>loadable_categories</code> 表中取出<code>loadable_category</code> ，通过 <code>_category_getClass</code> 获取分类对应的类，直接调用 <code>load</code> 方法</p>
<p><a href="https://www.jianshu.com/p/ea680941e084">深入APP启动之dyld、map_images、load_images</a></p>
]]></content>
  </entry>
  <entry>
    <title>《Flutter实战第二版》九：动画</title>
    <url>/2022/01/18/%E3%80%8AFlutter%E5%AE%9E%E6%88%98%E7%AC%AC%E4%BA%8C%E7%89%88%E3%80%8B%E4%B9%9D%EF%BC%9A%E5%8A%A8%E7%94%BB/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>《Flutter实战第二版》八：事件处理与通知</title>
    <url>/2022/01/18/%E3%80%8AFlutter%E5%AE%9E%E6%88%98%E7%AC%AC%E4%BA%8C%E7%89%88%E3%80%8B%E5%85%AB%EF%BC%9A%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E4%B8%8E%E9%80%9A%E7%9F%A5/</url>
    <content><![CDATA[<h3 id="8-事件处理与通知"><a href="#8-事件处理与通知" class="headerlink" title="8 事件处理与通知"></a>8 事件处理与通知</h3><h4 id="8-1-原始指针事件处理"><a href="#8-1-原始指针事件处理" class="headerlink" title="8.1 原始指针事件处理"></a>8.1 原始指针事件处理</h4><p>Flutter 中可以使用 Listener 来监听原始触摸事件</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Listener(&#123;</span><br><span class="line">  Key key,</span><br><span class="line">  <span class="keyword">this</span>.onPointerDown, <span class="comment">//手指按下回调</span></span><br><span class="line">  <span class="keyword">this</span>.onPointerMove, <span class="comment">//手指移动回调</span></span><br><span class="line">  <span class="keyword">this</span>.onPointerUp,<span class="comment">//手指抬起回调</span></span><br><span class="line">  <span class="keyword">this</span>.onPointerCancel,<span class="comment">//触摸事件取消回调</span></span><br><span class="line">  <span class="keyword">this</span>.behavior = HitTestBehavior.deferToChild, <span class="comment">//先忽略此参数，后面小节会专门介绍</span></span><br><span class="line">  Widget child</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>示例</li>
</ul>
<p>手指在容器上移动时查看手指相对于容器的位置</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_DemoState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">Demo</span>&gt; </span>&#123;</span><br><span class="line">  PointerEvent? _event;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(title: Text(<span class="string">&#x27;标题&#x27;</span>)),</span><br><span class="line">      body: Listener(</span><br><span class="line">        child: Container(</span><br><span class="line">          alignment: Alignment.center,</span><br><span class="line">          color: Colors.blue,</span><br><span class="line">          width: <span class="number">300.0</span>,</span><br><span class="line">          height: <span class="number">150.0</span>,</span><br><span class="line">          child: Text(<span class="string">&#x27;<span class="subst">$&#123;_event?.localPosition ?? <span class="string">&#x27;&#x27;</span>&#125;</span>&#x27;</span>,style: TextStyle(color: Colors.white)),</span><br><span class="line">        ),</span><br><span class="line">        onPointerDown: (PointerDownEvent event) =&gt; setState(() =&gt; _event = event),</span><br><span class="line">        onPointerMove: (PointerMoveEvent event) =&gt; setState(() =&gt; _event = event),</span><br><span class="line">        onPointerUp: (PointerUpEvent event) =&gt; setState(() =&gt; _event = event),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》八：事件处理与通知/WeChat2b7b8f8ebecd7a3a530fce169a8d1389.png" alt="WeChat2b7b8f8ebecd7a3a530fce169a8d1389" style="zoom:80%;" />

<p>PointerEvent 类中包括当前指针的一些信息<br>position：指针相对于全局坐标的偏移<br>localPosition：指针相对于本身布局坐标系的偏移<br>delta：两次指针移动事件（PointerMoveEvent）的距离<br>pressure：按压力度，如果手机不支持压力传感器，则始终为1<br>orientation：指针移动方向，是一个角度值</p>
<ul>
<li>忽略指针事件</li>
</ul>
<p>如果不想让某个子树响应 PointerEvent 的话，可以使用 IgnorePointer 和 AbsorbPointer，两个组件都能阻止子树接收指针事件；不同在于 AbsorbPointer 会参与命中测试（Hit Test）IgnorePointer 不会，意味着 AbsorbPointer 本身是可以接收指针事件的（但其子树不行）</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Listener(</span><br><span class="line">  child: AbsorbPointer(</span><br><span class="line">    child: Listener(</span><br><span class="line">      child: Container(</span><br><span class="line">        color: Colors.red,</span><br><span class="line">        width: <span class="number">200.0</span>,</span><br><span class="line">        height: <span class="number">100.0</span>,</span><br><span class="line">      ),</span><br><span class="line">      onPointerDown: (event)=&gt;<span class="built_in">print</span>(<span class="string">&quot;in&quot;</span>),</span><br><span class="line">    ),</span><br><span class="line">  ),</span><br><span class="line">  onPointerDown: (event)=&gt;<span class="built_in">print</span>(<span class="string">&quot;up&quot;</span>),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>点击 Container 会输出 up，换成 IgnorePointer 两个都不会输出</p>
<h4 id="8-2-手势识别"><a href="#8-2-手势识别" class="headerlink" title="8.2 手势识别"></a>8.2 手势识别</h4><h5 id="8-2-1-GestureDetector"><a href="#8-2-1-GestureDetector" class="headerlink" title="8.2.1 GestureDetector"></a>8.2.1 GestureDetector</h5><p>手势识别的功能性组件，内部封装了 Listener</p>
<ul>
<li>点击、双击、长按</li>
</ul>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_DemoState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">Demo</span>&gt; </span>&#123;</span><br><span class="line">  <span class="built_in">String</span> _operation = <span class="string">&quot;No Gesture detected!&quot;</span>; <span class="comment">//保存事件名</span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(title: Text(<span class="string">&#x27;标题&#x27;</span>)),</span><br><span class="line">      body: GestureDetector(</span><br><span class="line">        child: Container(</span><br><span class="line">          alignment: Alignment.center,</span><br><span class="line">          color: Colors.blue,</span><br><span class="line">          width: <span class="number">200.0</span>,</span><br><span class="line">          height: <span class="number">100.0</span>,</span><br><span class="line">          child: Text( _operation, style: TextStyle(color: Colors.white)),</span><br><span class="line">        ),</span><br><span class="line">        onTap: () =&gt; updateText(<span class="string">&quot;Tap&quot;</span>), <span class="comment">//点击</span></span><br><span class="line">        onDoubleTap: () =&gt; updateText(<span class="string">&quot;DoubleTap&quot;</span>), <span class="comment">//双击</span></span><br><span class="line">        onLongPress: () =&gt; updateText(<span class="string">&quot;LongPress&quot;</span>), <span class="comment">//长按</span></span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> updateText(<span class="built_in">String</span> text) &#123;</span><br><span class="line">    <span class="comment">//更新显示的事件名</span></span><br><span class="line">    setState(() &#123;</span><br><span class="line">      _operation = text;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>拖动、滑动</li>
</ul>
<p>GestureDetector 会将要监听的组件的原点（左上角）作为本次手势的原点</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_DemoState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">Demo</span>&gt; </span>&#123;</span><br><span class="line">  <span class="built_in">double</span> _top = <span class="number">0.0</span>; <span class="comment">//距顶部的偏移</span></span><br><span class="line">  <span class="built_in">double</span> _left = <span class="number">0.0</span>;<span class="comment">//距左边的偏移</span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(title: Text(<span class="string">&#x27;标题&#x27;</span>)),</span><br><span class="line">      body: Stack(</span><br><span class="line">        children: [</span><br><span class="line">          Positioned(</span><br><span class="line">            top: _top,</span><br><span class="line">            left: _left,</span><br><span class="line">            child: GestureDetector(</span><br><span class="line">              child: CircleAvatar(child: Text(<span class="string">&#x27;A&#x27;</span>)),</span><br><span class="line">              <span class="comment">//手指按下时会触发此回调</span></span><br><span class="line">              onPanDown: (DragDownDetails e) &#123;</span><br><span class="line">                <span class="comment">//打印手指按下的位置(相对于屏幕)</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;用户手指按下：<span class="subst">$&#123;e.globalPosition&#125;</span>&quot;</span>);</span><br><span class="line">              &#125;,</span><br><span class="line">              <span class="comment">//手指滑动时会触发此回调</span></span><br><span class="line">              onPanUpdate: (DragUpdateDetails e) &#123;</span><br><span class="line">                <span class="comment">//用户手指滑动时，更新偏移，重新构建</span></span><br><span class="line">                setState(() &#123;</span><br><span class="line">                  _left += e.delta.dx;</span><br><span class="line">                  _top += e.delta.dy;</span><br><span class="line">                &#125;);</span><br><span class="line">              &#125;,</span><br><span class="line">              onPanEnd: (DragEndDetails e)&#123;</span><br><span class="line">                <span class="comment">//打印滑动结束时在x、y轴上的速度</span></span><br><span class="line">                <span class="built_in">print</span>(e.velocity);</span><br><span class="line">              &#125;,</span><br><span class="line">            ),</span><br><span class="line">          ),</span><br><span class="line">        ],</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》八：事件处理与通知/WeChat086c3a31a2342c497e33c9b744b41fc2.png" alt="WeChat086c3a31a2342c497e33c9b744b41fc2" style="zoom:80%;" />

<p>DragDownDetails.globalPosition：用户按下时，按下位置相对于屏幕（非父组件）原点（左上角）的偏移</p>
<p>DragUpdateDetails.delta：屏幕上滑动时，会对次触发 Update 事件，delta 指一次 Update 事件的滑动的偏移量</p>
<p>DragEndDetails.velocity：用户抬起手指时的滑动速度</p>
<ul>
<li>单一方向拖动</li>
</ul>
<p>GestureDetector 可以只识别特定方向的手势事件</p>
<p>改成只能沿垂直方向拖动</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">child: GestureDetector(</span><br><span class="line">    child: CircleAvatar(child: Text(<span class="string">&quot;A&quot;</span>)),</span><br><span class="line">    <span class="comment">//垂直方向拖动事件</span></span><br><span class="line">    onVerticalDragUpdate: (DragUpdateDetails details) &#123;</span><br><span class="line">      setState(() &#123;</span><br><span class="line">        _top += details.delta.dy;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">  ),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>缩放</li>
</ul>
<p>GestureDetector 可以监听缩放事件</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_Scale</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> _Scale(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _ScaleState createState() =&gt; _ScaleState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_ScaleState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">_Scale</span>&gt; </span>&#123;</span><br><span class="line">  <span class="built_in">double</span> _width = <span class="number">200.0</span>; <span class="comment">//通过修改图片宽度来达到缩放效果</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Center(</span><br><span class="line">      child: GestureDetector(</span><br><span class="line">        <span class="comment">//指定宽度，高度自适应</span></span><br><span class="line">        child: Image.asset(<span class="string">&quot;./images/sea.png&quot;</span>, width: _width),</span><br><span class="line">        onScaleUpdate: (ScaleUpdateDetails details) &#123;</span><br><span class="line">          setState(() &#123;</span><br><span class="line">            <span class="comment">//缩放倍数在0.8到10倍之间</span></span><br><span class="line">            _width=<span class="number">200</span>*details.scale.clamp(<span class="number">.8</span>, <span class="number">10.0</span>);</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="8-2-2-GestureRecognizer"><a href="#8-2-2-GestureRecognizer" class="headerlink" title="8.2.2 GestureRecognizer"></a>8.2.2 GestureRecognizer</h5><p>GestureDetector 内部是使用一个或多个 Gesturerecognizer 来识别各种手势的</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    <span class="comment">//用到GestureRecognizer的话一定要调用其dispose方法释放资源</span></span><br><span class="line">    _tapGestureRecognizer.dispose();</span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">Widget _recognizeChild() &#123;</span><br><span class="line"><span class="keyword">return</span> Positioned(</span><br><span class="line">  top: <span class="number">20</span>,</span><br><span class="line">  child: Text.rich(</span><br><span class="line">    TextSpan(</span><br><span class="line">      children: [</span><br><span class="line">        TextSpan(text: <span class="string">&#x27;你好世界&#x27;</span>),</span><br><span class="line">        TextSpan(</span><br><span class="line">          text: <span class="string">&#x27;你好世界&#x27;</span>,</span><br><span class="line">          style: TextStyle(</span><br><span class="line">            fontSize: <span class="number">30.0</span>,</span><br><span class="line">            color: _toggle ? Colors.blue : Colors.red,</span><br><span class="line">          ),</span><br><span class="line">          recognizer: _tapGestureRecognizer</span><br><span class="line">            ..onTap = () &#123;</span><br><span class="line">              setState(() &#123;</span><br><span class="line">                _toggle = !_toggle;</span><br><span class="line">              &#125;);</span><br><span class="line">            &#125;,</span><br><span class="line">        ),</span><br><span class="line">        TextSpan(text: <span class="string">&#x27;你好世界&#x27;</span>),</span><br><span class="line">      ],</span><br><span class="line">    ),</span><br><span class="line">  ),</span><br><span class="line">);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用GestureRecognizer后一定要调用其dispose()方法来释放资源</p>
<h4 id="8-3-Flutter-事件机制"><a href="#8-3-Flutter-事件机制" class="headerlink" title="8.3 Flutter 事件机制"></a>8.3 Flutter 事件机制</h4><h4 id="8-4-手势原理与手势冲突"><a href="#8-4-手势原理与手势冲突" class="headerlink" title="8.4 手势原理与手势冲突"></a>8.4 手势原理与手势冲突</h4><h4 id="8-5-事件总线"><a href="#8-5-事件总线" class="headerlink" title="8.5 事件总线"></a>8.5 事件总线</h4><h4 id="8-6-通知-Notification"><a href="#8-6-通知-Notification" class="headerlink" title="8.6 通知 Notification"></a>8.6 通知 Notification</h4>]]></content>
  </entry>
  <entry>
    <title>《Flutter实战第二版》十三：国际化</title>
    <url>/2022/03/02/%E3%80%8AFlutter%E5%AE%9E%E6%88%98%E7%AC%AC%E4%BA%8C%E7%89%88%E3%80%8B%E5%8D%81%E4%B8%89%EF%BC%9A%E5%9B%BD%E9%99%85%E5%8C%96/</url>
    <content><![CDATA[<h5 id="13-1-2-支持国际化"><a href="#13-1-2-支持国际化" class="headerlink" title="13.1.2 支持国际化"></a>13.1.2 支持国际化</h5><p>pubspec.yaml 添加 flutter_localizations 的依赖包</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">dependencies:</span><br><span class="line">  flutter:</span><br><span class="line">    sdk: flutter</span><br><span class="line">  flutter_localizations:</span><br><span class="line">    sdk: flutter</span><br></pre></td></tr></table></figure>

<p>指定 MaterialApp 的 localizationsDelegates 和 supportedLocales</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter_localizations/flutter_localizations.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  runApp(MyApp());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> MyApp(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> MaterialApp(</span><br><span class="line">      localizationsDelegates: [</span><br><span class="line">        GlobalMaterialLocalizations.delegate,</span><br><span class="line">        GlobalWidgetsLocalizations.delegate,</span><br><span class="line">      ],</span><br><span class="line">      supportedLocales: [</span><br><span class="line">        Locale(<span class="string">&#x27;en&#x27;</span>, <span class="string">&#x27;US&#x27;</span>),<span class="comment">// 美国英语 Locale 包括语言和国家两个标志</span></span><br><span class="line">        Locale(<span class="string">&#x27;zh&#x27;</span>, <span class="string">&#x27;CN&#x27;</span>),<span class="comment">// 中文简体</span></span><br><span class="line">        <span class="comment">//其它Locales</span></span><br><span class="line">      ],</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>与 MaterialApp 类为入口的应用不同，对基于 WidgetsApp 类为入口的应用进行国际化时不需要 GlobalMaterialLocalizations.delegate</p>
<p>GlobalMaterialLocalizations.delegate 为 Material 组件库提供的本地化的字符串和其它值，可以使 Material 组件支持多语言<br>GlobalWidgetsLocalizations.delegate 定义组件默认的文本方向，从左到右或从右到左<br>supportedLocales 应用支持的语言列表</p>
<h5 id="13-1-3-获取当前区域-Locale"><a href="#13-1-3-获取当前区域-Locale" class="headerlink" title="13.1.3 获取当前区域 Locale"></a>13.1.3 获取当前区域 Locale</h5><p>Locale 类是用来标识用户的语言环境的，包括语言和国家两个标志</p>
<p>获取当前区域 Locale</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Locale myLocale = Localizations.localeOf(context);</span><br></pre></td></tr></table></figure>

<h5 id="13-1-4-监听系统语言切换"><a href="#13-1-4-监听系统语言切换" class="headerlink" title="13.1.4 监听系统语言切换"></a>13.1.4 监听系统语言切换</h5><p>当更改系统语言设置时，APP 中的 Localizations 组件会重新构建，Localizations.localeOf(context) 获取的 Locale 就会更新，最终界面会重新 build</p>
<p>可以通过 localeResolutionCallback 或 localeListResolutionCallback 回调来监听 Locale 改变事件</p>
<h4 id="13-3-使用-Intl-包"><a href="#13-3-使用-Intl-包" class="headerlink" title="13.3 使用 Intl 包"></a>13.3 使用 Intl 包</h4><h5 id="13-3-1-添加依赖"><a href="#13-3-1-添加依赖" class="headerlink" title="13.3.1 添加依赖"></a>13.3.1 添加依赖</h5><p>使用 Intl 包可以非常轻松的实现国际化</p>
<p>添加两个依赖</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dependencies:</span><br><span class="line">  intl: ^0.17.0 </span><br><span class="line">dev_dependencies:</span><br><span class="line">  intl_generator:  0.2.1 </span><br></pre></td></tr></table></figure>

<p>intl_generator 组要包含了一些工具，开发阶段主要作用是从代码中提取要国际化的字符串到单独的 arb 文件，和根据 arb 文件生成对应语言的 dart 代码。而 intl 包主要是引用和加载 intl——generator 生成后的 dart 代码</p>
<h5 id="13-3-2-创建必要目录"><a href="#13-3-2-创建必要目录" class="headerlink" title="13.3.2 创建必要目录"></a>13.3.2 创建必要目录</h5><p>根目录创建 l10n-arb 目录，保存接下来通过 intl_generator 命令生成的 arb 文件</p>
<p>lib 目录下创建 l10n 目录，保存从 arb 文件生成的 dart 代码文件</p>
<h5 id="13-3-3-实现-Localizations-和-Delegate-类"><a href="#13-3-3-实现-Localizations-和-Delegate-类" class="headerlink" title="13.3.3 实现 Localizations 和 Delegate 类"></a>13.3.3 实现 Localizations 和 Delegate 类</h5>]]></content>
      <categories>
        <category>Flutter</category>
      </categories>
      <tags>
        <tag>Flutter</tag>
      </tags>
  </entry>
  <entry>
    <title>《Flutter实战第二版》十五：一个完整的Flutter应用</title>
    <url>/2022/01/28/%E3%80%8AFlutter%E5%AE%9E%E6%88%98%E7%AC%AC%E4%BA%8C%E7%89%88%E3%80%8B%E5%8D%81%E4%BA%94%EF%BC%9A%E4%B8%80%E4%B8%AA%E5%AE%8C%E6%95%B4%E7%9A%84Flutter%E5%BA%94%E7%94%A8/</url>
    <content><![CDATA[<h3 id="15-一个完整的-Flutter-应用"><a href="#15-一个完整的-Flutter-应用" class="headerlink" title="15 一个完整的 Flutter 应用"></a>15 一个完整的 Flutter 应用</h3><h4 id="15-1-Github-客户端示例"><a href="#15-1-Github-客户端示例" class="headerlink" title="15.1 Github 客户端示例"></a>15.1 Github 客户端示例</h4><p>需要实现功能：</p>
<p>Github 账号登录、退出登录<br>登录后查看自己项目主页<br>支持换肤<br>支持多语言<br>登录状态持久化</p>
<h4 id="15-2-APP-代码结构"><a href="#15-2-APP-代码结构" class="headerlink" title="15.2 APP 代码结构"></a>15.2 APP 代码结构</h4><img src="《Flutter实战第二版》十五：一个完整的Flutter应用/WeChat3794f9d995c042b43f483a645aedb4d0.png" alt="WeChat3794f9d995c042b43f483a645aedb4d0" style="zoom:76%;" />

<p>l10n-arg 文件夹用于保存各国语言对应的 arb 文件</p>
<img src="《Flutter实战第二版》十五：一个完整的Flutter应用/WeChat34b91b756765ef038ab6c2be2dba0c3a.png" alt="WeChat34b91b756765ef038ab6c2be2dba0c3a"  />

<table>
<thead>
<tr>
<th>文件夹</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>common</td>
<td>一些工具类，如通用方法类、网络接口类、保存全局变量的静态类等</td>
</tr>
<tr>
<td>l10n</td>
<td>国际化相关的类都在此目录下</td>
</tr>
<tr>
<td>models</td>
<td>Json文件对应的Dart Model类会在此目录下</td>
</tr>
<tr>
<td>states</td>
<td>保存APP中需要跨组件共享的状态类</td>
</tr>
<tr>
<td>routes</td>
<td>存放所有路由页面类</td>
</tr>
<tr>
<td>widgets</td>
<td>APP内封装的一些Widget组件都在该目录下</td>
</tr>
</tbody></table>
<h4 id="15-3-Model-类定义"><a href="#15-3-Model-类定义" class="headerlink" title="15.3 Model 类定义"></a>15.3 Model 类定义</h4><ul>
<li>Github 账号信息</li>
</ul>
<p>Github API 接口返回 json 结构如下</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;login&quot;</span>: <span class="string">&quot;octocat&quot;</span>, <span class="comment">//用户登录名</span></span><br><span class="line">  <span class="string">&quot;avatar_url&quot;</span>: <span class="string">&quot;https://github.com/images/error/octocat_happy.gif&quot;</span>, <span class="comment">//用户头像地址</span></span><br><span class="line">  <span class="string">&quot;type&quot;</span>: <span class="string">&quot;User&quot;</span>, <span class="comment">//用户类型，可能是组织</span></span><br><span class="line">  <span class="string">&quot;name?&quot;</span>: <span class="string">&quot;monalisa octocat&quot;</span>, <span class="comment">//用户名字</span></span><br><span class="line">  <span class="string">&quot;company?&quot;</span>: <span class="string">&quot;GitHub&quot;</span>, <span class="comment">//公司</span></span><br><span class="line">  <span class="string">&quot;blog?&quot;</span>: <span class="string">&quot;https://github.com/blog&quot;</span>, <span class="comment">//博客地址</span></span><br><span class="line">  <span class="string">&quot;location?&quot;</span>: <span class="string">&quot;San Francisco&quot;</span>, <span class="comment">// 用户所处地理位置</span></span><br><span class="line">  <span class="string">&quot;email?&quot;</span>: <span class="string">&quot;octocat@github.com&quot;</span>, <span class="comment">// 邮箱</span></span><br><span class="line">  <span class="string">&quot;hireable?&quot;</span>: <span class="keyword">false</span>,</span><br><span class="line">  <span class="string">&quot;bio?&quot;</span>: <span class="string">&quot;There once was...&quot;</span>, <span class="comment">// 用户简介</span></span><br><span class="line">  <span class="string">&quot;public_repos&quot;</span>: <span class="number">2</span>, <span class="comment">// 公开项目数</span></span><br><span class="line">  <span class="string">&quot;followers&quot;</span>: <span class="number">20</span>, <span class="comment">//关注该用户的人数</span></span><br><span class="line">  <span class="string">&quot;following&quot;</span>: <span class="number">0</span>, <span class="comment">// 该用户关注的人数</span></span><br><span class="line">  <span class="string">&quot;created_at&quot;</span>: <span class="string">&quot;2008-01-14T04:33:35Z&quot;</span>, <span class="comment">// 账号创建时间</span></span><br><span class="line">  <span class="string">&quot;updated_at&quot;</span>: <span class="string">&quot;2008-01-14T04:33:35Z&quot;</span>, <span class="comment">// 账号信息更新时间</span></span><br><span class="line">  <span class="string">&quot;total_private_repos&quot;</span>: <span class="number">100</span>, <span class="comment">//该用户总的私有项目数(包括参与的其它组织的私有项目)</span></span><br><span class="line">  <span class="string">&quot;owned_private_repos&quot;</span>: <span class="number">100</span> <span class="comment">//该用户自己的私有项目数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>jsons 目录下创建一个 user.json 文件保存</p>
<ul>
<li>API 缓存策略信息</li>
</ul>
<p>创建 cacheConfig.json 文件缓存策略</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;enable&quot;</span>:<span class="keyword">true</span>, <span class="comment">// 是否启用缓存</span></span><br><span class="line">  <span class="string">&quot;maxAge&quot;</span>:<span class="number">1000</span>, <span class="comment">// 缓存的最长时间，单位（秒）</span></span><br><span class="line">  <span class="string">&quot;maxCount&quot;</span>:<span class="number">100</span> <span class="comment">// 最大缓存数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>用户信息</li>
</ul>
<p>profile.json </p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;user?&quot;</span>:<span class="string">&quot;<span class="subst">$user</span>&quot;</span>, <span class="comment">//Github账号信息，结构见&quot;user.json&quot;</span></span><br><span class="line">  <span class="string">&quot;token?&quot;</span>:<span class="string">&quot;&quot;</span>, <span class="comment">// 登录用户的token(oauth)或密码</span></span><br><span class="line">  <span class="string">&quot;theme&quot;</span>:<span class="number">0</span>, <span class="comment">//主题索引</span></span><br><span class="line">  <span class="string">&quot;cache?&quot;</span>:<span class="string">&quot;<span class="subst">$cacheConfig</span>&quot;</span>, <span class="comment">// 缓存策略信息，结构见&quot;cacheConfig.json&quot;</span></span><br><span class="line">  <span class="string">&quot;lastLogin?&quot;</span>:<span class="string">&quot;&quot;</span>, <span class="comment">//最近一次的注销登录的用户名</span></span><br><span class="line">  <span class="string">&quot;locale?&quot;</span>:<span class="string">&quot;&quot;</span> <span class="comment">// APP语言信息</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>项目信息</li>
</ul>
<p>repo.json 文件保存项目信息</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;id&quot;</span>: <span class="number">1296269</span>,</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Hello-World&quot;</span>, <span class="comment">//项目名称</span></span><br><span class="line">  <span class="string">&quot;full_name&quot;</span>: <span class="string">&quot;octocat/Hello-World&quot;</span>, <span class="comment">//项目完整名称</span></span><br><span class="line">  <span class="string">&quot;owner&quot;</span>: <span class="string">&quot;<span class="subst">$user</span>&quot;</span>, <span class="comment">// 项目拥有者，结构见&quot;user.json&quot;</span></span><br><span class="line">  <span class="string">&quot;parent?&quot;</span>:<span class="string">&quot;<span class="subst">$repo</span>&quot;</span>, <span class="comment">// 如果是fork的项目，则此字段表示fork的父项目信息</span></span><br><span class="line">  <span class="string">&quot;private&quot;</span>: <span class="keyword">false</span>, <span class="comment">// 是否私有项目</span></span><br><span class="line">  <span class="string">&quot;description&quot;</span>: <span class="string">&quot;This your first repo!&quot;</span>, <span class="comment">//项目描述</span></span><br><span class="line">  <span class="string">&quot;fork&quot;</span>: <span class="keyword">false</span>, <span class="comment">// 该项目是否为fork的项目</span></span><br><span class="line">  <span class="string">&quot;language?&quot;</span>: <span class="string">&quot;JavaScript&quot;</span>,<span class="comment">//该项目的主要编程语言</span></span><br><span class="line">  <span class="string">&quot;forks_count&quot;</span>: <span class="number">9</span>, <span class="comment">// fork了该项目的数量</span></span><br><span class="line">  <span class="string">&quot;stargazers_count&quot;</span>: <span class="number">80</span>, <span class="comment">//该项目的star数量</span></span><br><span class="line">  <span class="string">&quot;size&quot;</span>: <span class="number">108</span>, <span class="comment">// 项目占用的存储大小</span></span><br><span class="line">  <span class="string">&quot;default_branch&quot;</span>: <span class="string">&quot;master&quot;</span>, <span class="comment">//项目的默认分支</span></span><br><span class="line">  <span class="string">&quot;open_issues_count&quot;</span>: <span class="number">2</span>, <span class="comment">//该项目当前打开的issue数量</span></span><br><span class="line">  <span class="string">&quot;pushed_at&quot;</span>: <span class="string">&quot;2011-01-26T19:06:43Z&quot;</span>,</span><br><span class="line">  <span class="string">&quot;created_at&quot;</span>: <span class="string">&quot;2011-01-26T19:01:12Z&quot;</span>,</span><br><span class="line">  <span class="string">&quot;updated_at&quot;</span>: <span class="string">&quot;2011-01-26T19:14:43Z&quot;</span>,</span><br><span class="line">  <span class="string">&quot;subscribers_count?&quot;</span>: <span class="number">42</span>, <span class="comment">//订阅（关注）该项目的人数</span></span><br><span class="line">  <span class="string">&quot;license?&quot;</span>: &#123; <span class="comment">// 该项目的开源许可证</span></span><br><span class="line">    <span class="string">&quot;key&quot;</span>: <span class="string">&quot;mit&quot;</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;MIT License&quot;</span>,</span><br><span class="line">    <span class="string">&quot;spdx_id&quot;</span>: <span class="string">&quot;MIT&quot;</span>,</span><br><span class="line">    <span class="string">&quot;url&quot;</span>: <span class="string">&quot;https://api.github.com/licenses/mit&quot;</span>,</span><br><span class="line">    <span class="string">&quot;node_id&quot;</span>: <span class="string">&quot;MDc6TGljZW5zZW1pdA==&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>生成 Dart Model 类</li>
</ul>
<p>添加包 </p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">json_model: ^<span class="number">1.0</span><span class="number">.0</span></span><br><span class="line">json_serializable: ^<span class="number">6.1</span><span class="number">.4</span></span><br></pre></td></tr></table></figure>

<p>根目录运行 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">flutter packages pub run json_model</span><br></pre></td></tr></table></figure>

<p>执行后在 lib/models 文件夹下会生成相应的 Dart Model 类</p>
<img src="《Flutter实战第二版》十五：一个完整的Flutter应用/WeChatd1808cadb57d89cee1dc0a463410b7be.png" alt="WeChatd1808cadb57d89cee1dc0a463410b7be" style="zoom:80%;" />

<ul>
<li>数据持久化</li>
</ul>
<p>使用 shared_preferences 包来对登录用户的 profile 信息进行持久化，shared_preferences 是一个 Flutter 插件，通过 Android 和 iOS 平台提供的机制来实现数据持久化</p>
<h4 id="15-4-全局变量及共享状态"><a href="#15-4-全局变量及共享状态" class="headerlink" title="15.4 全局变量及共享状态"></a>15.4 全局变量及共享状态</h4><p>全局变量：单纯指会贯穿整个APP生命周期的变量，单纯保存一些信息或者封装一些全局工具和方法的对象</p>
<p>共享状态：指那些需要跨组件或跨路由共享的信息</p>
<p>区别在于共享状态发生改变时需要通知所有使用该状态的组件，全局变量不需要</p>
]]></content>
      <categories>
        <category>Flutter</category>
      </categories>
      <tags>
        <tag>Flutter</tag>
      </tags>
  </entry>
  <entry>
    <title>事件传递和响应</title>
    <url>/2021/07/20/%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E5%92%8C%E5%93%8D%E5%BA%94/</url>
    <content><![CDATA[<h4 id="1、事件的传递"><a href="#1、事件的传递" class="headerlink" title="1、事件的传递"></a>1、事件的传递</h4><h5 id="1-1-事件传递流程"><a href="#1-1-事件传递流程" class="headerlink" title="1.1 事件传递流程"></a>1.1 事件传递流程</h5><p>事件发生后，系统会将事件加入到一个由 UIApplication 管理的事件队列中<br>UIApplication 会从事件队列中取出最前面的事件，分发下去，首先传给 UIWindow<br>UIWindow 会在视图层次结构中找到一个最合适的视图来处理事件</p>
<p>触摸事件的传递是从父控件传递到子控件<br>UIApplication -&gt; Window -&gt; 寻找最合适的视图来处理事件</p>
<h5 id="1-2-寻找最合适的视图"><a href="#1-2-寻找最合适的视图" class="headerlink" title="1.2 寻找最合适的视图"></a>1.2 寻找最合适的视图</h5><p>内部通过调用 <code>hitTest:withEvent</code> 方法找最终响应视图</p>
<p><code>hitTest:withEvent</code> 底层实现：</p>
<ol>
<li>判断当前控件能不能接收事件</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">if(self.userInteractionEnabled &#x3D;&#x3D; NO || self.hidden &#x3D;&#x3D; YES || self.alpha &lt;&#x3D; 0.01)</span><br><span class="line">return  nil;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>判断触摸点在不在当前的控件上</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">if(![self pointInside:point withEvent:event]) return nil;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>从后往前遍历自己的子控件（最后添加的子视图先遍历）</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">int count &#x3D; (int)self.subviews.count;</span><br><span class="line">for (int i &#x3D; count - 1; i &gt;&#x3D; 0;i-- ) &#123;</span><br><span class="line">	UIView *childV &#x3D; self.subviews[i];</span><br><span class="line">	&#x2F;&#x2F;把当前坐标系上的点转换成子控件坐标系上的点.</span><br><span class="line">	CGPoint childP &#x3D; [self convertPoint:point toView:childV];</span><br><span class="line">	&#x2F;&#x2F;判断自己的子控件是不是最适合的View 对子view进行 hitTest</span><br><span class="line">	UIView *fitView &#x3D; [childV hitTest:childP withEvent:event];</span><br><span class="line">	&#x2F;&#x2F;如果子控件是最适合的View,直接返回</span><br><span class="line">  if (fitView) &#123;</span><br><span class="line">    return fitView;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>如果没有找到最合适的view，自己就是最合适的view</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">return self</span><br></pre></td></tr></table></figure>

<h5 id="1-3-应用"><a href="#1-3-应用" class="headerlink" title="1.3 应用"></a>1.3 应用</h5><ol>
<li>扩大button的响应区域</li>
<li>子view超出了父view的bounds响应事件</li>
<li>使部分区域失去响应</li>
<li>让非scrollView区域响应scrollView拖拽事件</li>
</ol>
<p>button被view遮住了，要让button接收事件</p>
<p><img src="/2021/07/20/%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E5%92%8C%E5%93%8D%E5%BA%94/button.png" alt="button"></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- (UIView *)hitTest:(CGPoint)point withEvent:(UIEvent *)event&#123;</span><br><span class="line">    &#x2F;&#x2F;return [super hitTest:point withEvent:event];</span><br><span class="line">    &#x2F;&#x2F;拿到后面的按钮</span><br><span class="line">    &#x2F;&#x2F;当点在按钮上的时候,才返回按钮,如果不在按钮上.保持系统默认做法</span><br><span class="line">    &#x2F;&#x2F;判断点在不在按钮身上</span><br><span class="line">    &#x2F;&#x2F;把当前的点转换到按钮身上的坐标系的点</span><br><span class="line">    CGPoint btnP &#x3D; [self convertPoint:point toView:self.btn];</span><br><span class="line">    if ([self.btn pointInside:btnP withEvent:event]) &#123;</span><br><span class="line">        return self.btn;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        return [super hitTest:point withEvent:event];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="2、事件响应"><a href="#2、事件响应" class="headerlink" title="2、事件响应"></a>2、事件响应</h4><p>传递链是用来获取第一响应者，接下来开始响应事件</p>
<p>响应链条：firstView -&gt; super view -&gt; … -&gt; viewcontroller -&gt;window -&gt; application -&gt; appdelegate</p>
<p>找到最合适的视图后，事件会从视图开始，沿着响应链 nextResponder 传递，直到找到处理事件的视图，没有处理的事件会被丢弃</p>
<p>如果有父视图，则 nextResponder指向父视图</p>
<p>响应链传递</p>
<p><img src="/2021/07/20/%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E5%92%8C%E5%93%8D%E5%BA%94/%E5%93%8D%E5%BA%94%E9%93%BE%E4%BC%A0%E9%80%92.png" alt="响应链传递"></p>
<h5 id="2-1-系统响应"><a href="#2-1-系统响应" class="headerlink" title="2.1 系统响应"></a>2.1 系统响应</h5><p>屏幕点击后，将事件交由 IOKit 处理</p>
<p>IOKit 将事件封装成一个 IOHIDEvent 对象，通过 mach port 传递给 SpringBoard 进程</p>
<p>SpringBoard 接收到触摸事件，触发主线程 RunLoop 的 source1回调</p>
<p>如果此时在桌面，则交给桌面系统消耗该事件</p>
<p>如果此时在 APP，通过 IPC（进程通信）传给 APP 进程</p>
<h5 id="2-2-APP响应"><a href="#2-2-APP响应" class="headerlink" title="2.2 APP响应"></a>2.2 APP响应</h5><p>APP 进程的 mach port 接收到 SpringBoard 触摸事件，主线程 RunLoop 被唤醒，触发 source1 回调</p>
<p>source1 内部触发了 source0 回调，将接收的 IOHIDEvent 对象封装成 UIEvent 对象</p>
<p>source0 将事件添加到 UIApplication 对象的事件队列中，开始寻找最佳响应者</p>
<h5 id="2-3-应用"><a href="#2-3-应用" class="headerlink" title="2.3 应用"></a>2.3 应用</h5><ul>
<li>利用响应链获取 view 的控制器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">extension UIView &#123;</span><br><span class="line">    var viewController: UIViewController? &#123;</span><br><span class="line">        var next &#x3D; next</span><br><span class="line">        var current: UIViewController?</span><br><span class="line">        while next !&#x3D; nil &#123;</span><br><span class="line">            if next is UIViewController &#123;</span><br><span class="line">                return next as? UIViewController</span><br><span class="line">            &#125;</span><br><span class="line">            next &#x3D; next?.next</span><br><span class="line">        &#125;</span><br><span class="line">        return current</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3、面试题"><a href="#3、面试题" class="headerlink" title="3、面试题"></a>3、面试题</h4><ul>
<li>APP 中间有个 button，在你手触摸屏幕点击后，到这个 button 收到点击事件，中间发生了什么？</li>
</ul>
<ol>
<li>设备将 touch 到的 UITouch 和 UIEvent 对象打包，放到当前活动的 Application 的事件队列中</li>
<li>UIApplication 会从事件队列中取出触摸事件并传递给 UIWindow</li>
<li>UIWindow 使用 hitTest:withEvent 方法查找操作所在视图</li>
</ol>
]]></content>
  </entry>
  <entry>
    <title>二进制重排</title>
    <url>/2021/07/30/%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%87%8D%E6%8E%92/</url>
    <content><![CDATA[<p><a href="https://mp.weixin.qq.com/s/Drmmx5JtjG3UtTFksL6Q8Q">抖音二进制重排</a></p>
]]></content>
  </entry>
  <entry>
    <title>内存管理</title>
    <url>/2021/07/23/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/</url>
    <content><![CDATA[<h4 id="内存分布"><a href="#内存分布" class="headerlink" title="内存分布"></a>内存分布</h4><p>iOS 中的内存区域从低地址到高地址：.text 段（代码区）、.data 段（已初始化全局变量、静态变量）、.bss 段（未初始化全局变量、静态变量）、堆区、栈区</p>
<img src="内存分布.png" alt="内存分布" style="zoom:40%;" />

<p>堆区：</p>
<p>低地址向高地址拓展数据结构，不连续的内存区域，先进先出，由程序员动态分配和释放，通过 alloc 分配的对象</p>
<p>缺点：手动管理，速度慢，容易产生内存碎片</p>
<p>栈区：</p>
<p>高地址向低地址拓展的数据结构，连续内存区域，后进先出，一般运行时分配，编译器自动分配并释放</p>
<p>由编译器自动分配并释放，不会产生内存碎片，速度快，缺点：内存大小限制不灵活</p>
<h4 id="TaggedPointer"><a href="#TaggedPointer" class="headerlink" title="TaggedPointer"></a>TaggedPointer</h4><p>普通对象的查找过程：从栈中找到指针，然后去堆中寻找指针对应的内存空间，进而读取值</p>
<p>64 bit 开始，引入了 TaggedPointer 技术，用于优化 NSNumber、NSDate、NSString 等小对象存储</p>
<p>TaggedPointer 通过在其最后一个 bit 位设置一个特殊标记，用于将数据直接保存到指针本身</p>
<p>TaggedPointer 指针的值不再是堆区地址，而是真正的值。所以实际上它不再是一个对象了，内存并不存储在堆中</p>
<p>将对象的指针拆分成两部分，一部分直接保存数据，另一部分作为特殊标记，表示这是一个特殊指针，不指向任何一个地址</p>
<ul>
<li>引入 TaggedPointer 对象之后，64 位 CPU 下 NSNumber 的内存变成这样</li>
</ul>
<img src="nsnumber.png" alt="nsnumber" style="zoom:60%;" />



<ul>
<li>执行以下代码，有什么区别</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dispatch_queue_t queue &#x3D; dispatch_get_global_queue(0, 0);</span><br><span class="line">for (int i &#x3D; 0; i &lt; 1000; i++) &#123;</span><br><span class="line">    dispatch_async(queue, ^&#123;</span><br><span class="line">        self.name &#x3D; [NSString stringWithFormat:@&quot;abcdefghij&quot;];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dispatch_queue_t queue &#x3D; dispatch_get_global_queue(0, 0);</span><br><span class="line">for (int i &#x3D; 0; i &lt; 1000; i++) &#123;</span><br><span class="line">    dispatch_async(queue, ^&#123;</span><br><span class="line">        self.name &#x3D; [NSString stringWithFormat:@&quot;abc&quot;];</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一个会 Crash，第二个正常运行</p>
<p>第一个多线程同时访问 name 的 setter 方法，有可能多条线程同时执行 [_name release]，连续 release 两次造成对象的过度释放，导致 Crash</p>
<p>第二个 name 指针为 TaggedPointer 类型，不存在 release 操作</p>
<p>两个 name 的底层类型不一致，第一个 name 类型是 NSCFString 类型，存储在堆上，第二个 name 类型是NSTaggedPointerString 存储在常量区</p>
<p>NSString 对于那些所需内存小于 60 位的字符串，它可以创建一个 TaggedPointer，其余则被放置在真正的 NSString 对象里，这使得常用短字符串的性能得到提升</p>
<h4 id="NONPOINTER-ISA"><a href="#NONPOINTER-ISA" class="headerlink" title="NONPOINTER_ISA"></a>NONPOINTER_ISA</h4><p>和 TaggedPointer 设计思想类似，ISA 其实并不单单是一个指针，其中一些位仍旧编码指向对象的类，一部分额外空间存储其它内容</p>
<p>ISA 指针第 1 位表示使用优化的 ISA 指针</p>
<p>64 位架构下，ISA 指针本身占 64 位，64 位存储一个内存地址显然浪费，为了提高内存利用率，剩余比特位中存储了内存管理相关的内容</p>
<ul>
<li>nonpointer：表示是否对isa开启指针优化 。0代表是纯isa指针，1代表除了地址外，还包含了类的一些信息、对象的引用计数等</li>
<li>has_assoc：关联对象标志位</li>
<li>该对象是否有C++或Objc的析构器，如果有析构函数，则需要做一些析构的逻辑处理，如果没有，则可以更快的释放对象</li>
<li>shiftcls：存在类指针的值，开启指针优化的情况下，arm64位中有33位来存储类的指针</li>
<li>magic：判断当前对象是真的对象还是一段没有初始化的空间</li>
<li>weakly_referenced：是否被指向或者曾经指向一个ARC的弱变量，没有弱引用的对象释放的更快</li>
<li>deallocating：是否正在释放</li>
<li>has_sidetable_rc：当对象引用计数大于10时，则需要进位</li>
<li>extra_rc：表示该对象的引用计数值，实际上是引用计数减一。例如：如果引用计数为10，那么extra_rc为9。如果引用计数大于10，则需要使用has_sidetable_rc</li>
</ul>
<h4 id="散列表"><a href="#散列表" class="headerlink" title="散列表"></a>散列表</h4><p>当引用计数存储到一定值，并不会存储到 Nonpointer_isa 位域的 extra_rc 中，而是会存储到 SideTable 散列表中</p>
<p>在 runtime 内存空间中，SideTable 是一个 hash 数组，里面存储了 SideTable</p>
<p>SideTable 的 hash 键就是一个对象 obj 的 address，因此可以说，一个 obj，对应了一个 SideTable，但一个 SideTable 会对应多个 obj，因为SideTable 的数量有限，所有会有很多 obj 公用一个 SideTable</p>
<p>SideTable结构中包含了自旋锁、引用计数表、弱引用表</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">struct SideTable &#123;</span><br><span class="line">    spinlock_t slock;       &#x2F;&#x2F; 自旋锁</span><br><span class="line">    RefcountMap refcnts;    &#x2F;&#x2F;引用计数的Map表 key-value</span><br><span class="line">    weak_table_t weak_table;&#x2F;&#x2F;弱引用表</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>为什么不直接用一张SideTable，而是用SideTables去管理多个 SideTable</li>
</ul>
<p>SideTable 里有一个自旋锁，如果把所有的类都放在同一个 SideTable，有任何一个类有改动都会对整个 table 做操作，并且在操作一个类的同时，操作别的类会被锁住等待，这样会导致操作效率和查询效率都很低。而有多个SideTable 的话，操作的都是单个 Table，并不会影响其他的 table，这就是分离锁</p>
<h5 id="retain"><a href="#retain" class="headerlink" title="retain"></a>retain</h5><p>retain 底层先判断是否是 Nonpointer_isa，如果不是，则直接操作散列表进行 +1 操作<br>如果是 Nonpointer_isa，extra_rc 引用计数+1，extra_rc只有8位，如果出现上溢出，需要借助散列表存储，一半存储在散列表中，另一半还是存储在 extra_rc 中</p>
<h5 id="release"><a href="#release" class="headerlink" title="release"></a>release</h5><p>release 底层先判断是否是 Nonpointer_isa，如果不是，则直接操作散列表进行 -1 操作<br>如果是 Nonpointer_isa，extra_rc 引用计数-1，如果引用计数出现下溢出，看散列表中是否存储引用计数，从散列表中取一半进行 -1 操作，然后存储到 extra_rc 中，如果还是下溢出，就调用 dealloc</p>
<p><a href="https://www.infoq.cn/article/deep-understanding-of-tagged-pointer/">深入理解 TaggedPointer</a></p>
]]></content>
  </entry>
  <entry>
    <title>对象和方法底层原理</title>
    <url>/2020/12/01/%E5%AF%B9%E8%B1%A1%E5%92%8C%E6%96%B9%E6%B3%95%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/</url>
    <content><![CDATA[<h4 id="isa指针"><a href="#isa指针" class="headerlink" title="isa指针"></a>isa指针</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">LGPerson *p  &#x3D; [LGPerson alloc];</span><br><span class="line">p.name &#x3D; @&quot;aa&quot;;</span><br><span class="line"></span><br><span class="line">Class cls1 &#x3D; [LGPerson class];</span><br><span class="line">Class cls2 &#x3D; p.class;</span><br><span class="line">Class cls3 &#x3D; object_getClass(p);</span><br><span class="line"></span><br><span class="line">NSLog(@&quot;%p %p %p&quot;, cls1, cls2, cls3); &#x2F;&#x2F;打印结果相同 只有一个类对象</span><br><span class="line"></span><br><span class="line">Class cls4 &#x3D; objcet_getClass(cls3);</span><br></pre></td></tr></table></figure>

<p>实例对象   – <code>p</code><br>类对象       – <code>cls1</code><br>元类对象   – <code>cls4</code></p>
<p>实例对象所属的类  -&gt; 类对象（<code>class</code>）<br>类对象所属的类      -&gt; 元类    （<code>meta-class</code>）<br>元类所属                  -&gt; 根元类（基类的<code>meta-class</code>）<br>根元类所属              -&gt; 自己</p>
<ul>
<li><p>根元类的父类是<code>NSObject</code> ，<code>NSObject</code> 的父类是 <code>nil</code></p>
</li>
<li><p><code>Class</code> 的 <code>superclass</code> 指向父类的 <code>class</code>，如果没有父类，<code>superclasss</code> 指针为 <code>nil</code></p>
</li>
<li><p><code>meta-class</code> 的 <code>superclass</code> 指向父类的 <code>meta-class</code>，基类的 <code>meta-class</code> 的 <code>superclass</code> 指向基类的 <code>class</code></p>
</li>
</ul>
<h4 id="实例对象调用对象方法"><a href="#实例对象调用对象方法" class="headerlink" title="实例对象调用对象方法"></a>实例对象调用对象方法</h4><p><img src="/2020/12/01/%E5%AF%B9%E8%B1%A1%E5%92%8C%E6%96%B9%E6%B3%95%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/%E5%AE%9E%E4%BE%8B%E5%AF%B9%E8%B1%A1%E8%B0%83%E7%94%A8%E5%AF%B9%E8%B1%A1%E6%96%B9%E6%B3%95.png" alt="实例对象调用对象方法"></p>
<p>对于 <code>student</code> 来说，并不知道 <code>abc</code> 方法在哪里，唯一知道的就是可以去它的 <code>class对象</code> 里找</p>
<p>先通过 <code>isa</code> 指针进入 <code>Student</code> 类的 <code>class对象</code>，如果在其中找到了 <code>abc</code> 就直接进行调动，调用过程结束</p>
<p>没有找到的话，就通过<code> class对象</code>的 <code>superclass</code> 指针进入 <code>Student</code> 类的父类，也就是 <code>Person</code>类的 <code>class对象</code>，重复上一步的查找逻辑</p>
<p>一层层往上找，最终到基类，也就是 <code>NSObject</code> 类的 <code>class对象</code>，还没找到的话，由于它的 <code>superclass</code> 为 nil，最终就会报错 <code>[ERROR: unrecognized selector sent to instance]</code>，调用结束</p>
<h4 id="类对象调用类方法"><a href="#类对象调用类方法" class="headerlink" title="类对象调用类方法"></a>类对象调用类方法</h4><p><img src="/2020/12/01/%E5%AF%B9%E8%B1%A1%E5%92%8C%E6%96%B9%E6%B3%95%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/%E7%B1%BB%E5%AF%B9%E8%B1%A1%E8%B0%83%E7%94%A8%E7%B1%BB%E6%96%B9%E6%B3%95.png" alt="类对象调用类方法"></p>
<p>对于<code> Student</code>类来说，并不知道 <code>abc</code> 方法在哪里，我们知道类方法放在 <code>meta-class</code>对象里面</p>
<p>首先通过 <code>Student</code> 的 <code>class对象</code> 的 <code>isa</code> 指针找到其 <code>meta-class</code>对象，然后在方法列表里找是否有<code>abc</code>，如果有的话就调用，调用结束</p>
<p>如果没有的话，就通过 <code>meta-class</code> 对象的 <code>superclass</code> 指针找到 <code>Student</code> 的父类 <code>Person</code> 的<code>meta-class</code>对象，然后查找<code>abc</code>方法，如果有的话就调用，调用结束</p>
<p>没有的话，通过<code>meta-class</code>对象的<code>superclass</code>指针一层层往上查找</p>
<p>如果到了基类<code>（NSObject）</code>的<code>meta-class</code>还没找到<code>abc</code>，接下来 <code>superclass</code> 指针会找到 <code>NSObject</code> 的<code>class对象</code>，此时会继续在 <code>NSObject</code> 的 <code>class对象</code> 里面，寻找 <code>abc</code>，如果找到就会调用</p>
<p>如果没有找到，由于此时 <code>superclass</code> 是 <code>nil</code> ，最终系统会报错</p>
<h4 id="验证isa指针指向"><a href="#验证isa指针指向" class="headerlink" title="验证isa指针指向"></a>验证isa指针指向</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">LGPerson *person &#x3D; [[LGPerson alloc] init];</span><br><span class="line">Class personClass &#x3D; [LGPerson class];</span><br><span class="line">Class personMetaClass &#x3D; object_getClass(personClass);</span><br><span class="line">NSLog(@&quot;%p %p %p&quot;, person, personClass, personMetaClass);</span><br></pre></td></tr></table></figure>

<p>打断点，LLDB调试打印 <code>person</code> 对象的 <code>isa</code> 指针</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(lldb) p&#x2F;x person-&gt;isa</span><br><span class="line">(Class) $1 &#x3D; 0x000001a1044bd715 LGPerson</span><br><span class="line">(lldb) p&#x2F;x personClass</span><br><span class="line">(Class) $2 &#x3D; 0x00000001044bd710 LGPerson</span><br></pre></td></tr></table></figure>

<p>通过 <code>p/x</code> 命令打印指针，<code>/</code>后面是打印参数，<code>x</code> 表示用 16 进制输出</p>
<p>可以看到输出结果并不相等</p>
<p>实例对象 <code>person 的 isa = 0x000001a1044bd715</code></p>
<p>类对象 <code>personClass = 0x00000001044bd710</code></p>
<p>从 64bit 开始，<code>isa</code> 需要进行一次位运算，才能计算出 <code>class对象</code> 的地址，系统提供了 <code>ISA_MASK</code>，在 <a href="https://opensource.apple.com/tarballs/objc4/">objc4</a> 的源码中可以找到</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">objc_object::ISA() </span><br><span class="line">&#123;</span><br><span class="line">    assert(!isTaggedPointer()); </span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> SUPPORT_INDEXED_ISA</span></span><br><span class="line">    <span class="keyword">if</span> (isa.nonpointer) &#123;</span><br><span class="line">        <span class="keyword">uintptr_t</span> slot = isa.indexcls;</span><br><span class="line">        <span class="keyword">return</span> classForIndex((<span class="keyword">unsigned</span>)slot);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (Class)isa.bits;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="keyword">return</span> (Class)(isa.bits &amp; ISA_MASK);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">if</span> __arm64__</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MASK        0x0000000ffffffff8ULL</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">elif</span> __x86_64__</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MASK        0x00007ffffffffff8ULL</span></span><br></pre></td></tr></table></figure>

<p>验证结果，通过和 <code>ISA_MASK</code>进行一次 <code>&amp;</code> 运算，得到了类对象 <code>personClass</code> 的地址</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(lldb) p&#x2F;x 0x000001a1044bd715 &amp; 0x0000000ffffffff8ULL</span><br><span class="line">(unsigned long long) $4 &#x3D; 0x00000001044bd710</span><br></pre></td></tr></table></figure>

<h4 id="objc-class"><a href="#objc-class" class="headerlink" title="objc_class"></a>objc_class</h4><p>查看源码</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">objc_class</span> :</span> objc_object &#123;</span><br><span class="line">    <span class="comment">// Class ISA;			//isa占8字节</span></span><br><span class="line">    Class superclass; <span class="comment">//8字节</span></span><br><span class="line">    <span class="keyword">cache_t</span> cache;    <span class="comment">//16字节         // formerly cache pointer and vtable</span></span><br><span class="line">    <span class="keyword">class_data_bits_t</span> bits;    <span class="comment">// class_rw_t * plus custom rr/alloc flags</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">class_rw_t</span> *<span class="title">data</span><span class="params">()</span> </span>&#123; </span><br><span class="line">        <span class="keyword">return</span> bits.data();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看到 <code>class_rw_t</code> 看字面意思是可读可写的表，进入查看</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">class_rw_t</span> &#123;</span></span><br><span class="line">    <span class="comment">// Be warned that Symbolication knows the layout of this structure.</span></span><br><span class="line">    <span class="keyword">uint32_t</span> flags;</span><br><span class="line">    <span class="keyword">uint32_t</span> version;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">class_ro_t</span> *ro;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">method_array_t</span> methods;				<span class="comment">//方法列表</span></span><br><span class="line">    <span class="keyword">property_array_t</span> properties;  <span class="comment">//属性列表</span></span><br><span class="line">    <span class="keyword">protocol_array_t</span> protocols;   <span class="comment">//协议列表</span></span><br></pre></td></tr></table></figure>

<p>方法、属性、协议信息都放在这里，还有一个 <code>class_ro_t</code> 只读表，进入查看哪些是只读的</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">class_ro_t</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> flags;</span><br><span class="line">    <span class="keyword">uint32_t</span> instanceStart;</span><br><span class="line">    <span class="keyword">uint32_t</span> instanceSize;	<span class="comment">//实例对象size</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __LP64__</span></span><br><span class="line">    <span class="keyword">uint32_t</span> reserved;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">uint8_t</span> * ivarLayout;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> * name;			<span class="comment">//类名</span></span><br><span class="line">    <span class="keyword">method_list_t</span> * baseMethodList;</span><br><span class="line">    <span class="keyword">protocol_list_t</span> * baseProtocols; <span class="comment">//成员变量描述信息，如名称，类型等</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">ivar_list_t</span> * ivars;</span><br></pre></td></tr></table></figure>

<h4 id="通过MachO文件查找类和方法列表"><a href="#通过MachO文件查找类和方法列表" class="headerlink" title="通过MachO文件查找类和方法列表"></a>通过MachO文件查找类和方法列表</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">   Person *p &#x3D; [[Person alloc] init];</span><br><span class="line">   p.name &#x3D; @&quot;pname&quot;;</span><br><span class="line">   p.age  &#x3D; 20;</span><br><span class="line">   NSLog(@&quot;%p&quot;, [p class]); &#x2F;&#x2F;0x100cc9718</span><br><span class="line">-&gt; NSLog(@&quot;end&quot;);</span><br><span class="line">   </span><br></pre></td></tr></table></figure>

<p><code>image list</code> 查看偏移量</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(lldb) image list</span><br><span class="line">[  0] E4FC76C2-878C-31CA-AB74-26EF8D1204D5 0x0000000100cc0000 &#x2F;</span><br><span class="line">xxx&#x2F;Build&#x2F;Products&#x2F;Debug-iphoneos&#x2F;Test.app&#x2F;Test </span><br></pre></td></tr></table></figure>

<p>计算内存地址</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(lldb) p&#x2F;x 0x100cc9718-0x0000000100cc0000</span><br><span class="line">(long) $0 &#x3D; 0x0000000000009718</span><br></pre></td></tr></table></figure>

<p>将<code>Products/Debug-iphoneos/Test.app/Test</code> 目录下的可执行文件拖入到 <code>MachOView</code></p>
<p><img src="/2020/12/01/%E5%AF%B9%E8%B1%A1%E5%92%8C%E6%96%B9%E6%B3%95%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/MachOView.jpg" alt="MachOView"></p>
<h4 id="isKindOfClass-isMemberOfClass"><a href="#isKindOfClass-isMemberOfClass" class="headerlink" title="isKindOfClass isMemberOfClass"></a>isKindOfClass isMemberOfClass</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">BOOL re1 &#x3D; [(id)[NSObject class] isKindOfClass:[NSObject class]];</span><br><span class="line">BOOL re2 &#x3D; [(id)[LGPerson class] isKindOfClass:[LGPerson class]];</span><br><span class="line">BOOL re3 &#x3D; [(id)[NSObject class] isMemberOfClass:[NSObject class]];</span><br><span class="line">BOOL re4 &#x3D; [(id)[LGPerson class] isMemberOfClass:[LGPerson class]];</span><br><span class="line">NSLog(@&quot; re1 :%hhd\n re2 :%hhd\n re3 :%hhd\n re4 :%hhd\n&quot;,re1,re2,re3,re4);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;ret3 传入类NSObject self指向NSObject self-&gt;ISA()指向根元类 根元类和NSObject不相等</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;iskindOfClass &amp; isMemberOfClass 实例方法调用</span><br><span class="line">BOOL re5 &#x3D; [(id)[NSObject alloc] isKindOfClass:[NSObject class]];</span><br><span class="line">BOOL re6 &#x3D; [(id)[LGPerson alloc] isKindOfClass:[LGPerson class]];</span><br><span class="line">BOOL re7 &#x3D; [(id)[NSObject alloc] isMemberOfClass:[NSObject class]];</span><br><span class="line">BOOL re8 &#x3D; [(id)[LGPerson alloc] isMemberOfClass:[LGPerson class]];</span><br><span class="line">NSLog(@&quot; re5 :%hhd\n re6 :%hhd\n re7 :%hhd\n re8 :%hhd\n&quot;,re5,re6,re7,re8);</span><br><span class="line"></span><br><span class="line">ret1: 1</span><br><span class="line">ret2: 0</span><br><span class="line">ret3: 0</span><br><span class="line">ret4: 0</span><br><span class="line"></span><br><span class="line">ret5: 1</span><br><span class="line">ret6: 1</span><br><span class="line">ret7: 1</span><br><span class="line">ret8: 1</span><br></pre></td></tr></table></figure>

<ul>
<li>isKindOfClass</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;类方法 </span><br><span class="line">&#x2F;&#x2F;第一次比较，获取类的元类与传入类比较，之后获取上次结果的父类与传入类比较</span><br><span class="line">+ (BOOL)isKindOfClass:(Class)cls &#123;</span><br><span class="line">     &#x2F;&#x2F;类的元类 vs 传入类</span><br><span class="line">     &#x2F;&#x2F;根元类 vs 传入类</span><br><span class="line">     &#x2F;&#x2F;根类 vs 传入类</span><br><span class="line">     &#x2F;&#x2F;nil vs 传入类</span><br><span class="line">     for (Class tcls &#x3D; self-&gt;ISA(); tcls; tcls &#x3D; tcls-&gt;getSuperclass()) &#123;</span><br><span class="line">         if (tcls &#x3D;&#x3D; cls) return YES;</span><br><span class="line">     &#125;</span><br><span class="line">     return NO;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;实例方法 </span><br><span class="line">&#x2F;&#x2F;第一次比较，获取对象的类与传入类比较，之后获取上次结果的父类与传入类比较</span><br><span class="line"> - (BOOL)isKindOfClass:(Class)cls &#123;</span><br><span class="line">     &#x2F;&#x2F;对象的类 vs 传入类</span><br><span class="line">     &#x2F;&#x2F;父类 vs 传入类</span><br><span class="line">     &#x2F;&#x2F;根类 vs 传入类</span><br><span class="line">     &#x2F;&#x2F;nil vs 传入类</span><br><span class="line">     for (Class tcls &#x3D; [self class]; tcls; tcls &#x3D; tcls-&gt;getSuperclass()) &#123;</span><br><span class="line">         if (tcls &#x3D;&#x3D; cls) return YES;</span><br><span class="line">     &#125;</span><br><span class="line">     return NO;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>类方法：元类 -&gt; 根元类 -&gt; 根类 -&gt; nil 与 传入类比较<br>对象方法：对象的类 -&gt; 父类 -&gt; 根类 -&gt; nil 与 传入类比较</p>
<ul>
<li>isMemberOfClass</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;类方法 </span><br><span class="line">&#x2F;&#x2F;获取类的元类 与传入类比较</span><br><span class="line">+ (BOOL)isMemberOfClass:(Class)cls &#123;</span><br><span class="line">     return self-&gt;ISA() &#x3D;&#x3D; cls;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;实例方法 </span><br><span class="line">&#x2F;&#x2F;获取对象的类 与传入类比较</span><br><span class="line"> - (BOOL)isMemberOfClass:(Class)cls &#123;</span><br><span class="line">     return [self class] &#x3D;&#x3D; cls;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>类方法：    类的元类 与 传入类 比较<br>对象方法：对象的父类 与 传入类 比较</p>
<p><a href="https://blog.csdn.net/u013480070/article/details/100154183">对象的本质（下）详解isa&amp;superclass指针</a></p>
]]></content>
  </entry>
  <entry>
    <title>测试下</title>
    <url>/2020/11/17/%E6%B5%8B%E8%AF%95%E4%B8%8B/</url>
    <content><![CDATA[]]></content>
      <categories>
        <category>分类1</category>
      </categories>
      <tags>
        <tag>标签1</tag>
      </tags>
  </entry>
  <entry>
    <title>逆</title>
    <url>/2021/03/31/%E9%80%86/</url>
    <content><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <div class="hbe-input-container">
  <input type="password" id="hbePass" placeholder="" />
    <label for="hbePass">输入密码</label>
    <div class="bottom-line"></div>
  </div>
  <script id="hbeData" type="hbeData" data-hmacdigest="72532eea066a4da146eb47dadaf84eae9b7a8370881c3e752edf5432c1f21e4f">6a0984f7a8e89a416916236f779221ce3fd2c4dcefac971b9ac8b0dfe88c8e46334c272f445ecc37ad2ff29ebc86c61b795b2bdd3ba96e9dc0312d782588f3cb55a66a01be0215453842d96a281db9303caec9bb73de782bc345e2ee9c2109549031e91b8f54c589e56cd95adc18592a272832103cd750c72d5021192aadfa386c3b355150f4376389da11d8e6d3b79ced6064535d03fcf12e8ad72c4f67d5196a2943dcd69dc9298ed2857ce03fc372809a9251c876b0605369c29361d02c80082e6af9060a3ffd5060671e8c286a72e29105bbd27fa3f7b643f885e6358b85ff761f1ad49fab37b1ac11b5c2879ec671eb393c01cc40b340f9b79fc36fbde6a6410ef6c65aa67281b7d616fc5b3f61a46de02ff4c1593f6a6e0fdd335e1fbecc015c033058d04b0f3796d88a5b639a8e502e8e36230ca5c175c600a08c9c0d2544b0a55b0dea027beb482f30bdb73be6d93f6f5941cf27106f9fc6b9ab45ae4bfab5cc357a1e09dd39af815aab12482e54376b299f8314af335ee9b4d19eec71138ac45872addfb03fde20d695503a1e6d89628fe5556b283bab9d641155c408aa20e621089921bc38a2226e5441d38eb1919e96ea5ccc7aa3ad50072925f12f1dc0c96f62927c180c49ff6629d59450382c0f7d5e51d84b376c68d7dc5d04323da77a82ba1c2f7d50e0b7f152589b9c4c83252fa4c75ef735d4070c51ba0e54ef82fe489ad56b19dc589056ad5348a4a3ac10df2c1fc258ec69bcc7540833af19ebeb43910353062e1a7f9afc05f682f6ee81dc998ed50bb091b3601db2e03db2d9afae8dc1e81592accf3ec79df755ed9261abcc7219cef7d94201dc8ca57f64781627c4b2eae6c57a4597ff77a3c7ef700615a774a5f42db7e39d39007c53c58b66d76619b0b979ddf6504860c6947e50f63be2a4c9f03efb22ff02259d9a7b664d33bf3aada6808a148bda07bc170ca2ca19bc069b49691ebb20db4f23cd61022657739942380ccf836e709424cc037cb464fab6ee3bdd4a5c325ed262ba1f61c704768fe90ef06daa72e4dd6dd00826a76be1a1c902cbbdb1fde547ac2df339616028bd8f213baa018b39f618cdec6274f0f0a72ab9e48a28c86496c60a522b6430e78f6837d54ab3b6abf57e6f825a2d2e96376e63f056881fee71a01cb345dcf559d6db14adc6da9d27b8f300972ea9333f7a33acd9f709b5229defb2fa2143718fa1119777a150ff8e18bbfdec179d55d7cca38daeb9bf7aefff3f1e5da36cd74725b78e80d16de9bfaf93d8a1f12dd51a7ae6b78ba34697edfb0d917beccfccb00f2d34d9df69c080b4e1</script>
</div>
<script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>逆</category>
      </categories>
      <tags>
        <tag>逆</tag>
      </tags>
  </entry>
  <entry>
    <title>消息流程</title>
    <url>/2021/07/29/%E6%B6%88%E6%81%AF%E6%B5%81%E7%A8%8B/</url>
    <content><![CDATA[<h4 id="方法的本质"><a href="#方法的本质" class="headerlink" title="方法的本质"></a>方法的本质</h4><p>使用 clang 编译 main.m 文件 <code>clang -rewrite-objc main.m</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">LGPerson *person &#x3D; [LGPerson alloc];</span><br><span class="line">[person sayHello];</span><br></pre></td></tr></table></figure>

<p>编译后的底层实现</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">LGPerson *person = ((LGPerson *(*)(id, SEL))(<span class="keyword">void</span> *)objc_msgSend)((id)objc_getClass(<span class="string">&quot;LGPerson&quot;</span>), sel_registerName(<span class="string">&quot;alloc&quot;</span>));</span><br><span class="line">((<span class="keyword">void</span> (*)(id, SEL))(<span class="keyword">void</span> *)objc_msgSend)((id)person, sel_registerName(<span class="string">&quot;say&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>可以看出，方法的调用本质就是 objc_msgSend消息发送</p>
<h4 id="objc-msgSend-快速查找"><a href="#objc-msgSend-快速查找" class="headerlink" title="objc_msgSend 快速查找"></a>objc_msgSend 快速查找</h4><h4 id="objc-msgSend-慢速查找"><a href="#objc-msgSend-慢速查找" class="headerlink" title="objc_msgSend 慢速查找"></a>objc_msgSend 慢速查找</h4><h4 id="动态方法解析"><a href="#动态方法解析" class="headerlink" title="动态方法解析"></a>动态方法解析</h4><p>如果 LGPerson 类中没有实现 sayHello 方法，runtime 就会调用</p>
<p> <code>resolveInstanceMethod:(实例方法)</code> 或者  <code>resolveClassMethod:(类方法)</code> </p>
<p>我们可以在方法中新增已实现的方法</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- (void)sayAddHello &#123;</span><br><span class="line">    NSLog(@&quot;say add hello&quot;);</span><br><span class="line">&#125;</span><br><span class="line">+ (BOOL)resolveInstanceMethod:(SEL)sel &#123;</span><br><span class="line">    if (sel &#x3D;&#x3D; @selector(sayHello)) &#123;</span><br><span class="line">        IMP addImp &#x3D; class_getMethodImplementation(self, @selector(sayAddHello));</span><br><span class="line">        Method addMethod &#x3D; class_getInstanceMethod(self, @selector(sayAddHello));</span><br><span class="line">        const char *type &#x3D; method_getTypeEncoding(addMethod);</span><br><span class="line">        return class_addMethod(self, sel, addImp, type);</span><br><span class="line">    &#125;</span><br><span class="line">    return [super resolveInstanceMethod:sel];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">void runAddMethod(id self, SEL _cmd)&#123;</span><br><span class="line">    NSLog(@&quot;add C IMP&quot;);</span><br><span class="line">&#125;</span><br><span class="line">+ (BOOL)resolveInstanceMethod:(SEL)sel &#123;</span><br><span class="line">    if ([NSStringFromSelector(sel) isEqualToString:@&quot;sayHello&quot;]) &#123;</span><br><span class="line">        class_addMethod(self, sel, (IMP)runAddMethod, &quot;v@:*&quot;);</span><br><span class="line">        return YES;</span><br><span class="line">    &#125;</span><br><span class="line">    return [super resolveInstanceMethod:sel];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="消息转发"><a href="#消息转发" class="headerlink" title="消息转发"></a>消息转发</h4><p>如果动态方法解析没有处理，进入消息转发流程</p>
<ol>
<li>进入快速转发</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@interface LGTeacher : NSObject</span><br><span class="line">- (void)sayHello;</span><br><span class="line">@end</span><br><span class="line">@implementation LGTeacher</span><br><span class="line">- (void)sayHello &#123;</span><br><span class="line">    NSLog(@&quot;Teacher sayhello&quot;);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<p>LGTeacher 中实现了 sayHello 方法，将消息转发给 LGTeacher 处理</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- (id)forwardingTargetForSelector:(SEL)aSelector &#123;</span><br><span class="line">    if (aSelector &#x3D;&#x3D; @selector(sayHello)) &#123;</span><br><span class="line">        return [LGTeacher alloc];</span><br><span class="line">    &#125;</span><br><span class="line">    return [super forwardingTargetForSelector:aSelector];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>快速转发没有处理，则进入慢速转发</li>
</ol>
<p><code>methodSignatureForSelector</code> 方法返回方法的签名</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector &#123;</span><br><span class="line">    if (aSelector &#x3D;&#x3D; @selector(sayHello)) &#123;</span><br><span class="line">        return [NSMethodSignature signatureWithObjCTypes:&quot;v@:&quot;];</span><br><span class="line">    &#125;</span><br><span class="line">    return [super methodSignatureForSelector:aSelector];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>forwardInvocation</code> 真正执行由 methodSignatureForSelector 返回的 NSMethodSignature</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- (void)forwardInvocation:(NSInvocation *)anInvocation &#123;</span><br><span class="line">    SEL aSelector &#x3D; [anInvocation selector];</span><br><span class="line">    LGTeacher *teacher &#x3D; [LGTeacher alloc];</span><br><span class="line">    if ([teacher respondsToSelector:aSelector]) &#123;</span><br><span class="line">        [anInvocation invokeWithTarget:teacher];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        [super forwardInvocation:anInvocation];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>OC 消息机制可以分为三个阶段：</p>
<p>消息发送阶段：从类和父类的方法缓存列表、方法列表中查找方法</p>
<p>动态解析阶段：如果消息发送阶段没找到方法，进入动态方法解析，动态添加方法实现</p>
<p>消息转发阶段：如果也没有实现动态解析方法，进入消息转发阶段，将消息转发给可以处理消息的接受者</p>
<img src="消息处理.png" alt="消息处理" style="zoom:67%;" />

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">void runAddMethod(id self, SEL _cmd)&#123;</span><br><span class="line">    NSLog(@&quot;add C IMP&quot;);</span><br><span class="line">&#125;</span><br><span class="line">+ (BOOL)resolveInstanceMethod:(SEL)sel &#123;</span><br><span class="line">    if ([NSStringFromSelector(sel) isEqualToString:@&quot;sayHello&quot;]) &#123;</span><br><span class="line">    		class_addMethod(self, sel, (IMP)runAddMethod, &quot;v@:*&quot;);</span><br><span class="line">   		  return YES;</span><br><span class="line">    &#125;</span><br><span class="line">    return [super resolveInstanceMethod:sel];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>objc_msgSend 发送消息流程：</p>
<p>消息发送者先进行 <code>快速查找流程</code> ，在类的缓存cache中查找方法</p>
<p>快速查找流程没找到，走慢速查找流程，实例方法在当前类及类的继承链的方法列表中查找，类方法在元类及元类继承链的方法列表中查找</p>
<p>慢速查找没找到会进行动态方法解析</p>
<p>动态方法解析没有找到会进入消息转发，快速消息转发和慢速消息转发</p>
<p>没有找到最终报异常：unrecognized selector send to instance</p>
]]></content>
  </entry>
  <entry>
    <title>逆向-安全保护</title>
    <url>/2021/11/12/%E9%80%86%E5%90%91-%E5%AE%89%E5%85%A8%E4%BF%9D%E6%8A%A4/</url>
    <content><![CDATA[<p>加固方案：</p>
<p>数据加密：静态字符串、本地存储及网络传输的加密</p>
<p>静态混淆：类名、方法名、属性的混淆</p>
<p>动态保护：反调试、注入检测、hook检测、越狱检测、签名检测等</p>
<p>代码混淆：将代码分块、扁平化、增加干扰代码，提高分析难度</p>
<h4 id="数据加密"><a href="#数据加密" class="headerlink" title="数据加密"></a>数据加密</h4><p>加密算法：</p>
<ul>
<li>BASE64：一种基于64个可打印字符表示二进制数据的方法，主要为了将二进制数据变成可见字符以便传输，可以解密</li>
<li>MD5：将数据运算变成另一个固定长度值，用于数据校验，不可逆</li>
<li>DES：一种对称加密算法，用于对二进制数据进行加密，明文、密文和秘钥的分组长度都是64</li>
<li>AES：密码学中的高级加密标准，本质上是一种对称分组密码体制，用来代替DES</li>
<li>RSA：一种非对称加密算法，存在一个公钥和一个私钥，分别用于加密和解密，速度比对称加密慢很多</li>
</ul>
<p>对称加密：加密解密使用同一秘钥</p>
<p>非对称加密：存在一个公钥和一个私钥</p>
<h5 id="本地存储加密"><a href="#本地存储加密" class="headerlink" title="本地存储加密"></a>本地存储加密</h5><p>本地存储方式：NSUserDefaults、文件、数据库</p>
<p>存储数据时，可以使用哈希算法、对称加密算法（DES/AES）进行加密存储，或者系统 keychain 进行存储，实现加密算法时也不能将 key 以明文形式写在代码中</p>
<h5 id="网络传输加密"><a href="#网络传输加密" class="headerlink" title="网络传输加密"></a>网络传输加密</h5><p>HTTPS + 本地证书校验方式</p>
<p>传输过程中可以使用 RSA+AES 进行加密传输</p>
<ol>
<li>客户端随机生成 AES 的key</li>
<li>使用 RSA 公钥加密算法加密随机的 key</li>
<li>使用随机的 key 对数据进行 AES 加密</li>
<li>将 RSA 加密后的 key 和 AES 加密后的数据发送给服务器</li>
<li>给发送的数据加上时间戳，以防止重放攻击</li>
</ol>
<img src="逆向-安全保护/WeChatd746b59be5c7fc2ddd3741f286c2db2f.png" alt="WeChatd746b59be5c7fc2ddd3741f286c2db2f"/>



<p>AFNetworking 证书校验</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">NSString *certFilePath &#x3D; [[NSBundle mainBundle] pathForResource:@&quot;server&quot; ofType:@&quot;der&quot;];</span><br><span class="line">NSData *certData &#x3D; [NSData dataWithContentsOfFile:certFilePath];</span><br><span class="line">NSSet *certSet &#x3D; [NSSet setWithObject:certData];</span><br><span class="line">AFSecurityPolicy *policy &#x3D; [AFSecurityPolicy policyWithPinningMode:AFSSLPinningModeCertificate withPinnedCertificates:certSet];</span><br></pre></td></tr></table></figure>

<h5 id="字符串加密"><a href="#字符串加密" class="headerlink" title="字符串加密"></a>字符串加密</h5><h4 id="反调试"><a href="#反调试" class="headerlink" title="反调试"></a>反调试</h4><h5 id="ptrace"><a href="#ptrace" class="headerlink" title="ptrace"></a>ptrace</h5><p>ptrace 提供了一个 PT_DENY_ATTACH 参数，告诉系统阻止调试器附加</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PT_DENY_ATTACH</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PT_DENY_ATTACH 31</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//方法1声明 ptrace函数否则不能编译</span></span><br><span class="line"><span class="keyword">int</span> ptrace(<span class="keyword">int</span> _request, pid_t _pid, caddr_t _addr, <span class="keyword">int</span> _data);</span><br><span class="line"><span class="keyword">static</span> __attribute__((always_inline)) <span class="keyword">void</span> Anti0()&#123;</span><br><span class="line">  ptrace(PT_DENY_ATTACH, <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//方法2</span></span><br><span class="line"><span class="keyword">static</span> __attribute__((always_inline))<span class="keyword">void</span> Anti1()&#123;</span><br><span class="line">  <span class="keyword">typedef</span> <span class="keyword">int</span>(*ptrace_ptr_t)(int_request, pid_t _pid, caddr_t _addr, <span class="keyword">int</span> _data);</span><br><span class="line">  <span class="keyword">void</span> *handle = dlopen(<span class="number">0</span>, RTLD_GLOBAL | RTLD_NOW);</span><br><span class="line">  ptrace_ptr_t ptrace_ptr = (ptrace_ptr_t)dlsym(handle, <span class="string">&quot;ptrace&quot;</span>);</span><br><span class="line">  ptrace_ptr(PT_DENY_ATTACH, <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sysctl"><a href="#sysctl" class="headerlink" title="sysctl"></a>sysctl</h5><p>当目标进程被调试的时候，会有一个标志表明自己正在被调试，可以通过 sysctl 查看当前进程的信息，从这个标志位得到当前的调试状态</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sysctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> __attribute__((always_inline))<span class="keyword">void</span> Anti2() &#123;</span><br><span class="line">  <span class="keyword">int</span> name[] = &#123; <span class="built_in">CTL_KERN</span>, KERN_PROC, KERN_PROC_PID, getpid() &#125;;</span><br><span class="line">  u_int nameLen = <span class="keyword">sizeof</span>(name)/<span class="keyword">sizeof</span>(*name);</span><br><span class="line">  <span class="keyword">struct</span> kinfo_proc oldp;</span><br><span class="line">  size_t oldlenp = <span class="keyword">sizeof</span>(oldp);</span><br><span class="line">  <span class="keyword">int</span> result = sysctl(name, nameLen, &amp;oldp, &amp;oldlenp, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span>(result==<span class="number">-1</span>)&#123;</span><br><span class="line">    <span class="comment">//错误处理</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ((oldp.ke_proc.p_flag &amp; P_TRACED) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">//添加自己的逻辑 崩溃、暗桩、退出等</span></span><br><span class="line">    exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="syscall"><a href="#syscall" class="headerlink" title="syscall"></a>syscall</h5><p>为了实现从用户态切换到内核态，系统提供了 syscall 函数</p>
<p>ptrace 也是通过系统调用去实现的，sys/syscall.h 中可以找到 ptrace 对应的编号</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#define SYS_ptrace 26</span><br></pre></td></tr></table></figure>

<p>以下代码等同于调用 ptrace</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="keyword">static</span> __attribute__((always_inline))<span class="keyword">void</span> Anti3() &#123;</span><br><span class="line">	syscall(SYS_ptrace, PT_DENY_ATTACH, <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="svc"><a href="#svc" class="headerlink" title="svc"></a>svc</h5><p>若不想暴露自己的ptrace等系统方法，不想被符号断点中断，可以采用 syscall 的汇编代码来调试 ptrace，实现从用户态到内核态的切换</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> __attribute__((always_inline))<span class="keyword">void</span> Anti4() &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __arm64__</span></span><br><span class="line">  <span class="keyword">asm</span>(</span><br><span class="line">  	<span class="string">&quot;mov x0,#31\n&quot;</span></span><br><span class="line">    <span class="string">&quot;mov x1,#0\n&quot;</span></span><br><span class="line">    <span class="string">&quot;mov x2,#0\n&quot;</span></span><br><span class="line">    <span class="string">&quot;mov x3,#0\n&quot;</span></span><br><span class="line">    <span class="string">&quot;mov w16,#26\n&quot;</span> <span class="comment">//26 --&gt;ptrace</span></span><br><span class="line">    <span class="string">&quot;svc #0x80&quot;</span> <span class="comment">//0x80触发中断去找w16执行</span></span><br><span class="line">  );</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>w16 的参考值可以在 sys/syscall.h 中找到，IDA会将此段代码识别为 mac_syscall</p>
<h5 id="isatty"><a href="#isatty" class="headerlink" title="isatty"></a>isatty</h5><p>检测文件描述符是否连接到一个终端设备，如果是返回1，而 LLDB 调试时需要远程连接 iOS 设备，因此可以用它来做反调试</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> __attribute__((always_inline))<span class="keyword">void</span> Anti6() &#123;</span><br><span class="line">	<span class="keyword">if</span> (isatty(STDOUT_FILENO)) &#123;</span><br><span class="line">    exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="反反调试"><a href="#反反调试" class="headerlink" title="反反调试"></a>反反调试</h4><p>ptrace、sysctl、syscall 反反调试</p>
<p>对于 SVC 汇编层的反调试绕过方法，使用 HookZzModules 来解决</p>
<p><a href="https://github.com/jmpews/HookZzModules/tree/master/AntiDebugBypass">https://github.com/jmpews/HookZzModules/tree/master/AntiDebugBypass</a></p>
<h4 id="注入对抗"><a href="#注入对抗" class="headerlink" title="注入对抗"></a>注入对抗</h4><p>注入的方式通常使用 DYLD_INSERT_LIBRARIES 环境变量将 dylib 注入</p>
<p>自己编写的 dylib 无法加载到目标应用的时候，表明应用做了反注入保护。</p>
<p>iOS10以下系统</p>
<p>在Xcode的编译设置选项  Other Linker Flags 添加 <code> -Wl,-sectcreate,__RESTRICT,__restrict,/dev/null</code>, </p>
<p>dyld 检测到 MachO中存在 <code>__RESTRICT,__restrict</code> 这样的节（Section）时，DYLD_INSERT_LIBRARIES 环境变量会被忽略，导致注入失败。</p>
<p>反反注入：</p>
<ol>
<li>把section的名字修改下（如果主程序同时具备完整性检测那就不行了）</li>
<li>使用Cydia自带的cynject工具注入，可以无惧主程序完整性检测 <code>/usr/bin/cynject&lt;pid&gt;&lt;dylib&gt;</code></li>
</ol>
<h4 id="注入检测"><a href="#注入检测" class="headerlink" title="注入检测"></a>注入检测</h4><h5 id="检测加载模块"><a href="#检测加载模块" class="headerlink" title="检测加载模块"></a>检测加载模块</h5><p>判断加载模块中是否存在一些已知的敏感路径（比如DynamicLibraries）使用 <code>_dyld_get_image_name</code> 获取模块名，然后进行匹配</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mach-o/dyld.h&gt;</span></span></span><br><span class="line">BOOK CheckInject() &#123;</span><br><span class="line">	<span class="keyword">int</span> count = _dyld_image_count();</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;count; i++)&#123;</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">char</span> *image_name = _dyld_get_image_name(i);</span><br><span class="line">		<span class="comment">//printf(&quot;image_name=%s\n&quot;, image_name);</span></span><br><span class="line">		<span class="keyword">if</span>(strstr(image_name, <span class="string">&quot;DynamicLibraries&quot;</span>) || strstr(image_name, <span class="string">&quot;CydiaSubstrate&quot;</span>)) &#123;</span><br><span class="line">			printf(<span class="string">&quot;三方库被注入 ---&gt; %s&quot;</span>, image_name);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还可以逐个检测 Mach-O 的 LoadCommand，以防被类似 yololib 的工具注入 dylib</p>
<h5 id="检测环境变量"><a href="#检测环境变量" class="headerlink" title="检测环境变量"></a>检测环境变量</h5><p>注入环境虽说不一定依赖 CydiaSubstrate，但原理都是通过 DYLD_INSERT_LIBRARIES 注入 dylib，因此可以通过检测环境变量来确定是否被注入</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">BOOL</span> CheckEnv() &#123;</span><br><span class="line">  <span class="keyword">char</span> *env = getenv(<span class="string">&quot;DYLD_INSERT_LIBRARIES&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (env != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    printf(<span class="string">&quot;env=%s&quot;</span>, env);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">char</span> **environ;</span><br><span class="line"><span class="built_in">BOOL</span> CheckEnv2()&#123;</span><br><span class="line">  <span class="keyword">char</span> **p = environ;</span><br><span class="line">  <span class="keyword">while</span>(*p) &#123;</span><br><span class="line">    <span class="keyword">if</span>(strstr(*p, <span class="string">&quot;MobileSubstrate&quot;</span>) || strstr(*p, <span class="string">&quot;DYLD_INSERT_LIBRARIES&quot;</span>)) &#123;</span><br><span class="line">      printf(<span class="string">&quot;%s (%p)\n&quot;</span>, *p, *p);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    p++;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果返回NO表明没有被注入</p>
<h5 id="实时监控dylib"><a href="#实时监控dylib" class="headerlink" title="实时监控dylib"></a>实时监控dylib</h5><p>_dyld_register_func_for_add_image 注册回调后，任意时刻只要 dylib 被加载，都会进入此回调，利用这个特性可以实时监控 dylib 的加载</p>
<p>回调函数代码</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> pyg_image_added(<span class="keyword">const</span> <span class="keyword">struct</span> mach_header *mh, intptr_t slide) &#123;</span><br><span class="line">  Dl_info image_info;</span><br><span class="line">  <span class="keyword">int</span> result = dladdr(mh, &amp;image_info);</span><br><span class="line">  <span class="keyword">if</span> (result==<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *image_name = image_info.dli_fname;</span><br><span class="line">  <span class="keyword">if</span>(strstr(image_name, <span class="string">&quot;DynamicLibraries&quot;</span>) || strstr(image_name, <span class="string">&quot;CydiaSubstrate&quot;</span>)) &#123;</span><br><span class="line">			printf(<span class="string">&quot;三方库被注入 ---&gt; %s&quot;</span>, image_name);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注册回调函数写在构造函数里</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">__attribute__((constructor)) <span class="keyword">static</span> <span class="keyword">void</span> pyg_init()&#123;</span><br><span class="line">  _dyld_register_func_for_add_image(&amp;pyg_image_added)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于 OC 类，可以写在 load 方法里</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">	_dyld_register_func_for_add_image(&amp;pyg_image_added)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Hook检测"><a href="#Hook检测" class="headerlink" title="Hook检测"></a>Hook检测</h4><h5 id="Method-Swizzing-检测"><a href="#Method-Swizzing-检测" class="headerlink" title="Method Swizzing 检测"></a>Method Swizzing 检测</h5><p>Method Swizzing 原理是替换 IMP，通过 dladdr 得到 IMP 地址所在模块信息进行判断</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;objc/runtime.h&gt;</span></span></span><br><span class="line">BOOK CheckMethodSwizzle(<span class="keyword">const</span> <span class="keyword">char</span> *className, <span class="keyword">char</span> *selName) &#123;</span><br><span class="line">  Dl_info info;</span><br><span class="line">  IMP imp = class_getMethodImplementation(objc_getClass(className), sel_registerName(selName));</span><br><span class="line">  <span class="keyword">if</span> (!dladdr(imp, &amp;info)) &#123;</span><br><span class="line">    printf(<span class="string">&quot;error: can&#x27;t find this symbol \n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//路径不在自身模块中（例如tweak中）则一定被hook了</span></span><br><span class="line">  <span class="keyword">if</span> (strcmp(info.dli_fname, _dyld_get_image_name(<span class="number">0</span>)) != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//还可以判断 dli_fbase dli_saddr是否位于自身内存区间</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//调用方法</span></span><br><span class="line">CheckMethodSwizzle(<span class="string">&quot;ViewController&quot;</span>, <span class="string">&quot;ViewDidLoad&quot;</span>);</span><br></pre></td></tr></table></figure>

<h5 id="Inline-Hook检测"><a href="#Inline-Hook检测" class="headerlink" title="Inline Hook检测"></a>Inline Hook检测</h5><p>Inline Hook原理通过修改函数的前 N字节内存，使程序跳转到自己编写的函数</p>
<h4 id="越狱检测"><a href="#越狱检测" class="headerlink" title="越狱检测"></a>越狱检测</h4><h5 id="检测越狱商店及附属文件"><a href="#检测越狱商店及附属文件" class="headerlink" title="检测越狱商店及附属文件"></a>检测越狱商店及附属文件</h5><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ARRAY_SIZE(a) sizeof(a)/sizeof(a[0])</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *jailbrokenFiles[] = &#123;</span><br><span class="line">  <span class="string">&quot;/Applications/Cydia.app&quot;</span>,</span><br><span class="line">  <span class="string">&quot;/Applications/Sileo.app&quot;</span>,</span><br><span class="line">  <span class="string">&quot;/Library/MobileSubstrate/MobileSubstrate.dylib&quot;</span>,</span><br><span class="line">  <span class="string">&quot;/bin/bash&quot;</span>,</span><br><span class="line">  <span class="string">&quot;/usr/sbin/sshd&quot;</span>,</span><br><span class="line">  <span class="string">&quot;/etc/apt&quot;</span>,</span><br><span class="line">  <span class="comment">//TODO 还可以添加更多文件列表</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">BOOL</span> isJailbroken1() &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; ARRAY_SIZE(jailbrokenFiles); i++)&#123;</span><br><span class="line">    <span class="keyword">if</span>([[<span class="built_in">NSFileManager</span> defaultManager] fileExistsAtPath:[<span class="built_in">NSString</span> stringWithUTF8String: jailbrokenFiles[i]]])&#123;</span><br><span class="line">      <span class="built_in">NSLog</span>(<span class="string">@&quot;设备已越狱&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="built_in">BOOL</span> isJailbroken2() &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; ARRAY_SIZE(jailbrokenFiles); i++)&#123;</span><br><span class="line">  	<span class="keyword">struct</span> stat stat_info;</span><br><span class="line">    <span class="keyword">if</span>(stat(jailbrokenFiles[i], &amp;stat_info) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">NSLog</span>(<span class="string">@&quot;设备已越狱&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="尝试读取系统应用列表"><a href="#尝试读取系统应用列表" class="headerlink" title="尝试读取系统应用列表"></a>尝试读取系统应用列表</h5><p>如果已越狱，就可以读取到系统应用列表</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">BOOL</span> isJailbroken3() &#123;</span><br><span class="line">  <span class="keyword">if</span> ([[<span class="built_in">NSFileManager</span> defaultManager] fileExistsAtPath: <span class="string">@&quot;/Applications/&quot;</span>]) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;设备已越狱&quot;</span>);</span><br><span class="line">    <span class="built_in">NSArray</span> *applist = [[<span class="built_in">NSFileManager</span> defaultManager] contentsOfDirectoryAtPath:<span class="string">@&quot;/Applications/&quot;</span> error: <span class="literal">nil</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;AppList = %@&quot;</span>, applist);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;设备未越狱&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="检测URLScheme是否有效"><a href="#检测URLScheme是否有效" class="headerlink" title="检测URLScheme是否有效"></a>检测URLScheme是否有效</h5><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">BOOL</span> isJailbroken4() &#123;</span><br><span class="line">	<span class="keyword">if</span>([[<span class="built_in">UIApplication</span> sharedApplication] canOpenURL:[[<span class="built_in">NSURL</span> URLWithString:<span class="string">@&quot;Cydia://&quot;</span>]]]) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;设备已越狱&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="完整性检测"><a href="#完整性检测" class="headerlink" title="完整性检测"></a>完整性检测</h4><p>检测目标是否被脱壳、是否被静态注入、内容是否被修改、是否被重签名等</p>
<p>常见方式有加载命令检测、代码段检测、签名信息检测</p>
<h5 id="加载命令检测"><a href="#加载命令检测" class="headerlink" title="加载命令检测"></a>加载命令检测</h5><p>为了使未越狱设备也能顺利使用插件，通常会在 LoadCommand（加载命令）中增加一个 LC_LOAD_DYLIB 或者 LC_LOAD_WEAK_DYLIB 的方式来指向自己的动态库，从而实现注入功能，这种方式通常也称为静态注入</p>
<p>加载命令检测即检测 Mach-O 文件的 LoadCommand 中 LC_LOAD_DYLIB 或 LC_LOAD_WEAK_DYLIB 是否存在异常</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//加载命令检测</span></span><br><span class="line"><span class="keyword">static</span> BOOk CheckLoadDylib() &#123;</span><br><span class="line">  mach_head_64 *header = (mach_header_64 *)&amp;_mh_execute_header;</span><br><span class="line">  <span class="keyword">if</span>(header-&gt;magic==M_MAGIC_64)&#123;</span><br><span class="line">    segment_command_64 *cur_seg_cmd;</span><br><span class="line">    uintptr_t cur = (uiniptr_t)head + <span class="keyword">sizeof</span>(mach_header_64);</span><br><span class="line">    <span class="keyword">for</span>(unit i=<span class="number">0</span>; i&lt;head-&gt;ncmds; i++,cur+=cur_seg_cmd-&gt;cmdsize)&#123;</span><br><span class="line">      cur_seg_cmd = (segment_command_64 *)cur;</span><br><span class="line">      <span class="keyword">if</span>(cur_seg_cmd-&gt;cmd == LC_LOAD_DYLIB || cur_seg_cmd-&gt;cmd == LC_LOAD_WEAK_DYLIB)&#123;</span><br><span class="line">        dylib_command *dylib = (dylib_command *)cur_seg_cmd;</span><br><span class="line">        <span class="keyword">char</span> *name = (<span class="keyword">char</span> *)((unintptr_t)dylib+dylib-&gt;dylib.name.offset);</span><br><span class="line">        printf(<span class="string">&quot;dylib_name=%s\n&quot;</span>, name);</span><br><span class="line">        <span class="comment">//这里可以加入白名单判断 如果发现了@rpath之类的路径就要怀疑是否注入了三方库</span></span><br><span class="line">        <span class="comment">//return YES;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="代码段检测"><a href="#代码段检测" class="headerlink" title="代码段检测"></a>代码段检测</h5><p>检测 <code>__TEXT,__text</code> 是否被修改（当然也可以检测其它 Section）</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *GetTextSectionHash () &#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> size;</span><br><span class="line">  uint8_t *ptr = getsectiondata(&amp;_mh_execute_header, <span class="string">&quot;__TEXT&quot;</span>, <span class="string">&quot;__text&quot;</span>, &amp;size);</span><br><span class="line">  <span class="keyword">if</span> (!ptr) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">@&quot;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">char</span> digest[CC_MD5_DIGEST_LENGTH];</span><br><span class="line">  CC_MD5(ptr, (CC_LONG)size, digest) ;</span><br><span class="line">  <span class="built_in">NSMutableString</span> *result = [<span class="built_in">NSMutableString</span> stringWithCapacity: CC_MD5_DIGEST_LENGTH * <span class="number">2</span>];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i  = <span class="number">0</span>: i &lt; CC_MD5_DIGEST_LENGTH; i++) </span><br><span class="line">    [result appendFormat: <span class="string">@&quot;%02x&quot;</span>, digest[i]];</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>&amp;_mh_execute_header</code> 指向 MachO 在内存中的起始位置，getsectiondata返回指定 Section 的内存地址大小。实际应用中可以将正确的 Hash 值存到 服务器或者加密后放到本地，在进程启动时进行对比，不匹配则可以进行一些逻辑处理</p>
<h5 id="签名信息检测"><a href="#签名信息检测" class="headerlink" title="签名信息检测"></a>签名信息检测</h5><p>检测 LC_CODE_SIGNATURE 中的特征信息，比如 TeamID是否和用户匹配</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> CheckTeamID(<span class="keyword">const</span> <span class="keyword">char</span> *szTeamID) &#123;</span><br><span class="line">  load_command *lc;</span><br><span class="line">  mach_header_64 *header = (mach_header_64 *)&amp;_mh_execute_header;</span><br><span class="line">  <span class="keyword">if</span> (header-&gt;magic == MH_MAGIC_64) &#123;</span><br><span class="line">    uintptr_t cur = (uintptr_t)head + <span class="keyword">sizeof</span>(mach_header_64);</span><br><span class="line">    <span class="keyword">for</span>(unit i=<span class="number">0</span>; i&lt;head-&gt;ncmds; i++,cur+=lc-&gt;cmdsize)&#123;</span><br><span class="line">    	lc = (load_command*)cur;</span><br><span class="line">      <span class="keyword">if</span>(lc-&gt;cmd == LC_CODE_SIGNATURE)&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;CMD=LC_CODE_SIGNATURE&quot;</span>);</span><br><span class="line">        <span class="keyword">char</span> *codeSignature = (<span class="keyword">char</span>*)header+((<span class="keyword">struct</span> linkedit_data_command *)lc)-&gt;dataoff;</span><br><span class="line">        <span class="keyword">int</span> codeSignatureSize = ((<span class="keyword">struct</span> linkedit_data_command)lc)-&gt;datasize;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">void</span> *p = memmem(codeSignature, codeSignatureSize, szTeamId, strlen(szTeamId));</span><br><span class="line">        <span class="keyword">if</span>(!p) &#123;</span><br><span class="line">          printf(<span class="string">&quot;校验失败&quot;</span>);</span><br><span class="line">          <span class="comment">//处理校验失败逻辑</span></span><br><span class="line">          exit(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="代码保护"><a href="#代码保护" class="headerlink" title="代码保护"></a>代码保护</h4><p><a href="https://github.com/HikariObfuscator/Hikari">https://github.com/HikariObfuscator/Hikari</a></p>
<p>安装 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone --recursive -b release_80 https:&#x2F;&#x2F;github.com&#x2F;HikariObfuscator&#x2F;Hikari.git Hikari &amp;&amp; cd Hikari &amp;&amp; git submodule update --remote --recursive &amp;&amp; cd ..&#x2F; &amp;&amp; mkdir Build &amp;&amp; cd Build &amp;&amp; cmake -G &quot;Ninja&quot; -DLLDB_CODESIGN_IDENTITY&#x3D;&#39;&#39; -DCMAKE_BUILD_TYPE&#x3D;MinSizeRel -DLLVM_APPEND_VC_REV&#x3D;on -DLLDB_USE_SYSTEM_DEBUGSERVER&#x3D;YES -DLLVM_CREATE_XCODE_TOOLCHAIN&#x3D;on -DCMAKE_INSTALL_PREFIX&#x3D;~&#x2F;Library&#x2F;Developer&#x2F; ..&#x2F;Hikari &amp;&amp; ninja &amp;&amp;ninja install-xcode-toolchain &amp;&amp; git clone https:&#x2F;&#x2F;github.com&#x2F;HikariObfuscator&#x2F;Resources.git ~&#x2F;Hikari &amp;&amp; rsync -a --ignore-existing &#x2F;Applications&#x2F;Xcode.app&#x2F;Contents&#x2F;Developer&#x2F;Toolchains&#x2F;XcodeDefault.xctoolchain&#x2F; ~&#x2F;Library&#x2F;Developer&#x2F;Toolchains&#x2F;Hikari.xctoolchain&#x2F; &amp;&amp; rm ~&#x2F;Library&#x2F;Developer&#x2F;Toolchains&#x2F;Hikari.xctoolchain&#x2F;ToolchainInfo.plist</span><br></pre></td></tr></table></figure>

<p>安装成功后 Xcode - Toolchains 菜单看到 Hikari 命令</p>
<p>提供了 8 中混淆选项</p>
<img src="逆向-安全保护/图片 5.png" alt="图片 5" style="zoom:90%;" />

<p>Xcode Build Settings 中根据需要添加上述选项</p>
<img src="逆向-安全保护/图片 2.png" alt="图片 2" style="zoom:70%;" />

<p>Hikari 还提供了一个 -enable-allobf 选项，用于启用以上所有功能</p>
]]></content>
  </entry>
  <entry>
    <title>逆向工具-Cycript</title>
    <url>/2021/10/11/%E9%80%86%E5%90%91%E5%B7%A5%E5%85%B7-Cycript/</url>
    <content><![CDATA[<p>用于注入目标进程来实现运行时调试，重启后所有修改都会失效，对原生程序或代码无副作用</p>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p><a href="http://www.cycript.org/">Cycript官网</a> 下载 SDK 解压进入 cycript_0.9.594 文件夹，执行 ./cycript</p>
<p>会报下面错误</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dyld[1291]: Library not loaded: &#x2F;System&#x2F;Library&#x2F;Frameworks&#x2F;Ruby.framework&#x2F;Versions&#x2F;2.0&#x2F;usr&#x2F;lib&#x2F;libruby.2.0.0.dylib</span><br><span class="line">  Referenced from: &#x2F;Users&#x2F;midland_whk&#x2F;Downloads&#x2F;cycript_0.9.594&#x2F;Cycript.lib&#x2F;cycript-apl</span><br><span class="line">  Reason: tried: &#39;&#x2F;Users&#x2F;midland_whk&#x2F;Downloads&#x2F;cycript_0.9.594&#x2F;.&#x2F;Cycript.lib&#x2F;libruby.2.0.0.dylib&#39; (no such file), &#39;&#x2F;System&#x2F;Library&#x2F;Frameworks&#x2F;Ruby.framework&#x2F;Versions&#x2F;2.0&#x2F;usr&#x2F;lib&#x2F;libruby.2.0.0.dylib&#39; (no such file), &#39;&#x2F;usr&#x2F;local&#x2F;lib&#x2F;libruby.2.0.0.dylib&#39; (no such file), &#39;&#x2F;usr&#x2F;lib&#x2F;libruby.2.0.0.dylib&#39; (no such file)</span><br><span class="line">[1]    1291 abort      .&#x2F;cycript</span><br></pre></td></tr></table></figure>

<p>这是因为 ruby 版本太高，需要进入 <code>/usr/local/Cellar/ruby@2.5/2.5.8/lib</code> ，将 <code>libruby.2.5.8.dylib</code> 重命名 <code>libruby.2.0.0</code> 并拷贝到 <code>Cycript.lib</code> 目录下</p>
<h4 id="Cycript-使用"><a href="#Cycript-使用" class="headerlink" title="Cycript 使用"></a>Cycript 使用</h4><p>Cydia 中 搜索 Cycript 安装</p>
<p>通过 SSH 登录手机，输入 cycript 命令，就进入交互界面，<code>control + D</code> 或者 <code>?exit</code>  退出命令</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ssh root@<span class="number">172.16</span><span class="number">.1</span><span class="number">.96</span> //或者 ssh -P <span class="number">2222</span> root@localhost</span><br><span class="line">cycript</span><br><span class="line"></span><br><span class="line">cy<span class="comment"># var a = 3</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line">cy<span class="comment"># var b = 4</span></span><br><span class="line"><span class="number">4</span></span><br><span class="line">cy<span class="comment"># a + b</span></span><br><span class="line"><span class="number">7</span></span><br></pre></td></tr></table></figure>

<p>使用 -p 选项注入目标进程</p>
<h6 id="alert弹窗"><a href="#alert弹窗" class="headerlink" title="alert弹窗"></a>alert弹窗</h6><p>注入 SpringBoard 弹出提示窗口</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">root<span class="meta"># cycript -p SpringBoard</span></span><br><span class="line">cy<span class="meta"># var alert = [[UIAlertView alloc] initWithTitle:@<span class="meta-string">&quot;hi&quot;</span> message: @<span class="meta-string">&quot;hello,world&quot;</span>  delegate:nil cancelButtonTitle:@<span class="meta-string">&quot;cancel&quot;</span> otherButtonTitles: nil]</span></span><br><span class="line">#<span class="string">&quot;&lt;UIAlertView: 0x118c27680; frame = (0 0; 0 0); layer = &lt;CALayer: 0x280a06b00&gt;&gt;&quot;</span></span><br><span class="line">cy# [alert show]</span><br></pre></td></tr></table></figure>

<h6 id="获取进程号"><a href="#获取进程号" class="headerlink" title="获取进程号"></a>获取进程号</h6><p><code>ps -e</code>  或者 <code>ps -A</code>   <code>ps -e | grep DemoApp</code> 找到进程号 9790</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">9790 ??  0:00.80 &#x2F;var&#x2F;containers&#x2F;Bundle&#x2F;Application&#x2F;4F526F02-0133-4149-9E3F-A492B2DC7D7F&#x2F;DemoApp.app&#x2F;DemoApp</span><br></pre></td></tr></table></figure>

<p>cycript -p 进程名字</p>
<h6 id="启动-cycript"><a href="#启动-cycript" class="headerlink" title="启动 cycript"></a>启动 cycript</h6><p><code>cycript -p 9790</code> 或者  <code>cycript -p DemoApp</code> 启动 cycript</p>
<h6 id="获取沙盒目录"><a href="#获取沙盒目录" class="headerlink" title="获取沙盒目录"></a>获取沙盒目录</h6><p>NSHomeDirectory()</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cy# NSHomeDirectory()</span><br><span class="line">@&quot;&#x2F;var&#x2F;mobile&#x2F;Containers&#x2F;Data&#x2F;Application&#x2F;629E01BE-3EC6-461C-A479-83EEEAB0A22D&quot;</span><br></pre></td></tr></table></figure>

<h6 id="获取-Bundle-ID"><a href="#获取-Bundle-ID" class="headerlink" title="获取 Bundle ID"></a>获取 Bundle ID</h6><p>[[NSBundle mainBundle] bundleIdentifier]</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cy# [[NSBundle mainBundle] bundleIdentifier]</span><br><span class="line">@&quot;com.DemoApp&quot;</span><br></pre></td></tr></table></figure>

<p>可以直接在脚本中调用 OC 函数来获取和修改应用一些信息</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">cy# <span class="built_in">UIApp</span></span><br><span class="line">#<span class="string">&quot;&lt;UIApplication: 0x109e01050&gt;&quot;</span></span><br><span class="line">cy# <span class="built_in">UIApp</span>.delegate</span><br><span class="line">#<span class="string">&quot;&lt;AppDelegate: 0x281d3d700&gt;&quot;</span></span><br><span class="line">cy# <span class="built_in">UIApp</span>.keyWindow</span><br><span class="line">#<span class="string">&quot;&lt;UIWindow: 0x109e14650; frame = (0 0; 375 667); gestureRecognizers = &lt;NSArray: 0x281324510&gt;; layer = &lt;UIWindowLayer: 0x281d2aa60&gt;&gt;&quot;</span></span><br><span class="line">cy# <span class="built_in">UIApp</span>.keyWindow.rootViewController</span><br><span class="line">#<span class="string">&quot;&lt;ViewController: 0x109d16900&gt;&quot;</span></span><br><span class="line">cy# #<span class="number">0x109d16900</span>.view</span><br><span class="line">#<span class="string">&quot;&lt;UIView: 0x109e15b40; frame = (0 0; 375 667); autoresize = W+H; layer = &lt;CALayer: 0x281d2ae80&gt;&gt;&quot;</span></span><br><span class="line"><span class="comment">//隐藏显示</span></span><br><span class="line">cy# [#<span class="number">0x109d16900</span> setHidden:<span class="literal">YES</span>]</span><br><span class="line">cy# [#<span class="number">0x109d16900</span> setHidden:<span class="literal">NO</span>] </span><br><span class="line">cy# #<span class="number">0x109d16900</span>.view.backgroundColor = [<span class="built_in">UIColor</span> yellowColor]</span><br><span class="line">#<span class="string">&quot;UIExtendedSRGBColorSpace 1 1 0 1&quot;</span></span><br><span class="line">cy<span class="meta"># var newVC = new Instance(0x109d16900)</span></span><br><span class="line">#<span class="string">&quot;&lt;ViewController: 0x109d16900&gt;&quot;</span></span><br><span class="line">cy<span class="meta"># var newVC = #0x109d16900</span></span><br><span class="line">#<span class="string">&quot;&lt;ViewController: 0x109d16900&gt;&quot;</span></span><br><span class="line">cy# newVC</span><br><span class="line">#<span class="string">&quot;&lt;ViewController: 0x109d16900&gt;&quot;</span></span><br><span class="line"><span class="comment">//获取对象</span></span><br><span class="line">cy# #<span class="number">0x109d16900</span></span><br><span class="line">#<span class="string">&quot;&lt;ViewController: 0x109d16900&gt;&quot;</span></span><br><span class="line"><span class="comment">//访问属性</span></span><br><span class="line">cy# #<span class="number">0x109d16900</span> -&gt;_tableView</span><br></pre></td></tr></table></figure>

<h6 id="打印界面结构"><a href="#打印界面结构" class="headerlink" title="打印界面结构"></a>打印界面结构</h6><p>UIApp.keyWindow.recursiveDescription().toString() </p>
<p>或者 <code>[[[UIApp keyWindow] recursiveDescription] toString]</code></p>
<p><code>[[UIApp keyWindow] _autolayoutTrace].toString()</code></p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">cy# <span class="built_in">UIApp</span>.keyWindow.recursiveDescription().toString()</span><br><span class="line">`&lt;<span class="built_in">UIWindow</span>: <span class="number">0x109e14650</span>; frame = (<span class="number">0</span> <span class="number">0</span>; <span class="number">375</span> <span class="number">667</span>); gestureRecognizers = &lt;<span class="built_in">NSArray</span>: <span class="number">0x281324510</span>&gt;; layer = &lt;<span class="built_in">UIWindowLayer</span>: <span class="number">0x281d2aa60</span>&gt;&gt;</span><br><span class="line">   | &lt;<span class="built_in">UIView</span>: <span class="number">0x109e15b40</span>; frame = (<span class="number">0</span> <span class="number">0</span>; <span class="number">375</span> <span class="number">667</span>); autoresize = W+H; layer = &lt;<span class="built_in">CALayer</span>: <span class="number">0x281d2ae80</span>&gt;&gt;</span><br><span class="line">   |    | &lt;<span class="built_in">UIButton</span>: <span class="number">0x109d1a100</span>; frame = (<span class="number">20</span> <span class="number">100</span>; <span class="number">100</span> <span class="number">50</span>); opaque = <span class="literal">NO</span>; layer = &lt;<span class="built_in">CALayer</span>: <span class="number">0x281d262c0</span>&gt;&gt;</span><br><span class="line">   |    |    | &lt;<span class="built_in">UIButtonLabel</span>: <span class="number">0x109d19690</span>; frame = (<span class="number">10</span> <span class="number">14.5</span>; <span class="number">80.5</span> <span class="number">21.5</span>); text = <span class="string">&#x27;DemoApp&#x27;</span>; opaque = <span class="literal">NO</span>; userInteractionEnabled = <span class="literal">NO</span>; layer = &lt;_UILabelLayer: <span class="number">0x283e31400</span>&gt;&gt;`</span><br></pre></td></tr></table></figure>

<p>[[[UIWindow keyWindow] rootViewController] _printHierarchy].toString()</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">cy# [[[<span class="built_in">UIWindow</span> keyWindow] rootViewController] _printHierarchy].toString()</span><br><span class="line"><span class="string">&quot;&lt;ViewController 0x101211e50&gt;, state: appeared, view: &lt;UIView 0x109e15b40&gt;&quot;</span></span><br></pre></td></tr></table></figure>

<h6 id="choose-方法"><a href="#choose-方法" class="headerlink" title="choose() 方法"></a>choose() 方法</h6><p>choose(UITableView) 在内存中直接找出这个类的对象地址，打印所有 UITableView 实例</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">cy<span class="meta"># choose(UIViewController)</span></span><br><span class="line">[#<span class="string">&quot;&lt;ViewController: 0x101211e50&gt;&quot;</span>]</span><br></pre></td></tr></table></figure>

<h6 id="找UIButton-所属-Controller"><a href="#找UIButton-所属-Controller" class="headerlink" title="找UIButton 所属 Controller"></a>找UIButton 所属 Controller</h6><p>UIButton 地址 0x100b15960</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">cy# [#<span class="number">0x100b15960</span> nextResponder]</span><br><span class="line">#<span class="string">&quot;&lt;UIView: 0x100b15380; frame = (0 0; 375 667); autoresize = W+H; layer = &lt;CALayer: 0x282e3a4a0&gt;&gt;&quot;</span></span><br><span class="line">cy# [#<span class="number">0x100b15380</span> nextResponder]</span><br><span class="line">#<span class="string">&quot;&lt;ViewController: 0x101211e50&gt;&quot;</span></span><br></pre></td></tr></table></figure>

<h6 id="找出-Action-响应方法"><a href="#找出-Action-响应方法" class="headerlink" title="找出 Action 响应方法"></a>找出 Action 响应方法</h6><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">cy# [#<span class="number">0x100b15960</span> allTargets]</span><br><span class="line">[<span class="built_in">NSSet</span> setWithArray:@[#<span class="string">&quot;&lt;ViewController: 0x101211e50&gt;&quot;</span>]]]</span><br><span class="line">cy# [#<span class="number">0x100b15960</span> actionsForTarget:#<span class="number">0x101211e50</span>]</span><br><span class="line">cy# [#<span class="number">0x100b15960</span> actionsForTarget:#<span class="number">0x101211e50</span> forControlEvent: <span class="built_in">UIControlEventTouchUpInside</span>]</span><br><span class="line">@[<span class="string">&quot;demoAction:&quot;</span>]</span><br></pre></td></tr></table></figure>

<h5 id="加载脚本"><a href="#加载脚本" class="headerlink" title="加载脚本"></a>加载脚本</h5><p>新建 utils.cy</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(function(utils) &#123;</span><br><span class="line">	APPID &#x3D; [NSBundle mainBundle].bundleIdentifier,</span><br><span class="line">	APPPATH &#x3D; [NSBundle mainBundle].bundlePath,</span><br><span class="line"></span><br><span class="line">	HKRootvc &#x3D; function()&#123;</span><br><span class="line">	 	return UIApp.keyWindow.rootViewController;</span><br><span class="line">	 &#125;;</span><br><span class="line">	 </span><br><span class="line">	 HKKeyWindow &#x3D; function()&#123;</span><br><span class="line">	 	return UIApp.keyWindow;</span><br><span class="line">	 &#125;;</span><br><span class="line"></span><br><span class="line">	 HKGetCurrentVCFromRootVc &#x3D; function(rootVC)&#123;</span><br><span class="line">	 var currentVC;</span><br><span class="line">	 if([rootVC presentedViewController])&#123;</span><br><span class="line">	 rootVC &#x3D; [rootVC presentedViewController];</span><br><span class="line">	 &#125;</span><br><span class="line">	 </span><br><span class="line">	 if([rootVC isKindOfClass:[UITabBarController class]])&#123;</span><br><span class="line">		 	currentVC &#x3D; HKGetCurrentVCFromRootVc(rootVC.selectedViewController);</span><br><span class="line">		 &#125;else if([rootVC isKindOfClass:[UINavigationController class]])&#123;</span><br><span class="line">		 	currentVC &#x3D; HKGetCurrentVCFromRootVc(rootVC.visibleViewController);</span><br><span class="line">		 &#125;else&#123;</span><br><span class="line">		 currentVC &#x3D; rootVC;</span><br><span class="line">	 &#125;</span><br><span class="line">	 </span><br><span class="line">	 	return currentVC;</span><br><span class="line">	 &#125;;</span><br><span class="line">	 </span><br><span class="line">	 </span><br><span class="line">	 HKCurrentVC &#x3D; function()&#123;</span><br><span class="line">	 	return HKGetCurrentVCFromRootVc(HKRootvc());</span><br><span class="line">	 &#125;;</span><br><span class="line"></span><br><span class="line">	 pviews &#x3D; function() &#123;</span><br><span class="line">		return UIApp.keyWindow.recursiveDescription().toString();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	pvc &#x3D; function() &#123;</span><br><span class="line">		return [[[UlWindow keyWindow] rootViewController] _printHierarchy].toString();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;)(exports);</span><br></pre></td></tr></table></figure>

<p>设备上 <code>/usr/lib/cycript0.9/com/</code> 新建文件夹 monkey</p>
<p>将 utils.cy 拷贝到文件夹</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scp utils.cy root@172.16.1.96:&#x2F;usr&#x2F;lib&#x2F;cycript0.9&#x2F;com&#x2F;monkey</span><br></pre></td></tr></table></figure>

<p>如果需要使用该文件，在 cycript 中需要导入，就可以使用了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@import com.monkey.utils;</span><br><span class="line">pviews()</span><br></pre></td></tr></table></figure>

<h5 id="MonkeyApp-cycript"><a href="#MonkeyApp-cycript" class="headerlink" title="MonkeyApp cycript"></a>MonkeyApp cycript</h5><p>MonkeyApp 运行后控制台会提示 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Download cycript(https:&#x2F;&#x2F;cydia.saurik.com&#x2F;api&#x2F;latest&#x2F;3) then run: .&#x2F;cycript -r 172.16.1.60:6666</span><br><span class="line">2021-10-11 15:15:55.342839+0800 TargetApp[5795:1158273] [Cycript] Finish download all script!</span><br></pre></td></tr></table></figure>

<p>终端输入 <code>./cycript -r 172.16.1.60:6666</code> 就可以进入 cycript 交互界面</p>
<p>MonkeyDev 作者加载了自己写的网络脚本，源码如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(function(utils) &#123;</span><br><span class="line"></span><br><span class="line">    utils.constants &#x3D; &#123;</span><br><span class="line">        APPID:  	 NSBundle.mainBundle.bundleIdentifier,</span><br><span class="line">        APPPATH:     NSBundle.mainBundle.bundlePath,</span><br><span class="line">        APPHOME:	 NSHomeDirectory(),</span><br><span class="line">        APPDOC:      NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES)[0],</span><br><span class="line">        APPLIBRARY:  NSSearchPathForDirectoriesInDomains(NSLibraryDirectory, NSUserDomainMask, YES)[0],</span><br><span class="line">        APPCACHE:    NSSearchPathForDirectoriesInDomains(NSCachesDirectory, NSUserDomainMask, YES)[0]</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    utils.pviews &#x3D; function()&#123;</span><br><span class="line">        return UIApp.keyWindow.recursiveDescription().toString();</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    utils.pvcs &#x3D; function()&#123;</span><br><span class="line">        return UIWindow.keyWindow().rootViewController._printHierarchy().toString();</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    utils.rp &#x3D; function(target)&#123;</span><br><span class="line">        var result &#x3D; &quot;&quot; + target.toString();</span><br><span class="line">        while(target.nextResponder)&#123;</span><br><span class="line">            result +&#x3D; &quot;\n&quot; + target.nextResponder.toString();</span><br><span class="line">            target &#x3D; target.nextResponder;</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    utils.pactions &#x3D; function(target)&#123;</span><br><span class="line">		var result &#x3D; &#39;&#39;;</span><br><span class="line">		var objs &#x3D; target.allTargets.allObjects();</span><br><span class="line">		for(var i &#x3D; 0; i &lt; objs.length; i++)&#123;</span><br><span class="line">			var actions &#x3D; [target actionsForTarget:objs[i] forControlEvent:0];</span><br><span class="line">			result +&#x3D; objs[i] + &quot; &quot; + [actions componentsJoinedByString:@&quot;,&quot;];</span><br><span class="line">		&#125;</span><br><span class="line">		return result;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    for(var k in utils.constants) &#123;</span><br><span class="line">        Cycript.all[k] &#x3D; utils.constants[k];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for(var k in utils) &#123;</span><br><span class="line">        if(utils.hasOwnProperty(k)) &#123;</span><br><span class="line">            var f &#x3D; utils[k];</span><br><span class="line">            if(typeof f &#x3D;&#x3D;&#x3D; &#39;function&#39;) &#123;</span><br><span class="line">                Cycript.all[k] &#x3D; f;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)(exports);</span><br></pre></td></tr></table></figure>

<p>使用的时候需要先导入 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">@import md</span><br></pre></td></tr></table></figure>





















]]></content>
      <tags>
        <tag>逆向工具</tag>
      </tags>
  </entry>
  <entry>
    <title>Autotouch</title>
    <url>/2021/09/29/Autotouch/</url>
    <content><![CDATA[<blockquote>
<p>Autotouch 版本：7.0.33 破解版</p>
<p>软件源：多米诺骨牌源 <a href="https://apt.wxhbts.com/">https://apt.wxhbts.com</a></p>
</blockquote>
<h4 id="Lua"><a href="#Lua" class="headerlink" title="Lua"></a>Lua</h4><h5 id="模块与包"><a href="#模块与包" class="headerlink" title="模块与包"></a>模块与包</h5><p>Lua 的模块是由变量、函数等已知元素组成的 table，创建一个模块就是创建一个 table，把需要导出的常量、函数放入其中，最后返回 table</p>
<p>创建自定义模块 module.lua</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 文件名为 module.lua</span></span><br><span class="line"><span class="comment">-- 定义一个 module 的模块</span></span><br><span class="line"><span class="built_in">module</span> = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 定义一个常量</span></span><br><span class="line"><span class="built_in">module</span>.constant = <span class="string">&quot;这是一个常量&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 定义一个函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">module.func1</span><span class="params">()</span></span></span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;这是公有函数&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">func2</span><span class="params">()</span></span> </span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&quot;这是私有函数&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">module.func3</span><span class="params">()</span></span></span><br><span class="line">	func2()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="built_in">module</span></span><br></pre></td></tr></table></figure>

<p>使用模块</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- 加载模块 或者 require &quot;module&quot;</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">&quot;module&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">module</span>.constant)</span><br><span class="line"><span class="built_in">module</span>.func1()</span><br><span class="line"><span class="built_in">module</span>.func3()</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 给模块定义一个别名</span></span><br><span class="line"><span class="keyword">local</span> m = <span class="built_in">require</span>(<span class="string">&quot;module&quot;</span>)</span><br><span class="line">m.func3()</span><br></pre></td></tr></table></figure>





<h4 id="Extension-Functions"><a href="#Extension-Functions" class="headerlink" title="Extension Functions"></a>Extension Functions</h4><h5 id="touchDown-id-x-y"><a href="#touchDown-id-x-y" class="headerlink" title="touchDown(id, x, y)"></a>touchDown(id, x, y)</h5><blockquote>
<p>Press the coordinate (x,y) on the screen.</p>
</blockquote>
<p>id:    Finger ID</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- Press by one finger at coordinate (100,200).</span></span><br><span class="line">touchDown(<span class="number">0</span>, <span class="number">100</span>, <span class="number">200</span>); </span><br><span class="line"></span><br><span class="line"><span class="comment">-- Press by three fingers at three locations on the screen.</span></span><br><span class="line">touchDown(<span class="number">0</span>, <span class="number">100</span>, <span class="number">200</span>);</span><br><span class="line">touchDown(<span class="number">1</span>, <span class="number">200</span>, <span class="number">300</span>);</span><br><span class="line">touchDown(<span class="number">2</span>, <span class="number">300</span>, <span class="number">400</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Implement a tap function</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tap</span><span class="params">(x, y)</span></span></span><br><span class="line">    touchDown(<span class="number">0</span>, x, y);</span><br><span class="line">    usleep(<span class="number">16000</span>);</span><br><span class="line">    touchUp(<span class="number">0</span>, x, y);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Tap at (100, 200)</span></span><br><span class="line">tap(<span class="number">100</span>, <span class="number">200</span>);</span><br></pre></td></tr></table></figure>

<h5 id="touchMove-id-x-y"><a href="#touchMove-id-x-y" class="headerlink" title="touchMove(id, x, y)"></a>touchMove(id, x, y)</h5><blockquote>
<p>Move the finger to coordinate (x,y).</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- Press by one finger at coordinate (100,200) and move the finger to coordinate (200,200).</span></span><br><span class="line">touchDown(<span class="number">0</span>, <span class="number">100</span>, <span class="number">200</span>);</span><br><span class="line">usleep(<span class="number">16000</span>);</span><br><span class="line">touchMove(<span class="number">0</span>, <span class="number">200</span>, <span class="number">200</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Press by three fingers at three locations on the screen and move to new location.</span></span><br><span class="line">touchDown(<span class="number">0</span>, <span class="number">100</span>, <span class="number">200</span>);</span><br><span class="line">touchDown(<span class="number">1</span>, <span class="number">200</span>, <span class="number">300</span>);</span><br><span class="line">touchDown(<span class="number">2</span>, <span class="number">300</span>, <span class="number">400</span>);</span><br><span class="line">usleep(<span class="number">16000</span>);</span><br><span class="line">touchMove(<span class="number">0</span>, <span class="number">150</span>, <span class="number">250</span>);</span><br><span class="line">touchMove(<span class="number">1</span>, <span class="number">250</span>, <span class="number">350</span>);</span><br><span class="line">touchMove(<span class="number">2</span>, <span class="number">350</span>, <span class="number">450</span>);</span><br></pre></td></tr></table></figure>

<h5 id="touchUp-id-x-y"><a href="#touchUp-id-x-y" class="headerlink" title="touchUp(id, x, y)"></a>touchUp(id, x, y)</h5><blockquote>
<p>Lift the finger from coordinate (x,y)</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- Click the screen once by one finger at coordinate (100,200).</span></span><br><span class="line">touchDown(<span class="number">0</span>, <span class="number">100</span>, <span class="number">200</span>);</span><br><span class="line">usleep(<span class="number">16000</span>);</span><br><span class="line">touchUp(<span class="number">0</span>, <span class="number">100</span>, <span class="number">200</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Press by three fingers at three locations on the screen, move to new location, and then lift the finger.</span></span><br><span class="line">touchDown(<span class="number">0</span>, <span class="number">100</span>, <span class="number">200</span>);</span><br><span class="line">touchDown(<span class="number">1</span>, <span class="number">200</span>, <span class="number">300</span>);</span><br><span class="line">touchDown(<span class="number">2</span>, <span class="number">300</span>, <span class="number">400</span>);</span><br><span class="line">usleep(<span class="number">16000</span>);</span><br><span class="line">touchMove(<span class="number">0</span>, <span class="number">150</span>, <span class="number">250</span>);</span><br><span class="line">touchMove(<span class="number">1</span>, <span class="number">250</span>, <span class="number">350</span>);</span><br><span class="line">touchMove(<span class="number">2</span>, <span class="number">350</span>, <span class="number">450</span>);</span><br><span class="line">usleep(<span class="number">16000</span>);</span><br><span class="line">touchUp(<span class="number">0</span>, <span class="number">150</span>, <span class="number">250</span>);</span><br><span class="line">touchUp(<span class="number">1</span>, <span class="number">250</span>, <span class="number">350</span>);</span><br><span class="line">touchUp(<span class="number">2</span>, <span class="number">350</span>, <span class="number">450</span>);</span><br></pre></td></tr></table></figure>

<h5 id="keyDown-keyType"><a href="#keyDown-keyType" class="headerlink" title="keyDown(keyType)"></a>keyDown(keyType)</h5><blockquote>
<p>Simulate the pressing of physical key</p>
</blockquote>
<p>Home Button：KEY_TYPE.HOME_BUTTON</p>
<p>Volume – Button：KEY_TYPE.VOLUME_DOWN_BUTTON</p>
<p>Volume + Button：KEY_TYPE.VOLUME_UP_BUTTON</p>
<p>Power Button：KEY_TYPE.POWER_BUTTON</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- Simulate the pressing of Home Key.</span></span><br><span class="line">keyDown(KEY_TYPE.HOME_BUTTON);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- How to simulate a key pressing?</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">keyPress</span><span class="params">(keyType)</span></span></span><br><span class="line">    keyDown(keyType);</span><br><span class="line">    usleep(<span class="number">10000</span>);</span><br><span class="line">    keyUp(keyType);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">keyPress(KEY_TYPE.HOME_BUTTON);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- How to simulate a screen lock function?</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">lockScreen</span><span class="params">()</span></span></span><br><span class="line">    keyDown(KEY_TYPE.POWER_BUTTON);</span><br><span class="line">    keyUp(KEY_TYPE.POWER_BUTTON);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- How to simulate a screen unlock function?</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unlockScreen</span><span class="params">()</span></span></span><br><span class="line">    keyDown(KEY_TYPE.POWER_BUTTON);</span><br><span class="line">    keyUp(KEY_TYPE.POWER_BUTTON);</span><br><span class="line"></span><br><span class="line">    usleep(<span class="number">1000000</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> w, h = getScreenResolution();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> x = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">local</span> gap = <span class="number">120</span>;</span><br><span class="line">    touchDown(<span class="number">0</span>, x, <span class="number">200</span>);</span><br><span class="line">    <span class="keyword">while</span> x &lt; w <span class="keyword">do</span></span><br><span class="line">        x = x + gap;</span><br><span class="line">        usleep(<span class="number">16000</span>);</span><br><span class="line">        touchMove(<span class="number">0</span>, x, <span class="number">200</span>);</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    touchUp(<span class="number">0</span>, x, <span class="number">200</span>);</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h5 id="keyUp-keyType"><a href="#keyUp-keyType" class="headerlink" title="keyUp(keyType)"></a>keyUp(keyType)</h5><blockquote>
<p>Simulate the lifting of physical key</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- Simulate the action of pressing and lifting Home Key.</span></span><br><span class="line">keyDown(KEY_TYPE.HOME_BUTTON);</span><br><span class="line">usleep(<span class="number">10000</span>);</span><br><span class="line">keyUp(KEY_TYPE.HOME_BUTTON);</span><br></pre></td></tr></table></figure>

<h5 id="getColor-x-y"><a href="#getColor-x-y" class="headerlink" title="getColor(x, y)"></a>getColor(x, y)</h5><blockquote>
<p>Get the color value of the pixel point of the specified coordinate on current screen</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> color = getColor(<span class="number">100</span>, <span class="number">200</span>)</span><br><span class="line">alert(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;Pixel color is :%d&quot;</span>, color))</span><br><span class="line"><span class="comment">-- Pop up color: 16777215</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Keep gettting color of a location until it matches a specify color</span></span><br><span class="line"><span class="keyword">local</span> color</span><br><span class="line"><span class="keyword">repeat</span></span><br><span class="line">   color = getColor(<span class="number">100</span>, <span class="number">200</span>)</span><br><span class="line">   usleep(<span class="number">50000</span>) <span class="comment">-- Wait a while</span></span><br><span class="line"><span class="keyword">until</span>( color == <span class="number">123456</span> )</span><br><span class="line"><span class="comment">-- Continue to do what&#x27;s next</span></span><br></pre></td></tr></table></figure>

<h5 id="getColors-locations"><a href="#getColors-locations" class="headerlink" title="getColors(locations)"></a>getColors(locations)</h5><blockquote>
<p>Get the color values of the pixel points of the specified coordinates on current screen</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> result = getColors(&#123; &#123;<span class="number">100</span>, <span class="number">200</span>&#125;, &#123;<span class="number">200</span>, <span class="number">300</span>&#125;, &#123;<span class="number">300</span>, <span class="number">400</span>&#125; &#125;);</span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">pairs</span>(result) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">log</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;Gotten color:%d&quot;</span>, v));</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h5 id="findColor"><a href="#findColor" class="headerlink" title="findColor()"></a>findColor()</h5><p>findColor(color, count, region, debug, rightToLeft, bottomToTop)</p>
<blockquote>
<p>Search the coordinates of the pixel points matching the specified color on current screen</p>
</blockquote>
<table>
<thead>
<tr>
<th>Parameter</th>
<th align="left">Type</th>
<th>Optional</th>
<th>Default</th>
</tr>
</thead>
<tbody><tr>
<td>color</td>
<td align="left">Integer</td>
<td>NO</td>
<td></td>
</tr>
<tr>
<td>count</td>
<td align="left">Integer</td>
<td>NO</td>
<td>0</td>
</tr>
<tr>
<td>region</td>
<td align="left">table</td>
<td>NO</td>
<td>nil</td>
</tr>
<tr>
<td>debug</td>
<td align="left">boolean</td>
<td>YES</td>
<td>false</td>
</tr>
<tr>
<td>rightToLeft</td>
<td align="left">boolean</td>
<td>YES</td>
<td>false</td>
</tr>
<tr>
<td>bottonToTop</td>
<td align="left">boolean</td>
<td>YES</td>
<td>false</td>
</tr>
</tbody></table>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- Example:</span></span><br><span class="line"><span class="keyword">local</span> result = findColor(<span class="number">0x0000ff</span>, <span class="number">2</span>, <span class="literal">nil</span>);</span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">pairs</span>(result) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">log</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;Found pixel: x:%f, y:%f&quot;</span>, v[<span class="number">1</span>], v[<span class="number">2</span>]));</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Example: Search from right to left, from bottom to top</span></span><br><span class="line"><span class="keyword">local</span> result = findColor(<span class="number">0x0000ff</span>, <span class="number">2</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">pairs</span>(result) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">log</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;Found rect at: x:%f, y:%f&quot;</span>, v[<span class="number">1</span>], v[<span class="number">2</span>]));</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Example:</span></span><br><span class="line"><span class="keyword">local</span> result = findColor(<span class="number">0x00ddff</span>, <span class="number">0</span>, &#123;<span class="number">100</span>, <span class="number">50</span>, <span class="number">200</span>, <span class="number">200</span>&#125;);</span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">pairs</span>(result) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">log</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;Found pixel: x:%f, y:%f&quot;</span>, v[<span class="number">1</span>], v[<span class="number">2</span>]));</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Example:</span></span><br><span class="line"><span class="keyword">local</span> region = &#123;<span class="number">100</span>, <span class="number">50</span>, <span class="number">200</span>, <span class="number">200</span>&#125;;</span><br><span class="line"><span class="keyword">local</span> result = findColor(<span class="number">0x00ddff</span>, <span class="number">0</span>, region);</span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">pairs</span>(result) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">log</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;Found pixel: x:%f, y:%f&quot;</span>, v[<span class="number">1</span>], v[<span class="number">2</span>]));</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Example:</span></span><br><span class="line"><span class="comment">-- Keep finding a speficied color until it&#x27;s found.</span></span><br><span class="line"><span class="keyword">local</span> locations</span><br><span class="line"><span class="keyword">repeat</span></span><br><span class="line">   <span class="keyword">local</span> locations = findColor(<span class="number">0x0000ff</span>, <span class="number">2</span>, <span class="literal">nil</span>);</span><br><span class="line">   usleep(<span class="number">50000</span>) <span class="comment">-- Wait a while</span></span><br><span class="line"><span class="keyword">until</span>(locations &gt; <span class="number">0</span>)</span><br><span class="line"><span class="comment">-- Log the locations if found</span></span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">pairs</span>(locations) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">log</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;Found pixel: x:%f, y:%f&quot;</span>, v[<span class="number">1</span>], v[<span class="number">2</span>]));</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h5 id="findColors"><a href="#findColors" class="headerlink" title="findColors()"></a>findColors()</h5><p> findColors(colors, count, region, debug, rightToLeft, bottomToTop)</p>
<blockquote>
<p>colors: { {0x00ddff,0,0}, {0x00eeff,10,10}, {0x0000ff,0,20} }</p>
<p>the first is the color value. The second and the third are the corresponding locations of the colors </p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- Example:</span></span><br><span class="line"><span class="keyword">local</span> result = findColors(&#123; &#123;<span class="number">0x00ddff</span>,<span class="number">0</span>,<span class="number">0</span>&#125;, &#123;<span class="number">0x00eeff</span>,<span class="number">10</span>,<span class="number">10</span>&#125;, &#123;<span class="number">0x0000ff</span>,<span class="number">0</span>,<span class="number">20</span>&#125; &#125;, <span class="number">2</span>, <span class="literal">nil</span>, <span class="literal">true</span>);</span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">pairs</span>(result) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">log</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;Found rect at: x:%f, y:%f&quot;</span>, v[<span class="number">1</span>], v[<span class="number">2</span>]));</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Example: Search from right to left, from bottom to top</span></span><br><span class="line"><span class="keyword">local</span> result = findColors(&#123; &#123;<span class="number">0x00ddff</span>,<span class="number">0</span>,<span class="number">0</span>&#125;, &#123;<span class="number">0x00eeff</span>,<span class="number">10</span>,<span class="number">10</span>&#125;, &#123;<span class="number">0x0000ff</span>,<span class="number">0</span>,<span class="number">20</span>&#125; &#125;, <span class="number">2</span>, <span class="literal">nil</span>, <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">pairs</span>(result) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">log</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;Found rect at: x:%f, y:%f&quot;</span>, v[<span class="number">1</span>], v[<span class="number">2</span>]));</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Example:</span></span><br><span class="line"><span class="keyword">local</span> colors = &#123; &#123;<span class="number">0x00ddff</span>,<span class="number">0</span>,<span class="number">0</span>&#125;, &#123;<span class="number">0x00eeff</span>,<span class="number">10</span>,<span class="number">10</span>&#125;, &#123;<span class="number">0x0000ff</span>,<span class="number">0</span>,<span class="number">20</span>&#125; &#125;;</span><br><span class="line"><span class="keyword">local</span> result = findColors(colors, <span class="number">0</span>, <span class="literal">nil</span>, <span class="literal">true</span>);</span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">pairs</span>(result) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">log</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;Found rect at: x:%f, y:%f&quot;</span>, v[<span class="number">1</span>], v[<span class="number">2</span>]));</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Example:</span></span><br><span class="line"><span class="keyword">local</span> colors = &#123; &#123;<span class="number">0x00ddff</span>,<span class="number">0</span>,<span class="number">0</span>&#125;, &#123;<span class="number">0x00eeff</span>,<span class="number">10</span>,<span class="number">10</span>&#125;, &#123;<span class="number">0x0000ff</span>,<span class="number">0</span>,<span class="number">20</span>&#125; &#125;;</span><br><span class="line"><span class="keyword">local</span> region = &#123;<span class="number">100</span>, <span class="number">50</span>, <span class="number">200</span>, <span class="number">200</span>&#125;;</span><br><span class="line"><span class="keyword">local</span> result = findColors(colors, <span class="number">0</span>, region);</span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">pairs</span>(result) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">log</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;Found rect at: x:%f, y:%f&quot;</span>, v[<span class="number">1</span>], v[<span class="number">2</span>]));</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h5 id="findImage"><a href="#findImage" class="headerlink" title="findImage()"></a>findImage()</h5><p>findImage(targetImagePath, count, threshold, region, debug, method)</p>
<blockquote>
<p>Search areas matching the specified image on current screen and return the center coordinates</p>
</blockquote>
<table>
<thead>
<tr>
<th></th>
<th>Type</th>
<th>Specification</th>
<th>Optional</th>
<th>Default</th>
</tr>
</thead>
<tbody><tr>
<td>targetImagePath</td>
<td></td>
<td>for example: “images/gold.PNG”, If the path starts with character “/“, it will be treated as absolute path, if not, it will be treated as relative path</td>
<td>NO</td>
<td></td>
</tr>
<tr>
<td>count</td>
<td>integer</td>
<td>How many areas to find, Pass 0 or nil</td>
<td>YES</td>
<td>0</td>
</tr>
<tr>
<td>threshold</td>
<td>float</td>
<td>maximum value is 1 means totally the same, minimum value is -1 means non same, default is 0.9, usually 0.99 is good. Pass nil if you just want to use the default value</td>
<td>YES</td>
<td>0.9</td>
</tr>
<tr>
<td>region</td>
<td>table</td>
<td>Do searching in which region</td>
<td>YES</td>
<td>Whole screen</td>
</tr>
<tr>
<td>debug</td>
<td>boolean</td>
<td>If pass debug=true, it will produce a image ends with “-Debug.PNG” marked the matching areas.</td>
<td>YES</td>
<td>false</td>
</tr>
<tr>
<td>method</td>
<td>integer</td>
<td>Searching method, default is 1, pass 2 if you want to use the more intelligent method which is able to cover size scale, orientation, color changed, it will be a little slower than method 1.</td>
<td>YES</td>
<td>1</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>Return</th>
<th>Type</th>
<th>Specification</th>
</tr>
</thead>
<tbody><tr>
<td>center locations</td>
<td>table</td>
<td>Center coordinates of the matching areas</td>
</tr>
</tbody></table>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- Example:</span></span><br><span class="line"><span class="keyword">local</span> result = findImage(<span class="string">&quot;images/Gold.PNG&quot;</span>, <span class="number">5</span>, <span class="number">0.99</span>, <span class="literal">nil</span>, <span class="literal">true</span>)</span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">pairs</span>(result) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">log</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;Found rect at: x:%f, y:%f&quot;</span>, v[<span class="number">1</span>], v[<span class="number">2</span>]));</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Example:</span></span><br><span class="line"><span class="keyword">local</span> result = findImage(<span class="string">&quot;images/Gold.PNG&quot;</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">true</span>)</span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">pairs</span>(result) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">log</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;Found rect at: x:%f, y:%f&quot;</span>, v[<span class="number">1</span>], v[<span class="number">2</span>]));</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Example:</span></span><br><span class="line"><span class="keyword">local</span> result = findImage(<span class="string">&quot;images/Gold.PNG&quot;</span>, <span class="number">3</span>)</span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">pairs</span>(result) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">log</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;Found rect at: x:%f, y:%f&quot;</span>, v[<span class="number">1</span>], v[<span class="number">2</span>]));</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Example:</span></span><br><span class="line"><span class="keyword">local</span> imagePath = <span class="string">&quot;images/spirit.PNG&quot;</span>;</span><br><span class="line"><span class="keyword">local</span> region = &#123;<span class="number">100</span>, <span class="number">100</span>, <span class="number">300</span>, <span class="number">300</span>&#125;;</span><br><span class="line"><span class="keyword">local</span> result = findImage(imagePath, <span class="number">2</span>, <span class="number">0.98</span>, region, <span class="literal">true</span>)</span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">pairs</span>(result) <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> x = v[<span class="number">1</span>], y = v[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">log</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;Found rect at: x:%f, y:%f&quot;</span>, x, y));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- Click the found location once.</span></span><br><span class="line">    tap(x, y);</span><br><span class="line">    usleep(<span class="number">16000</span>);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Example:</span></span><br><span class="line"><span class="keyword">local</span> imagePath = <span class="string">&quot;images/spirit.PNG&quot;</span>;</span><br><span class="line"><span class="keyword">local</span> region = &#123;<span class="number">100</span>, <span class="number">100</span>, <span class="number">300</span>, <span class="number">300</span>&#125;;</span><br><span class="line"><span class="comment">-- Use method 2 to find image</span></span><br><span class="line"><span class="keyword">local</span> result = findImage(imagePath, <span class="number">2</span>, <span class="number">0.98</span>, region, <span class="literal">true</span>, <span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<h5 id="screenshot-filePath-region"><a href="#screenshot-filePath-region" class="headerlink" title="screenshot(filePath, region)"></a>screenshot(filePath, region)</h5><blockquote>
<p>Take a screenshot for the whole screen or specified area</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- Take shot of the whole screen and save into  &quot;AutoTouch&quot; album of iOS Photo Library.</span></span><br><span class="line">screenshot();</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Take a screenshot of the whole screen and save to the specified path, if no PNG as path extension, .PNG will automatically added.</span></span><br><span class="line">screenshot (<span class="string">&quot;images/screenshot1&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Take a screenshot of the specified area and save.</span></span><br><span class="line">screenshot (<span class="string">&quot;images/screenshot2.PNG&quot;</span>, &#123;<span class="number">100</span>, <span class="number">100</span>, <span class="number">200</span>, <span class="number">200</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Take a screenshot of the specified area and save into  &quot;AutoTouch&quot; album of iOS Photo Library.</span></span><br><span class="line">screenshot (<span class="literal">nil</span>, &#123;<span class="number">100</span>, <span class="number">100</span>, <span class="number">200</span>, <span class="number">200</span>&#125;);</span><br></pre></td></tr></table></figure>

<h5 id="appRun-appidentifier"><a href="#appRun-appidentifier" class="headerlink" title="appRun(appidentifier)"></a>appRun(appidentifier)</h5><blockquote>
<p>Run specified application</p>
</blockquote>
<p>或者 appActivate</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">appRun(<span class="string">&quot;com.apple.mobilesafari&quot;</span>)</span><br><span class="line">appActivate(<span class="string">&quot;com.taobao.taobao4iphone&quot;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="appKill（appidentifier）"><a href="#appKill（appidentifier）" class="headerlink" title="appKill（appidentifier）"></a>appKill（appidentifier）</h5><blockquote>
<p>Kill specified application</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">appKill(<span class="string">&quot;com.apple.mobilesafari&quot;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="appState-appidentifier"><a href="#appState-appidentifier" class="headerlink" title="appState(appidentifier)"></a>appState(appidentifier)</h5><blockquote>
<p>Get the running state of the specified application</p>
</blockquote>
<p>“NOT RUNNING”, “ACTIVATED”, “DEACTIVATED”</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- Get the state of Safari.</span></span><br><span class="line"><span class="keyword">local</span> state = appState(<span class="string">&quot;com.apple.mobilesafari&quot;</span>);</span><br><span class="line">alert(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;State of Safari: %s&quot;</span>, state));</span><br><span class="line"><span class="comment">-- Pop up the state of Safari: &quot;ACTIVATED&quot;</span></span><br></pre></td></tr></table></figure>

<h5 id="rootDir"><a href="#rootDir" class="headerlink" title="rootDir()"></a>rootDir()</h5><blockquote>
<p>Get the default directory address of the saved script</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> dirPath = rootDir();</span><br><span class="line">alert(dirPath);</span><br><span class="line"><span class="comment">-- Popup &quot;/var/mobile/Library/AutoTouch/Scripts/&quot;</span></span><br></pre></td></tr></table></figure>

<h5 id="currentDir"><a href="#currentDir" class="headerlink" title="currentDir()"></a>currentDir()</h5><blockquote>
<p>Get directory of current executing script in runtime</p>
</blockquote>
<p>7.0.33 不支持</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> dir = currentDir();</span><br><span class="line">alert(dir);</span><br><span class="line"><span class="comment">-- &quot;/var/mobile/Library/AutoTouch/Scripts&quot;</span></span><br><span class="line"><span class="comment">-- Or maybe in tmp place for encrypted scripts: &quot;/tmp/xxxxxxxxxxxx/&quot;</span></span><br></pre></td></tr></table></figure>

<h5 id="botPath"><a href="#botPath" class="headerlink" title="botPath"></a>botPath</h5><blockquote>
<p>Get original path of the bot, relative to the runtime path of encrypted scripts</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="built_in">path</span> = botPath();</span><br><span class="line">alert(<span class="built_in">path</span>);</span><br><span class="line"><span class="comment">-- &quot;/var/mobile/Library/AutoTouch/Scripts/test.lua&quot;</span></span><br><span class="line"><span class="comment">-- &quot;/var/mobile/Library/AutoTouch/Scripts/test1.ate&quot;</span></span><br></pre></td></tr></table></figure>

<h5 id="usleep-microseconds"><a href="#usleep-microseconds" class="headerlink" title="usleep(microseconds)"></a>usleep(microseconds)</h5><blockquote>
<p>Sleep several microseconds (1/1000000 second)</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- Sleep 1 second.</span></span><br><span class="line">usleep(<span class="number">1000000</span>);</span><br></pre></td></tr></table></figure>

<h5 id="log-content"><a href="#log-content" class="headerlink" title="log(content)"></a>log(content)</h5><blockquote>
<p>Record log, can be seen in the log interface</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="built_in">log</span>(<span class="string">&quot;play here...&quot;</span>);</span><br></pre></td></tr></table></figure>

<h5 id="alert-message"><a href="#alert-message" class="headerlink" title="alert(message)"></a>alert(message)</h5><blockquote>
<p>Pop up the dialog box to show specified content</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">alert(<span class="string">&quot;Hello World!&quot;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="toast-message-delay"><a href="#toast-message-delay" class="headerlink" title="toast(message, delay)"></a>toast(message, delay)</h5><blockquote>
<p>Show messages with Toast style and delay for some seconds</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">toast(<span class="string">&quot;Hello I&#x27;m a toast!&quot;</span>, <span class="number">5</span>); <span class="comment">-- Show message for 5 seconds.</span></span><br><span class="line">toast(<span class="string">&quot;Hello again!&quot;</span>); <span class="comment">-- Show message for 2 seconds.</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Hello again!&quot;</span>);</span><br></pre></td></tr></table></figure>

<h5 id="vibrate"><a href="#vibrate" class="headerlink" title="vibrate()"></a>vibrate()</h5><blockquote>
<p>Vibrate once</p>
</blockquote>
<p>震动一次 7.0.33 没生效</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- Vibrate once.</span></span><br><span class="line">vibrate();</span><br></pre></td></tr></table></figure>

<h5 id="playAudio-audioFile-times"><a href="#playAudio-audioFile-times" class="headerlink" title="playAudio(audioFile, times)"></a>playAudio(audioFile, times)</h5><blockquote>
<p>Play audio document at specified location</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- Play audio infinitely.</span></span><br><span class="line">playAudio(<span class="string">&quot;/var/audio.mp3&quot;</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<h5 id="stopAudio"><a href="#stopAudio" class="headerlink" title="stopAudio"></a>stopAudio</h5><blockquote>
<p>Stop playing audio</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- Stop playing audio.</span></span><br><span class="line">stopAudio();</span><br></pre></td></tr></table></figure>

<h5 id="getOrientation"><a href="#getOrientation" class="headerlink" title="getOrientation()"></a>getOrientation()</h5><blockquote>
<p>Get orientation of the screen</p>
</blockquote>
<table>
<thead>
<tr>
<th>Value</th>
<th>Specification</th>
</tr>
</thead>
<tbody><tr>
<td>ORIENTATION_TYPE.UNKNOWN</td>
<td>Unknown orientation. Practical value is 0.</td>
</tr>
<tr>
<td>ORIENTATION_TYPE.PORTRAIT</td>
<td>Portrait screen. Home button is at the bottom. Practical value is 1.</td>
</tr>
<tr>
<td>ORIENTATION_TYPE.PORTRAIT_UPSIDE_DOWN</td>
<td>Upside-down portrait screen. Home button on the top. Practical value is 2.</td>
</tr>
<tr>
<td>ORIENTATION_TYPE.LANDSCAPE_LEFT</td>
<td>Landscape left screen. Home Key is in the left. Practical value is 3.</td>
</tr>
<tr>
<td>ORIENTATION_TYPE.LANDSCAPE_RIGHT</td>
<td>Landscape right screen. Home key is in the right. Practical value is 4.</td>
</tr>
</tbody></table>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> o = getOrientation();</span><br><span class="line">alert(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;Screen orientation is : %d&quot;</span>, <span class="number">0</span>))</span><br><span class="line"><span class="comment">-- Pop up the orientation 2 of the screen, and mark the reversed screen.</span></span><br></pre></td></tr></table></figure>

<h5 id="getScreenResolution"><a href="#getScreenResolution" class="headerlink" title="getScreenResolution"></a>getScreenResolution</h5><blockquote>
<p>Get screen resolution bese on pixels</p>
</blockquote>
<table>
<thead>
<tr>
<th>Return</th>
<th align="center">Type</th>
<th>Specification</th>
</tr>
</thead>
<tbody><tr>
<td>width</td>
<td align="center">Integer</td>
<td>Width of screen resolution.</td>
</tr>
<tr>
<td>height</td>
<td align="center">Integer</td>
<td>Height of screen resolution</td>
</tr>
</tbody></table>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> w, h = getScreenResolution();</span><br><span class="line">alert(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;Resolution of iPhone 6 Plus: width:%d, height:%d&quot;</span>, w, h));</span><br><span class="line"><span class="comment">-- iPhone 6 Plus’s resolution width is 1242 and resolution height is 2208.</span></span><br></pre></td></tr></table></figure>

<h5 id="getSN"><a href="#getSN" class="headerlink" title="getSN()"></a>getSN()</h5><blockquote>
<p>Get Serial Number of the device</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> sn = getSN();</span><br><span class="line">alert(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;SN is : %s&quot;</span>, sn));</span><br><span class="line"><span class="comment">-- Popup shows the SN of the device: C15NFK32TWD2</span></span><br></pre></td></tr></table></figure>

<h5 id="getVersion"><a href="#getVersion" class="headerlink" title="getVersion()"></a>getVersion()</h5><blockquote>
<p>Get version of AutoTouch</p>
</blockquote>
<p>7.0.33 返回 nil</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> version = getVersion();</span><br><span class="line">alert(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;Current version of AutoTouch is : %s&quot;</span>, version));</span><br><span class="line"><span class="comment">-- Pop up shows current version of AutoTouch: 3.5.3-4</span></span><br></pre></td></tr></table></figure>

<h5 id="frontMostAppid"><a href="#frontMostAppid" class="headerlink" title="frontMostAppid()"></a>frontMostAppid()</h5><blockquote>
<p>Get identifier of current front most App</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> appId = frontMostAppId();</span><br><span class="line">alert(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;Current front most App is : %s&quot;</span>, appId))</span><br></pre></td></tr></table></figure>

<h5 id="frontMostAppOrientation"><a href="#frontMostAppOrientation" class="headerlink" title="frontMostAppOrientation()"></a>frontMostAppOrientation()</h5><blockquote>
<p>Get orientation of current front most App</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> orientation = frontMostAppOrientation();</span><br><span class="line">alert(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;Orientation of current front most App is : %d&quot;</span>, orientation))</span><br></pre></td></tr></table></figure>

<h5 id="intToRgb-intColor"><a href="#intToRgb-intColor" class="headerlink" title="intToRgb(intColor)"></a>intToRgb(intColor)</h5><blockquote>
<p>Transit integer color to independent values of R,G,B.</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> r, g, b = intToRgb(<span class="number">0x2b2b2b</span>);</span><br><span class="line">alert(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;R:%d, G:%d, B:%d&quot;</span>, r, g, b))</span><br></pre></td></tr></table></figure>

<h5 id="rgbToInt-r-g-b"><a href="#rgbToInt-r-g-b" class="headerlink" title="rgbToInt(r, g, b)"></a>rgbToInt(r, g, b)</h5><blockquote>
<p>Transit values of R,G,B to integer color value</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> intColor = rgbToInt(<span class="number">200</span>, <span class="number">255</span>, <span class="number">100</span>);</span><br><span class="line">alert(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;Int type color: %d&quot;</span>, intColor))</span><br></pre></td></tr></table></figure>

<h5 id="copyText-text"><a href="#copyText-text" class="headerlink" title="copyText(text)"></a>copyText(text)</h5><blockquote>
<p>Copy specified text to clipboard</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">copyText(<span class="string">&quot;This is a copied text!&quot;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="clipText"><a href="#clipText" class="headerlink" title="clipText()"></a>clipText()</h5><blockquote>
<p>Get the text in the clipboard</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> text = clipText();</span><br><span class="line">alert(text);</span><br><span class="line"><span class="comment">-- Popup shows the text to be copied: &quot;This is a copied text!&quot;;</span></span><br></pre></td></tr></table></figure>

<h5 id="inputText"><a href="#inputText" class="headerlink" title="inputText()"></a>inputText()</h5><blockquote>
<p>Input text to the input box selected now. You can delete a character backspace by inputText(“\b”).<strong>ATTENSION:</strong> Enable inoutText function at AutoTouch Settings &gt; Features before using it</p>
</blockquote>
<p>7.0.33 没有这个设置</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">inputText(<span class="string">&quot;Let&#x27;s input some text automatically without tapping the keyboard!&quot;</span>);</span><br><span class="line"><span class="comment">--  Delete 3 character by inputing 3 backspaces.</span></span><br><span class="line">inputText(<span class="string">&quot;\b\b\b&quot;</span>); </span><br></pre></td></tr></table></figure>

<h5 id="dialog-controls-orientations"><a href="#dialog-controls-orientations" class="headerlink" title="dialog(controls, orientations)"></a>dialog(controls, orientations)</h5><blockquote>
<p>Pop up self-defined dialog box to accept the user input. Please refer to the example for specific usage</p>
</blockquote>
<table>
<thead>
<tr>
<th>Value</th>
<th>Specification</th>
</tr>
</thead>
<tbody><tr>
<td>CONTROLLER_TYPE.LABEL</td>
<td>Text label</td>
</tr>
<tr>
<td>CONTROLLER_TYPE.INPUT</td>
<td>Input box</td>
</tr>
<tr>
<td>CONTROLLER_TYPE.PICKER</td>
<td>Picker</td>
</tr>
<tr>
<td>CONTROLLER_TYPE.SWITCH</td>
<td>Switch</td>
</tr>
<tr>
<td>CONTROLLER_TYPE.BUTTON</td>
<td>Button</td>
</tr>
<tr>
<td>CONTROLLER_TYPE.REMEMBER</td>
<td>Switch for remember user inputs</td>
</tr>
</tbody></table>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> label = &#123;<span class="built_in">type</span>=CONTROLLER_TYPE.LABEL, text=<span class="string">&quot;Would you mind to provide some personal informations?&quot;</span>&#125;</span><br><span class="line"><span class="keyword">local</span> nameInput = &#123;<span class="built_in">type</span>=CONTROLLER_TYPE.INPUT, title=<span class="string">&quot;Name:&quot;</span>, key=<span class="string">&quot;Name&quot;</span>, value=<span class="string">&quot;Bob&quot;</span>&#125;</span><br><span class="line"><span class="keyword">local</span> positionPicker = &#123;<span class="built_in">type</span>=CONTROLLER_TYPE.PICKER, title=<span class="string">&quot;Position:&quot;</span>, key=<span class="string">&quot;Position&quot;</span>, value=<span class="string">&quot;CEO&quot;</span>, options=&#123;<span class="string">&quot;CEO&quot;</span>, <span class="string">&quot;CTO&quot;</span>, <span class="string">&quot;CFO&quot;</span>, <span class="string">&quot;CXO&quot;</span>&#125; &#125;</span><br><span class="line"><span class="keyword">local</span> developerSwitch = &#123;<span class="built_in">type</span>=CONTROLLER_TYPE.SWITCH, title=<span class="string">&quot;A Developer:&quot;</span>, key=<span class="string">&quot;ADeveloper&quot;</span>, value=<span class="number">1</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- It&#x27;s an option for users to determine weather the inputs should be remembered, if you use this control in the dialog.</span></span><br><span class="line"><span class="keyword">local</span> remember = &#123;<span class="built_in">type</span>=CONTROLLER_TYPE.REMEMBER, on=<span class="literal">false</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">--[[ Define buttons:</span></span><br><span class="line"><span class="comment">type = CONTROLLER_TYPE.BUTTON</span></span><br><span class="line"><span class="comment">title = Button text</span></span><br><span class="line"><span class="comment">color = Button background color, it&#x27;s optional, the default value is 0x428BCA</span></span><br><span class="line"><span class="comment">width = Button width upon percentage of the dialog width, it&#x27;s optional, the default value is 0.5, max value is 1.0.</span></span><br><span class="line"><span class="comment">flag = Integer type of button flag for identifying which button is tapped.</span></span><br><span class="line"><span class="comment">collectInputs = Boolean type specifying wheather the dialog should collect the inputs while this button is tapped. ]]</span><span class="comment">--</span></span><br><span class="line"><span class="keyword">local</span> btn1 = &#123;<span class="built_in">type</span>=CONTROLLER_TYPE.BUTTON, title=<span class="string">&quot;Button 1&quot;</span>, color=<span class="number">0x71C69E</span>, width=<span class="number">0.8</span>, flag=<span class="number">1</span>, collectInputs=<span class="literal">false</span>&#125;</span><br><span class="line"><span class="keyword">local</span> btn2 = &#123;<span class="built_in">type</span>=CONTROLLER_TYPE.BUTTON, title=<span class="string">&quot;Button 2&quot;</span>, color=<span class="number">0xFF5733</span>, flag=<span class="number">2</span>, collectInputs=<span class="literal">true</span>&#125;</span><br><span class="line"><span class="keyword">local</span> btn3 = &#123;<span class="built_in">type</span>=CONTROLLER_TYPE.BUTTON, title=<span class="string">&quot;Button 3&quot;</span>, color=<span class="number">0xFFB7D0</span>, width=<span class="number">1.0</span>, flag=<span class="number">3</span>, collectInputs=<span class="literal">false</span>&#125;</span><br><span class="line"><span class="keyword">local</span> btn4 = &#123;<span class="built_in">type</span>=CONTROLLER_TYPE.BUTTON, title=<span class="string">&quot;Button 4&quot;</span>, width=<span class="number">1.0</span>, flag=<span class="number">4</span>, collectInputs=<span class="literal">true</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> controls = &#123;label, nameInput, positionPicker, developerSwitch, btn1, btn2, remember, btn3, btn4&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Pop up the dialog. After popping, the script will suspend waiting for user input until any button is tapped, then returns the flag of tapped button.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- What orientations the dialog could be, it&#x27;s optional</span></span><br><span class="line"><span class="keyword">local</span> orientations = &#123; ORIENTATION_TYPE.PORTRAIT &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> result = dialog(controls, orientations);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (result == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">    alert(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;name:%s, birthday:%s, gender:%d&quot;</span>, nameInput.value, positionPicker.value, developerSwitch.value))</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    alert(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;Dialog returned: %s&quot;</span>, result))</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h5 id="cleanDialogValues-script"><a href="#cleanDialogValues-script" class="headerlink" title="cleanDialogValues(script)"></a>cleanDialogValues(script)</h5><blockquote>
<p>Clear the remembered values of the dialog created by the function dialog</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- There is a dialog.lua script in the scripts list</span></span><br><span class="line">clearDialogValues(<span class="string">&quot;dialog.lua&quot;</span>);</span><br></pre></td></tr></table></figure>

<h5 id="openURL-urlString"><a href="#openURL-urlString" class="headerlink" title="openURL(urlString)"></a>openURL(urlString)</h5><blockquote>
<p>Open url, or open other apps’ url scheme</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">openURL(<span class="string">&quot;https://autotouch.net&quot;</span>)</span><br><span class="line">openURL(<span class="string">&quot;prefs:root=General&amp;path=About&quot;</span>)</span><br><span class="line">openURL(<span class="string">&quot;musics://&quot;</span>)</span><br><span class="line">openURL(<span class="string">&quot;itms-apps://itunes.apple.com&quot;</span>)</span><br><span class="line">openURL(<span class="string">&quot;tel://+1123456&quot;</span>)</span><br><span class="line">openURL(<span class="string">&quot;clashofclans://&quot;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="isLicensed"><a href="#isLicensed" class="headerlink" title="isLicensed()"></a>isLicensed()</h5><blockquote>
<p>Check if the current device is running licensed AutoTouch</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> isLicensed() <span class="keyword">then</span></span><br><span class="line">    alert(<span class="string">&quot;Your device is licensed by AutoTouch!&quot;</span>);</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h5 id="setAutoLaunch-scriptPath-on"><a href="#setAutoLaunch-scriptPath-on" class="headerlink" title="setAutoLaunch(scriptPath, on)"></a>setAutoLaunch(scriptPath, on)</h5><blockquote>
<p>Switch on/off a script as auto launch</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">setAutoLaunch(<span class="string">&quot;Records/test.lua&quot;</span>, <span class="literal">true</span>)</span><br></pre></td></tr></table></figure>

<h5 id="listAutoLaunch"><a href="#listAutoLaunch" class="headerlink" title="listAutoLaunch()"></a>listAutoLaunch()</h5><blockquote>
<p>List all auto launch scripts</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> scripts = listAutoLaunch()</span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">pairs</span>(scripts) <span class="keyword">do</span></span><br><span class="line">    alert(v);</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h5 id="stop"><a href="#stop" class="headerlink" title="stop()"></a>stop()</h5><blockquote>
<p>SStop the current script execution.</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- Exit execution</span></span><br><span class="line">stop();</span><br></pre></td></tr></table></figure>

<h5 id="ocr"><a href="#ocr" class="headerlink" title="ocr"></a>ocr</h5><p>ocr(region, languages, threshold, whitelist, blacklist, timeout, tessdataParentDir, debug)</p>
<p> 需要识别的语言，下载需要的语言到相同的目录 </p>
<p><code>/var/mobile/Library/AutoTouch/Library/tessadata</code></p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th align="center">Type</th>
<th>Specification</th>
<th align="center">Optional</th>
<th align="center">Default</th>
</tr>
</thead>
<tbody><tr>
<td>region</td>
<td align="center">table</td>
<td>What region you want to recognize text at the screen.</td>
<td align="center">YES</td>
<td align="center">Whole screen</td>
</tr>
<tr>
<td>languages</td>
<td align="center">String</td>
<td>Languages you want to recognize, by default AutoTouch has included <code>eng.traineddata</code> at <code>/var/mobile/Library/AutoTouch/Library/tessadata</code>, you may download other languages you needed to the same dir from <a href="https://github.com/tesseract-ocr/tessdata/tree/3.04.00">https://github.com/tesseract-ocr/tessdata/tree/3.04.00</a>. Somewhat you may even train your own data for <code>tesseract orc</code> and put it at <code>tessadata</code> dir.</td>
<td align="center">YES</td>
<td align="center">“eng”</td>
</tr>
<tr>
<td>threshold</td>
<td align="center">Integer</td>
<td>Threshold the image, Adjust this value to improve the accurancy. Value range is from 0 to 255.</td>
<td align="center">YES</td>
<td align="center">100</td>
</tr>
<tr>
<td>whitelist</td>
<td align="center">String</td>
<td>What characters you want to recognize in the region, such as “0123456789” will find numbers only.</td>
<td align="center">YES</td>
<td align="center">NULL</td>
</tr>
<tr>
<td>blacklist</td>
<td align="center">String</td>
<td>What characters you do not want to recognize from the region.</td>
<td align="center">YES</td>
<td align="center">NULL</td>
</tr>
<tr>
<td>timeout</td>
<td align="center">Integer</td>
<td>Timeout in seconds.</td>
<td align="center">YES</td>
<td align="center">3</td>
</tr>
<tr>
<td>tessdataParentDir</td>
<td align="center">String</td>
<td>Parent directory path of the <code>tessdata</code> directory, google to know more about <code>tessdata</code> of <code>tesseract ocr</code>. If this parameter starts with “/“, it will be treated as an absolute path, otherwise it will be treated as a relative path. The real <code>traineddata</code> files will be at <code>tessdata</code>dir inside <code>tessdataParentDir</code>. <strong>ATTENSION</strong> this parameter is the <strong>parent dir</strong> of the <code>tessdata</code> folder!!! And the folder containers traineddata files must be named <code>tessdata</code>.</td>
<td align="center">YES</td>
<td align="center"><code>/var/mobile/Library/AutoTouch/Library/</code></td>
</tr>
<tr>
<td>debug</td>
<td align="center">boolean</td>
<td>If pass debug=true, it will produce a image ends with “-Debug.PNG” marked the matching areas.</td>
<td align="center">YES</td>
<td align="center">false</td>
</tr>
</tbody></table>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- Example:</span></span><br><span class="line"><span class="keyword">local</span> result = ocr(&#123;<span class="number">100</span>, <span class="number">100</span>, <span class="number">300</span>, <span class="number">300</span>&#125;, <span class="string">&#x27;eng&#x27;</span>, <span class="number">220</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Example:</span></span><br><span class="line"><span class="keyword">local</span> result = ocr(&#123;<span class="number">100</span>, <span class="number">100</span>, <span class="number">300</span>, <span class="number">300</span>&#125;, <span class="string">&#x27;eng+fra&#x27;</span>, <span class="number">220</span>, <span class="string">&#x27;0123456789 &#x27;</span>, <span class="string">&#x27;..........&#x27;</span>, <span class="number">5</span>, <span class="literal">nil</span>, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Example:</span></span><br><span class="line"><span class="comment">-- Find English+France at the specified region with threshold 220, using the traindata in `tessdata` folder at the current directory.</span></span><br><span class="line"><span class="comment">-- Like this example, you can put the traindata inside your package project, so you can encrypt and pack them to a single bot.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--+TestOrcProject.at</span></span><br><span class="line"><span class="comment">--+----tesseract</span></span><br><span class="line"><span class="comment">--+--------eng.traindata</span></span><br><span class="line"><span class="comment">--+--------fra.traindata</span></span><br><span class="line"><span class="comment">--+----main.lua</span></span><br><span class="line"><span class="comment">--+----worker.lua</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- `./` means under current directory, it will find `tessdata` folder in current directory.</span></span><br><span class="line"><span class="keyword">local</span> result = ocr(&#123;<span class="number">100</span>, <span class="number">100</span>, <span class="number">300</span>, <span class="number">300</span>&#125;, <span class="string">&#x27;eng+fra&#x27;</span>, <span class="number">220</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="number">5</span>, <span class="string">&#x27;./&#x27;</span>, <span class="literal">true</span>)</span><br></pre></td></tr></table></figure>

<p>识别当前界面范围， 7.0.33 识别 result = nil</p>
<p>中文识别 chi_sim 死机了。。</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> result = ocr(&#123;<span class="number">80.28</span>,<span class="number">225</span>, <span class="number">176.41</span>, <span class="number">120.42</span>&#125;,<span class="string">&#x27;eng&#x27;</span>, <span class="number">220</span>, <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="number">5</span>, <span class="string">&#x27;./&#x27;</span>, <span class="literal">true</span>)</span><br></pre></td></tr></table></figure>

<h5 id="recognizeText"><a href="#recognizeText" class="headerlink" title="recognizeText()"></a>recognizeText()</h5><blockquote>
<p>Recognize text on the screen</p>
</blockquote>
<p>7.0.33 版本不支持 recognizeText</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- Recognize text on the screen or a specified region</span></span><br><span class="line"><span class="comment">-- recognizeText(region, customWords, minimumTextHeight, level, languages, correct, debug)</span></span><br><span class="line"><span class="comment">-- @param &#123;region&#125; - specified the region to recognize text</span></span><br><span class="line"><span class="comment">-- @param &#123;customWords&#125; - an array of strings to supplement the recognized languages at the word recognition stage.</span></span><br><span class="line"><span class="comment">-- @param &#123;minimumTextHeight&#125; - the minimum height of the text expected to be recognized, relative to the region/screen height, default is 1/32.</span></span><br><span class="line"><span class="comment">-- @param &#123;level&#125; - 0 means accurate first, 1 means speed first</span></span><br><span class="line"><span class="comment">-- @param &#123;languages&#125; - an array of languages to detect, in priority order, only `en-US` supported now. ISO language codes: http://www.lingoes.net/en/translator/langcode.htm. Use function `at.recognizeTextSupportedLanguages()` of `JavaScript` API to get the supported languages</span></span><br><span class="line"><span class="comment">-- @param &#123;correct&#125; - whether use language correction during the recognition process.</span></span><br><span class="line"><span class="comment">-- @param &#123;debug&#125; - whether you want to produce debug image</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> region = &#123;<span class="number">10</span>, <span class="number">20</span>, <span class="number">500</span>, <span class="number">600</span>&#125;; <span class="comment">-- nil for default means hole screen, </span></span><br><span class="line"><span class="keyword">local</span> customWords = <span class="literal">nil</span>; <span class="comment">-- nil for default, or something like [&#x27;Deploy&#x27;, &#x27;Troops&#x27;]</span></span><br><span class="line"><span class="keyword">local</span> minimumTextHeight = <span class="literal">nil</span>; <span class="comment">-- nil for default</span></span><br><span class="line"><span class="keyword">local</span> level = <span class="literal">nil</span>; <span class="comment">-- nil for default means value 0</span></span><br><span class="line"><span class="keyword">local</span> languages = <span class="literal">nil</span>; <span class="comment">-- nil for default, or something like [&#x27;en-US&#x27;, &quot;fr-FR&quot;, &#x27;zh-Hans&#x27;].</span></span><br><span class="line"><span class="keyword">local</span> correct = <span class="literal">nil</span>; <span class="comment">-- nil for default value false</span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">debug</span> = <span class="literal">nil</span>; <span class="comment">-- nil for default value false</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> result = recognizeText(region, customWords, minimumTextHeight, level, languages, correct, <span class="built_in">debug</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Got result of recognizeText:</span></span><br><span class="line"><span class="comment">-- &#123;</span></span><br><span class="line"><span class="comment">--     &#123;</span></span><br><span class="line"><span class="comment">--         &quot;text&quot;: &quot;Example&quot;,</span></span><br><span class="line"><span class="comment">--         &quot;rectangle&quot;: &#123;</span></span><br><span class="line"><span class="comment">--             &quot;bottomRight&quot;: &#123;</span></span><br><span class="line"><span class="comment">--                 &quot;x&quot;: 300.47,</span></span><br><span class="line"><span class="comment">--                 &quot;y&quot;: 177.78</span></span><br><span class="line"><span class="comment">--             &#125;,</span></span><br><span class="line"><span class="comment">--             &quot;topRight&quot;: &#123;</span></span><br><span class="line"><span class="comment">--                 &quot;x&quot;: 300.47,</span></span><br><span class="line"><span class="comment">--                 &quot;y&quot;: 237.52</span></span><br><span class="line"><span class="comment">--             &#125;,</span></span><br><span class="line"><span class="comment">--             &quot;topLeft&quot;: &#123;</span></span><br><span class="line"><span class="comment">--                 &quot;x&quot;: 33.51,</span></span><br><span class="line"><span class="comment">--                 &quot;y&quot;: 237.42</span></span><br><span class="line"><span class="comment">--             &#125;,</span></span><br><span class="line"><span class="comment">--             &quot;bottomLeft&quot;: &#123;</span></span><br><span class="line"><span class="comment">--                 &quot;x&quot;: 33.51,</span></span><br><span class="line"><span class="comment">--                 &quot;y&quot;: 177.68</span></span><br><span class="line"><span class="comment">--             &#125;</span></span><br><span class="line"><span class="comment">--         &#125;</span></span><br><span class="line"><span class="comment">--     &#125;</span></span><br><span class="line"><span class="comment">-- &#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="appInfo-appidentifier"><a href="#appInfo-appidentifier" class="headerlink" title="appInfo(appidentifier)"></a>appInfo(appidentifier)</h5><blockquote>
<p>Get the speficied App’s displayName,executablePath,bundleContainerPath,dataContainerPath</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> result = appInfo(<span class="string">&quot;com.apple.mobilesafari&quot;</span>)</span><br><span class="line">alert(<span class="built_in">table</span>.<span class="built_in">tostring</span>(result))</span><br></pre></td></tr></table></figure>

<h5 id="setTimer-scriptPath-fireTime-repeat-interval"><a href="#setTimer-scriptPath-fireTime-repeat-interval" class="headerlink" title="setTimer(scriptPath, fireTime, repeat, interval)"></a>setTimer(scriptPath, fireTime, repeat, interval)</h5><blockquote>
<p>Set timer for a script</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- trigger after 1000 seconds</span></span><br><span class="line"><span class="keyword">local</span> done = setTimer(<span class="string">&quot;Records/test.lua&quot;</span>, <span class="number">1000</span>, <span class="literal">false</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">-- Equals to</span></span><br><span class="line">const done = at.setTimer(<span class="string">&quot;/var/mobile/Library/AutoTouch/Scripts/Records/test.lua&quot;</span>, <span class="number">1000</span>, <span class="literal">false</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- trigger at 2019-09-17 08:12:52 and repeat every 10000 seconds</span></span><br><span class="line"><span class="keyword">local</span> done = setTimer(<span class="string">&quot;Records/test.lua&quot;</span>, <span class="string">&quot;2019-09-17 08:12:52&quot;</span>, <span class="literal">true</span>, <span class="number">10000</span>);</span><br></pre></td></tr></table></figure>

<h5 id="removeTimer-scriptPath"><a href="#removeTimer-scriptPath" class="headerlink" title="removeTimer(scriptPath)"></a>removeTimer(scriptPath)</h5><blockquote>
<p>Remove timer of a script</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> done = removeTimer(<span class="string">&quot;/Records/test.lua&quot;</span>);</span><br></pre></td></tr></table></figure>

<h5 id="keepAutoTouchAwake-keepAwake"><a href="#keepAutoTouchAwake-keepAwake" class="headerlink" title="keepAutoTouchAwake(keepAwake)"></a>keepAutoTouchAwake(keepAwake)</h5><blockquote>
<p>Keep AutoTouch awake aginst iOS idle sleep</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">keepAutoTouchAwake(<span class="literal">true</span>)</span><br></pre></td></tr></table></figure>



<h4 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h4><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> socket = <span class="built_in">require</span>(<span class="string">&quot;socket&quot;</span>)</span><br><span class="line"><span class="comment">-- 获取时间戳</span></span><br><span class="line"><span class="built_in">log</span>(<span class="built_in">os</span>.<span class="built_in">time</span>())        <span class="comment">-- 1632985348</span></span><br><span class="line"><span class="built_in">log</span>(socket.gettime()) <span class="comment">-- 1632985348.2712</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sleep</span><span class="params">(n)</span></span></span><br><span class="line">   socket.<span class="built_in">select</span>(<span class="literal">nil</span>, <span class="literal">nil</span>, n)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 休眠0.1秒</span></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">usleep(<span class="number">100000</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>













<p><a href="http://www.lua.org/manual/5.3/">Lua Official Reference Manual</a></p>
]]></content>
  </entry>
  <entry>
    <title>Core Audio</title>
    <url>/2021/08/06/Core-Audio/</url>
    <content><![CDATA[<h4 id="Core-Audio"><a href="#Core-Audio" class="headerlink" title="Core Audio"></a>Core Audio</h4><p>Core Audio 结构分层（<a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/CoreAudioOverview/CoreAudioEssentials/CoreAudioEssentials.html#//apple_ref/doc/uid/TP40003577-CH10-SW1">官方文档</a>）</p>
<img src="API Architectural Layers.png" alt="Architectural Layers"/>

<ul>
<li>Low-Level Services：底层跟硬件打交道</li>
</ul>
<p>I/O Kit：与硬件驱动交互<br>Audio HAL：音频硬件抽象层，使API调用与实际硬件相分离<br>Core MIDI：提供与MIDI（乐器数字接口）设备（包括硬件键盘和合成器）进行通信的API<br>Host Time Services：访问硬件时钟</p>
<ul>
<li>Mid-Level Services：Core Audio 中的中间层包括用于数据格式转换、读写磁盘、解析流和使用插件的服务</li>
</ul>
<p>Audio Convert Services：负责音频数据格式的转换<br>Audio File Services：负责音频数据读写<br>Audio Unit Services 和 Audio Processing Graph Services 使应用程序可以使用数字信号处理（DSP）插件，例如均衡器和混频器<br>Core Audio Clock Services：用于音频和MIDI同步以及时间格式管理<br>Audio File Stream Services：创建可以解析流的应用程序，负责流解析，对音频进行解码</p>
<ul>
<li>High-Level Services</li>
</ul>
<p>AVAudioPlayer：高级接口，可以完成整个音频播放的过程<br>Audio Queue Services：录制、播放、暂停、循环、同步音频<br>Extended Audio File Services：Audio File Services 和 Audio Converter services的结合体<br>OpenAL：游戏音频</p>
<h4 id="Audio-Session"><a href="#Audio-Session" class="headerlink" title="Audio Session"></a>Audio Session</h4><p><a href="https://links.jianshu.com/go?to=https://developer.apple.com/library/archive/documentation/Audio/Conceptual/AudioSessionProgrammingGuide/Introduction/Introduction.html%23//apple_ref/doc/uid/TP40007875-CH1-SW1">官方文档 Audio Session Programming Guide</a></p>
<img src="Audio Session.png" alt="Audio Session" style="zoom:60%;" />

<p>可以使用 AVAudioSession 实例与应用程序的音频会话进行交互</p>
<ul>
<li>配置音频会话的类别和模式，告诉系统如何使用音频</li>
<li>激活音频会话使设置的类别和模式使设置生效</li>
<li>订阅并响应音频会话通知，例如音频中断和路由更改</li>
<li>执行高级别的音频设备配置，例如采样率，I/O缓冲持续时间和通道数</li>
</ul>
<h5 id="配置-Audio-Session"><a href="#配置-Audio-Session" class="headerlink" title="配置 Audio Session"></a>配置 Audio Session</h5><p>Audio Session 默认行为</p>
<ul>
<li>支持音频播放，但不允许录音</li>
<li>iOS中，将”铃声/静音”开关设置为静音模式会使应用播放的任何音频静音</li>
<li>iOS中，将设备锁定时，应用程序的音频将静音</li>
<li>当你的应用播放音频时，其他任何背景音频（如音乐应用正在播放的音频）都将静音</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let session &#x3D; AVAudioSession.sharedInstance()</span><br><span class="line">do &#123;</span><br><span class="line">    try session.setCategory(.playback, mode: .moviePlayback, options: [])</span><br><span class="line">&#125; catch let error as NSError &#123;</span><br><span class="line">    print(&quot;Failed to set the audio session category and mode: \(error.localizedDescription)&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Category 设置音频的基本行为，可以通过设置 Mode 进一步设置这些行为</p>
<p>例如：IP电话（VoIP）Category设置为 AVAudioSessionCategoryPlayAndRecord，Mode 设置为 AVAudioSessionModeVoiceChat 此模式可确保通过系统提供的信号处理来优化语音信号</p>
<p>某些Category通过会话上设置一个或多个Category选项来支持覆盖默认行为，如AVAudioSessionCategoryPlayback 类别的默认行为会在激活会话时中断其他系统音频，如果您希望音频与其他系统音频混合，则可以通过 AVAudioSessionCategoryOptionMixWithOthers 在会话上设置选项来覆盖此行为</p>
<img src="Category behavior.jpg" alt="Category behavior"/>

<p>大多数应用在启动时只需要设置一次Category，但可以根据需要更改Category，可以在音频会话处于激活状态进行更改，最好在更改Category或者其他会话属性前停用音频会话，停用会话的同时进行这些更改可以防止音频系统不必要的重新配置</p>
<img src="AudioSession mode.png" alt="AudioSession mode"/>

<h6 id="Multiroute-Category"><a href="#Multiroute-Category" class="headerlink" title="Multiroute Category"></a>Multiroute Category</h6><p>多路由Category使应用程序可以使用所有连接的输出端口，而不仅仅使用最后的使用端口</p>
<p>例如，你正在通过HDMI输出路径收听音频并插入耳机，则你的应用将继续通过HDMI输出路径输出音频，同时还通过耳机播放音频</p>
<p>还可以将不同的音频流发送到不同的输出路由，例如，应用可以将一个音频发送到左耳机，将另一个音频发送到右耳机，将第三个音频流发送到HDMI路由</p>
<img src="multiroute.png" alt="multiroute" style="zoom:50%;" />

<p>有效输出路径组合</p>
<ul>
<li>USB和耳机</li>
<li>HDMI和耳机</li>
<li>LineOut和耳机</li>
</ul>
<p>注：仅当未连接任何其他输出端口（USB，HDMI，LineOut）时，才可以使用内置扬声器</p>
<h6 id="选择AirPlay的Category和mode"><a href="#选择AirPlay的Category和mode" class="headerlink" title="选择AirPlay的Category和mode"></a>选择AirPlay的Category和mode</h6><p>仅特定Category和mode支持AirPlay，以下类别通知支持AirPlay的镜像和非镜像版本</p>
<ul>
<li>AVAudioSessionCategorySoloAmbient</li>
<li>AVAudioSessionCategoryAmbient</li>
<li>AVAudioSessionCategoryPlayback<br>AVAudioSessionCategoryPlayAndRecord 类别和以下mode仅支持AirPlay镜像版本</li>
<li>AVAudioSessionModeDefault</li>
<li>AVAudioSessionModeVideoChat</li>
<li>AVAudioSessionModeGameChat</li>
</ul>
<p>注：从 iOS 10 开始，您可以在使用 AVAudioSessionCategoryPlayAndRecord 类别时通过使用 AVAudioSessionCategoryOptionAllowAirPlay 选项激活会话来启用 AirPlay 输出</p>
<h6 id="背景音频"><a href="#背景音频" class="headerlink" title="背景音频"></a>背景音频</h6><p>Capabilities 打开 Background Modes 的 Audio,AirPlay,and Picture in Picture</p>
<h5 id="激活-Audio-Session"><a href="#激活-Audio-Session" class="headerlink" title="激活 Audio Session"></a>激活 Audio Session</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let session &#x3D; AVAudioSession.sharedInstance()</span><br><span class="line">do &#123;</span><br><span class="line">    &#x2F;&#x2F; 1) Configure your audio session category, options, and mode</span><br><span class="line">    &#x2F;&#x2F; 2) Activate your audio session to enable your custom configuration</span><br><span class="line">    try session.setActive(true, options: [])</span><br><span class="line">&#125; catch let error as NSError &#123;</span><br><span class="line">    print(&quot;Unable to activate audio session:  \(error.localizedDescription)&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用AVFoundation对象（AVPlayer，AVAudioRecoder）播放或录制音频时，系统会在中断结束时重新激活音频会话，但是如果注册了通知消息并显式重新激活音频会话，则可以验证重新激活成功，还可以更新应用程序的状态和用户界面</p>
<h6 id="检测是否正在播放其他音频"><a href="#检测是否正在播放其他音频" class="headerlink" title="检测是否正在播放其他音频"></a>检测是否正在播放其他音频</h6><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">func setupNotification() &#123;</span><br><span class="line">    NotificationCenter.default.addObserver(self,</span><br><span class="line">             selector: #selector(handleSecondaryAudio(notification:)),</span><br><span class="line">             name: AVAudioSession.silenceSecondaryAudioHintNotification,</span><br><span class="line">             object: AVAudioSession.sharedInstance())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@objc func handleSecondaryAudio(notification: Notification) &#123;</span><br><span class="line">    guard let userinfo &#x3D; notification.userInfo ,</span><br><span class="line">    let typeValue &#x3D; userinfo[AVAudioSessionSilenceSecondaryAudioHintTypeKey] as? UInt,</span><br><span class="line">    let type &#x3D; AVAudioSession.SilenceSecondaryAudioHintType(rawValue: typeValue) else &#123;</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line">    if type &#x3D;&#x3D; .begin &#123;</span><br><span class="line">        &#x2F;&#x2F;其他应用音频开始播放 - 将辅助音频静音</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        &#x2F;&#x2F;其他应用音频停止播放 - 重新启动辅助音频</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="响应中断"><a href="#响应中断" class="headerlink" title="响应中断"></a>响应中断</h6><p>你的应用程序可能会中断后暂停，当发生接听电话时，系统会发出中断结束消息，你的应用将继续运行，要恢复音频，必须重新激活音频会话</p>
<img src="Interruption.png" alt="Interruption" style="zoom:60%;" />

<ol>
<li>应用处于活跃状态，正在播放音频</li>
<li>FaceTime请求到达，系统激活FaceTime的音频会话</li>
<li>系统将停用你的音频会话，此时你的应用播放停止</li>
<li>系统发布通知，通知你的会话已被停用</li>
<li>你的应用处理通知，如更新界面保存停止播放点继续播放所需的信息</li>
<li>如果用户取消中断（忽略FaceTime请求），系统发送通知我们应用中断结束</li>
<li>你的应用处理中断结束操作，如更新界面重新激活音频会话并恢复播放</li>
<li>如果没有6的中断，而是接听了电话，你的应用将被暂停</li>
</ol>
<ul>
<li>音频中断处理<br>中断开始后：保存状态和上下文，更新用户界面<br>中断结束后：恢复状态和上下文，更新用户界面，重新激活音频会话</li>
</ul>
<ul>
<li>观察音频中断 </li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">func registerForNotification() &#123;</span><br><span class="line">    NotificationCenter.default.addObserver(self, selector: #selector(handleInterruption(notification:)),</span><br><span class="line">                                           name: AVAudioSession.interruptionNotification,</span><br><span class="line">                                           object: AVAudioSession.sharedInstance())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@objc func handleInterruption(notification: Notification) &#123;</span><br><span class="line">    guard let userinfo &#x3D; notification.userInfo,</span><br><span class="line">          let typeValue &#x3D; userinfo[AVAudioSessionInterruptionTypeKey] as? UInt,</span><br><span class="line">          let type &#x3D; AVAudioSession.InterruptionType(rawValue: typeValue) else &#123;</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line">    if type &#x3D;&#x3D; .began &#123;</span><br><span class="line">        &#x2F;&#x2F;中断开始 采取适当措施（保存状态更新界面）</span><br><span class="line">    &#125; else if type &#x3D;&#x3D; .ended &#123;</span><br><span class="line">        guard let optionsValue &#x3D; userinfo[AVAudioSessionInterruptionOptionKey] as? UInt else &#123;</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">        let options &#x3D; AVAudioSession.InterruptionOptions(rawValue: optionsValue)</span><br><span class="line">        if options.contains(.shouldResume) &#123;</span><br><span class="line">            &#x2F;&#x2F;中断结束 恢复播放</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="响应路由变更"><a href="#响应路由变更" class="headerlink" title="响应路由变更"></a>响应路由变更</h6><p>当用户插入或拔出耳机时，系统会自动更改音频硬件路由</p>
<img src="routechange.png" alt="routechange" style="zoom:60%;" />

<p>你的应用启动后，系统会首先确定音频路由，应用运行时，它将继续监听活动路由</p>
<p>录制期间，用户可以插入和拔出耳机，作为响应，系统发送包含更改原因和先前路由的路由更改通知，应用停止录制</p>
<ul>
<li>观察音频路由变更</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">func setupNotification() &#123;</span><br><span class="line">    NotificationCenter.default.addObserver(self, </span><br><span class="line">         selector: #selector(handleRouteChange(notification:)),</span><br><span class="line">         name: AVAudioSession.routeChangeNotification,</span><br><span class="line">         object: AVAudioSession.sharedInstance())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@objc func handleRouteChange(notification: Notification) &#123;</span><br><span class="line">    guard let userinfo &#x3D; notification.userInfo,</span><br><span class="line">          let reasonValue &#x3D; userinfo[AVAudioSessionRouteChangeReasonKey] as? UInt,</span><br><span class="line">          let reason &#x3D; AVAudioSession.RouteChangeReason(rawValue: reasonValue) else &#123;</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line">    switch reason &#123;</span><br><span class="line">    case .newDeviceAvailable:</span><br><span class="line">        print(&quot;处理可用新设备&quot;)</span><br><span class="line">        let session &#x3D; AVAudioSession.sharedInstance()</span><br><span class="line">        for output in session.currentRoute.outputs where output.portType &#x3D;&#x3D; AVAudioSessionPortHeadphones &#123;</span><br><span class="line">            &#x2F;&#x2F;耳机连接true</span><br><span class="line">            headphonesConnected &#x3D; true</span><br><span class="line">        &#125;</span><br><span class="line">    case .oldDeviceUnavailable:</span><br><span class="line">        print(&quot;处理旧设备&quot;)</span><br><span class="line">        if let previousRoute &#x3D;</span><br><span class="line">            userInfo[AVAudioSessionRouteChangePreviousRouteKey] as? AVAudioSessionRouteDescription &#123;</span><br><span class="line">            for output in previousRoute.outputs where output.portType &#x3D;&#x3D; AVAudioSessionPortHeadphones &#123;</span><br><span class="line">                &#x2F;&#x2F;耳机连接false</span><br><span class="line">                headphonesConnected &#x3D; false</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    default:</span><br><span class="line">        ()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当有新设备时，可以查询音频会话currentRoute属性，返回AVAudioSessionRouteDescription对象，其中列出了音频会话的所有输入和输出</p>
<p>如果路由更改原因是原因 AVAudioSessionRouteChangeReasonOldDeviceUnavailable ，则媒体播放应用应暂停播放，但如果原因是，则不应暂停播放 AVAudioSessionRouteChangeReasonOverride</p>
<p>配置设备硬件</p>
<table>
<thead>
<tr>
<th>设置</th>
<th align="center">首选采样率</th>
<th align="left">首选I/O缓冲区持续时间</th>
</tr>
</thead>
<tbody><tr>
<td>High value</td>
<td align="center">示例：48Hz +高音质 -大文件或缓冲区大小</td>
<td align="left">示例：500ms +较少的文件访问 -更长的延迟</td>
</tr>
<tr>
<td>Low value</td>
<td align="center">示例：8Hz +大文件或缓冲区大小 -低音频质量</td>
<td align="left">示例：5ms +低延迟 -频繁的文件访问</td>
</tr>
</tbody></table>
<p>如果音频质量在你应用中非常重要，并且文件或缓冲区的大小不是主要问题，则可以指定高采样率的首选项</p>
<p>默认音频I/O缓存持续时间（44.1kHz约0.02s）为大多数应用提供了足够的响应速度，可以对延迟有严格要求的应用（如现场乐器监控）设置较低的I/O持续时间，但对大多数应用，无需修改此设置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;Category and mode</span><br><span class="line">let session &#x3D; AVAudioSession.sharedInstance()</span><br><span class="line">do &#123;</span><br><span class="line">    try session.setCategory(.record, mode: .default, options: [])</span><br><span class="line">&#125; catch &#123;</span><br><span class="line">    print(&quot;Unable to set Category: \(error.localizedDescription)&quot;)</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;Set preferred sample rate</span><br><span class="line">do &#123;</span><br><span class="line">    try session.setPreferredSampleRate(44_100)</span><br><span class="line">&#125; catch &#123;</span><br><span class="line">    print(&quot;Unable to set preferred sample rate \(error.localizedDescription)&quot;)</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;Set preferred I&#x2F;O buffer duration</span><br><span class="line">do &#123;</span><br><span class="line">    try session.setPreferredIOBufferDuration(0.005)</span><br><span class="line">&#125; catch &#123;</span><br><span class="line">    print(&quot;Unable to set preferred I&#x2F;O bufferr duration \(error.localizedDescription)&quot;)</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;Active the audio session</span><br><span class="line">do &#123;</span><br><span class="line">    try session.setActive(true)</span><br><span class="line">&#125; catch &#123;</span><br><span class="line">    print(&quot;Unable to active session \(error.localizedDescription)&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="选择和配置麦克风"><a href="#选择和配置麦克风" class="headerlink" title="选择和配置麦克风"></a>选择和配置麦克风</h6><ul>
<li>设置首选输入 Setting a Preferred Input<br>要发现内置或已连接的输入端口，使用音频会话的<code>availableInputs</code>属性，返回一个<code>AVAudioSessionPortDescription</code>对象数组，这些对象描述设备的可用输入端口，可用通过端口<code>protType</code>属性标识端口，要设置首选输入端口（内置麦克风，有线麦克风，USB输入等）使用音频会话的<code>setPreferredInput:error:</code>方法</li>
<li>设置首选数据源 Setting a Preferred Data Source<br>某些端口（如内置麦克风和某些USB附件）支持数据源，可用通过查询端口描述的<code>DataSource</code>属性发现可用数据源。<br>对于内置麦克风，返回的数据源描述对象代表每个单独的麦克风，不同设备的内置麦克风返回不同的值。如<code>iPhone4</code>和<code>iPhone4s</code>有两个麦克风：底部和顶部<br>可通过数据源描述的<code>location</code>属性（上部下部）和<code>orientation</code>属性（正面背面）的组合来标识各个内置麦克风，使用<code>setPreferredDataSource:error:</code>方法设置首选数据源<code>AVAudioSessionPortDescription</code></li>
<li>设置首选极性模式 Setting a Preferred Polar Pattern<br>某些iOS设备支持为某些内置麦克风配置麦克风极性模式，麦克风的极性模式定义了其对声音相对于声源方向的灵敏度<br><code>supportedPolarPatterns</code>数据源描述对象的属性返回可用模式。此属性返回数据源支持的极性图案的数组，例如心形或全向，或者<code>nil</code>在没有可用的可选图案时返回。如果数据源具有许多受支持的极性图案，则可以使用数据源描述的<code>[setPreferredPolarPattern:error:</code>方法来设置首选的极性图案</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; Preferred Mic &#x3D; Front, Preferred Polar Pattern &#x3D; Cardioid</span><br><span class="line">let preferredMicOrientation &#x3D; AVAudioSession.Orientation.front</span><br><span class="line">let preferredPolarPattern   &#x3D; AVAudioSession.PolarPattern.cardioid</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Retrieve your configured and activated audio session</span><br><span class="line">let session &#x3D; AVAudioSession.sharedInstance()</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Get available inputs</span><br><span class="line">guard let inputs &#x3D; session.availableInputs else &#123; return &#125;</span><br><span class="line"> </span><br><span class="line">&#x2F;&#x2F; Find built-in mic</span><br><span class="line">guard let builtInMic &#x3D; inputs.first(where: &#123;</span><br><span class="line">    $0.portType &#x3D;&#x3D; AVAudioSession.Port.builtInMic</span><br><span class="line">&#125;) else &#123; return &#125;</span><br><span class="line"> </span><br><span class="line">&#x2F;&#x2F; Find the data source at the specified orientation</span><br><span class="line">guard let dataSource &#x3D; builtInMic.dataSources?.first (where: &#123;</span><br><span class="line">    $0.orientation &#x3D;&#x3D; preferredMicOrientation</span><br><span class="line">&#125;) else &#123; return &#125;</span><br><span class="line"> </span><br><span class="line">&#x2F;&#x2F; Set data source&#39;s polar pattern</span><br><span class="line">do &#123;</span><br><span class="line">    try dataSource.setPreferredPolarPattern(preferredPolarPattern)</span><br><span class="line">&#125; catch let error as NSError &#123;</span><br><span class="line">    print(&quot;Unable to preferred polar pattern: \(error.localizedDescription)&quot;)</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">&#x2F;&#x2F; Set the data source as the input&#39;s preferred data source</span><br><span class="line">do &#123;</span><br><span class="line">    try builtInMic.setPreferredDataSource(dataSource)</span><br><span class="line">&#125; catch let error as NSError &#123;</span><br><span class="line">    print(&quot;Unable to preferred dataSource: \(error.localizedDescription)&quot;)</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">&#x2F;&#x2F; Set the built-in mic as the preferred input</span><br><span class="line">&#x2F;&#x2F; This call will be a no-op if already selected</span><br><span class="line">do &#123;</span><br><span class="line">    try session.setPreferredInput(builtInMic)</span><br><span class="line">&#125; catch let error as NSError &#123;</span><br><span class="line">    print(&quot;Unable to preferred input: \(error.localizedDescription)&quot;)</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">&#x2F;&#x2F; Print Active Configuration</span><br><span class="line">session.currentRoute.inputs.forEach &#123; portDesc in</span><br><span class="line">    print(&quot;Port: \(portDesc.portType)&quot;)</span><br><span class="line">    if let ds &#x3D; portDesc.selectedDataSource &#123;</span><br><span class="line">        print(&quot;Name: \(ds.dataSourceName)&quot;)</span><br><span class="line">        print(&quot;Polar Pattern: \(ds.selectedPolarPattern) ?? [None]&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="保护隐私"><a href="#保护隐私" class="headerlink" title="保护隐私"></a>保护隐私</h5><p>录制音频前询问并获得用户许可</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">AVAudioSession.sharedInstance().requestRecordPermission &#123; granted in</span><br><span class="line">    if granted &#123;</span><br><span class="line">        &#x2F;&#x2F; User granted access. Present recording interface.</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        &#x2F;&#x2F; Present message to user indicating that recording</span><br><span class="line">        &#x2F;&#x2F; can&#39;t be performed until they change their preference</span><br><span class="line">        &#x2F;&#x2F; under Settings -&gt; Privacy -&gt; Microphone</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问麦克风 Info.plist 添加 NSMicrophoneUsageDescription </p>
]]></content>
  </entry>
  <entry>
    <title>Dart</title>
    <url>/2022/02/09/Dart/</url>
    <content><![CDATA[<h3 id="基础语法"><a href="#基础语法" class="headerlink" title="基础语法"></a>基础语法</h3><ul>
<li>Hello Dart</li>
</ul>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="comment">//main标准写法</span></span><br><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&#x27;Hello World!&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//dart中void类型，作为函数返回值类型可以省略</span></span><br><span class="line">main() &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&#x27;Hello World!&#x27;</span>);  </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//如果函数内部只有一个表达式，可以省略大括号，使用&quot;=&gt;&quot;箭头函数; </span></span><br><span class="line"><span class="keyword">void</span> main() =&gt; <span class="built_in">print</span>(<span class="string">&#x27;Hello World!&#x27;</span>);</span><br><span class="line"><span class="comment">//最简写形式</span></span><br><span class="line">main() =&gt; <span class="built_in">print</span>(<span class="string">&#x27;Hello World!&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="二-数据类型"><a href="#二-数据类型" class="headerlink" title="二. 数据类型"></a>二. 数据类型</h4><h5 id="1-布尔类型-bool"><a href="#1-布尔类型-bool" class="headerlink" title="1. 布尔类型 bool"></a>1. 布尔类型 bool</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">bool</span> isClosed = <span class="keyword">true</span>;</span><br><span class="line"><span class="built_in">bool</span> isOpened = <span class="keyword">false</span>;</span><br></pre></td></tr></table></figure>

<h5 id="2-数字类型-num、int、double"><a href="#2-数字类型-num、int、double" class="headerlink" title="2. 数字类型 num、int、double"></a>2. 数字类型 num、int、double</h5><p>flutter 中 num、int、double 都是类，int、double 都继承 num 抽象类</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">double</span> pi = <span class="number">3.1415926</span>;</span><br><span class="line"><span class="built_in">int</span> width = <span class="number">4</span>;</span><br><span class="line"><span class="built_in">int</span> height = <span class="number">3</span>;</span><br><span class="line"><span class="built_in">print</span>(width / height);  <span class="comment">//1.3333333</span></span><br><span class="line"><span class="built_in">print</span>(width ~/ height); <span class="comment">//1 整除</span></span><br></pre></td></tr></table></figure>

<p>dart 一些数字常用函数</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="number">3.141592653</span>.toStringAsFixed(<span class="number">3</span>)); <span class="comment">//3.142 保留有效数字</span></span><br><span class="line"><span class="built_in">print</span>(<span class="number">6.6</span>.floor());<span class="comment">//6向下取整</span></span><br><span class="line"><span class="built_in">print</span>((<span class="number">-6.6</span>).ceil()); <span class="comment">//-6 向上取整</span></span><br><span class="line"><span class="built_in">print</span>(<span class="number">9.9</span>.ceil()); <span class="comment">//10 向上取整</span></span><br><span class="line"><span class="built_in">print</span>(<span class="number">666.6</span>.round()); <span class="comment">//667 四舍五入</span></span><br><span class="line"><span class="built_in">print</span>((<span class="number">-666.6</span>).abs()); <span class="comment">// 666.6 取绝对值</span></span><br><span class="line"><span class="built_in">print</span>(<span class="number">666.6</span>.toInt()); <span class="comment">//666 转化成int,这中toInt、toDouble和Kotlin类似</span></span><br><span class="line"><span class="built_in">print</span>(<span class="number">999.</span>isEven); <span class="comment">//false 是否是偶数</span></span><br><span class="line"><span class="built_in">print</span>(<span class="number">999.</span>isOdd); <span class="comment">//true 是否是奇数</span></span><br><span class="line"><span class="built_in">print</span>(<span class="number">666.6</span>.toString()); <span class="comment">//666.6 转化成字符串</span></span><br></pre></td></tr></table></figure>

<h5 id="3-字符串-String"><a href="#3-字符串-String" class="headerlink" title="3. 字符串 String"></a>3. 字符串 String</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">String</span> name = <span class="string">&#x27;Hello Dart!&#x27;</span>;<span class="comment">//单引号</span></span><br><span class="line"><span class="built_in">String</span> title = <span class="string">&quot;&#x27;Hello Dart!&#x27;&quot;</span>;<span class="comment">//双引号</span></span><br><span class="line"><span class="built_in">String</span> description = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">      Hello Dart! Hello Dart!</span></span><br><span class="line"><span class="string">      Hello Dart!</span></span><br><span class="line"><span class="string">      Hello Dart! Hello Dart!</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>;<span class="comment">//三引号</span></span><br><span class="line"><span class="built_in">num</span> value = <span class="number">2</span>;</span><br><span class="line"><span class="built_in">String</span> result = <span class="string">&quot;The result is <span class="subst">$value</span>&quot;</span>;<span class="comment">//单值引用</span></span><br><span class="line"><span class="built_in">num</span> width = <span class="number">200</span>;</span><br><span class="line"><span class="built_in">num</span> height = <span class="number">300</span>;</span><br><span class="line"><span class="built_in">String</span> square = <span class="string">&quot;The square is <span class="subst">$&#123;width * height&#125;</span>&quot;</span>;<span class="comment">//表达式的值引用</span></span><br></pre></td></tr></table></figure>

<p>字符串操作方法</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">String</span> url = <span class="string">&quot;https://mrale.ph/dartvm/&quot;</span>;</span><br><span class="line"><span class="built_in">print</span>(url.split(<span class="string">&quot;://&quot;</span>)[<span class="number">0</span>]); <span class="comment">//字符串分割split方法，https</span></span><br><span class="line"><span class="built_in">print</span>(url.substring(<span class="number">3</span>, <span class="number">9</span>)); <span class="comment">//字符串截取substring方法，ps://m</span></span><br><span class="line"><span class="built_in">print</span>(url.codeUnitAt(<span class="number">0</span>)); <span class="comment">//取当前索引位置字符的UTF-16码，104</span></span><br><span class="line"><span class="built_in">print</span>(url.startsWith(<span class="string">&quot;https&quot;</span>)); <span class="comment">//当前字符串是否以指定字符开头，true</span></span><br><span class="line"><span class="built_in">print</span>(url.endsWith(<span class="string">&quot;/&quot;</span>)); <span class="comment">//当前字符串是否以指定字符结尾，true</span></span><br><span class="line"><span class="built_in">print</span>(url.toUpperCase()); <span class="comment">//大写</span></span><br><span class="line"><span class="built_in">print</span>(url.toLowerCase()); <span class="comment">//小写</span></span><br><span class="line"><span class="built_in">print</span>(url.indexOf(<span class="string">&quot;ph&quot;</span>)); <span class="comment">//获取指定字符的索引位置，14</span></span><br><span class="line"><span class="built_in">print</span>(url.contains(<span class="string">&quot;http&quot;</span>)); <span class="comment">//字符串是否包含指定字符，true</span></span><br><span class="line"><span class="built_in">print</span>(url.trim()); <span class="comment">//去除字符串的首尾空格</span></span><br><span class="line"><span class="built_in">print</span>(url.length); <span class="comment">//获取字符串长度，24</span></span><br><span class="line"><span class="built_in">print</span>(url.replaceFirst(<span class="string">&quot;t&quot;</span>, <span class="string">&quot;A&quot;</span>)); <span class="comment">//替换第一次出现t字符位置的字符</span></span><br><span class="line"><span class="built_in">print</span>(url.replaceAll(<span class="string">&quot;m&quot;</span>, <span class="string">&quot;M&quot;</span>)); <span class="comment">//全部替换</span></span><br></pre></td></tr></table></figure>

<h5 id="4-类型检查和强制类型转换-as"><a href="#4-类型检查和强制类型转换-as" class="headerlink" title="4. 类型检查和强制类型转换 as"></a>4. 类型检查和强制类型转换 as</h5><p>通过 is 关键字来对类型进行检查 as 关键字对类型进行强制转换，判断不是某个类型使用 is！</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">int</span> number = <span class="number">100</span>;</span><br><span class="line"><span class="built_in">double</span> distance = <span class="number">200.5</span>;</span><br><span class="line"><span class="built_in">num</span> age = <span class="number">18</span>;</span><br><span class="line"><span class="built_in">print</span>(number <span class="keyword">is</span> <span class="built_in">num</span>);<span class="comment">//true</span></span><br><span class="line"><span class="built_in">print</span>(distance <span class="keyword">is</span>! <span class="built_in">int</span>);<span class="comment">//true</span></span><br><span class="line"><span class="built_in">print</span>(age <span class="keyword">as</span> <span class="built_in">int</span>);<span class="comment">//18</span></span><br></pre></td></tr></table></figure>

<h5 id="5-Object-类型"><a href="#5-Object-类型" class="headerlink" title="5. Object 类型"></a>5. Object 类型</h5><p>dart 中所有东西都是对象，都继承于 object，可以使用 object 定义任何的变量，赋值后类型可以更改</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Object</span> color = <span class="string">&#x27;black&#x27;</span>;</span><br><span class="line">color = <span class="number">0xff000000</span>;<span class="comment">//运行正常，0xff000000类型是int, int也继承于Object   </span></span><br></pre></td></tr></table></figure>

<h5 id="6-dynamic-类型"><a href="#6-dynamic-类型" class="headerlink" title="6. dynamic 类型"></a>6. dynamic 类型</h5><p>一般用于无法确定具体类型，不要滥用 dynamic，一般尽量使用 object</p>
<p>object 和 dynamic 区别：object 会在编译阶段检查类型，dynamic 不会</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">dynamic</span> color = <span class="string">&#x27;black&#x27;</span>;</span><br><span class="line">color = <span class="number">0xff000000</span>;<span class="comment">//运行正常，0xff000000类型是int, int也继承于Object</span></span><br></pre></td></tr></table></figure>

<h4 id="三-变量和常量"><a href="#三-变量和常量" class="headerlink" title="三. 变量和常量"></a>三. 变量和常量</h4><h5 id="1-var-关键字"><a href="#1-var-关键字" class="headerlink" title="1. var 关键字"></a>1. var 关键字</h5><p>dart 中可以使用 var 来替代具体类型的声明，会自动推导变量的类型</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">int</span> colorValue = <span class="number">0xff000000</span>;</span><br><span class="line"><span class="keyword">var</span> colorKey = <span class="string">&#x27;black&#x27;</span>; <span class="comment">//var声明变量 自动根据赋值的类型，推导为String类型 </span></span><br><span class="line"><span class="comment">// 使用var声明集合变量 </span></span><br><span class="line"><span class="keyword">var</span> colorList = [<span class="string">&#x27;red&#x27;</span>, <span class="string">&#x27;yellow&#x27;</span>, <span class="string">&#x27;blue&#x27;</span>, <span class="string">&#x27;green&#x27;</span>];</span><br><span class="line"><span class="keyword">var</span> colorSet = &#123;<span class="string">&#x27;red&#x27;</span>, <span class="string">&#x27;yellow&#x27;</span>, <span class="string">&#x27;blue&#x27;</span>, <span class="string">&#x27;green&#x27;</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> colorMap = &#123;<span class="string">&#x27;white&#x27;</span>: <span class="number">0xffffffff</span>, <span class="string">&#x27;black&#x27;</span>: <span class="number">0xff000000</span>&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="2-常量（final和const）"><a href="#2-常量（final和const）" class="headerlink" title="2. 常量（final和const）"></a>2. 常量（final和const）</h5><p>声明常量可以使用 final 或 const，区别：如果常量是编译期就能初始化的用 const，如果常量是运行时期初始化的就用 final</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> PI = <span class="number">3.141592653</span>;<span class="comment">//const定义常量    </span></span><br><span class="line"><span class="keyword">final</span> nowTime = <span class="built_in">DateTime</span>.now();<span class="comment">//final定义常量</span></span><br></pre></td></tr></table></figure>

<h4 id="四-集合-List、Set、Map"><a href="#四-集合-List、Set、Map" class="headerlink" title="四. 集合 List、Set、Map"></a>四. 集合 List、Set、Map</h4><h5 id="1-集合-List"><a href="#1-集合-List" class="headerlink" title="1. 集合 List"></a>1. 集合 List</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; colorList = [<span class="string">&#x27;red&#x27;</span>, <span class="string">&#x27;yellow&#x27;</span>, <span class="string">&#x27;blue&#x27;</span>, <span class="string">&#x27;green&#x27;</span>];<span class="comment">//直接使用[]形式初始化       </span></span><br><span class="line"><span class="keyword">var</span> colorList = &lt;<span class="built_in">String</span>&gt; [<span class="string">&#x27;red&#x27;</span>, <span class="string">&#x27;yellow&#x27;</span>, <span class="string">&#x27;blue&#x27;</span>, <span class="string">&#x27;green&#x27;</span>];   </span><br></pre></td></tr></table></figure>

<p>常用函数</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; colorList = [<span class="string">&#x27;red&#x27;</span>, <span class="string">&#x27;yellow&#x27;</span>, <span class="string">&#x27;blue&#x27;</span>, <span class="string">&#x27;green&#x27;</span>];       </span><br><span class="line">colorList.add(<span class="string">&#x27;white&#x27;</span>); <span class="comment">//通过add添加一个新的元素       </span></span><br><span class="line"><span class="built_in">print</span>(colorList[<span class="number">2</span>]); <span class="comment">//直接使用数组下标形式访问元素       </span></span><br><span class="line"><span class="built_in">print</span>(colorList.length);<span class="comment">//获取集合的长度    </span></span><br><span class="line">colorList.insert(<span class="number">1</span>, <span class="string">&#x27;black&#x27;</span>);<span class="comment">//在集合指定index位置插入指定的元素       </span></span><br><span class="line">colorList.removeAt(<span class="number">2</span>);<span class="comment">//移除集合指定的index=2的元素，第3个元素       </span></span><br><span class="line">colorList.clear();<span class="comment">//清除所有元素       </span></span><br><span class="line"><span class="built_in">print</span>(colorList.sublist(<span class="number">1</span>,<span class="number">3</span>));<span class="comment">//截取子集合       </span></span><br><span class="line"><span class="built_in">print</span>(colorList.getRange(<span class="number">1</span>, <span class="number">3</span>));<span class="comment">//获取集合中某个范围元素       </span></span><br><span class="line"><span class="built_in">print</span>(colorList.join(<span class="string">&#x27;&lt;---&gt;&#x27;</span>));<span class="comment">//输出: red&lt;---&gt;yellow&lt;---&gt;blue&lt;---&gt;green       </span></span><br><span class="line"><span class="built_in">print</span>(colorList.isEmpty);       </span><br><span class="line"><span class="built_in">print</span>(colorList.contains(<span class="string">&#x27;green&#x27;</span>));  </span><br></pre></td></tr></table></figure>

<p>遍历</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; colorList = [<span class="string">&#x27;red&#x27;</span>, <span class="string">&#x27;yellow&#x27;</span>, <span class="string">&#x27;blue&#x27;</span>, <span class="string">&#x27;green&#x27;</span>];<span class="comment">//for-i遍历       </span></span><br><span class="line"> <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; colorList.length; i++) &#123;<span class="comment">//可以使用var或int           </span></span><br><span class="line">     <span class="built_in">print</span>(colorList[i]);               </span><br><span class="line"> &#125;       </span><br><span class="line"><span class="comment">//forEach遍历       </span></span><br><span class="line"><span class="comment">//forEach的参数为Function. =&gt;使用了箭头函数</span></span><br><span class="line">colorList.forEach((color) =&gt; <span class="built_in">print</span>(color));       </span><br><span class="line"><span class="comment">//for-in遍历       </span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> color <span class="keyword">in</span> colorList) &#123;</span><br><span class="line">    <span class="built_in">print</span>(color);       </span><br><span class="line">&#125;       </span><br><span class="line"><span class="comment">//while+iterator迭代器遍历，类似Java中的iteator       </span></span><br><span class="line"><span class="keyword">while</span>(colorList.iterator.moveNext()) &#123;           </span><br><span class="line">    <span class="built_in">print</span>(colorList.iterator.current);       </span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure>

<h5 id="2-集合-Set"><a href="#2-集合-Set" class="headerlink" title="2. 集合 Set"></a>2. 集合 Set</h5><p>集合中元素不能重复，添加重复元素时会返回 false，表示添加不成功</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Set</span>&lt;<span class="built_in">String</span>&gt; colorSet= &#123;<span class="string">&#x27;red&#x27;</span>, <span class="string">&#x27;yellow&#x27;</span>, <span class="string">&#x27;blue&#x27;</span>, <span class="string">&#x27;green&#x27;</span>&#125;;<span class="comment">//直接使用&#123;&#125;形式初始化       </span></span><br><span class="line"><span class="keyword">var</span> colorList = &lt;<span class="built_in">String</span>&gt; &#123;<span class="string">&#x27;red&#x27;</span>, <span class="string">&#x27;yellow&#x27;</span>, <span class="string">&#x27;blue&#x27;</span>, <span class="string">&#x27;green&#x27;</span>&#125;; </span><br></pre></td></tr></table></figure>

<p>集合中的交、并、补集</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> colorSet1 = &#123;<span class="string">&#x27;red&#x27;</span>, <span class="string">&#x27;yellow&#x27;</span>, <span class="string">&#x27;blue&#x27;</span>, <span class="string">&#x27;green&#x27;</span>&#125;;       </span><br><span class="line"><span class="keyword">var</span> colorSet2 = &#123;<span class="string">&#x27;black&#x27;</span>, <span class="string">&#x27;yellow&#x27;</span>, <span class="string">&#x27;blue&#x27;</span>, <span class="string">&#x27;green&#x27;</span>, <span class="string">&#x27;white&#x27;</span>&#125;;       </span><br><span class="line"><span class="built_in">print</span>(colorSet1.intersection(colorSet2));<span class="comment">//交集--&gt;输出: &#123;&#x27;yellow&#x27;, &#x27;blue&#x27;, &#x27;green&#x27;&#125;       </span></span><br><span class="line"><span class="built_in">print</span>(colorSet1.union(colorSet2));<span class="comment">//并集---&gt;输出: &#123;&#x27;black&#x27;, &#x27;red&#x27;, &#x27;yellow&#x27;, &#x27;blue&#x27;, &#x27;green&#x27;, &#x27;white&#x27;&#125;       </span></span><br><span class="line"><span class="built_in">print</span>(colorSet1.difference(colorSet2));<span class="comment">//补集---&gt;输出: &#123;&#x27;red&#x27;&#125;</span></span><br></pre></td></tr></table></figure>

<p>Set 的遍历方式和 List 一样</p>
<h5 id="3-集合-Map"><a href="#3-集合-Map" class="headerlink" title="3. 集合 Map"></a>3. 集合 Map</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">int</span>&gt; colorMap = &#123;<span class="string">&#x27;white&#x27;</span>: <span class="number">0xffffffff</span>, <span class="string">&#x27;black&#x27;</span>:<span class="number">0xff000000</span>&#125;;<span class="comment">//使用&#123;key:value&#125;形式初始化    </span></span><br><span class="line"><span class="keyword">var</span> colorMap = &lt;<span class="built_in">String</span>, <span class="built_in">int</span>&gt;&#123;<span class="string">&#x27;white&#x27;</span>: <span class="number">0xffffffff</span>, <span class="string">&#x27;black&#x27;</span>:<span class="number">0xff000000</span>&#125;;  </span><br></pre></td></tr></table></figure>

<p>常用函数</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">int</span>&gt; colorMap = &#123;<span class="string">&#x27;white&#x27;</span>: <span class="number">0xffffffff</span>, <span class="string">&#x27;black&#x27;</span>:<span class="number">0xff000000</span>&#125;;       </span><br><span class="line"><span class="built_in">print</span>(colorMap.containsKey(<span class="string">&#x27;green&#x27;</span>));<span class="comment">//false       </span></span><br><span class="line"><span class="built_in">print</span>(colorMap.containsValue(<span class="number">0xff000000</span>));<span class="comment">//true       </span></span><br><span class="line"><span class="built_in">print</span>(colorMap.keys.toList());<span class="comment">//[&#x27;white&#x27;,&#x27;black&#x27;]       </span></span><br><span class="line"><span class="built_in">print</span>(colorMap.values.toList());<span class="comment">//[0xffffffff, 0xff000000]       </span></span><br><span class="line">colorMap[<span class="string">&#x27;white&#x27;</span>] = <span class="number">0xfffff000</span>;<span class="comment">//修改指定key的元素       </span></span><br><span class="line">colorMap.remove(<span class="string">&#x27;black&#x27;</span>);<span class="comment">//移除指定key的元素 </span></span><br></pre></td></tr></table></figure>

<p>Map 遍历</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">int</span>&gt; colorMap = &#123;<span class="string">&#x27;white&#x27;</span>: <span class="number">0xffffffff</span>, <span class="string">&#x27;black&#x27;</span>:<span class="number">0xff000000</span>&#125;;       </span><br><span class="line"><span class="comment">//for-each key-value       </span></span><br><span class="line">colorMap.forEach((key, value) =&gt; <span class="built_in">print</span>(<span class="string">&#x27;color is <span class="subst">$key</span>, color value is <span class="subst">$value</span>&#x27;</span>));   </span><br></pre></td></tr></table></figure>

<p>Map.fromIterables 将 List 集合转换成 Map</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; colorKeys = [<span class="string">&#x27;white&#x27;</span>, <span class="string">&#x27;black&#x27;</span>];       </span><br><span class="line"><span class="built_in">List</span>&lt;<span class="built_in">int</span>&gt; colorValues = [<span class="number">0xffffffff</span>, <span class="number">0xff000000</span>];       </span><br><span class="line"><span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">int</span>&gt; colorMap = <span class="built_in">Map</span>.fromIterables(colorKeys, colorValues);   </span><br></pre></td></tr></table></figure>

<h5 id="4-集合常用操作符"><a href="#4-集合常用操作符" class="headerlink" title="4. 集合常用操作符"></a>4. 集合常用操作符</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; colorList = [<span class="string">&#x27;red&#x27;</span>, <span class="string">&#x27;yellow&#x27;</span>, <span class="string">&#x27;blue&#x27;</span>, <span class="string">&#x27;green&#x27;</span>];</span><br><span class="line"><span class="comment">//forEach箭头函数遍历</span></span><br><span class="line">colorList.forEach((color) =&gt; &#123;<span class="built_in">print</span>(color)&#125;);</span><br><span class="line">colorList.forEach((color) =&gt; <span class="built_in">print</span>(color)); <span class="comment">//箭头函数遍历，如果箭头函数内部只有一个表达式可以省略大括号</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//map函数的使用</span></span><br><span class="line"><span class="built_in">print</span>(colorList.map((color) =&gt; <span class="string">&#x27;<span class="subst">$color_font</span>&#x27;</span>).join(<span class="string">&quot;,&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//every函数的使用，判断里面的元素是否都满足条件，返回值为true/false</span></span><br><span class="line"><span class="built_in">print</span>(colorList.every((color) =&gt; color == <span class="string">&#x27;red&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//sort函数的使用</span></span><br><span class="line"><span class="built_in">List</span>&lt;<span class="built_in">int</span>&gt; numbers = [<span class="number">0</span>, <span class="number">3</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">7</span>, <span class="number">12</span>, <span class="number">2</span>, <span class="number">4</span>];</span><br><span class="line">numbers.sort((num1, num2) =&gt; num1 - num2); <span class="comment">//升序排序</span></span><br><span class="line">numbers.sort((num1, num2) =&gt; num2 - num1); <span class="comment">//降序排序</span></span><br><span class="line"><span class="built_in">print</span>(numbers);</span><br><span class="line"></span><br><span class="line"><span class="comment">//where函数使用，相当于Kotlin中的filter操作符，返回符合条件元素的集合</span></span><br><span class="line"><span class="built_in">print</span>(numbers.where((<span class="built_in">num</span>) =&gt; <span class="built_in">num</span> &gt; <span class="number">6</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//firstWhere函数的使用，相当于Kotlin中的find操作符，返回符合条件的第一个元素，如果没找到返回null</span></span><br><span class="line"><span class="built_in">print</span>(numbers.firstWhere((<span class="built_in">num</span>) =&gt; <span class="built_in">num</span> == <span class="number">5</span>, orElse: () =&gt; <span class="number">-1</span>)); <span class="comment">//注意: 如果没有找到，执行orElse代码块，可返回一个指定的默认值</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//singleWhere函数的使用，返回符合条件的第一个元素，如果没找到返回null，但是前提是集合中只有一个符合条件的元素, 否则就会抛出异常</span></span><br><span class="line"><span class="built_in">print</span>(numbers.singleWhere((<span class="built_in">num</span>) =&gt; <span class="built_in">num</span> == <span class="number">4</span>, orElse: () =&gt; <span class="number">-1</span>)); <span class="comment">//注意: 如果没有找到，执行orElse代码块，可返回一个指定的默认值</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//take(n)、skip(n)函数的使用，take(n)表示取当前集合前n个元素, skip(n)表示跳过前n个元素，然后取剩余所有的元素</span></span><br><span class="line"><span class="built_in">print</span>(numbers.take(<span class="number">5</span>).skip(<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//List.from函数的使用，从给定集合中创建一个新的集合,相当于clone一个集合</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">List</span>.from(numbers));</span><br><span class="line"></span><br><span class="line"><span class="comment">//expand函数的使用, 将集合一个元素扩展成多个元素或者将多个元素组成二维数组展开成平铺一个一位数组</span></span><br><span class="line"><span class="keyword">var</span> pair = [</span><br><span class="line">  [<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">  [<span class="number">3</span>, <span class="number">4</span>]</span><br><span class="line">];</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;flatten list: <span class="subst">$&#123;pair.expand((pair) =&gt; pair)&#125;</span>&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> inputs = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;duplicated list: <span class="subst">$&#123;inputs.expand((number) =&gt;[</span></span></span><br><span class="line"><span class="string"><span class="subst">  number,</span></span></span><br><span class="line"><span class="string"><span class="subst">  number,</span></span></span><br><span class="line"><span class="string"><span class="subst">  number</span></span></span><br><span class="line"><span class="string"><span class="subst">])&#125;</span>&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="五-流程控制"><a href="#五-流程控制" class="headerlink" title="五. 流程控制"></a>五. 流程控制</h4><h5 id="1-for-循环"><a href="#1-for-循环" class="headerlink" title="1. for 循环"></a>1. for 循环</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; colorList = [<span class="string">&#x27;red&#x27;</span>, <span class="string">&#x27;yellow&#x27;</span>, <span class="string">&#x27;blue&#x27;</span>, <span class="string">&#x27;green&#x27;</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; colorList.length; i++) &#123;<span class="comment">//可以用var或int</span></span><br><span class="line">    <span class="built_in">print</span>(colorList[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-do-while-循环"><a href="#2-do-while-循环" class="headerlink" title="2. do-while 循环"></a>2. do-while 循环</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; colorList = [<span class="string">&#x27;red&#x27;</span>, <span class="string">&#x27;yellow&#x27;</span>, <span class="string">&#x27;blue&#x27;</span>, <span class="string">&#x27;green&#x27;</span>];</span><br><span class="line"><span class="keyword">var</span> index = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(colorList[index++]);</span><br><span class="line">&#125; <span class="keyword">while</span> (index &lt; colorList.length);</span><br></pre></td></tr></table></figure>

<h5 id="3-while-循环"><a href="#3-while-循环" class="headerlink" title="3. while 循环"></a>3. while 循环</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; colorList = [<span class="string">&#x27;red&#x27;</span>, <span class="string">&#x27;yellow&#x27;</span>, <span class="string">&#x27;blue&#x27;</span>, <span class="string">&#x27;green&#x27;</span>];</span><br><span class="line"><span class="keyword">var</span> index = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (index &lt; colorList.length) &#123;</span><br><span class="line">    <span class="built_in">print</span>(colorList[index++]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="4-break-和-continue"><a href="#4-break-和-continue" class="headerlink" title="4. break 和 continue"></a>4. break 和 continue</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; colorList = [<span class="string">&#x27;red&#x27;</span>, <span class="string">&#x27;yellow&#x27;</span>, <span class="string">&#x27;blue&#x27;</span>, <span class="string">&#x27;green&#x27;</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; colorList.length; i++) &#123;<span class="comment">//可以用var或int</span></span><br><span class="line">    <span class="keyword">if</span>(colorList[i] == <span class="string">&#x27;yellow&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(colorList[i] == <span class="string">&#x27;blue&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">print</span>(colorList[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-if-else"><a href="#5-if-else" class="headerlink" title="5. if-else"></a>5. if-else</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> numbers = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; numbers.length; i++) &#123;</span><br><span class="line">  <span class="keyword">if</span> (numbers[i].isEven) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;偶数: <span class="subst">$&#123;numbers[i]&#125;</span>&#x27;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (numbers[i].isOdd) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;奇数: <span class="subst">$&#123;numbers[i]&#125;</span>&#x27;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;非法数字&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="6-三目运算（-）"><a href="#6-三目运算（-）" class="headerlink" title="6. 三目运算（?:）"></a>6. 三目运算（?:）</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> numbers = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; numbers.length; i++) &#123;</span><br><span class="line">    <span class="built_in">num</span> targetNumber = numbers[i].isEven ? numbers[i] * <span class="number">2</span> : numbers[i] + <span class="number">4</span>;</span><br><span class="line">    <span class="built_in">print</span>(targetNumber);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="7-switch-case"><a href="#7-switch-case" class="headerlink" title="7. switch-case"></a>7. switch-case</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Color getColor(<span class="built_in">String</span> colorName) &#123;</span><br><span class="line">  Color currentColor = Colors.blue;</span><br><span class="line">  <span class="keyword">switch</span> (colorName) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;read&quot;</span>:</span><br><span class="line">      currentColor = Colors.red;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;blue&quot;</span>:</span><br><span class="line">      currentColor = Colors.blue;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;yellow&quot;</span>:</span><br><span class="line">      currentColor = Colors.yellow;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> currentColor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="8-Assert-断言"><a href="#8-Assert-断言" class="headerlink" title="8. Assert 断言"></a>8. Assert 断言</h5><p>断言只在检查模式下运行有效，生产模式运行断言不生效</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">assert</span>(text != <span class="keyword">null</span>);<span class="comment">//text为null,就会中断后续代码执行</span></span><br><span class="line"><span class="keyword">assert</span>(urlString.startsWith(<span class="string">&#x27;https&#x27;</span>));</span><br></pre></td></tr></table></figure>

<h4 id="六-运算符"><a href="#六-运算符" class="headerlink" title="六. 运算符"></a>六. 运算符</h4><h5 id="1-算术运算符"><a href="#1-算术运算符" class="headerlink" title="1. 算术运算符"></a>1. 算术运算符</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="comment">//+ - * /</span></span><br><span class="line"><span class="keyword">var</span> result = <span class="number">3</span>~/<span class="number">5</span>; <span class="comment">//0 整除</span></span><br><span class="line"><span class="keyword">var</span> result = <span class="number">5</span>%<span class="number">3</span>;  <span class="comment">//2 取余</span></span><br></pre></td></tr></table></figure>

<h5 id="2-条件运算符"><a href="#2-条件运算符" class="headerlink" title="2. 条件运算符"></a>2. 条件运算符</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="comment">//&gt; &lt; == != &gt;= &lt;=</span></span><br></pre></td></tr></table></figure>

<h5 id="3-逻辑运算符"><a href="#3-逻辑运算符" class="headerlink" title="3. 逻辑运算符"></a>3. 逻辑运算符</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="comment">//|| &amp;&amp; !</span></span><br></pre></td></tr></table></figure>

<h5 id="4-位运算符"><a href="#4-位运算符" class="headerlink" title="4. 位运算符"></a>4. 位运算符</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="comment">//&amp; ! ^ &lt;&lt; &gt;&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="5-三目运算符"><a href="#5-三目运算符" class="headerlink" title="5. 三目运算符"></a>5. 三目运算符</h5><h5 id="6-空安全运算符"><a href="#6-空安全运算符" class="headerlink" title="6. 空安全运算符"></a>6. 空安全运算符</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">result = expr1 ?? expr2; </span><br><span class="line">expr1 ??= expr2; <span class="comment">// expr1为null则把expr2值赋值给expr1</span></span><br><span class="line">result = expr1?.value </span><br></pre></td></tr></table></figure>

<h5 id="7-级联操作符（-）"><a href="#7-级联操作符（-）" class="headerlink" title="7. 级联操作符（..）"></a>7. 级联操作符（..）</h5><p>级联操作符 .. 可以让你对一个对象中字段进行链式调用操作</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">question</span><br><span class="line">    ..id = <span class="string">&#x27;10001&#x27;</span></span><br><span class="line">    ..stem = <span class="string">&#x27;第一题: xxxxxx&#x27;</span></span><br><span class="line">    ..choices = &lt;<span class="built_in">String</span>&gt; [<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>,<span class="string">&#x27;D&#x27;</span>]</span><br><span class="line">    ..hint = <span class="string">&#x27;听音频做题&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h5 id="8-运算符重载"><a href="#8-运算符重载" class="headerlink" title="8. 运算符重载"></a>8. 运算符重载</h5><p>dart 支持运算符自定义重载，使用 operator 关键字定义重载函数</p>
<h5 id="9-异常"><a href="#9-异常" class="headerlink" title="9. 异常"></a>9. 异常</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">int</span> <span class="built_in">num</span> = <span class="number">18</span>;</span><br><span class="line"><span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  result = <span class="built_in">num</span> ~/ <span class="number">0</span>;</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;<span class="comment">//捕获到IntegerDivisionByZeroException</span></span><br><span class="line">  <span class="built_in">print</span>(e.toString());</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">  <span class="built_in">print</span>(<span class="string">&#x27;<span class="subst">$result</span>&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用on关键字捕获特定的异常</span></span><br><span class="line">main() &#123;</span><br><span class="line">  <span class="built_in">int</span> <span class="built_in">num</span> = <span class="number">18</span>;</span><br><span class="line">  <span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    result = <span class="built_in">num</span> ~/ <span class="number">0</span>;</span><br><span class="line">  &#125; <span class="keyword">on</span> IntegerDivisionByZeroException <span class="keyword">catch</span> (e) &#123;<span class="comment">//捕获特定异常</span></span><br><span class="line">    <span class="built_in">print</span>(e.toString());</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;<span class="subst">$result</span>&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="八-函数"><a href="#八-函数" class="headerlink" title="八. 函数"></a>八. 函数</h4><h5 id="1-函数基本用法"><a href="#1-函数基本用法" class="headerlink" title="1. 函数基本用法"></a>1. 函数基本用法</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">main() &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;sum is <span class="subst">$&#123;sum(<span class="number">2</span>, <span class="number">5</span>)&#125;</span>&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">num</span> sum(<span class="built_in">num</span> a, <span class="built_in">num</span> b) &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-函数参数列表传参规则"><a href="#2-函数参数列表传参规则" class="headerlink" title="2. 函数参数列表传参规则"></a>2. 函数参数列表传参规则</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="comment">//num a, num b, num c, num d 最普通的传参: 调用时，参数个数和参数顺序必须固定</span></span><br><span class="line">add1(<span class="built_in">num</span> a, <span class="built_in">num</span> b, <span class="built_in">num</span> c, <span class="built_in">num</span> d) &#123;</span><br><span class="line">  <span class="built_in">print</span>(a + b + c + d);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//[num a, num b, num c, num d]传参: 调用时，参数个数不固定，但是参数顺序需要一一对应, 不支持命名参数</span></span><br><span class="line">add2([<span class="built_in">num</span> a, <span class="built_in">num</span> b, <span class="built_in">num</span> c, <span class="built_in">num</span> d]) &#123;</span><br><span class="line">  <span class="built_in">print</span>(a + b + c + d);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//&#123;num a, num b, num c, num d&#125;传参: 调用时，参数个数不固定，参数顺序也可以不固定，支持命名参数,也叫可选参数，是dart中的一大特性，这就是为啥Flutter代码那么多可选属性，大量使用可选参数</span></span><br><span class="line">add3(&#123;<span class="built_in">num</span> a, <span class="built_in">num</span> b, <span class="built_in">num</span> c, <span class="built_in">num</span> d&#125;) &#123;</span><br><span class="line">  <span class="built_in">print</span>(a + b + c + d);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//num a, num b, &#123;num c, num d&#125;传参: 调用时，a,b参数个数固定顺序固定，c,d参数个数和顺序也可以不固定</span></span><br><span class="line">add4(<span class="built_in">num</span> a, <span class="built_in">num</span> b, &#123;<span class="built_in">num</span> c, <span class="built_in">num</span> d&#125;) &#123;</span><br><span class="line">  <span class="built_in">print</span>(a + b + c + d);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main() &#123;</span><br><span class="line">  add1(<span class="number">100</span>, <span class="number">100</span>, <span class="number">100</span>, <span class="number">100</span>); <span class="comment">//最普通的传参: 调用时，参数个数和参数顺序必须固定</span></span><br><span class="line">  add2(<span class="number">100</span>, <span class="number">100</span>); <span class="comment">//调用时，参数个数不固定，但是参数顺序需要一一对应, 不支持命名参数(也就意味着顺序不变)</span></span><br><span class="line">  add3(</span><br><span class="line">      b: <span class="number">200</span>,</span><br><span class="line">      a: <span class="number">200</span>,</span><br><span class="line">      c: <span class="number">100</span>,</span><br><span class="line">      d: <span class="number">100</span>); <span class="comment">//调用时，参数个数不固定，参数顺序也可以不固定，支持命名参数(也就意味着顺序可变)</span></span><br><span class="line">  add4(<span class="number">100</span>, <span class="number">100</span>, d: <span class="number">100</span>, c: <span class="number">100</span>); <span class="comment">//调用时，a,b参数个数固定顺序笃定，c,d参数个数和顺序也可以不固定</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-函数默认参数和可选参数"><a href="#3-函数默认参数和可选参数" class="headerlink" title="3. 函数默认参数和可选参数"></a>3. 函数默认参数和可选参数</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">add3(&#123;<span class="built_in">num</span> a, <span class="built_in">num</span> b, <span class="built_in">num</span> c, <span class="built_in">num</span> d = <span class="number">100</span>&#125;) &#123;<span class="comment">//d就是默认值参数，给的默认值是100</span></span><br><span class="line">   <span class="built_in">print</span>(a + b + c + d);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main() &#123;</span><br><span class="line">    add3(b: <span class="number">200</span>, a: <span class="number">100</span>, c: <span class="number">800</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="4-函数类型与高阶函数"><a href="#4-函数类型与高阶函数" class="headerlink" title="4. 函数类型与高阶函数"></a>4. 函数类型与高阶函数</h5><p>dart 函数也是一种类型 Function，可以作为函数参数传递，也可作为返回值</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">main() &#123;</span><br><span class="line">  <span class="built_in">Function</span> square = (a) &#123;</span><br><span class="line">    <span class="keyword">return</span> a * a;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Function</span> square2 = (a) &#123;</span><br><span class="line">    <span class="keyword">return</span> a * a * a;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  add(<span class="number">3</span>, <span class="number">4</span>, square, square2)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">num</span> add(<span class="built_in">num</span> a, <span class="built_in">num</span> b, [<span class="built_in">Function</span> op, <span class="built_in">Function</span> op2]) &#123;</span><br><span class="line">  <span class="comment">//函数作为参数传递</span></span><br><span class="line">  <span class="keyword">return</span> op(a) + op2(b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5-函数的简化及箭头函数"><a href="#5-函数的简化及箭头函数" class="headerlink" title="5. 函数的简化及箭头函数"></a>5. 函数的简化及箭头函数</h5><p>dart 中函数体内只有一个表达式，可以使用箭头函数来简化代码</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">add4(<span class="built_in">num</span> a, <span class="built_in">num</span> b, &#123;<span class="built_in">num</span> c, <span class="built_in">num</span> d&#125;) &#123;</span><br><span class="line">  <span class="built_in">print</span>(a + b + c + d);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">add5(<span class="built_in">num</span> a, <span class="built_in">num</span> b, &#123;<span class="built_in">num</span> c, <span class="built_in">num</span> d&#125;)  =&gt;  <span class="built_in">print</span>(a + b + c + d);</span><br></pre></td></tr></table></figure>

<h4 id="九-面向对象"><a href="#九-面向对象" class="headerlink" title="九. 面向对象"></a>九. 面向对象</h4><h5 id="1-类的基本定义和使用"><a href="#1-类的基本定义和使用" class="headerlink" title="1. 类的基本定义和使用"></a>1. 类的基本定义和使用</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="built_in">String</span> name;</span><br><span class="line">    <span class="built_in">int</span> age;</span><br><span class="line">    <span class="built_in">double</span> height;</span><br><span class="line">    Person(<span class="keyword">this</span>.name, <span class="keyword">this</span>.age, <span class="keyword">this</span>.height);<span class="comment">//注意，这里写法可能大家没见过， 这点和Java是不一样，这里实际上是一个dart的语法糖。但是这里不如Kotlin，Kotlin是直接把this.name传值的过程都省了。</span></span><br><span class="line">    <span class="comment">//与上述的等价代码,当然这也是Java中必须要写的代码</span></span><br><span class="line">    Person(<span class="built_in">String</span> name, <span class="built_in">int</span> age, <span class="built_in">double</span> height) &#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        <span class="keyword">this</span>.height = height;</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="comment">//然而Kotlin很彻底只需要声明属性就行,下面是Kotlin实现代码</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span>(<span class="title">val</span> <span class="title">name</span>: <span class="title">String</span>, <span class="title">val</span> <span class="title">age</span>: <span class="title">Int</span>, <span class="title">val</span> <span class="title">height</span>: <span class="title">Double</span>)     </span></span><br><span class="line"><span class="class">&#125;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">Student</span> <span class="keyword">extends</span> <span class="title">Person</span> </span>&#123;<span class="comment">//使用extends关键字表示继承</span></span><br><span class="line">    Student(<span class="built_in">String</span> name, <span class="built_in">int</span> age, <span class="built_in">double</span> height, <span class="built_in">double</span> grade): <span class="keyword">super</span>(name, age, height);<span class="comment">//在 Dart里：类名(变量，变量,...) 是构造函数的写法, :super()表示该构造调用父类，这里构造时传入三个参数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

































<p><a href="https://zhuanlan.zhihu.com/p/88728224">Dart语法之基础语法</a></p>
<p><a href="https://dart.dev/guides/language/language-tour#instance-variables">Dart</a></p>
<p><a href="https://dart.cn/guides">Dart.cn</a></p>
]]></content>
      <categories>
        <category>Flutter</category>
      </categories>
      <tags>
        <tag>Flutter</tag>
      </tags>
  </entry>
  <entry>
    <title>RxSwift（三）</title>
    <url>/2021/09/03/RxSwift%EF%BC%88%E4%B8%89%EF%BC%89/</url>
    <content><![CDATA[<h4 id="1-错误处理"><a href="#1-错误处理" class="headerlink" title="1 错误处理"></a>1 错误处理</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">enum MyError: Error &#123;</span><br><span class="line">    case A</span><br><span class="line">    case B</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="1-1-catchErrorJustReturn"><a href="#1-1-catchErrorJustReturn" class="headerlink" title="1.1 catchErrorJustReturn"></a>1.1 catchErrorJustReturn</h5><p>遇到error事件时，就返回指定的值，然后结束</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let sequenceFailed &#x3D; PublishSubject&lt;String&gt;()</span><br><span class="line">sequenceFailed</span><br><span class="line">    .catchErrorJustReturn(&quot;错误&quot;)</span><br><span class="line">    .subscribe(onNext: &#123;print($0)&#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">sequenceFailed.onNext(&quot;a&quot;)</span><br><span class="line">sequenceFailed.onNext(&quot;b&quot;)</span><br><span class="line">sequenceFailed.onError(MyError.A)</span><br><span class="line">sequenceFailed.onNext(&quot;c&quot;)</span><br><span class="line">结果：</span><br><span class="line">a</span><br><span class="line">b</span><br><span class="line">错误</span><br></pre></td></tr></table></figure>

<h5 id="1-2-catchError"><a href="#1-2-catchError" class="headerlink" title="1.2 catchError"></a>1.2 catchError</h5><p>捕获error，并对其处理，同时还能返回另一个observable序列进行订阅</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let sequenceFailed &#x3D; PublishSubject&lt;String&gt;()</span><br><span class="line">let recoverSequence &#x3D; Observable.of(&quot;1&quot;, &quot;2&quot;, &quot;3&quot;)</span><br><span class="line">    sequenceFailed</span><br><span class="line">        .catchError &#123;</span><br><span class="line">            print(&quot;Error:&quot;, $0)</span><br><span class="line">            return recoverSequence</span><br><span class="line">        &#125;</span><br><span class="line">        .subscribe(onNext: &#123;print($0)&#125;)</span><br><span class="line">        .disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">    sequenceFailed.onNext(&quot;a&quot;)</span><br><span class="line">    sequenceFailed.onNext(&quot;b&quot;)</span><br><span class="line">    sequenceFailed.onError(MyError.A)</span><br><span class="line">    sequenceFailed.onNext(&quot;c&quot;)</span><br><span class="line">结果：</span><br><span class="line">a</span><br><span class="line">b</span><br><span class="line">Error: A</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td></tr></table></figure>

<h5 id="1-3-retry"><a href="#1-3-retry" class="headerlink" title="1.3 retry"></a>1.3 retry</h5><p>遇到错误的时候，重新订阅该序列<br>retry()传入数字表示重试次数，不传默认1次</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var count &#x3D; 1</span><br><span class="line">let sequenceError &#x3D; Observable&lt;String&gt;.create &#123; (observer) -&gt; Disposable in</span><br><span class="line">    observer.onNext(&quot;a&quot;)</span><br><span class="line">    observer.onNext(&quot;b&quot;)</span><br><span class="line">    if count &#x3D;&#x3D; 1 &#123;</span><br><span class="line">        observer.onError(MyError.A)</span><br><span class="line">        print(&quot;error&quot;)</span><br><span class="line">        count +&#x3D; 1</span><br><span class="line">    &#125;</span><br><span class="line">    observer.onNext(&quot;c&quot;)</span><br><span class="line">    observer.onCompleted()</span><br><span class="line">    return Disposables.create()</span><br><span class="line">&#125;</span><br><span class="line">sequenceError</span><br><span class="line">.retry(2)</span><br><span class="line">.subscribe(onNext: &#123;print($0)&#125;)</span><br><span class="line">.disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h4 id="2-调试操作"><a href="#2-调试操作" class="headerlink" title="2 调试操作"></a>2 调试操作</h4><h5 id="2-1-debug"><a href="#2-1-debug" class="headerlink" title="2.1 debug"></a>2.1 debug</h5><p>还可以传入标记参数<code>.debug(&quot;调试1&quot;)</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Observable.of(2, 3)</span><br><span class="line">  .startWith(1)</span><br><span class="line">  .debug()</span><br><span class="line">  .subscribe(onNext: &#123;print($0)&#125;)</span><br><span class="line">  .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h5 id="2-2-RxSwift-Resources-total"><a href="#2-2-RxSwift-Resources-total" class="headerlink" title="2.2 RxSwift.Resources.total"></a>2.2 RxSwift.Resources.total</h5><p>将RxSwift.Resources.total打印出来可以查看当前RxSwift申请的所有资源数量 检查内存泄漏时有用<br>开启需要在Podfile开启配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">print(RxSwift.Resources.total)</span><br></pre></td></tr></table></figure>

<h4 id="3-特征序列"><a href="#3-特征序列" class="headerlink" title="3 特征序列"></a>3 特征序列</h4><h5 id="3-1-Single"><a href="#3-1-Single" class="headerlink" title="3.1 Single"></a>3.1 Single</h5><p>observable另一个版本，只能发出一个元素，要么产生一个error<br>不会共享状态变化<br>常用于执行HTTP请求，成功返回应答或错误</p>
<p>RxSwift为Single提供了一个枚举（SingleEvent）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public enum SingleEvent&lt;Element&gt; &#123;</span><br><span class="line">    case success(Element)</span><br><span class="line">    case error(Swift.Error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>样例</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">enum DataError: Error &#123;</span><br><span class="line">    case cantParseJSON</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func getPlayList(_ channel: String) -&gt; Single&lt;[String: Any]&gt; &#123;</span><br><span class="line">    return Single&lt;[String: Any]&gt;.create &#123; (single) -&gt; Disposable in</span><br><span class="line">        let url &#x3D; &quot;https:&#x2F;&#x2F;douban.fm&#x2F;j&#x2F;mine&#x2F;playlist?&quot; + &quot;type&#x3D;n&amp;channel&#x3D;\(channel)&amp;from&#x3D;mainsite&quot;</span><br><span class="line">        let task &#x3D; URLSession.shared.dataTask(with: URL(string: url)!) &#123; (data, _, error) in</span><br><span class="line">            if let error &#x3D; error &#123;</span><br><span class="line">                single(.error(error))</span><br><span class="line">                return</span><br><span class="line">            &#125;</span><br><span class="line">            guard let data &#x3D; data,</span><br><span class="line">                  let json &#x3D; try? JSONSerialization.jsonObject(with: data, options: .mutableLeaves),</span><br><span class="line">                  let result &#x3D; json as? [String: Any] else &#123;</span><br><span class="line">                single(.error(DataError.cantParseJSON))</span><br><span class="line">                return</span><br><span class="line">            &#125;</span><br><span class="line">            single(.success(result))</span><br><span class="line">        &#125;</span><br><span class="line">        task.resume()</span><br><span class="line">        return Disposables.create &#123; task.cancel() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 也可以用<code>subscribe(onSuccess:onError:)</code>方式</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">getPlayList(&quot;0&quot;)</span><br><span class="line">    .subscribe &#123; (event) in</span><br><span class="line">        switch event &#123;</span><br><span class="line">        case.success(let json):</span><br><span class="line">            print(&quot;JSON结果：&quot;, json)</span><br><span class="line">        case .error(let error):</span><br><span class="line">            print(&quot;发生错误：&quot;, error)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<ul>
<li>asSingle</li>
</ul>
<p>可以通过observable的asSingle()，转换为Single</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Observable.of(&quot;1&quot;)</span><br><span class="line">    .asSingle()</span><br><span class="line">    .subscribe(&#123;print($0)&#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h5 id="3-2-Completable"><a href="#3-2-Completable" class="headerlink" title="3.2 Completable"></a>3.2 Completable</h5><p>要么只能产生一个completed事件，要么产生一个error事件<br>不会共享状态变化</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">func cacheLocally() -&gt; Completable &#123;</span><br><span class="line">    return Completable.create &#123; (completeable) -&gt; Disposable in</span><br><span class="line">        let success &#x3D; (arc4random() % 2 &#x3D;&#x3D; 0)</span><br><span class="line">        guard success else &#123;</span><br><span class="line">            completeable(.error(CacheError.failedCaching))</span><br><span class="line">            return Disposables.create &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        completeable(.completed)</span><br><span class="line">        return Disposables.create &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">enum CacheError: Error &#123;</span><br><span class="line">   case failedCaching</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 也可使用<code>subscribe(onCompleted:onError:)</code>方式</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cacheLocally()</span><br><span class="line">    .subscribe &#123; (completable) in</span><br><span class="line">        switch completable &#123;</span><br><span class="line">        case .completed:</span><br><span class="line">            print(&quot;保存成功&quot;)</span><br><span class="line">        case .error(let error):</span><br><span class="line">            print(&quot;保存失败：\(error.localizedDescription)&quot;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h5 id="3-3-Maybe"><a href="#3-3-Maybe" class="headerlink" title="3.3 Maybe"></a>3.3 Maybe</h5><p>介于Single和Completable之间，要么只能发出一个元素，要么产生一个completable事件，要么产生error事件<br>不会共享状态变化</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public enum MaybeEvent&lt;Element&gt; &#123;</span><br><span class="line">    case success(Element)</span><br><span class="line">    case error(Swift.Error)</span><br><span class="line">    case completed</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">func generateString() -&gt; Maybe&lt;String&gt; &#123;</span><br><span class="line">    return Maybe.create &#123; (maybe) -&gt; Disposable in</span><br><span class="line">        maybe(.success(&quot;hang&quot;))</span><br><span class="line">        maybe(.completed)</span><br><span class="line">        return Disposables.create &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>asMaybe</li>
</ul>
<p>可以通过observable的asMaybe()，转换为Maybe</p>
<h4 id="4-Driver"><a href="#4-Driver" class="headerlink" title="4 Driver"></a>4 Driver</h4><p>目标是提供一种简便的方式在UI层编写响应式代码<br>不会产生error事件<br>一定在主线程监听<br>共享状态变化</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let results &#x3D; query.rx.text.asDriver()        &#x2F;&#x2F; 将普通序列转换为 Driver</span><br><span class="line">    .throttle(0.3, scheduler: MainScheduler.instance)</span><br><span class="line">    .flatMapLatest &#123; query in</span><br><span class="line">        fetchAutoCompleteItems(query)</span><br><span class="line">            .asDriver(onErrorJustReturn: [])  &#x2F;&#x2F; 仅仅提供发生错误时的备选返回值</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#x2F;&#x2F;将返回的结果绑定到显示结果数量的label上</span><br><span class="line">results</span><br><span class="line">    .map &#123; &quot;\($0.count)&quot; &#125;</span><br><span class="line">    .drive(resultCount.rx.text) &#x2F;&#x2F; 这里使用 drive 而不是 bindTo</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line"> </span><br><span class="line">&#x2F;&#x2F;将返回的结果绑定到tableView上</span><br><span class="line">results</span><br><span class="line">    .drive(resultsTableView.rx.items(cellIdentifier: &quot;Cell&quot;)) &#123; &#x2F;&#x2F;  同样使用 drive 而不是 bindTo</span><br><span class="line">        (_, result, cell) in</span><br><span class="line">        cell.textLabel?.text &#x3D; &quot;\(result)&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h5 id="4-1-asDriver"><a href="#4-1-asDriver" class="headerlink" title="4.1 asDriver"></a>4.1 asDriver</h5><p><code>query.rx.text.asDriver</code>将ControlProperty转换为Driver，将普通序列转换为Driver</p>
<h5 id="4-2-asDriver-onErrorJustReturn"><a href="#4-2-asDriver-onErrorJustReturn" class="headerlink" title="4.2 asDriver(onErrorJustReturn: )"></a>4.2 asDriver(onErrorJustReturn: )</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let disposeBag &#x3D; DisposeBag()</span><br><span class="line">let pubSubject &#x3D; PublishSubject&lt;Int&gt;()</span><br><span class="line"></span><br><span class="line">pubSubject.asDriver(onErrorJustReturn: 1000)</span><br><span class="line">    .drive(onNext: &#123;</span><br><span class="line">        print($0)</span><br><span class="line">    &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">pubSubject.onNext(10)</span><br><span class="line">pubSubject.onNext(29)</span><br><span class="line">pubSubject.onError(CustomError.test)</span><br></pre></td></tr></table></figure>

<h5 id="4-3-asDriver-onErrorDriveWith"><a href="#4-3-asDriver-onErrorDriveWith" class="headerlink" title="4.3 asDriver(onErrorDriveWith:)"></a>4.3 asDriver(onErrorDriveWith:)</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let disposeBag &#x3D; DisposeBag()</span><br><span class="line">let pubSubject &#x3D; PublishSubject&lt;Int&gt;()</span><br><span class="line">let recoverySubject &#x3D; PublishSubject&lt;Int&gt;()</span><br><span class="line">pubSubject.asDriver(onErrorDriveWith:</span><br><span class="line">    recoverySubject.asDriver(onErrorJustReturn: 1000))</span><br><span class="line">        .drive(onNext: &#123;</span><br><span class="line">            print($0)</span><br><span class="line">        &#125;)</span><br><span class="line">        .disposed(by: disposeBag)</span><br><span class="line">pubSubject.onNext(19)</span><br><span class="line">pubSubject.onError(CustomError.test)</span><br><span class="line">recoverySubject.onNext(10)</span><br></pre></td></tr></table></figure>

<h4 id="5-ControlProperty"><a href="#5-ControlProperty" class="headerlink" title="5 ControlProperty"></a>5 ControlProperty</h4><p>专门用来描述UI控件的属性，拥有该类型的属性都是被观察者observable<br>特性：<br>不会产生error事件，一定在主线程订阅，主线程监听，共享状态变化</p>
<p>UITextField+Rx.swift 中 UITextField 的 rx.text 属性类型便是 ControlProperty</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">extension Reactive where Base: UITextField &#123;</span><br><span class="line">    public var text: ControlProperty&lt;String?&gt; &#123;</span><br><span class="line">        return value</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    public var value: ControlProperty&lt;String?&gt; &#123;</span><br><span class="line">        return base.rx.controlPropertyWithDefaultEvents(</span><br><span class="line">            getter: &#123; textField in</span><br><span class="line">                textField.text</span><br><span class="line">        &#125;,</span><br><span class="line">            setter: &#123; textField, value in</span><br><span class="line">                if textField.text !&#x3D; value &#123;</span><br><span class="line">                    textField.text &#x3D; value</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-ControlEvent"><a href="#6-ControlEvent" class="headerlink" title="6 ControlEvent"></a>6 ControlEvent</h4><p>专门用来描述UI所产生事件，拥有该类型的属性都是被观察者observable<br>特性：<br>不会产生error事件，一定在主线程订阅，主线程监听，共享状态变化</p>
<p>UIButton 的 rx.tap 方法类型便是 ControlEvent<Void></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">extension Reactive where Base: UIButton &#123;</span><br><span class="line">    public var tap: ControlEvent&lt;Void&gt; &#123;</span><br><span class="line">        return controlEvent(.touchUpInside)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对 UIViewController 进行扩展</p>
<ul>
<li>将  viewDidLoad、viewDidAppear、viewDidLayoutSubviews 等各种 ViewController 生命周期的方法转成 ControlEvent 方便在 RxSwift 项目中使用。</li>
<li>增加 isVisible 序列属性，方便对视图的显示状态进行订阅。</li>
<li>增加 isDismissing 序列属性，方便对视图的释放进行订阅。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">public extension Reactive where Base: UIViewController &#123;</span><br><span class="line">    public var viewDidLoad: ControlEvent&lt;Void&gt; &#123;</span><br><span class="line">        let source &#x3D; self.methodInvoked(#selector(Base.viewDidLoad)).map &#123; _ in &#125;</span><br><span class="line">        return ControlEvent(events: source)</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    public var viewWillAppear: ControlEvent&lt;Bool&gt; &#123;</span><br><span class="line">        let source &#x3D; self.methodInvoked(#selector(Base.viewWillAppear))</span><br><span class="line">            .map &#123; $0.first as? Bool ?? false &#125;</span><br><span class="line">        return ControlEvent(events: source)</span><br><span class="line">    &#125;</span><br><span class="line">    public var viewDidAppear: ControlEvent&lt;Bool&gt; &#123;</span><br><span class="line">        let source &#x3D; self.methodInvoked(#selector(Base.viewDidAppear))</span><br><span class="line">            .map &#123; $0.first as? Bool ?? false &#125;</span><br><span class="line">        return ControlEvent(events: source)</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    public var viewWillDisappear: ControlEvent&lt;Bool&gt; &#123;</span><br><span class="line">        let source &#x3D; self.methodInvoked(#selector(Base.viewWillDisappear))</span><br><span class="line">            .map &#123; $0.first as? Bool ?? false &#125;</span><br><span class="line">        return ControlEvent(events: source)</span><br><span class="line">    &#125;</span><br><span class="line">    public var viewDidDisappear: ControlEvent&lt;Bool&gt; &#123;</span><br><span class="line">        let source &#x3D; self.methodInvoked(#selector(Base.viewDidDisappear))</span><br><span class="line">            .map &#123; $0.first as? Bool ?? false &#125;</span><br><span class="line">        return ControlEvent(events: source)</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    public var viewWillLayoutSubviews: ControlEvent&lt;Void&gt; &#123;</span><br><span class="line">        let source &#x3D; self.methodInvoked(#selector(Base.viewWillLayoutSubviews))</span><br><span class="line">            .map &#123; _ in &#125;</span><br><span class="line">        return ControlEvent(events: source)</span><br><span class="line">    &#125;</span><br><span class="line">    public var viewDidLayoutSubviews: ControlEvent&lt;Void&gt; &#123;</span><br><span class="line">        let source &#x3D; self.methodInvoked(#selector(Base.viewDidLayoutSubviews))</span><br><span class="line">            .map &#123; _ in &#125;</span><br><span class="line">        return ControlEvent(events: source)</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    public var willMoveToParentViewController: ControlEvent&lt;UIViewController?&gt; &#123;</span><br><span class="line">        let source &#x3D; self.methodInvoked(#selector(Base.willMove))</span><br><span class="line">            .map &#123; $0.first as? UIViewController &#125;</span><br><span class="line">        return ControlEvent(events: source)</span><br><span class="line">    &#125;</span><br><span class="line">    public var didMoveToParentViewController: ControlEvent&lt;UIViewController?&gt; &#123;</span><br><span class="line">        let source &#x3D; self.methodInvoked(#selector(Base.didMove))</span><br><span class="line">            .map &#123; $0.first as? UIViewController &#125;</span><br><span class="line">        return ControlEvent(events: source)</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    public var didReceiveMemoryWarning: ControlEvent&lt;Void&gt; &#123;</span><br><span class="line">        let source &#x3D; self.methodInvoked(#selector(Base.didReceiveMemoryWarning))</span><br><span class="line">            .map &#123; _ in &#125;</span><br><span class="line">        return ControlEvent(events: source)</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    &#x2F;&#x2F;表示视图是否显示的可观察序列，当VC显示状态改变时会触发</span><br><span class="line">    public var isVisible: Observable&lt;Bool&gt; &#123;</span><br><span class="line">        let viewDidAppearObservable &#x3D; self.base.rx.viewDidAppear.map &#123; _ in true &#125;</span><br><span class="line">        let viewWillDisappearObservable &#x3D; self.base.rx.viewWillDisappear</span><br><span class="line">            .map &#123; _ in false &#125;</span><br><span class="line">        return Observable&lt;Bool&gt;.merge(viewDidAppearObservable,</span><br><span class="line">                                      viewWillDisappearObservable)</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    &#x2F;&#x2F;表示页面被释放的可观察序列，当VC被dismiss时会触发</span><br><span class="line">    public var isDismissing: ControlEvent&lt;Bool&gt; &#123;</span><br><span class="line">        let source &#x3D; self.sentMessage(#selector(Base.dismiss))</span><br><span class="line">            .map &#123; $0.first as? Bool ?? false &#125;</span><br><span class="line">        return ControlEvent(events: source)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="7-调度器"><a href="#7-调度器" class="headerlink" title="7 调度器"></a>7 调度器</h4><p>控制任务在哪个线程或队列运行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let rxData: Observable&lt;Data&gt; &#x3D; ...</span><br><span class="line"> </span><br><span class="line">rxData</span><br><span class="line">    .subscribeOn(ConcurrentDispatchQueueScheduler(qos: .userInitiated)) &#x2F;&#x2F;后台构建序列</span><br><span class="line">    .observeOn(MainScheduler.instance)  &#x2F;&#x2F;主线程监听并处理序列结果</span><br><span class="line">    .subscribe(onNext: &#123; [weak self] data in</span><br><span class="line">        self?.data &#x3D; data</span><br><span class="line">    &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h5 id="7-1-subscribeOn"><a href="#7-1-subscribeOn" class="headerlink" title="7.1 subscribeOn()"></a>7.1 subscribeOn()</h5><p>决定数据序列的构建在哪个schedule上运行</p>
<p>比如上面样例，由于获取数据、解析数据需要花费一段时间的时间，所以通过 <strong>subscribeOn</strong> 将其切换到后台 <strong>Scheduler</strong> 来执行。这样可以避免主线程被阻塞</p>
<h5 id="7-2-observeOn"><a href="#7-2-observeOn" class="headerlink" title="7.2 observeOn()"></a>7.2 observeOn()</h5><p>决定哪个schedule上监听这个数据序列</p>
<p>比如上面样例，我们获取并解析完毕数据后又通过 <strong>observeOn</strong> 方法切换到主线程来监听并且处理结果</p>
<h4 id="8-双向绑定"><a href="#8-双向绑定" class="headerlink" title="8 双向绑定"></a>8 双向绑定</h4><p>比如控件的某个属性值与 ViewModel 里的某个 Subject 属性进行双向绑定</p>
<p>当 ViewModel 里的值发生改变时，可以同步反映到控件上</p>
<p>如果对控件值修改，ViewModel 那边值同时也会发生改变</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;将用户名与textField做双向绑定</span><br><span class="line">userVM.username.asObservable().bind(to: textField.rx.text).disposed(by: disposeBag)</span><br><span class="line">textField.rx.text.orEmpty.bind(to: userVM.username).disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<ul>
<li>自定义双向绑定操作符</li>
</ul>
<p>xSwift自带的双向绑定操作符 &lt;-&gt;<br>在RxSwift项目文件夹中 RxExample中 Operators.swift</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;将用户名与textField做双向绑定</span><br><span class="line">_ &#x3D;  self.textField.rx.textInput &lt;-&gt;  self.userVM.username</span><br></pre></td></tr></table></figure>

<h4 id="9-UITableView"><a href="#9-UITableView" class="headerlink" title="9 UITableView"></a>9 UITableView</h4><h5 id="9-1-单分区的表格数据"><a href="#9-1-单分区的表格数据" class="headerlink" title="9.1 单分区的表格数据"></a>9.1 单分区的表格数据</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let items &#x3D; Observable.just([</span><br><span class="line">    &quot;First Item&quot;,</span><br><span class="line">    &quot;Second Item&quot;,</span><br><span class="line">    &quot;Third Item&quot;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<p>绑定数据一：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">items</span><br><span class="line">    .bind(to: tableView.rx.items)</span><br><span class="line">    &#123; (tableView, row, element) in</span><br><span class="line">        let cell &#x3D; tableView.dequeueReusableCell(withIdentifier: &quot;Cell&quot;)!</span><br><span class="line">        cell.textLabel?.text &#x3D; &quot;\(element) @ row \(row)&quot;</span><br><span class="line">        return cell</span><br><span class="line">    &#125;</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<p>绑定数据二：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">items</span><br><span class="line">    .bind(to: tableView.rx.items(cellIdentifier: &quot;Cell&quot;, cellType: UITableViewCell.self))</span><br><span class="line">    &#123; (row, element, cell) in</span><br><span class="line">        cell.textLabel?.text &#x3D; &quot;\(element) @ row \(row)&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<ul>
<li>单元格选中</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tableView.rx.itemSelected.subscribe(onNext: &#123; indexPath in</span><br><span class="line">    print(&quot;选中index：\(indexPath.row)&quot;)</span><br><span class="line">&#125;)</span><br><span class="line">.disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">tableView.rx.modelSelected(String.self).subscribe(onNext: &#123; item in</span><br><span class="line">    print(&quot;选中内容：\(item)&quot;)</span><br><span class="line">&#125;)</span><br><span class="line">.disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<ul>
<li>同时获取索引和内容</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Observable.zip(tableView.rx.itemSelected, tableView.rx.modelSelected(String.self))</span><br><span class="line">    .subscribe(onNext: &#123; indexPath, item in</span><br><span class="line">        print(&quot;\(indexPath) \(item)&quot;)</span><br><span class="line">    &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Observable.zip(tableView.rx.itemSelected, tableView.rx.modelSelected(String.self))</span><br><span class="line">    .bind &#123; indexPath, item in</span><br><span class="line">        print(&quot;\(indexPath) \(item)&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<ul>
<li>删除单元格</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tableView.rx.itemDeleted.subscribe(onNext: &#123; indexPath in</span><br><span class="line">    print(&quot;删除index: \(indexPath.row)&quot;)</span><br><span class="line">&#125;)</span><br><span class="line">.disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h4 id="10-RxDataSource"><a href="#10-RxDataSource" class="headerlink" title="10 RxDataSource"></a>10 RxDataSource</h4><p>以 Section 来作为数据结构的</p>
<h5 id="10-1-单分区-TableView"><a href="#10-1-单分区-TableView" class="headerlink" title="10.1 单分区 TableView"></a>10.1 单分区 TableView</h5><p>使用自带 Section</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let items &#x3D; Observable.just([</span><br><span class="line">    SectionModel(model: &quot;&quot;, items: [</span><br><span class="line">        &quot;UILabel&quot;,</span><br><span class="line">        &quot;UITextView&quot;,</span><br><span class="line">        &quot;UIButton&quot;</span><br><span class="line">    ])</span><br><span class="line">])</span><br><span class="line">&#x2F;&#x2F;创建数据源</span><br><span class="line">let dataSource &#x3D; RxTableViewSectionedReloadDataSource&lt;SectionModel&lt;String, String&gt;&gt; &#123; dataSource, tableView, indexPath, element in</span><br><span class="line">    let cell &#x3D; tableView.dequeueReusableCell(withIdentifier: &quot;Cell&quot;)!</span><br><span class="line">    cell.textLabel?.text &#x3D; &quot;index：\(indexPath.row) element: \(element)&quot;</span><br><span class="line">    return cell</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;绑定单元格数据</span><br><span class="line">items</span><br><span class="line">    .bind(to: tableView.rx.items(dataSource: dataSource))</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h5 id="10-2-多分区-TableView"><a href="#10-2-多分区-TableView" class="headerlink" title="10.2 多分区 TableView"></a>10.2 多分区 TableView</h5><p>使用自带 Section</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let items &#x3D; Observable.just([</span><br><span class="line">    SectionModel(model: &quot;基本控件&quot;, items: [</span><br><span class="line">        &quot;UILabel&quot;,</span><br><span class="line">        &quot;UIButton&quot;,</span><br><span class="line">    ]),</span><br><span class="line">    SectionModel(model: &quot;高级控件&quot;, items: [</span><br><span class="line">        &quot;UITableView&quot;,</span><br><span class="line">        &quot;UICollectionView&quot;,</span><br><span class="line">    ]),</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;创建数据源</span><br><span class="line">let dataSource &#x3D; RxTableViewSectionedReloadDataSource&lt;SectionModel&lt;String, String&gt;&gt; &#123; dataSource, tableView, indexPath, element in</span><br><span class="line">    let cell &#x3D; tableView.dequeueReusableCell(withIdentifier: &quot;Cell&quot;)!</span><br><span class="line">    cell.textLabel?.text &#x3D; &quot;index：\(indexPath.row) element: \(element)&quot;</span><br><span class="line">    return cell</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;设置分区头标题</span><br><span class="line">dataSource.titleForHeaderInSection &#x3D; &#123; dataSource, index in</span><br><span class="line">    return dataSource.sectionModels[index].model</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">items</span><br><span class="line">    .bind(to: tableView.rx.items(dataSource: dataSource))</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h5 id="10-3-使用自定义-Section"><a href="#10-3-使用自定义-Section" class="headerlink" title="10.3 使用自定义 Section"></a>10.3 使用自定义 Section</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let items &#x3D; Observable.just([</span><br><span class="line">    MySection(header: &quot;基本控件&quot;, items: [</span><br><span class="line">        &quot;UILabel&quot;,</span><br><span class="line">        &quot;UIButton&quot;,</span><br><span class="line">    ]),</span><br><span class="line">    MySection(header: &quot;高级控件&quot;, items: [</span><br><span class="line">        &quot;UITableView&quot;,</span><br><span class="line">        &quot;UICollectionView&quot;,</span><br><span class="line">    ]),</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;创建数据源</span><br><span class="line">let dataSource &#x3D; RxTableViewSectionedReloadDataSource&lt;MySection&gt; &#123; dataSource, tableView, indexPath, element in</span><br><span class="line">    let cell &#x3D; tableView.dequeueReusableCell(withIdentifier: &quot;Cell&quot;)!</span><br><span class="line">    cell.textLabel?.text &#x3D; &quot;index：\(indexPath.row) element: \(element)&quot;</span><br><span class="line">    return cell</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;设置分区头标题</span><br><span class="line">dataSource.titleForHeaderInSection &#x3D; &#123; dataSource, index in</span><br><span class="line">    return dataSource.sectionModels[index].header</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">items</span><br><span class="line">    .bind(to: tableView.rx.items(dataSource: dataSource))</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h5 id="10-4-数据刷新"><a href="#10-4-数据刷新" class="headerlink" title="10.4 数据刷新"></a>10.4 数据刷新</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let refreshButton: UIBarButtonItem &#x3D; UIBarButtonItem(title: &quot;Refresh&quot;, style: .plain, target: self, action: nil)</span><br><span class="line"></span><br><span class="line">let randomResult &#x3D; refreshButton.rx.tap</span><br><span class="line">    .startWith(())&#x2F;&#x2F;一开始就能自动请求一次数据</span><br><span class="line">    .flatMapLatest(getRandomResult)&#x2F;&#x2F;多次请求取最后一次</span><br><span class="line">    .share()</span><br><span class="line"></span><br><span class="line">let dataSource &#x3D; RxTableViewSectionedReloadDataSource&lt;SectionModel&lt;String, Int&gt;&gt; &#123; dataSource, tableView, indexPath, element in</span><br><span class="line">    let cell &#x3D; tableView.dequeueReusableCell(withIdentifier: &quot;Cell&quot;)!</span><br><span class="line">    cell.textLabel?.text &#x3D; &quot;\(indexPath.row): \(element)&quot;</span><br><span class="line">    return cell</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">randomResult</span><br><span class="line">    .bind(to: tableView.rx.items(dataSource: dataSource))</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">func getRandomResult() -&gt; Observable&lt;[SectionModel&lt;String, Int&gt;]&gt;&#123;</span><br><span class="line">        print(&quot;请求数据..&quot;)</span><br><span class="line">        let items &#x3D; (0..&lt;5).map &#123; _ in</span><br><span class="line">            Int(arc4random())</span><br><span class="line">        &#125;</span><br><span class="line">        let observable &#x3D; Observable.just([SectionModel(model: &quot;S&quot;, items: items)])</span><br><span class="line">        return observable.delay(RxTimeInterval.seconds(2), scheduler: MainScheduler.instance)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>也可以在源头进行限制，1秒内多次点击只取最后一次</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let randomResult &#x3D; refreshButton.rx.tap</span><br><span class="line">    .throttle(RxTimeInterval.seconds(1), scheduler: MainScheduler.instance)</span><br><span class="line">    .startWith(())&#x2F;&#x2F;一开始就能自动请求一次数据</span><br><span class="line">    .share()</span><br></pre></td></tr></table></figure>

<ul>
<li> 停止数据请求</li>
</ul>
<p>使用 takeUntil，当 takeUntil 中的 Observable 发送一个值时，便会结束对应的 Observable</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let stopButton: UIBarButtonItem &#x3D; UIBarButtonItem(title: &quot;Cancel&quot;, style: .plain, target: self, action: nil)</span><br><span class="line"></span><br><span class="line">let randomResult &#x3D; refreshButton.rx.tap</span><br><span class="line">    .startWith(())&#x2F;&#x2F;一开始就能自动请求一次数据</span><br><span class="line">    .flatMapLatest &#123;</span><br><span class="line">        self.getRandomResult().takeUntil(self.stopButton.rx.tap)</span><br><span class="line">    &#125;.share()</span><br></pre></td></tr></table></figure>

<h5 id="10-5-搜索过滤"><a href="#10-5-搜索过滤" class="headerlink" title="10.5 搜索过滤"></a>10.5 搜索过滤</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var searchBar: UISearchBar!</span><br><span class="line">tableView.tableHeaderView &#x3D; searchBar</span><br><span class="line"></span><br><span class="line">let randomResult &#x3D; refreshButton.rx.tap</span><br><span class="line">    .startWith(())&#x2F;&#x2F;一开始就能自动请求一次数据</span><br><span class="line">    .flatMapLatest &#123;</span><br><span class="line">        self.getRandomResult().takeUntil(self.stopButton.rx.tap)</span><br><span class="line">    &#125;</span><br><span class="line">    .flatMapLatest(filterResult)</span><br><span class="line">    .share()</span><br><span class="line">      </span><br><span class="line">func filterResult(data: [SectionModel&lt;String, Int&gt;]) -&gt; Observable&lt;[SectionModel&lt;String, Int&gt;]&gt; &#123;</span><br><span class="line">    self.searchBar.rx.text.orEmpty.flatMapLatest &#123; query -&gt; Observable&lt;[SectionModel&lt;String, Int&gt;]&gt; in</span><br><span class="line">        print(&quot;筛选数据(条件为：\(query)&quot;)</span><br><span class="line">        if query.isEmpty &#123;</span><br><span class="line">            return Observable.just(data)</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            var newData: [SectionModel&lt;String, Int&gt;] &#x3D; []</span><br><span class="line">            for sectionModel in data &#123;</span><br><span class="line">                let items &#x3D; sectionModel.items.filter &#123; &quot;\($0)&quot;.contains(query) &#125;</span><br><span class="line">                newData.append(SectionModel(model: sectionModel.model, items: items))</span><br><span class="line">            &#125;</span><br><span class="line">            return Observable.just(newData)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="10-6-可编辑表格"><a href="#10-6-可编辑表格" class="headerlink" title="10.6 可编辑表格"></a>10.6 可编辑表格</h5><p>定义各种操作</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">enum TableEditingCommand &#123;</span><br><span class="line">    case setItems(items: [String])</span><br><span class="line">    case addItem(item: String)</span><br><span class="line">    case moveItem(from: IndexPath, to: IndexPath)</span><br><span class="line">    case deleteItem(IndexPath)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义ViewModel，保存除了表格数据外，还包含4个操作指令的具体实现</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">struct TableViewModel &#123;</span><br><span class="line">    fileprivate var items: [String]</span><br><span class="line">    </span><br><span class="line">    init(items: [String] &#x3D; []) &#123;</span><br><span class="line">        self.items &#x3D; items</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    func execute(command: TableEditingCommand) -&gt; TableViewModel &#123;</span><br><span class="line">        switch command &#123;</span><br><span class="line">        case .setItems(let items):</span><br><span class="line">            print(&quot;设置表格数据&quot;)</span><br><span class="line">            return TableViewModel(items: items)</span><br><span class="line">        case .addItem(let item):</span><br><span class="line">            print(&quot;新增数据&quot;)</span><br><span class="line">            var items &#x3D; self.items</span><br><span class="line">            items.append(item)</span><br><span class="line">            return TableViewModel(items: items)</span><br><span class="line">        case .moveItem(let from, let to):</span><br><span class="line">            print(&quot;移动数据&quot;)</span><br><span class="line">            var items &#x3D; self.items</span><br><span class="line">            items.insert(items.remove(at: from.row), at: to.row)</span><br><span class="line">            return TableViewModel(items: items)</span><br><span class="line">        case .deleteItem(let indexPath):</span><br><span class="line">            print(&quot;删除数据项&quot;)</span><br><span class="line">            var items &#x3D; self.items</span><br><span class="line">            items.remove(at: indexPath.row)</span><br><span class="line">            return TableViewModel(items: items)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ViewController</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class ViewController: UIViewController &#123;</span><br><span class="line"></span><br><span class="line">    let disposeBag &#x3D; DisposeBag()</span><br><span class="line">    </span><br><span class="line">    var tableView: UITableView!</span><br><span class="line">    </span><br><span class="line">    let refreshButton: UIBarButtonItem &#x3D; UIBarButtonItem(title: &quot;Refresh&quot;, style: .plain, target: self, action: nil)</span><br><span class="line">    let addButton    : UIBarButtonItem &#x3D; UIBarButtonItem(title: &quot;Add&quot;, style: .plain, target: self, action: nil)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    override func viewDidLoad() &#123;</span><br><span class="line">        super.viewDidLoad()</span><br><span class="line">        </span><br><span class="line">        self.tableView &#x3D; UITableView(frame: view.frame, style: .plain)</span><br><span class="line">        self.tableView.register(UITableViewCell.self, forCellReuseIdentifier: &quot;Cell&quot;)</span><br><span class="line">        self.view.addSubview(tableView)</span><br><span class="line"></span><br><span class="line">        navigationItem.leftBarButtonItem  &#x3D; addButton</span><br><span class="line">        navigationItem.rightBarButtonItem &#x3D; refreshButton</span><br><span class="line">        </span><br><span class="line">        let initialVM &#x3D; TableViewModel()</span><br><span class="line">        </span><br><span class="line">        let refreshCommand &#x3D; refreshButton.rx.tap</span><br><span class="line">            .startWith(())</span><br><span class="line">            .flatMapLatest(getRandomResult)</span><br><span class="line">            .map(TableEditingCommand.setItems)</span><br><span class="line">        </span><br><span class="line">        let addCommand &#x3D; addButton.rx.tap</span><br><span class="line">            .map &#123; &quot;\(arc4random())&quot; &#125;</span><br><span class="line">            .map(TableEditingCommand.addItem)</span><br><span class="line">        </span><br><span class="line">        let moveCommand &#x3D; tableView.rx.itemMoved</span><br><span class="line">            .map (TableEditingCommand.moveItem)</span><br><span class="line">        </span><br><span class="line">        let deleteCommand &#x3D; tableView.rx.itemDeleted</span><br><span class="line">            .map(TableEditingCommand.deleteItem)</span><br><span class="line">        </span><br><span class="line">        Observable.of(refreshCommand, addCommand, moveCommand, deleteCommand)</span><br><span class="line">            .merge()</span><br><span class="line">            .scan(initialVM) &#123; (vm: TableViewModel, command: TableEditingCommand) -&gt; TableViewModel  in</span><br><span class="line">                return vm.execute(command: command)</span><br><span class="line">            &#125;</span><br><span class="line">            .startWith(initialVM)</span><br><span class="line">            .map &#123;</span><br><span class="line">                [AnimatableSectionModel(model: &quot;&quot;, items: $0.items)]</span><br><span class="line">            &#125;</span><br><span class="line">            .share()</span><br><span class="line">            .bind(to: tableView.rx.items(dataSource: ViewController.dataSource()))</span><br><span class="line">            .disposed(by: disposeBag)</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    func getRandomResult() -&gt; Observable&lt;[String]&gt; &#123;</span><br><span class="line">        print(&quot;生成随机数&quot;)</span><br><span class="line">        let items &#x3D; (0..&lt;5).map &#123; _ in</span><br><span class="line">            &quot;\(arc4random())&quot;</span><br><span class="line">        &#125;</span><br><span class="line">        return Observable.just(items)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    override func viewDidAppear(_ animated: Bool) &#123;</span><br><span class="line">        super.viewDidAppear(animated)</span><br><span class="line">        tableView.setEditing(true, animated: true)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">extension ViewController &#123;</span><br><span class="line"></span><br><span class="line">    static func dataSource() -&gt; RxTableViewSectionedAnimatedDataSource&lt;AnimatableSectionModel&lt;String, String&gt;&gt; &#123;</span><br><span class="line"></span><br><span class="line">        let configuration: AnimationConfiguration &#x3D;</span><br><span class="line">            AnimationConfiguration(insertAnimation: .top,</span><br><span class="line">                                   reloadAnimation: .fade,</span><br><span class="line">                                   deleteAnimation: .left)</span><br><span class="line"></span><br><span class="line">        return RxTableViewSectionedAnimatedDataSource(</span><br><span class="line">            animationConfiguration: configuration) &#123; dataSource, tv, indexPath, element in</span><br><span class="line">            let cell &#x3D; tv.dequeueReusableCell(withIdentifier: &quot;Cell&quot;)!</span><br><span class="line">            cell.textLabel?.text &#x3D; &quot;条目：\(indexPath.row) \(element)&quot;</span><br><span class="line">            return cell</span><br><span class="line">        &#125; canEditRowAtIndexPath: &#123; _, _ in</span><br><span class="line">            return true</span><br><span class="line">        &#125; canMoveRowAtIndexPath: &#123; _, _ in</span><br><span class="line">            return true</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="10-7-不同类型-Cell"><a href="#10-7-不同类型-Cell" class="headerlink" title="10.7 不同类型 Cell"></a>10.7 不同类型 Cell</h5>]]></content>
  </entry>
  <entry>
    <title>RxSwift（二）操作符</title>
    <url>/2021/09/03/RxSwift%EF%BC%88%E4%BA%8C%EF%BC%89%E6%93%8D%E4%BD%9C%E7%AC%A6/</url>
    <content><![CDATA[<h4 id="1-变换操作"><a href="#1-变换操作" class="headerlink" title="1 变换操作"></a>1 变换操作</h4><p>对原始的Observable序列进行一些转换</p>
<h5 id="1-1-buffer"><a href="#1-1-buffer" class="headerlink" title="1.1 buffer"></a>1.1 buffer</h5><p>缓冲组合，参数1缓冲时间，参数2缓冲个数，参数3线程<br>缓存Observable中发出的元素，元素达到某个数量或经过特定时间，就将元素集合发送出来</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let subject &#x3D; PublishSubject&lt;String&gt;()</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;每缓存3个元素则组合一起发出来</span><br><span class="line">&#x2F;&#x2F;如果1秒内不够3个也会发出（有几个发几个，一个没有发[]）</span><br><span class="line">subject</span><br><span class="line">    .buffer(timeSpan: RxTimeInterval.seconds(1), count: 3, scheduler: MainScheduler.instance)</span><br><span class="line">    .subscribe(onNext: &#123; print($0)&#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">subject.onNext(&quot;a&quot;)</span><br><span class="line">subject.onNext(&quot;b&quot;)</span><br><span class="line">subject.onNext(&quot;c&quot;)</span><br><span class="line"></span><br><span class="line">subject.onNext(&quot;1&quot;)</span><br><span class="line">subject.onNext(&quot;2&quot;)</span><br><span class="line"></span><br><span class="line">结果：</span><br><span class="line">[&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]</span><br><span class="line">[&quot;1&quot;, &quot;2&quot;]</span><br><span class="line">[]</span><br><span class="line">[]</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h5 id="1-2-window"><a href="#1-2-window" class="headerlink" title="1.2 window"></a>1.2 window</h5><p>和 buffer 类似，Buffer是周期性的将缓存的元素集合发送出来，window周期性的将元素集合以observable形态发送出来</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let subject &#x3D; PublishSubject&lt;String&gt;()</span><br><span class="line"></span><br><span class="line">subject</span><br><span class="line">    .window(timeSpan: RxTimeInterval.seconds(1), count: 3, scheduler: MainScheduler.instance)</span><br><span class="line">    .subscribe(onNext: &#123;</span><br><span class="line">        print($0)</span><br><span class="line">        $0.subscribe(onNext: &#123; print($0) &#125;)</span><br><span class="line">          .disposed(by: self.disposeBag)</span><br><span class="line">    &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">subject.onNext(&quot;a&quot;)</span><br><span class="line">subject.onNext(&quot;b&quot;)</span><br><span class="line">subject.onNext(&quot;c&quot;)</span><br><span class="line"></span><br><span class="line">subject.onNext(&quot;1&quot;)</span><br><span class="line">subject.onNext(&quot;2&quot;)</span><br><span class="line">  </span><br><span class="line">结果：</span><br><span class="line">RxSwift.AddRef&lt;Swift.String&gt;</span><br><span class="line">a</span><br><span class="line">b</span><br><span class="line">c</span><br><span class="line">RxSwift.AddRef&lt;Swift.String&gt;</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">RxSwift.AddRef&lt;Swift.String&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h5 id="1-3-map"><a href="#1-3-map" class="headerlink" title="1.3 map"></a>1.3 map</h5><p>传入一个函数闭包，把原来observable序列转变为一个新的observable序列</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Observable.of(1, 2, 3)</span><br><span class="line">    .map &#123; $0 * 10 &#125;</span><br><span class="line">    .subscribe(onNext: &#123; print($0) &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h5 id="4-4-flatMap"><a href="#4-4-flatMap" class="headerlink" title="4.4 flatMap"></a>4.4 flatMap</h5><p><code>map </code>做转换的时候容易出现升维情况，转变后，从一个序列变为一个序列的序列<br><code>flatMap</code> 会对源observable的每个元素应用一个转换方法，转换成observables，然后将这些observables元素合并后发送出来，即又将其降维成一个observable序列</p>
<p>Observable 的元素本生拥有其他的 Observable 时，我们可以将所有子 Observables 的元素发送出来</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let subject1 &#x3D; BehaviorSubject(value: &quot;A&quot;)</span><br><span class="line">let subject2 &#x3D; BehaviorSubject(value: &quot;1&quot;)</span><br><span class="line"></span><br><span class="line">let replay &#x3D; BehaviorRelay(value: subject1)</span><br><span class="line">replay.asObservable()</span><br><span class="line">    .flatMap&#123; $0 &#125;</span><br><span class="line">    .subscribe(onNext: &#123;print($0)&#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">subject1.onNext(&quot;B&quot;)</span><br><span class="line">replay.accept(subject2)</span><br><span class="line">subject2.onNext(&quot;2&quot;)</span><br><span class="line">subject1.onNext(&quot;C&quot;)</span><br><span class="line">      </span><br><span class="line">结果：</span><br><span class="line">A</span><br><span class="line">B</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">C</span><br></pre></td></tr></table></figure>

<h5 id="4-5-flatMapLatest"><a href="#4-5-flatMapLatest" class="headerlink" title="4.5 flatMapLatest"></a>4.5 flatMapLatest</h5><p>和flatMap唯一区别，只会接收最新的value事件<br>将flatMap的例子替换成flatMapLatest</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">A</span><br><span class="line">B</span><br><span class="line">1</span><br><span class="line">2</span><br></pre></td></tr></table></figure>

<h5 id="1-6-flatMapFirst"><a href="#1-6-flatMapFirst" class="headerlink" title="1.6 flatMapFirst"></a>1.6 flatMapFirst</h5><p>和flatMapLatest相反，只接收最初value事件</p>
<p>可以防止重复请求<br>如：点击按钮发送请求，请求完成前，该按钮点击都不应该继续发送请求</p>
<p>将flatMap的例子替换成 flatMapFirst</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">A</span><br><span class="line">B</span><br><span class="line">C</span><br></pre></td></tr></table></figure>

<h5 id="4-7-concatMap"><a href="#4-7-concatMap" class="headerlink" title="4.7 concatMap"></a>4.7 concatMap</h5><p>和flatMap区别：前一个Observable元素发送完毕后，后一个Observable才可以开始发出元素。<br>等待前一个Observable产生完成事件后，才对后一个Observable进行订阅</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let subject1 &#x3D; BehaviorSubject(value: &quot;A&quot;)</span><br><span class="line">let subject2 &#x3D; BehaviorSubject(value: &quot;1&quot;)</span><br><span class="line"></span><br><span class="line">let replay &#x3D; BehaviorRelay(value: subject1)</span><br><span class="line">replay</span><br><span class="line">    .concatMap &#123; $0 &#125;</span><br><span class="line">    .subscribe(onNext: &#123;print($0)&#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">subject1.onNext(&quot;B&quot;)</span><br><span class="line">replay.accept(subject2)</span><br><span class="line">subject2.onNext(&quot;2&quot;)</span><br><span class="line">subject1.onNext(&quot;C&quot;)</span><br><span class="line">subject1.onCompleted() &#x2F;&#x2F;只有前一个序列结束，才能接收下一个序列 如果没有complete 只输出 A B C</span><br><span class="line">结果：</span><br><span class="line">A</span><br><span class="line">B</span><br><span class="line">C</span><br><span class="line">2</span><br></pre></td></tr></table></figure>

<h5 id="4-8-scan"><a href="#4-8-scan" class="headerlink" title="4.8 scan"></a>4.8 scan</h5><p>先给一个初始化的数，然后不断拿前一个结果和最新值进行处理操作</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Observable.of(1, 2, 3, 4, 6)</span><br><span class="line">    .scan(0) &#123; acum, elem in</span><br><span class="line">        acum + elem</span><br><span class="line">    &#125;</span><br><span class="line">    .subscribe(onNext: &#123; print($0) &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line">结果：</span><br><span class="line">1</span><br><span class="line">3</span><br><span class="line">6</span><br><span class="line">10</span><br><span class="line">16</span><br></pre></td></tr></table></figure>

<h5 id="1-9-groupBy"><a href="#1-9-groupBy" class="headerlink" title="1.9 groupBy"></a>1.9 groupBy</h5><p>将源Observable分解为多个子Observable，然后将子Observable发送出来<br>会将元素通过某个键进行分组，然后将分组后的元素序列以Observable形态发送出来</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Observable&lt;Int&gt;.of(0, 1, 2, 3, 4, 5)</span><br><span class="line">    .groupBy &#123; element -&gt; String in</span><br><span class="line">        return element % 2 &#x3D;&#x3D; 0 ? &quot;偶数&quot;:&quot;奇数&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    .subscribe &#123; event in</span><br><span class="line">        switch event &#123;</span><br><span class="line">        case .next(let group):</span><br><span class="line">            group</span><br><span class="line">                .subscribe(onNext: &#123; print(&quot;key:\(group.key) \($0)&quot;) &#125;)</span><br><span class="line">                .disposed(by: self.disposeBag)</span><br><span class="line">        default:</span><br><span class="line">            print(&quot;&quot;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.disposed(by: disposeBag)</span><br><span class="line">结果：</span><br><span class="line">key:奇数 1</span><br><span class="line">key:偶数 2</span><br><span class="line">key:奇数 3</span><br><span class="line">key:偶数 4</span><br><span class="line">key:奇数 5</span><br></pre></td></tr></table></figure>

<h4 id="2-过滤操作符"><a href="#2-过滤操作符" class="headerlink" title="2 过滤操作符"></a>2 过滤操作符</h4><p>从源Observable中选择特定的数据发送出来</p>
<h5 id="2-1-filter"><a href="#2-1-filter" class="headerlink" title="2.1 filter"></a>2.1 filter</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Observable.of(1, 2, 10, 12)</span><br><span class="line">    .filter &#123;$0 &gt; 10&#125;</span><br><span class="line">    .subscribe(onNext: &#123;print($0)&#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line">&#x2F;&#x2F;结果：12</span><br></pre></td></tr></table></figure>

<h5 id="2-2-distinctUntilChanged"><a href="#2-2-distinctUntilChanged" class="headerlink" title="2.2 distinctUntilChanged"></a>2.2 distinctUntilChanged</h5><p>过滤掉连续重复事件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Observable.of(1, 1, 10, 1)</span><br><span class="line">    .distinctUntilChanged()</span><br><span class="line">    .subscribe(onNext: &#123;print($0)&#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line">结果</span><br><span class="line">1</span><br><span class="line">10</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<h5 id="2-3-single"><a href="#2-3-single" class="headerlink" title="2.3 single"></a>2.3 single</h5><p>限制只发送一次事件，或满足条件的第一个事件<br>如果存在多个事件或没有事件会发出一个error<br>如果只有一个事件，则不会发出error事件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Observable.of(1, 2, 3)</span><br><span class="line">    .single&#123;$0 &#x3D;&#x3D; 2&#125;</span><br><span class="line">    .subscribe(onNext: &#123;print($0)&#125;) &#x2F;&#x2F;结果 2</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line">   </span><br><span class="line">Observable.of(&quot;A&quot;, &quot;B&quot;, &quot;C&quot;)</span><br><span class="line">            .single()</span><br><span class="line">            .subscribe(onNext: &#123;print($0)&#125;, onError: &#123; error in</span><br><span class="line">                print(error)</span><br><span class="line">            &#125;)</span><br><span class="line">            .disposed(by: disposeBag)</span><br><span class="line">结果：</span><br><span class="line">A</span><br><span class="line">Sequence contains more than one element.</span><br></pre></td></tr></table></figure>

<h5 id="2-4-elementAt"><a href="#2-4-elementAt" class="headerlink" title="2.4 elementAt"></a>2.4 elementAt</h5><p>只处理指定位置事件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Observable.of(1, 2, 3)</span><br><span class="line">    .elementAt(2)</span><br><span class="line">    .subscribe(onNext: &#123;print($0)&#125;) &#x2F;&#x2F;3</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h5 id="2-5-ignoreElements"><a href="#2-5-ignoreElements" class="headerlink" title="2.5 ignoreElements"></a>2.5 ignoreElements</h5><p>可以忽略所有元素，只发出error或complete事件<br>如果并不关心Observable任何元素，只想知道Observable在什么时候终止，可以用ignoreElements</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Observable.of(1, 2, 3)</span><br><span class="line">    .ignoreElements()</span><br><span class="line">    .subscribe&#123;print($0)&#125; &#x2F;&#x2F;completed</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h5 id="2-6-take"><a href="#2-6-take" class="headerlink" title="2.6 take"></a>2.6 take</h5><p>实现仅发送Observable序列前n个事件，满足数量后自动.complete</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Observable.of(1, 2, 3)</span><br><span class="line">   .take(2)</span><br><span class="line">   .subscribe&#123;print($0)&#125;</span><br><span class="line">   .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h5 id="2-7-takeLast"><a href="#2-7-takeLast" class="headerlink" title="2.7 takeLast"></a>2.7 takeLast</h5><p>仅发送Observable序列中的后n个元素</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Observable.of(1, 2, 3)</span><br><span class="line">   .takeLast(1)</span><br><span class="line">   .subscribe&#123;print($0)&#125;</span><br><span class="line">   .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h5 id="2-8-skip"><a href="#2-8-skip" class="headerlink" title="2.8 skip"></a>2.8 skip</h5><p>跳过源Observable序列发出的前n个事件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Observable.of(1, 2, 3)</span><br><span class="line">   .skip(2)</span><br><span class="line">   .subscribe&#123;print($0)&#125;</span><br><span class="line">   .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h5 id="2-9-Sample"><a href="#2-9-Sample" class="headerlink" title="2.9 Sample"></a>2.9 Sample</h5><p>除了订阅源Observable外，还能监视另外一个Observable，即notifier<br>每当收到notifier事件，就会从源序列取一个最新事件发送</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let source &#x3D; PublishSubject&lt;Int&gt;()</span><br><span class="line">let notifier &#x3D; PublishSubject&lt;String&gt;()</span><br><span class="line"> </span><br><span class="line">source</span><br><span class="line">    .sample(notifier)</span><br><span class="line">    .subscribe(onNext: &#123; print($0) &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line"> </span><br><span class="line">source.onNext(1)</span><br><span class="line">&#x2F;&#x2F;让源序列接收接收消息</span><br><span class="line">notifier.onNext(&quot;A&quot;)</span><br><span class="line">source.onNext(2)</span><br><span class="line">&#x2F;&#x2F;让源序列接收接收消息</span><br><span class="line">notifier.onNext(&quot;B&quot;)</span><br><span class="line">notifier.onNext(&quot;C&quot;)</span><br><span class="line">source.onNext(3)</span><br><span class="line">source.onNext(4)</span><br><span class="line">&#x2F;&#x2F;让源序列接收接收消息</span><br><span class="line">notifier.onNext(&quot;D&quot;)</span><br><span class="line">source.onNext(5)</span><br><span class="line">&#x2F;&#x2F;让源序列接收接收消息</span><br><span class="line">notifier.onCompleted()</span><br><span class="line"></span><br><span class="line">结果：</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td></tr></table></figure>

<h5 id="2-10-debounce"><a href="#2-10-debounce" class="headerlink" title="2.10 debounce"></a>2.10 debounce</h5><p>可以过滤掉高频产生的元素<br>队列中的元素如果和下一个元素的间隔小于了指定时间间隔，那这元素将被过滤掉<br>常用在输入的时候，不需要每个字母敲进去都发送一个事件，而是稍等下取最后一个事件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let times &#x3D; [</span><br><span class="line">    [ &quot;value&quot;: 1, &quot;time&quot;: 100 ], &#x2F;&#x2F;0.1s</span><br><span class="line">    [ &quot;value&quot;: 2, &quot;time&quot;: 110 ],</span><br><span class="line">    [ &quot;value&quot;: 3, &quot;time&quot;: 120 ],</span><br><span class="line">    [ &quot;value&quot;: 4, &quot;time&quot;: 120 ],</span><br><span class="line">    [ &quot;value&quot;: 5, &quot;time&quot;: 140 ],</span><br><span class="line">    [ &quot;value&quot;: 6, &quot;time&quot;: 210 ]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">Observable.from(times)</span><br><span class="line">    </span><br><span class="line">    .flatMap &#123; item in</span><br><span class="line">        return Observable.of(Int(item[&quot;value&quot;]!))</span><br><span class="line">            .delay(RxTimeInterval.milliseconds(Int(item[&quot;time&quot;]!)), scheduler: MainScheduler.instance)</span><br><span class="line">    &#125;</span><br><span class="line">    .debounce(RxTimeInterval.milliseconds(500), scheduler: MainScheduler.instance)</span><br><span class="line">    .subscribe(onNext: &#123; print($0) &#125;)&#x2F;&#x2F;只发出与下一个间隔超过0.5s的元素</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h4 id="3-条件与布尔操作符"><a href="#3-条件与布尔操作符" class="headerlink" title="3 条件与布尔操作符"></a>3 条件与布尔操作符</h4><h5 id="3-1-amb"><a href="#3-1-amb" class="headerlink" title="3.1 amb"></a>3.1 amb</h5><p>传入多个Observables到amb操作符，将取第一个发出元素或产生事件的Observable，然后只发出它的元素，忽略其它Observable</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let subject1 &#x3D; PublishSubject&lt;Int&gt;()</span><br><span class="line">let subject2 &#x3D; PublishSubject&lt;Int&gt;()</span><br><span class="line">let subject3 &#x3D; PublishSubject&lt;Int&gt;()</span><br><span class="line"></span><br><span class="line">subject1</span><br><span class="line">.amb(subject2)</span><br><span class="line">.amb(subject3)</span><br><span class="line">.subscribe&#123;print($0)&#125;</span><br><span class="line">.disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">subject2.onNext(1)&#x2F;&#x2F;最先发</span><br><span class="line">subject1.onNext(20)</span><br><span class="line">subject2.onNext(2)</span><br><span class="line">subject1.onNext(40)</span><br><span class="line">subject3.onNext(0)</span><br><span class="line">subject2.onNext(3)</span><br><span class="line">subject1.onNext(60)</span><br><span class="line">subject3.onNext(0)</span><br><span class="line">subject3.onNext(0)</span><br><span class="line">结果：</span><br><span class="line">next(1)</span><br><span class="line">next(2)</span><br><span class="line">next(3)</span><br></pre></td></tr></table></figure>

<h5 id="3-2-takeWhile"><a href="#3-2-takeWhile" class="headerlink" title="3.2 takeWhile"></a>3.2 takeWhile</h5><p>依次判断Observable序列每个值是否满足条件，第一个不满足值出现，便自动完成</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Observable.of(1, 2, 3)</span><br><span class="line">    .takeWhile&#123; $0 &lt; 2&#125;</span><br><span class="line">    .subscribe&#123;print($0)&#125;</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h5 id="3-3-takeUntil"><a href="#3-3-takeUntil" class="headerlink" title="3.3 takeUntil"></a>3.3 takeUntil</h5><p>可以监听另外一个Observable，即notifier<br>notifier发出值或complete通知，源Observable便自动完成，停止发送事件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let source &#x3D; PublishSubject&lt;String&gt;()</span><br><span class="line">let notifier &#x3D; PublishSubject&lt;String&gt;()</span><br><span class="line"> </span><br><span class="line">source</span><br><span class="line">    .takeUntil(notifier)</span><br><span class="line">    .subscribe(onNext: &#123; print($0) &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line"> </span><br><span class="line">source.onNext(&quot;a&quot;)</span><br><span class="line">source.onNext(&quot;b&quot;)</span><br><span class="line">source.onNext(&quot;c&quot;)</span><br><span class="line">source.onNext(&quot;d&quot;)</span><br><span class="line"> </span><br><span class="line">&#x2F;&#x2F;停止接收消息</span><br><span class="line">notifier.onNext(&quot;z&quot;)</span><br><span class="line"> </span><br><span class="line">source.onNext(&quot;e&quot;)</span><br><span class="line">source.onNext(&quot;f&quot;)</span><br><span class="line">source.onNext(&quot;g&quot;)</span><br><span class="line">结果：</span><br><span class="line">a</span><br><span class="line">b</span><br><span class="line">c</span><br><span class="line">d</span><br></pre></td></tr></table></figure>

<h5 id="3-4-skipWhile"><a href="#3-4-skipWhile" class="headerlink" title="3.4 skipWhile"></a>3.4 skipWhile</h5><p>跳过前面满足条件的事件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Observable.of(2, 3, 4, 5, 6)</span><br><span class="line">    .skipWhile &#123; $0 &lt; 4 &#125;</span><br><span class="line">    .subscribe(onNext: &#123; print($0) &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h5 id="3-5-skipUntil"><a href="#3-5-skipUntil" class="headerlink" title="3.5 skipUntil"></a>3.5 skipUntil</h5><p>类似takeUntil，还可以监听另外一个Observable<br>和takeUntil相反，默认会一直跳过，直到notifier发出值</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let source &#x3D; PublishSubject&lt;Int&gt;()</span><br><span class="line">let notifier &#x3D; PublishSubject&lt;Int&gt;()</span><br><span class="line"> </span><br><span class="line">source</span><br><span class="line">    .skipUntil(notifier)</span><br><span class="line">    .subscribe(onNext: &#123; print($0) &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line"> </span><br><span class="line">source.onNext(1)</span><br><span class="line">source.onNext(2)</span><br><span class="line">source.onNext(3)</span><br><span class="line">source.onNext(4)</span><br><span class="line">source.onNext(5)</span><br><span class="line"> </span><br><span class="line">&#x2F;&#x2F;开始接收消息</span><br><span class="line">notifier.onNext(0)</span><br><span class="line">source.onNext(6)</span><br><span class="line">source.onNext(7)</span><br><span class="line">source.onNext(8)</span><br><span class="line"> </span><br><span class="line">&#x2F;&#x2F;仍然接收消息</span><br><span class="line">notifier.onNext(0)</span><br><span class="line">source.onNext(9)</span><br><span class="line">结果：</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td></tr></table></figure>

<h4 id="4-结合操作符"><a href="#4-结合操作符" class="headerlink" title="4 结合操作符"></a>4 结合操作符</h4><p>将多个Observable序列进行组合，拼装成一个新的Observable</p>
<h5 id="4-1-startWith"><a href="#4-1-startWith" class="headerlink" title="4.1 startWith"></a>4.1 startWith</h5><p>在Observable序列开始前插入一些事件元素，也可以多次startWith</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Observable.of(2, 3)</span><br><span class="line">    .startWith(1)</span><br><span class="line">    .subscribe(onNext: &#123; print($0) &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h5 id="4-2-merge"><a href="#4-2-merge" class="headerlink" title="4.2 merge"></a>4.2 merge</h5><p>将多个Observable序列合并成一个Observable序列</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let subject1 &#x3D; PublishSubject&lt;Int&gt;()</span><br><span class="line">let subject2 &#x3D; PublishSubject&lt;Int&gt;()</span><br><span class="line"></span><br><span class="line">Observable.of(subject1, subject2)</span><br><span class="line">    .merge()</span><br><span class="line">    .subscribe(onNext: &#123;print($0)&#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">subject1.onNext(20)</span><br><span class="line">subject1.onNext(60)</span><br><span class="line">subject2.onNext(1)</span><br><span class="line">subject1.onNext(80)</span><br><span class="line">subject2.onNext(1)</span><br><span class="line">结果：</span><br><span class="line">20</span><br><span class="line">60</span><br><span class="line">1</span><br><span class="line">80</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<h5 id="4-3-zip"><a href="#4-3-zip" class="headerlink" title="4.3 zip"></a>4.3 zip</h5><p>多个Observable序列压缩成一个Observable序列<br>会等每个Observables事件一一对应凑齐后合并</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let subject1 &#x3D; PublishSubject&lt;Int&gt;()</span><br><span class="line">let subject2 &#x3D; PublishSubject&lt;String&gt;()</span><br><span class="line"></span><br><span class="line">Observable.zip(subject1, subject2) &#123;</span><br><span class="line">        &quot;\($0)\($1)&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    .subscribe(onNext: &#123;print($0)&#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">subject1.onNext(1)</span><br><span class="line">subject2.onNext(&quot;A&quot;)</span><br><span class="line">subject1.onNext(2)</span><br><span class="line">subject2.onNext(&quot;B&quot;)</span><br><span class="line">subject2.onNext(&quot;C&quot;)</span><br><span class="line">subject2.onNext(&quot;D&quot;)</span><br><span class="line">subject1.onNext(3)</span><br><span class="line">subject1.onNext(4)</span><br><span class="line">subject1.onNext(5)</span><br><span class="line">结果：</span><br><span class="line">1A</span><br><span class="line">2B</span><br><span class="line">3C</span><br><span class="line">4D</span><br></pre></td></tr></table></figure>

<p>常用在整合网络请求上，只有当两请求成功后，再两者结果整合起来继续往下处理</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;第一个请求</span><br><span class="line">let userRequest: Observable&lt;User&gt; &#x3D; API.getUser(&quot;me&quot;)</span><br><span class="line">&#x2F;&#x2F;第二个请求</span><br><span class="line">let friendsRequest: Observable&lt;Friends&gt; &#x3D; API.getFriends(&quot;me&quot;)</span><br><span class="line"> </span><br><span class="line">&#x2F;&#x2F;将两个请求合并处理</span><br><span class="line">Observable.zip(userRequest, friendsRequest) &#123;</span><br><span class="line">        user, friends in</span><br><span class="line">        &#x2F;&#x2F;将两个信号合并成一个信号，并压缩成一个元组返回（两个信号均成功）</span><br><span class="line">        return (user, friends)</span><br><span class="line">    &#125;</span><br><span class="line">    .observeOn(MainScheduler.instance) &#x2F;&#x2F;加这个是应为请求在后台线程，下面的绑定在前台线程。</span><br><span class="line">    .subscribe(onNext: &#123; (user, friends) in</span><br><span class="line">        &#x2F;&#x2F;将数据绑定到界面上</span><br><span class="line">        &#x2F;&#x2F;.......</span><br><span class="line">    &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h5 id="4-4-combineLatest"><a href="#4-4-combineLatest" class="headerlink" title="4.4 combineLatest"></a>4.4 combineLatest</h5><p>将多个Observable序列元素进行合并<br>和zip不同的是，任意一个Observable有新事件发出，会将每个Observable序列的最新事件元素进行合并</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let subject1 &#x3D; PublishSubject&lt;Int&gt;()</span><br><span class="line">let subject2 &#x3D; PublishSubject&lt;String&gt;()</span><br><span class="line"> </span><br><span class="line">Observable.combineLatest(subject1, subject2) &#123;</span><br><span class="line">    &quot;\($0)\($1)&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    .subscribe(onNext: &#123; print($0) &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line"> </span><br><span class="line">subject1.onNext(1)</span><br><span class="line">subject2.onNext(&quot;A&quot;)</span><br><span class="line">subject1.onNext(2)</span><br><span class="line">subject2.onNext(&quot;B&quot;)</span><br><span class="line">subject2.onNext(&quot;C&quot;)</span><br><span class="line">subject2.onNext(&quot;D&quot;)</span><br><span class="line">subject1.onNext(3)</span><br><span class="line">subject1.onNext(4)</span><br><span class="line">subject1.onNext(5)</span><br><span class="line">结果：</span><br><span class="line">1A</span><br><span class="line">2A</span><br><span class="line">2B</span><br><span class="line">2C</span><br><span class="line">3D</span><br><span class="line">4D</span><br><span class="line">5D</span><br></pre></td></tr></table></figure>

<h5 id="4-5-withLatestFrom"><a href="#4-5-withLatestFrom" class="headerlink" title="4.5 withLatestFrom"></a>4.5 withLatestFrom</h5><p>将两个Observable序列合并为一个，self队列 发射一个元素时，就从第二个序列中取最新的一个值</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let subject1 &#x3D; PublishSubject&lt;String&gt;()</span><br><span class="line">let subject2 &#x3D; PublishSubject&lt;String&gt;()</span><br><span class="line"> </span><br><span class="line">subject1.withLatestFrom(subject2)</span><br><span class="line">    .subscribe(onNext: &#123; print($0) &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line"> </span><br><span class="line">subject1.onNext(&quot;A&quot;)</span><br><span class="line">subject2.onNext(&quot;1&quot;)</span><br><span class="line">subject1.onNext(&quot;B&quot;)</span><br><span class="line">subject1.onNext(&quot;C&quot;)</span><br><span class="line">subject2.onNext(&quot;2&quot;)</span><br><span class="line">subject1.onNext(&quot;D&quot;)</span><br><span class="line">结果：</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">2</span><br></pre></td></tr></table></figure>

<h5 id="4-6-switchLatest"><a href="#4-6-switchLatest" class="headerlink" title="4.6 switchLatest"></a>4.6 switchLatest</h5><p>可以对事件流进行切换<br>如：本来监听Subject1，通过value更换事件源后变成监听Subject2</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let subject1 &#x3D; BehaviorSubject(value: &quot;A&quot;)</span><br><span class="line">let subject2 &#x3D; BehaviorSubject(value: &quot;1&quot;)</span><br><span class="line">let replay &#x3D; BehaviorRelay(value: subject1)</span><br><span class="line">replay.asObservable()</span><br><span class="line">    .switchLatest()</span><br><span class="line">    .subscribe(onNext: &#123; print($0) &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line">subject1.onNext(&quot;B&quot;)</span><br><span class="line">subject1.onNext(&quot;C&quot;)</span><br><span class="line">&#x2F;&#x2F;改变事件源</span><br><span class="line">&#x2F;&#x2F;切换了源 不打印D 打印1 2</span><br><span class="line">replay.accept(subject2)</span><br><span class="line">subject1.onNext(&quot;D&quot;)</span><br><span class="line">subject2.onNext(&quot;2&quot;)</span><br><span class="line">&#x2F;&#x2F;改变事件源</span><br><span class="line">&#x2F;&#x2F;切换了源 不打印3 打印 D E</span><br><span class="line">replay.accept(subject1)</span><br><span class="line">subject2.onNext(&quot;3&quot;)</span><br><span class="line">subject1.onNext(&quot;E&quot;)</span><br><span class="line">结果：</span><br><span class="line">A</span><br><span class="line">B</span><br><span class="line">C</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">D</span><br><span class="line">E</span><br></pre></td></tr></table></figure>

<h4 id="5-算术、聚合操作符"><a href="#5-算术、聚合操作符" class="headerlink" title="5 算术、聚合操作符"></a>5 算术、聚合操作符</h4><h5 id="5-1-toArray"><a href="#5-1-toArray" class="headerlink" title="5.1 toArray"></a>5.1 toArray</h5><p>将序列转成一个数组，并作为一个单一的事件发送</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Observable.of(1, 2, 3)</span><br><span class="line">    .toArray()</span><br><span class="line">    .subscribe(onSuccess: &#123; print($0) &#125;) &#x2F;&#x2F;[1, 2, 3]</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h5 id="5-2-reduce"><a href="#5-2-reduce" class="headerlink" title="5.2 reduce"></a>5.2 reduce</h5><p>接受初始值和一个操作符<br>将给定初始值，和序列中每个值进行累计运算，等到最终结果，并将其作为单个值发送</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Observable.of(1, 2, 3, 4, 5)</span><br><span class="line">    .reduce(0, accumulator: +)</span><br><span class="line">    .subscribe(onNext: &#123; print($0) &#125;) &#x2F;&#x2F;15</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h5 id="5-3-concat"><a href="#5-3-concat" class="headerlink" title="5.3 concat"></a>5.3 concat</h5><p>把多个Observable序列合并（串联）为一个Observable序列<br>前一个Observable发出complete事件，才会开始发送下一个Observable序列</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">subject1 &#x3D; BehaviorSubject(value: 1)</span><br><span class="line">let subject2 &#x3D; BehaviorSubject(value: 2)</span><br><span class="line">let replay &#x3D; BehaviorRelay(value: subject1)</span><br><span class="line">replay.asObservable()</span><br><span class="line">    .concat()</span><br><span class="line">    .subscribe(onNext: &#123; print($0) &#125;)</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line">subject2.onNext(2)</span><br><span class="line">subject1.onNext(1)</span><br><span class="line">subject1.onNext(1)</span><br><span class="line">subject1.onCompleted()</span><br><span class="line">replay.accept(subject2)</span><br><span class="line">subject2.onNext(2)</span><br><span class="line">结果：</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">2</span><br></pre></td></tr></table></figure>

<h4 id="6-连接操作符"><a href="#6-连接操作符" class="headerlink" title="6 连接操作符"></a>6 连接操作符</h4><p>有订阅时不会立刻开始发送事件消息，只有当调用connect()之后才会开始发送消息<br>可以让所有订阅者订阅后，才开始发送事件消息，保证所有订阅者能接收到事件消息</p>
<p>对DispatchTime扩展 方便使用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">extension DispatchTime: ExpressibleByIntegerLiteral &#123;</span><br><span class="line">    public init(integerLiteral value: Int) &#123;</span><br><span class="line">        self &#x3D; DispatchTime.now() + .seconds(value)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">extension DispatchTime: ExpressibleByFloatLiteral &#123;</span><br><span class="line">    public init(floatLiteral value: Double) &#123;</span><br><span class="line">        self &#x3D; DispatchTime.now() + .milliseconds(Int(value * 1000))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加延迟执行方法</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">func delay(_ delay: Double, clousure: @escaping () -&gt; Void) &#123;</span><br><span class="line">    DispatchQueue.main.asyncAfter(deadline: DispatchTime(floatLiteral: delay)) &#123;</span><br><span class="line">        clousure()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="6-1-publish"><a href="#6-1-publish" class="headerlink" title="6.1 publish"></a>6.1 publish</h5><p>将正常序列转换成一个可连接序列，序列不会立刻发送事件，只有调用connect后才会开始</p>
<p>普通序列的样例<br>第一个订阅者订阅后每1秒接收一个值，第二个订阅者5秒后才收到第一个值0，所以两个订阅者接收到的值是不同步的</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let interval &#x3D; Observable&lt;Int&gt;.interval(DispatchTimeInterval.seconds(1), scheduler: MainScheduler.instance)</span><br><span class="line">_ &#x3D; interval.subscribe(onNext: &#123; print(&quot;订阅1：\($0)&quot;) &#125;)</span><br><span class="line">delay(5) &#123;</span><br><span class="line">    _ &#x3D; interval.subscribe(onNext: &#123; print(&quot;订阅2：\($0)&quot;) &#125;)</span><br><span class="line">&#125;</span><br><span class="line">结果：</span><br><span class="line">订阅1：0</span><br><span class="line">订阅1：1</span><br><span class="line">订阅1：2</span><br><span class="line">订阅1：3</span><br><span class="line">订阅1：4</span><br><span class="line">订阅1：5</span><br><span class="line">订阅2：0 &#x2F;&#x2F;不同步</span><br><span class="line">订阅1：6</span><br><span class="line">订阅2：1</span><br></pre></td></tr></table></figure>

<p>使用publish</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let interval &#x3D; Observable&lt;Int&gt;.interval(DispatchTimeInterval.seconds(1), scheduler: MainScheduler.instance).publish()</span><br><span class="line">&#x2F;&#x2F;第一个订阅者（立刻开始订阅）</span><br><span class="line">_ &#x3D; interval.subscribe(onNext: &#123;print($0)&#125;)</span><br><span class="line">&#x2F;&#x2F;相当于把事件推迟2秒</span><br><span class="line">delay(2) &#123;</span><br><span class="line">    _ &#x3D; interval.connect()</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;第2个订阅者 延迟5秒开始订阅</span><br><span class="line">delay(5) &#123;</span><br><span class="line">    _ &#x3D; interval.subscribe(onNext: &#123;print(&quot;订阅2 \($0)&quot;)&#125;)</span><br><span class="line">&#125;</span><br><span class="line">结果：&#x2F;&#x2F;输出同步</span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">订阅2 2</span><br><span class="line">3</span><br><span class="line">订阅2 3</span><br><span class="line">4</span><br><span class="line">订阅2 4</span><br><span class="line">5</span><br><span class="line">订阅2 5</span><br></pre></td></tr></table></figure>

<h5 id="6-2-relay"><a href="#6-2-relay" class="headerlink" title="6.2 relay"></a>6.2 relay</h5><p>和publish一样<br>不同在于，新订阅者还能收到订阅之前的事件消息，由bufferSize决定</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let interval &#x3D; Observable&lt;Int&gt;.interval(DispatchTimeInterval.seconds(1), scheduler: MainScheduler.instance).replay(3)</span><br><span class="line">_ &#x3D; interval.subscribe(onNext: &#123;print(&quot;订阅1 \($0)&quot;)&#125;)</span><br><span class="line">&#x2F;&#x2F;相当于把事件推迟2秒</span><br><span class="line">delay(2) &#123;</span><br><span class="line">    _ &#x3D; interval.connect()</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;第2个订阅者 延迟5秒开始订阅</span><br><span class="line">delay(5) &#123;</span><br><span class="line">    _ &#x3D; interval.subscribe(onNext: &#123;print(&quot;订阅2 \($0)&quot;)&#125;)</span><br><span class="line">&#125;</span><br><span class="line">结果：</span><br><span class="line">订阅1 0</span><br><span class="line">订阅1 1</span><br><span class="line">订阅2 0</span><br><span class="line">订阅2 1</span><br><span class="line">订阅1 2</span><br><span class="line">订阅2 2</span><br><span class="line">订阅1 3</span><br><span class="line">订阅2 3</span><br><span class="line">订阅1 4</span><br><span class="line">订阅2 4</span><br></pre></td></tr></table></figure>

<h5 id="6-3-multicast"><a href="#6-3-multicast" class="headerlink" title="6.3 multicast"></a>6.3 multicast</h5><p>同样是将序列转换成一个可连接序列<br>还可以传入一个subject，每当序列发送事件都会触发这个subject的发送</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let subject &#x3D; PublishSubject&lt;Int&gt;()</span><br><span class="line">_ &#x3D; subject.subscribe(onNext: &#123;print(&quot;subject \($0)&quot;)&#125;)</span><br><span class="line"></span><br><span class="line">let interval &#x3D; Observable&lt;Int&gt;.interval(DispatchTimeInterval.seconds(1), scheduler: MainScheduler.instance).multicast(subject)</span><br><span class="line">_ &#x3D; interval.subscribe(onNext: &#123;print(&quot;订阅1 \($0)&quot;)&#125;)</span><br><span class="line">&#x2F;&#x2F;相当于把事件推迟2秒</span><br><span class="line">delay(2) &#123;</span><br><span class="line">    _ &#x3D; interval.connect()</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;第2个订阅者 延迟5秒开始订阅</span><br><span class="line">delay(5) &#123;</span><br><span class="line">    _ &#x3D; interval.subscribe(onNext: &#123;print(&quot;订阅2 \($0)&quot;)&#125;)</span><br><span class="line">&#125;</span><br><span class="line">结果：</span><br><span class="line">subject 0</span><br><span class="line">订阅1 0</span><br><span class="line">subject 1</span><br><span class="line">订阅1 1</span><br><span class="line">subject 2</span><br><span class="line">订阅1 2</span><br><span class="line">订阅2 2</span><br><span class="line">subject 3</span><br><span class="line">订阅1 3</span><br><span class="line">订阅2 3</span><br><span class="line">subject 4</span><br><span class="line">订阅1 4</span><br><span class="line">订阅2 4</span><br></pre></td></tr></table></figure>

<h5 id="6-4-refCount"><a href="#6-4-refCount" class="headerlink" title="6.4 refCount"></a>6.4 refCount</h5><p>可以将可被连接的observable转换为普通observable<br>可自动连接和断开可连接的observable，第一个观察者对可连接的observable订阅时，底层的observable将被自动连接，最后一个观察者离开时，底层的observable将自动断开连接</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">let interval &#x3D; Observable&lt;Int&gt;.interval(DispatchTimeInterval.seconds(1), scheduler: MainScheduler.instance).publish().refCount()</span><br></pre></td></tr></table></figure>

<h5 id="6-5-share-relay"><a href="#6-5-share-relay" class="headerlink" title="6.5 share(relay:)"></a>6.5 share(relay:)</h5><p>使观察者共享源observable，并且缓存最新的n个元素，将这些元素直接发送给新的观察者<br>是replay和refCount组合</p>
<h4 id="7-其它操作符"><a href="#7-其它操作符" class="headerlink" title="7 其它操作符"></a>7 其它操作符</h4><h5 id="7-1-delay"><a href="#7-1-delay" class="headerlink" title="7.1 delay"></a>7.1 delay</h5><p>将observable所有元素拖延一段时间后发送出来</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Observable.of(1, 2, 3)</span><br><span class="line">    .delay(DispatchTimeInterval.seconds(3), scheduler: MainScheduler.instance)</span><br><span class="line">.subscribe(onNext: &#123;print($0)&#125;)</span><br><span class="line">.disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h5 id="10-2-delaySubscription"><a href="#10-2-delaySubscription" class="headerlink" title="10.2 delaySubscription"></a>10.2 delaySubscription</h5><p>进行延时订阅，经过设定时间后，才对observable订阅</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Observable.of(1, 2, 3)</span><br><span class="line">    .delaySubscription(DispatchTimeInterval.seconds(3), scheduler: MainScheduler.instance)</span><br><span class="line">.subscribe(onNext: &#123;print($0)&#125;)</span><br><span class="line">.disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h5 id="7-3-materialize"><a href="#7-3-materialize" class="headerlink" title="7.3 materialize"></a>7.3 materialize</h5><p>可将序列产生的事件，转换成元素</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Observable.of(1, 2, 3)</span><br><span class="line">  .materialize()</span><br><span class="line">  .subscribe(onNext: &#123;print($0)&#125;)</span><br><span class="line">  .disposed(by: disposeBag)</span><br><span class="line">结果：</span><br><span class="line">next(1)</span><br><span class="line">next(2)</span><br><span class="line">next(3)</span><br><span class="line">completed</span><br></pre></td></tr></table></figure>

<h5 id="7-4-dematerialize"><a href="#7-4-dematerialize" class="headerlink" title="7.4 dematerialize"></a>7.4 dematerialize</h5><p>和materialize相反，将materialize转换后的元素还原</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Observable.of(1, 2, 3)</span><br><span class="line">  .materialize()</span><br><span class="line">  .dematerialize()</span><br><span class="line">  .subscribe(onNext: &#123;print($0)&#125;)</span><br><span class="line">  .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>

<h5 id="7-5-timeout"><a href="#7-5-timeout" class="headerlink" title="7.5 timeout"></a>7.5 timeout</h5><p>设置超时时间，源observable规定时间内没发出元素，就产生一个超时的error</p>
<h5 id="7-6-using"><a href="#7-6-using" class="headerlink" title="7.6 using"></a>7.6 using</h5><p>使用using创建observable时，同时会创建一个可被清除的资源，一旦observable终止，那这资源就被清除了</p>
<p><a href="https://www.hangge.com/blog/cache/detail_1922.html">RxSwift hangge.com</a></p>
]]></content>
  </entry>
  <entry>
    <title>dyld加载流程</title>
    <url>/2020/12/07/dyld%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B/</url>
    <content><![CDATA[<h4 id="编译过程"><a href="#编译过程" class="headerlink" title="编译过程"></a>编译过程</h4><ul>
<li>库：编译好的二进制文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">源文件 -&gt; 预编译 -&gt; 编译 -&gt; 汇编 -&gt; 链接 -&gt; 可执行文件</span><br></pre></td></tr></table></figure>

<p><code>源文件</code>：.h、 .m、 .cpp 等文件</p>
<p><code>预编译</code>：替换宏、删除注释，产生 <code>.i</code> 文件</p>
<p><code>编译</code>：编译高级语言代码成汇编底层代码，生成汇编代码文件 <code>.s</code></p>
<p><code>汇编</code>：将汇编代码转变成机器可执行的指令 <code>.o</code></p>
<p><code>链接</code>：将引用的静态库与汇编生成的目标文件 <code>.o</code> 一起打包生成可执行文件</p>
<h4 id="动态库、静态库"><a href="#动态库、静态库" class="headerlink" title="动态库、静态库"></a>动态库、静态库</h4><ul>
<li>静态库 .a、 .lib</li>
</ul>
<p>在链接阶段，将汇编生成的目标文件.o与引用的库，一起链接打包到可执行文件</p>
<p>缺点：静态库会有两份，导致目标程序体积增大（编译时会直接拷贝一份，复制到目标程序里）</p>
<p>优点：编译完后，库文件就没有用了，目标程序没有外部依赖，可以直接运行</p>
<ul>
<li>动态库 .so</li>
</ul>
<p>编译时并不会链接到目标程序，只会存储指向动态库的引用，程序运行时才被载入</p>
<p>优点：多次使用共享内存，减少打包APP的体积</p>
<h4 id="dyld"><a href="#dyld" class="headerlink" title="dyld"></a>dyld</h4><p><code>dyld</code> ：动态库链接器，负责加载程序和程序依赖的动态库，内核读取 <code>Mach-O</code> 文件后，将读取内容交给 <code>dyld</code> 加载，<code>dyld</code> 加载完毕后才会执行 <code>main</code> 函数</p>
<p><code>dyld</code> 在系统中以一个用户态的可执行文件形式存在，一般应用程序会在 <code>Mach-O</code> 文件部分指定一个 <code>LC_LOAD_DYLINKER</code> 的加载命令，此加载命令指定了 <code>dyld</code> 的路径，通常默认值是 <code>/usr/lib/dyld</code></p>
<p>新建项目，在 <code>main</code> 函数中打断点，通过 <code>bt</code> 查看调用栈，看到 <code>App</code> 启动后会执行 <code>libdyld.dylib</code> 的 <code>start</code> 操作，这边调用栈的信息比较少</p>
<p><img src="/2020/12/07/dyld%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B/%E5%90%AF%E5%8A%A8main%E6%96%AD%E7%82%B9.jpg" alt="启动main断点"></p>
<p>继续在  <code>ViewController</code> 中重写 <code>load</code> 方法 ，<code>load</code> 方法打断点，通过 <code>bt</code> 查看调用栈，发现一个 <code>_dyld_start</code> 的调用</p>
<p><img src="/2020/12/07/dyld%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B/%E5%90%AF%E5%8A%A8load%E6%96%AD%E7%82%B9.jpg" alt="启动load断点"></p>
<p><code>dyld</code> 源码中搜索 <code>_dyld_start</code> ，可以在 <code>dyldStartup.s</code> 文件中找到 <code>_dyld_start</code> 的汇编实现，文件中按照 <code>i386</code>、<code>x86_64</code>、<code>arm64</code>、<code>arm</code> 不同架构做了逻辑处理</p>
<p>查看 <code>arm64</code> 架构下汇编源码</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __arm64__</span></span><br><span class="line">	.text</span><br><span class="line">	.align <span class="number">2</span></span><br><span class="line">	.globl __dyld_start</span><br><span class="line">__dyld_start:</span><br><span class="line">	...</span><br><span class="line">	<span class="comment">// call dyldbootstrap::start(app_mh, argc, argv, dyld_mh, &amp;startGlue)</span></span><br><span class="line">	bl	__ZN13dyldbootstrap5startEPKN5dyld311MachOLoadedEiPPKcS3_Pm</span><br><span class="line">	...</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// __arm64__</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>找到关键部分代码，看到 <code>bl</code> 跳转指令，看注释信息，这边会调用 <code>dyldbootstrap::start</code> </p>
<h4 id="dyldbootstrap-start"><a href="#dyldbootstrap-start" class="headerlink" title="dyldbootstrap::start"></a>dyldbootstrap::start</h4><p>【1】<code>dyldbootstrap::start</code></p>
<p>源码中搜索 <code>dyldbootstrap</code> 命名空间的 <code>start</code> 方法，这是 <code>dyld</code> 的启动函数</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">uintptr_t</span> <span class="title">start</span><span class="params">(<span class="keyword">const</span> dyld3::MachOLoaded* appsMachHeader, <span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[],</span></span></span><br><span class="line"><span class="function"><span class="params">				<span class="keyword">const</span> dyld3::MachOLoaded* dyldsMachHeader, <span class="keyword">uintptr_t</span>* startGlue)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Emit kdebug tracepoint to indicate dyld bootstrap has started &lt;rdar://46878536&gt;</span></span><br><span class="line">    dyld3::kdebug_trace_dyld_marker(DBG_DYLD_TIMING_BOOTSTRAP_START, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// if kernel had to slide dyld, we need to fix up load sensitive locations</span></span><br><span class="line">	<span class="comment">// we have to do this before using any global variables</span></span><br><span class="line">    rebaseDyld(dyldsMachHeader);</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	<span class="comment">// set up random value for stack canary</span></span><br><span class="line">	__guard_setup(apple);</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">	<span class="comment">// now that we are done bootstrapping dyld, call dyld&#x27;s main</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> appsSlide = appsMachHeader-&gt;getSlide();</span><br><span class="line">	<span class="keyword">return</span> dyld::_main((macho_header*)appsMachHeader, appsSlide, argc, argv, envp, apple, startGlue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>dyldbootstrap::start</code> 主要操作：</p>
<ol>
<li><p>调用 <code>rebaseDyld()</code> dyld 重定位</p>
</li>
<li><p><code>__guard_setup</code> 栈溢出保护</p>
</li>
<li><p><code>dyld::_main</code> 进入 <code>dyld</code> 的 <code>_main</code> 函数</p>
</li>
</ol>
<h4 id="dyld-main"><a href="#dyld-main" class="headerlink" title="dyld::_main"></a>dyld::_main</h4><p>【2】<code>dyld::_main</code></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Entry point for dyld.  The kernel loads dyld and jumps to __dyld_start which</span></span><br><span class="line"><span class="comment">// sets up some registers and call this function.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Returns address of main() in target program which __dyld_start jumps to</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">uintptr_t</span></span><br><span class="line">_main(<span class="keyword">const</span> macho_header* mainExecutableMH, <span class="keyword">uintptr_t</span> mainExecutableSlide, </span><br><span class="line">		<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span>* argv[], <span class="keyword">const</span> <span class="keyword">char</span>* envp[], <span class="keyword">const</span> <span class="keyword">char</span>* apple[], </span><br><span class="line">		<span class="keyword">uintptr_t</span>* startGlue)</span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="comment">//【1】初始化程序运行环境</span></span><br><span class="line">    <span class="comment">// Grab the cdHash of the main executable from the environment</span></span><br><span class="line">	<span class="keyword">uint8_t</span> mainExecutableCDHashBuffer[<span class="number">20</span>];</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">uint8_t</span>* mainExecutableCDHash = <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">if</span> ( hexToBytes(_simple_getenv(apple, <span class="string">&quot;executable_cdhash&quot;</span>), <span class="number">40</span>, mainExecutableCDHashBuffer) )</span><br><span class="line">		mainExecutableCDHash = mainExecutableCDHashBuffer;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	<span class="keyword">uintptr_t</span> result = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">//获取主程序的macho_header结构以及主程序的slide偏移值</span></span><br><span class="line">  <span class="comment">//保存执行文件头部，后续可以根据头部访问其他信息</span></span><br><span class="line">	sMainExecutableMachHeader = mainExecutableMH;</span><br><span class="line">	sMainExecutableSlide = mainExecutableSlide;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	CRSetCrashLogMessage(<span class="string">&quot;dyld: launch started&quot;</span>);</span><br><span class="line">	<span class="comment">//设置上下文信息</span></span><br><span class="line">	setContext(mainExecutableMH, argc, argv, envp, apple);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Pickup the pointer to the exec path.</span></span><br><span class="line">	<span class="comment">//获取可执行文件路径</span></span><br><span class="line">	sExecPath = _simple_getenv(apple, <span class="string">&quot;executable_path&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// &lt;rdar://problem/13868260&gt; Remove interim apple[0] transition code from dyld</span></span><br><span class="line">	<span class="keyword">if</span> (!sExecPath) sExecPath = apple[<span class="number">0</span>];</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	<span class="comment">//获取进程名称</span></span><br><span class="line">	<span class="comment">// Remember short name of process for later logging</span></span><br><span class="line">	sExecShortName = ::<span class="built_in">strrchr</span>(sExecPath, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">	<span class="keyword">if</span> ( sExecShortName != <span class="literal">NULL</span> )</span><br><span class="line">		++sExecShortName;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		sExecShortName = sExecPath;</span><br><span class="line">	</span><br><span class="line">	  <span class="comment">//配置进程受限模式</span></span><br><span class="line">    configureProcessRestrictions(mainExecutableMH, envp);</span><br><span class="line">	...</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//检查环境变量配置</span></span><br><span class="line">		checkEnvironmentVariables(envp);</span><br><span class="line">    <span class="comment">//如果 DYLD_FALLBACK 为nil，将其设置为默认值</span></span><br><span class="line">		defaultUninitializedFallbackPaths(envp);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//如果设置了 DYLD_PRINT_OPTS 环境变量，则打印参数</span></span><br><span class="line">	<span class="keyword">if</span> ( sEnv.DYLD_PRINT_OPTS )</span><br><span class="line">		printOptions(argv);</span><br><span class="line">  <span class="comment">//如果设置了 DYLD_PRINT_ENV 环境变量，则打印环境变量</span></span><br><span class="line">	<span class="keyword">if</span> ( sEnv.DYLD_PRINT_ENV ) </span><br><span class="line">		printEnvironmentVariables(envp);</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	<span class="comment">//读取Mach-O文件的header，获取当前程序架构信息</span></span><br><span class="line">	getHostInfo(mainExecutableMH, mainExecutableSlide);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// load shared cache</span></span><br><span class="line">	<span class="comment">//【2】加载共享缓存 shared cache</span></span><br><span class="line">  <span class="comment">//检查共享缓存是否开启 iOS中必须开启</span></span><br><span class="line">	checkSharedRegionDisable((dyld3::MachOLoaded*)mainExecutableMH, mainExecutableSlide);</span><br><span class="line">	<span class="keyword">if</span> ( gLinkContext.sharedRegionMode != ImageLoader::kDontUseSharedRegion ) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> TARGET_OS_SIMULATOR</span></span><br><span class="line">		<span class="keyword">if</span> ( sSharedCacheOverrideDir)</span><br><span class="line">      <span class="comment">//将共享缓存映射到共享区域</span></span><br><span class="line">			mapSharedCache();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		mapSharedCache();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="comment">// add dyld itself to UUID list</span></span><br><span class="line">		addDyldImageToUUIDList();</span><br><span class="line">		...</span><br><span class="line">		CRSetCrashLogMessage(sLoadingCrashMessage);</span><br><span class="line">		<span class="comment">// instantiate ImageLoader for main executable</span></span><br><span class="line">		<span class="comment">//【3】实例化主程序，并赋值给ImageLoader::LinkContext</span></span><br><span class="line">    <span class="comment">//加载可执行文件并生成一个ImageLoader实例对象</span></span><br><span class="line">		sMainExecutable = instantiateFromLoadedImage(mainExecutableMH, mainExecutableSlide, sExecPath);</span><br><span class="line">		gLinkContext.mainExecutable = sMainExecutable;</span><br><span class="line">		gLinkContext.mainExecutableCodeSigned = hasCodeSignatureLoadCommand(mainExecutableMH);</span><br><span class="line">		...</span><br><span class="line"></span><br><span class="line">		<span class="comment">// load any inserted libraries</span></span><br><span class="line">		<span class="comment">//【4】加载插入的动态库（加载所有 DYLD_INSERT_LIBRARIES 指定的库）</span></span><br><span class="line">		<span class="keyword">if</span>	( sEnv.DYLD_INSERT_LIBRARIES != <span class="literal">NULL</span> ) &#123;</span><br><span class="line">      <span class="comment">//遍历 DYLD_INSERT_LIBRARIES 环境变量</span></span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span>* lib = sEnv.DYLD_INSERT_LIBRARIES; *lib != <span class="literal">NULL</span>; ++lib) </span><br><span class="line">				loadInsertedDylib(*lib);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// record count of inserted libraries so that a flat search will look at </span></span><br><span class="line">		<span class="comment">// inserted libraries, then main, then others.</span></span><br><span class="line">		sInsertedDylibCount = sAllImages.size()<span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// link main executable</span></span><br><span class="line">		<span class="comment">//【5】链接主程序</span></span><br><span class="line">		gLinkContext.linkingMainExecutable = <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> SUPPORT_ACCELERATE_TABLES</span></span><br><span class="line">		<span class="keyword">if</span> ( mainExcutableAlreadyRebased ) &#123;</span><br><span class="line">			<span class="comment">// previous link() on main executable has already adjusted its internal pointers for ASLR</span></span><br><span class="line">			<span class="comment">// work around that by rebasing by inverse amount</span></span><br><span class="line">			sMainExecutable-&gt;rebase(gLinkContext, -mainExecutableSlide);</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		link(sMainExecutable, sEnv.DYLD_BIND_AT_LAUNCH, <span class="literal">true</span>, ImageLoader::RPathChain(<span class="literal">NULL</span>, <span class="literal">NULL</span>), <span class="number">-1</span>);</span><br><span class="line">		sMainExecutable-&gt;setNeverUnloadRecursive();</span><br><span class="line">		<span class="keyword">if</span> ( sMainExecutable-&gt;forceFlat() ) &#123;</span><br><span class="line">			gLinkContext.bindFlat = <span class="literal">true</span>;</span><br><span class="line">			gLinkContext.prebindUsage = ImageLoader::kUseNoPrebinding;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//【6】链接插入的动态库</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// link any inserted libraries</span></span><br><span class="line">		<span class="comment">// do this after linking main executable so that any dylibs pulled in by inserted </span></span><br><span class="line">		<span class="comment">// dylibs (e.g. libSystem) will not be in front of dylibs the program uses</span></span><br><span class="line">		<span class="keyword">if</span> ( sInsertedDylibCount &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">			<span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>; i &lt; sInsertedDylibCount; ++i) &#123;</span><br><span class="line">				ImageLoader* image = sAllImages[i+<span class="number">1</span>];</span><br><span class="line">				link(image, sEnv.DYLD_BIND_AT_LAUNCH, <span class="literal">true</span>, ImageLoader::RPathChain(<span class="literal">NULL</span>, <span class="literal">NULL</span>), <span class="number">-1</span>);</span><br><span class="line">				image-&gt;setNeverUnloadRecursive();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> ( gLinkContext.allowInterposing ) &#123;</span><br><span class="line">				<span class="comment">// only INSERTED libraries can interpose</span></span><br><span class="line">				<span class="comment">// register interposing info after all inserted libraries are bound so chaining works</span></span><br><span class="line">				<span class="keyword">for</span>(<span class="keyword">unsigned</span> <span class="keyword">int</span> i=<span class="number">0</span>; i &lt; sInsertedDylibCount; ++i) &#123;</span><br><span class="line">					ImageLoader* image = sAllImages[i+<span class="number">1</span>];</span><br><span class="line">					image-&gt;registerInterposing(gLinkContext);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		...</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//【7】链接所有插入的image后，执行弱符号绑定</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">// &lt;rdar://problem/12186933&gt; do weak binding only after all inserted images linked</span></span><br><span class="line">		sMainExecutable-&gt;weakBind(gLinkContext);</span><br><span class="line">		gLinkContext.linkingMainExecutable = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		sMainExecutable-&gt;recursiveMakeDataReadOnly(gLinkContext);</span><br><span class="line"></span><br><span class="line">		CRSetCrashLogMessage(<span class="string">&quot;dyld: launch, running initializers&quot;</span>);</span><br><span class="line">	<span class="meta">#<span class="meta-keyword">if</span> SUPPORT_OLD_CRT_INITIALIZATION</span></span><br><span class="line">		<span class="comment">// Old way is to run initializers via a callback from crt1.o</span></span><br><span class="line">		<span class="keyword">if</span> ( ! gRunInitializersOldWay ) </span><br><span class="line">			initializeMainExecutable(); </span><br><span class="line">	<span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		<span class="comment">//【8】执行所有初始化方法</span></span><br><span class="line">		<span class="comment">// run all initializers</span></span><br><span class="line">		initializeMainExecutable(); </span><br><span class="line">	<span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		...</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">//【9】查找主程序的入口并返回</span></span><br><span class="line">			<span class="comment">// find entry point for main executable</span></span><br><span class="line">			result = (<span class="keyword">uintptr_t</span>)sMainExecutable-&gt;getEntryFromLC_MAIN();</span><br><span class="line">			<span class="keyword">if</span> ( result != <span class="number">0</span> ) &#123;</span><br><span class="line">				<span class="comment">// main executable uses LC_MAIN, we need to use helper in libdyld to call into main()</span></span><br><span class="line">				<span class="keyword">if</span> ( (gLibSystemHelpers != <span class="literal">NULL</span>) &amp;&amp; (gLibSystemHelpers-&gt;version &gt;= <span class="number">9</span>) )</span><br><span class="line">					*startGlue = (<span class="keyword">uintptr_t</span>)gLibSystemHelpers-&gt;startGlueToCallExit;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">					halt(<span class="string">&quot;libdyld.dylib support not present for LC_MAIN&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="comment">// main executable uses LC_UNIXTHREAD, dyld needs to let &quot;start&quot; in program set up for main()</span></span><br><span class="line">				result = (<span class="keyword">uintptr_t</span>)sMainExecutable-&gt;getEntryFromLC_UNIXTHREAD();</span><br><span class="line">				*startGlue = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="dyld-加载流程"><a href="#dyld-加载流程" class="headerlink" title="dyld 加载流程"></a><code>dyld</code> 加载流程</h4><p><code>dyld</code> 的加载流程主要包括以下 9 个步骤：</p>
<ol>
<li>主程序运行环境初始化，获取当前运行架构</li>
<li>加载共享缓存，检查共享缓存是否映射到共享区域</li>
<li>加载可执行文件，生成一个 <code>ImageLoader</code> 实例对象</li>
<li>加载插入的动态库</li>
<li>链接主程序</li>
<li>链接动态库</li>
<li>弱符号绑定</li>
<li>执行初始化方法</li>
<li>寻找程序入口 <code>LC_MAIN</code></li>
</ol>
<ul>
<li>分析第 8 步</li>
</ul>
<h4 id="initializeMainExecutable-执行初始化方法"><a href="#initializeMainExecutable-执行初始化方法" class="headerlink" title="initializeMainExecutable 执行初始化方法"></a>initializeMainExecutable 执行初始化方法</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initializeMainExecutable</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="comment">//循环遍历，对插入的 dylib 调用 runInitializers 方法进行初始化</span></span><br><span class="line">	<span class="comment">// run initialzers for any inserted dylibs</span></span><br><span class="line">	ImageLoader::InitializerTimingList initializerTimes[allImagesCount()];</span><br><span class="line">	initializerTimes[<span class="number">0</span>].count = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">size_t</span> rootCount = sImageRoots.size();</span><br><span class="line">	<span class="keyword">if</span> ( rootCount &gt; <span class="number">1</span> ) &#123;</span><br><span class="line">		<span class="keyword">for</span>(<span class="keyword">size_t</span> i=<span class="number">1</span>; i &lt; rootCount; ++i) &#123;</span><br><span class="line">			sImageRoots[i]-&gt;runInitializers(gLinkContext, initializerTimes[<span class="number">0</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//主程序调用 runInitializers 方法初始化</span></span><br><span class="line">	<span class="comment">// run initializers for main executable and everything it brings up </span></span><br><span class="line">	sMainExecutable-&gt;runInitializers(gLinkContext, initializerTimes[<span class="number">0</span>]);</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>runInitializers</code>  内部调用了 <code>processInitializers</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ImageLoader::runInitializers</span><span class="params">(<span class="keyword">const</span> LinkContext&amp; context, InitializerTimingList&amp; timingInfo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	...</span><br><span class="line">	processInitializers(context, thisThread, timingInfo, up);</span><br><span class="line">	context.notifyBatch(dyld_image_state_initialized, <span class="literal">false</span>);</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>processInitializers</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ImageLoader::processInitializers</span><span class="params">(<span class="keyword">const</span> LinkContext&amp; context, <span class="keyword">mach_port_t</span> thisThread, InitializerTimingList&amp; timingInfo, ImageLoader::UninitedUpwards&amp; images)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="comment">// Calling recursive init on all images in images list, building a new list of</span></span><br><span class="line">	<span class="comment">// uninitialized upward dependencies.</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">uintptr_t</span> i=<span class="number">0</span>; i &lt; images.count; ++i) &#123;</span><br><span class="line">		images.imagesAndPaths[i].first-&gt;recursiveInitialization(context, thisThread, images.imagesAndPaths[i].second, timingInfo, ups);</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对镜像列表调用 <code>recursiveInitialization</code> 递归初始化</p>
<p><code>recursiveInitialization</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ImageLoader::recursiveInitialization</span><span class="params">(<span class="keyword">const</span> LinkContext&amp; context, <span class="keyword">mach_port_t</span> this_thread, <span class="keyword">const</span> <span class="keyword">char</span>* pathToInitialize, InitializerTimingList&amp; timingInfo, UninitedUpwards&amp; uninitUps)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">recursive_lock <span class="title">lock_info</span><span class="params">(this_thread)</span></span>;</span><br><span class="line">	recursiveSpinLock(lock_info); <span class="comment">//递归枷锁</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( fState &lt; dyld_image_state_dependents_initialized<span class="number">-1</span> ) &#123;</span><br><span class="line">		<span class="keyword">uint8_t</span> oldState = fState;</span><br><span class="line">		<span class="comment">// break cycles</span></span><br><span class="line">		fState = dyld_image_state_dependents_initialized<span class="number">-1</span>;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">// initialize lower level libraries first</span></span><br><span class="line">			...</span><br><span class="line"></span><br><span class="line">			<span class="comment">// let objc know we are about to initialize this image 让objc知道将要初始化镜像</span></span><br><span class="line">			<span class="keyword">uint64_t</span> t1 = mach_absolute_time();</span><br><span class="line">			fState = dyld_image_state_dependents_initialized;</span><br><span class="line">			oldState = fState;</span><br><span class="line">			context.notifySingle(dyld_image_state_dependents_initialized, <span class="keyword">this</span>, &amp;timingInfo);</span><br><span class="line">			</span><br><span class="line">			<span class="comment">// initialize this image 初始化镜像</span></span><br><span class="line">			<span class="keyword">bool</span> hasInitializers = <span class="keyword">this</span>-&gt;doInitialization(context);</span><br><span class="line"></span><br><span class="line">			<span class="comment">// let anyone know we finished initializing this image 镜像初始化完成</span></span><br><span class="line">			fState = dyld_image_state_initialized;</span><br><span class="line">			oldState = fState;</span><br><span class="line">			context.notifySingle(dyld_image_state_initialized, <span class="keyword">this</span>, <span class="literal">NULL</span>);</span><br><span class="line">			...</span><br><span class="line">		&#125;</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">	recursiveSpinUnLock();<span class="comment">//递归解锁</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>initializeMainExecutable</code> -&gt; <code>runInitializers</code> -&gt; <code>processInitializers</code> -&gt; <code>recursiveInitialization</code> -&gt; <code>notifySingle</code></p>
<h5 id="doInitialization"><a href="#doInitialization" class="headerlink" title="doInitialization"></a>doInitialization</h5><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">ImageLoaderMachO::doInitialization</span><span class="params">(<span class="keyword">const</span> LinkContext&amp; context)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CRSetCrashLogMessage2(<span class="keyword">this</span>-&gt;getPath());</span><br><span class="line"></span><br><span class="line">	<span class="comment">// mach-o has -init and static initializers</span></span><br><span class="line">	doImageInit(context);</span><br><span class="line">	doModInitFunctions(context);<span class="comment">//加载c++构造函数</span></span><br><span class="line">	</span><br><span class="line">	CRSetCrashLogMessage2(<span class="literal">NULL</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> (fHasDashInit || fHasInitializers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c++构造方法，在 <code>mach-O</code>的 <code>data段</code> 中对应 <code>__mod_init_func</code></p>
<h5 id="notifySingle"><a href="#notifySingle" class="headerlink" title="notifySingle"></a>notifySingle</h5><p>继续在 <code>dyld2.cpp</code> 中找到 <code>notifySingle</code> 实现</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">notifySingle</span><span class="params">(dyld_image_states state, <span class="keyword">const</span> ImageLoader* image, ImageLoader::InitializerTimingList* timingInfo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="keyword">if</span> ( (state == dyld_image_state_dependents_initialized) &amp;&amp; (sNotifyObjCInit != <span class="literal">NULL</span>) &amp;&amp; image-&gt;notifyObjC() ) &#123;</span><br><span class="line">		<span class="keyword">uint64_t</span> t0 = mach_absolute_time();</span><br><span class="line">		<span class="function">dyld3::ScopedTimer <span class="title">timer</span><span class="params">(DBG_DYLD_TIMING_OBJC_INIT, (<span class="keyword">uint64_t</span>)image-&gt;machHeader(), <span class="number">0</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">		(*sNotifyObjCInit)(image-&gt;getRealPath(), image-&gt;machHeader());</span><br><span class="line">		<span class="keyword">uint64_t</span> t1 = mach_absolute_time();</span><br><span class="line">		<span class="keyword">uint64_t</span> t2 = mach_absolute_time();</span><br><span class="line">		<span class="keyword">uint64_t</span> timeInObjC = t1-t0;</span><br><span class="line">		<span class="keyword">uint64_t</span> emptyTime = (t2-t1)*<span class="number">100</span>;</span><br><span class="line">		<span class="keyword">if</span> ( (timeInObjC &gt; emptyTime) &amp;&amp; (timingInfo != <span class="literal">NULL</span>) ) &#123;</span><br><span class="line">			timingInfo-&gt;addTime(image-&gt;getShortName(), timeInObjC);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键函数指针 <code>sNotifyObjCInit</code> ，当前文件搜索 <code>sNotifyObjCInit</code> 找到赋值的地方</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">registerObjCNotifiers</span><span class="params">(_dyld_objc_notify_mapped mapped, _dyld_objc_notify_init init, _dyld_objc_notify_unmapped unmapped)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// record functions to call</span></span><br><span class="line">	sNotifyObjCMapped	= mapped;</span><br><span class="line">	sNotifyObjCInit		= init;</span><br><span class="line">	sNotifyObjCUnmapped = unmapped;</span><br></pre></td></tr></table></figure>

<p>再全局搜索 <code>registerObjCNotifiers</code> 查找到调用的地方</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> _dyld_objc_notify_register(_dyld_objc_notify_mapped    mapped,</span><br><span class="line">                                _dyld_objc_notify_init      init,</span><br><span class="line">                                _dyld_objc_notify_unmapped  unmapped)</span><br><span class="line">&#123;</span><br><span class="line">	dyld::registerObjCNotifiers(mapped, init, unmapped);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>什么时候调用了 <code>_dyld_objc_notify_register</code> ?</p>
<p>通过添加 <code>_dyld_objc_notify_register</code> 符号断点，运行后发现调用者是 <code>_objc_init</code>， <code>_objc_init</code> 函数是 <code>Runtime</code> 的入口函数</p>
<p><img src="/2020/12/07/dyld%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B/notifi_register.jpg" alt="notifi_register"></p>
<h4 id="objc-init"><a href="#objc-init" class="headerlink" title="_objc_init"></a>_objc_init</h4><p><code>_objc_init</code> 需要在 <code>libobjc</code> 源码中查看</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Called by libSystem BEFORE library initialization time</span></span><br><span class="line"><span class="keyword">void</span> _objc_init(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">bool</span> initialized = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (initialized) <span class="keyword">return</span>;</span><br><span class="line">    initialized = <span class="literal">true</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// fixme defer initialization until an objc-using image is found?</span></span><br><span class="line">    environ_init();</span><br><span class="line">    tls_init();</span><br><span class="line">    static_init();</span><br><span class="line">    runtime_init();</span><br><span class="line">    exception_init();</span><br><span class="line">    cache_init();</span><br><span class="line">    _imp_implementationWithBlock_init();</span><br><span class="line">    <span class="comment">//注册回调函数</span></span><br><span class="line">    _dyld_objc_notify_register(&amp;map_images, load_images, unmap_image);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __OBJC2__</span></span><br><span class="line">    didCallDyldNotifyRegister = <span class="literal">true</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看函数注释意思，<code>_objc_init</code> 的调用时机是在其他动态库初始化之前，由 <code>libSystem</code> 系统库调用</p>
<p>所以 <code>dyld</code> 加载的第 8 步，在初始化所有动态库和主程序之前，就注册了 <code>load_images</code> 的回调，Runtime调用 <code>load_images</code> 加载完所有 <code>load</code> 方法之后，就回调到 <code>dyld::_main</code> 的 <code>initializeMainExecutable()</code> </p>
<p><img src="/2020/12/07/dyld%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B/dyld.png" alt="dyld"></p>
<h4 id="共享缓存"><a href="#共享缓存" class="headerlink" title="共享缓存"></a>共享缓存</h4><p><code>dyld</code> 加载时，为了优化程序启动，启用了共享缓存技术。共享缓存会在进程启动时被 <code>dyld</code> 映射到内存中，之后，当任何 <code>Mach-O</code> 镜像加载时，<code>dyld</code> 首先会检查该 <code>Mach-O</code> 镜像与所需的动态库是否在共享缓存中，如果存在，则直接将它在共享内存中的内存地址映射到进程的内存地址空间。在程序依赖的系统动态库很多的情况下，这种做法对程序启动性能是有明显提升的。</p>
<p><a href="https://opensource.apple.com/tarballs/dyld/">dyld750.6下载</a></p>
<p><a href="https://www.jianshu.com/p/e383013ca846">dyld 流程分析</a></p>
<p><a href="https://www.jianshu.com/p/db765ff4e36a">dyld加载流程</a></p>
]]></content>
  </entry>
  <entry>
    <title>《Flutter实战第二版》七：功能型组件</title>
    <url>/2022/01/18/%E3%80%8AFlutter%E5%AE%9E%E6%88%98%E7%AC%AC%E4%BA%8C%E7%89%88%E3%80%8B%E4%B8%83%EF%BC%9A%E5%8A%9F%E8%83%BD%E5%9E%8B%E7%BB%84%E4%BB%B6/</url>
    <content><![CDATA[<h3 id="7-功能型组件"><a href="#7-功能型组件" class="headerlink" title="7 功能型组件"></a>7 功能型组件</h3><p>功能型组件指的是不影响UI布局及外观的组件，通常具有一定的功能，如事件监听、数据存储等</p>
<p>FocusScope（焦点控制住）、PageStorage（数据存储）、NotificationListener（事件监听）都属于功能型组件</p>
<h4 id="7-1-导航返回拦截-WillPopScope"><a href="#7-1-导航返回拦截-WillPopScope" class="headerlink" title="7.1 导航返回拦截 WillPopScope"></a>7.1 导航返回拦截 WillPopScope</h4><p>Flutter 可以通过 willPopScope 来实现返回按钮拦截</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> WillPopScope(&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">required</span> WillPopCallback onWillPop,</span><br><span class="line">  <span class="keyword">required</span> Widget child</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>onWillPop 当用户点击返回按钮时被调用，该回调需要返回一个 Future 对象</p>
<ul>
<li>示例</li>
</ul>
<p>为防止用户误触返回键退出，拦截返回事件。用户 1 秒内点击两次返回按钮时，则退出；如果间隔超过 1 秒则不退出，并重新计时</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WillPopScopeTestRouteState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">WillPopScopeTestRoute</span>&gt; </span>&#123;</span><br><span class="line">  <span class="built_in">DateTime?</span> _lastPressedAt; <span class="comment">//上次点击时间</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> WillPopScope(</span><br><span class="line">      onWillPop: () <span class="keyword">async</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (_lastPressedAt == <span class="keyword">null</span> ||</span><br><span class="line">            <span class="built_in">DateTime</span>.now().difference(_lastPressedAt!) &gt; <span class="built_in">Duration</span>(seconds: <span class="number">1</span>)) &#123;</span><br><span class="line">          <span class="comment">//两次点击间隔超过1秒则重新计时</span></span><br><span class="line">          _lastPressedAt = <span class="built_in">DateTime</span>.now();</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;,</span><br><span class="line">      child: Container(</span><br><span class="line">        alignment: Alignment.center,</span><br><span class="line">        child: Text(<span class="string">&quot;1秒内连续按两次返回键退出&quot;</span>),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="7-2-数据共享-InheritedWidget"><a href="#7-2-数据共享-InheritedWidget" class="headerlink" title="7.2 数据共享 InheritedWidget"></a>7.2 数据共享 InheritedWidget</h4><p>InheritedWidget 提供了一种在 widget 树中从上到下共享数据的方式。比如在根 widget 中通过 InheritedWidget 共享了一个数据，那么我们可以在任意子 widget 中获取共享的数据</p>
<p>Flutter SDK 中通过 InheritedWidget 来共享主题和 Locale 信息</p>
<h5 id="didChangeDependencies"><a href="#didChangeDependencies" class="headerlink" title="didChangeDependencies"></a>didChangeDependencies</h5><p>State 对象有个 didChangeDependencies 回调，它会在依赖发生变化时被 Flutter 框架调用，</p>
<p>这个依赖指的是，子 widget 是否使用了父 widget 中 InheritedWidget 的数据，</p>
<p>这种机制可以使子组件在依赖的 InheritedWidget 变化时更新自身，如主题、语言等变化时，依赖他们的子 widget 的 didChangeDependencies 会被调用</p>
<ul>
<li>示例</li>
</ul>
<p>首先通过继承 InheritedWidget，将计数器点击次数保存在 ShareDataWidget 的 data 属性中</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ShareDataWidget</span> <span class="keyword">extends</span> <span class="title">InheritedWidget</span> </span>&#123;</span><br><span class="line">  ShareDataWidget(&#123;</span><br><span class="line">    Key? key,</span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">this</span>.data, <span class="comment">//需要在子树中共享的数据，保存点击次数</span></span><br><span class="line">    <span class="keyword">required</span> Widget child,</span><br><span class="line">  &#125;) : <span class="keyword">super</span>(key: key, child: child);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">int</span> data;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//定义一个便捷方法，方便子树中的widget获取共享数据</span></span><br><span class="line">  <span class="keyword">static</span> ShareDataWidget? of(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> context.dependOnInheritedWidgetOfExactType&lt;ShareDataWidget&gt;();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//该回调决定当data发生变化时，是否通知子树中依赖data的Widget</span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">bool</span> updateShouldNotify(<span class="keyword">covariant</span> ShareDataWidget oldWidget) &#123;</span><br><span class="line">    <span class="keyword">return</span> oldWidget.data != data;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后实现一个子组件 _TestWidget，在 build 方法中引用了 ShareDataWidget 中的数据，同时在 didChangeDependencies 回调中打印日志 </p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_TestWidget</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> _TestWidget(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _TestWidgetState createState() =&gt; _TestWidgetState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_TestWidgetState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">_TestWidget</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="comment">//使用InheritedWidget中的共享数据</span></span><br><span class="line">    <span class="keyword">return</span> Text(ShareDataWidget.of(context)!.data.toString());</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> didChangeDependencies() &#123;</span><br><span class="line">    <span class="keyword">super</span>.didChangeDependencies();</span><br><span class="line">    <span class="comment">//父或祖先widget中的InheritedWidget改变(updateShouldNotify返回true)时会被调用。</span></span><br><span class="line">    <span class="comment">//如果build中没有依赖InheritedWidget，则此回调不会被调用。</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Dependencies change&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后创建按钮，每点击一次就 ShareDataWidget 的值自增</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InheritedWidgetTestRoute</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _InheritedWidgetTestRouteState createState() =&gt; _InheritedWidgetTestRouteState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_InheritedWidgetTestRouteState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">InheritedWidgetTestRoute</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(title: Text(<span class="string">&#x27;标题&#x27;</span>)),</span><br><span class="line">      body: Center(</span><br><span class="line">        child: ShareDataWidget(<span class="comment">//使用ShareDataWidget</span></span><br><span class="line">          data: count,</span><br><span class="line">          child: Column(</span><br><span class="line">            mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">            children: [</span><br><span class="line">              Padding(</span><br><span class="line">                padding: EdgeInsets.only(bottom: <span class="number">20.0</span>),</span><br><span class="line">                child: _TestWidget(),<span class="comment">//子widget中依赖ShareDataWidget</span></span><br><span class="line">              ),</span><br><span class="line">              ElevatedButton(</span><br><span class="line">                	<span class="comment">//每点击一次，将count自增，然后重新build,ShareDataWidget的data将被更新  </span></span><br><span class="line">                  onPressed: () =&gt; setState(() &#123;</span><br><span class="line">                    ++count;</span><br><span class="line">                  &#125;),</span><br><span class="line">                  child: Text(<span class="string">&#x27;Increment&#x27;</span>)</span><br><span class="line">              ),</span><br><span class="line">            ],</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》七：功能型组件/WeChat82decdb61c34cabc1597ca20cba3581b.png" alt="WeChat82decdb61c34cabc1597ca20cba3581b" style="zoom:80%;" />

<p>每点击一次，计数器就会自增，控制台就会打印一句日志 flutter: Dependencies change，依赖变化后，其 didChangeDependencies 会被调用</p>
<p>如果 _TestWidget 的 build 方法中没有使用 ShareDataWidget 的数据，那么它的 didChangeDependencies 将不会被调用，因为它没有依赖 ShareDataWidget，即将上面改成 </p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Widget build(BuildContext context) &#123;</span><br><span class="line">  <span class="comment">//使用InheritedWidget中的共享数据</span></span><br><span class="line">  <span class="comment">//return Text(ShareDataWidget.of(context)!.data.toString());</span></span><br><span class="line">  retirn Text(<span class="string">&#x27;text&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>didChangeDependencies 中做什么</li>
</ul>
<p>一般子 widget 很少会重写此方法，因为依赖改变后 Flutter 也都会调用 build() 方法重新构建组件树。但是，如果需要在依赖改变后执行一些昂贵 的操作，比如网络请求，这时最好的方式是在此方法中执行，可以避免每次 build 都执行这些昂贵操作</p>
<h5 id="InheritedWidget"><a href="#InheritedWidget" class="headerlink" title="InheritedWidget"></a>InheritedWidget</h5><p>如果只想在 _TestWidgetState 中引用 ShareDataWidget 数据，但不希望在 ShareDataWidget 发生变化时调用 _TestWidgetState 的 didChangeDependencies</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="comment">//定义一个便捷方法，方便子树中的widget获取共享数据</span></span><br><span class="line"><span class="keyword">static</span> ShareDataWidget of(BuildContext context) &#123;</span><br><span class="line">  <span class="comment">//return context.dependOnInheritedWidgetOfExactType&lt;ShareDataWidget&gt;();</span></span><br><span class="line">  <span class="keyword">return</span> context.getElementForInheritedWidgetOfExactType&lt;ShareDataWidget&gt;().widget;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>dependOnInheritedWidgetOfExactType 和 getElementForInheritedWidgetOfExactType 的区别是前者会注册依赖关系，后者不会。</p>
<p>调用 dependOnInheritedWidgetOfExactType 后，InheritedWidget 和依赖它的子孙组件关系便完成了注册，之后 InheritedWidget 发生变化，就会更新依赖它的子孙组件，也就会调用子孙组件的 didChangeDependencies 方法和 build 方法</p>
<h4 id="7-3-跨组件状态共享-Provider"><a href="#7-3-跨组件状态共享-Provider" class="headerlink" title="7.3 跨组件状态共享 Provider"></a>7.3 跨组件状态共享 Provider</h4><p>登录状态同步的示例</p>
<p>定义事件：</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">enum</span> Event&#123;</span><br><span class="line">  login,</span><br><span class="line">  ... <span class="comment">//省略其它事件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>登录页代码大致如下：</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 登录状态改变后发布状态改变事件</span></span><br><span class="line">bus.emit(Event.login);</span><br></pre></td></tr></table></figure>

<p>依赖登录状态的页面：</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> onLoginChanged(e)&#123;</span><br><span class="line">  <span class="comment">//登录状态变化处理逻辑</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@override</span></span><br><span class="line"><span class="keyword">void</span> initState() &#123;</span><br><span class="line">  <span class="comment">//订阅登录状态改变事件</span></span><br><span class="line">  bus.<span class="keyword">on</span>(Event.login,onLogin);</span><br><span class="line">  <span class="keyword">super</span>.initState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@override</span></span><br><span class="line"><span class="keyword">void</span> dispose() &#123;</span><br><span class="line">  <span class="comment">//取消订阅</span></span><br><span class="line">  bus.off(Event.login,onLogin);</span><br><span class="line">  <span class="keyword">super</span>.dispose();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过观察者模式来实现跨组件状态共享缺点：<br>必须显式定义各种事件，不好管理<br>订阅者必须显式注册状态改变回调，必须组件销毁时手动解绑回调以避免内存泄漏</p>
<p>InheritedWidget 的特性就是能绑定 InheritedWidget 与依赖它的子孙组件的依赖关系，且 <code> InheritedWidget 数据发生变化时，可以自动更新依赖的子孙组件</code> 。利用这个特性，我们可以将需要跨组件共享的状态保存在 InheritedWidget 中，然后在子组件中引用 InheritedWidget 即可</p>
<h5 id="7-3-1-Provider"><a href="#7-3-1-Provider" class="headerlink" title="7.3.1 Provider"></a>7.3.1 Provider</h5><p>实现一个最小功能的 Provider</p>
<p>首先需要一个保存共享的数据 InheritedWidget，由于具体业务数据不可预期，使用泛型，定义一个通用的 InheritedProvider 类，它继承自 InheritedWidget</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InHeritedProvider</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">InheritedWidget</span> </span>&#123;</span><br><span class="line">  InHeritedProvider(&#123;</span><br><span class="line">    Key? key,</span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">this</span>.data,</span><br><span class="line">    <span class="keyword">required</span> Widget child,</span><br><span class="line">  &#125;) : <span class="keyword">super</span>(child: child);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> T data;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">bool</span> updateShouldNotify(<span class="keyword">covariant</span> InHeritedProvider&lt;T&gt; oldWidget) &#123;</span><br><span class="line">    <span class="comment">//在此简单返回true，则每次更新都会调用依赖其的子孙节点的`didChangeDependencies`。</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>数据发生变化怎么通知？</li>
</ul>
<p>Flutter 提供了 ChangeNotifier 类，继承自 Listenable 定义大致如下</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChangeNotifier</span> <span class="keyword">implements</span> <span class="title">Listenable</span> </span>&#123;</span><br><span class="line">  <span class="built_in">List</span> listeners=[];</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> addListener(VoidCallback listener) &#123;</span><br><span class="line">     <span class="comment">//添加监听器</span></span><br><span class="line">     listeners.add(listener);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> removeListener(VoidCallback listener) &#123;</span><br><span class="line">    <span class="comment">//移除监听器</span></span><br><span class="line">    listeners.remove(listener);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">void</span> notifyListeners() &#123;</span><br><span class="line">    <span class="comment">//通知所有监听器，触发监听器回调 </span></span><br><span class="line">    listeners.forEach((item)=&gt;item());</span><br><span class="line">  &#125;</span><br><span class="line">   </span><br><span class="line">  ... <span class="comment">//省略无关代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在，将要共享的状态放到一个 Model 类中，让它继承自 ChangeNotifier，这样当共享状态发生改变时，只需调用 notifyListeners() 来通知订阅者，然后订阅者重新构建 InheritedProvider</p>
<p>//TODO：。。。。</p>
<h4 id="7-4-颜色和主题"><a href="#7-4-颜色和主题" class="headerlink" title="7.4 颜色和主题"></a>7.4 颜色和主题</h4><h5 id="7-4-1-颜色"><a href="#7-4-1-颜色" class="headerlink" title="7.4.1 颜色"></a>7.4.1 颜色</h5><ul>
<li>MaterialColor</li>
</ul>
<p>MaterialColor 包含一种颜色的10个级别的渐变色，通过 [] 运算符的索引值来代表颜色的深度，有效的索引有：50，100，200，.. 800，900 数值越大，颜色越深，默认值为索引等于500的颜色</p>
<p>可以根据 shadeXX 来获取具体索引的颜色 Color.blue.shade50 </p>
<img src="《Flutter实战第二版》七：功能型组件/7-5.6f1c5012.jpeg" alt="7-5.6f1c5012" style="zoom:80%;" />

<h5 id="7-4-2-Theme"><a href="#7-4-2-Theme" class="headerlink" title="7.4.2 Theme"></a>7.4.2 Theme</h5><ul>
<li>ThemeData</li>
</ul>
<p>ThemeData 用于保存 Material 组件库的主题数据</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">ThemeData(&#123;</span><br><span class="line">  Brightness? brightness, <span class="comment">//深色还是浅色</span></span><br><span class="line">  MaterialColor? primarySwatch, <span class="comment">//主题颜色样本，见下面介绍</span></span><br><span class="line">  Color? primaryColor, <span class="comment">//主色，决定导航栏颜色</span></span><br><span class="line">  Color? cardColor, <span class="comment">//卡片颜色</span></span><br><span class="line">  Color? dividerColor, <span class="comment">//分割线颜色</span></span><br><span class="line">  ButtonThemeData buttonTheme, <span class="comment">//按钮主题</span></span><br><span class="line">  Color dialogBackgroundColor,<span class="comment">//对话框背景颜色</span></span><br><span class="line">  <span class="built_in">String</span> fontFamily, <span class="comment">//文字字体</span></span><br><span class="line">  TextTheme textTheme,<span class="comment">// 字体主题，包括标题、body等文字样式</span></span><br><span class="line">  IconThemeData iconTheme, <span class="comment">// Icon的默认样式</span></span><br><span class="line">  TargetPlatform platform, <span class="comment">//指定平台，应用特定平台控件风格</span></span><br><span class="line">  ColorScheme? colorScheme,</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>路由换肤示例</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThemeTestRoute</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _ThemeTestRouteState createState() =&gt; _ThemeTestRouteState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_ThemeTestRouteState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">ThemeTestRoute</span>&gt; </span>&#123;</span><br><span class="line">  MaterialColor _themeColor = Colors.teal; <span class="comment">//当前路由主题色</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    ThemeData themeData = Theme.of(context);</span><br><span class="line">    <span class="keyword">return</span> Theme(</span><br><span class="line">      data: ThemeData(</span><br><span class="line">          primarySwatch: _themeColor, <span class="comment">//用于导航栏、FloatingActionButton的背景色等</span></span><br><span class="line">          iconTheme: IconThemeData(color: _themeColor) <span class="comment">//用于Icon颜色</span></span><br><span class="line">      ),</span><br><span class="line">      child: Scaffold(</span><br><span class="line">        appBar: AppBar(title: Text(<span class="string">&quot;主题测试&quot;</span>)),</span><br><span class="line">        body: Column(</span><br><span class="line">          mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">          children: &lt;Widget&gt;[</span><br><span class="line">            <span class="comment">//第一行Icon使用主题中的iconTheme</span></span><br><span class="line">            Row(</span><br><span class="line">                mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">                children: &lt;Widget&gt;[</span><br><span class="line">                  Icon(Icons.favorite),</span><br><span class="line">                  Icon(Icons.airport_shuttle),</span><br><span class="line">                  Text(<span class="string">&quot;  颜色跟随主题&quot;</span>)</span><br><span class="line">                ]</span><br><span class="line">            ),</span><br><span class="line">            <span class="comment">//为第二行Icon自定义颜色（固定为黑色)</span></span><br><span class="line">            Theme(</span><br><span class="line">              data: themeData.copyWith(</span><br><span class="line">                iconTheme: themeData.iconTheme.copyWith(</span><br><span class="line">                    color: Colors.black</span><br><span class="line">                ),</span><br><span class="line">              ),</span><br><span class="line">              child: Row(</span><br><span class="line">                  mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">                  children: &lt;Widget&gt;[</span><br><span class="line">                    Icon(Icons.favorite),</span><br><span class="line">                    Icon(Icons.airport_shuttle),</span><br><span class="line">                    Text(<span class="string">&quot;  颜色固定黑色&quot;</span>)</span><br><span class="line">                  ]</span><br><span class="line">              ),</span><br><span class="line">            ),</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">        floatingActionButton: FloatingActionButton(</span><br><span class="line">            onPressed: () =&gt;  <span class="comment">//切换主题</span></span><br><span class="line">                setState(() =&gt;</span><br><span class="line">                _themeColor =</span><br><span class="line">                _themeColor == Colors.teal ? Colors.blue : Colors.teal</span><br><span class="line">                ),</span><br><span class="line">            child: Icon(Icons.palette)</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》七：功能型组件/WeChat480a699489c96afae7c2834566a2792f.png" alt="WeChat480a699489c96afae7c2834566a2792f" style="zoom:80%;" />

<p>可以通过局部主题覆盖全局主题</p>
<h4 id="7-5-ValueListenableBuilder"><a href="#7-5-ValueListenableBuilder" class="headerlink" title="7.5 ValueListenableBuilder"></a>7.5 ValueListenableBuilder</h4><p>ValueListenableBuilder 功能是监听一个数据源，如果数据源发生变化，则会重新执行其 builder</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> ValueListenableBuilder(&#123;</span><br><span class="line">  Key? key,</span><br><span class="line">  <span class="keyword">required</span> <span class="keyword">this</span>.valueListenable, <span class="comment">// 数据源，类型为ValueListenable&lt;T&gt;</span></span><br><span class="line">  <span class="keyword">required</span> <span class="keyword">this</span>.builder, <span class="comment">// builder</span></span><br><span class="line">  <span class="keyword">this</span>.child,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>valueListenable：类型为 <code>ValueListenable&lt;T&gt;</code> ，表示一个可监听的数据源</p>
<p>builder：数据源发生变化通知时，会重新调用 builder 重新 builder 子组件树</p>
<p>child：builder 中每次都会重新构建整个子组件树，如果子组件树中有一些不变的部分，可以传递给 child</p>
<p>点击器示例</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ValueListenableRoute</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ValueListenableRoute(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _ValueListenableRouteState createState() =&gt; _ValueListenableRouteState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_ValueListenableRouteState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">ValueListenableRoute</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// 定义一个ValueNotifier，当数字变化时会通知 ValueListenableBuilder</span></span><br><span class="line">  <span class="keyword">final</span> ValueNotifier&lt;<span class="built_in">int</span>&gt; _counter = ValueNotifier&lt;<span class="built_in">int</span>&gt;(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">double</span> textScaleFactor = <span class="number">1.5</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;build&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(title: Text(<span class="string">&#x27;ValueListenableBuilder 测试&#x27;</span>)),</span><br><span class="line">      body: Center(</span><br><span class="line">        child: ValueListenableBuilder(</span><br><span class="line">            valueListenable: _counter,</span><br><span class="line">            builder: (BuildContext context, <span class="built_in">int</span> value, Widget? child) &#123;</span><br><span class="line">              <span class="comment">// builder 方法只会在 _counter 变化时被调用</span></span><br><span class="line">              <span class="keyword">return</span> Row(</span><br><span class="line">                mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">                children: [</span><br><span class="line">                  Text(<span class="string">&#x27;点击了<span class="subst">$value</span>次&#x27;</span>, textScaleFactor: textScaleFactor,)</span><br><span class="line">                ],</span><br><span class="line">              );</span><br><span class="line">            &#125;,</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">      floatingActionButton: FloatingActionButton(</span><br><span class="line">        <span class="comment">// 点击后值 +1，触发 ValueListenableBuilder 重新构建</span></span><br><span class="line">        onPressed: () =&gt; _counter.value += <span class="number">1</span>,</span><br><span class="line">        child: Icon(Icons.add),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》七：功能型组件/WeChata5da268a632103c4c715f5e27552825c.png" alt="WeChata5da268a632103c4c715f5e27552825c" style="zoom:80%;" />

<p>控制台只在打开时 build 了一次，点击 + 按钮时只是 ValueListenableBuilder 重新构建了子组件树，整个页面没有重新 build；尽可能让 ValueListenableBuilder 只构建依赖数据源的 widget，这样的话可以缩小重新构建的范围</p>
<p>ValueListenableBuilder 和数据流向无关，可以实现任意数据流向的数据共享，实践中 ValueListenableBuilder 的拆分粒度应该尽可能的细</p>
<h4 id="7-6-异步-UI-更新"><a href="#7-6-异步-UI-更新" class="headerlink" title="7.6 异步 UI 更新"></a>7.6 异步 UI 更新</h4><h5 id="7-6-1-FutureBuilder"><a href="#7-6-1-FutureBuilder" class="headerlink" title="7.6.1 FutureBuilder"></a>7.6.1 FutureBuilder</h5><p>FutureBuilder 会依赖一个 Future，会根据所依赖的 Future 的状态来动态构建自身</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">FutureBuilder(&#123;</span><br><span class="line">  <span class="keyword">this</span>.future,</span><br><span class="line">  <span class="keyword">this</span>.initialData,</span><br><span class="line">  <span class="keyword">required</span> <span class="keyword">this</span>.builder,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>future：FutureBuilder 依赖的 future，通常是一个异步耗时的任务</p>
<p>initialData：初始数据，用户设置默认数据</p>
<p>builder：widget 构建器，该构建器会在 Future 执行的不同阶段被多次调用</p>
<p>签名如下</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> AsyncWidgetBuilder&lt;T&gt; = Widget <span class="built_in">Function</span>(BuildContext context, AsyncSnapshot&lt;T&gt; snapshot);</span><br></pre></td></tr></table></figure>

<p>snapshot 会包含当前异步任务的状态信息及结果信息，<br>snapshot.connectionState 获取异步任务的状态信息<br>snapshot.hasError 判断异步任务是否有错误等</p>
<ul>
<li>示例</li>
</ul>
<p>实现一个路由从网上获取数据，获取数据时弹一个加载框；获取结束时，如果成功则显示获取到的数据，失败则显示错误</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_DemoState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">Demo</span>&gt; </span>&#123;</span><br><span class="line">  </span><br><span class="line">  Future&lt;<span class="built_in">String</span>&gt; mockNetworkData() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Future.delayed(<span class="built_in">Duration</span>(seconds: <span class="number">2</span>), () =&gt; <span class="string">&quot;我是从互联网上获取的数据&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(title: Text(<span class="string">&#x27;标题&#x27;</span>)),</span><br><span class="line">      body: Container(</span><br><span class="line">        child: FutureBuilder(</span><br><span class="line">          future: mockNetworkData(),</span><br><span class="line">          builder: (BuildContext context, AsyncSnapshot snapshot) &#123;</span><br><span class="line">            <span class="comment">// 请求已结束</span></span><br><span class="line">            <span class="keyword">if</span> (snapshot.connectionState == ConnectionState.done) &#123;</span><br><span class="line">              <span class="keyword">if</span> (snapshot.hasError) &#123;</span><br><span class="line">                <span class="comment">// 请求失败，显示错误</span></span><br><span class="line">                <span class="keyword">return</span> Text(<span class="string">&quot;Error: <span class="subst">$&#123;snapshot.error&#125;</span>&quot;</span>);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 请求成功，显示数据</span></span><br><span class="line">                <span class="keyword">return</span> Text(<span class="string">&quot;Contents: <span class="subst">$&#123;snapshot.data&#125;</span>&quot;</span>);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">// 请求未结束，显示loading</span></span><br><span class="line">              <span class="keyword">return</span> CircularProgressIndicator();</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》七：功能型组件/WeChatbfb98a9a1f4c131945af42218a1998ee.png" alt="WeChatbfb98a9a1f4c131945af42218a1998ee" style="zoom: 67%;" />

<p>connectionState 异步任务状态是个枚举</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">enum</span> ConnectionState &#123;</span><br><span class="line">  <span class="comment">/// <span class="markdown">当前没有异步任务，比如[FutureBuilder]的[future]为null时</span></span></span><br><span class="line">  none,</span><br><span class="line">  <span class="comment">/// <span class="markdown">异步任务处于等待状态</span></span></span><br><span class="line">  waiting,</span><br><span class="line">  <span class="comment">/// <span class="markdown">Stream处于激活状态（流上已经有数据传递了），对于FutureBuilder没有该状态。</span></span></span><br><span class="line">  active,</span><br><span class="line">  <span class="comment">/// <span class="markdown">异步任务已经终止.</span></span></span><br><span class="line">  done,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ConnectionState.active 只有在 StreamBuilder 中才会出现</p>
<h5 id="7-6-2-StreamBuilder"><a href="#7-6-2-StreamBuilder" class="headerlink" title="7.6.2 StreamBuilder"></a>7.6.2 StreamBuilder</h5><p>Dart 中 Stream 也是用于接收异步事件数据，和 Future 不同的是，它可以接收多个异步操作的结果，常用于会多次读取数据的异步任务场景，如网络内容下载，文件读写</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">StreamBuilder(&#123;</span><br><span class="line">  <span class="keyword">this</span>.initialData,</span><br><span class="line">  Stream&lt;T&gt; stream,</span><br><span class="line">  <span class="keyword">required</span> <span class="keyword">this</span>.builder,</span><br><span class="line">&#125;) </span><br></pre></td></tr></table></figure>

<p>和 FutureBuilder 有一点不同，前者需要一个 future，后者需要一个 stream</p>
<ul>
<li>示例</li>
</ul>
<p>创建一个计时器，每隔1秒，计数加1，这里使用 Stream 来实现每隔一秒生成一个数字</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Stream&lt;<span class="built_in">int</span>&gt; counter() &#123;</span><br><span class="line">  <span class="keyword">return</span> Stream.periodic(<span class="built_in">Duration</span>(seconds: <span class="number">1</span>), (i) &#123;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Widget build(BuildContext context) &#123;</span><br><span class="line">   <span class="keyword">return</span> StreamBuilder&lt;<span class="built_in">int</span>&gt;(</span><br><span class="line">     stream: counter(), <span class="comment">//</span></span><br><span class="line">     <span class="comment">//initialData: ,// a Stream&lt;int&gt; or null</span></span><br><span class="line">     builder: (BuildContext context, AsyncSnapshot&lt;<span class="built_in">int</span>&gt; snapshot) &#123;</span><br><span class="line">       <span class="keyword">if</span> (snapshot.hasError)</span><br><span class="line">         <span class="keyword">return</span> Text(<span class="string">&#x27;Error: <span class="subst">$&#123;snapshot.error&#125;</span>&#x27;</span>);</span><br><span class="line">       <span class="keyword">switch</span> (snapshot.connectionState) &#123;</span><br><span class="line">         <span class="keyword">case</span> ConnectionState.none:</span><br><span class="line">           <span class="keyword">return</span> Text(<span class="string">&#x27;没有Stream&#x27;</span>);</span><br><span class="line">         <span class="keyword">case</span> ConnectionState.waiting:</span><br><span class="line">           <span class="keyword">return</span> Text(<span class="string">&#x27;等待数据...&#x27;</span>);</span><br><span class="line">         <span class="keyword">case</span> ConnectionState.active:</span><br><span class="line">           <span class="keyword">return</span> Text(<span class="string">&#x27;active: <span class="subst">$&#123;snapshot.data&#125;</span>&#x27;</span>);</span><br><span class="line">         <span class="keyword">case</span> ConnectionState.done:</span><br><span class="line">           <span class="keyword">return</span> Text(<span class="string">&#x27;Stream 已关闭&#x27;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">// unreachable</span></span><br><span class="line">     &#125;,</span><br><span class="line">   );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实战中，凡是UI会依赖多个异步数据而发生变化的场景都可以使用 StreamBuilder</p>
<h4 id="7-7-对话框详解"><a href="#7-7-对话框详解" class="headerlink" title="7.7 对话框详解"></a>7.7 对话框详解</h4><h5 id="7-7-1-使用对话框"><a href="#7-7-1-使用对话框" class="headerlink" title="7.7.1 使用对话框"></a>7.7.1 使用对话框</h5><ul>
<li>AlertDialog</li>
</ul>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> AlertDialog(&#123;</span><br><span class="line">  Key? key,</span><br><span class="line">  <span class="keyword">this</span>.title, <span class="comment">//对话框标题组件</span></span><br><span class="line">  <span class="keyword">this</span>.titlePadding, <span class="comment">// 标题填充</span></span><br><span class="line">  <span class="keyword">this</span>.titleTextStyle, <span class="comment">//标题文本样式</span></span><br><span class="line">  <span class="keyword">this</span>.content, <span class="comment">// 对话框内容组件</span></span><br><span class="line">  <span class="keyword">this</span>.contentPadding = <span class="keyword">const</span> EdgeInsets.fromLTRB(<span class="number">24.0</span>, <span class="number">20.0</span>, <span class="number">24.0</span>, <span class="number">24.0</span>), <span class="comment">//内容的填充</span></span><br><span class="line">  <span class="keyword">this</span>.contentTextStyle,<span class="comment">// 内容文本样式</span></span><br><span class="line">  <span class="keyword">this</span>.actions, <span class="comment">// 对话框操作按钮组</span></span><br><span class="line">  <span class="keyword">this</span>.backgroundColor, <span class="comment">// 对话框背景色</span></span><br><span class="line">  <span class="keyword">this</span>.elevation,<span class="comment">// 对话框的阴影</span></span><br><span class="line">  <span class="keyword">this</span>.semanticLabel, <span class="comment">//对话框语义化标签(用于读屏软件)</span></span><br><span class="line">  <span class="keyword">this</span>.shape, <span class="comment">// 对话框外形</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Demo</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _DemoState createState() =&gt; _DemoState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_DemoState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">Demo</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//弹出对话框</span></span><br><span class="line">  Future&lt;<span class="built_in">bool?</span>&gt; showDialog1() &#123;</span><br><span class="line">    <span class="keyword">return</span> showDialog&lt;<span class="built_in">bool</span>&gt;(</span><br><span class="line">        context: context,</span><br><span class="line">        builder: (context) &#123;</span><br><span class="line">          <span class="keyword">return</span> AlertDialog(</span><br><span class="line">            title: Text(<span class="string">&#x27;提示&#x27;</span>),</span><br><span class="line">            content: Text(<span class="string">&#x27;您确定要删除当前文件吗?&#x27;</span>),</span><br><span class="line">            actions: [</span><br><span class="line">              TextButton(</span><br><span class="line">                  onPressed: () =&gt; Navigator.of(context).pop(),<span class="comment">//关闭对话框</span></span><br><span class="line">                  child: Text(<span class="string">&#x27;取消&#x27;</span>)</span><br><span class="line">              ),</span><br><span class="line">              TextButton(</span><br><span class="line">                  onPressed: ()&#123;</span><br><span class="line">                    <span class="comment">//关闭对话框并返回true</span></span><br><span class="line">                    Navigator.of(context).pop(<span class="keyword">true</span>);</span><br><span class="line">                  &#125;,<span class="comment">// ... 执行删除操作</span></span><br><span class="line">                  child: Text(<span class="string">&#x27;删除&#x27;</span>)</span><br><span class="line">              ),</span><br><span class="line">            ],</span><br><span class="line">          );</span><br><span class="line">        &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(title: Text(<span class="string">&#x27;标题&#x27;</span>)),</span><br><span class="line">      body: Container(</span><br><span class="line">        child: Column(</span><br><span class="line">          mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">          children: [</span><br><span class="line">            ElevatedButton(</span><br><span class="line">                onPressed: () <span class="keyword">async</span> &#123;</span><br><span class="line">                  <span class="comment">//弹出对话框并等待其关闭</span></span><br><span class="line">                  <span class="built_in">bool?</span> delete = <span class="keyword">await</span> showDialog1();</span><br><span class="line">                  <span class="keyword">if</span> (delete == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;取消删除&quot;</span>);</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;已确认删除&quot;</span>);</span><br><span class="line">                    <span class="comment">//... 删除文件</span></span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                child: Text(<span class="string">&#x27;对话框1&#x27;</span>),</span><br><span class="line">            ),</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》七：功能型组件/WeChat27864c95f0c816238363a69b4f71ff06.png" alt="WeChat27864c95f0c816238363a69b4f71ff06" style="zoom:80%;" />

<p>通过 Navigator.of(context).pop(…) 方法来关闭对话框，都可以返回一个结果数据</p>
<ul>
<li>弹出对话框 showDialog()</li>
</ul>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Future&lt;T?&gt; showDialog&lt;T&gt;(&#123;</span><br><span class="line">  <span class="keyword">required</span> BuildContext context,</span><br><span class="line">  <span class="keyword">required</span> WidgetBuilder builder, <span class="comment">// 对话框UI的builder</span></span><br><span class="line">  <span class="built_in">bool</span> barrierDismissible = <span class="keyword">true</span>, <span class="comment">//点击对话框barrier(遮罩)时是否关闭它</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>SimpleDialog</li>
</ul>
<p>会展示一个列表，用于列表选择的场景</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Future&lt;<span class="keyword">void</span>&gt; changeLanguage() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="built_in">int?</span> i = <span class="keyword">await</span> showDialog(</span><br><span class="line">      context: context,</span><br><span class="line">      builder: (context) &#123;</span><br><span class="line">        <span class="keyword">return</span> SimpleDialog(</span><br><span class="line">          title: Text(<span class="string">&#x27;请选择语言&#x27;</span>),</span><br><span class="line">          children: [</span><br><span class="line">            SimpleDialogOption(</span><br><span class="line">              child: Padding(</span><br><span class="line">                  padding: EdgeInsets.symmetric(vertical: <span class="number">6</span>),</span><br><span class="line">                  child: Text(<span class="string">&#x27;中文简体&#x27;</span>),</span><br><span class="line">              ),</span><br><span class="line">              onPressed: () &#123;</span><br><span class="line">                Navigator.pop(context, <span class="number">1</span>);</span><br><span class="line">              &#125;,</span><br><span class="line">            ),</span><br><span class="line">            SimpleDialogOption(</span><br><span class="line">              child: Padding(</span><br><span class="line">                padding: EdgeInsets.symmetric(vertical: <span class="number">6</span>),</span><br><span class="line">                child: Text(<span class="string">&#x27;美国英语&#x27;</span>),</span><br><span class="line">              ),</span><br><span class="line">              onPressed: () &#123;</span><br><span class="line">                Navigator.pop(context, <span class="number">2</span>);</span><br><span class="line">              &#125;,</span><br><span class="line">            ),</span><br><span class="line">          ],</span><br><span class="line">        );</span><br><span class="line">      &#125;,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">if</span> (i != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;选择了：<span class="subst">$&#123;i == <span class="number">1</span> ? <span class="string">&quot;中文简体&quot;</span> : <span class="string">&quot;美国英语&quot;</span>&#125;</span>&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>列表项组件使用了 SimpleDialogOption 包装了，相当于一个 TextButton，只不过按钮是左对齐的，并且 padding 较小</p>
<ul>
<li>Dialog</li>
</ul>
<p>如果对话框需要嵌套一个 ListView 可以直接使用 Dialog 类</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Future&lt;<span class="keyword">void</span>&gt; showListDialog() <span class="keyword">async</span> &#123;</span><br><span class="line">  <span class="built_in">int?</span> index = <span class="keyword">await</span> showDialog(</span><br><span class="line">      context: context,</span><br><span class="line">      builder: (context) &#123;</span><br><span class="line">        <span class="keyword">var</span> child = Column(</span><br><span class="line">          children: [</span><br><span class="line">            ListTile(title: Text(<span class="string">&#x27;请选择&#x27;</span>)),</span><br><span class="line">            Expanded(</span><br><span class="line">                child: ListView.builder(</span><br><span class="line">                    itemCount: <span class="number">30</span>,</span><br><span class="line">                    itemBuilder: (context, index) &#123;</span><br><span class="line">                      <span class="keyword">return</span> ListTile(</span><br><span class="line">                        title: Text(<span class="string">&quot;<span class="subst">$index</span>&quot;</span>),</span><br><span class="line">                        onTap: () =&gt; Navigator.of(context).pop(index),</span><br><span class="line">                      );</span><br><span class="line">                    &#125;,</span><br><span class="line">                ),</span><br><span class="line">            ),</span><br><span class="line">          ],</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> Dialog(child: child);</span><br><span class="line">      &#125;,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">if</span> (index != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;点击了：<span class="subst">$index</span>&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》七：功能型组件/WeChatf310a19612106d0766aaec0ad0fde4d9.png" alt="WeChatf310a19612106d0766aaec0ad0fde4d9" style="zoom: 67%;" />

<h5 id="7-7-2-对话框打开动画及遮罩"><a href="#7-7-2-对话框打开动画及遮罩" class="headerlink" title="7.7.2 对话框打开动画及遮罩"></a>7.7.2 对话框打开动画及遮罩</h5><p>如何打开一个普通风格的对话框（非 Material风格）？Flutter 提供了一个 showGeneralDialog 方法</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Future&lt;T?&gt; showGeneralDialog&lt;T&gt;(&#123;</span><br><span class="line">  <span class="keyword">required</span> BuildContext context,</span><br><span class="line">  <span class="keyword">required</span> RoutePageBuilder pageBuilder, <span class="comment">//构建对话框内部UI</span></span><br><span class="line">  <span class="built_in">bool</span> barrierDismissible = <span class="keyword">false</span>, <span class="comment">//点击遮罩是否关闭对话框</span></span><br><span class="line">  <span class="built_in">String?</span> barrierLabel, <span class="comment">// 语义化标签(用于读屏软件)</span></span><br><span class="line">  Color barrierColor = <span class="keyword">const</span> Color(<span class="number">0x80000000</span>), <span class="comment">// 遮罩颜色</span></span><br><span class="line">  <span class="built_in">Duration</span> transitionDuration = <span class="keyword">const</span> <span class="built_in">Duration</span>(milliseconds: <span class="number">200</span>), <span class="comment">// 对话框打开/关闭的动画时长</span></span><br><span class="line">  RouteTransitionsBuilder? transitionBuilder, <span class="comment">// 对话框打开/关闭的动画</span></span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>showDialog 方法正是 showGeneralDialog 的一个封装，定制了 Material 风格对话框的遮罩颜色和动画</p>
<ul>
<li>封装一个 showCustomDialog 方法</li>
</ul>
<h5 id="7-7-3-对话框实现原理"><a href="#7-7-3-对话框实现原理" class="headerlink" title="7.7.3 对话框实现原理"></a>7.7.3 对话框实现原理</h5><p>直接调用 Navigatio 的 push 方法打开了一个新的对话框路由 RawDialogRoute，然后返回了 push 的返回值，对话框实际上正是通过路由的形式打开的</p>
<h5 id="7-7-4-对话框状态管理"><a href="#7-7-4-对话框状态管理" class="headerlink" title="7.7.4 对话框状态管理"></a>7.7.4 对话框状态管理</h5><h5 id="7-7-5-其它类型的对话框"><a href="#7-7-5-其它类型的对话框" class="headerlink" title="7.7.5 其它类型的对话框"></a>7.7.5 其它类型的对话框</h5><ul>
<li>Loading 框</li>
<li>日历选择</li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>《Flutter实战第二版》三：基础组件</title>
    <url>/2022/01/18/%E3%80%8AFlutter%E5%AE%9E%E6%88%98%E7%AC%AC%E4%BA%8C%E7%89%88%E3%80%8B%E4%B8%89%EF%BC%9A%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6/</url>
    <content><![CDATA[<h3 id="3-基础组件"><a href="#3-基础组件" class="headerlink" title="3 基础组件"></a>3 基础组件</h3><h4 id="3-1-文本及样式"><a href="#3-1-文本及样式" class="headerlink" title="3.1 文本及样式"></a>3.1 文本及样式</h4><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  runApp(MaterialApp(home: TextDemo()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextDemo</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(<span class="string">&#x27;标题&#x27;</span>),</span><br><span class="line">      ),</span><br><span class="line">      body: Center(</span><br><span class="line">        child: Column(</span><br><span class="line">          children: [</span><br><span class="line">            Text(<span class="string">&#x27;hello&#x27;</span>,</span><br><span class="line">              style: TextStyle(</span><br><span class="line">                color: Colors.blue,</span><br><span class="line">                fontSize: <span class="number">30</span>,</span><br><span class="line">                height: <span class="number">1.2</span>,</span><br><span class="line">                fontFamily: <span class="string">&#x27;Courier&#x27;</span>,</span><br><span class="line">                background: Paint()..color=Colors.yellow,</span><br><span class="line">                decoration: TextDecoration.underline,</span><br><span class="line">                decorationStyle: TextDecorationStyle.dashed,</span><br><span class="line">              ),</span><br><span class="line">            ),</span><br><span class="line">            Text.rich(</span><br><span class="line">                TextSpan(children: [</span><br><span class="line">                  TextSpan(text: <span class="string">&#x27;Home: &#x27;</span>,</span><br><span class="line">                      style: TextStyle(fontSize: <span class="number">30</span>)</span><br><span class="line">                  ),</span><br><span class="line">                  TextSpan(text: <span class="string">&#x27;//flutterchina.club&#x27;</span>,</span><br><span class="line">                      style: TextStyle(</span><br><span class="line">                          color: Colors.blue, fontSize: <span class="number">30</span>),</span><br><span class="line">                  ),</span><br><span class="line">                ])</span><br><span class="line">            ),</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/%E3%80%8AFlutter%E5%AE%9E%E6%88%98%E7%AC%AC%E4%BA%8C%E7%89%88%E3%80%8B%E4%B8%89%EF%BC%9A%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6/WeChat312b40c64293529cd163ce4550ee7471.png?lastModify=1642479994" alt="WeChat312b40c64293529cd163ce4550ee7471"></p>
<h5 id="3-1-1-Text"><a href="#3-1-1-Text" class="headerlink" title="3.1.1 Text"></a>3.1.1 Text</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">body: Container(</span><br><span class="line">  child: Column(</span><br><span class="line">    children: [</span><br><span class="line">      Text(<span class="string">&#x27;Hello world&#x27;</span>, textAlign: TextAlign.left),</span><br><span class="line">      Text(<span class="string">&#x27;Hello world I`m Jack&#x27;</span>*<span class="number">4</span>, maxLines: <span class="number">1</span>, overflow: TextOverflow.ellipsis),</span><br><span class="line">      Text(<span class="string">&#x27;Hello world&#x27;</span>, textScaleFactor: <span class="number">2</span>),</span><br><span class="line">    ],</span><br><span class="line">  ),</span><br><span class="line">),</span><br></pre></td></tr></table></figure>

<ul>
<li>Text 的构造方法</li>
</ul>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> Text(<span class="keyword">this</span>.data, &#123;  <span class="comment">//Text显示的内容</span></span><br><span class="line">Key key,</span><br><span class="line"><span class="keyword">this</span>.style, <span class="comment">//Text显示的样式</span></span><br><span class="line"><span class="keyword">this</span>.textAlign,<span class="comment">//文本应该如何水平对齐,TextAlign.start,end 或者center</span></span><br><span class="line"><span class="keyword">this</span>.textDirection, <span class="comment">//文本方向,TextDirection.ltr\TextDirection.rtl</span></span><br><span class="line"><span class="keyword">this</span>.locale,</span><br><span class="line"><span class="keyword">this</span>.softWrap,  <span class="comment">//是否自动换行，若为false，文字将不考虑容器大小，单行显示，超出屏幕部分将默认截断处理</span></span><br><span class="line"><span class="keyword">this</span>.overflow, <span class="comment">//当文字超出屏幕的时候，如何处理,TextOverflow.clip(裁剪)\TextOverflow.fade(渐隐)\TextOverflow.ellipsis(省略号)</span></span><br><span class="line"><span class="keyword">this</span>.textScaleFactor, <span class="comment">//字体大小缩放因子，将字体设置成10.0，然后倍率为2，使用字体大小就是20</span></span><br><span class="line"><span class="keyword">this</span>.maxLines, <span class="comment">//最大行数设置</span></span><br><span class="line"><span class="keyword">this</span>.semanticsLabel,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h5 id="3-1-2-TextStyle"><a href="#3-1-2-TextStyle" class="headerlink" title="3.1.2 TextStyle"></a>3.1.2 TextStyle</h5><ul>
<li>TextStyle 构造方法</li>
</ul>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> TextStyle(&#123;</span><br><span class="line">    <span class="keyword">this</span>.inherit: <span class="keyword">true</span>,      <span class="comment">// 为false的时候不继承默认样式</span></span><br><span class="line">    <span class="keyword">this</span>.color,              <span class="comment">// 颜色 </span></span><br><span class="line">    <span class="keyword">this</span>.fontSize,           <span class="comment">// 字号</span></span><br><span class="line">    <span class="keyword">this</span>.fontWeight,         <span class="comment">// 字重，加粗也用这个字段  FontWeight.w700</span></span><br><span class="line">    <span class="keyword">this</span>.fontStyle,          <span class="comment">// FontStyle.normal  FontStyle.italic斜体</span></span><br><span class="line">    <span class="keyword">this</span>.letterSpacing,      <span class="comment">// 字符间距  就是单个字母或者汉字之间的间隔，可以是负数</span></span><br><span class="line">    <span class="keyword">this</span>.wordSpacing,        <span class="comment">// 字间距 句字之间的间距</span></span><br><span class="line">    <span class="keyword">this</span>.textBaseline,       <span class="comment">// 基线，两个值，字面意思是一个用来排字母的，一人用来排表意字的（类似中文）</span></span><br><span class="line">    <span class="keyword">this</span>.height,            <span class="comment">// 当用来Text控件上时，行高（会乘以fontSize,所以不以设置过大）</span></span><br><span class="line">    <span class="keyword">this</span>.decoration,        <span class="comment">// 添加上划线，下划线，删除线 </span></span><br><span class="line">    <span class="keyword">this</span>.decorationColor,   <span class="comment">// 划线的颜色</span></span><br><span class="line">    <span class="keyword">this</span>.decorationStyle,   <span class="comment">// 这个style可能控制画实线，虚线，两条线，点, 波浪线等</span></span><br><span class="line">    <span class="keyword">this</span>.debugLabel,</span><br><span class="line">    <span class="built_in">String</span> fontFamily,    <span class="comment">// 字体</span></span><br><span class="line">    <span class="built_in">String</span> package,</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>



<h5 id="3-1-3-TextSpan"><a href="#3-1-3-TextSpan" class="headerlink" title="3.1.3 TextSpan"></a>3.1.3 TextSpan</h5><p>TextSpan 将 Text 内容的不同部分按照不同的样式显示</p>
<ul>
<li>TextSpan 的定义:</li>
</ul>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> TextSpan(&#123;</span><br><span class="line">   TextStyle style, </span><br><span class="line">   Sting text,</span><br><span class="line">   <span class="built_in">List</span>&lt;TextSpan&gt; children,</span><br><span class="line">   GestureRecognizer recognizer,</span><br><span class="line"> &#125;);</span><br></pre></td></tr></table></figure>

<p>style 和 text 属性代表该文本的样式和内容，children 是 TextSpan 数组，也就是 TextSpan 可以包括其它 TextSpan，recognizer 用于文本片段上手势识别处理</p>
<h5 id="3-1-4-DefaultTextStyle"><a href="#3-1-4-DefaultTextStyle" class="headerlink" title="3.1.4 DefaultTextStyle"></a>3.1.4 DefaultTextStyle</h5><p>文本样式可以被默认继承（子类文本组件未指定具体样式可以使用 Widget 树中父级的默认样式）</p>
<p>DefaultTextStyle 用于设置默认文本样式</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextDemo</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(<span class="string">&#x27;标题&#x27;</span>),</span><br><span class="line">      ),</span><br><span class="line">      body: DefaultTextStyle(</span><br><span class="line">          style: TextStyle(</span><br><span class="line">            color: Colors.red,</span><br><span class="line">            fontSize: <span class="number">20</span>,</span><br><span class="line">          ),</span><br><span class="line">          child: Column(</span><br><span class="line">            children: [</span><br><span class="line">              Text(<span class="string">&#x27;123&#x27;</span>),</span><br><span class="line">              Text(<span class="string">&#x27;456&#x27;</span>),</span><br><span class="line">              Text(<span class="string">&#x27;789&#x27;</span>, style: TextStyle(</span><br><span class="line">                  inherit: <span class="keyword">false</span>,</span><br><span class="line">                  color: Colors.grey)</span><br><span class="line">              ),</span><br><span class="line">            ],</span><br><span class="line">          )</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/%E3%80%8AFlutter%E5%AE%9E%E6%88%98%E7%AC%AC%E4%BA%8C%E7%89%88%E3%80%8B%E4%B8%89%EF%BC%9A%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6/WeChatd910839e3ff49d0f3f1548df3adf920f.png?lastModify=1642479994" alt="WeChatd910839e3ff49d0f3f1548df3adf920f"></p>
<h5 id="3-1-5-字体"><a href="#3-1-5-字体" class="headerlink" title="3.1.5 字体"></a>3.1.5 字体</h5><p>pubspec.yaml 中声明</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">flutter:</span><br><span class="line">  fonts:</span><br><span class="line">    - family: Raleway</span><br><span class="line">      fonts:</span><br><span class="line">        - asset: assets/fonts/Raleway-Regular.ttf</span><br><span class="line">        - asset: assets/fonts/Raleway-Medium.ttf</span><br><span class="line">          weight: <span class="number">500</span></span><br><span class="line">        - asset: assets/fonts/Raleway-SemiBold.ttf</span><br><span class="line">          weight: <span class="number">600</span></span><br><span class="line">    - family: AbrilFatface</span><br><span class="line">      fonts:</span><br><span class="line">        - asset: assets/fonts/abrilfatface/AbrilFatface-Regular.ttf</span><br></pre></td></tr></table></figure>

<p>使用字体</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 声明文本样式</span></span><br><span class="line"><span class="keyword">const</span> textStyle = <span class="keyword">const</span> TextStyle(</span><br><span class="line">  fontFamily: <span class="string">&#x27;Raleway&#x27;</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用文本样式</span></span><br><span class="line"><span class="keyword">var</span> buttonText = <span class="keyword">const</span> Text(</span><br><span class="line">  <span class="string">&quot;Use the font for this text&quot;</span>,</span><br><span class="line">  style: textStyle,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h4 id="3-2-按钮"><a href="#3-2-按钮" class="headerlink" title="3.2 按钮"></a>3.2 按钮</h4><p>Material 库中的按钮，按下时都还有水波纹动画，就是点击按钮上会出现水波纹扩展动画</p>
<p>有一个 onPressed 属性来设置点击回调</p>
<p><img src="/../../../../../../%E3%80%8AFlutter%E5%AE%9E%E6%88%98%E7%AC%AC%E4%BA%8C%E7%89%88%E3%80%8B%E4%B8%89%EF%BC%9A%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6/WeChata1d3c6be4375dfacab4bffe55cf60aa5.png" alt="WeChata1d3c6be4375dfacab4bffe55cf60aa5"></p>
<ul>
<li>ElevatedButton</li>
</ul>
<p>漂浮按钮，默认带阴影和灰色背景，按下后阴影会变大</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">ElevatedButton(</span><br><span class="line">    onPressed: ()&#123;</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&#x27;onPressed&#x27;</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    child: Text(<span class="string">&#x27;normal&#x27;</span>),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>TextButton</li>
</ul>
<p>文本按钮，默认背景透明不带阴影，按下后会有背景色</p>
<ul>
<li>OutlineButton</li>
</ul>
<p>默认有一个灰色边框，不带阴影背景透明，按下后边框颜色变亮，同时出现背景和阴影</p>
<p>构造方法：</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">const</span> OutlineButton(&#123;</span><br><span class="line">   Key key,</span><br><span class="line">   <span class="meta">@required</span> VoidCallback onPressed,</span><br><span class="line">   ButtonTextTheme textTheme,  <span class="comment">//按钮上字体主题</span></span><br><span class="line">   Color textColor,  <span class="comment">//字体颜色</span></span><br><span class="line">   Color disabledTextColor, <span class="comment">//按钮禁用时候文字的颜色</span></span><br><span class="line">   Color color,  <span class="comment">//按钮背景颜色</span></span><br><span class="line">   Color highlightColor,<span class="comment">//点击或者toch控件高亮的时候显示在控件上面，水波纹下面的颜色</span></span><br><span class="line">   Color splashColor, <span class="comment">//水波纹的颜色</span></span><br><span class="line">   <span class="built_in">double</span> highlightElevation,<span class="comment">//高亮时候的阴影</span></span><br><span class="line">   <span class="keyword">this</span>.borderSide,<span class="comment">//按钮边框</span></span><br><span class="line">   <span class="keyword">this</span>.disabledBorderColor, <span class="comment">//按钮禁用时边框的颜色</span></span><br><span class="line">   <span class="keyword">this</span>.highlightedBorderColor,<span class="comment">//高亮时边框的颜色</span></span><br><span class="line">   EdgeInsetsGeometry padding,<span class="comment">//边距</span></span><br><span class="line">   ShapeBorder shape, <span class="comment">//设置shape</span></span><br><span class="line">   Clip clipBehavior = Clip.none,</span><br><span class="line">   Widget child,</span><br><span class="line">&#125;) </span><br></pre></td></tr></table></figure>

<p>设置圆角和边框颜色</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">OutlineButton(</span><br><span class="line"> borderSide: BorderSide(color: Colors.red),</span><br><span class="line"> shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(<span class="number">20</span>)),</span><br><span class="line"> child: Text(<span class="string">&#x27;normal&#x27;</span>),</span><br><span class="line">),</span><br></pre></td></tr></table></figure>

<ul>
<li>IconButton</li>
</ul>
<p>可点击 Icon，默认没有背景点击后出现背景</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">IconButton(</span><br><span class="line">     onPressed: ()&#123;</span><br><span class="line">       <span class="built_in">print</span>(<span class="string">&#x27;onPressed&#x27;</span>);</span><br><span class="line">     &#125;,</span><br><span class="line">     icon: Icon(Icons.thumb_up),</span><br><span class="line"> )</span><br></pre></td></tr></table></figure>

<ul>
<li>带图标按钮</li>
</ul>
<p>ElevatedButton、OutlineButton、IconButton 都有一个 icon 构造函数，通过 icon 创建带图标按钮</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">ElevatedButton.icon(</span><br><span class="line">   icon: Icon(Icons.send),</span><br><span class="line">   label: Text(<span class="string">&quot;发送&quot;</span>),</span><br><span class="line">   onPressed: _onPressed,</span><br><span class="line"> )</span><br></pre></td></tr></table></figure>

<h4 id="3-3-图片及ICON"><a href="#3-3-图片及ICON" class="headerlink" title="3.3 图片及ICON"></a>3.3 图片及ICON</h4><h5 id="3-3-1-图片"><a href="#3-3-1-图片" class="headerlink" title="3.3.1 图片"></a>3.3.1 图片</h5><ul>
<li>asset 中加载图片</li>
</ul>
<p>根目录创建一个 images 目录，avata.png 拷贝到目录</p>
<p>pubspec.yaml 中的 flutter 部分添加内容</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">assets:</span><br><span class="line">	- images/avatar.png</span><br><span class="line">也可以</span><br><span class="line">	- images/</span><br></pre></td></tr></table></figure>

<p>加载图片</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Image(image: AssetImage(<span class="string">&#x27;images/avatar.png&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>也提供了快捷构造函数 Image.asset</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Image.asset(<span class="string">&#x27;images/avatar.png&#x27;</span>, width: <span class="number">100</span>,)</span><br></pre></td></tr></table></figure>

<ul>
<li>网络加载图片</li>
</ul>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Image(image: NetworkImage(<span class="string">&#x27;https://xxxx&#x27;</span>), width: <span class="number">100</span>,)</span><br><span class="line">Image.network(<span class="string">&#x27;https://xxxx&#x27;</span>, width: <span class="number">100.0</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>Image 参数</li>
</ul>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> Image(&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">this</span>.width, <span class="comment">//图片的宽</span></span><br><span class="line">  <span class="keyword">this</span>.height, <span class="comment">//图片高度</span></span><br><span class="line">  <span class="keyword">this</span>.color, <span class="comment">//图片的混合色值</span></span><br><span class="line">  <span class="keyword">this</span>.colorBlendMode, <span class="comment">//混合模式</span></span><br><span class="line">  <span class="keyword">this</span>.fit,<span class="comment">//缩放模式</span></span><br><span class="line">  <span class="keyword">this</span>.alignment = Alignment.center, <span class="comment">//对齐方式</span></span><br><span class="line">  <span class="keyword">this</span>.repeat = ImageRepeat.noRepeat, <span class="comment">//重复方式</span></span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>width、height 设置图片宽高，不指定宽高时，图片会根据父容器的限制，尽可能显示原始大小，如果只设置一个，另一个属性会按比例缩放</p>
<p>fit：图片显示空间和图片大小不同时指定图片适应模式</p>
<p>fill 拉伸填充满显示空间，长宽比发生变化，图片会变形</p>
<p>cover 按图片长宽比放大后居中填充显示空间，图片不会变形，超出显示被裁剪</p>
<p>fit width 图片宽度缩放到显示空间宽度，高度按比例缩放，居中显示，图片不变形，超出显示被裁剪</p>
<p>fit height</p>
<p>none 没有适应策略，图片比显示空间达，则显示图片中间部分</p>
<p>repeat：图片大小小于显示空间时，指定图片重复规则</p>
<img src="《Flutter实战第二版》三：基础组件/WeChatfd803adaf46878bf208e18fb3907acc4.png" alt="WeChatfd803adaf46878bf208e18fb3907acc4" style="zoom:80%;" />

<h5 id="3-3-2-iconfont"><a href="#3-3-2-iconfont" class="headerlink" title="3.3.2 iconfont"></a>3.3.2 iconfont</h5><p>Flutter 默认包含了一套 Material Design 的字体图标，是将图标做成字体文件，通过指定不同字符显示不同图片</p>
<p>在 pubspec.yaml 中配置</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">flutter:</span><br><span class="line">  users-material-design: <span class="keyword">true</span></span><br></pre></td></tr></table></figure>

<p>Material Design 所有图标可以在官网查看 <a href="https://material.io/tools/icons/">https://material.io/tools/icons/</a></p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">String</span> icons = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="comment">// accessible: 0xe03e</span></span><br><span class="line">icons += <span class="string">&quot;\uE03e&quot;</span>;</span><br><span class="line"><span class="comment">// error:  0xe237</span></span><br><span class="line">icons += <span class="string">&quot; \uE237&quot;</span>;</span><br><span class="line"><span class="comment">// fingerprint: 0xe287</span></span><br><span class="line">icons += <span class="string">&quot; \uE287&quot;</span>;</span><br><span class="line"></span><br><span class="line">Text(</span><br><span class="line">  icons,</span><br><span class="line">  style: TextStyle(</span><br><span class="line">    fontFamily: <span class="string">&quot;MaterialIcons&quot;</span>,</span><br><span class="line">    fontSize: <span class="number">24.0</span>,</span><br><span class="line">    color: Colors.green,</span><br><span class="line">  ),</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>Flutter 封装了 IconData 和 Icon 来专门显示字体图标</p>
<p>icons 类中包含了所有 Material Design 图标的 IconData 静态变量定义</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Row(</span><br><span class="line">   mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">   children: &lt;Widget&gt;[</span><br><span class="line">     Icon(MyIcons.book,color: Colors.purple),</span><br><span class="line">     Icon(MyIcons.wechat,color: Colors.green),</span><br><span class="line">   ],</span><br><span class="line"> )</span><br></pre></td></tr></table></figure>



<ul>
<li>使用自定义字体图标 </li>
</ul>
<p>导入字体图标文件</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">fonts:</span><br><span class="line">  - family: myIcon  #指定一个字体名</span><br><span class="line">    fonts:</span><br><span class="line">      - asset: fonts/iconfont.ttf</span><br></pre></td></tr></table></figure>

<p>为了使用方便，定义 MyIcons 类，将字体文件中的所有图标都定义成静态变量</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyIcons</span></span>&#123;</span><br><span class="line">  <span class="comment">// book 图标</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> IconData book = <span class="keyword">const</span> IconData(</span><br><span class="line">      <span class="number">0xe614</span>, </span><br><span class="line">      fontFamily: <span class="string">&#x27;myIcon&#x27;</span>, </span><br><span class="line">      matchTextDirection: <span class="keyword">true</span></span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// 微信图标</span></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> IconData wechat = <span class="keyword">const</span> IconData(</span><br><span class="line">      <span class="number">0xec7d</span>,  </span><br><span class="line">      fontFamily: <span class="string">&#x27;myIcon&#x27;</span>, </span><br><span class="line">      matchTextDirection: <span class="keyword">true</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-4-单选开关和复选框"><a href="#3-4-单选开关和复选框" class="headerlink" title="3.4 单选开关和复选框"></a>3.4 单选开关和复选框</h4><p>它们本身不会保存当前选中状态</p>
<p><img src="/%E3%80%8AFlutter%E5%AE%9E%E6%88%98%E7%AC%AC%E4%BA%8C%E7%89%88%E3%80%8B%E4%B8%89%EF%BC%9A%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6/WeChate24ea09c0c08061e88779c644b095b75.png?lastModify=1642479994" alt="WeChate24ea09c0c08061e88779c644b095b75"></p>
<p>都有个 activeColor 属性设置激活态颜色</p>
<p>Checkbox 大小固定，无法自定义</p>
<p>Switch 只能自定宽度，高度固定</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"> <span class="built_in">bool</span> _switchSelected=<span class="keyword">true</span>; <span class="comment">//维护单选开关状态</span></span><br><span class="line"> <span class="built_in">bool</span> _checkboxSelected=<span class="keyword">true</span>;<span class="comment">//维护复选框状态</span></span><br><span class="line"> Switch(</span><br><span class="line"> value: _switchSelected,</span><br><span class="line"> onChanged: (value)&#123;</span><br><span class="line">   setState(() &#123;</span><br><span class="line">     _switchSelected = value;</span><br><span class="line">   &#125;);</span><br><span class="line"> &#125;),</span><br><span class="line">Checkbox(</span><br><span class="line"> value: _checkboxSelected,</span><br><span class="line"> onChanged: (value)&#123;</span><br><span class="line">   setState(() &#123;</span><br><span class="line">     _checkboxSelected = value ?? <span class="keyword">false</span>;</span><br><span class="line">   &#125;);</span><br><span class="line"> &#125;),</span><br></pre></td></tr></table></figure>

<h4 id="3-5-输入框及表单"><a href="#3-5-输入框及表单" class="headerlink" title="3.5 输入框及表单"></a>3.5 输入框及表单</h4><h5 id="3-5-1-输入框-TextField"><a href="#3-5-1-输入框-TextField" class="headerlink" title="3.5.1 输入框 TextField"></a>3.5.1 输入框 TextField</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> TextField(&#123;</span><br><span class="line">   Key key,</span><br><span class="line">   <span class="keyword">this</span>.controller,           <span class="comment">//控制器，控制TextField文字</span></span><br><span class="line">   <span class="keyword">this</span>.focusNode, <span class="comment">//控制textField是否占有当前键盘的输入焦点</span></span><br><span class="line">   <span class="keyword">this</span>.decoration = <span class="keyword">const</span> InputDecoration(),    <span class="comment">//输入器装饰</span></span><br><span class="line">   TextInputType keyboardType,   <span class="comment">//输入的类型</span></span><br><span class="line">   <span class="keyword">this</span>.textInputAction,  <span class="comment">//键盘回车键图标</span></span><br><span class="line">   <span class="keyword">this</span>.textCapitalization = TextCapitalization.none,</span><br><span class="line">   <span class="keyword">this</span>.style,</span><br><span class="line">   <span class="keyword">this</span>.textAlign = TextAlign.start,   <span class="comment">//文字显示位置</span></span><br><span class="line">   <span class="keyword">this</span>.autofocus = <span class="keyword">false</span>, <span class="comment">//是否自动获取焦点</span></span><br><span class="line">   <span class="keyword">this</span>.obscureText = <span class="keyword">false</span>, <span class="comment">//是否*号显示</span></span><br><span class="line">   <span class="keyword">this</span>.autocorrect = <span class="keyword">true</span>,</span><br><span class="line">   <span class="keyword">this</span>.maxLines = <span class="number">1</span>,</span><br><span class="line">   <span class="keyword">this</span>.maxLength, <span class="comment">//文本框最大长度，设置后输入框右下角会显示输入的文本计数</span></span><br><span class="line">   <span class="keyword">this</span>.maxLengthEnforced = <span class="keyword">true</span>,</span><br><span class="line">   <span class="keyword">this</span>.onChanged,                <span class="comment">//文字改变触发</span></span><br><span class="line">   <span class="keyword">this</span>.onEditingComplete,   <span class="comment">//当用户提交可编辑内容时调用</span></span><br><span class="line">   <span class="keyword">this</span>.onSubmitted,   <span class="comment">////<span class="markdown">文字提交触发（键盘按键）</span></span></span><br><span class="line">   <span class="keyword">this</span>.inputFormatters, <span class="comment">//指定输入格式，输入内容改变时，会根据指定格式校验</span></span><br><span class="line">   <span class="keyword">this</span>.enabled,</span><br><span class="line">   <span class="keyword">this</span>.cursorWidth = <span class="number">2.0</span>, <span class="comment">//输入光标宽度</span></span><br><span class="line">   <span class="keyword">this</span>.cursorRadius,    <span class="comment">//输入光标圆角  </span></span><br><span class="line">   <span class="keyword">this</span>.cursorColor,   <span class="comment">//输入光标颜色</span></span><br><span class="line">   <span class="keyword">this</span>.keyboardAppearance,</span><br><span class="line">   <span class="keyword">this</span>.scrollPadding = <span class="keyword">const</span> EdgeInsets.all(<span class="number">20.0</span>),</span><br><span class="line"> &#125;)</span><br></pre></td></tr></table></figure>

<p>controller 编辑框的控制器，通过它可以设置/获取编辑框的内容、选择编辑内容、监听文本改变事件。</p>
<p>focusNode 用于控制 TextField 是否占有当前键盘的输入焦点</p>
<p>decoration 用于控制 TextField 的外观显示，如提示文本、背景颜色、边框</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">FocusNode focusNode1 = FocusNode();</span><br><span class="line">FocusNode focusNode2 = FocusNode();</span><br><span class="line">FocusScopeNode? focusScopeNode;</span><br><span class="line"></span><br><span class="line">body: Center(</span><br><span class="line">  child: Column(</span><br><span class="line">    children: [</span><br><span class="line">      TextField(</span><br><span class="line">        autofocus: <span class="keyword">true</span>,</span><br><span class="line">        focusNode: focusNode1,</span><br><span class="line">        controller: _unameController,</span><br><span class="line">        decoration: InputDecoration(</span><br><span class="line">          labelText: <span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">          hintText: <span class="string">&#x27;用户名或邮箱&#x27;</span>,</span><br><span class="line">          prefixIcon: Icon(Icons.person),</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">      TextField(</span><br><span class="line">        focusNode: focusNode2,</span><br><span class="line">        decoration: InputDecoration(</span><br><span class="line">          labelText: <span class="string">&#x27;密码&#x27;</span>,</span><br><span class="line">          hintText: <span class="string">&#x27;登录密码&#x27;</span>,</span><br><span class="line">          prefixIcon: Icon(Icons.lock),</span><br><span class="line">        ),</span><br><span class="line">        obscureText: <span class="keyword">true</span>,</span><br><span class="line">      ),</span><br><span class="line">      ElevatedButton(</span><br><span class="line">        onPressed: ()&#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">null</span> == focusScopeNode) &#123;</span><br><span class="line">            focusScopeNode = FocusScope.of(context);</span><br><span class="line">          &#125;</span><br><span class="line">          focusScopeNode!.requestFocus(focusNode2);</span><br><span class="line">        &#125;,</span><br><span class="line">        child: Text(<span class="string">&#x27;移动焦点&#x27;</span>),</span><br><span class="line">      ),</span><br><span class="line">      ElevatedButton(</span><br><span class="line">        onPressed: ()&#123;</span><br><span class="line">          focusNode1.unfocus();</span><br><span class="line">          focusNode2.unfocus();</span><br><span class="line">        &#125;,</span><br><span class="line">        child: Text(<span class="string">&#x27;隐藏键盘&#x27;</span>),</span><br><span class="line">      ),</span><br><span class="line">    ],</span><br><span class="line">  ),</span><br><span class="line">),</span><br></pre></td></tr></table></figure>



<p><img src="/%E3%80%8AFlutter%E5%AE%9E%E6%88%98%E7%AC%AC%E4%BA%8C%E7%89%88%E3%80%8B%E4%B8%89%EF%BC%9A%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6/WeChatce892753a9d9210783f5c2d69dadd941.png?lastModify=1642479994" alt="WeChatce892753a9d9210783f5c2d69dadd941"></p>
<ul>
<li>获取输入内容</li>
</ul>
<p>定义一个 controller</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">TextEditingController _unameController = TextEditingController();</span><br></pre></td></tr></table></figure>

<p>设置输入 controller</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">TextField(</span><br><span class="line">    autofocus: <span class="keyword">true</span>,</span><br><span class="line">    controller: _unameController,</span><br></pre></td></tr></table></figure>

<p>通过 onChange 回调获取输入内容</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">TextField(</span><br><span class="line">    autofocus: <span class="keyword">true</span>,</span><br><span class="line">    onChanged: (v) &#123;</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;onChange: <span class="subst">$v</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>通过 controller 监听获取输入的内容</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> initState() &#123;</span><br><span class="line">  <span class="keyword">super</span>.initState();</span><br><span class="line">  _unameController.addListener(() &#123;</span><br><span class="line">    <span class="built_in">print</span>(_unameController.text);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>onChange 是专门用于监听文本变化</p>
<p>controller 还可以设置默认值、选择文本</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">_selectionController.text=<span class="string">&quot;hello world!&quot;</span>;</span><br><span class="line">_selectionController.selection=TextSelection(</span><br><span class="line">    baseOffset: <span class="number">2</span>,</span><br><span class="line">    extentOffset: _selectionController.text.length</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<ul>
<li>控制焦点</li>
</ul>
<p>通过 FocusScopeNode 在输入框之间移动焦点、设置默认焦点</p>
<p>通过 FocusScope.of(context) 获取 Widget 树中默认的 FocusScopeNode</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">FocusScopeNode? focusScopeNode;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">null</span> == focusScopeNode) &#123;</span><br><span class="line">  focusScopeNode = FocusScope.of(context);</span><br><span class="line">&#125;</span><br><span class="line">focusScopeNode!.requestFocus(focusNode2); <span class="comment">//移动焦点</span></span><br></pre></td></tr></table></figure>

<ul>
<li>监听焦点改变事件</li>
</ul>
<p>获取到焦点时 focusNode.hasFocus 为 true 失去焦点时为 false</p>
<p>FocusNode 继承自 ChangeNotifier，通过 FocusNode 可以监听焦点的改变</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="comment">//隐藏键盘</span></span><br><span class="line">focusNode1.unfocus();</span><br><span class="line">...</span><br><span class="line"><span class="comment">// 创建 focusNode   </span></span><br><span class="line">FocusNode focusNode = FocusNode();</span><br><span class="line">...</span><br><span class="line"><span class="comment">// focusNode绑定输入框   </span></span><br><span class="line">TextField(focusNode: focusNode);</span><br><span class="line">...</span><br><span class="line"><span class="comment">// 监听焦点变化    </span></span><br><span class="line">focusNode.addListener(()&#123;</span><br><span class="line">   <span class="built_in">print</span>(focusNode.hasFocus);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>自定义样式</li>
</ul>
<p>分别设置输入框未获得和获得焦点下划线颜色</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">decoration: InputDecoration(</span><br><span class="line">  labelText: <span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">  hintText: <span class="string">&#x27;用户名或邮箱&#x27;</span>,</span><br><span class="line">  prefixIcon: Icon(Icons.person),</span><br><span class="line">  enabledBorder: UnderlineInputBorder( <span class="comment">//未获得焦点下划线颜色</span></span><br><span class="line">    borderSide: BorderSide(color: Colors.red),</span><br><span class="line">  ),</span><br><span class="line">  focusedBorder: UnderlineInputBorder( <span class="comment">//获得焦点下划线颜色</span></span><br><span class="line">    borderSide: BorderSide(color: Colors.yellow),</span><br><span class="line">  ),</span><br><span class="line">),</span><br></pre></td></tr></table></figure>

<p>通过主题自定义输入框样式</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Theme(</span><br><span class="line">  data: Theme.of(context).copyWith(</span><br><span class="line">      hintColor: Colors.grey[<span class="number">200</span>], <span class="comment">//定义下划线颜色</span></span><br><span class="line">      inputDecorationTheme: InputDecorationTheme(</span><br><span class="line">          labelStyle: TextStyle(color: Colors.grey),<span class="comment">//定义label字体样式</span></span><br><span class="line">          hintStyle: TextStyle(color: Colors.grey, fontSize: <span class="number">14.0</span>)<span class="comment">//定义提示文本样式</span></span><br><span class="line">      )</span><br><span class="line">  ),</span><br></pre></td></tr></table></figure>

<p>另一种灵活的方式是直接隐藏 TextField 本身的下划线，通过 Container 去嵌套定义样式</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Container(</span><br><span class="line">  child: TextField(</span><br><span class="line">    keyboardType: TextInputType.emailAddress,</span><br><span class="line">    decoration: InputDecoration(</span><br><span class="line">        labelText: <span class="string">&quot;Email&quot;</span>,</span><br><span class="line">        hintText: <span class="string">&quot;电子邮件地址&quot;</span>,</span><br><span class="line">        prefixIcon: Icon(Icons.email),</span><br><span class="line">        border: InputBorder.none <span class="comment">//隐藏下划线</span></span><br><span class="line">    )</span><br><span class="line">  ),</span><br><span class="line">  decoration: BoxDecoration(</span><br><span class="line">      <span class="comment">// 下滑线浅灰色，宽度1像素</span></span><br><span class="line">      border: Border(bottom: BorderSide(color: Colors.grey[<span class="number">200</span>], width: <span class="number">1.0</span>))</span><br><span class="line">  ),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h5 id="3-5-2-表单-Form"><a href="#3-5-2-表单-Form" class="headerlink" title="3.5.2 表单 Form"></a>3.5.2 表单 Form</h5><ul>
<li>Form</li>
</ul>
<p>可以对输入框进行分组，然后进行统一操作</p>
<p>Form 类的定义 </p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Form(&#123;</span><br><span class="line">  <span class="keyword">required</span> Widget child,</span><br><span class="line">  <span class="built_in">bool</span> autovalidate = <span class="keyword">false</span>,</span><br><span class="line">  WillPopCallback onWillPop,</span><br><span class="line">  VoidCallback onChanged,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>autovalidate 是否自动校验输入内容，为 true 时，每个 FormField 内容变化时自动校验合法性，显示错误信息，否则需要通过调用 FormState.validate() 来手动校验</p>
<p>onWillPop 决定 Form 所在路由是否可以直接返回，通常用于拦截返回按钮</p>
<p>onChanged： Form 任意一个子 FormField 内容发生改变时触发回调</p>
<ul>
<li>FormField</li>
</ul>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> FormField(&#123;</span><br><span class="line">   ...</span><br><span class="line">   FormFieldSetter&lt;T&gt; onSaved, <span class="comment">//保存回调</span></span><br><span class="line">   FormFieldValidator&lt;T&gt;  validator, <span class="comment">//验证回调</span></span><br><span class="line">   T initialValue, <span class="comment">//初始值</span></span><br><span class="line">   <span class="built_in">bool</span> autovalidate = <span class="keyword">false</span>, <span class="comment">//是否自动校验。</span></span><br><span class="line"> &#125;)</span><br></pre></td></tr></table></figure>

<p>Form 的子孙元素必须是 FormField 类型</p>
<p>为了使用方便，Flutter 提供了一个 TextFormField</p>
<ul>
<li>FormState</li>
</ul>
<p>FormState 为 Form 的State 类，可以通过 Form.of(context) 或 GlobalKey 获得，可以通过它来对 Form 的子孙 FormField 进行统一操作</p>
<p>FormState.validate()：调用后，会调用 Form 子孙 FormField 的 validate 回调，有一个校验失败返回 false</p>
<p>FormState.save()：会调用 Form 子孙 FormField 的 save 回调，用于保存表单内容</p>
<p>FormState.reset()：会将子孙 FormField 的内容清空</p>
<ul>
<li>示例</li>
</ul>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">void</span> main() &#123;</span><br><span class="line">   runApp(MaterialApp(home: FormTestRoute()));</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">FormTestRoute</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">   <span class="meta">@override</span></span><br><span class="line">   _FormTestRouteState createState() =&gt; _FormTestRouteState();</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">_FormTestRouteState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">FormTestRoute</span>&gt; </span>&#123;</span><br><span class="line">   TextEditingController _unameController = TextEditingController();</span><br><span class="line">   TextEditingController _pwdController   = TextEditingController();</span><br><span class="line">   GlobalKey _formKey = GlobalKey&lt;FormState&gt;();</span><br><span class="line"> </span><br><span class="line">   <span class="meta">@override</span></span><br><span class="line">   <span class="keyword">void</span> initState() &#123;</span><br><span class="line">     <span class="keyword">super</span>.initState();</span><br><span class="line"> </span><br><span class="line">     _unameController.addListener(() &#123;</span><br><span class="line">       <span class="built_in">print</span>(_unameController.text);</span><br><span class="line">     &#125;);</span><br><span class="line">   &#125;</span><br><span class="line"> </span><br><span class="line">   <span class="meta">@override</span></span><br><span class="line">   Widget build(BuildContext context) &#123;</span><br><span class="line">     <span class="keyword">return</span> Scaffold(</span><br><span class="line">       appBar: AppBar(</span><br><span class="line">         title: Text(<span class="string">&#x27;标题&#x27;</span>),</span><br><span class="line">       ),</span><br><span class="line">       body: Form(</span><br><span class="line">         key: _formKey,<span class="comment">//设置 globalkey</span></span><br><span class="line">         child: Column(</span><br><span class="line">           children: [</span><br><span class="line">             TextFormField(</span><br><span class="line">               autofocus: <span class="keyword">true</span>,</span><br><span class="line">               controller: _unameController,</span><br><span class="line">               decoration: InputDecoration(</span><br><span class="line">                 labelText: <span class="string">&#x27;用户名&#x27;</span>,</span><br><span class="line">                 hintText: <span class="string">&#x27;用户名或邮箱&#x27;</span>,</span><br><span class="line">                 prefixIcon: Icon(Icons.person),</span><br><span class="line">               ),</span><br><span class="line">               <span class="comment">//校验用户名</span></span><br><span class="line">               validator: (v)&#123;</span><br><span class="line">                 <span class="keyword">return</span> v!.trim().length &gt; <span class="number">0</span> ? <span class="keyword">null</span> : <span class="string">&#x27;用户名不能为空&#x27;</span>;</span><br><span class="line">               &#125;,</span><br><span class="line">             ),</span><br><span class="line">             TextFormField(</span><br><span class="line">               decoration: InputDecoration(</span><br><span class="line">                 labelText: <span class="string">&#x27;密码&#x27;</span>,</span><br><span class="line">                 hintText: <span class="string">&#x27;登录密码&#x27;</span>,</span><br><span class="line">                 prefixIcon: Icon(Icons.lock),</span><br><span class="line">               ),</span><br><span class="line">               obscureText: <span class="keyword">true</span>,</span><br><span class="line">               <span class="comment">//校验密码</span></span><br><span class="line">               validator: (v)&#123;</span><br><span class="line">                 <span class="keyword">return</span> v!.trim().length &gt; <span class="number">0</span> ? <span class="keyword">null</span> : <span class="string">&#x27;密码不能为空&#x27;</span>;</span><br><span class="line">               &#125;,</span><br><span class="line">             ),</span><br><span class="line">             Padding(</span><br><span class="line">                 padding: EdgeInsets.only(top: <span class="number">20</span>),</span><br><span class="line">                 child: Row(</span><br><span class="line">                   children: [</span><br><span class="line">                     Expanded(</span><br><span class="line">                         child: ElevatedButton(</span><br><span class="line">                           child: Padding(</span><br><span class="line">                             padding: EdgeInsets.all(<span class="number">16</span>),</span><br><span class="line">                             child: Text(<span class="string">&#x27;登录&#x27;</span>),</span><br><span class="line">                           ),</span><br><span class="line">                           onPressed: ()&#123;</span><br><span class="line">                             <span class="comment">// 通过_formKey.currentState 获取FormState后，</span></span><br><span class="line">                             <span class="comment">// 调用validate()方法校验用户名密码是否合法，校验</span></span><br><span class="line">                             <span class="comment">// 通过后再提交数据。</span></span><br><span class="line">                             <span class="keyword">if</span> ((_formKey.currentState <span class="keyword">as</span> FormState).validate()) &#123;</span><br><span class="line">                               <span class="built_in">print</span>(<span class="string">&#x27;通过校验&#x27;</span>);</span><br><span class="line">                             &#125;</span><br><span class="line">                           &#125;,</span><br><span class="line">                         ),</span><br><span class="line">                     ),</span><br><span class="line">                   ],</span><br><span class="line">                 ),</span><br><span class="line">             ),</span><br><span class="line">           ],</span><br><span class="line">         ),</span><br><span class="line">       ),</span><br><span class="line">     );</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/%E3%80%8AFlutter%E5%AE%9E%E6%88%98%E7%AC%AC%E4%BA%8C%E7%89%88%E3%80%8B%E4%B8%89%EF%BC%9A%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6/WeChat803de70354088ea04b9983c0a122d48b.png?lastModify=1642479994" alt="WeChat803de70354088ea04b9983c0a122d48b"></p>
<p>此处登录按钮的 onPressed 方法不能通过 Form.of(context) 来获取，这边的context是 FormTestRoute 的context</p>
<p>Form.of(context) 是根据所指定的 context 向根去查找，FormState 是在FormTestRoute的子树中所以不行 </p>
<p>可以通过 Builder 来构建登录按钮，Builder 会将 Widget 节点的context 作为回调参数</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Expanded(</span><br><span class="line"> <span class="comment">// 通过Builder来获取ElevatedButton所在widget树的真正context(Element) </span></span><br><span class="line">  child:Builder(builder: (context)&#123;</span><br><span class="line">    <span class="keyword">return</span> ElevatedButton(</span><br><span class="line">      ...</span><br><span class="line">      onPressed: () &#123;</span><br><span class="line">        <span class="comment">//由于本widget也是Form的子代widget，所以可以通过下面方式获取FormState  </span></span><br><span class="line">        <span class="keyword">if</span>(Form.of(context).validate())&#123;</span><br><span class="line">          <span class="comment">//验证通过提交数据</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    );</span><br><span class="line">  &#125;)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h4 id="3-6-进度指示器"><a href="#3-6-进度指示器" class="headerlink" title="3.6 进度指示器"></a>3.6 进度指示器</h4><ul>
<li>LinearProgressIndicator</li>
</ul>
<p>线性条状进度条</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">LinearProgressIndicator(&#123;</span><br><span class="line">  <span class="built_in">double</span> value,</span><br><span class="line">  Color backgroundColor,</span><br><span class="line">  Animation&lt;Color&gt; valueColor,</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>value：当前进度，取值 [0,1]，value 为 null 会执行一个循环动画，不为 null 时为一个具体进度的进度条</p>
<p>valueColor：进度条颜色，类型 <code>Animation&lt;Color&gt;</code>，允许对进度条颜色指定动画，如果使用固定颜色使用 AlwaysStoppedAnimation 来指定</p>
<ul>
<li>CircularProgressIndicator</li>
</ul>
<p>圆形进度条</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"> CircularProgressIndicator(&#123;</span><br><span class="line">  <span class="built_in">double</span> value,</span><br><span class="line">  Color backgroundColor,</span><br><span class="line">  Animation&lt;Color&gt; valueColor,</span><br><span class="line">  <span class="keyword">this</span>.strokeWidth = <span class="number">4.0</span>,</span><br><span class="line">  ...   </span><br><span class="line">&#125;) </span><br></pre></td></tr></table></figure>

<p>strokeWidth 圆形进度条的粗细</p>
<ul>
<li>示例</li>
</ul>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">LinearProgressIndicator(</span><br><span class="line">  backgroundColor: Colors.grey[<span class="number">200</span>],</span><br><span class="line">  valueColor: AlwaysStoppedAnimation(Colors.blue),</span><br><span class="line">  value: <span class="number">.5</span>,</span><br><span class="line">),</span><br><span class="line">CircularProgressIndicator(</span><br><span class="line">  backgroundColor: Colors.grey[<span class="number">200</span>],</span><br><span class="line">  valueColor: AlwaysStoppedAnimation(Colors.blue),</span><br><span class="line">),</span><br></pre></td></tr></table></figure>

<ul>
<li>自定义尺寸</li>
</ul>
<p>CircularProgressIndicator 和 LinearProgressIndicator 都是取父容器的尺寸作为绘制边界的，可以通过尺寸限制 Widget，如 ConstrainedBox、SizedBox</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 线性进度条高度指定为3</span></span><br><span class="line">SizedBox(</span><br><span class="line">  height: <span class="number">3</span>,</span><br><span class="line">  child: LinearProgressIndicator(</span><br><span class="line">    backgroundColor: Colors.grey[<span class="number">200</span>],</span><br><span class="line">    valueColor: AlwaysStoppedAnimation(Colors.blue),</span><br><span class="line">    value: <span class="number">.5</span>,</span><br><span class="line">  ),</span><br><span class="line">),</span><br><span class="line"><span class="comment">// 圆形进度条直径指定为100</span></span><br><span class="line">SizedBox(</span><br><span class="line">  height: <span class="number">100</span>,</span><br><span class="line">  width: <span class="number">100</span>,</span><br><span class="line">  child: CircularProgressIndicator(</span><br><span class="line">    backgroundColor: Colors.grey[<span class="number">200</span>],</span><br><span class="line">    valueColor: AlwaysStoppedAnimation(Colors.blue),</span><br><span class="line">    value: <span class="number">.7</span>,</span><br><span class="line">  ),</span><br><span class="line">),</span><br></pre></td></tr></table></figure>

<ul>
<li><p>进度色动画</p>
</li>
<li><p>自定义进度指示器样式</p>
</li>
</ul>
<p>可以通过 CustomPainter Widge 来自定义绘制逻辑</p>
]]></content>
  </entry>
  <entry>
    <title>《Flutter实战第二版》二：第一个Flutter应用</title>
    <url>/2022/01/18/%E3%80%8AFlutter%E5%AE%9E%E6%88%98%E7%AC%AC%E4%BA%8C%E7%89%88%E3%80%8B%E4%BA%8C%EF%BC%9A%E7%AC%AC%E4%B8%80%E4%B8%AAFlutter%E5%BA%94%E7%94%A8/</url>
    <content><![CDATA[<h3 id="2-第一个-Flutter-应用"><a href="#2-第一个-Flutter-应用" class="headerlink" title="2 第一个 Flutter 应用"></a>2 第一个 Flutter 应用</h3><h4 id="2-1-计数器应用"><a href="#2-1-计数器应用" class="headerlink" title="2.1 计数器应用"></a>2.1 计数器应用</h4><h5 id="2-1-1-创建-Flutter-应用模板"><a href="#2-1-1-创建-Flutter-应用模板" class="headerlink" title="2.1.1 创建 Flutter 应用模板"></a>2.1.1 创建 Flutter 应用模板</h5><p>Android Studio 创建新的 Flutter 工程得到一个计数器应用 Demo</p>
<img src="《Flutter实战第二版》二：第一个Flutter应用/WeChatb18a46cb6a1321d33b71401d68d6e8ba.png" alt="WeChatb18a46cb6a1321d33b71401d68d6e8ba" style="zoom:50%;" />

<p>示例主要 Dart 代码在 lib/main.dart 文件中，源码</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() &#123; runApp(<span class="keyword">const</span> MyApp()); &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> MyApp(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> MaterialApp(</span><br><span class="line">      title: <span class="string">&#x27;Flutter Demo&#x27;</span>,</span><br><span class="line">      theme: ThemeData(</span><br><span class="line">        primarySwatch: Colors.blue,</span><br><span class="line">      ),</span><br><span class="line">      home: <span class="keyword">const</span> MyHomePage(title: <span class="string">&#x27;Flutter Demo Home Page&#x27;</span>),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyHomePage</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> MyHomePage(&#123;Key? key, <span class="keyword">required</span> <span class="keyword">this</span>.title&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> title;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  State&lt;MyHomePage&gt; createState() =&gt; _MyHomePageState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_MyHomePageState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">MyHomePage</span>&gt; </span>&#123;</span><br><span class="line">  <span class="built_in">int</span> _counter = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">void</span> _incrementCounter() &#123;</span><br><span class="line">    setState(() &#123;</span><br><span class="line">      _counter++;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(widget.title),</span><br><span class="line">      ),</span><br><span class="line">      body: Center(</span><br><span class="line">        child: Column(</span><br><span class="line">          mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">          children: &lt;Widget&gt;[</span><br><span class="line">            <span class="keyword">const</span> Text(</span><br><span class="line">              <span class="string">&#x27;You have pushed the button this many times:&#x27;</span>,</span><br><span class="line">            ),</span><br><span class="line">            Text(</span><br><span class="line">              <span class="string">&#x27;<span class="subst">$_counter</span>&#x27;</span>,</span><br><span class="line">              style: Theme.of(context).textTheme.headline4,</span><br><span class="line">            ),</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">      floatingActionButton: FloatingActionButton(</span><br><span class="line">        onPressed: _incrementCounter,</span><br><span class="line">        tooltip: <span class="string">&#x27;Increment&#x27;</span>,</span><br><span class="line">        child: <span class="keyword">const</span> Icon(Icons.add),</span><br><span class="line">      ), <span class="comment">// This trailing comma makes auto-formatting nicer for build methods.</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>分析</li>
</ul>
<ol>
<li>导入包</li>
</ol>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>导入了 Material UI 组件库，Material 是一种标准的移动端和web端视觉设计语言，Flutter 默认提供了一套丰富的 Material 风格的 UI 组件</p>
<ol start="2">
<li>应用的入口</li>
</ol>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> main() &#123; runApp(<span class="keyword">const</span> MyApp()); &#125;</span><br></pre></td></tr></table></figure>

<p>man 函数为应用程序入口，main 函数调用了 runApp 方法，它的功能是启动 Flutter 应用，runApp 接受一个 Widget 参数，本示例中它是一个 MyApp 对象， MyApp() 是 Flutter 应用的根组件</p>
<ol start="3">
<li>应用结构</li>
</ol>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> MyApp(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> MaterialApp(</span><br><span class="line">      title: <span class="string">&#x27;Flutter Demo&#x27;</span>,</span><br><span class="line">      theme: ThemeData(</span><br><span class="line">        primarySwatch: Colors.blue,<span class="comment">//蓝色主题</span></span><br><span class="line">      ),</span><br><span class="line">      home: <span class="keyword">const</span> MyHomePage(title: <span class="string">&#x27;Flutter Demo Home Page&#x27;</span>),<span class="comment">//应用首页路由</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MyApp 类代表 Flutter 应用，继承了 StatelessWidget 类，意味着应用本身也是一个 widget</p>
<p>Flutter 中大多数东西都是 widget，包括对齐(Align)、填充(Padding)、手势处理(GestureDetector)等，都是以 widget 的形式提供</p>
<p>Flutter 构建页面时，会调用组件 build 方法，widget 的主要工作是提供一个 build() 方法来描述如何构建 UI 界面(通常是组合、拼装其它基础 widget)</p>
<p>MaterialAPP 是 Material 库中提供的 Flutter APP 框架，通过它可以设置应用的名称、主题、首页及路由列表，MaterialAPP 也是一个 widget</p>
<p>home 为 Flutter 应用首页，也是一个 widget</p>
<h5 id="2-1-2-首页"><a href="#2-1-2-首页" class="headerlink" title="2.1.2 首页"></a>2.1.2 首页</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyHomePage</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> MyHomePage(&#123;Key? key, <span class="keyword">required</span> <span class="keyword">this</span>.title&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> title;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  State&lt;MyHomePage&gt; createState() =&gt; _MyHomePageState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_MyHomePageState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">MyHomePage</span>&gt; </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MyHomePage 应用首页 继承自 StatefulWidget 类，表示它是一个有状态的组件</p>
<p>StatefulWidget 至少由两个类组成：</p>
<p>一个 StatefulWidget 类；一个 State 类；StatefulWidget 类本身是不变的，State 类持有的状态在 widget 生命周期中可能发生变化</p>
<ul>
<li>State 类</li>
</ul>
<p>_MyHomePageState 类包含</p>
<ol>
<li>该组件的状态，这里只需要维护一个点击次数的计数器，所以定义一个 _counter</li>
</ol>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">int</span> _counter = <span class="number">0</span>;<span class="comment">//记录按钮点击次数</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>设置状态的自增函数</li>
</ol>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> _incrementCounter() &#123;</span><br><span class="line">  setState(() &#123;</span><br><span class="line">    _counter++;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>按钮点击时会调用此函数，该函数作用是先自增 _counter，然后调用 setState 方法，setState 方法作用是通知 Flutter 框架，有状态发生了改变，Flutter 框架收到通知后，会执行 build 方法来跟进新的状态重新构建界面</p>
<ol start="3">
<li>构建 UI 界面</li>
</ol>
<p>构建 UI 界面在 build 方法中，MyHomePage 第一次创建时，_MyHomePageState 类会被创建，Flutter 框架会调用 widget 的 build 方法来构建 widget 树</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Widget build(BuildContext context) &#123;</span><br><span class="line">  <span class="keyword">return</span> Scaffold(</span><br><span class="line">    appBar: AppBar(</span><br><span class="line">      title: Text(widget.title),</span><br><span class="line">    ),</span><br><span class="line">    body: Center(</span><br><span class="line">      child: Column(</span><br><span class="line">        mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">        children: &lt;Widget&gt;[</span><br><span class="line">          <span class="keyword">const</span> Text(</span><br><span class="line">            <span class="string">&#x27;You have pushed the button this many times:&#x27;</span>,</span><br><span class="line">          ),</span><br><span class="line">          Text(</span><br><span class="line">            <span class="string">&#x27;<span class="subst">$_counter</span>&#x27;</span>,</span><br><span class="line">            style: Theme.of(context).textTheme.headline4,</span><br><span class="line">          ),</span><br><span class="line">        ],</span><br><span class="line">      ),</span><br><span class="line">    ),</span><br><span class="line">    floatingActionButton: FloatingActionButton(</span><br><span class="line">      onPressed: _incrementCounter,</span><br><span class="line">      tooltip: <span class="string">&#x27;Increment&#x27;</span>,</span><br><span class="line">      child: <span class="keyword">const</span> Icon(Icons.add),</span><br><span class="line">    ), <span class="comment">// This trailing comma makes auto-formatting nicer for build methods.</span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Scaffold 是 Material 库中提供的页面脚手架，提供了默认的导航栏、标题、和包含主屏幕 widget 树的body 属性，路由默认都是通过 Scaffold 创建</p>
<p>body 组件中包含了一个 Center 组件，Center 组件可以将子组件对齐到屏幕中心</p>
<p>Center 的子组件是一个 Column 组件，Column 作用是将其所有子组件沿屏幕垂直方向依次排列</p>
<p>floatingActionButton 页面右下角带+号的悬浮按钮，它的 onPressed 属性接受一个回调函数</p>
<h4 id="2-2-Widget"><a href="#2-2-Widget" class="headerlink" title="2.2 Widget"></a>2.2 Widget</h4><h5 id="2-2-1-Widget-概念"><a href="#2-2-1-Widget-概念" class="headerlink" title="2.2.1 Widget 概念"></a>2.2.1 Widget 概念</h5><p>Flutter 中是通过 Widget 嵌套 Widget 的方式来构建 UI 和进行实践处理的，Flutter中万物皆为 Widget</p>
<h5 id="2-2-2-StatelessWidget"><a href="#2-2-2-StatelessWidget" class="headerlink" title="2.2.2 StatelessWidget"></a>2.2.2 StatelessWidget</h5><p>StatelessWidget 用于不需要维护状态的场景，通常在 build 方法中通过嵌套其它 widget 来构建UI</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Echo</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span>  </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> Echo(&#123;</span><br><span class="line">    Key? key,  </span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">this</span>.text,</span><br><span class="line">    <span class="keyword">this</span>.backgroundColor = Colors.grey, <span class="comment">//默认为灰色</span></span><br><span class="line">  &#125;):<span class="keyword">super</span>(key:key);</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> text;</span><br><span class="line">  <span class="keyword">final</span> Color backgroundColor;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Center(</span><br><span class="line">      child: Container(</span><br><span class="line">        color: backgroundColor,</span><br><span class="line">        child: Text(text),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在继承 widget 时，第一个参数通常应该是 key，按照惯例，widget 的属性应尽可能的被声明为 final</p>
<p>使用</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Widget build(BuildContext context) &#123;</span><br><span class="line">  <span class="keyword">return</span> Echo(text: <span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Context</li>
</ul>
<p>build 方法中有一个 context 参数，是BuildContext 类的一个实例，表示当前 widget 在 widget 树中的上下文，每个 widget 都会对应一个 context 对象</p>
<p>提供了从当前 widget 开始向上遍历 widget 树以及按照 widget 类型查找父级 widget 的方法</p>
<p>从子树中获取父级 widget 的示例</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContextRoute</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span>  </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(<span class="string">&quot;Context测试&quot;</span>),</span><br><span class="line">      ),</span><br><span class="line">      body: Container(</span><br><span class="line">        child: Builder(builder: (context) &#123;</span><br><span class="line">          <span class="comment">// 在 widget 树中向上查找最近的父级`Scaffold`  widget </span></span><br><span class="line">          Scaffold scaffold = context.findAncestorWidgetOfExactType&lt;Scaffold&gt;();</span><br><span class="line">          <span class="comment">// 直接返回 AppBar的title， 此处实际上是Text(&quot;Context测试&quot;)</span></span><br><span class="line">          <span class="keyword">return</span> (scaffold.appBar <span class="keyword">as</span> AppBar).title;</span><br><span class="line">        &#125;),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-2-3-StatefulWidget"><a href="#2-2-3-StatefulWidget" class="headerlink" title="2.2.3 StatefulWidget"></a>2.2.3 StatefulWidget</h5><p>继承自 widget 类，重写了 createElement() 方法，添加了一个新的接口 createState()</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">StatefulWidget</span> <span class="keyword">extends</span> <span class="title">Widget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> StatefulWidget(&#123; Key key &#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line">    </span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  StatefulElement createElement() =&gt; StatefulElement(<span class="keyword">this</span>);</span><br><span class="line">    </span><br><span class="line">  <span class="meta">@protected</span></span><br><span class="line">  State createState();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-2-4-State"><a href="#2-2-4-State" class="headerlink" title="2.2.4 State"></a>2.2.4 State</h5><p>一个 StatefulWidget 类会对应一个 State 类，State表示与其对应的 StatefulWidget 要维护的状态</p>
<p>当State被改变时，可以手动调用其 setState() 方法通知Flutter 框架状态发生改变，Flutter 框架在收到消息后，会重新调用其 build 方法重新构建 widget 树，从而达到更新UI的目的</p>
<p>State 中有两个常用属性 widget、context</p>
<h5 id="2-2-5-从-widget-树中获取-State-对象"><a href="#2-2-5-从-widget-树中获取-State-对象" class="headerlink" title="2.2.5 从 widget 树中获取 State 对象"></a>2.2.5 从 widget 树中获取 State 对象</h5><p>context 对象有一个 findAncestorStateOfType() 方法，该方法可以从当前节点沿着 widget 树向上查找指定类型的 StatefulWidget 对应的 state 对象</p>
<p>通过context获取</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 查找父级最近的Scaffold对应的ScaffoldState对象</span></span><br><span class="line">ScaffoldState _state = context.findAncestorStateOfType&lt;ScaffoldState&gt;()!;</span><br><span class="line"><span class="comment">// 打开抽屉菜单</span></span><br><span class="line">_state.openDrawer();</span><br></pre></td></tr></table></figure>

<p>Scaffold 也提供了一个 of 方法</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 直接通过of静态方法来获取ScaffoldState</span></span><br><span class="line">ScaffoldState _state=Scaffold.of(context);</span><br><span class="line"><span class="comment">// 打开抽屉菜单</span></span><br><span class="line">_state.openDrawer();</span><br></pre></td></tr></table></figure>

<p>通过 GlobalKey</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="comment">//定义一个globalKey, 由于GlobalKey要保持全局唯一性，我们使用静态变量存储</span></span><br><span class="line"><span class="keyword">static</span> GlobalKey&lt;ScaffoldState&gt; _globalKey= GlobalKey();</span><br><span class="line">...</span><br><span class="line">Scaffold(</span><br><span class="line">    key: _globalKey , <span class="comment">//设置key</span></span><br><span class="line">    ...  </span><br><span class="line">)</span><br><span class="line">  </span><br><span class="line"><span class="comment">//通过GlobalKey来获取State对象</span></span><br><span class="line">_globalKey.currentState.openDrawer()</span><br></pre></td></tr></table></figure>



<h4 id="2-3-状态管理"><a href="#2-3-状态管理" class="headerlink" title="2.3 状态管理"></a>2.3 状态管理</h4><h5 id="2-3-1-Widget-管理自身状态"><a href="#2-3-1-Widget-管理自身状态" class="headerlink" title="2.3.1 Widget 管理自身状态"></a>2.3.1 Widget 管理自身状态</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  runApp(MaterialApp(home: FormTestRoute()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FormTestRoute</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _FormTestRouteState createState() =&gt; _FormTestRouteState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_FormTestRouteState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">FormTestRoute</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(<span class="string">&#x27;标题&#x27;</span>),</span><br><span class="line">      ),</span><br><span class="line">      body: TapboxA(),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>_TapboxAState 类：</p>
<p>管理 TapboxA 的状态，定义 _active：确定盒子的当前颜色的布尔值</p>
<p>定义 _handleTap() 函数，在点击盒子时更新 _active 并调用 setState() 更新UI</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TapboxA</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> TapboxA(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _TapboxAState createState() =&gt; _TapboxAState();</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_TapboxAState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">TapboxA</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">bool</span> _active = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _handleTap() &#123;</span><br><span class="line">    setState(() &#123;</span><br><span class="line">      _active = !_active;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> GestureDetector(</span><br><span class="line">      onTap: _handleTap,</span><br><span class="line">      child: Container(</span><br><span class="line">        child: Text(</span><br><span class="line">          _active ? <span class="string">&quot;Active&quot;</span> : <span class="string">&quot;Inactive&quot;</span>,</span><br><span class="line">          style: TextStyle(fontSize: <span class="number">32.0</span>, color: Colors.red),</span><br><span class="line">        ),</span><br><span class="line">        width: <span class="number">200</span>,</span><br><span class="line">        height: <span class="number">200</span>,</span><br><span class="line">        decoration: BoxDecoration(</span><br><span class="line">          color: _active ? Colors.lightGreen[<span class="number">700</span>] : Colors.grey[<span class="number">600</span>],</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-3-2-父-Widget-管理子-Widget-状态"><a href="#2-3-2-父-Widget-管理子-Widget-状态" class="headerlink" title="2.3.2 父 Widget 管理子 Widget 状态"></a>2.3.2 父 Widget 管理子 Widget 状态</h5><p>对于父 Widget 来说，管理状态并告诉其子 Widget 何时更新通常是比较好的方式，例如，IconButton 是一个图标按钮，但它是个无状态 Widget，因为我们认为父Widget需要知道该按钮是否被点击来采取相应处理</p>
<p>TapboxB通过回调将其状态导出到其父组件，状态由父组件管理，因此父组件未 StatefulWidget，TapboxB不管理任何状态，为 StatelessWidget</p>
<p>ParentWidget</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParentWidget</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ParentWidget(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _ParentWidgetState createState() =&gt; _ParentWidgetState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_ParentWidgetState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">ParentWidget</span>&gt; </span>&#123;</span><br><span class="line">  <span class="built_in">bool</span> _active = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">void</span> _handleTapboxChanged(<span class="built_in">bool</span> newValue) &#123;</span><br><span class="line">    setState(() &#123;</span><br><span class="line">      _active = newValue;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Container(</span><br><span class="line">      child: TapBoxB(</span><br><span class="line">          active: _active,</span><br><span class="line">          onChanged: _handleTapboxChanged,</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>TapBoxB</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TapBoxB</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> TapBoxB(&#123;</span><br><span class="line">    Key? key,</span><br><span class="line">    <span class="keyword">this</span>.active: <span class="keyword">false</span>,</span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">this</span>.onChanged</span><br><span class="line">  &#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">bool</span> active;</span><br><span class="line">  <span class="keyword">final</span> ValueChanged&lt;<span class="built_in">bool</span>&gt; onChanged;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _handleTap() &#123;</span><br><span class="line">    onChanged(!active);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> GestureDetector(</span><br><span class="line">      onTap: _handleTap,</span><br><span class="line">      child: Container(</span><br><span class="line">        child: Center(</span><br><span class="line">          child: Text(</span><br><span class="line">              active ? <span class="string">&quot;Active&quot;</span> : <span class="string">&quot;Inactive&quot;</span>,</span><br><span class="line">              style: TextStyle(fontSize: <span class="number">32</span>, color: Colors.red),</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">        width: <span class="number">200</span>,</span><br><span class="line">        height: <span class="number">200</span>,</span><br><span class="line">        decoration: BoxDecoration(</span><br><span class="line">          color: active ? Colors.lightGreen[<span class="number">700</span>] : Colors.grey[<span class="number">600</span>],</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-3-3-混合状态管理"><a href="#2-3-3-混合状态管理" class="headerlink" title="2.3.3 混合状态管理"></a>2.3.3 混合状态管理</h5><p>组件自身管理一些内部状态，父组件管理一些其它外部状态</p>
<h4 id="2-4-路由管理"><a href="#2-4-路由管理" class="headerlink" title="2.4 路由管理"></a>2.4 路由管理</h4><h5 id="2-4-1-示例"><a href="#2-4-1-示例" class="headerlink" title="2.4.1 示例"></a>2.4.1 示例</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestRoute</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> TestRoute(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(<span class="string">&#x27;标题&#x27;</span>),</span><br><span class="line">      ),</span><br><span class="line">      body: Container(</span><br><span class="line">        child: TextButton(</span><br><span class="line">            onPressed: ()&#123;</span><br><span class="line">              Navigator.push(</span><br><span class="line">                context,</span><br><span class="line">                MaterialPageRoute(builder: (context)&#123;</span><br><span class="line">                  <span class="keyword">return</span> NewRoute();</span><br><span class="line">                &#125;),</span><br><span class="line">              );</span><br><span class="line">            &#125;,</span><br><span class="line">            child: Text(<span class="string">&quot;open new router&quot;</span>)</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NewRoute</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> NewRoute(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(<span class="string">&#x27;New route&#x27;</span>),</span><br><span class="line">      ),</span><br><span class="line">      body: Center(</span><br><span class="line">        child: Text(<span class="string">&#x27;This is new route&#x27;</span>),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-4-2-MaterialPageRoute"><a href="#2-4-2-MaterialPageRoute" class="headerlink" title="2.4.2 MaterialPageRoute"></a>2.4.2 MaterialPageRoute</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"> MaterialPageRoute(&#123;</span><br><span class="line">  WidgetBuilder builder,</span><br><span class="line">  RouteSettings settings,</span><br><span class="line">  <span class="built_in">bool</span> maintainState = <span class="keyword">true</span>,</span><br><span class="line">  <span class="built_in">bool</span> fullscreenDialog = <span class="keyword">false</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>builder：是一个 WidgetBuilder 类型的回调函数，作用是构建路由页面的具体内容，返回一个 widget。通常要实现此回调，返回新路由的实例</p>
<p>settings：路由配置信息，如路由名称、是否初始路由（首页）</p>
<p>maintainState：默认情况下，当入栈一个新路由时，原来的路由仍然会被保存在内存中，如果想在路由没用的时候释放其所占用的所有资源，可以设置 maintainState 为 false</p>
<p>fullscreenDialog：新路由页面是否是一个全屏的模态对话框，iOS中为true，则新页面将会从屏幕底部滑入</p>
<h5 id="2-4-3-Navigtior"><a href="#2-4-3-Navigtior" class="headerlink" title="2.4.3 Navigtior"></a>2.4.3 Navigtior</h5><p>路由管理组件，提供打开和退出路由页面方法，通过一个栈来管理活动路由集合，当前页面就是栈顶的路由，常用两个方法 push、pop</p>
<h5 id="2-4-4-路由器传值"><a href="#2-4-4-路由器传值" class="headerlink" title="2.4.4 路由器传值"></a>2.4.4 路由器传值</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestRoute</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> TestRoute(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(<span class="string">&#x27;标题&#x27;</span>),</span><br><span class="line">      ),</span><br><span class="line">      body: Container(</span><br><span class="line">        child: TextButton(</span><br><span class="line">            onPressed: () <span class="keyword">async</span> &#123;<span class="comment">//打开下一个页面，并等待返回结果</span></span><br><span class="line">              <span class="keyword">var</span> result = <span class="keyword">await</span> Navigator.push(</span><br><span class="line">                context,</span><br><span class="line">                MaterialPageRoute(</span><br><span class="line">                    builder: (context) &#123;</span><br><span class="line">                      <span class="keyword">return</span> NewRoute(</span><br><span class="line">                          text: <span class="string">&#x27;提示123&#x27;</span>,</span><br><span class="line">                      );</span><br><span class="line">                    &#125;</span><br><span class="line">                ),</span><br><span class="line">              );</span><br><span class="line">              <span class="built_in">print</span>(<span class="string">&#x27;路由返回值：<span class="subst">$result</span>&#x27;</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">            child: Text(<span class="string">&quot;open new router&quot;</span>)</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NewRoute</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> NewRoute(&#123;</span><br><span class="line">    Key? key,</span><br><span class="line">    <span class="meta">@required</span> <span class="keyword">this</span>.text, <span class="comment">//接收一个 text 参数</span></span><br><span class="line">  &#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String?</span> text;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(<span class="string">&#x27;New route&#x27;</span>),</span><br><span class="line">      ),</span><br><span class="line">      body: Padding(</span><br><span class="line">          padding: EdgeInsets.all(<span class="number">18</span>),</span><br><span class="line">          child: Center(</span><br><span class="line">            child: Column(</span><br><span class="line">              children: [</span><br><span class="line">                Text(text!),</span><br><span class="line">                ElevatedButton(</span><br><span class="line">                    onPressed: ()&#123;</span><br><span class="line">                      Navigator.pop(context, <span class="string">&#x27;我是返回值1&#x27;</span>);<span class="comment">//传递返回值</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    child: Text(<span class="string">&#x27;返回&#x27;</span>)</span><br><span class="line">                ),</span><br><span class="line">              ],</span><br><span class="line">            ),</span><br><span class="line">          ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="2-4-5-命名路由"><a href="#2-4-5-命名路由" class="headerlink" title="2.4.5 命名路由"></a>2.4.5 命名路由</h5><ul>
<li>路由表</li>
</ul>
<p>先注册一个路由表，key 是路由名字，value 是个 builder 回调函数</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Map</span>&lt;<span class="built_in">String</span>, WidgetBuilder&gt; routes;</span><br></pre></td></tr></table></figure>

<p>打开一个新路由时，根据路由名字在路由表中查找对应的 WidgetBuilder</p>
<ul>
<li>注册路由表</li>
</ul>
<p>找到 MaterialApp，添加 routes 属性</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">runApp(MaterialApp(</span><br><span class="line">    home: TestRoute(),</span><br><span class="line">    routes: &#123;</span><br><span class="line">      <span class="string">&#x27;new_page&#x27;</span>: (context) =&gt; NewRoute(text: <span class="string">&#x27;提示123&#x27;</span>),</span><br><span class="line">      <span class="string">&#x27;/&#x27;</span>: (context) =&gt; TestRoute(),</span><br><span class="line">      <span class="comment">//其它路由注册信息</span></span><br><span class="line">    &#125;,</span><br><span class="line">));</span><br></pre></td></tr></table></figure>

<ul>
<li>通过路由名打开新路由</li>
</ul>
<p>使用 Navigator 的 pushNamed 方法</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">onPressed: () &#123;</span><br><span class="line">  Navigator.pushNamed(context, <span class="string">&quot;new_page&quot;</span>); </span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<ul>
<li>命名路由参数传递</li>
</ul>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> main() &#123;</span><br><span class="line">  runApp(MaterialApp(</span><br><span class="line">      home: TestRoute(),</span><br><span class="line">      routes: &#123;</span><br><span class="line">        <span class="string">&#x27;new_page&#x27;</span>: (context) &#123;</span><br><span class="line">          <span class="keyword">return</span> NewRoute(text: ModalRoute.of(context)?.settings.arguments <span class="keyword">as</span> <span class="built_in">String</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">//其它路由注册信息</span></span><br><span class="line">      &#125;,</span><br><span class="line">  ));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestRoute</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> TestRoute(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(<span class="string">&#x27;标题&#x27;</span>),</span><br><span class="line">      ),</span><br><span class="line">      body: Container(</span><br><span class="line">        child: TextButton(</span><br><span class="line">            onPressed: () <span class="keyword">async</span> &#123;</span><br><span class="line">              <span class="comment">//带参数跳转</span></span><br><span class="line">              <span class="keyword">var</span> result = <span class="keyword">await</span> Navigator.of(context).pushNamed(<span class="string">&#x27;new_page&#x27;</span>, arguments: <span class="string">&#x27;提示123&#x27;</span>);</span><br><span class="line">              <span class="built_in">print</span>(<span class="string">&#x27;路由返回值：<span class="subst">$result</span>&#x27;</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">            child: Text(<span class="string">&quot;open new router&quot;</span>)</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NewRoute</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> NewRoute(&#123;</span><br><span class="line">    Key? key,</span><br><span class="line">    <span class="meta">@required</span> <span class="keyword">this</span>.text, <span class="comment">//接收一个 text 参数</span></span><br><span class="line">  &#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String?</span> text;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="comment">//获取路由参数</span></span><br><span class="line">    <span class="keyword">var</span> args = ModalRoute.of(context)?.settings.arguments <span class="keyword">as</span> <span class="built_in">String</span>;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(<span class="string">&#x27;New route&#x27;</span>),</span><br><span class="line">      ),</span><br><span class="line">      body: Padding(</span><br><span class="line">          padding: EdgeInsets.all(<span class="number">18</span>),</span><br><span class="line">          child: Center(</span><br><span class="line">            child: Column(</span><br><span class="line">              children: [</span><br><span class="line">                Text(args),</span><br><span class="line">                ElevatedButton(</span><br><span class="line">                    onPressed: ()&#123;</span><br><span class="line">                      Navigator.pop(context, <span class="string">&#x27;我是返回值1&#x27;</span>);</span><br><span class="line">                    &#125;,</span><br><span class="line">                    child: Text(<span class="string">&#x27;返回&#x27;</span>)</span><br><span class="line">                ),</span><br><span class="line">              ],</span><br><span class="line">            ),</span><br><span class="line">          ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="2-4-6-路由生成钩子"><a href="#2-4-6-路由生成钩子" class="headerlink" title="2.4.6 路由生成钩子"></a>2.4.6 路由生成钩子</h5><p>MaterialApp 有一个 onGenerateRoute 属性，打开命名路由时可能被调用</p>
<p>如果指定的路由名在路由表中已注册，则会调用路由表中的 builder 函数生成路由组件</p>
<p>如果没注册，调用 onGenerateRoute 来生成路由</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">MaterialApp(</span><br><span class="line">	onGenerateRoute: (RouteSettings settings) &#123;</span><br><span class="line">    <span class="keyword">return</span> MaterialPageRoute(builder: (context)&#123;</span><br><span class="line">      <span class="built_in">String</span> routeName = settings.name <span class="keyword">as</span> <span class="built_in">String</span>;</span><br><span class="line">      <span class="comment">// 如果访问的路由页需要登录，但当前未登录，则直接返回登录页路由，</span></span><br><span class="line">      <span class="comment">// 引导用户登录；其它情况则正常打开路由。</span></span><br><span class="line">      <span class="keyword">return</span> NewRoute(text: ModalRoute.of(context)?.settings.arguments <span class="keyword">as</span> <span class="built_in">String</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>有了 onGenerateRoute 回调，实现控制权限功能就可以放弃使用路由表，提供一个 onGenerateRoute 回调，在回调中进行统一的权限控制</p>
<h4 id="2-5-包管理"><a href="#2-5-包管理" class="headerlink" title="2.5 包管理"></a>2.5 包管理</h4><p>使用配置文件 pubspec.yaml 来管理第三方依赖包</p>
<p>dependencies：应用或包依赖的其它包或插件</p>
<p>dev_dependencies：开发环境依赖的工具包</p>
<p>区别：</p>
<p>前者的依赖包将作为APP的源码的一部分参与编译，生成最终安装包</p>
<p>后者的依赖包只作为开发阶段的一些工具包，主要用于帮助提高开发、测试效率，如flutter的自动化测试包</p>
<ul>
<li>Pub 仓库</li>
</ul>
<p>Pub（<a href="https://pub.dev/%EF%BC%89%E6%98%AF">https://pub.dev/）是</a> Google 官方 Dart packages 仓库，查找需要的包和插件</p>
<ul>
<li>示例</li>
</ul>
<p>搜索 english_words，添加 english_words 到依赖项列表</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dependencies:</span><br><span class="line">  flutter:</span><br><span class="line">    sdk: flutter</span><br><span class="line">  english_words: ^4.0.0</span><br></pre></td></tr></table></figure>

<p>单击 pubspec.yami 右上角 Pub get，或者控制台定位到当前工程目录 <code>flutter packages get</code> 命令下载依赖包</p>
<ul>
<li>依赖本地包</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dependencies:</span><br><span class="line">	pkg1:</span><br><span class="line">        path: ..&#x2F;..&#x2F;code&#x2F;pkg1</span><br></pre></td></tr></table></figure>

<ul>
<li>依赖 Git</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dependencies:</span><br><span class="line">  pkg1:</span><br><span class="line">    git:</span><br><span class="line">      url: git:&#x2F;&#x2F;github.com&#x2F;xxx&#x2F;pkg1.git</span><br></pre></td></tr></table></figure>

<p>上面是包位于 Git 存储库的根目录中，如果不是可以使用 path 参数指定相对位置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dependencies:</span><br><span class="line">  package1:</span><br><span class="line">    git:</span><br><span class="line">      url: git:&#x2F;&#x2F;github.com&#x2F;flutter&#x2F;packages.git</span><br><span class="line">      path: packages&#x2F;package1        </span><br></pre></td></tr></table></figure>

<h4 id="2-6-资源管理"><a href="#2-6-资源管理" class="headerlink" title="2.6 资源管理"></a>2.6 资源管理</h4><ul>
<li>指定 assets</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">flutter:</span><br><span class="line">  assets:</span><br><span class="line">    - assets&#x2F;my_icon.png</span><br><span class="line">    - assets&#x2F;background.png</span><br></pre></td></tr></table></figure>

<ul>
<li>加载图片</li>
</ul>
<p>Flutter 也可以为当前设备加载适合其分辨率的图像</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">…&#x2F;image.png</span><br><span class="line">…&#x2F;Mx&#x2F;image.png</span><br><span class="line">…&#x2F;Nx&#x2F;image.png  &#x2F;&#x2F;M N 是数字标识</span><br><span class="line"></span><br><span class="line">…&#x2F;my_icon.png</span><br><span class="line">…&#x2F;2.0x&#x2F;my_icon.png</span><br><span class="line">…&#x2F;3.0x&#x2F;my_icon.png</span><br></pre></td></tr></table></figure>

<p>主资源默认使用1.0倍的分辨率图片，设备像素比率为1.8的设备上 …/2.0x/my_icon.png 将被选择。对于2.7的设备像素比率 …/3.0x/my_icon.png 将被选择</p>
<p>加载图片，可以使用 AssetImage </p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">AssetImage(<span class="string">&#x27;graphics/background.png&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>依赖包中的资源图片</li>
</ul>
<p>要加载依赖包中的图像，必须给 AssetImage 提供 package 参数</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">AssetImage(<span class="string">&#x27;icons/heart.png&#x27;</span>, package: <span class="string">&#x27;my_icons&#x27;</span>)</span><br><span class="line"><span class="comment">//或者</span></span><br><span class="line">Image.asset(<span class="string">&#x27;icons/heart.png&#x27;</span>, package: <span class="string">&#x27;my_icons&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="2-7-调试-Flutter-应用"><a href="#2-7-调试-Flutter-应用" class="headerlink" title="2.7 调试 Flutter 应用"></a>2.7 调试 Flutter 应用</h4><h4 id="2-8-Flutter-异常捕获"><a href="#2-8-Flutter-异常捕获" class="headerlink" title="2.8 Flutter 异常捕获"></a>2.8 Flutter 异常捕获</h4><p><a href="https://book.flutterchina.club/preface.html">Flutter实战 第二版</a></p>
<p><a href="https://flutterchina.club/widgets/material/">Flutter 中文网</a></p>
<p><a href="https://flutter.cn/docs/cookbook">Flutter.cn</a></p>
]]></content>
  </entry>
  <entry>
    <title>《Flutter实战第二版》五：容器类组件</title>
    <url>/2022/01/18/%E3%80%8AFlutter%E5%AE%9E%E6%88%98%E7%AC%AC%E4%BA%8C%E7%89%88%E3%80%8B%E4%BA%94%EF%BC%9A%E5%AE%B9%E5%99%A8%E7%B1%BB%E7%BB%84%E4%BB%B6/</url>
    <content><![CDATA[<h3 id="5-容器类组件"><a href="#5-容器类组件" class="headerlink" title="5 容器类组件"></a>5 容器类组件</h3><p>布局类组件一般都需要接收一个 widget 数组（children），容器类组件一般只需要接收一个子 widget（child）</p>
<p>布局类 widget 是按照一定的排列方式来对其子 widget 进行排列；容器类widget一般只是包装其子 widget，对其添加一些修饰（补白或背景色等）、变换（旋转裁剪等）、或限制（大小等）</p>
<h4 id="5-1-Padding"><a href="#5-1-Padding" class="headerlink" title="5.1 Padding"></a>5.1 Padding</h4><p>可以给子节点添加填充（留白），和间距效果类似</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Padding(&#123;</span><br><span class="line">  ...</span><br><span class="line">  EdgeInsetsGeometry padding,</span><br><span class="line">  Widget child,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>EdgeInsetsGeometry 是一个抽象类，开发中一般使用 EdgeInsets 类，它是 EdgeInsetsGeometry 的一个子类，定义了一些设置填充的便捷方法</p>
<ul>
<li>EdgeInsets</li>
</ul>
<p>EdgeInsets 的便捷方法：</p>
<p><code>fromLTRB(double left, double top, double right, double bottom)</code> 分别指定四个方向的填充</p>
<p><code>all(double value)</code> 所有方向均使用相同数值填充</p>
<p><code>only(&#123;left, top, right ,bottom &#125;)</code> 设置某个方向的填充（可以同时指多个方向）</p>
<p><code>symmetric(&#123; vertical, horizontal &#125;)</code> 用于设置对称方向的填充，vertical 指 top 和bottom，horizontal 指 left 和 right</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PaddingTestRoute</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Padding(</span><br><span class="line">      <span class="comment">//上下左右各添加16像素补白</span></span><br><span class="line">      padding: EdgeInsets.all(<span class="number">16.0</span>),</span><br><span class="line">      child: Column(</span><br><span class="line">        <span class="comment">//显式指定对齐方式为左对齐，排除对齐干扰</span></span><br><span class="line">        crossAxisAlignment: CrossAxisAlignment.start,</span><br><span class="line">        children: &lt;Widget&gt;[</span><br><span class="line">          Padding(</span><br><span class="line">            <span class="comment">//左边添加8像素补白</span></span><br><span class="line">            padding: <span class="keyword">const</span> EdgeInsets.only(left: <span class="number">8.0</span>),</span><br><span class="line">            child: Text(<span class="string">&quot;Hello world&quot;</span>),</span><br><span class="line">          ),</span><br><span class="line">          Padding(</span><br><span class="line">            <span class="comment">//垂直方向上下各添加8像素补白</span></span><br><span class="line">            padding: <span class="keyword">const</span> EdgeInsets.symmetric(vertical: <span class="number">8.0</span>),</span><br><span class="line">            child: Text(<span class="string">&quot;I am Jack&quot;</span>),</span><br><span class="line">          ),</span><br><span class="line">          Padding(</span><br><span class="line">            <span class="comment">// 分别指定四个方向的补白</span></span><br><span class="line">            padding: <span class="keyword">const</span> EdgeInsets.fromLTRB(<span class="number">20.0</span>,<span class="number">.0</span>,<span class="number">20.0</span>,<span class="number">20.0</span>),</span><br><span class="line">            child: Text(<span class="string">&quot;Your friend&quot;</span>),</span><br><span class="line">          )</span><br><span class="line">        ],</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》五：容器类组件/WeChat6661e3955fcbc5012a3fbf2acb8b2009.png" alt="WeChat6661e3955fcbc5012a3fbf2acb8b2009" style="zoom:80%;" />

<h4 id="5-2-尺寸限制类容器"><a href="#5-2-尺寸限制类容器" class="headerlink" title="5.2 尺寸限制类容器"></a>5.2 尺寸限制类容器</h4><p>尺寸限制类容器用于限制容器大小，ConstrainedBox<code>、</code>SizedBox<code>、</code>UnconstrainedBox<code>、</code>AspectRatio 等</p>
<p>尺寸限制类容器涉及到Flutter 布局流程 ，确定子组件大小的步骤为：<br>上层组件向下层组件传递约束条件<br>下层组件确定自己的大小，然后告诉上层组件，注意下层组件的大小必须符合父组件的约束</p>
<h5 id="5-2-1-ConstrainedBox"><a href="#5-2-1-ConstrainedBox" class="headerlink" title="5.2.1 ConstrainedBox"></a>5.2.1 ConstrainedBox</h5><p>ConstrainedBox 用于对子组件添加额外约束</p>
<p>。。看 四：布局类组件 4.2 布局原理与约束</p>
<h4 id="5-3-装饰容器-DecoratedBox"><a href="#5-3-装饰容器-DecoratedBox" class="headerlink" title="5.3 装饰容器 DecoratedBox"></a>5.3 装饰容器 DecoratedBox</h4><p>DecoratedBox 可以在其子组件绘制前或后绘制一些装饰，如背景、边框、渐变等</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> DecoratedBox(&#123;</span><br><span class="line">  Decoration decoration,</span><br><span class="line">  DecorationPosition position = DecorationPosition.background,</span><br><span class="line">  Widget? child</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>decoration 代表将要绘制的装饰</p>
<p>position 决定哪里绘制，接收 DecorationPositon 的枚举，background 在子组件之后绘制，即背景，foreground 在子组件之上绘制，即前景</p>
<ul>
<li>BoxDecoration</li>
</ul>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">BoxDecoration(&#123;</span><br><span class="line">  Color color, <span class="comment">//颜色</span></span><br><span class="line">  DecorationImage image,<span class="comment">//图片</span></span><br><span class="line">  BoxBorder border, <span class="comment">//边框</span></span><br><span class="line">  BorderRadiusGeometry borderRadius, <span class="comment">//圆角</span></span><br><span class="line">  <span class="built_in">List</span>&lt;BoxShadow&gt; boxShadow, <span class="comment">//阴影,可以指定多个</span></span><br><span class="line">  Gradient gradient, <span class="comment">//渐变</span></span><br><span class="line">  BlendMode backgroundBlendMode, <span class="comment">//背景混合模式</span></span><br><span class="line">  BoxShape shape = BoxShape.rectangle, <span class="comment">//形状</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>绘制一个带阴影的背景色渐变的按钮</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">DecoratedBox(</span><br><span class="line">   decoration: BoxDecoration(</span><br><span class="line">     gradient: LinearGradient(colors:[Colors.red,Colors.orange.shade700]), <span class="comment">//背景渐变</span></span><br><span class="line">     borderRadius: BorderRadius.circular(<span class="number">3.0</span>), <span class="comment">//3像素圆角</span></span><br><span class="line">     boxShadow: [ <span class="comment">//阴影</span></span><br><span class="line">       BoxShadow(</span><br><span class="line">         color:Colors.black54,</span><br><span class="line">         offset: Offset(<span class="number">2.0</span>,<span class="number">2.0</span>),</span><br><span class="line">         blurRadius: <span class="number">4.0</span></span><br><span class="line">       )</span><br><span class="line">     ]</span><br><span class="line">   ),</span><br><span class="line">  child: Padding(</span><br><span class="line">    padding: EdgeInsets.symmetric(horizontal: <span class="number">80.0</span>, vertical: <span class="number">18.0</span>),</span><br><span class="line">    child: Text(<span class="string">&quot;Login&quot;</span>, style: TextStyle(color: Colors.white),),</span><br><span class="line">  )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><img src="/%E3%80%8AFlutter%E5%AE%9E%E6%88%98%E7%AC%AC%E4%BA%8C%E7%89%88%E3%80%8B%E4%BA%94%EF%BC%9A%E5%AE%B9%E5%99%A8%E7%B1%BB%E7%BB%84%E4%BB%B6/WeChatb229d2ef3c49cb4ea45184fc4edabea2.png" alt="WeChatb229d2ef3c49cb4ea45184fc4edabea2"></p>
<p>上面用到 LinearGradient 类，是用于定义线性渐变的类，Flutter 还提供了其它渐变配置 RadialGradient、SweepGradient</p>
<h4 id="5-4-变换"><a href="#5-4-变换" class="headerlink" title="5.4 变换"></a>5.4 变换</h4><p>Matrix4 是一个 4D 矩阵</p>
<ul>
<li>平移</li>
</ul>
<p>Transform.translate  接收一个 offset 参数，可以在绘制是沿 x y 轴对子组件平移指定距离</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">DecoratedBox(</span><br><span class="line">  decoration:BoxDecoration(color: Colors.red),</span><br><span class="line">  <span class="comment">//默认原点为左上角，左移20像素，向上平移5像素  </span></span><br><span class="line">  child: Transform.translate(</span><br><span class="line">    offset: Offset(<span class="number">-20.0</span>, <span class="number">-5.0</span>),</span><br><span class="line">    child: Text(<span class="string">&quot;Hello world&quot;</span>),</span><br><span class="line">  ),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><img src="/%E3%80%8AFlutter%E5%AE%9E%E6%88%98%E7%AC%AC%E4%BA%8C%E7%89%88%E3%80%8B%E4%BA%94%EF%BC%9A%E5%AE%B9%E5%99%A8%E7%B1%BB%E7%BB%84%E4%BB%B6/WeChat1771bb23256be799e6f11bbc2a98325a.png" alt="WeChat1771bb23256be799e6f11bbc2a98325a"></p>
<ul>
<li>旋转</li>
</ul>
<p>Transform.rotate </p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;dart:math&#x27;</span> <span class="keyword">as</span> math;</span><br><span class="line">DecoratedBox(</span><br><span class="line">  decoration:BoxDecoration(color: Colors.red),</span><br><span class="line">  child: Transform.rotate(</span><br><span class="line">    <span class="comment">//旋转90度</span></span><br><span class="line">    angle:math.pi/<span class="number">2</span> ,</span><br><span class="line">    child: Text(<span class="string">&quot;Hello world&quot;</span>),</span><br><span class="line">  ),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>缩放</li>
</ul>
<p>Transform.scale</p>
<ul>
<li>RotatedBox</li>
</ul>
<p>Transform 的变换是应用在绘制阶段，不是应用在布局（layout）阶段，无论对子组件应用何种变换，其占用空间大小和在屏幕上的位置都是固定不变的</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Row(</span><br><span class="line">  mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">  children: &lt;Widget&gt;[</span><br><span class="line">    DecoratedBox(</span><br><span class="line">      decoration:BoxDecoration(color: Colors.red),</span><br><span class="line">      child: Transform.scale(scale: <span class="number">1.5</span>,</span><br><span class="line">          child: Text(<span class="string">&quot;Hello world&quot;</span>)</span><br><span class="line">      )</span><br><span class="line">    ),</span><br><span class="line">    Text(<span class="string">&quot;你好&quot;</span>, style: TextStyle(color: Colors.green, fontSize: <span class="number">18.0</span>),)</span><br><span class="line">  ],</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><img src="/%E3%80%8AFlutter%E5%AE%9E%E6%88%98%E7%AC%AC%E4%BA%8C%E7%89%88%E3%80%8B%E4%BA%94%EF%BC%9A%E5%AE%B9%E5%99%A8%E7%B1%BB%E7%BB%84%E4%BB%B6/WeChat7c79d01b2fac91e32fdb2602d6be1ee1.png" alt="WeChat7c79d01b2fac91e32fdb2602d6be1ee1"></p>
<p>第一个 Text 放大后，绘制时会放大，但占用空间还是红色部分</p>
<p>RotatedBox 的变换是在 layout 阶段，会影响子组件位置和大小</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Row(</span><br><span class="line">  mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">  children: &lt;Widget&gt;[</span><br><span class="line">    DecoratedBox(</span><br><span class="line">      decoration: BoxDecoration(color: Colors.red),</span><br><span class="line">      <span class="comment">//将Transform.rotate换成RotatedBox  </span></span><br><span class="line">      child: RotatedBox(</span><br><span class="line">        quarterTurns: <span class="number">1</span>, <span class="comment">//旋转90度(1/4圈)</span></span><br><span class="line">        child: Text(<span class="string">&quot;Hello world&quot;</span>),</span><br><span class="line">      ),</span><br><span class="line">    ),</span><br><span class="line">    Text(<span class="string">&quot;你好&quot;</span>, style: TextStyle(color: Colors.green, fontSize: <span class="number">18.0</span>),)</span><br><span class="line">  ],</span><br><span class="line">),</span><br></pre></td></tr></table></figure>

<p><img src="/%E3%80%8AFlutter%E5%AE%9E%E6%88%98%E7%AC%AC%E4%BA%8C%E7%89%88%E3%80%8B%E4%BA%94%EF%BC%9A%E5%AE%B9%E5%99%A8%E7%B1%BB%E7%BB%84%E4%BB%B6/WeChatf5d0a9a9d12548219cbe16cae734cd85.png" alt="WeChatf5d0a9a9d12548219cbe16cae734cd85"></p>
<h4 id="5-5-Container"><a href="#5-5-Container" class="headerlink" title="5.5 Container"></a>5.5 Container</h4><p>Container 是一个组合类容器，<code>DecoratedBox</code>、<code>ConstrainedBox、Transform</code>、<code>Padding</code>、<code>Align</code> 等组件组合的一个多功能容器</p>
<p>只需要通过一个 Container 组件可以实现同时需要装饰、变换、限制的场景</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Container(&#123;</span><br><span class="line">  <span class="keyword">this</span>.alignment,</span><br><span class="line">  <span class="keyword">this</span>.padding, <span class="comment">//容器内补白，属于decoration的装饰范围</span></span><br><span class="line">  Color color, <span class="comment">// 背景色</span></span><br><span class="line">  Decoration decoration, <span class="comment">// 背景装饰</span></span><br><span class="line">  Decoration foregroundDecoration, <span class="comment">//前景装饰</span></span><br><span class="line">  <span class="built_in">double</span> width,<span class="comment">//容器的宽度</span></span><br><span class="line">  <span class="built_in">double</span> height, <span class="comment">//容器的高度</span></span><br><span class="line">  BoxConstraints constraints, <span class="comment">//容器大小的限制条件</span></span><br><span class="line">  <span class="keyword">this</span>.margin,<span class="comment">//容器外补白，不属于decoration的装饰范围</span></span><br><span class="line">  <span class="keyword">this</span>.transform, <span class="comment">//变换</span></span><br><span class="line">  <span class="keyword">this</span>.child,</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>容器大小可以通过 width、height 属性来指定，也可以通过 constraints 来指定，如果同时存在，width、height 优先</p>
<p>color 和 decoration 是互斥的</p>
<p>例子</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Container(</span><br><span class="line">  margin: EdgeInsets.only(top: <span class="number">50.0</span>, left: <span class="number">120.0</span>),</span><br><span class="line">  constraints: BoxConstraints.tightFor(width: <span class="number">200.0</span>, height: <span class="number">150.0</span>),<span class="comment">//卡片大小</span></span><br><span class="line">  decoration: BoxDecoration(  <span class="comment">//背景装饰</span></span><br><span class="line">    gradient: RadialGradient( <span class="comment">//背景径向渐变</span></span><br><span class="line">      colors: [Colors.red, Colors.orange],</span><br><span class="line">      center: Alignment.topLeft,</span><br><span class="line">      radius: <span class="number">.98</span>,</span><br><span class="line">    ),</span><br><span class="line">    boxShadow: [</span><br><span class="line">      <span class="comment">//卡片阴影</span></span><br><span class="line">      BoxShadow(</span><br><span class="line">        color: Colors.black54,</span><br><span class="line">        offset: Offset(<span class="number">2.0</span>, <span class="number">2.0</span>),</span><br><span class="line">        blurRadius: <span class="number">4.0</span>,</span><br><span class="line">      )</span><br><span class="line">    ],</span><br><span class="line">  ),</span><br><span class="line">  transform: Matrix4.rotationZ(<span class="number">.2</span>),<span class="comment">//卡片倾斜变换</span></span><br><span class="line">  alignment: Alignment.center, <span class="comment">//卡片内文字居中</span></span><br><span class="line">  child: Text(</span><br><span class="line">    <span class="comment">//卡片文字</span></span><br><span class="line">    <span class="string">&quot;5.20&quot;</span>, style: TextStyle(color: Colors.white, fontSize: <span class="number">40.0</span>),</span><br><span class="line">  ),</span><br><span class="line"> )</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》五：容器类组件/WeChat351cd0ae2781d4d6e03e8d598ef69023.png" alt="WeChat351cd0ae2781d4d6e03e8d598ef69023" style="zoom:80%;" />

<ul>
<li>Padding 和 Margin</li>
</ul>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Container(</span><br><span class="line">  margin: EdgeInsets.all(<span class="number">20.0</span>), <span class="comment">//容器外补白</span></span><br><span class="line">  color: Colors.orange,</span><br><span class="line">  child: Text(<span class="string">&quot;Hello world!&quot;</span>),</span><br><span class="line">),</span><br><span class="line">Container(</span><br><span class="line">  padding: EdgeInsets.all(<span class="number">20.0</span>), <span class="comment">//容器内补白</span></span><br><span class="line">  color: Colors.orange,</span><br><span class="line">  child: Text(<span class="string">&quot;Hello world!&quot;</span>),</span><br><span class="line">),</span><br></pre></td></tr></table></figure>

<p><img src="/%E3%80%8AFlutter%E5%AE%9E%E6%88%98%E7%AC%AC%E4%BA%8C%E7%89%88%E3%80%8B%E4%BA%94%EF%BC%9A%E5%AE%B9%E5%99%A8%E7%B1%BB%E7%BB%84%E4%BB%B6/WeChat48a70d601784f808caac89583b0d4d09.png" alt="WeChat48a70d601784f808caac89583b0d4d09"></p>
<p>margin 的留白在容器外部，padding 的留白在容器内部</p>
<h4 id="5-6-裁剪"><a href="#5-6-裁剪" class="headerlink" title="5.6 裁剪"></a>5.6 裁剪</h4><table>
<thead>
<tr>
<th>剪裁Widget</th>
<th>默认行为</th>
</tr>
</thead>
<tbody><tr>
<td>ClipOval</td>
<td>子组件为正方形时剪裁成内贴圆形；为矩形时，剪裁成内贴椭圆</td>
</tr>
<tr>
<td>ClipRRect</td>
<td>将子组件剪裁为圆角矩形</td>
</tr>
<tr>
<td>ClipRect</td>
<td>默认剪裁掉子组件布局空间之外的绘制内容（溢出部分剪裁）</td>
</tr>
<tr>
<td>ClipPath</td>
<td>按照自定义的路径剪裁</td>
</tr>
</tbody></table>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClipTestRoute</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="comment">// 头像  </span></span><br><span class="line">    Widget avatar = Image.asset(<span class="string">&quot;imgs/avatar.png&quot;</span>, width: <span class="number">60.0</span>);</span><br><span class="line">    <span class="keyword">return</span> Center(</span><br><span class="line">      child: Column(</span><br><span class="line">        children: &lt;Widget&gt;[</span><br><span class="line">          avatar, <span class="comment">//不剪裁</span></span><br><span class="line">          ClipOval(child: avatar), <span class="comment">//剪裁为圆形</span></span><br><span class="line">          ClipRRect( <span class="comment">//剪裁为圆角矩形</span></span><br><span class="line">            borderRadius: BorderRadius.circular(<span class="number">5.0</span>),</span><br><span class="line">            child: avatar,</span><br><span class="line">          ), </span><br><span class="line">          Row(</span><br><span class="line">            mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">            children: &lt;Widget&gt;[</span><br><span class="line">              Align(</span><br><span class="line">                alignment: Alignment.topLeft,</span><br><span class="line">                widthFactor: <span class="number">.5</span>,<span class="comment">//宽度设为原来宽度一半，另一半会溢出</span></span><br><span class="line">                child: avatar,</span><br><span class="line">              ),</span><br><span class="line">              Text(<span class="string">&quot;你好世界&quot;</span>, style: TextStyle(color: Colors.green),)</span><br><span class="line">            ],</span><br><span class="line">          ),</span><br><span class="line">          Row(</span><br><span class="line">            mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">            children: &lt;Widget&gt;[</span><br><span class="line">              ClipRect(<span class="comment">//将溢出部分剪裁</span></span><br><span class="line">                child: Align(</span><br><span class="line">                  alignment: Alignment.topLeft,</span><br><span class="line">                  widthFactor: <span class="number">.5</span>,<span class="comment">//宽度设为原来宽度一半</span></span><br><span class="line">                  child: avatar,</span><br><span class="line">                ),</span><br><span class="line">              ),</span><br><span class="line">              Text(<span class="string">&quot;你好世界&quot;</span>,style: TextStyle(color: Colors.green))</span><br><span class="line">            ],</span><br><span class="line">          ),</span><br><span class="line">        ],</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/%E3%80%8AFlutter%E5%AE%9E%E6%88%98%E7%AC%AC%E4%BA%8C%E7%89%88%E3%80%8B%E4%BA%94%EF%BC%9A%E5%AE%B9%E5%99%A8%E7%B1%BB%E7%BB%84%E4%BB%B6/WeChatedd5eb5c6aef971412aded090c9a4d5d.png" alt="WeChatedd5eb5c6aef971412aded090c9a4d5d"></p>
<ul>
<li>CustomClipper</li>
</ul>
<p>自定义裁剪区域</p>
<p>自定义一个 CustomClipper</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClipper</span> <span class="keyword">extends</span> <span class="title">CustomClipper</span>&lt;<span class="title">Rect</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Rect getClip(Size size) &#123;</span><br><span class="line">    <span class="keyword">return</span> Rect.fromLTWH(<span class="number">10.0</span>, <span class="number">15.0</span>, <span class="number">40.0</span>, <span class="number">30.0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">bool</span> shouldReclip(<span class="keyword">covariant</span> CustomClipper&lt;Rect&gt; oldClipper) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>getClip 用于获取裁剪区域的接口，返回的裁剪区域为 Rect.fromLTWH(10.0, 15.0, 40.0, 30.0)</p>
<p>shouldReclip 接口决定是否重新裁剪，如果应用中裁剪区域不会发生变化时应该返回false，就不会触发重新裁剪，避免不必要的性能开销，如果裁剪区域会发生变化，那么变化后应该返回 true 来重新执行裁剪</p>
<p>然后通过 ClipRect 来执行裁剪 </p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">DecoratedBox(</span><br><span class="line">  decoration: BoxDecoration(</span><br><span class="line">    color: Colors.red</span><br><span class="line">  ),</span><br><span class="line">  child: ClipRect(</span><br><span class="line">    clipper: MyClipper(), <span class="comment">//使用自定义的clipper</span></span><br><span class="line">    child: avatar</span><br><span class="line">  ),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>ClipPath 可以按照自定义的路径实现裁剪，需要自定义一个 <code>CustomClipper&lt;Path&gt;</code> 类型的Clipper，定义方式和 MyClipper 类似，getClip 返回一个 Path</p>
<h4 id="5-7-空间适配-FittedBox"><a href="#5-7-空间适配-FittedBox" class="headerlink" title="5.7 空间适配 FittedBox"></a>5.7 空间适配 FittedBox</h4><h5 id="5-7-1-FittedBox"><a href="#5-7-1-FittedBox" class="headerlink" title="5.7.1 FittedBox"></a>5.7.1 FittedBox</h5><p>子组件大小超出父组件大小时，如果不经过处理的话 Flutter 中就会显示一个溢出警告</p>
<p>为了方便开发者自定义适配规则，Flutter 提供了 FittedBox 组件</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> FittedBox(&#123;</span><br><span class="line">  Key? key,</span><br><span class="line">  <span class="keyword">this</span>.fit = BoxFit.contain, <span class="comment">// 适配方式</span></span><br><span class="line">  <span class="keyword">this</span>.alignment = Alignment.center, <span class="comment">//对齐方式</span></span><br><span class="line">  <span class="keyword">this</span>.clipBehavior = Clip.none, <span class="comment">//是否剪裁</span></span><br><span class="line">  Widget? child,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Widget build(BuildContext context) &#123;</span><br><span class="line">  <span class="keyword">return</span> Center(</span><br><span class="line">    child: Column(</span><br><span class="line">      children: [</span><br><span class="line">        wContainer(BoxFit.none),</span><br><span class="line">        Text(<span class="string">&#x27;Wendux&#x27;</span>),</span><br><span class="line">        wContainer(BoxFit.contain),</span><br><span class="line">        Text(<span class="string">&#x27;Flutter中国&#x27;</span>),</span><br><span class="line">      ],</span><br><span class="line">    ),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Widget wContainer(BoxFit boxFit) &#123;</span><br><span class="line">  <span class="keyword">return</span> Container(</span><br><span class="line">    width: <span class="number">50</span>,</span><br><span class="line">    height: <span class="number">50</span>,</span><br><span class="line">    color: Colors.red,</span><br><span class="line">    child: FittedBox(</span><br><span class="line">      fit: boxFit,</span><br><span class="line">      <span class="comment">// 子容器超过父容器大小</span></span><br><span class="line">      child: Container(width: <span class="number">60</span>, height: <span class="number">70</span>, color: Colors.blue),</span><br><span class="line">    ),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/%E3%80%8AFlutter%E5%AE%9E%E6%88%98%E7%AC%AC%E4%BA%8C%E7%89%88%E3%80%8B%E4%BA%94%EF%BC%9A%E5%AE%B9%E5%99%A8%E7%B1%BB%E7%BB%84%E4%BB%B6/WeChat2c36ee6dff4f283649d2ef335b96036f.png" alt="WeChat2c36ee6dff4f283649d2ef335b96036f"></p>
<p>父 Container 要比子 Container 小，没置顶任何适配方式时，子组件按照真实大小绘制，蓝色区域超出父组件空间，因而看不到红色区域</p>
<p>第二个适配方式 BoxFit.contain，含义是按子组件的比例缩放，尽可能多的占据父组件的空间，子组件的长宽不相同，按照比例适配父组件后，父组件能显示一部分</p>
<p>未指定适配方式时，子组件的大小超出了父组件，但 FittedBox 自身还是要遵守父组件传递的约束，所以 FittedBox 本身大小是 50x50，所以蓝色下面文本重叠了</p>
<p>如果不想让蓝色超出父组件布局范围，可以使用 ClipRec 对超出部分裁剪掉</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">ClipRect( <span class="comment">// 将超出子组件布局范围的绘制内容剪裁掉</span></span><br><span class="line">  child: Container(</span><br><span class="line">    width: <span class="number">50</span>,</span><br><span class="line">    height: <span class="number">50</span>,</span><br><span class="line">    color: Colors.red,</span><br><span class="line">    child: FittedBox(</span><br><span class="line">      fit: boxFit,</span><br><span class="line">      child: Container(width: <span class="number">60</span>, height: <span class="number">70</span>, color: Colors.blue),</span><br><span class="line">    ),</span><br><span class="line">  ),</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h5 id="5-7-2-单行缩放布局"><a href="#5-7-2-单行缩放布局" class="headerlink" title="5.7.2 单行缩放布局"></a>5.7.2 单行缩放布局</h5><p>三个数据指标，需要一行显示，我们希望当无法一行显示时能够对组件进行适当的缩放确保一行显示</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="meta">@override</span></span><br><span class="line"> Widget build(BuildContext context) &#123;</span><br><span class="line">   <span class="keyword">return</span> Center(</span><br><span class="line">     child: Column(</span><br><span class="line">       children:  [</span><br><span class="line">         wRow(<span class="string">&#x27; 90000000000000000 &#x27;</span>),</span><br><span class="line">         FittedBox(child: wRow(<span class="string">&#x27; 90000000000000000 &#x27;</span>)),</span><br><span class="line">         wRow(<span class="string">&#x27; 800 &#x27;</span>),</span><br><span class="line">         FittedBox(child: wRow1(<span class="string">&#x27; 800 &#x27;</span>)),</span><br><span class="line">   		]</span><br><span class="line">       .map((e) =&gt; Padding(</span><br><span class="line">             padding: EdgeInsets.symmetric(vertical: <span class="number">20</span>),</span><br><span class="line">             child: e,</span><br><span class="line">           ))</span><br><span class="line">       .toList();,</span><br><span class="line">     ),</span><br><span class="line">   );</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 直接使用Row</span></span><br><span class="line"> Widget wRow(<span class="built_in">String</span> text) &#123;</span><br><span class="line">   Widget child = Text(text);</span><br><span class="line">   child = Row(</span><br><span class="line">     mainAxisAlignment: MainAxisAlignment.spaceEvenly,</span><br><span class="line">     children: [child, child, child],</span><br><span class="line">   );</span><br><span class="line">   <span class="keyword">return</span> child;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》五：容器类组件/WeChatc17b2a1e3c1f5eddd9695a65c7bf9423.png" alt="WeChatc17b2a1e3c1f5eddd9695a65c7bf9423" style="zoom:80%;" />

<p>Row 在主轴的对齐方式为 MainAxisAlignment.spaceEvenly，会将水平方向的剩余显示空间均分成多份穿插在每个 child 之间</p>
<p>第一行超出屏幕宽度，直接使用 Row 会溢出</p>
<p>第二行加上 FittedBox 就可以按比例缩放至一行显示</p>
<p>Row 没被 FittedBox 包裹时，父组件传给 Row 的约束的 maxWidth 为屏幕宽度，Row的宽度也就是屏幕宽度</p>
<p>当被 FittedBox 包裹时，FittedBox 传给 Row的约束的 maxWidth 为无限大，因此 Row的最终宽度就是子组件的宽度之和</p>
<p>所以只需要让 FittedBox 子元素接收到的约束的 maxWidth 为屏幕宽度即可</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SingleLineFittedBox</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> SingleLineFittedBox(&#123;Key? key,<span class="keyword">this</span>.child&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"> <span class="keyword">final</span> Widget? child;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> LayoutBuilder(</span><br><span class="line">      builder: (_, constraints) &#123;</span><br><span class="line">        <span class="keyword">return</span> FittedBox(</span><br><span class="line">          child: ConstrainedBox(</span><br><span class="line">            constraints: constraints.copyWith(</span><br><span class="line">              minWidth: constraints.maxWidth,</span><br><span class="line">              maxWidth: <span class="built_in">double</span>.infinity,</span><br><span class="line">              <span class="comment">//maxWidth: constraints.maxWidth</span></span><br><span class="line">            ),</span><br><span class="line">            child: child,</span><br><span class="line">          ),</span><br><span class="line">        );</span><br><span class="line">      &#125;,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》五：容器类组件/WeChatf8d080b6a4934b277d35eae7dee059d2.png" alt="WeChatf8d080b6a4934b277d35eae7dee059d2" style="zoom:80%;" />

<h4 id="5-8-Scaffold"><a href="#5-8-Scaffold" class="headerlink" title="5.8 Scaffold"></a>5.8 Scaffold</h4><h5 id="5-8-1-Scaffold"><a href="#5-8-1-Scaffold" class="headerlink" title="5.8.1 Scaffold"></a>5.8.1 Scaffold</h5><p>Scaffold 是一个路由页的骨架</p>
<p>实现一个页面：<br>1.一个导航栏<br>2.导航栏右边分享按钮<br>3.一个抽屉菜单<br>4.有一个底部导航<br>5.右下角悬浮动作按钮</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScaffoldRoute</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _ScaffoldRouteState createState() =&gt; _ScaffoldRouteState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_ScaffoldRouteState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">ScaffoldRoute</span>&gt; </span>&#123;</span><br><span class="line">  <span class="built_in">int</span> _selectedIndex = <span class="number">1</span>;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(<span class="string">&#x27;标题&#x27;</span>),</span><br><span class="line">        actions: [</span><br><span class="line">          IconButton(onPressed: ()&#123;&#125;, icon: Icon(Icons.share))</span><br><span class="line">        ],</span><br><span class="line">      ),</span><br><span class="line">      bottomNavigationBar: BottomNavigationBar(</span><br><span class="line">          items: [</span><br><span class="line">            BottomNavigationBarItem(icon: Icon(Icons.home), title: Text(<span class="string">&#x27;Home&#x27;</span>)),</span><br><span class="line">            BottomNavigationBarItem(icon: Icon(Icons.business), title:Text(<span class="string">&#x27;Business&#x27;</span>)),</span><br><span class="line">            BottomNavigationBarItem(icon: Icon(Icons.school), title: Text(<span class="string">&#x27;School&#x27;</span>)),</span><br><span class="line">          ],</span><br><span class="line">          currentIndex: _selectedIndex,</span><br><span class="line">          fixedColor: Colors.blue, <span class="comment">//选中index图标颜色</span></span><br><span class="line">          onTap: _onItemTapped,</span><br><span class="line">      ),</span><br><span class="line">      floatingActionButton: FloatingActionButton(</span><br><span class="line">          child: Icon(Icons.add),</span><br><span class="line">          onPressed: _onAdd,</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">void</span> _onItemTapped(<span class="built_in">int</span> index) &#123;</span><br><span class="line">    setState(() &#123;</span><br><span class="line">      _selectedIndex = index;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">void</span> _onAdd() &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》五：容器类组件/WeChataf1f187dc2c0ab4fa149ec5e1962aaf7.png" alt="WeChataf1f187dc2c0ab4fa149ec5e1962aaf7" style="zoom:80%;" />

<p>AppBar 导航栏骨架</p>
<p>BottomNavigationBar 底部导航栏</p>
<p>FloatingActionButton 悬浮按钮</p>
<h5 id="5-8-2-AppBar"><a href="#5-8-2-AppBar" class="headerlink" title="5.8.2 AppBar"></a>5.8.2 AppBar</h5><p>APPBar 是一个 Material 风格的导航栏，通过它可以设置导航栏标题、导航栏菜单、导航栏底部Tab标题等</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">AppBar(&#123;</span><br><span class="line">  Key? key,</span><br><span class="line">  <span class="keyword">this</span>.leading, <span class="comment">//导航栏最左侧Widget，常见为抽屉菜单按钮或返回按钮。</span></span><br><span class="line">  <span class="keyword">this</span>.automaticallyImplyLeading = <span class="keyword">true</span>, <span class="comment">//如果leading为null，是否自动实现默认的leading按钮</span></span><br><span class="line">  <span class="keyword">this</span>.title,<span class="comment">// 页面标题</span></span><br><span class="line">  <span class="keyword">this</span>.actions, <span class="comment">// 导航栏右侧菜单</span></span><br><span class="line">  <span class="keyword">this</span>.bottom, <span class="comment">// 导航栏底部菜单，通常为Tab按钮组</span></span><br><span class="line">  <span class="keyword">this</span>.elevation = <span class="number">4.0</span>, <span class="comment">// 导航栏阴影</span></span><br><span class="line">  <span class="keyword">this</span>.centerTitle, <span class="comment">//标题是否居中 </span></span><br><span class="line">  <span class="keyword">this</span>.backgroundColor,</span><br><span class="line">  ...   <span class="comment">//其它属性见源码注释</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>如果给 Scaffold 添加了菜单，默认情况下 Scaffold 会自动将 leading 设置为菜单按钮，点击它就可以打开抽屉菜单，也可以自定义图标</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Scaffold(</span><br><span class="line">  appBar: AppBar(</span><br><span class="line">    title: Text(<span class="string">&quot;App Name&quot;</span>),</span><br><span class="line">    leading: Builder(builder: (context) &#123;</span><br><span class="line">      <span class="keyword">return</span> IconButton(</span><br><span class="line">        icon: Icon(Icons.dashboard, color: Colors.white), <span class="comment">//自定义图标</span></span><br><span class="line">        onPressed: () &#123;</span><br><span class="line">          <span class="comment">// 打开抽屉菜单  </span></span><br><span class="line">          Scaffold.of(context).openDrawer(); </span><br><span class="line">        &#125;,</span><br><span class="line">      );</span><br><span class="line">    &#125;),</span><br><span class="line">    ...  </span><br><span class="line">  )  </span><br></pre></td></tr></table></figure>

<h5 id="5-8-3-抽屉菜单-Drawer"><a href="#5-8-3-抽屉菜单-Drawer" class="headerlink" title="5.8.3 抽屉菜单 Drawer"></a>5.8.3 抽屉菜单 Drawer</h5><p>Scaffold 的 drawer 和 endDrawer 属性可以分别接受一个 widget 来作为左、右抽屉菜单</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyDrawer</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> MyDrawer(&#123;</span><br><span class="line">    Key? key,</span><br><span class="line">  &#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Drawer(</span><br><span class="line">      child: MediaQuery.removePadding(</span><br><span class="line">        context: context,</span><br><span class="line">        <span class="comment">//移除抽屉菜单顶部默认留白</span></span><br><span class="line">        removeTop: <span class="keyword">true</span>,</span><br><span class="line">        child: Column(</span><br><span class="line">          crossAxisAlignment: CrossAxisAlignment.start,</span><br><span class="line">          children: &lt;Widget&gt;[</span><br><span class="line">            Padding(</span><br><span class="line">              padding: <span class="keyword">const</span> EdgeInsets.only(top: <span class="number">38.0</span>),</span><br><span class="line">              child: Row(</span><br><span class="line">                children: &lt;Widget&gt;[</span><br><span class="line">                  Padding(</span><br><span class="line">                    padding: <span class="keyword">const</span> EdgeInsets.symmetric(horizontal: <span class="number">16.0</span>),</span><br><span class="line">                    child: ClipOval(</span><br><span class="line">                      child: Image.asset(</span><br><span class="line">                        <span class="string">&quot;img/avatar.png&quot;</span>,</span><br><span class="line">                        width: <span class="number">80</span>,</span><br><span class="line">                      ),</span><br><span class="line">                    ),</span><br><span class="line">                  ),</span><br><span class="line">                  Text(</span><br><span class="line">                    <span class="string">&quot;Wendux&quot;</span>,</span><br><span class="line">                    style: TextStyle(fontWeight: FontWeight.bold),</span><br><span class="line">                  )</span><br><span class="line">                ],</span><br><span class="line">              ),</span><br><span class="line">            ),</span><br><span class="line">            Expanded(</span><br><span class="line">              child: ListView(</span><br><span class="line">                children: &lt;Widget&gt;[</span><br><span class="line">                  ListTile(</span><br><span class="line">                    leading: <span class="keyword">const</span> Icon(Icons.add),</span><br><span class="line">                    title: <span class="keyword">const</span> Text(<span class="string">&#x27;Add account&#x27;</span>),</span><br><span class="line">                  ),</span><br><span class="line">                  ListTile(</span><br><span class="line">                    leading: <span class="keyword">const</span> Icon(Icons.settings),</span><br><span class="line">                    title: <span class="keyword">const</span> Text(<span class="string">&#x27;Manage accounts&#x27;</span>),</span><br><span class="line">                  ),</span><br><span class="line">                ],</span><br><span class="line">              ),</span><br><span class="line">            ),</span><br><span class="line">          ],</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>抽屉菜单通常将 Drawer 组件作为根节点，MediaQuery.removePadding 可以移除 Drawer 默认的一些留白（比如Drawer默认顶部会留手机状态栏等高的留白）</p>
<h5 id="5-8-4-FloatingActionButton"><a href="#5-8-4-FloatingActionButton" class="headerlink" title="5.8.4 FloatingActionButton"></a>5.8.4 FloatingActionButton</h5><p>可以通过 floatingActionButtonLocation 属性指定其在页面中悬浮的位置</p>
<h5 id="5-8-5-底部-Tab-导航栏"><a href="#5-8-5-底部-Tab-导航栏" class="headerlink" title="5.8.5 底部 Tab 导航栏"></a>5.8.5 底部 Tab 导航栏</h5><p>Material 组件库中提供了一个 BottomAPPBar 组件，可以和 FloatingActionButton 配合实现打洞效果</p>
<img src="《Flutter实战第二版》五：容器类组件/WeChat32ad216f5189993f92ba6d3d40aae74c.png" alt="WeChat32ad216f5189993f92ba6d3d40aae74c" style="zoom:80%;" />

<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">bottomNavigationBar: BottomAppBar(</span><br><span class="line">  color: Colors.white,</span><br><span class="line">  shape: CircularNotchedRectangle(), <span class="comment">// 底部导航栏打一个圆形的洞</span></span><br><span class="line">  child: Row(</span><br><span class="line">    children: [</span><br><span class="line">      IconButton(icon: Icon(Icons.home)),</span><br><span class="line">      SizedBox(), <span class="comment">//中间位置空出</span></span><br><span class="line">      IconButton(icon: Icon(Icons.business)),</span><br><span class="line">    ],</span><br><span class="line">    mainAxisAlignment: MainAxisAlignment.spaceAround, <span class="comment">//均分底部导航栏横向空间</span></span><br><span class="line">  ),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>上面代码没有控制打洞位置的属性，实际上打洞位置取决于 FloatingActionButton 的位置</p>
<p>上面 FloatingActionButton 的位置为</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">floatingActionButtonLocation: FloatingActionButtonLocation.centerDocked,</span><br></pre></td></tr></table></figure>

<p>打洞位置在导航栏正中间</p>
<p>shape 属性决定洞的外形，也可以自定义外形</p>
]]></content>
  </entry>
  <entry>
    <title>《Flutter实战第二版》十一：文件操作与网络请求</title>
    <url>/2022/01/26/%E3%80%8AFlutter%E5%AE%9E%E6%88%98%E7%AC%AC%E4%BA%8C%E7%89%88%E3%80%8B%E5%8D%81%E4%B8%80%EF%BC%9A%E6%96%87%E4%BB%B6%E6%93%8D%E4%BD%9C%E4%B8%8E%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82/</url>
    <content><![CDATA[<h3 id="11-文件操作与网络请求"><a href="#11-文件操作与网络请求" class="headerlink" title="11 文件操作与网络请求"></a>11 文件操作与网络请求</h3><h4 id="11-1-文件操作"><a href="#11-1-文件操作" class="headerlink" title="11.1 文件操作"></a>11.1 文件操作</h4><ul>
<li>临时目录</li>
</ul>
<p>getTemporaryDirectory() 获取，系统可随时清除的临时目录。iOS 上对应 NSTemporaryDirectory()，Android 上是 getCacheDir()</p>
<ul>
<li>文档目录</li>
</ul>
<p>getApplicationDocumentsDirectory() 获取应用程序的文档目录。iOS 上对应 NSDocumentDirectory，Android 上是 APPData 目录</p>
<ul>
<li>外部存储目录</li>
</ul>
<p>getExternalStorageDirectory() 获取外部存储目录，如 SD 卡，iOS 不支持外部目录，iOS 下调用会抛出 UnsupportedError 异常，Android 中是 getExternalStorageDirectory 的返回值</p>
<p>一旦你的 Flutter 应用程序有一个文件位置的引用，可以使用 dart:io API来执行对文件系统的读/写操作</p>
<ul>
<li>示例</li>
</ul>
<p>计数器示例，退出重启后可以恢复点击次数，用文件来保存数据</p>
<p>引入 PathProvider 插件，pubspec.yaml 中添加</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">path_provider: ^<span class="number">2.0</span><span class="number">.8</span></span><br></pre></td></tr></table></figure>

<p>实现 </p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;dart:io&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;dart:async&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:path_provider/path_provider.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileOperationRoute</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  FileOperationRoute(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _FileOperationRouteState createState() =&gt; _FileOperationRouteState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_FileOperationRouteState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">FileOperationRoute</span>&gt; </span>&#123;</span><br><span class="line">  <span class="built_in">int</span> _counter = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    <span class="comment">//从文件读取点击次数</span></span><br><span class="line">    _readCounter().then((<span class="built_in">int</span> value) &#123;</span><br><span class="line">      setState(() &#123;</span><br><span class="line">        _counter = value;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future&lt;File&gt; _getLocalFile() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="comment">// 获取应用目录</span></span><br><span class="line">    <span class="built_in">String</span> dir = (<span class="keyword">await</span> getApplicationDocumentsDirectory()).path;</span><br><span class="line">    <span class="keyword">return</span> File(<span class="string">&#x27;<span class="subst">$dir</span>/counter.txt&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future&lt;<span class="built_in">int</span>&gt; _readCounter() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      File file = <span class="keyword">await</span> _getLocalFile();</span><br><span class="line">      <span class="comment">// 读取点击次数（以字符串）</span></span><br><span class="line">      <span class="built_in">String</span> contents = <span class="keyword">await</span> file.readAsString();</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">int</span>.parse(contents);</span><br><span class="line">    &#125; <span class="keyword">on</span> FileSystemException &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  _incrementCounter() <span class="keyword">async</span> &#123;</span><br><span class="line">    setState(() &#123;</span><br><span class="line">      _counter++;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 将点击次数以字符串类型写到文件中</span></span><br><span class="line">    <span class="keyword">await</span> (<span class="keyword">await</span> _getLocalFile()).writeAsString(<span class="string">&#x27;<span class="subst">$_counter</span>&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(title: Text(<span class="string">&#x27;文件操作&#x27;</span>)),</span><br><span class="line">      body: Center(</span><br><span class="line">        child: Text(<span class="string">&#x27;点击了 <span class="subst">$_counter</span> 次&#x27;</span>),</span><br><span class="line">      ),</span><br><span class="line">      floatingActionButton: FloatingActionButton(</span><br><span class="line">        onPressed: _incrementCounter,</span><br><span class="line">        tooltip: <span class="string">&#x27;Increment&#x27;</span>,</span><br><span class="line">        child: Icon(Icons.add),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》十一：文件操作与网络请求/WeChat090c4738bd95a6d28745c73778204758.png" alt="WeChat090c4738bd95a6d28745c73778204758" style="zoom:80%;" />

<p>实际开发中如果要存储一些简单数据，使用 shared_preferences 插件</p>
<h4 id="11-2-通过-HttpClient-发起-HTTP-请求"><a href="#11-2-通过-HttpClient-发起-HTTP-请求" class="headerlink" title="11.2 通过 HttpClient 发起 HTTP 请求"></a>11.2 通过 HttpClient 发起 HTTP 请求</h4><p>使用 HttpClient 发起请求分为五步</p>
<ol>
<li>创建 HttpClient</li>
</ol>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">HttpClient httpClient = HttpClient();</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>打开HTTP连接，设置请求头</li>
</ol>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">HttpClientRequest request = <span class="keyword">await</span> httpClient.getUrl(uri);</span><br></pre></td></tr></table></figure>

<p>这一步可以使用任意Http Method，如<code>httpClient.post(...)</code>、<code>httpClient.delete(...)</code>等。如果包含Query参数，可以在构建uri时添加</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Uri</span> uri = <span class="built_in">Uri</span>(scheme: <span class="string">&quot;https&quot;</span>, host: <span class="string">&quot;flutterchina.club&quot;</span>, queryParameters: &#123;</span><br><span class="line">    <span class="string">&quot;xx&quot;</span>:<span class="string">&quot;xx&quot;</span>,</span><br><span class="line">    <span class="string">&quot;yy&quot;</span>:<span class="string">&quot;dd&quot;</span></span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>通过 HttpClientRequest 可以设置请求 header</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">request.headers.add(<span class="string">&quot;user-agent&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>如果是post或put等可以携带请求体方法，可以通过HttpClientRequest对象发送request body</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">String</span> payload=<span class="string">&quot;...&quot;</span>;</span><br><span class="line">request.add(utf8.encode(payload)); </span><br><span class="line"><span class="comment">//request.addStream(_inputStream); //可以直接添加输入流</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>等待连接服务器</li>
</ol>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">HttpClientResponse response = <span class="keyword">await</span> request.close();</span><br></pre></td></tr></table></figure>

<p>这一步完成后，请求信息就已经发送给服务器了，返回一个<code>HttpClientResponse</code>对象，它包含响应头（header）和响应流(响应体的Stream)，接下来就可以通过读取响应流来获取响应内容</p>
<ol start="4">
<li>读取响应内容</li>
</ol>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">String</span> responseBody = <span class="keyword">await</span> response.transform(utf8.decoder).join();</span><br></pre></td></tr></table></figure>

<p>我们通过读取响应流来获取服务器返回的数据，在读取时我们可以设置编码格式，这里是utf8</p>
<ol start="5">
<li>请求结束，关闭<code>HttpClient</code></li>
</ol>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">httpClient.close();</span><br></pre></td></tr></table></figure>

<p>关闭client后，通过该client发起的所有请求都会中止</p>
<ul>
<li>示例</li>
</ul>
<p>获取百度首页 html</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;dart:convert&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;dart:io&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpTestRoute</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _HttpTestRouteState createState() =&gt; _HttpTestRouteState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_HttpTestRouteState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">HttpTestRoute</span>&gt; </span>&#123;</span><br><span class="line">  <span class="built_in">bool</span> _loading = <span class="keyword">false</span>;</span><br><span class="line">  <span class="built_in">String</span> _text = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> SingleChildScrollView(</span><br><span class="line">      child: Column(</span><br><span class="line">        children: &lt;Widget&gt;[</span><br><span class="line">          ElevatedButton(</span><br><span class="line">            child: Text(<span class="string">&quot;获取百度首页&quot;</span>),</span><br><span class="line">            onPressed: _loading ? <span class="keyword">null</span> : request,</span><br><span class="line">          ),</span><br><span class="line">          Container(</span><br><span class="line">            width: MediaQuery.of(context).size.width - <span class="number">50.0</span>,</span><br><span class="line">            child: Text(_text.replaceAll(<span class="built_in">RegExp</span>(<span class="string">r&quot;\s&quot;</span>), <span class="string">&quot;&quot;</span>)),</span><br><span class="line">          )</span><br><span class="line">        ],</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  request() <span class="keyword">async</span> &#123;</span><br><span class="line">    setState(() &#123;</span><br><span class="line">      _loading = <span class="keyword">true</span>;</span><br><span class="line">      _text = <span class="string">&quot;正在请求...&quot;</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//创建一个HttpClient</span></span><br><span class="line">      HttpClient httpClient = HttpClient();</span><br><span class="line">      <span class="comment">//打开Http连接</span></span><br><span class="line">      HttpClientRequest request =</span><br><span class="line">          <span class="keyword">await</span> httpClient.getUrl(<span class="built_in">Uri</span>.parse(<span class="string">&quot;https://www.baidu.com&quot;</span>));</span><br><span class="line">      <span class="comment">//使用iPhone的UA</span></span><br><span class="line">      request.headers.add(</span><br><span class="line">        <span class="string">&quot;user-agent&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Mozilla/5.0 (iPhone; CPU iPhone OS 10_3_1 like Mac OS X) AppleWebKit/603.1.30 (KHTML, like Gecko) Version/10.0 Mobile/14E304 Safari/602.1&quot;</span>,</span><br><span class="line">      );</span><br><span class="line">      <span class="comment">//等待连接服务器（会将请求信息发送给服务器）</span></span><br><span class="line">      HttpClientResponse response = <span class="keyword">await</span> request.close();</span><br><span class="line">      <span class="comment">//读取响应内容</span></span><br><span class="line">      _text = <span class="keyword">await</span> response.transform(utf8.decoder).join();</span><br><span class="line">      <span class="comment">//输出响应头</span></span><br><span class="line">      <span class="built_in">print</span>(response.headers);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//关闭client后，通过该client发起的所有请求都会中止。</span></span><br><span class="line">      httpClient.close();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      _text = <span class="string">&quot;请求失败：<span class="subst">$e</span>&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      setState(() &#123;</span><br><span class="line">        _loading = <span class="keyword">false</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》十一：文件操作与网络请求/WeChat268e06a2ed985dfb1a6c39fd00b96c2e.png" alt="WeChat268e06a2ed985dfb1a6c39fd00b96c2e" style="zoom:80%;" />

<ul>
<li>HttpClient </li>
</ul>
<table>
<thead>
<tr>
<th>属性</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>idleTimeout</td>
<td>对应请求头中的keep-alive字段值，为了避免频繁建立连接，httpClient在请求结束后会保持连接一段时间，超过这个阈值后才会关闭连接。</td>
</tr>
<tr>
<td>connectionTimeout</td>
<td>和服务器建立连接的超时，如果超过这个值则会抛出SocketException异常。</td>
</tr>
<tr>
<td>maxConnectionsPerHost</td>
<td>同一个host，同时允许建立连接的最大数量。</td>
</tr>
<tr>
<td>autoUncompress</td>
<td>对应请求头中的Content-Encoding，如果设置为true，则请求头中Content-Encoding的值为当前HttpClient支持的压缩算法列表，目前只有”gzip”</td>
</tr>
<tr>
<td>userAgent</td>
<td>对应请求头中的User-Agent字段。</td>
</tr>
</tbody></table>
<p>这些属性也可通过 HttpClientRequest 直接设置 header，只对当前请求生效；HttpClient 设置的对整个 HttpClient 都生效</p>
<ul>
<li>HTTP 请求认证</li>
<li>代理</li>
<li>证书校验</li>
</ul>
<p>Https 中为了防止通过伪造证书而发起的中间人攻击，客户端应该对自签名或非CA颁发的证书进行校验</p>
<h4 id="11-3-HTTP请求-Dio-http-库"><a href="#11-3-HTTP请求-Dio-http-库" class="headerlink" title="11.3 HTTP请求-Dio http 库"></a>11.3 HTTP请求-Dio http 库</h4><p>引入 dio</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">dio: ^<span class="number">4.0</span><span class="number">.3</span></span><br></pre></td></tr></table></figure>

<p>导入并创建 dio 实例</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:dio/dio.dart&#x27;</span>;</span><br><span class="line">Dio dio =  Dio();</span><br></pre></td></tr></table></figure>

<p>GET 请求</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Response response;</span><br><span class="line">response=<span class="keyword">await</span> dio.<span class="keyword">get</span>(<span class="string">&quot;/test?id=12&amp;name=wendu&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(response.data.toString());</span><br></pre></td></tr></table></figure>

<p>可以将 query 参数通过对象来传递</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">response=<span class="keyword">await</span> dio.<span class="keyword">get</span>(<span class="string">&quot;/test&quot;</span>,queryParameters:&#123;<span class="string">&quot;id&quot;</span>:<span class="number">12</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;wendu&quot;</span>&#125;)</span><br><span class="line"><span class="built_in">print</span>(response);</span><br></pre></td></tr></table></figure>

<p>POST 请求</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">response=<span class="keyword">await</span> dio.post(<span class="string">&quot;/test&quot;</span>,data:&#123;<span class="string">&quot;id&quot;</span>:<span class="number">12</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;wendu&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>发起多个并发请求</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">response= <span class="keyword">await</span> Future.wait([dio.post(<span class="string">&quot;/info&quot;</span>),dio.<span class="keyword">get</span>(<span class="string">&quot;/token&quot;</span>)]);</span><br></pre></td></tr></table></figure>

<p>下载文件</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">response=<span class="keyword">await</span> dio.download(<span class="string">&quot;https://www.google.com/&quot;</span>,_savePath);</span><br></pre></td></tr></table></figure>

<p>发送 FormData</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">FormData formData = FormData.from(&#123;</span><br><span class="line">   <span class="string">&quot;name&quot;</span>: <span class="string">&quot;wendux&quot;</span>,</span><br><span class="line">   <span class="string">&quot;age&quot;</span>: <span class="number">25</span>,</span><br><span class="line">&#125;);</span><br><span class="line">response = <span class="keyword">await</span> dio.post(<span class="string">&quot;/info&quot;</span>, data: formData)</span><br></pre></td></tr></table></figure>

<p>如果发送的数据是FormData，则dio会将请求header的<code>contentType</code>设为“multipart/form-data”</p>
<p>通过FormData上传多个文件</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">FormData formData = FormData.from(&#123;</span><br><span class="line">   <span class="string">&quot;name&quot;</span>: <span class="string">&quot;wendux&quot;</span>,</span><br><span class="line">   <span class="string">&quot;age&quot;</span>: <span class="number">25</span>,</span><br><span class="line">   <span class="string">&quot;file1&quot;</span>: UploadFileInfo(File(<span class="string">&quot;./upload.txt&quot;</span>), <span class="string">&quot;upload1.txt&quot;</span>),</span><br><span class="line">   <span class="string">&quot;file2&quot;</span>: UploadFileInfo(File(<span class="string">&quot;./upload.txt&quot;</span>), <span class="string">&quot;upload2.txt&quot;</span>),</span><br><span class="line">     <span class="comment">// 支持文件数组上传</span></span><br><span class="line">   <span class="string">&quot;files&quot;</span>: [</span><br><span class="line">      UploadFileInfo(File(<span class="string">&quot;./example/upload.txt&quot;</span>), <span class="string">&quot;upload.txt&quot;</span>),</span><br><span class="line">      UploadFileInfo(File(<span class="string">&quot;./example/upload.txt&quot;</span>), <span class="string">&quot;upload.txt&quot;</span>)</span><br><span class="line">    ]</span><br><span class="line">&#125;);</span><br><span class="line">response = <span class="keyword">await</span> dio.post(<span class="string">&quot;/info&quot;</span>, data: formData)</span><br></pre></td></tr></table></figure>

<p>dio 内部仍然使用 HttpClient 发起请求，所以代理、请求认证、证书校验等和 HttpClient 是相同的，可以在 onHttpClientCreate 回调中设置</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">(dio.httpClientAdapter <span class="keyword">as</span> DefaultHttpClientAdapter).onHttpClientCreate = (client) &#123;</span><br><span class="line">    <span class="comment">//设置代理 </span></span><br><span class="line">    client.findProxy = (uri) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;PROXY 192.168.1.2:8888&quot;</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//校验证书</span></span><br><span class="line">    httpClient.badCertificateCallback=(X509Certificate cert, <span class="built_in">String</span> host, <span class="built_in">int</span> port)&#123;</span><br><span class="line">      <span class="keyword">if</span>(cert.pem==PEM)&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">//证书一致，则允许发送数据</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;;   </span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p><code>onHttpClientCreate</code> 会在当前dio实例内部需要创建HttpClient时调用，所以通过此回调配置HttpClient会对整个dio实例生效</p>
<ul>
<li>示例</li>
</ul>
<p>通过 Github 开放 API 请求 flutterchina 组织下所有公开的项目</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_FutureBuilderRouteState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">FutureBuilderRoute</span>&gt; </span>&#123;</span><br><span class="line">  Dio _dio = Dio();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Container(</span><br><span class="line">      alignment: Alignment.center,</span><br><span class="line">      child: FutureBuilder(</span><br><span class="line">          future: _dio.<span class="keyword">get</span>(<span class="string">&quot;https://api.github.com/orgs/flutterchina/repos&quot;</span>),</span><br><span class="line">          builder: (BuildContext context, AsyncSnapshot snapshot) &#123;</span><br><span class="line">            <span class="comment">//请求完成</span></span><br><span class="line">            <span class="keyword">if</span> (snapshot.connectionState == ConnectionState.done) &#123;</span><br><span class="line">              Response response = snapshot.data;</span><br><span class="line">              <span class="comment">//发生错误</span></span><br><span class="line">              <span class="keyword">if</span> (snapshot.hasError) &#123;</span><br><span class="line">                <span class="keyword">return</span> Text(snapshot.error.toString());</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="comment">//请求成功，通过项目信息构建用于显示项目名称的ListView</span></span><br><span class="line">              <span class="keyword">return</span> ListView(</span><br><span class="line">                children: response.data.map&lt;Widget&gt;((e) =&gt;</span><br><span class="line">                    ListTile(title: Text(e[<span class="string">&quot;full_name&quot;</span>]))</span><br><span class="line">                ).toList(),</span><br><span class="line">              );</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//请求未完成时弹出loading</span></span><br><span class="line">            <span class="keyword">return</span> CircularProgressIndicator();</span><br><span class="line">          &#125;</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="11-4-实例：HTTP分块下载"><a href="#11-4-实例：HTTP分块下载" class="headerlink" title="11.4 实例：HTTP分块下载"></a>11.4 实例：HTTP分块下载</h4><p>Http 协议定义了分块传输的响应 header 字段，具体是否支持取决于 Server 的实现，可以指定 range 字段验证服务器是否支持分块传输，例如，可以利用 curl 命令来验证</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">xxx:~ duwen$ curl -H &quot;Range: bytes=0-10&quot; http://download.dcloud.net.cn/HBuilder.9.0.2.macosx_64.dmg -v</span><br><span class="line"><span class="meta">#</span><span class="bash"> 请求头</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> GET /HBuilder.9.0.2.macosx_64.dmg HTTP/1.1</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> Host: download.dcloud.net.cn</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> User-Agent: curl/7.54.0</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> Accept: */*</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> Range: bytes=0-10</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 响应头</span></span><br><span class="line">&lt; HTTP/1.1 206 Partial Content</span><br><span class="line">&lt; Content-Type: application/octet-stream</span><br><span class="line">&lt; Content-Length: 11</span><br><span class="line">&lt; Connection: keep-alive</span><br><span class="line">&lt; Date: Thu, 21 Feb 2019 06:25:15 GMT</span><br><span class="line">&lt; Content-Range: bytes 0-10/233295878</span><br></pre></td></tr></table></figure>

<p>请求头中添加 <code>Range: bytes=0-10</code> 告诉服务器本次请求只想获取 0-10（包括10共11个字节）这块内容，如果服务器支持分块传输，则响应状态码为206，表示部分内容，响应头中包含  Content-Range 字段</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Content-Range: bytes 0-10/233295878 //单位byte</span><br></pre></td></tr></table></figure>

<ul>
<li>示例</li>
</ul>
<p>分块下载</p>
<h4 id="11-5-WebSockets"><a href="#11-5-WebSockets" class="headerlink" title="11.5 WebSockets"></a>11.5 WebSockets</h4><p>WebSocket 协议正是为了解决客户端与服务端实时通信而产生的技术</p>
<p>Http 协议中虽然可以通过  keep-alive 机制使服务器在响应结束后链接会保持一段时间，但还是会断开。keep-alive 机制主要是用于避免在同一台服务器请求多个资源时频繁创建链接，它本质上是支持链接复用的技术，并非用于实时通信</p>
<ul>
<li>步骤</li>
</ul>
<ol>
<li>连接到 WebSocket 服务器</li>
<li>监听来自服务器的消息</li>
<li>将数据发送到服务器</li>
<li>关闭 WebSocket 连接</li>
</ol>
<h4 id="11-6-使用-Socket-API"><a href="#11-6-使用-Socket-API" class="headerlink" title="11.6 使用 Socket API"></a>11.6 使用 Socket API</h4><h4 id="11-7-Json-转-Dart-Model-类"><a href="#11-7-Json-转-Dart-Model-类" class="headerlink" title="11.7 Json 转 Dart Model 类"></a>11.7 Json 转 Dart Model 类</h4><h5 id="11-7-1-Json-转-Dart-类"><a href="#11-7-1-Json-转-Dart-类" class="headerlink" title="11.7.1 Json 转 Dart 类"></a>11.7.1 Json 转 Dart 类</h5><p>返回数据是 JSON 格式的字符串，为了方便在代码中操作 JSON，先将 JSON 格式字符串转为 Dart 对象，可以通过 <code>dart:convert</code> 中的 JSON 解码器 <code>json.decode()</code> 来实现，可以根据 JSON 字符串具体内容将其转为 List 或 Map</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="comment">//一个JSON格式的用户列表字符串</span></span><br><span class="line"><span class="built_in">String</span> jsonStr=<span class="string">&#x27;[&#123;&quot;name&quot;:&quot;Jack&quot;&#125;,&#123;&quot;name&quot;:&quot;Rose&quot;&#125;]&#x27;</span>;`</span><br><span class="line"><span class="comment">//将JSON字符串转为Dart对象(此处是List)</span></span><br><span class="line"><span class="built_in">List</span> items=json.decode(jsonStr);</span><br><span class="line"><span class="comment">//输出第一个用户的姓名</span></span><br><span class="line"><span class="built_in">print</span>(items[<span class="number">0</span>][<span class="string">&quot;name&quot;</span>]);</span><br></pre></td></tr></table></figure>

<p>有如下 JSON</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Smith&quot;</span>,</span><br><span class="line">  <span class="string">&quot;email&quot;</span>: <span class="string">&quot;john@example.com&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">dynamic</span>&gt; user = json.decode(json);</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Howdy, <span class="subst">$&#123;user[<span class="string">&#x27;name&#x27;</span>]&#125;</span>!&#x27;</span>);</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;We sent the verification link to <span class="subst">$&#123;user[<span class="string">&#x27;email&#x27;</span>]&#125;</span>.&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>容易出错，比如访问属性字段名写错，编译的时候不会报错，运行时会报错</p>
<p>解决：即 Json Model 化，引入模型类 User，一个 User.fromJson 构造函数，用于从一个 map 构造出一个 User 实例 map 结构；一个 toJson 方法，将 User 实例转化为一个 map</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> name;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> email;</span><br><span class="line"></span><br><span class="line">  User(<span class="keyword">this</span>.name, <span class="keyword">this</span>.email);</span><br><span class="line"></span><br><span class="line">  User.fromJson(<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">dynamic</span>&gt; json)</span><br><span class="line">      : name = json[<span class="string">&#x27;name&#x27;</span>],</span><br><span class="line">        email = json[<span class="string">&#x27;email&#x27;</span>];</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">dynamic</span>&gt; toJson() =&gt;</span><br><span class="line">    &lt;<span class="built_in">String</span>, <span class="built_in">dynamic</span>&gt;&#123;</span><br><span class="line">      <span class="string">&#x27;name&#x27;</span>: name,</span><br><span class="line">      <span class="string">&#x27;email&#x27;</span>: email,</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Map</span> userMap = json.decode(json);</span><br><span class="line"><span class="keyword">var</span> user = User.fromJson(userMap);</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Howdy, <span class="subst">$&#123;user.name&#125;</span>!&#x27;</span>);</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;We sent the verification link to <span class="subst">$&#123;user.email&#125;</span>.&#x27;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>自动生成 Model</li>
</ul>
<p>官方推荐的 json_serializable package 包，是一个自动化的源代码生成器，可以在开发阶段为我们生成 JSON 序列化模板</p>
<ul>
<li>项目中设置 json_serializable</li>
</ul>
<p>json_serializable 需要一个常规和两个开发依赖项，开发依赖项是不包含在我们应用程序源代码中的依赖项</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">dependencies:</span><br><span class="line">  json_annotation: &lt;最新版本&gt;</span><br><span class="line"></span><br><span class="line">dev_dependencies:</span><br><span class="line">  build_runner: &lt;最新版本&gt;</span><br><span class="line">  json_serializable: &lt;最新版本&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>以 json_serializable 的方式创建 model 类</li>
</ul>
<p>user.dart</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:json_annotation/json_annotation.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// User.g.dart 将在我们运行生成命令后自动生成</span></span><br><span class="line"><span class="keyword">part</span> <span class="string">&#x27;User.g.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">///<span class="markdown">这个标注是告诉生成器，这个类是需要生成Model类的</span></span></span><br><span class="line"><span class="meta">@JsonSerializable</span>()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">  User(<span class="keyword">this</span>.name, <span class="keyword">this</span>.email);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">String</span> name;</span><br><span class="line">  <span class="built_in">String</span> email;</span><br><span class="line">  <span class="comment">//不同的类使用不同的mixin即可</span></span><br><span class="line">  <span class="keyword">factory</span> User.fromJson(<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">dynamic</span>&gt; json) =&gt; _$UserFromJson(json);</span><br><span class="line">  <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="built_in">dynamic</span>&gt; toJson() =&gt; _$UserToJson(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有了上面设置，源码生成器将生成用于序列化 name 和 email 字段的 JSON 代码</p>
<ul>
<li>自定义命名策略</li>
</ul>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="comment">//显式关联JSON字段名与Model属性的对应关系 </span></span><br><span class="line"><span class="meta">@JsonKey</span>(name: <span class="string">&#x27;registration_date_millis&#x27;</span>)</span><br><span class="line"><span class="keyword">final</span> <span class="built_in">int</span> registrationDateMillis;</span><br></pre></td></tr></table></figure>

<ul>
<li>运行代码生成程序</li>
</ul>
<p>上面的代码会报错，必须运行代码生成器来生成序列化模板</p>
<ul>
<li>一次性生成</li>
</ul>
<p>在项目根目录运行 </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">flutter packages pub run build_runner build</span><br></pre></td></tr></table></figure>

<p>这触发了一次构建，会通过源文件，找出需要生成 Model 类的源文件（包含 @JsonSerializable标注的）来生成对应的 .g.dart 文件；可以将所有 Model 类放到一个目录，然后在该目录执行命令</p>
<ul>
<li>持续生成</li>
</ul>
<p>使用 <code>_watcher_</code> 使源代码生成更加方便，会监视我们项目中文件的变换，并在需要时自动构建必要的文件</p>
<p>在项目根目录运行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">flutter packages pub run build_runner watch</span><br></pre></td></tr></table></figure>

<p>只需启动一次观察，然后就会在后台运行</p>
<h5 id="11-7-2-自动化生成模板"><a href="#11-7-2-自动化生成模板" class="headerlink" title="11.7.2 自动化生成模板"></a>11.7.2 自动化生成模板</h5><p>。。。</p>
<ul>
<li>json_model 包</li>
</ul>
<p>笔者发布的 json_model 包，把包加入开发依赖后，便可以用一条命令，根据 json 文件生成 Dart 类</p>
]]></content>
  </entry>
  <entry>
    <title></title>
    <url>/2022/01/18/%E3%80%8AFlutter%E5%AE%9E%E6%88%98%E7%AC%AC%E4%BA%8C%E7%89%88%E3%80%8B%E5%9B%9B%EF%BC%9A%E5%B8%83%E5%B1%80%E7%B1%BB%E7%BB%84%E4%BB%B6/</url>
    <content><![CDATA[<p>title: 《Flutter实战第二版》四：布局类组件<br>abstract: 输入密码<br>message: 输入密码<br>date: 2022-01-18 12:17:35<br>tags: flutter<br>categories: flutter<br>password:</p>
<h3 id="4-布局类组件"><a href="#4-布局类组件" class="headerlink" title="4 布局类组件"></a>4 布局类组件</h3><h4 id="4-2-布局原理与约束"><a href="#4-2-布局原理与约束" class="headerlink" title="4.2 布局原理与约束"></a>4.2 布局原理与约束</h4><p>尺寸限制类容器用于限制容器大小，如 ConstrainedBox、SizedBox、UnconstrainedBox、AspectRatio等</p>
<p>Flutter 有两种布局模型<br>基于 RenderBox 的盒模型布局<br>基于 Sliver（RenderBox）按需加载列表布局</p>
<ul>
<li>布局流程</li>
</ul>
<p>上层组件向下层组件传递约束条件<br>下层组件确定自己的大小，然后告诉上层组件。注意下层组件的大小必须符合父组件的约束<br>上层组件确定下层组件相对于自身的偏移和确定自身的大小（大多数情况下会根据子组件的大小来确定自身大小）</p>
<p>比如，父组件传递给子组件的约束是“最大宽高不能超过100，最小宽高为0”，如果给子组件设宽高都为100，则子组件最终大小是 100*100，因为任何时候子组件都必须遵守父组件的约束</p>
<h5 id="4-2-1-BoxConstraints"><a href="#4-2-1-BoxConstraints" class="headerlink" title="4.2.1 BoxConstraints"></a>4.2.1 BoxConstraints</h5><p>盒模型布局过程中父渲染对象传递给子渲染对象的 <code>约束信息</code>，包含最大宽高信息，子组件大小需要在约束的范围内</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> BoxConstraints(&#123;</span><br><span class="line">  <span class="keyword">this</span>.minWidth = <span class="number">0.0</span>, <span class="comment">//最小宽度</span></span><br><span class="line">  <span class="keyword">this</span>.maxWidth = <span class="built_in">double</span>.infinity, <span class="comment">//最大宽度</span></span><br><span class="line">  <span class="keyword">this</span>.minHeight = <span class="number">0.0</span>, <span class="comment">//最小高度</span></span><br><span class="line">  <span class="keyword">this</span>.maxHeight = <span class="built_in">double</span>.infinity <span class="comment">//最大高度</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>BoxConstraints 还定义了便捷的构造函数</p>
<p>生成固定宽高的限制</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">constraints: BoxConstraints.tight(Size(<span class="number">100</span>, <span class="number">200</span>)),</span><br></pre></td></tr></table></figure>

<p>生成尽可能大的用以填充另一个容器的 BoxConstraints</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">constraints: BoxConstraints.expand(),</span><br></pre></td></tr></table></figure>

<h5 id="4-2-2-ConstrainedBox"><a href="#4-2-2-ConstrainedBox" class="headerlink" title="4.2.2 ConstrainedBox"></a>4.2.2 ConstrainedBox</h5><p>用于对子组件添加 <code>额外约束</code></p>
<p>实现一个最小高度为50，宽度尽可能大的红色容器</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="comment">//先定义一个背景色红色盒子，不指定宽高</span></span><br><span class="line">Widget redBox = DecoratedBox(</span><br><span class="line">    decoration: BoxDecoration(color: Colors.red),</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">body: Container(</span><br><span class="line">  child: ConstrainedBox(</span><br><span class="line">    constraints: BoxConstraints(</span><br><span class="line">      minWidth: <span class="built_in">double</span>.infinity,<span class="comment">//宽度尽可能大</span></span><br><span class="line">      minHeight: <span class="number">50.0</span>,<span class="comment">//最小高度50</span></span><br><span class="line">    ),</span><br><span class="line">    child: Container(</span><br><span class="line">      height: <span class="number">5</span>,</span><br><span class="line">      child: redBox,</span><br><span class="line">    ),</span><br><span class="line">  ),</span><br><span class="line">),</span><br></pre></td></tr></table></figure>

<p>虽然 Container 高度设置为 5 但最终高度是 50，正是 ConstrainedBox 最小高度限制生效了</p>
<p><img src="/%E3%80%8AFlutter%E5%AE%9E%E6%88%98%E7%AC%AC%E4%BA%8C%E7%89%88%E3%80%8B%E5%9B%9B%EF%BC%9A%E5%B8%83%E5%B1%80%E7%B1%BB%E7%BB%84%E4%BB%B6/WeChatb3dfacd2a03676594b4be71803e35712.png" alt="WeChatb3dfacd2a03676594b4be71803e35712"></p>
<h5 id="4-2-3-SizedBox"><a href="#4-2-3-SizedBox" class="headerlink" title="4.2.3 SizedBox"></a>4.2.3 SizedBox</h5><p>用于给子元素指定固定的宽高</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">SizedBox(</span><br><span class="line">  width: <span class="number">80</span>,</span><br><span class="line">  height: <span class="number">80</span>,</span><br><span class="line">  child: redBox,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>实际上 SizedBox 只是 ConstrainedBox 的一个定制</p>
<h5 id="4-2-4-多重限制"><a href="#4-2-4-多重限制" class="headerlink" title="4.2.4 多重限制"></a>4.2.4 多重限制</h5><p>如果组件有多个父级 ConstrainedBox 限制，最终哪个会生效？</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">ConstrainedBox(</span><br><span class="line">  constraints: BoxConstraints(minWidth: <span class="number">60.0</span>, minHeight: <span class="number">60.0</span>), <span class="comment">//父</span></span><br><span class="line">  child: ConstrainedBox(</span><br><span class="line">    constraints: BoxConstraints(minWidth: <span class="number">90.0</span>, minHeight: <span class="number">20.0</span>),<span class="comment">//子</span></span><br><span class="line">    child: redBox,</span><br><span class="line">  ),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>最终显示宽度 90，高度 60</p>
<p>多重限制时，对于 minWidth minHeight 是取父子中数值较大的</p>
<h5 id="4-2-5-UnconstrainedBox"><a href="#4-2-5-UnconstrainedBox" class="headerlink" title="4.2.5 UnconstrainedBox"></a>4.2.5 UnconstrainedBox</h5><p>子组件不再受父组件约束</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">body: Container(</span><br><span class="line">  child: ConstrainedBox(</span><br><span class="line">    constraints: BoxConstraints(minWidth: 60, minHeight: 100),</span><br><span class="line">    child: UnconstrainedBox(&#x2F;&#x2F;去除父级限制</span><br><span class="line">      child: ConstrainedBox(</span><br><span class="line">        constraints: BoxConstraints(minWidth: 90, minHeight: 20),</span><br><span class="line">        child: redBox,</span><br><span class="line">      ),</span><br><span class="line">    ),</span><br><span class="line">  ),</span><br><span class="line">),</span><br></pre></td></tr></table></figure>

<p>如果没有 UnconstrainedBox，那么根据多重限制的规则最终显示是 90x100<br>由于 UnconstrainedBox，去除了父级限制，最终按子 ConstrainedBox 限制来绘制 redBox，redBox 最终宽 90 高 20</p>
<p>实际开发中，如果已经使用了 SizedBox 或 ConstrainedBox 给子元素指定了固定宽高，但没有效果时，几乎可以断定，已经有父组件指定了约束</p>
<h5 id="4-2-6-其它约束类容器"><a href="#4-2-6-其它约束类容器" class="headerlink" title="4.2.6 其它约束类容器"></a>4.2.6 其它约束类容器</h5><p>AspectRatio，可以指定子组件的长宽比</p>
<p>LimitedBox，可以指定最大宽高</p>
<p>FractionallySizeBox，可以根据父容器宽高的百分比来设置子组件宽高</p>
<h4 id="4-3-线性布局"><a href="#4-3-线性布局" class="headerlink" title="4.3 线性布局"></a>4.3 线性布局</h4><p>线性布局中有两个定义对齐方式的枚举类 MainAxisAlignment 和 CrossAxisAlignment，分别代表主轴对齐和纵轴对齐</p>
<h5 id="4-3-1-Row"><a href="#4-3-1-Row" class="headerlink" title="4.3.1 Row"></a>4.3.1 Row</h5><p>可以沿水平方向排列其子 Widget</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Row(&#123;</span><br><span class="line">  ...  </span><br><span class="line">  TextDirection textDirection,    </span><br><span class="line">  MainAxisSize mainAxisSize = MainAxisSize.max,    </span><br><span class="line">  MainAxisAlignment mainAxisAlignment = MainAxisAlignment.start,</span><br><span class="line">  VerticalDirection verticalDirection = VerticalDirection.down,  </span><br><span class="line">  CrossAxisAlignment crossAxisAlignment = CrossAxisAlignment.center,</span><br><span class="line">  <span class="built_in">List</span>&lt;Widget&gt; children = <span class="keyword">const</span> &lt;Widget&gt;[],</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>textDirection 水平方向子组件的布局顺序，从左到右 TextDirection.ltr，从右到左 TextDirection.rtl </p>
<p>mainAxisSize 表示 Row 在主轴（水平）方向占用的空间，MainAxisSize.max 尽可能多的占用水平空间，MainAxisSize.min 尽可能少的占用水平空间</p>
<p>mainAxisAlignment 子组件在 Row 所占空间内对齐方式，MainAxisAlignment.start 表示沿着 textDirection 的初始方向对齐</p>
<p>verticalDirection 纵轴的对齐方向，默认 VerticalDirection.down 从上到下</p>
<p>crossAxisAlignment 子组件在纵轴方向对齐方式</p>
<h5 id="4-3-2-Column"><a href="#4-3-2-Column" class="headerlink" title="4.3.2 Column"></a>4.3.2 Column</h5><p>可以沿垂直方向排列其子组件</p>
<h4 id="4-4-弹性布局"><a href="#4-4-弹性布局" class="headerlink" title="4.4 弹性布局"></a>4.4 弹性布局</h4><p>弹性布局允许子组件按照一定比例来分配父容器空间</p>
<ul>
<li>Flex     </li>
</ul>
<p>Flex 组件可以沿着水平或垂直方向布局子组件，Row 和 Column 都继承自 Flex，参数基本相同，能使用 Flex 的地方都可以使用 Row 或 Column，它也可以和 Expanded 组件配合实现弹性布局</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Flex(&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">required</span> <span class="keyword">this</span>.direction, <span class="comment">//弹性布局的方向, Row默认为水平方向，Column默认为垂直方向</span></span><br><span class="line">  <span class="built_in">List</span>&lt;Widget&gt; children = <span class="keyword">const</span> &lt;Widget&gt;[],</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>Expanded</li>
</ul>
<p>只能作为 Flex 的孩子，它可以按比例扩伸 Flex 子组件所占用的空间</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> Expanded(&#123;</span><br><span class="line">  <span class="built_in">int</span> flex = <span class="number">1</span>, </span><br><span class="line">  <span class="keyword">required</span> Widget child,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>flex 为弹性系数，为 0 或 null，则 child 是没有弹性的，如果大于 0，所有的 Expand 按照其 flex 的比例来分割主轴的全部剩余空间</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">body: Column(</span><br><span class="line">  children: [</span><br><span class="line">    Flex(</span><br><span class="line">        direction: Axis.horizontal,</span><br><span class="line">        children: [</span><br><span class="line">          Expanded(</span><br><span class="line">              flex: <span class="number">1</span>,</span><br><span class="line">              child: Container(</span><br><span class="line">                height: <span class="number">30</span>,</span><br><span class="line">                color: Colors.red,</span><br><span class="line">              ),</span><br><span class="line">          ),</span><br><span class="line">          Expanded(</span><br><span class="line">              flex: <span class="number">2</span>,</span><br><span class="line">              child: Container(</span><br><span class="line">                height: <span class="number">30</span>,</span><br><span class="line">                color: Colors.green,</span><br><span class="line">              ),</span><br><span class="line">          )</span><br><span class="line">        ],</span><br><span class="line">    ),</span><br><span class="line">    Padding(</span><br><span class="line">        padding: EdgeInsets.only(top: <span class="number">20</span>),</span><br><span class="line">        child: SizedBox(</span><br><span class="line">          height: <span class="number">100</span>,</span><br><span class="line">          child: Flex(</span><br><span class="line">              direction: Axis.vertical,</span><br><span class="line">              children: [</span><br><span class="line">                Expanded(</span><br><span class="line">                    flex: <span class="number">2</span>,</span><br><span class="line">                    child: Container(</span><br><span class="line">                      height: <span class="number">30</span>,</span><br><span class="line">                      color: Colors.red,</span><br><span class="line">                    ),</span><br><span class="line">                ),</span><br><span class="line">                Spacer( <span class="comment">//Spacer 占用指定比例的空间</span></span><br><span class="line">                    flex: <span class="number">1</span>,</span><br><span class="line">                ),</span><br><span class="line">                Expanded(</span><br><span class="line">                    flex: <span class="number">1</span>,</span><br><span class="line">                    child: Container(</span><br><span class="line">                      height: <span class="number">30</span>,</span><br><span class="line">                      color: Colors.green,</span><br><span class="line">                    ),</span><br><span class="line">                ),</span><br><span class="line">              ],</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">    ),</span><br><span class="line">  ],</span><br><span class="line">),</span><br></pre></td></tr></table></figure>

<p><img src="/%E3%80%8AFlutter%E5%AE%9E%E6%88%98%E7%AC%AC%E4%BA%8C%E7%89%88%E3%80%8B%E5%9B%9B%EF%BC%9A%E5%B8%83%E5%B1%80%E7%B1%BB%E7%BB%84%E4%BB%B6/WeChatfbc763c47e927557d16a3e4f1bfe01c1.png" alt="WeChatfbc763c47e927557d16a3e4f1bfe01c1"></p>
<p>Spacer  的功能是占用指定比例的空间，只是 Expanded 的一个包装类</p>
<h4 id="4-5-流式布局"><a href="#4-5-流式布局" class="headerlink" title="4.5 流式布局"></a>4.5 流式布局</h4><p>Row 和 Column，如果子 widget 超出屏幕范围时，会溢出报错</p>
<p>超出屏幕范围会自动折行的布局称为流式布局，通过 Wrap 和 Flow 来支持</p>
<h5 id="4-5-1-Wrap"><a href="#4-5-1-Wrap" class="headerlink" title="4.5.1 Wrap"></a>4.5.1 Wrap</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Wrap(&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">this</span>.direction = Axis.horizontal,</span><br><span class="line">  <span class="keyword">this</span>.alignment = WrapAlignment.start, <span class="comment">//主轴方向对齐方式</span></span><br><span class="line">  <span class="keyword">this</span>.spacing = <span class="number">0.0</span>,		<span class="comment">//主轴方向子 widget 的间距</span></span><br><span class="line">  <span class="keyword">this</span>.runAlignment = WrapAlignment.start, <span class="comment">//纵轴方向对齐方式</span></span><br><span class="line">  <span class="keyword">this</span>.runSpacing = <span class="number">0.0</span>, <span class="comment">//纵轴方向的间距</span></span><br><span class="line">  <span class="keyword">this</span>.crossAxisAlignment = WrapCrossAlignment.start,</span><br><span class="line">  <span class="keyword">this</span>.textDirection,</span><br><span class="line">  <span class="keyword">this</span>.verticalDirection = VerticalDirection.down,</span><br><span class="line">  <span class="built_in">List</span>&lt;Widget&gt; children = <span class="keyword">const</span> &lt;Widget&gt;[],</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>例子</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">body: Wrap(</span><br><span class="line">  spacing: <span class="number">8</span>, <span class="comment">// 主轴(水平)方向间距</span></span><br><span class="line">  runSpacing: <span class="number">4</span>,<span class="comment">// 纵轴（垂直）方向间距</span></span><br><span class="line">  alignment: WrapAlignment.center,<span class="comment">//沿主轴方向居中</span></span><br><span class="line">  children: [</span><br><span class="line">    Chip(</span><br><span class="line">      avatar: CircleAvatar(backgroundColor: Colors.blue, child: Text(<span class="string">&quot;A&quot;</span>)),</span><br><span class="line">      label: Text(<span class="string">&quot;Hamilton&quot;</span>),</span><br><span class="line">    ),</span><br><span class="line">    Chip(</span><br><span class="line">      avatar: CircleAvatar(backgroundColor: Colors.blue, child: Text(<span class="string">&quot;M&quot;</span>)),</span><br><span class="line">      label: Text(<span class="string">&quot;Lafayette&quot;</span>),</span><br><span class="line">    ),</span><br><span class="line">    Chip(</span><br><span class="line">      avatar: CircleAvatar(backgroundColor: Colors.blue, child: Text(<span class="string">&quot;H&quot;</span>)),</span><br><span class="line">      label: Text(<span class="string">&quot;Mulligan&quot;</span>),</span><br><span class="line">    ),</span><br><span class="line">    Chip(</span><br><span class="line">      avatar: CircleAvatar(backgroundColor: Colors.blue, child: Text(<span class="string">&quot;J&quot;</span>)),</span><br><span class="line">      label: Text(<span class="string">&quot;Laurens&quot;</span>),</span><br><span class="line">    ),</span><br><span class="line">  ],</span><br><span class="line">),</span><br></pre></td></tr></table></figure>

<p><img src="/%E3%80%8AFlutter%E5%AE%9E%E6%88%98%E7%AC%AC%E4%BA%8C%E7%89%88%E3%80%8B%E5%9B%9B%EF%BC%9A%E5%B8%83%E5%B1%80%E7%B1%BB%E7%BB%84%E4%BB%B6/WeChat3d54f85053626129a97f139ca49e747e.png" alt="WeChat3d54f85053626129a97f139ca49e747e"></p>
<h5 id="4-5-2-Flow"><a href="#4-5-2-Flow" class="headerlink" title="4.5.2 Flow"></a>4.5.2 Flow</h5><p>一般很少使用 Flow，因为其过于复杂，需要自己实现子 widget 的位置转换，很多情况下首先要考虑 Wrap 是否满足需求</p>
<p>主要用于一些自定义布局策略或性能要求较高（如动画）的场景</p>
<h4 id="4-6-层叠布局"><a href="#4-6-层叠布局" class="headerlink" title="4.6 层叠布局"></a>4.6 层叠布局</h4><p>Flutter 中使用 Stack 和 Positioned 这两个组件来配合实现绝对定位，Stack 允许子组件堆叠，而 Positioned 用于根据 Stack 的四个角来确定子组件的位置</p>
<h5 id="4-6-1-Stack"><a href="#4-6-1-Stack" class="headerlink" title="4.6.1 Stack"></a>4.6.1 Stack</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Stack(&#123;</span><br><span class="line">  <span class="keyword">this</span>.alignment = AlignmentDirectional.topStart,</span><br><span class="line">  <span class="keyword">this</span>.textDirection,</span><br><span class="line">  <span class="keyword">this</span>.fit = StackFit.loose,<span class="comment">//未定位widget使用子组件大小</span></span><br><span class="line">  <span class="keyword">this</span>.overflow = Overflow.clip,</span><br><span class="line">  <span class="built_in">List</span>&lt;Widget&gt; children = <span class="keyword">const</span> &lt;Widget&gt;[],</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>aligment：没有指定定位（没有使用Positioned）或部分定位的子组件对齐方式</p>
<p>fit：用于确定没有定位的子组件如何去适应 Stack 的大小。StackFit.loose 表示使用子组件的大小，StackFit.expand 表示扩伸到 Stack 的大小</p>
<p>clipBehavior：决定对超出 Stack 显示空间的部分如何裁剪</p>
<h5 id="4-6-2-Positioned"><a href="#4-6-2-Positioned" class="headerlink" title="4.6.2 Positioned"></a>4.6.2 Positioned</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> Positioned(&#123;</span><br><span class="line">  Key? key,</span><br><span class="line">  <span class="keyword">this</span>.left, </span><br><span class="line">  <span class="keyword">this</span>.top,</span><br><span class="line">  <span class="keyword">this</span>.right,</span><br><span class="line">  <span class="keyword">this</span>.bottom,</span><br><span class="line">  <span class="keyword">this</span>.width,</span><br><span class="line">  <span class="keyword">this</span>.height,</span><br><span class="line">  <span class="keyword">required</span> Widget child,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>left、right、top、bottom 分别代表 Stack 左、右、上、下四边的距离。width、height 用于配合 left、right、top、bottom 来定位组件，水平方向时，只能指定 left、right、width 三个属性中的两个</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="comment">//通过ConstrainedBox来确保Stack占满屏幕</span></span><br><span class="line">ConstrainedBox(</span><br><span class="line">  constraints: BoxConstraints.expand(),</span><br><span class="line">  child: Stack(</span><br><span class="line">    alignment:Alignment.center , <span class="comment">//指定未定位或部分定位widget的对齐方式</span></span><br><span class="line">    children: &lt;Widget&gt;[</span><br><span class="line">      Container(</span><br><span class="line">        child: Text(<span class="string">&quot;Hello world&quot;</span>,style: TextStyle(color: Colors.white)),</span><br><span class="line">        color: Colors.red,</span><br><span class="line">      ),</span><br><span class="line">      Positioned(</span><br><span class="line">        left: <span class="number">18.0</span>,</span><br><span class="line">        child: Text(<span class="string">&quot;I am Jack&quot;</span>),</span><br><span class="line">      ),</span><br><span class="line">      Positioned(</span><br><span class="line">        top: <span class="number">18.0</span>,</span><br><span class="line">        child: Text(<span class="string">&quot;Your friend&quot;</span>),</span><br><span class="line">      )        </span><br><span class="line">    ],</span><br><span class="line">  ),</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》四：布局类组件/WeChatb7f223696d8793b8c8b7ad2a3a70efe0.png" alt="WeChatb7f223696d8793b8c8b7ad2a3a70efe0" style="zoom:80%;" />

<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Stack(</span><br><span class="line">  alignment:Alignment.center ,</span><br><span class="line">  fit: StackFit.expand, <span class="comment">//未定位widget占满Stack整个空间</span></span><br><span class="line">  children: &lt;Widget&gt;[</span><br><span class="line">    Positioned(</span><br><span class="line">      left: <span class="number">18.0</span>,</span><br><span class="line">      child: Text(<span class="string">&quot;I am Jack&quot;</span>),</span><br><span class="line">    ),</span><br><span class="line">    Container(child: Text(<span class="string">&quot;Hello world&quot;</span>,style: TextStyle(color: Colors.white)),</span><br><span class="line">      color: Colors.red,</span><br><span class="line">    ),</span><br><span class="line">    Positioned(</span><br><span class="line">      top: <span class="number">18.0</span>,</span><br><span class="line">      child: Text(<span class="string">&quot;Your friend&quot;</span>),</span><br><span class="line">    )</span><br><span class="line">  ],</span><br><span class="line">),</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》四：布局类组件/WeChat292f6adf44bfae8dcc84ab16cd736158.png" alt="WeChat292f6adf44bfae8dcc84ab16cd736158" style="zoom:80%;" />

<p>第二个文本组件没有定位，fit 属性会对它起作用，就会占满 Stack，Stack 子元素是堆叠的，所以第一个组件被第二个遮挡住了，第三个在最上层正常显示</p>
<h4 id="4-7-对齐与相对定位"><a href="#4-7-对齐与相对定位" class="headerlink" title="4.7 对齐与相对定位"></a>4.7 对齐与相对定位</h4><p>Stack 和 Positioned，我们可以指定一个或多个子元素相对父元素各个边的偏移，并且可以堆叠；如果只想简单调整下一个子元素在父元素中的位置的话使用 Align 组件更简单</p>
<h5 id="4-7-1-Align"><a href="#4-7-1-Align" class="headerlink" title="4.7.1 Align"></a>4.7.1 Align</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Align(&#123;</span><br><span class="line">  Key key,</span><br><span class="line">  <span class="keyword">this</span>.alignment = Alignment.center,</span><br><span class="line">  <span class="keyword">this</span>.widthFactor,</span><br><span class="line">  <span class="keyword">this</span>.heightFactor,</span><br><span class="line">  Widget child,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>widthFactor，heightFactor 用于确定 Align 组件本身宽高属性，是两个缩放因子，如果为 null，则组件的宽高会占用尽可能多的空间</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">body: Container(</span><br><span class="line">  width: <span class="number">120</span>,</span><br><span class="line">  height: <span class="number">120</span>,</span><br><span class="line">  color: Colors.red,</span><br><span class="line">  child: Align(</span><br><span class="line">    alignment: Alignment.topRight,</span><br><span class="line">    child: FlutterLogo(size: <span class="number">60</span>),</span><br><span class="line">  ),</span><br><span class="line">),</span><br><span class="line"><span class="comment">//相同效果 FlutterLogo宽高为60 则最终宽高都为 120</span></span><br><span class="line">Align(</span><br><span class="line">  widthFactor: <span class="number">2</span>,<span class="comment">//确定Align组件宽度 2*子组件宽60=120</span></span><br><span class="line">  heightFactor: <span class="number">2</span>,</span><br><span class="line">  alignment: Alignment.topRight,</span><br><span class="line">  child: FlutterLogo(size: <span class="number">60</span>),</span><br><span class="line">),</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》四：布局类组件/WeChat8615b0b3da0d913f7ac3f52a0b453f34.png" alt="WeChat8615b0b3da0d913f7ac3f52a0b453f34" style="zoom:80%;" />

<ul>
<li>Alignment</li>
</ul>
<p>继承自 AlignmentGeometry，x y 分别表示在水平和垂直方向偏移</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Alignment(this.x, this.y)</span><br></pre></td></tr></table></figure>

<p>会以矩形中心点作为原点，x y 值从 -1 到 1 分别代表矩形左边到右边的距离和顶部到底部的距离，Alignment(-1,-1) 代表左上角顶点</p>
<ul>
<li>FractionalOffset</li>
</ul>
<p>FractionalOffset 继承自 Alignment，唯一区别就是坐标原点不同，坐标原点为矩形左侧顶点</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Container(</span><br><span class="line">  height: <span class="number">120.0</span>,</span><br><span class="line">  width: <span class="number">120.0</span>,</span><br><span class="line">  color: Colors.blue[<span class="number">50</span>],</span><br><span class="line">  child: Align(</span><br><span class="line">    alignment: FractionalOffset(<span class="number">0.2</span>, <span class="number">0.6</span>),</span><br><span class="line">    child: FlutterLogo(</span><br><span class="line">      size: <span class="number">60</span>,</span><br><span class="line">    ),</span><br><span class="line">  ),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h5 id="4-7-2-Align-和-Stack-对比"><a href="#4-7-2-Align-和-Stack-对比" class="headerlink" title="4.7.2 Align 和 Stack 对比"></a>4.7.2 Align 和 Stack 对比</h5><p>定位参考系统不同；Stack/Positioned 定位参考系可以是父容器的四个顶点，Align 则需要通过 aligment 参数来确定坐标原点</p>
<p>Stack 可以有多个子元素，并且子元素可以堆叠，而 Align 只能有一个子元素，不存在堆叠</p>
<h5 id="4-7-3-Center-组件"><a href="#4-7-3-Center-组件" class="headerlink" title="4.7.3 Center 组件"></a>4.7.3 Center 组件</h5><p>Center 继承自 Align，比 Align 少了一个 aligment 参数</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">...<span class="comment">//省略无关代码</span></span><br><span class="line">DecoratedBox(</span><br><span class="line">  decoration: BoxDecoration(color: Colors.red),</span><br><span class="line">  child: Center(</span><br><span class="line">    child: Text(<span class="string">&quot;xxx&quot;</span>),</span><br><span class="line">  ),</span><br><span class="line">),</span><br><span class="line">DecoratedBox(</span><br><span class="line">  decoration: BoxDecoration(color: Colors.red),</span><br><span class="line">  child: Center(</span><br><span class="line">    widthFactor: <span class="number">1</span>,</span><br><span class="line">    heightFactor: <span class="number">1</span>,</span><br><span class="line">    child: Text(<span class="string">&quot;xxx&quot;</span>),</span><br><span class="line">  ),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》四：布局类组件/WeChat5e3ebd6ef218ee6f1388e9e97b95ecb0.png" alt="WeChat5e3ebd6ef218ee6f1388e9e97b95ecb0" style="zoom:80%;" />

<ul>
<li>总结</li>
</ul>
<p>在需要指定一些精确的偏移时优先使用 FractionalOffset，因为它的坐标原点和布局系统相同</p>
<h4 id="4-8-LayoutBuilder、AfterLayout"><a href="#4-8-LayoutBuilder、AfterLayout" class="headerlink" title="4.8 LayoutBuilder、AfterLayout"></a>4.8 LayoutBuilder、AfterLayout</h4><h5 id="4-8-1-LayoutBuilder"><a href="#4-8-1-LayoutBuilder" class="headerlink" title="4.8.1 LayoutBuilder"></a>4.8.1 LayoutBuilder</h5><p>通过  LayoutBuilder 我们可以在布局过程中拿到父组件传递的约束信息，然后可以根据约束信息动态的构建不同的布局</p>
<p>例子：当当前可用宽度小于200时，将子组件显示为一列，否则显示为两列</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResponsiveColumn</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ResponsiveColumn(&#123;Key? key, <span class="keyword">required</span> <span class="keyword">this</span>.children&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">List</span>&lt;Widget&gt; children;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="comment">// 通过 LayoutBuilder 拿到父组件传递的约束，然后判断 maxWidth 是否小于200</span></span><br><span class="line">    <span class="keyword">return</span> LayoutBuilder(</span><br><span class="line">      builder: (BuildContext context, BoxConstraints constraints) &#123;</span><br><span class="line">        <span class="keyword">if</span> (constraints.maxWidth &lt; <span class="number">200</span>) &#123;</span><br><span class="line">          <span class="comment">// 最大宽度小于200，显示单列</span></span><br><span class="line">          <span class="keyword">return</span> Column(children: children, mainAxisSize: MainAxisSize.min);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 大于200，显示双列</span></span><br><span class="line">          <span class="keyword">var</span> _children = &lt;Widget&gt;[];</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; children.length; i += <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i + <span class="number">1</span> &lt; children.length) &#123;</span><br><span class="line">              _children.add(Row(</span><br><span class="line">                children: [children[i], children[i + <span class="number">1</span>]],</span><br><span class="line">                mainAxisSize: MainAxisSize.min,</span><br><span class="line">              ));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              _children.add(children[i]);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> Column(children: _children, mainAxisSize: MainAxisSize.min);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LayoutBuilderRoute</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> LayoutBuilderRoute(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">var</span> _children = <span class="built_in">List</span>.filled(<span class="number">6</span>, Text(<span class="string">&quot;A&quot;</span>));</span><br><span class="line">    <span class="comment">// Column在本示例中在水平方向的最大宽度为屏幕的宽度</span></span><br><span class="line">    <span class="keyword">return</span> Column(</span><br><span class="line">      children: [</span><br><span class="line">        <span class="comment">// 限制宽度为190，小于 200</span></span><br><span class="line">        SizedBox(width: <span class="number">190</span>, child: ResponsiveColumn(children: _children)),</span><br><span class="line">        ResponsiveColumn(children: _children),</span><br><span class="line">        LayoutLogPrint(child:Text(<span class="string">&quot;xx&quot;</span>)) <span class="comment">// 下面介绍</span></span><br><span class="line">      ],</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以使用 LayoutBuilder 来根据设备的尺寸来实现响应式布局</p>
<p>LayoutBuilder 可以帮助排查问题，如遇到布局问题或想调试组件树中一个节点布局的约束时</p>
<h5 id="4-8-2-AfterLayout"><a href="#4-8-2-AfterLayout" class="headerlink" title="4.8.2 AfterLayout"></a>4.8.2 AfterLayout</h5><p>作者封装的组件，可以在子组件布局完成后执行一个回调</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">AfterLayout(</span><br><span class="line">  callback: (RenderAfterLayout ral) &#123;</span><br><span class="line">    <span class="built_in">print</span>(ral.size); <span class="comment">//子组件的大小</span></span><br><span class="line">    <span class="built_in">print</span>(ral.offset);<span class="comment">// 子组件在屏幕中坐标</span></span><br><span class="line">  &#125;,</span><br><span class="line">  child: Text(<span class="string">&#x27;flutter@wendux&#x27;</span>),</span><br><span class="line">),</span><br></pre></td></tr></table></figure>

































]]></content>
  </entry>
  <entry>
    <title>音视频开发</title>
    <url>/2021/08/03/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%BC%80%E5%8F%91/</url>
    <content><![CDATA[<h4 id="音视频基础"><a href="#音视频基础" class="headerlink" title="音视频基础"></a>音视频基础</h4><h5 id="数字音频"><a href="#数字音频" class="headerlink" title="数字音频"></a>数字音频</h5><p>将模拟信号转换为数字信号的过程</p>
<ul>
<li>采样</li>
</ul>
<p>在时间轴上对信号进行数字化。</p>
<p>根据奈奎斯特定理（也称为采样定理），按比声音最高频率高2倍以上的频率对声音进行采样（也称为AD转换）</p>
<p>比如：对高质量音频信号，其频率范围是20Hz~20kHz（人耳能够听到的频率范围），所以采样频率一般为44.1kHz，这样就可以保证采样声音达到20kHz也能被数字化，从而使得经过数字化处理之后，人耳听到的声音质量不会被降低</p>
<p>44.1kHz就是代表1秒会采样44100次</p>
<ul>
<li>量化</li>
</ul>
<p>在幅度轴上对信号进行数字化</p>
<ul>
<li>编码</li>
</ul>
<p>按照一定的格式记录采样和量化后的数字数据</p>
<p>音频格式有很多种，音频裸数据格式就是脉冲编码调制（PCM）数据。</p>
<p>描述一段PCM数据一般需要以下几个概念：<br>量化格式（sampleFormat）<br>采样率（sampleRate）<br>声道数（channel）</p>
<p>以CD音质为例：量化格式为16比特（2字节），采样率为44100，声道数为2，这些信息就描述</p>
<p>CD音质的比特率：即1秒时间内的比特数目，衡量音频数据单位时间内的容量大小<br>44100 * 16 * 2 = 1378.125kbps</p>
<p>那么1分钟内，这类CD音质的数据需要占据多大内存空间？<br>1378.125 * 60 / 8 / 1024 = 10.09M</p>
<p>如果sampleFormat更加精确（比如用4字节来描述一个采样）或者sampleRate更加密集（比如48kHz的采样率）那么所占的存储空间会更大，同时能够描述的声音细节会越精确</p>
<h5 id="音频编码"><a href="#音频编码" class="headerlink" title="音频编码"></a>音频编码</h5><p>通过计算CD音质的数据采样，每分钟需要存储10.1M，若要在网络中实时在线传播的话，数据量可能就太大了，需要进行压缩编码</p>
<p>压缩算法包括有损压缩和无损压缩，无损压缩是指解压后的数据可以完全恢复，有损压缩解压后的数据不能完全恢复，会丢失一部分信息，压缩比越小，丢失的信息就越多</p>
<p>压缩编码实际上是压缩掉冗余信号，冗余信号是指不能被人耳感知到的信号</p>
<p>常见压缩编码格式：</p>
<ol>
<li>WAV编码</li>
</ol>
<p>在PCM数据格式前加上44字节，分辨用来描述PCM的采样率、声道数、数据格式等信息</p>
<p>特点：音质非常好，大量软件都支持其播放</p>
<p>适合场所：多媒体开发中的中间文件，保存音乐和音效素材</p>
<ol start="2">
<li>MP3编码</li>
</ol>
<p>具有不错的压缩比，听感上非常解决WAV文件</p>
<p>特点：音质在128kbps/s以上表现还不错，压缩比比较高，大量软件和硬件都支持，兼容性好</p>
<p>适合场所：搞比特率下对兼容性有要求的音乐欣赏</p>
<ol start="3">
<li>AAC编码</li>
</ol>
<p>目前比较热门的有损压缩编码技术，并衍生出了LC-AAC、HE-AAC、HE-AAC v2三种主要编码格式。</p>
<p>LC-AAC 是比较传统的AAC，主要应用于中高码率场景编码（&gt;=80Kbit/s）</p>
<p>HE-AAC 主要应用于低码率场景的编码（&lt;=80Kbit/s）</p>
<p>HE-AAC v2 主要应用于低码率场景的编码（&lt;=48Kbit/s）</p>
<p>特点：在小于128Kbit/s的码率下表现优异，多用于视频中的音频编码</p>
<ol start="4">
<li>Ogg编码</li>
</ol>
<p>一种非常有潜力的编码，各种码率下都有比较优秀的表现，尤其在中低码率场景下。可以用更下的码率达到更好的音质，128Kbit/s的Ogg币192Kbit/s甚至更高码率的MP3还要出色，但目前还没有媒体服务软件的支持</p>
<p>特点：可以用比MP3更小的码率实现比MP3更好的音质，高中低码率下均有良好表现，兼容性不够好，流媒体特性不支持</p>
<p>适用场景：语音聊天的音频消息场景</p>
<h5 id="视频编码"><a href="#视频编码" class="headerlink" title="视频编码"></a>视频编码</h5><p>视频压缩也是通过去除冗余信息来进行压缩的</p>
<p>使用帧间编码技术可以去除时间上冗余信息</p>
<p>使用帧内编码技术可以去除空间上冗余信息</p>
<h5 id="编码概念"><a href="#编码概念" class="headerlink" title="编码概念"></a>编码概念</h5><p>MPEG 算法适用于动态视频的压缩算法，它除了对单幅图像进行编码外，还利用图像序列中的相关原则去除冗余，大大提高视频压缩比。</p>
<p>MPEG主要包括几个版本：Mpeg1（用于VCD）、Mpeg2（用于DVD）、Mpeg4 AVC（现在流媒体使用最多的就是它了）</p>
<p>相比较与ISO指定的MPEG的视频压缩标准，ITU-T制定的H.261、H.262、H.263、H.264一系列视频编码标准是一套单独的体系。其中H.264集中了以往标准的所有有点，采用简洁设计，使得它比Mpeg4更容易推广，现在使用最多的就是H.264标准</p>
<ul>
<li>I帧</li>
</ul>
<p>帧内编码帧，</p>
<ul>
<li><p>P帧</p>
</li>
<li><p>B帧</p>
</li>
</ul>
<h4 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h4><p>项目增加C++支持，OC语法支持混编，把引用C++的OC类后缀名改为.mm，就可以和C++一块编译了</p>
<p>LAME 一种MP3编码引擎，转码成MP3格式的音频文件时，最常用的就是LAME库</p>
<p>编译LAME，<a href="https://lame.sourceforge.io/download.php">LAME</a> 下载不下来，使用别人编译好的版本 <a href="https://github.com/JIANHUI2015/RemoteIODemo">lame </a> 两个文件 lame.h 和 libmp3lame.a，拖进项目就可以了</p>
<h4 id="AudioUnit"><a href="#AudioUnit" class="headerlink" title="AudioUnit"></a>AudioUnit</h4><p>iOS 平台上所有的音频框架底层都是基于 AudioUnit 实现的</p>
<p>较高层次的音频框架包括：Mediia Player、AVFoundation、OpenAL、AudioToolbox，这些框架都封装了 AudioUnit，提供了更高层次的API（功能更少，职责更单一接口）</p>
<p><img src="/2021/08/03/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%BC%80%E5%8F%91/AudioUnit.png" alt="AudioUnit"></p>
<p>如果对音频需要更高成都的控制、性能以及灵活性，或者想要使用一些特殊功能（回声消除）时，可以直接使用 AudioUnit API，以下场景更适合使用 AudioUnit</p>
<ul>
<li>想使用低延迟的音频 I/O（input或者output）比如说 VoIP 的应用场景下</li>
<li>多路声音的合成并且回放，比如游戏或者音乐合成器的应用</li>
<li>使用 AudioUnit 里提供的特殊功能，比如：回声消除、Mix两轨音频、以及均衡器、压缩器、混响器等效果器</li>
<li>需要图状结构来处理音频，可以将音频处理模块组装到灵活的图状结构中</li>
</ul>
<h6 id="AudioSession"><a href="#AudioSession" class="headerlink" title="AudioSession"></a>AudioSession</h6><p>音频会话，用于管理与获取 iOS 设备音频的硬件信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">AVAudioSession *audioSession &#x3D; [AVAudioSession sharedInstance];</span><br><span class="line">NSError *error &#x3D; nil;</span><br><span class="line">&#x2F;&#x2F;设置以何种方式使用音频硬件</span><br><span class="line">[audioSession setCategory:AVAudioSessionCategoryPlayAndRecord error:&amp;error];</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;设置I&#x2F;O的Buffer，Buffer越小则说明延迟越低</span><br><span class="line">NSTimeInterval bufferDuration &#x3D; 0.002;</span><br><span class="line">[audioSession setPreferredIOBufferDuration:bufferDuration error:&amp;error];</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;设置采样频率 让硬件设备按照设置的采样频率来采集或者播放音频</span><br><span class="line">double hwSampleRate &#x3D; 44100.0;</span><br><span class="line">[audioSession setPreferredSampleRate:hwSampleRate error:&amp;error];</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;设置完所有参数之后就可以激活 AudioSession</span><br><span class="line">[audioSession setActive:YES error:&amp;error];</span><br></pre></td></tr></table></figure>

<h6 id="构建-AudioUnit"><a href="#构建-AudioUnit" class="headerlink" title="构建 AudioUnit"></a>构建 AudioUnit</h6><p>创建并启用 AudioSession 音频会话之后就可以构建 AudioUnit 了</p>
<p>需要指定类型（Type）、子类型（subtype）以及厂商（Manufacture），利用三个变量可以完整描述一个 AudioUnit 了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">AudioComponentDescription ioUnitDescription;</span><br><span class="line">ioUnitDescription.componentType &#x3D; kAudioUnitType_Output;</span><br><span class="line">ioUnitDescription.componentSubType &#x3D; kAudioUnitSubType_RemoteIO;</span><br><span class="line">&#x2F;&#x2F;比较固定 直接kAudioUnitManufacturer_Apple就可以了</span><br><span class="line">ioUnitDescription.componentManufacturer &#x3D; kAudioUnitManufacturer_Apple;</span><br><span class="line">ioUnitDescription.componentFlags &#x3D; 0;</span><br><span class="line">ioUnitDescription.componentFlagsMask &#x3D; 0;</span><br></pre></td></tr></table></figure>

<p>上面代码构造了 RemoteIO 类型的 AudioUnit 描述的结构体，下面构造 AudioUnit</p>
<p>两种方式构建：1. 使用 AudioUnit 裸的创建方式 2. 使用 AUGraph 和 AUNode 的 Wrapper 来构建</p>
<ol>
<li>裸的创建方式</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;根据 AudioUnit 的描述，找出实际的 AudioUnit 类型</span><br><span class="line">AudioComponent ioUnitRef &#x3D; AudioComponentFindNext(NULL, &amp;ioUnitDescription);</span><br><span class="line">&#x2F;&#x2F;声明一个 AudioUnit 引用</span><br><span class="line">AudioUnit ioUnitInstance;</span><br><span class="line">&#x2F;&#x2F;根据类型创建 AudioUnit 实例</span><br><span class="line">AudioComponentInstanceNew(ioUnitRef, &amp;ioUnitInstance);</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>AUGraph 创建方式（扩展性更高）</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;声明并实例化一个AUGraph</span><br><span class="line">AUGraph processingGraph;</span><br><span class="line">NewAUGraph(&amp;processingGraph);</span><br><span class="line">&#x2F;&#x2F;按照AudioUnit的描述在AUGraph中增加一个AUNode</span><br><span class="line">AUNode ioNode;</span><br><span class="line">AUGraphAddNode(processingGraph, &amp;ioUnitDescription, &amp;ioNode);</span><br><span class="line">&#x2F;&#x2F;打开AUGraph，必须在获取AudioUnit之前打开整个AUGraph</span><br><span class="line">AUGraphOpen(processingGraph);</span><br><span class="line">&#x2F;&#x2F;在AUGraph中的某个Node里获得AudioUnit的引用</span><br><span class="line">AudioUnit ioUnit;</span><br><span class="line">AUGraphNodeInfo(processingGraph, ioNode, NULL, &amp;ioUnit);</span><br></pre></td></tr></table></figure>

<h6 id="AudioUnit-通用参数"><a href="#AudioUnit-通用参数" class="headerlink" title="AudioUnit 通用参数"></a>AudioUnit 通用参数</h6><p>以 RemoteIO  为例，RemoteIO 这个 AudioUnit 是与硬件 IO 相关的一个 Unit，分为输入和输出端，输入端一般是麦克风，输出端一般指扬声器或者耳机，如果需要同事使用输入输出，即K歌应用中的耳返功能，则需要做一些设置将他们连接起来</p>
<img src="remoteio.png" alt="remoteio" style="zoom:90%;" />

<p>RemoteIO Unit 分为 Element0 和 Element 1，Element0 控制输出端，Element1 控制输入端，每个 Element 又分为 Input Scope 和 Output Scope。</p>
<p>如果想要使用扬声器的声音播放功能，必须将这个 Unit 的 Element0 的 OutputScope 和 Speaker 进行连接</p>
<p>如果想要使用麦克风录音功能，必须将这个Unit 的 Element1 的 InputScope 和麦克风进行连接</p>
<p>使用扬声器代码：把 RemoteIOUnit的 Element0 的 OutputScope 连接到 Speaker 上，会返回一个 OSStatus 值，使用自定义 CheckStatus 函数判断错误</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">OSStatus status &#x3D; noErr;</span><br><span class="line">UInt32 oneFlag &#x3D; 1;</span><br><span class="line">&#x2F;&#x2F;Element 0</span><br><span class="line">UInt32 busZero &#x3D; 0;</span><br><span class="line">status &#x3D; AudioUnitSetProperty(ioUnit,</span><br><span class="line">                              kAudioOutputUnitProperty_EnableIO,</span><br><span class="line">                              kAudioUnitScope_Output,</span><br><span class="line">                              busZero,</span><br><span class="line">                              &amp;oneFlag,</span><br><span class="line">                              sizeof(oneFlag));</span><br><span class="line">&#x2F;&#x2F;自定义的CheckStatus函数来判断错误并输出</span><br><span class="line">CheckStatus(status, @&quot;Could not Connect To Speaker&quot;, YES);</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CheckStatus</span><span class="params">(OSStatus status, NSString *message, BOOL fatal)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (status != noErr) &#123;</span><br><span class="line">        <span class="keyword">char</span> fourCC[<span class="number">16</span>];</span><br><span class="line">        *(UInt32 *)fourCC = CFSwapInt32HostToBig(status);</span><br><span class="line">        fourCC[<span class="number">4</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">isprint</span>(fourCC[<span class="number">0</span>]) &amp;&amp;</span><br><span class="line">            <span class="built_in">isprint</span>(fourCC[<span class="number">1</span>]) &amp;&amp;</span><br><span class="line">            <span class="built_in">isprint</span>(fourCC[<span class="number">2</span>]) &amp;&amp;</span><br><span class="line">            <span class="built_in">isprint</span>(fourCC[<span class="number">3</span>])) &#123;</span><br><span class="line">            NSLog(@<span class="string">&quot;%@: %s&quot;</span>, message, fourCC);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            NSLog(@<span class="string">&quot;%@: %d&quot;</span>, message, (<span class="keyword">int</span>)status);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (fatal) &#123;</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启用麦克风：把 RemoteIOUnit 的 Element1 的 InputScope 连接上麦克风</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;Element 1</span><br><span class="line">UInt32 busOne &#x3D; 1;</span><br><span class="line">AudioUnitSetProperty(ioUnit,</span><br><span class="line">                     kAudioOutputUnitProperty_EnableIO,</span><br><span class="line">                     kAudioUnitScope_Input,</span><br><span class="line">                     busOne,</span><br><span class="line">                     &amp;oneFlag,</span><br><span class="line">                     sizeof(oneFlag));</span><br></pre></td></tr></table></figure>

<p>连接成功后，就该给 AudioUnit 设置数据格式了，AudioUnit 数据格式分为输入和输出两个部分</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;设置AudioUnit数据格式 AudioStreamBasicDescription描述音视频具体格式</span><br><span class="line">UInt32 bytesPerSample &#x3D; sizeof(Float32);</span><br><span class="line">AudioStreamBasicDescription asbd;</span><br><span class="line">bzero(&amp;asbd, sizeof(asbd));</span><br><span class="line"></span><br><span class="line">double _samplerRate &#x3D; 44100.0;</span><br><span class="line">UInt32 channels &#x3D; 2;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;指定音频的编码格式 此处 PCM</span><br><span class="line">asbd.mFormatID &#x3D; kAudioFormatLinearPCM;</span><br><span class="line">&#x2F;&#x2F;采样率</span><br><span class="line">asbd.mSampleRate &#x3D; _samplerRate;</span><br><span class="line">&#x2F;&#x2F;声道数 1单身到 2立体声</span><br><span class="line">asbd.mChannelsPerFrame &#x3D; channels;</span><br><span class="line">&#x2F;&#x2F;每个Packers有几个Frame</span><br><span class="line">asbd.mFramesPerPacket &#x3D; 1;</span><br><span class="line">&#x2F;&#x2F;mFormatFlags 描述声音表示格式的参数</span><br><span class="line">&#x2F;&#x2F;kAudioFormatFlagsNativeFloatPacked 指定每个sample的表示格式是Float格式；</span><br><span class="line">&#x2F;&#x2F;kAudioFormatFlagIsNonInterleaved   左右声道是非交错存放的</span><br><span class="line">&#x2F;&#x2F;实际的音频数据会存储在一个 AudioBufferList结构中的变量mBuffers中，如果mFormatFlags指定的是 NonInterleaved，那么左声道就会在mBuffers[0]里面，右声道就会在 mBuffers[1]里面</span><br><span class="line">asbd.mFormatFlags &#x3D; kAudioFormatFlagsNativeFloatPacked | kAudioFormatFlagIsNonInterleaved;</span><br><span class="line">&#x2F;&#x2F;一个声道的音频数据用多少位来表示</span><br><span class="line">asbd.mBitsPerChannel &#x3D; 8 * bytesPerSample;</span><br><span class="line">&#x2F;&#x2F;每一帧有多少字节 mBytesPerFrame和mBytesPerPacket根据mFormatFlags来分配</span><br><span class="line">&#x2F;&#x2F;NonInterleaved情况下bytesPerSample(因为左右声道分开存放的)；Interleaved的话bytesPerSample * channels(因为左右声道是交错存放)</span><br><span class="line">asbd.mBytesPerFrame &#x3D; bytesPerSample;</span><br><span class="line">&#x2F;&#x2F;每个包有多少字节</span><br><span class="line">asbd.mBytesPerPacket &#x3D; bytesPerSample;</span><br></pre></td></tr></table></figure>

<p>构造好了 BasicDescription 结构体，将结构体设置给对应 AudioUnit</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;构造好了BasicDescription结构体，将这结构体设置给对应的AudioUnit</span><br><span class="line">AudioUnitSetProperty(ioUnit,</span><br><span class="line">                     kAudioUnitProperty_StreamFormat,</span><br><span class="line">                     kAudioUnitScope_Output, 1,</span><br><span class="line">                     &amp;asbd, sizeof(asbd));</span><br></pre></td></tr></table></figure>



<ul>
<li>kAudioOutputUnitProperty_EnableIO 用于启用或禁用 I/O Unit上的输入输出，默认启用输出但禁用输入</li>
<li>kAudioUnitProperty_ElementCount 配置 Mixer Unit上的输入元素数量</li>
<li>kAudioUnitProperty_MaximumFramesPerSlice 指定音频数据最大帧数</li>
<li>kAudioUnitProperty_StreamFormat 指定特定音频单元输入或输出总线的音频流数据格式</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">UInt32 maximumFramesPerSlice &#x3D; 4096;</span><br><span class="line">AudioUnitSetProperty (</span><br><span class="line">              _ioUnit,</span><br><span class="line">              kAudioUnitProperty_MaximumFramesPerSlice,</span><br><span class="line">              kAudioUnitScope_Global,0,</span><br><span class="line">              &amp;maximumFramesPerSlice,</span><br><span class="line">              sizeof (maximumFramesPerSlice));</span><br></pre></td></tr></table></figure>

<p>Global Scope适用于整个AudioUnit，不与任何特定音频流相关，只有1个元素即0，某些属性，如每个切片最大帧数，仅适用于 Global Scope</p>
<p>设置音频数据流格式</p>
<img src="音视频开发/IOWithoutRenderCallback.png" alt="IOWithoutRenderCallback" style="zoom:70%;" />













<h6 id="AudioUnit-分类"><a href="#AudioUnit-分类" class="headerlink" title="AudioUnit 分类"></a>AudioUnit 分类</h6><ol>
<li>Effect Unit</li>
</ol>
<p>类型是 <code>kAudioUnitType_Effect</code>，主要提供声音特效处理的功能，子类型如下：</p>
<p>均衡器效果：子类型是 <code>kAudioUnitSubType_NBandEQ</code>，主要作用 是为声音的某些频带增强或者减弱能量，该效果器需要指定多个频带， 然后为各个频带设置宽度以及增益，最终将改变声音在频域上的能量分布</p>
<p>压缩效果器：子类型是 <code>kAudioUnitSubType_DynamicsProcessor</code>，主 要作用是当声音较小的时候可以提高声音的能量，当声音的能量超过了 设置的阈值时，可以降低声音的能量，当然应合理地设置作用时间、释 放时间以及触发值，使得最终可以将声音在时域上的能量压缩到一定范 围之内</p>
<p>混响效果器：子类型是 <code>kAudioUnitSubType_Reverb2</code>，对于人声处 理来讲这是非常重要的效果器，可以想象自己身处在一个空房子中，如 果有非常多的反射声和原始声音叠加在一起，那么从听感上可能会更有 震撼力，但是同时原始声音也会变得更加模糊，原始声音的一些细节会 被遮盖掉，所以混响设置的大或者小对于不同的人来讲会很不一致，可以根据自己的喜好来进行设置</p>
<p>Effect Unit下最常使用的就是上述三种效果器，其下还有很多种子类型的效果器，像高通(High Pass)、低通(Low Pass)、带通 (Band Pass)、延迟(Delay)、压限(Limiter)等效果器</p>
<ol start="2">
<li>Mixer Units</li>
</ol>
<p>类型是 <code>kAudioUnitType_Mixer</code>，主要提供 Mix 多路声音的功能，子类型如下：</p>
<p>3D Mixer：该效果器在移动身上无法使用</p>
<p>MultiChannelMixer：子类型是 <code>kAudioUnitSubType_MultiChannelMixer</code>，它是多路声音混音的效果器，可以接收多路音频的输入，还可以 分别调整每一路音频的增益与开关，并将多路音频合并成一路，该效果 器在处理音频的图状结构中非常有用</p>
<p>OutputScope仅设置采样率</p>
<p>默认情况下 kAudioUnitProperty_MaximumFramesPerSlice 设置为1024，如果在屏幕锁定情况下播放音频，必须增加此属性值，除非音频输入处于活动状态</p>
<p>如果音频活动处于活动状态，无需为 kAudioUnitProperty_MaximumFramesPerSlice 设置值</p>
<p>如果音频输入不活跃，将此属性设置为 4096</p>
<ol start="3">
<li>I/O Units</li>
</ol>
<p>类型是 <code>kAudioUnitType_Output</code>，主要提供的就是I/O的功能</p>
<p>RemoteIO：子类型是 <code>kAudioUnitSubType_RemoteIO</code>，是用来采集音频与播放音频的</p>
<p>Generic Output：子类型是 <code>kAudioUnitSubType_GenericOutput</code>，当 开发者需要进行离线处理，或者说在AUGraph中不使用Speaker(扬声 器)来驱动整个数据流，而是希望使用一个输出(可以放入内存队列或 者进行磁盘I/O操作)来驱动数据流时，就使用该子类型</p>
<ol start="4">
<li>Format Converter Units</li>
</ol>
<p>类型是 <code>kAudioUnitType_FormatConverter</code>，主要用于提供格式转换 的功能，比如:采样格式由Float到SInt16的转换、交错和平铺的格式转换、单双声道的转换等</p>
<p>AUConverter：子类型是 <code>kAudioUnitSubType_AUConverter</code>，当某些效果器对输入的音频格式有 明确的要求时(比如3D Mixer Unit就必须使用UInt16格式的sample)， 或者开发者将音频数据输入给一些其他的编码器进行编码，又或者开发 者想使用SInt16格式的PCM裸数据在其他CPU上进行音频算法计算等的 场景下，就需要使用到这个ConverterNode了。下面来看一个比较典型的 场景，我们自定义一个音频播放器(代码仓库中的AudioPlayer项目)， 由FFmpeg解码出来的PCM数据是SInt16格式的，因此不能直接输送给 RemoteIO Unit进行播放，所以需要构建一个ConvertNode将SInt16格式 表示的数据转换为Float32格式表示的数据，然后再输送给RemoteIO Unit，最终才能正常播放出来</p>
<p>Time Pitch:子类型是 <code>kAudioUnitSubType_NewTimePitch</code>，即变速 变调效果器，这是一个很有意思的效果器，可以对声音的音高、速度进 行调整，像“会说话的Tom猫”类似的应用场景就可以使用这个效果器来 实现</p>
<ol start="5">
<li>Generator Units</li>
</ol>
<p>类型是 <code>kAudioUnitType_Generator</code>，在开发中我们经常使用它来提供播放器的功能</p>
<p>AudioFilePlayer：子类型是 <code>kAudioUnitSubType_AudioFilePlayer</code>， 在 AudioUnit 里面，如果我们的输入不是麦克风，而希望其是一个媒体 文件，当然，也可以类似于代码仓库中的 AudioPlayer 项目自行解码，转 换之后将数据输送给 RemoteIO Unit 播放出来，但是其实还有一种更加简 单、方便的方式，那就是使用 AudioFilePlayer 这个 AudioUnit，可以参考 代码仓库中的 AUPlayer 项目，该项目就是利用 AudioFilePlayer 作为输入 数据源来提供数据的。需要注意的是，必须在初始化 AUGraph 之后，再 去配置 AudioFilePlayer 的数据源以及播放范围等属性，否则就会出现错 误，其实数据源还是会调用 AudioFile 的解码功能，将媒体文件中的压缩 数据解压成为PCM裸数据，最终再交给 AudioFilePlayer Unit 进行后续处 理</p>
<h6 id="构造一个-AUGraph"><a href="#构造一个-AUGraph" class="headerlink" title="构造一个 AUGraph"></a>构造一个 AUGraph</h6><p>实际的K歌应用场景，会对用户发出的声音进行处理，并且立即给 用户一个耳返(在50ms之内将声音输出到耳机中，让用户可以听到)。 那么如何让 RemoteIOUnit 利用麦克风采集出来的声音，经过中间效果器 的处理，最终输出到 Speaker 中播放给用户呢？如何 以AUGraph的方式将声音采集、声音处理以及声音输出的整个过程管理 起来</p>
<p>首先要知道数据可以在通道中传递是由最右端 Speaker(RemoteIO Unit)来驱动的，它会向其前一级——AUNode要数 据，然后它的前一级会继续向上一级节点要数据，并最终从 RemoteIOUnit的Element1 (即麦克风)中要数据，这样就可以将数据按 照相反的方向一级一级地传递下去，最终传递到RemoteIOUnit的 Element0(即Speaker)并播放给用户听到。当然你可能会想到离线处理 的时候应该由谁来进行驱动呢?其实在进行离线处理的时候应该使用 Mixer Unit大类型下面子类型为Generic Output的AudioUnit来做驱动端。 那么这些AudioUnit或者说AUNode是如何进行连接的呢?有两种方式， 第一种方式是直接将AUNode连接起来;第二种方式是通过回调的方式 将两个AUNode连接起来</p>
<p><img src="/2021/08/03/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%BC%80%E5%8F%91/02.png" alt="02"></p>
<ul>
<li>直接连接</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">AUGraphConnectNodeInput(mPlayerGraph, mPlayerNode, 0, mPlayerIONode, 0);</span><br></pre></td></tr></table></figure>

<p>AUPlayer实例中的一段代码，目标是将Audio File Player Unit和RemoteIO Unit直接连接起来，当RemoteIO Unit需要播放数据的时 候，就会调用AudioFilePlayer Unit来获取数据，这样就把这两个 AudioUnit连接起来了</p>
<ul>
<li>回调方式</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">AURenderCallbackStruct renderProc;</span><br><span class="line">renderProc.inputProc &#x3D; &amp;inputAvailableCallback;</span><br><span class="line">renderProc.inputProcRefCon &#x3D; (__bridge void *)self;</span><br><span class="line">AUGraphSetNodeInputCallback(mGraph, ioNode, 0, &amp;finalRenderProc);</span><br></pre></td></tr></table></figure>

<p>这段代码首先是构造一个AURenderCallback的结构体，并指定一个 回调函数，然后设置给RemoteIO Unit的输入端，当RemoteIO Unit需要 数据输入的时候就会回调该回调函数，回调函数代码如下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">static OSStatus renderCallback(void *inRefCon, AudioUnitRenderActionFlags</span><br><span class="line">           *ioActionFlags, const AudioTimeStamp *inTimeStamp, UInt32</span><br><span class="line">           inBusNumber, UInt32 inNumberFrames, AudioBufferList *ioData)</span><br><span class="line"> &#123;</span><br><span class="line">     OSStatus result &#x3D; noErr;</span><br><span class="line">     __unsafe_unretained AUGraphRecorder *THIS &#x3D; (__bridge</span><br><span class="line">             AUGraphRecorder *)inRefCon;</span><br><span class="line">     AudioUnitRender(THIS-&gt;mixerUnit, ioActionFlags, inTimeStamp, 0,</span><br><span class="line">             inNumberFrames, ioData);</span><br><span class="line">     result &#x3D; ExtAudioFileWriteAsync(THIS-&gt;finalAudioFile, inNumberFrames,</span><br><span class="line">             ioData);</span><br><span class="line">     return result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>该回调函数主要完成两件事情:第一件事情是去Mixer Unit里面要 数据，通过调用AudioUnitRender的方式来驱动Mixer Unit获取数据，得 到数据之后放入ioData中，从而填充回调方法中的参数，将Mixer Unit与 RemoteIO Unit连接了起来;第二件事情则是利用ExtAudioFile将这段声 音编码并写入本地磁盘的一个文件中</p>
<p>本节的代码仓库中包含了两个实例项目:一个是AUPlayer，利用 AudioFilePlayer Unit和RemoteIO Unit做了一个最简单的播放器;另外一个是AudioPlayer，它会利用FFmpeg进行解码操作，解码出来的是SInt16 格式表示的数据，然后再通过一个ConvertNode将其转换为Float32格式 表示的数据，最终输送给RemoteIO Unit进行播放。将这两个项目对比来 看，第二种方式十分不便</p>
<h4 id="音频采集"><a href="#音频采集" class="headerlink" title="音频采集"></a>音频采集</h4><p>示例代码 AudioRecorder</p>
<p>如果想要直接指定一个路径，可以将录制的音频编码到文件中，可以使用 <code> AVAudioRecorder</code>，优点是简单易用</p>
<p>但如果想要实时在内存中获取录音数据来说，限制性非常强，iOS提供了两个层次API来协助实现</p>
<p><code>AudioQueue</code>：是AudioUnit更高级的封装，功能更单一，接口调用更简单，如果仅仅要获取内存中的录音数据，然后再进行编码输出，用更高级的AudioQueue的API会更好些</p>
<p><code>AudioUnit</code>：如果要使用更多音效处理，以及实时的监听（耳机中听到自己说话），使用AudioUnit会更方便一些</p>
<p>要使用 AudioUnit，需要通过 AudioSession 来开启硬件设备以及对硬件设备做一些设置，然后才能使用 AudioUnit</p>
<ol>
<li>获取 AVAudioSession 实例</li>
<li>为 AVAudioSession 设置类别，录音的同时为用户输送监听耳返，类别使用 AVAudioSessionCategoryPlayAndRecord，</li>
<li>为 AVAudioSession 设置预设采样率</li>
<li>启用 AVAudioSession</li>
<li>为 AVAudioSession 设置路由监听，采集音频或视频输出的路线发生变化时（比如拔出耳机、蓝牙设备连接成功）回调此方法，以便可以重新设置使用当前最新的麦克风或扬声器</li>
</ol>
<p>接下来构造应用所使用的 AUGraph，因为这里要使用录音功能，所以需要启用RemoteIO这个AudioUnit 的InputElement。RemoteIO 这个 AudioUnit 比较特别，Input-Element实际 上使用的是麦克风，而OutputElement使用的则是扬声器，所以这里首先 会启用 RemoteIOUnit 的 InputElement。</p>
<p>为了支持所开发的App可以在后续 Mix 一轨伴奏这一扩展功能，在AUGraph中需要增加 MultiChannelMixer 这个 AudioUnit。由于每个 AudioUnit 的输入输出格式并不相同，所以这 里还要使用AudioConvert这个AudioUnit将输入的AudioUnit连接到  MixerUnit上。最终将 MixerUnit 连接到 RemoteIO 这个 AudioUnit 的 OutputElement，将声音发送到耳机的扬声器中(如果直接发送到手机的 扬声器中就会出现啸叫)，这样就将 AUGraph 整体地建立起来了</p>
<p><img src="/2021/08/03/%E9%9F%B3%E8%A7%86%E9%A2%91%E5%BC%80%E5%8F%91/01.png" alt="01"></p>
<p><a href="https://developer.apple.com/library/archive/documentation/Audio/Conceptual/AudioSessionProgrammingGuide/Introduction/Introduction.html#//apple_ref/doc/uid/TP40007875">Audio Session Programming Guide</a></p>
<p><a href="https://developer.apple.com/library/archive/documentation/MusicAudio/Conceptual/AudioUnitHostingGuide_iOS/ConstructingAudioUnitApps/ConstructingAudioUnitApps.html#//apple_ref/doc/uid/TP40009492-CH16-SW1">Audio Unit Hosting Guide for iOS</a></p>
<p><a href="https://github.com/zhanxiaokai/iOS-AudioRecorder">音频采集代码 AudioRecorder</a></p>
<p><a href="https://github.com/zhanxiaokai?tab=repositories">音视频进阶开发指南源码</a></p>
]]></content>
  </entry>
  <entry>
    <title>《Flutter实战第二版》六：可滚动组件</title>
    <url>/2022/01/18/%E3%80%8AFlutter%E5%AE%9E%E6%88%98%E7%AC%AC%E4%BA%8C%E7%89%88%E3%80%8B%E5%85%AD%EF%BC%9A%E5%8F%AF%E6%BB%9A%E5%8A%A8%E7%BB%84%E4%BB%B6/</url>
    <content><![CDATA[<h3 id="6-可滚动组件"><a href="#6-可滚动组件" class="headerlink" title="6 可滚动组件"></a>6 可滚动组件</h3><h5 id="6-1-可滚动组件"><a href="#6-1-可滚动组件" class="headerlink" title="6.1 可滚动组件"></a>6.1 可滚动组件</h5><p>Flutter 中有两种布局模型<br>基于 RenderBox 的盒模型布局<br>基于 Sliver（RenderSliver）按需加载列表布局</p>
<p>Flutter 中的可滚动主要由三个角色组成：Scollable、Viewport 和 Sliver<br>Scollable 用于处理滑动手势，确定滑动偏移，滑动偏移时构建 Viewport<br>Viewport 显示的视窗，即列表的可视区域<br>Sliver 视窗里显示的元素</p>
<ul>
<li>布局过程</li>
</ul>
<p>Scrollable 监听到用户滑动行为后，根据最新的滑动偏移构建 Viewport</p>
<p>Viewport 将当前视口信息和配置信息通过 SliverConstraints 传递给 Sliver</p>
<p>Sliver 中对子组件（RenderBox）按需进行构建和布局，然后确认自身的位置、绘制等信息，保存在 geometry 中（一个 SliverGeometry 类型的对象）</p>
<ul>
<li>Scrollable</li>
</ul>
<p>用于处理滑动手势，确定滑动偏移，滑动偏移变化时构建 Viewport</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Scrollable(&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">this</span>.axisDirection = AxisDirection.down, <span class="comment">//滚动方向</span></span><br><span class="line">  <span class="keyword">this</span>.controller,</span><br><span class="line">  <span class="keyword">this</span>.physics,</span><br><span class="line">  <span class="keyword">required</span> <span class="keyword">this</span>.viewportBuilder, <span class="comment">//后面介绍</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><code>physics</code> 接受一个 ScrollPhysics 类型的对象，决定可滚动组件如何响应用户操作</p>
<p>比如用户滑动完抬起手指后，继续执行动画；或者滑动到边界时如何显示，默认情况下，Flutter会根据平台分别使用不同 ScrollPhysics 对象，应用不同效果，如滑动到边界时，继续拖动，iOS上会出现弹性效果，Android上会出现微光效果</p>
<p>Flutter SDK中包含两个 ScrollPhysics 的子类</p>
<p>ClampingScrollPhysics 列表滑动到边界时将不能继续滑动，通常Android中配合GlowingOverscrollIndicator （实现微光效果的组件）使用</p>
<p>BouncingScrollPhysics iOS 下弹性效果</p>
<p><code>controller</code>  接受一个 ScrollController 对象，主要作用是控制滚动位置和监听滚动事件</p>
<p><code>viewportBuilder</code> 构建 Viewport 的回调，用户滑动时，Scrollable 会调用此回调构建新的 Viewport</p>
<ul>
<li>Viewport</li>
</ul>
<p>用于渲染当前视口中需要显示 Sliver</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Viewport(&#123;</span><br><span class="line">  Key? key,</span><br><span class="line">  <span class="keyword">this</span>.axisDirection = AxisDirection.down,</span><br><span class="line">  <span class="keyword">this</span>.crossAxisDirection,</span><br><span class="line">  <span class="keyword">this</span>.anchor = <span class="number">0.0</span>,</span><br><span class="line">  <span class="keyword">required</span> ViewportOffset offset, <span class="comment">// 用户的滚动偏移</span></span><br><span class="line">  <span class="comment">// 类型为Key，表示从什么地方开始绘制，默认是第一个元素</span></span><br><span class="line">  <span class="keyword">this</span>.center,</span><br><span class="line">  <span class="keyword">this</span>.cacheExtent, <span class="comment">// 预渲染区域</span></span><br><span class="line">  <span class="comment">//该参数用于配合解释cacheExtent的含义，也可以为主轴长度的乘数</span></span><br><span class="line">  <span class="keyword">this</span>.cacheExtentStyle = CacheExtentStyle.pixel, </span><br><span class="line">  <span class="keyword">this</span>.clipBehavior = Clip.hardEdge,</span><br><span class="line">  <span class="built_in">List</span>&lt;Widget&gt; slivers = <span class="keyword">const</span> &lt;Widget&gt;[], <span class="comment">// 需要显示的 Sliver 列表</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>offset：该参数为 Scrollable 构建 Viewport 时传入，描述了 Viewport 应该显示哪一部分内容</p>
<p>cacheExtentStyle：是个枚举，有 pixel 和 viewport 两个取值，为 pixel 时，cacheExtent 的值为预渲染区域的具体像素长度，为 viewport 时，cacheExtent 的值是一个乘数，表示有几个 viewport 的长度</p>
<ul>
<li>Sliver</li>
</ul>
<p>Sliver 主要作用是对子组件进行构建和布局</p>
<ul>
<li>可滚动组件通用配置</li>
</ul>
<p>几乎所有的可滚动组件在构造时都能指定 scrollDirection（滚动的主轴）reverse（滑动方向是否反向）controller、physics、cacheExtent</p>
<ul>
<li>Scrollbar</li>
</ul>
<p>滚动条，如果要给滚动组件添加滚动条，只需将 Scrollbar 作为可滚动组件的任意一个父级组件即可</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Scrollbar(</span><br><span class="line">  child: SingleChildScrollView(</span><br><span class="line">    ...</span><br><span class="line">  ),</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h4 id="6-2-SingleChildScrollView"><a href="#6-2-SingleChildScrollView" class="headerlink" title="6.2 SingleChildScrollView"></a>6.2 SingleChildScrollView</h4><p>SingleChildScrollView 类似 Android 中的 ScrollView</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">SingleChildScrollView(&#123;</span><br><span class="line">  <span class="keyword">this</span>.scrollDirection = Axis.vertical, <span class="comment">//滚动方向，默认是垂直方向</span></span><br><span class="line">  <span class="keyword">this</span>.reverse = <span class="keyword">false</span>, </span><br><span class="line">  <span class="keyword">this</span>.padding, </span><br><span class="line">  <span class="built_in">bool</span> primary, </span><br><span class="line">  <span class="keyword">this</span>.physics, </span><br><span class="line">  <span class="keyword">this</span>.controller,</span><br><span class="line">  <span class="keyword">this</span>.child,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>primary 属性：表示是否使用 widget 树中默认的 PrimaryScrollController</p>
<p>通常 SingleChildScrollView 只应在期望的内容不会超过屏幕太多的时候使用，因为 SingleChildScrollView 不支持基于 Sliver 的延迟加载模型</p>
<p>例如：将大写字母 A-Z 沿垂直方向显示，垂直方向空间会超过屏幕视口高度，使用 SingleChildScrollView</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SingleChildScrollViewTestRoute</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="built_in">String</span> str = <span class="string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> Scrollbar( <span class="comment">// 显示进度条</span></span><br><span class="line">      child: SingleChildScrollView(</span><br><span class="line">        padding: EdgeInsets.all(<span class="number">16.0</span>),</span><br><span class="line">        child: Center(</span><br><span class="line">          child: Column( </span><br><span class="line">            <span class="comment">//动态创建一个List&lt;Widget&gt;  </span></span><br><span class="line">            children: str.split(<span class="string">&quot;&quot;</span>) </span><br><span class="line">                <span class="comment">//每一个字母都用一个Text显示,字体为原来的两倍</span></span><br><span class="line">                .map((c) =&gt; Text(c, textScaleFactor: <span class="number">2.0</span>,)) </span><br><span class="line">                .toList(),</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》六：可滚动组件/WeChat6f1348f5e3cb71768b5c796b10ce1e55.png" alt="WeChat6f1348f5e3cb71768b5c796b10ce1e55" style="zoom:80%;" />

<h4 id="6-3-ListView"><a href="#6-3-ListView" class="headerlink" title="6.3 ListView"></a>6.3 ListView</h4><p>最常用可滚动组件之一，可以沿一个方向排布所有子组件，支持列表懒加载</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">ListView(&#123;</span><br><span class="line">  ...  </span><br><span class="line">  <span class="comment">//可滚动widget公共参数</span></span><br><span class="line">  Axis scrollDirection = Axis.vertical,</span><br><span class="line">  <span class="built_in">bool</span> reverse = <span class="keyword">false</span>,</span><br><span class="line">  ScrollController? controller,</span><br><span class="line">  <span class="built_in">bool?</span> primary,</span><br><span class="line">  ScrollPhysics? physics,</span><br><span class="line">  EdgeInsetsGeometry? padding,</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//ListView各个构造函数的共同参数  </span></span><br><span class="line">  <span class="built_in">double?</span> itemExtent,</span><br><span class="line">  Widget? prototypeItem, <span class="comment">//列表项原型，后面解释</span></span><br><span class="line">  <span class="built_in">bool</span> shrinkWrap = <span class="keyword">false</span>,</span><br><span class="line">  <span class="built_in">bool</span> addAutomaticKeepAlives = <span class="keyword">true</span>,</span><br><span class="line">  <span class="built_in">bool</span> addRepaintBoundaries = <span class="keyword">true</span>,</span><br><span class="line">  <span class="built_in">double?</span> cacheExtent, <span class="comment">// 预渲染区域长度</span></span><br><span class="line">    </span><br><span class="line">  <span class="comment">//子widget列表</span></span><br><span class="line">  <span class="built_in">List</span>&lt;Widget&gt; children = <span class="keyword">const</span> &lt;Widget&gt;[],</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>itemExtent：参数如果不为 null，则会强制 children 的长度为 itemExtent 的值，长度指滚动方向上子组件的长度</p>
<p>prototypeItem：如果我们知道列表中的所有列表项长度都相同但不知道具体是多少，我们可以指定一个列表项，这个列表项为 prototypeItem（列表项原型），和 itemExtent 互斥</p>
<p>ShrinkWrap：是否跟进子组件总长度来设置 ListView 的长度，默认 false；默认情况下，ListView 会在滚动方向尽可能多的占用空间，当 ListView 在一个无边界（滚动向上）的容器中时，必须为 true</p>
<p>addAutomaticKeepAlives</p>
<p>addRepaintBoundaries</p>
<h5 id="默认构造函数"><a href="#默认构造函数" class="headerlink" title="默认构造函数"></a>默认构造函数</h5><p>默认构造函数有一个 children 参数，接受一个 Widget 列表，这种方式适合只有少量的子组件数量已知且比较少的情况，反之使用 ListView.builder 按需动态构建列表</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">ListView(</span><br><span class="line">  shrinkWrap: <span class="keyword">true</span>, </span><br><span class="line">  padding: <span class="keyword">const</span> EdgeInsets.all(<span class="number">20.0</span>),</span><br><span class="line">  children: &lt;Widget&gt;[</span><br><span class="line">    <span class="keyword">const</span> Text(<span class="string">&#x27;I\&#x27;m dedicating every day to you&#x27;</span>),</span><br><span class="line">    <span class="keyword">const</span> Text(<span class="string">&#x27;Domestic life was never quite my style&#x27;</span>),</span><br><span class="line">    <span class="keyword">const</span> Text(<span class="string">&#x27;When you smile, you knock me out, I fall apart&#x27;</span>),</span><br><span class="line">    <span class="keyword">const</span> Text(<span class="string">&#x27;And I thought I was so smart&#x27;</span>),</span><br><span class="line">  ],</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h5 id="ListView-builder"><a href="#ListView-builder" class="headerlink" title="ListView.builder"></a>ListView.builder</h5><p>适合列表项比较多或者列表项不确定的情况</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">ListView.builder(&#123;</span><br><span class="line">  <span class="comment">// ListView公共参数已省略  </span></span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">required</span> IndexedWidgetBuilder itemBuilder,</span><br><span class="line">  <span class="built_in">int</span> itemCount,</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>itemBuilder：是列表项的构造器</p>
<ul>
<li>例子</li>
</ul>
<p>itemCount 列表项数量，为null则为无限列表</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">ListView.builder(</span><br><span class="line">  itemCount: <span class="number">100</span>,</span><br><span class="line">  itemExtent: <span class="number">50.0</span>, <span class="comment">//强制高度为50.0</span></span><br><span class="line">  itemBuilder: (BuildContext context, <span class="built_in">int</span> index) &#123;</span><br><span class="line">    <span class="keyword">return</span> ListTile(title: Text(<span class="string">&quot;<span class="subst">$index</span>&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》六：可滚动组件/WeChatd89bad409c79874b042dc4ffbed29249.png" alt="WeChatd89bad409c79874b042dc4ffbed29249" style="zoom:80%;" />

<h5 id="ListView-separated"><a href="#ListView-separated" class="headerlink" title="ListView.separated"></a>ListView.separated</h5><p>可以在生成的列表项之间加一个分割组件，比 ListView.builder 多了一个 separatedBuilder 参数，是一个分割组件生成器</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListView3</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="comment">//下划线widget预定义以供复用。  </span></span><br><span class="line">    Widget divider1=Divider(color: Colors.blue,);</span><br><span class="line">    Widget divider2=Divider(color: Colors.green);</span><br><span class="line">    <span class="keyword">return</span> ListView.separated(</span><br><span class="line">      itemCount: <span class="number">100</span>,</span><br><span class="line">      <span class="comment">//列表项构造器</span></span><br><span class="line">      itemBuilder: (BuildContext context, <span class="built_in">int</span> index) &#123;</span><br><span class="line">        <span class="keyword">return</span> ListTile(title: Text(<span class="string">&quot;<span class="subst">$index</span>&quot;</span>));</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">//分割器构造器</span></span><br><span class="line">      separatorBuilder: (BuildContext context, <span class="built_in">int</span> index) &#123;</span><br><span class="line">        <span class="keyword">return</span> index%<span class="number">2</span>==<span class="number">0</span>?divider1:divider2;</span><br><span class="line">      &#125;,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》六：可滚动组件/WeChat5ceee9697183ace9c3a29f3a4ca3973e.png" alt="WeChat5ceee9697183ace9c3a29f3a4ca3973e" style="zoom:80%;" />

<h5 id="固定高度列表"><a href="#固定高度列表" class="headerlink" title="固定高度列表"></a>固定高度列表</h5><p>给列表指定 itemExtent 或 prototypeItem 会有更高的性能，在知道列表项的高度都相同时，强烈建议指定 itemExtent 或 prototypeItem</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FixedExtentList</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> FixedExtentList(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> ListView.builder(</span><br><span class="line">   		prototypeItem: ListTile(title: Text(<span class="string">&quot;1&quot;</span>)),</span><br><span class="line">      <span class="comment">//itemExtent: 56,</span></span><br><span class="line">      itemBuilder: (context, index) &#123;</span><br><span class="line">        <span class="comment">//LayoutLogPrint是一个自定义组件，在布局时可以打印当前上下文中父组件给子组件的约束信息</span></span><br><span class="line">        <span class="keyword">return</span> LayoutLogPrint(</span><br><span class="line">          tag: index, </span><br><span class="line">          child: ListTile(title: Text(<span class="string">&quot;<span class="subst">$index</span>&quot;</span>)),</span><br><span class="line">        );</span><br><span class="line">      &#125;,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="无限加载列表"><a href="#无限加载列表" class="headerlink" title="无限加载列表"></a>无限加载列表</h5><p>从数据源异步分批次拉取数据，用 ListView 展示，当滑动到列表末尾时，判断是否需要去拉取数据，如果是，则去拉取，拉取过程中表尾显示一个 loading，拉取成功后将数据插入表尾，如果不需要拉取，则表尾显示没有更多</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/material.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:english_words/english_words.dart&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;package:flutter/rendering.dart&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InfiniteListView</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _InfiniteListViewState createState() =&gt; _InfiniteListViewState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_InfiniteListViewState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">InfiniteListView</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">const</span> loadingTag = <span class="string">&quot;##loading##&quot;</span>; <span class="comment">//表尾标记</span></span><br><span class="line">  <span class="keyword">var</span> _words = &lt;<span class="built_in">String</span>&gt;[loadingTag];</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    _retrieveData();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> ListView.separated(</span><br><span class="line">      itemCount: _words.length,</span><br><span class="line">      itemBuilder: (context, index) &#123;</span><br><span class="line">        <span class="comment">//如果到了表尾</span></span><br><span class="line">        <span class="keyword">if</span> (_words[index] == loadingTag) &#123;</span><br><span class="line">          <span class="comment">//不足100条，继续获取数据</span></span><br><span class="line">          <span class="keyword">if</span> (_words.length - <span class="number">1</span> &lt; <span class="number">100</span>) &#123;</span><br><span class="line">            <span class="comment">//获取数据</span></span><br><span class="line">            _retrieveData();</span><br><span class="line">            <span class="comment">//加载时显示loading</span></span><br><span class="line">            <span class="keyword">return</span> Container(</span><br><span class="line">              padding: <span class="keyword">const</span> EdgeInsets.all(<span class="number">16.0</span>),</span><br><span class="line">              alignment: Alignment.center,</span><br><span class="line">              child: SizedBox(</span><br><span class="line">                width: <span class="number">24.0</span>,</span><br><span class="line">                height: <span class="number">24.0</span>,</span><br><span class="line">                child: CircularProgressIndicator(strokeWidth: <span class="number">2.0</span>),</span><br><span class="line">              ),</span><br><span class="line">            );</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//已经加载了100条数据，不再获取数据。</span></span><br><span class="line">            <span class="keyword">return</span> Container(</span><br><span class="line">              alignment: Alignment.center,</span><br><span class="line">              padding: EdgeInsets.all(<span class="number">16.0</span>),</span><br><span class="line">              child: Text(</span><br><span class="line">                <span class="string">&quot;没有更多了&quot;</span>,</span><br><span class="line">                style: TextStyle(color: Colors.grey),</span><br><span class="line">              ),</span><br><span class="line">            );</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//显示单词列表项</span></span><br><span class="line">        <span class="keyword">return</span> ListTile(title: Text(_words[index]));</span><br><span class="line">      &#125;,</span><br><span class="line">      separatorBuilder: (context, index) =&gt; Divider(height: <span class="number">.0</span>),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> _retrieveData() &#123;</span><br><span class="line">    Future.delayed(<span class="built_in">Duration</span>(seconds: <span class="number">2</span>)).then((e) &#123;</span><br><span class="line">      setState(() &#123;</span><br><span class="line">        <span class="comment">//重新构建列表</span></span><br><span class="line">        _words.insertAll(</span><br><span class="line">          _words.length - <span class="number">1</span>,</span><br><span class="line">          <span class="comment">//每次生成20个单词</span></span><br><span class="line">          generateWordPairs().take(<span class="number">20</span>).map((e) =&gt; e.asPascalCase).toList(),</span><br><span class="line">        );</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》六：可滚动组件/WeChat4aceb0db67ca479d945b472396307dd9.png" alt="WeChat4aceb0db67ca479d945b472396307dd9" style="zoom:80%;" />

<p>_retrieveData 是模拟从数据源异步获取数据，使用 english_words 包的 generateWordPairs 方法每次生成 20 个单词</p>
<h5 id="添加固定表头"><a href="#添加固定表头" class="headerlink" title="添加固定表头"></a>添加固定表头</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="meta">@override</span></span><br><span class="line">Widget build(BuildContext context) &#123;</span><br><span class="line">  <span class="keyword">return</span> Column(children: &lt;Widget&gt;[</span><br><span class="line">    ListTile(title:Text(<span class="string">&quot;商品列表&quot;</span>)),</span><br><span class="line">    Expanded(</span><br><span class="line">      child: ListView.builder(itemBuilder: (BuildContext context, <span class="built_in">int</span> index) &#123;</span><br><span class="line">        <span class="keyword">return</span> ListTile(title: Text(<span class="string">&quot;<span class="subst">$index</span>&quot;</span>));</span><br><span class="line">      &#125;),</span><br><span class="line">    ),</span><br><span class="line">  ]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自动拉伸 ListView 以填充屏幕剩余空间</p>
<h4 id="6-4-滚动监听及控制"><a href="#6-4-滚动监听及控制" class="headerlink" title="6.4 滚动监听及控制"></a>6.4 滚动监听及控制</h4><h5 id="6-4-1-ScrollController"><a href="#6-4-1-ScrollController" class="headerlink" title="6.4.1 ScrollController"></a>6.4.1 ScrollController</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">ScrollController(&#123;</span><br><span class="line">  <span class="built_in">double</span> initialScrollOffset = <span class="number">0.0</span>, <span class="comment">//初始滚动位置</span></span><br><span class="line">  <span class="keyword">this</span>.keepScrollOffset = <span class="keyword">true</span>,<span class="comment">//是否保存滚动位置</span></span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>ScrollController 常用属性和方法</p>
<p>offset：可滚动组件当前的滚动位置</p>
<p>jumpTo(double offset)、animateTo(double offset, …)：这两个方法用于跳转到指定的位置</p>
<ul>
<li>滚动监听</li>
</ul>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">controller.addListener(()=&gt;<span class="built_in">print</span>(controller.offset))</span><br></pre></td></tr></table></figure>

<ul>
<li>示例</li>
</ul>
<p>创建一个 ListView，滚动位置发生变化时，打印当前滚动位置，判断超过 1000 像素，屏幕右下角显示返回顶部按钮，按钮点击恢复到初始位置；没超过 1000 像素，隐藏按钮</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScrollControllerTestRoute</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  ScrollControllerTestRouteState createState() &#123;</span><br><span class="line">    <span class="keyword">return</span> ScrollControllerTestRouteState();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScrollControllerTestRouteState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">ScrollControllerTestRoute</span>&gt; </span>&#123;</span><br><span class="line">  ScrollController _controller = ScrollController();</span><br><span class="line">  <span class="built_in">bool</span> showToTopBtn = <span class="keyword">false</span>; <span class="comment">//是否显示“返回到顶部”按钮</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    <span class="comment">//监听滚动事件，打印滚动位置</span></span><br><span class="line">    _controller.addListener(() &#123;</span><br><span class="line">      <span class="built_in">print</span>(_controller.offset); <span class="comment">//打印滚动位置</span></span><br><span class="line">      <span class="keyword">if</span> (_controller.offset &lt; <span class="number">1000</span> &amp;&amp; showToTopBtn) &#123;</span><br><span class="line">        setState(() &#123;</span><br><span class="line">          showToTopBtn = <span class="keyword">false</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_controller.offset &gt;= <span class="number">1000</span> &amp;&amp; showToTopBtn == <span class="keyword">false</span>) &#123;</span><br><span class="line">        setState(() &#123;</span><br><span class="line">          showToTopBtn = <span class="keyword">true</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    <span class="comment">//为了避免内存泄露，需要调用_controller.dispose</span></span><br><span class="line">    _controller.dispose();</span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(title: Text(<span class="string">&quot;滚动控制&quot;</span>)),</span><br><span class="line">      body: Scrollbar(</span><br><span class="line">        child: ListView.builder(</span><br><span class="line">          itemCount: <span class="number">100</span>,</span><br><span class="line">          itemExtent: <span class="number">50.0</span>, <span class="comment">//列表项高度固定时，显式指定高度是一个好习惯(性能消耗小)</span></span><br><span class="line">          controller: _controller,</span><br><span class="line">          itemBuilder: (context, index) &#123;</span><br><span class="line">            <span class="keyword">return</span> ListTile(title: Text(<span class="string">&quot;<span class="subst">$index</span>&quot;</span>),);</span><br><span class="line">          &#125;</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">      floatingActionButton: !showToTopBtn ? <span class="keyword">null</span> : FloatingActionButton(</span><br><span class="line">        child: Icon(Icons.arrow_upward),</span><br><span class="line">        onPressed: () &#123;</span><br><span class="line">          <span class="comment">//返回到顶部时执行动画</span></span><br><span class="line">          _controller.animateTo(</span><br><span class="line">            <span class="number">.0</span>,</span><br><span class="line">            duration: <span class="built_in">Duration</span>(milliseconds: <span class="number">200</span>),</span><br><span class="line">            curve: Curves.ease,</span><br><span class="line">          );</span><br><span class="line">        &#125;</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》六：可滚动组件/WeChat42973799693e4227480a0cc11ab05bd7.png" alt="WeChat42973799693e4227480a0cc11ab05bd7" style="zoom:80%;" />

<ul>
<li>滚动位置恢复</li>
</ul>
<p>PageStorage 是一个用于保存页面（路由）相关数据的组件，是一个功能型组件，拥有一个存储桶，子树中的widget可以通过指定不同的 PageStorageKey 来存储各自的数据或状态</p>
<p>每次滚动结束，可滚动组件都会将滚动位置 offset 存储到 PageStorage 中</p>
<p>如果 ScrollController.keepScrollOffset 为 false，则滚动位置将不会被存储</p>
<p>多个可滚动组件时，显示指定 PageStorageKey</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">ListView(key: PageStorageKey(<span class="number">1</span>), ... );</span><br><span class="line">...</span><br><span class="line">ListView(key: PageStorageKey(<span class="number">2</span>), ... );</span><br></pre></td></tr></table></figure>

<ul>
<li>ScrollPosition</li>
</ul>
<p>ScrollPosition 是用来保存可滚动组件的滚动位置的，一个 ScrollController 对象可以同时被多个可滚动组件使用，ScrollController 会为每个可滚动组件创建一个 ScrollPosition 对象，这些 ScrollPosition 保存在 ScrollController 的 positions 属性中</p>
<p>offset</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="built_in">double</span> <span class="keyword">get</span> offset =&gt; position.pixels;</span><br><span class="line">...</span><br><span class="line">controller.positions.elementAt(<span class="number">0</span>).pixels</span><br><span class="line">controller.positions.elementAt(<span class="number">1</span>).pixels</span><br><span class="line">...    </span><br></pre></td></tr></table></figure>

<p>controller.positions.length 来确定 controller 被几个可滚动组件使用</p>
<ul>
<li>ScrollPosition 的方法</li>
</ul>
<p>ScrollPosition 两个常用方法 animateTo() 和 jumpTo()，控制跳转滚动位置的方法</p>
<h5 id="6-4-2-滚动监听"><a href="#6-4-2-滚动监听" class="headerlink" title="6.4.2 滚动监听"></a>6.4.2 滚动监听</h5><p>Flutter widget 树中，子 widget 可以通过发送通知与父（包括祖先）widget 通信，父 widget 通过 NotificationListener 组件监听自己关注的通知</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScrollNotificationTestRoute</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _ScrollNotificationTestRouteState createState() =&gt; _ScrollNotificationTestRouteState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_ScrollNotificationTestRouteState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">ScrollNotificationTestRoute</span>&gt; </span>&#123;</span><br><span class="line">  <span class="built_in">String</span> _progress = <span class="string">&#x27;0%&#x27;</span>;<span class="comment">//保存进度百分比</span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(<span class="string">&#x27;标题&#x27;</span>),</span><br><span class="line">      ),</span><br><span class="line">      body: Scrollbar(<span class="comment">//进度条，监听滚动通知</span></span><br><span class="line">          child: NotificationListener(</span><br><span class="line">              onNotification: (ScrollNotification notification) &#123;</span><br><span class="line">                <span class="built_in">double</span> progress = notification.metrics.pixels / notification.metrics.maxScrollExtent;</span><br><span class="line">                setState(() &#123;</span><br><span class="line">                  <span class="keyword">var</span> value = (progress * <span class="number">100</span>).toInt();</span><br><span class="line">                  <span class="built_in">print</span>(<span class="string">&quot;<span class="subst">$value</span>%, <span class="subst">$progress</span>&quot;</span>);</span><br><span class="line">                  _progress = <span class="string">&quot;<span class="subst">$value</span>%&quot;</span>;</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="comment">// print(progress);</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">              &#125;,</span><br><span class="line">              child: Stack(</span><br><span class="line">                alignment: Alignment.center,</span><br><span class="line">                children: [</span><br><span class="line">                  ListView.builder(</span><br><span class="line">                    itemCount: <span class="number">100</span>,</span><br><span class="line">                    itemExtent: <span class="number">50.0</span>,</span><br><span class="line">                    itemBuilder: (context, index) =&gt; ListTile(title: Text(<span class="string">&#x27;<span class="subst">$index</span>&#x27;</span>)),</span><br><span class="line">                  ),</span><br><span class="line">                  CircleAvatar(</span><br><span class="line">                    radius: <span class="number">30.0</span>,</span><br><span class="line">                    child: Text(_progress),</span><br><span class="line">                    backgroundColor: Colors.black54,</span><br><span class="line">                  ),</span><br><span class="line">                ],</span><br><span class="line">              )</span><br><span class="line">          )</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》六：可滚动组件/WeChat5139ec30bc349c3ef1280b60d76c0f9e.png" alt="WeChat5139ec30bc349c3ef1280b60d76c0f9e" style="zoom:80%;" />

<p>接收到滚动事件时，参数类型为 ScrollNotification，包括一个 metrics 属性，类型是 ScrollMetrics</p>
<p>该属性包含当前 ViewPort 及滚动位置等信息</p>
<p>pixels：当前滚动位置<br>maxScrollPosition：最大可滚动长度<br>extentBefore：滑出ViewPort顶部的长度，相当于顶部滑出屏幕上方的列表长度<br>extentInside：ViewPort内部长度，相当于屏幕显示的列表长度<br>extentAfter：列表中未滑入ViewPort部分的长度<br>atEdge：是否滑到了可滚动组件的边界</p>
<h4 id="6-5-AnimatedList"><a href="#6-5-AnimatedList" class="headerlink" title="6.5 AnimatedList"></a>6.5 AnimatedList</h4><p>AnimatedList 和 ListView 的功能大体相似，AnimatedList 可以在列表中插入或删除节点时执行一个动画</p>
<ul>
<li>示例</li>
</ul>
<p>点击底部 + 号向列表追加一个列表项，点击列表项删除按钮，删除该列表项，添加和删除分别执行指定的动画</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnimatedListRoute</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> AnimatedListRoute(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _AnimatedListRouteState createState() =&gt; _AnimatedListRouteState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_AnimatedListRouteState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">AnimatedListRoute</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> data = &lt;<span class="built_in">String</span>&gt;[];</span><br><span class="line">  <span class="built_in">int</span> counter = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> globalKey = GlobalKey&lt;AnimatedListState&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; counter; i++) &#123;</span><br><span class="line">      data.add(<span class="string">&#x27;<span class="subst">$&#123;i + <span class="number">1</span>&#125;</span>&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Stack(</span><br><span class="line">      children: [</span><br><span class="line">        AnimatedList(</span><br><span class="line">          key: globalKey,</span><br><span class="line">          initialItemCount: data.length,</span><br><span class="line">          itemBuilder: (</span><br><span class="line">            BuildContext context,</span><br><span class="line">            <span class="built_in">int</span> index,</span><br><span class="line">            Animation&lt;<span class="built_in">double</span>&gt; animation,</span><br><span class="line">          ) &#123;</span><br><span class="line">            <span class="comment">//添加列表项时会执行渐显动画</span></span><br><span class="line">            <span class="keyword">return</span> FadeTransition(</span><br><span class="line">              opacity: animation,</span><br><span class="line">              child: buildItem(context, index),</span><br><span class="line">            );</span><br><span class="line">          &#125;,</span><br><span class="line">        ),</span><br><span class="line">        buildAddBtn(),</span><br><span class="line">      ],</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建一个 “+” 按钮，点击后会向列表中插入一项</span></span><br><span class="line">  Widget buildAddBtn() &#123;</span><br><span class="line">    <span class="keyword">return</span> Positioned(</span><br><span class="line">      child: FloatingActionButton(</span><br><span class="line">        child: Icon(Icons.add),</span><br><span class="line">        onPressed: () &#123;</span><br><span class="line">          <span class="comment">// 添加一个列表项</span></span><br><span class="line">          data.add(<span class="string">&#x27;<span class="subst">$&#123;++counter&#125;</span>&#x27;</span>);</span><br><span class="line">          <span class="comment">// 告诉列表项有新添加的列表项</span></span><br><span class="line">          globalKey.currentState!.insertItem(data.length - <span class="number">1</span>);</span><br><span class="line">          <span class="built_in">print</span>(<span class="string">&#x27;添加 <span class="subst">$counter</span>&#x27;</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">      ),</span><br><span class="line">      bottom: <span class="number">30</span>,</span><br><span class="line">      left: <span class="number">0</span>,</span><br><span class="line">      right: <span class="number">0</span>,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构建列表项</span></span><br><span class="line">  Widget buildItem(context, index) &#123;</span><br><span class="line">    <span class="built_in">String</span> char = data[index];</span><br><span class="line">    <span class="keyword">return</span> ListTile(</span><br><span class="line">      <span class="comment">//数字不会重复，所以作为Key</span></span><br><span class="line">      key: ValueKey(char),</span><br><span class="line">      title: Text(char),</span><br><span class="line">      trailing: IconButton(</span><br><span class="line">        icon: Icon(Icons.delete),</span><br><span class="line">        <span class="comment">// 点击时删除</span></span><br><span class="line">        onPressed: () =&gt; onDelete(context, index),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">void</span> onDelete(context, index) &#123;</span><br><span class="line">    <span class="comment">// 待实现</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>删除 onDelete 执行渐隐+收缩组合动画</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">setState(() &#123;</span><br><span class="line">  globalKey.currentState!.removeItem(</span><br><span class="line">    index,</span><br><span class="line">    (context, animation) &#123;</span><br><span class="line">      <span class="comment">// 删除过程执行的是反向动画，animation.value 会从1变为0</span></span><br><span class="line">      <span class="keyword">var</span> item = buildItem(context, index);</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&#x27;删除 <span class="subst">$&#123;data[index]&#125;</span>&#x27;</span>);</span><br><span class="line">      data.removeAt(index);</span><br><span class="line">      <span class="comment">// 删除动画是一个合成动画：渐隐 + 缩小列表项告诉</span></span><br><span class="line">      <span class="keyword">return</span> FadeTransition(</span><br><span class="line">        opacity: CurvedAnimation(</span><br><span class="line">          parent: animation,</span><br><span class="line">          <span class="comment">//让透明度变化的更快一些</span></span><br><span class="line">          curve: <span class="keyword">const</span> Interval(<span class="number">0.5</span>, <span class="number">1.0</span>),</span><br><span class="line">        ),</span><br><span class="line">        <span class="comment">// 不断缩小列表项的高度</span></span><br><span class="line">        child: SizeTransition(</span><br><span class="line">          sizeFactor: animation,</span><br><span class="line">          axisAlignment: <span class="number">0.0</span>,</span><br><span class="line">          child: item,</span><br><span class="line">        ),</span><br><span class="line">      );</span><br><span class="line">    &#125;,</span><br><span class="line">    duration: <span class="built_in">Duration</span>(milliseconds: <span class="number">200</span>), <span class="comment">// 动画时间为 200 ms</span></span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》六：可滚动组件/WeChat11c3ca4197d326442fed540c599a1cd8.png" alt="WeChat11c3ca4197d326442fed540c599a1cd8" style="zoom:80%;" />

<h4 id="6-6-GridView"><a href="#6-6-GridView" class="headerlink" title="6.6 GridView"></a>6.6 GridView</h4><p>GridView 可以构建一个二维网格列表</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">GridView(&#123;</span><br><span class="line">    Key? key,</span><br><span class="line">    Axis scrollDirection = Axis.vertical,</span><br><span class="line">    <span class="built_in">bool</span> reverse = <span class="keyword">false</span>,</span><br><span class="line">    ScrollController? controller,</span><br><span class="line">    <span class="built_in">bool?</span> primary,</span><br><span class="line">    ScrollPhysics? physics,</span><br><span class="line">    <span class="built_in">bool</span> shrinkWrap = <span class="keyword">false</span>,</span><br><span class="line">    EdgeInsetsGeometry? padding,</span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">this</span>.gridDelegate,  <span class="comment">//下面解释</span></span><br><span class="line">    <span class="built_in">bool</span> addAutomaticKeepAlives = <span class="keyword">true</span>,</span><br><span class="line">    <span class="built_in">bool</span> addRepaintBoundaries = <span class="keyword">true</span>,</span><br><span class="line">    <span class="built_in">double?</span> cacheExtent, </span><br><span class="line">    <span class="built_in">List</span>&lt;Widget&gt; children = <span class="keyword">const</span> &lt;Widget&gt;[],</span><br><span class="line">    ...</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<p>gridDelegate 类型是 SliverGridDelegate，作用是控制 GridView 子组件如何排列（layout）</p>
<p>Flutter 提供了 SliverGridDelegate 的子类，SliverGridDelegateWithFixedCrossAxisCount，SliverGridDelegateWithMaxCrossAxisExtent</p>
<ul>
<li>SliverGridDelegateWithFixedCrossAxisCount</li>
</ul>
<p>该子类实现了一个横轴为固定数量子元素的 layout 算法</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">SliverGridDelegateWithFixedCrossAxisCount(&#123;</span><br><span class="line">  <span class="meta">@required</span> <span class="built_in">double</span> crossAxisCount,  <span class="comment">//横轴子元素数量</span></span><br><span class="line">  <span class="built_in">double</span> mainAxisSpacing = <span class="number">0.0</span>, <span class="comment">//主轴方向间距</span></span><br><span class="line">  <span class="built_in">double</span> crossAxisSpacing = <span class="number">0.0</span>, <span class="comment">//横轴方向子元素间距</span></span><br><span class="line">  <span class="built_in">double</span> childAspectRatio = <span class="number">1.0</span>, </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>childAspectRatio：子元素在横轴长度和主轴长度的比例</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">GridView(</span><br><span class="line">  gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(</span><br><span class="line">      crossAxisCount: <span class="number">3</span>, <span class="comment">//横轴三个子widget</span></span><br><span class="line">      childAspectRatio: <span class="number">1.0</span> <span class="comment">//宽高比为1时，子widget</span></span><br><span class="line">  ),</span><br><span class="line">  children:&lt;Widget&gt;[</span><br><span class="line">    Icon(Icons.ac_unit),</span><br><span class="line">    Icon(Icons.airport_shuttle),</span><br><span class="line">    Icon(Icons.all_inclusive),</span><br><span class="line">    Icon(Icons.beach_access),</span><br><span class="line">    Icon(Icons.cake),</span><br><span class="line">    Icon(Icons.free_breakfast)</span><br><span class="line">  ]</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》六：可滚动组件/WeChat1903ec58a90f35b79a5be2f22e6d67bb.png" alt="WeChat1903ec58a90f35b79a5be2f22e6d67bb" style="zoom:80%;" />

<p>子元素的大小通过 crossAxisCount 和 childAspectRatio 两个参数共同决定的</p>
<h5 id="GridView-count"><a href="#GridView-count" class="headerlink" title="GridView.count"></a>GridView.count</h5><p>构造函数，通过它可以快速创建横轴固定数量子元素的 GridView，上面代码等价于</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">GridView.count( </span><br><span class="line">  crossAxisCount: <span class="number">3</span>,</span><br><span class="line">  childAspectRatio: <span class="number">1.0</span>,</span><br><span class="line">  children: &lt;Widget&gt;[</span><br><span class="line">    Icon(Icons.ac_unit),</span><br><span class="line">    Icon(Icons.airport_shuttle),</span><br><span class="line">    Icon(Icons.all_inclusive),</span><br><span class="line">    Icon(Icons.beach_access),</span><br><span class="line">    Icon(Icons.cake),</span><br><span class="line">    Icon(Icons.free_breakfast),</span><br><span class="line">  ],</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<ul>
<li>SliverGridDelegateWithMaxCrossAxisExtent</li>
</ul>
<p>该子类实现一个横轴子元素为固定最大长度的 layout 算法</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">SliverGridDelegateWithMaxCrossAxisExtent(&#123;</span><br><span class="line">  <span class="built_in">double</span> maxCrossAxisExtent,</span><br><span class="line">  <span class="built_in">double</span> mainAxisSpacing = <span class="number">0.0</span>,</span><br><span class="line">  <span class="built_in">double</span> crossAxisSpacing = <span class="number">0.0</span>,</span><br><span class="line">  <span class="built_in">double</span> childAspectRatio = <span class="number">1.0</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>maxCrossAxisExtent：子元素在横轴上最大长度，横轴方向上每个子元素的长度仍然是等分的</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">GridView(</span><br><span class="line">  padding: EdgeInsets.zero,</span><br><span class="line">  gridDelegate: SliverGridDelegateWithMaxCrossAxisExtent(</span><br><span class="line">      maxCrossAxisExtent: <span class="number">120.0</span>,</span><br><span class="line">      childAspectRatio: <span class="number">2.0</span> <span class="comment">//宽高比为2</span></span><br><span class="line">  ),</span><br><span class="line">  children: &lt;Widget&gt;[</span><br><span class="line">    Icon(Icons.ac_unit),</span><br><span class="line">    Icon(Icons.airport_shuttle),</span><br><span class="line">    Icon(Icons.all_inclusive),</span><br><span class="line">    Icon(Icons.beach_access),</span><br><span class="line">    Icon(Icons.cake),</span><br><span class="line">    Icon(Icons.free_breakfast),</span><br><span class="line">  ],</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》六：可滚动组件/WeChatae018d1dc24fdb3bad25c5536cf3294b.png" alt="WeChatae018d1dc24fdb3bad25c5536cf3294b" style="zoom:80%;" />

<h5 id="GridView-extent"><a href="#GridView-extent" class="headerlink" title="GridView.extent"></a>GridView.extent</h5><p>构造函数，通过它可以快速构建纵轴子元素为固定最大长度的 GridView，上面代码等价于</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">GridView.extent(</span><br><span class="line">   maxCrossAxisExtent: <span class="number">120.0</span>,</span><br><span class="line">   childAspectRatio: <span class="number">2.0</span>,</span><br><span class="line">   children: &lt;Widget&gt;[</span><br><span class="line">     Icon(Icons.ac_unit),</span><br><span class="line">     Icon(Icons.airport_shuttle),</span><br><span class="line">     Icon(Icons.all_inclusive),</span><br><span class="line">     Icon(Icons.beach_access),</span><br><span class="line">     Icon(Icons.cake),</span><br><span class="line">     Icon(Icons.free_breakfast),</span><br><span class="line">   ],</span><br><span class="line"> );</span><br></pre></td></tr></table></figure>

<h5 id="GridView-builder"><a href="#GridView-builder" class="headerlink" title="GridView.builder"></a>GridView.builder</h5><p>上面介绍的都需要一个 widget 数组作为其子元素，适用于子 widget 数量比较少，子 widget 比较多时，可以通过 GridView.builder 来动态构建子 widget</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">GridView.builder(</span><br><span class="line"> ...</span><br><span class="line"> <span class="keyword">required</span> SliverGridDelegate gridDelegate, </span><br><span class="line"> <span class="keyword">required</span> IndexedWidgetBuilder itemBuilder,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>示例</li>
</ul>
<p>异步数据源分批获取 Icon</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InfiniteGridView</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _InfiniteGridViewState createState() =&gt; _InfiniteGridViewState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_InfiniteGridViewState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">InfiniteGridView</span>&gt; </span>&#123;</span><br><span class="line">  <span class="built_in">List</span>&lt;IconData&gt; _icons = []; <span class="comment">//保存Icon数据</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    <span class="comment">// 初始化数据</span></span><br><span class="line">    _retrieveIcons();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> GridView.builder(</span><br><span class="line">      gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(</span><br><span class="line">        crossAxisCount: <span class="number">3</span>, <span class="comment">//每行三列</span></span><br><span class="line">        childAspectRatio: <span class="number">1.0</span>, <span class="comment">//显示区域宽高相等</span></span><br><span class="line">      ),</span><br><span class="line">      itemCount: _icons.length,</span><br><span class="line">      itemBuilder: (context, index) &#123;</span><br><span class="line">        <span class="comment">//如果显示到最后一个并且Icon总数小于200时继续获取数据</span></span><br><span class="line">        <span class="keyword">if</span> (index == _icons.length - <span class="number">1</span> &amp;&amp; _icons.length &lt; <span class="number">200</span>) &#123;</span><br><span class="line">          _retrieveIcons();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Icon(_icons[index]);</span><br><span class="line">      &#125;,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//模拟异步获取数据</span></span><br><span class="line">  <span class="keyword">void</span> _retrieveIcons() &#123;</span><br><span class="line">    Future.delayed(<span class="built_in">Duration</span>(milliseconds: <span class="number">200</span>)).then((e) &#123;</span><br><span class="line">      setState(() &#123;</span><br><span class="line">        _icons.addAll([</span><br><span class="line">          Icons.ac_unit,</span><br><span class="line">          Icons.airport_shuttle,</span><br><span class="line">          Icons.all_inclusive,</span><br><span class="line">          Icons.beach_access,</span><br><span class="line">          Icons.cake,</span><br><span class="line">          Icons.free_breakfast,</span><br><span class="line">        ]);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>_retrieveIcons() 方法中通过 Future.delayed 模拟异步数据源获取数据，每次获取数据 200 毫秒，调用 setState 重新构建</p>
<h4 id="6-7-PageView-与页面缓存"><a href="#6-7-PageView-与页面缓存" class="headerlink" title="6.7 PageView 与页面缓存"></a>6.7 PageView 与页面缓存</h4><h5 id="6-7-1-PageView"><a href="#6-7-1-PageView" class="headerlink" title="6.7.1 PageView"></a>6.7.1 PageView</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">PageView(&#123;</span><br><span class="line">  Key? key,</span><br><span class="line">  <span class="keyword">this</span>.scrollDirection = Axis.horizontal, <span class="comment">// 滑动方向</span></span><br><span class="line">  <span class="keyword">this</span>.reverse = <span class="keyword">false</span>,</span><br><span class="line">  PageController? controller,</span><br><span class="line">  <span class="keyword">this</span>.physics,</span><br><span class="line">  <span class="built_in">List</span>&lt;Widget&gt; children = <span class="keyword">const</span> &lt;Widget&gt;[],</span><br><span class="line">  <span class="keyword">this</span>.onPageChanged,</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//每次滑动是否强制切换整个页面，如果为false，则会根据实际的滑动距离显示页面</span></span><br><span class="line">  <span class="keyword">this</span>.pageSnapping = <span class="keyword">true</span>,</span><br><span class="line">  <span class="comment">//主要是配合辅助功能用的，后面解释</span></span><br><span class="line">  <span class="keyword">this</span>.allowImplicitScrolling = <span class="keyword">false</span>,</span><br><span class="line">  <span class="comment">//后面解释</span></span><br><span class="line">  <span class="keyword">this</span>.padEnds = <span class="keyword">true</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>示例</li>
</ul>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Tab 页面</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Page</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> Page(&#123;</span><br><span class="line">    Key? key,</span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">this</span>.text,</span><br><span class="line">  &#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> text;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _PageState createState() =&gt; _PageState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_PageState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">Page</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;build <span class="subst">$&#123;widget.text&#125;</span>&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> Center(child: Text(<span class="string">&#x27;<span class="subst">$&#123;widget.text&#125;</span>&#x27;</span>, textScaleFactor: <span class="number">5</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建 PageView</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PageViewRoute</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> children = &lt;Widget&gt;[];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) &#123; <span class="comment">//生成6个Tab页面</span></span><br><span class="line">      children.add(Page(text: <span class="string">&#x27;<span class="subst">$i</span>&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(title: Text(<span class="string">&#x27;标题&#x27;</span>)),</span><br><span class="line">      body: PageView(</span><br><span class="line">        children: children,</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行后就可以滑动来回切换页面了</p>
<img src="《Flutter实战第二版》六：可滚动组件/WeChat6ff7e4dc572a88cb6f32c91d7b3a5956.png" alt="WeChat6ff7e4dc572a88cb6f32c91d7b3a5956" style="zoom:80%;" />

<h5 id="6-7-2-页面缓存"><a href="#6-7-2-页面缓存" class="headerlink" title="6.7.2 页面缓存"></a>6.7.2 页面缓存</h5><p>上面每当页面切换时都会重新触发 Page 页的 build</p>
<p>allowImplicitScrolling 设置为 true，前后各缓存一个页面宽度</p>
<h4 id="6-8-可滚动组件子项缓存-KeepAlive"><a href="#6-8-可滚动组件子项缓存-KeepAlive" class="headerlink" title="6.8 可滚动组件子项缓存 KeepAlive"></a>6.8 可滚动组件子项缓存 KeepAlive</h4><p>ListView 有一个 addAutomaticKeepAlives 属性如果为 true，则 ListView 会为每一个列表项添加一个 AutomaticKeeyAlive 父组件</p>
<h5 id="6-8-1-AutomaticKeeyAlive"><a href="#6-8-1-AutomaticKeeyAlive" class="headerlink" title="6.8.1 AutomaticKeeyAlive"></a>6.8.1 AutomaticKeeyAlive</h5><p>AutomaticKeeyAlive 组件的主要作用是将列表项的 RenderObject 的 keepAlive 按需自动标记为 true 或 false</p>
<p>将列表组件的 Viewport 区域 + cacheExtent（预渲染区域）称为加载区域</p>
<p>keepAlive 标记为 false 时，如果列表项滑出加载区域时，列表组件将会被销毁</p>
<p>keepAlive 标记为 true 时，当列表项滑出加载区域后，Viewport 会将列表组件缓存起来，当列表项进入加载区域时，Viewport 从先缓存中查找是否已缓存，如果有则复用，没有则重新创建列表项</p>
<ul>
<li>让 PageView 示例实现页面缓存 </li>
</ul>
<p>Flutter 提供了一个 AutomaticKeepAliveClientMixin，只需让 PageState 混入这个 mixin，同时添加一些必要操作即可</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_PageState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">Page</span>&gt; <span class="title">with</span> <span class="title">AutomaticKeepAliveClientMixin</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">get</span> wantKeepAlive =&gt; <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">super</span>.build(context);<span class="comment">//必须调用</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;build <span class="subst">$&#123;widget.text&#125;</span>&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> Center(child: Text(<span class="string">&#x27;<span class="subst">$&#123;widget.text&#125;</span>&#x27;</span>, textScaleFactor: <span class="number">5</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="6-8-2-KeepAliveWrapper"><a href="#6-8-2-KeepAliveWrapper" class="headerlink" title="6.8.2 KeepAliveWrapper"></a>6.8.2 KeepAliveWrapper</h5><p>作者分装的组件，如果哪个列表项需要缓存，只需要使用 KeepAliveWrapper 包裹下即可</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="meta">@override</span></span><br><span class="line">Widget build(BuildContext context) &#123;</span><br><span class="line">  <span class="keyword">var</span> children = &lt;Widget&gt;[];</span><br><span class="line">  <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">6</span>; ++i) &#123;</span><br><span class="line">    <span class="comment">//只需要用 KeepAliveWrapper 包装一下即可</span></span><br><span class="line">    children.add(KeepAliveWrapper(child:Page( text: <span class="string">&#x27;<span class="subst">$i</span>&#x27;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> PageView(children: children);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>KeepAliveWrapper 源码 </p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KeepAliveWrapper</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> KeepAliveWrapper(&#123;</span><br><span class="line">    Key? key,</span><br><span class="line">    <span class="keyword">this</span>.keepAlive = <span class="keyword">true</span>,</span><br><span class="line">    <span class="keyword">required</span> <span class="keyword">this</span>.child,</span><br><span class="line">  &#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">bool</span> keepAlive;</span><br><span class="line">  <span class="keyword">final</span> Widget child;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _KeepAliveWrapperState createState() =&gt; _KeepAliveWrapperState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_KeepAliveWrapperState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">KeepAliveWrapper</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="title">with</span> <span class="title">AutomaticKeepAliveClientMixin</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">super</span>.build(context);</span><br><span class="line">    <span class="keyword">return</span> widget.child;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> didUpdateWidget(<span class="keyword">covariant</span> KeepAliveWrapper oldWidget) &#123;</span><br><span class="line">    <span class="keyword">if</span>(oldWidget.keepAlive != widget.keepAlive) &#123;</span><br><span class="line">      <span class="comment">// keepAlive 状态需要更新，实现在 AutomaticKeepAliveClientMixin 中</span></span><br><span class="line">      updateKeepAlive();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">super</span>.didUpdateWidget(oldWidget);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="built_in">bool</span> <span class="keyword">get</span> wantKeepAlive =&gt; widget.keepAlive;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ListView 中测试下 </p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KeepAliveTest</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> KeepAliveTest(&#123;Key? key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> ListView.builder(itemBuilder: (_, index) &#123;</span><br><span class="line">      <span class="keyword">return</span> KeepAliveWrapper(</span><br><span class="line">        <span class="comment">// 为 true 后会缓存所有的列表项，列表项将不会销毁。</span></span><br><span class="line">        <span class="comment">// 为 false 时，列表项滑出预加载区域后将会别销毁。</span></span><br><span class="line">        <span class="comment">// 使用时一定要注意是否必要，因为对所有列表项都缓存的会导致更多的内存消耗</span></span><br><span class="line">        keepAlive: <span class="keyword">true</span>,</span><br><span class="line">        child: ListItem(index: index),</span><br><span class="line">      );</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ListItem</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ListItem(&#123;Key? key, <span class="keyword">required</span> <span class="keyword">this</span>.index&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">int</span> index;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _ListItemState createState() =&gt; _ListItemState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_ListItemState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">ListItem</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> ListTile(title: Text(<span class="string">&#x27;<span class="subst">$&#123;widget.index&#125;</span>&#x27;</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;dispose <span class="subst">$&#123;widget.index&#125;</span>&#x27;</span>);</span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-9-TabBarView"><a href="#6-9-TabBarView" class="headerlink" title="6.9 TabBarView"></a>6.9 TabBarView</h4><h5 id="6-9-1-TabBarView"><a href="#6-9-1-TabBarView" class="headerlink" title="6.9.1 TabBarView"></a>6.9.1 TabBarView</h5><p>TabBarView 封装了 PageView </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> TabBarView(&#123;</span><br><span class="line">  Key? key,</span><br><span class="line">  required this.children, &#x2F;&#x2F; tab 页</span><br><span class="line">  this.controller, &#x2F;&#x2F; TabController</span><br><span class="line">  this.physics,</span><br><span class="line">  this.dragStartBehavior &#x3D; DragStartBehavior.start,</span><br><span class="line">&#125;) </span><br></pre></td></tr></table></figure>

<p>TabController 用于监听和控制 TabBarView 的页面切换，通常和 TabBar 联动，如果没有指定，则会在组件树中向上查找并使用最近一个 DefaultTabController</p>
<h5 id="6-9-2-TabBar"><a href="#6-9-2-TabBar" class="headerlink" title="6.9.2 TabBar"></a>6.9.2 TabBar</h5><img src="《Flutter实战第二版》六：可滚动组件/image-20210822144239879.02ae3d67.png" alt="image-20210822144239879.02ae3d67" style="zoom: 67%;" />

<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> TabBar(&#123;</span><br><span class="line">  Key? key,</span><br><span class="line">  <span class="keyword">required</span> <span class="keyword">this</span>.tabs, <span class="comment">// 具体的 Tabs，需要我们创建</span></span><br><span class="line">  <span class="keyword">this</span>.controller,</span><br><span class="line">  <span class="keyword">this</span>.isScrollable = <span class="keyword">false</span>, <span class="comment">// 是否可以滑动</span></span><br><span class="line">  <span class="keyword">this</span>.padding,</span><br><span class="line">  <span class="keyword">this</span>.indicatorColor,<span class="comment">// 指示器颜色，默认是高度为2的一条下划线</span></span><br><span class="line">  <span class="keyword">this</span>.automaticIndicatorColorAdjustment = <span class="keyword">true</span>,</span><br><span class="line">  <span class="keyword">this</span>.indicatorWeight = <span class="number">2.0</span>,<span class="comment">// 指示器高度</span></span><br><span class="line">  <span class="keyword">this</span>.indicatorPadding = EdgeInsets.zero, <span class="comment">//指示器padding</span></span><br><span class="line">  <span class="keyword">this</span>.indicator, <span class="comment">// 指示器</span></span><br><span class="line">  <span class="keyword">this</span>.indicatorSize, <span class="comment">// 指示器长度，有两个可选值，一个tab的长度，一个是label长度</span></span><br><span class="line">  <span class="keyword">this</span>.labelColor, </span><br><span class="line">  <span class="keyword">this</span>.labelStyle,</span><br><span class="line">  <span class="keyword">this</span>.labelPadding,</span><br><span class="line">  <span class="keyword">this</span>.unselectedLabelColor,</span><br><span class="line">  <span class="keyword">this</span>.unselectedLabelStyle,</span><br><span class="line">  <span class="keyword">this</span>.mouseCursor,</span><br><span class="line">  <span class="keyword">this</span>.onTap,</span><br><span class="line">  ...</span><br><span class="line">&#125;) </span><br></pre></td></tr></table></figure>

<p>TapBar 通常位于 AppBar 底部，也可以接收一个 TabController</p>
<p>Material 组件库中已实现了一个 Tab 组件，一般会直接使用它 </p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> Tab(&#123;</span><br><span class="line">  Key? key,</span><br><span class="line">  <span class="keyword">this</span>.text, <span class="comment">//文本</span></span><br><span class="line">  <span class="keyword">this</span>.icon, <span class="comment">// 图标</span></span><br><span class="line">  <span class="keyword">this</span>.iconMargin = <span class="keyword">const</span> EdgeInsets.only(bottom: <span class="number">10.0</span>),</span><br><span class="line">  <span class="keyword">this</span>.height,</span><br><span class="line">  <span class="keyword">this</span>.child, <span class="comment">// 自定义 widget</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h5 id="6-9-3-示例"><a href="#6-9-3-示例" class="headerlink" title="6.9.3 示例"></a>6.9.3 示例</h5><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TabViewRoute1</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _TabViewRoute1State createState() =&gt; _TabViewRoute1State();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_TabViewRoute1State</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">TabViewRoute1</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="title">with</span> <span class="title">SingleTickerProviderStateMixin</span> </span>&#123;</span><br><span class="line">  <span class="keyword">late</span> TabController _tabController;</span><br><span class="line">  <span class="built_in">List</span> tabs = [<span class="string">&quot;新闻&quot;</span>, <span class="string">&quot;历史&quot;</span>, <span class="string">&quot;图片&quot;</span>];</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    _tabController = TabController(length: tabs.length, vsync: <span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      appBar: AppBar(</span><br><span class="line">        title: Text(<span class="string">&quot;App Name&quot;</span>),</span><br><span class="line">        bottom: TabBar(</span><br><span class="line">          controller: _tabController,</span><br><span class="line">          tabs: tabs.map((e) =&gt; Tab(text: e)).toList(),</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">      body: TabBarView( <span class="comment">//构建</span></span><br><span class="line">        controller: _tabController,</span><br><span class="line">        children: tabs.map((e) &#123;</span><br><span class="line">          <span class="keyword">return</span> KeepAliveWrapper(</span><br><span class="line">            child: Container(</span><br><span class="line">              alignment: Alignment.center,</span><br><span class="line">              child: Text(e, textScaleFactor: <span class="number">5</span>),</span><br><span class="line">            ),</span><br><span class="line">          );</span><br><span class="line">        &#125;).toList(),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    <span class="comment">// 释放资源</span></span><br><span class="line">    _tabController.dispose();</span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<img src="《Flutter实战第二版》六：可滚动组件/WeChatfe6ded64a5b41253fae7d920235ca757.png" alt="WeChatfe6ded64a5b41253fae7d920235ca757" style="zoom:80%;" />

<p>为了实现 TabBar 和 TabBarView 的联动，显式创建了一个 TabController，TabController 又需要一个 TickerProvider（vsync参数）我们又混入了 SingleTickerProviderStateMixin ；TabController 中会执行动画，持有一些资源，所以在页面销毁时必须得释放资源</p>
<p>实战中，如果需要 TabBar 和 TabBarView 联动，通常会创建一个 DefaultTabController 作为他们共同的父级组件，这样它们在执行时就会从组件树向上查找，都会使用我们指定的这个 DefaultTabController，修改后如下</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TabViewRoute2</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="built_in">List</span> tabs = [<span class="string">&quot;新闻&quot;</span>, <span class="string">&quot;历史&quot;</span>, <span class="string">&quot;图片&quot;</span>];</span><br><span class="line">    <span class="keyword">return</span> DefaultTabController(</span><br><span class="line">      length: tabs.length,</span><br><span class="line">      child: Scaffold(</span><br><span class="line">        appBar: AppBar(</span><br><span class="line">          title: Text(<span class="string">&quot;App Name&quot;</span>),</span><br><span class="line">          bottom: TabBar(</span><br><span class="line">            tabs: tabs.map((e) =&gt; Tab(text: e)).toList(),</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">        body: TabBarView( <span class="comment">//构建</span></span><br><span class="line">          children: tabs.map((e) &#123;</span><br><span class="line">            <span class="keyword">return</span> KeepAliveWrapper(</span><br><span class="line">              child: Container(</span><br><span class="line">                alignment: Alignment.center,</span><br><span class="line">                child: Text(e, textScaleFactor: <span class="number">5</span>),</span><br><span class="line">              ),</span><br><span class="line">            );</span><br><span class="line">          &#125;).toList(),</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到我们无需去手动管理Controller的生命周期，也不需要提供 SingleTickerProviderStateMixin，同时也没有其它的状态需要管理，也就不需要用 StatefulWidget 了</p>
<h4 id="6-10-CustomScrollView-和-Slivers"><a href="#6-10-CustomScrollView-和-Slivers" class="headerlink" title="6.10 CustomScrollView 和 Slivers"></a>6.10 CustomScrollView 和 Slivers</h4><h5 id="6-10-1-CustomScrollView"><a href="#6-10-1-CustomScrollView" class="headerlink" title="6.10.1 CustomScrollView"></a>6.10.1 CustomScrollView</h5><p>Flutter 提供了一个 CustomScrollView 组件帮助我们创建一个公共的 Scrollable 和 Viewport，然后它的 slivers 参数接受一个 Sliver 数组</p>
<p>加入我们想要在一个页面中，同时包含多个可滚动组件，且使他们的滑动效果统一起来</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">Widget buildTwoSliverList() &#123;</span><br><span class="line">  <span class="comment">// SliverFixedExtentList 是一个 Sliver，它可以生成高度相同的列表项。</span></span><br><span class="line">  <span class="comment">// 再次提醒，如果列表项高度相同，我们应该优先使用SliverFixedExtentList </span></span><br><span class="line">  <span class="comment">// 和 SliverPrototypeExtentList，如果不同，使用 SliverList.</span></span><br><span class="line">  <span class="keyword">var</span> listView = SliverFixedExtentList(</span><br><span class="line">    itemExtent: <span class="number">56</span>, <span class="comment">//列表项高度固定</span></span><br><span class="line">    delegate: SliverChildBuilderDelegate(</span><br><span class="line">      (_, index) =&gt; ListTile(title: Text(<span class="string">&#x27;<span class="subst">$index</span>&#x27;</span>)),</span><br><span class="line">      childCount: <span class="number">10</span>,</span><br><span class="line">    ),</span><br><span class="line">  );</span><br><span class="line">  <span class="comment">// 使用</span></span><br><span class="line">  <span class="keyword">return</span> CustomScrollView(</span><br><span class="line">    slivers: [</span><br><span class="line">      listView,</span><br><span class="line">      listView,</span><br><span class="line">    ],</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="《Flutter实战第二版》六：可滚动组件/combine-twolist.74a615bf.gif" alt="combine-twolist.74a615bf" style="zoom:80%;" />

<h5 id="6-10-2-Flutter-中常用的Sliver"><a href="#6-10-2-Flutter-中常用的Sliver" class="headerlink" title="6.10.2 Flutter 中常用的Sliver"></a>6.10.2 Flutter 中常用的Sliver</h5><table>
<thead>
<tr>
<th>Sliver名称</th>
<th>功能</th>
<th>对应的可滚动组件</th>
</tr>
</thead>
<tbody><tr>
<td>SliverList</td>
<td>列表</td>
<td>ListView</td>
</tr>
<tr>
<td>SliverFixedExtentList</td>
<td>高度固定的列表</td>
<td>ListView，指定<code>itemExtent</code>时</td>
</tr>
<tr>
<td>SliverAnimatedList</td>
<td>添加/删除列表项可以执行动画</td>
<td>AnimatedList</td>
</tr>
<tr>
<td>SliverGrid</td>
<td>网格</td>
<td>GridView</td>
</tr>
<tr>
<td>SliverPrototypeExtentList</td>
<td>根据原型生成高度固定的列表</td>
<td>ListView，指定<code>prototypeItem</code> 时</td>
</tr>
<tr>
<td>SliverFillViewport</td>
<td>包含多给子组件，每个都可以填满屏幕</td>
<td>PageView</td>
</tr>
</tbody></table>
<p>除了和列表对应的 Sliver 之外还有一些用于对 Sliver 进行布局、装饰的组件，<strong>它们的子组件必须是 Sliver</strong>，我们列举几个常用的</p>
<table>
<thead>
<tr>
<th>Sliver名称</th>
<th>对应 RenderBox</th>
</tr>
</thead>
<tbody><tr>
<td>SliverPadding</td>
<td>Padding</td>
</tr>
<tr>
<td>SliverVisibility、SliverOpacity</td>
<td>Visibility、Opacity</td>
</tr>
<tr>
<td>SliverFadeTransition</td>
<td>FadeTransition</td>
</tr>
<tr>
<td>SliverLayoutBuilder</td>
<td>LayoutBuilder</td>
</tr>
</tbody></table>
<p>还有一些其它常用的 Sliver</p>
<table>
<thead>
<tr>
<th>Sliver名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>SliverAppBar</td>
<td>对应 AppBar，主要是为了在 CustomScrollView 中使用。</td>
</tr>
<tr>
<td>SliverToBoxAdapter</td>
<td>一个适配器，可以将 RenderBox 适配为 Sliver，后面介绍。</td>
</tr>
<tr>
<td>SliverPersistentHeader</td>
<td>滑动到顶部时可以固定住，后面介绍。</td>
</tr>
</tbody></table>
<ul>
<li>示例</li>
</ul>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 因为本路由没有使用 Scaffold，为了让子级Widget(如Text)使用</span></span><br><span class="line"><span class="comment">// Material Design 默认的样式风格,我们使用 Material 作为本路由的根。</span></span><br><span class="line">Material(</span><br><span class="line">  child: CustomScrollView(</span><br><span class="line">    slivers: &lt;Widget&gt;[</span><br><span class="line">      <span class="comment">// AppBar，包含一个导航栏.</span></span><br><span class="line">      SliverAppBar(</span><br><span class="line">        pinned: <span class="keyword">true</span>, <span class="comment">// 滑动到顶端时会固定住</span></span><br><span class="line">        expandedHeight: <span class="number">250.0</span>,</span><br><span class="line">        flexibleSpace: FlexibleSpaceBar(</span><br><span class="line">          title: <span class="keyword">const</span> Text(<span class="string">&#x27;Demo&#x27;</span>),</span><br><span class="line">          background: Image.asset(</span><br><span class="line">            <span class="string">&quot;./imgs/sea.png&quot;</span>,</span><br><span class="line">            fit: BoxFit.cover,</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">      SliverPadding(</span><br><span class="line">        padding: <span class="keyword">const</span> EdgeInsets.all(<span class="number">8.0</span>),</span><br><span class="line">        sliver: SliverGrid(</span><br><span class="line">          <span class="comment">//Grid</span></span><br><span class="line">          gridDelegate: SliverGridDelegateWithFixedCrossAxisCount(</span><br><span class="line">            crossAxisCount: <span class="number">2</span>, <span class="comment">//Grid按两列显示</span></span><br><span class="line">            mainAxisSpacing: <span class="number">10.0</span>,</span><br><span class="line">            crossAxisSpacing: <span class="number">10.0</span>,</span><br><span class="line">            childAspectRatio: <span class="number">4.0</span>,</span><br><span class="line">          ),</span><br><span class="line">          delegate: SliverChildBuilderDelegate(</span><br><span class="line">            (BuildContext context, <span class="built_in">int</span> index) &#123;</span><br><span class="line">              <span class="comment">//创建子widget</span></span><br><span class="line">              <span class="keyword">return</span> Container(</span><br><span class="line">                alignment: Alignment.center,</span><br><span class="line">                color: Colors.cyan[<span class="number">100</span> * (index % <span class="number">9</span>)],</span><br><span class="line">                child: Text(<span class="string">&#x27;grid item <span class="subst">$index</span>&#x27;</span>),</span><br><span class="line">              );</span><br><span class="line">            &#125;,</span><br><span class="line">            childCount: <span class="number">20</span>,</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">      SliverFixedExtentList(</span><br><span class="line">        itemExtent: <span class="number">50.0</span>,</span><br><span class="line">        delegate: SliverChildBuilderDelegate(</span><br><span class="line">          (BuildContext context, <span class="built_in">int</span> index) &#123;</span><br><span class="line">            <span class="comment">//创建列表项</span></span><br><span class="line">            <span class="keyword">return</span> Container(</span><br><span class="line">              alignment: Alignment.center,</span><br><span class="line">              color: Colors.lightBlue[<span class="number">100</span> * (index % <span class="number">9</span>)],</span><br><span class="line">              child: Text(<span class="string">&#x27;list item <span class="subst">$index</span>&#x27;</span>),</span><br><span class="line">            );</span><br><span class="line">          &#125;,</span><br><span class="line">          childCount: <span class="number">20</span>,</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    ],</span><br><span class="line">  ),</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>头部 SliverAppBar：SliverAppBar 对应 APPBar，不同之处在于 SliverAppBar 可以集成到 CustomScrollView， SliverAppBar 可以结合 FlexibleSpaceBar 实现Material Design 中头部伸缩的模型</p>
<p>中间 SliverGrid：它用 SliverPadding 包裹以给 SliverGrid 添加补白。SliverGrid 是一个两列，宽高比为4的网格，它有20个子组件</p>
<p>底部SliverFixedExtentList：它是一个所有子元素高度都为50像素的列表</p>
<img src="《Flutter实战第二版》六：可滚动组件/WeChata2a92923087dac38a2ad6c5e16f9cfb4.png" alt="WeChata2a92923087dac38a2ad6c5e16f9cfb4" style="zoom:80%;" />

<ul>
<li>SliverToBoxAdapter</li>
</ul>
<p>实际布局中，通常需要在 CustomScrollView 中添加一些自定义组件，这些组件并非都有 Sliver 版本，为此 Flutter 提供了一个 SliverToBoxAdapter 组件，是一个适配器，可以将 RenderBox 适配为 Sliver。</p>
<p>比如想在列表顶部加一个可以横向滚动的 PageView，可以使用 SliverToBoxAdapter 来适配</p>
<figure class="highlight dart"><table><tr><td class="code"><pre><span class="line">CustomScrollView(</span><br><span class="line">  slivers: [</span><br><span class="line">    SliverToBoxAdapter(</span><br><span class="line">      child: SizedBox(</span><br><span class="line">        height: <span class="number">300</span>,</span><br><span class="line">        child: PageView(</span><br><span class="line">          children: [Text(<span class="string">&quot;1&quot;</span>), Text(<span class="string">&quot;2&quot;</span>)],</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    ),</span><br><span class="line">    buildSliverFixedList(),</span><br><span class="line">  ],</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<ul>
<li>SliverPersistentHeader</li>
</ul>
<p>SliverPersistentHeader 的功能是当滑动到 CustomScrollView 的顶部时，可以将组件固定在顶部</p>
<h4 id="6-11-自定义-Sliver"><a href="#6-11-自定义-Sliver" class="headerlink" title="6.11 自定义 Sliver"></a>6.11 自定义 Sliver</h4><h4 id="6-12-嵌套可滚动组件-NestedScrollView"><a href="#6-12-嵌套可滚动组件-NestedScrollView" class="headerlink" title="6.12 嵌套可滚动组件 NestedScrollView"></a>6.12 嵌套可滚动组件 NestedScrollView</h4><p>CustomScrollView 只能组合 Sliver，如果有孩子也是可滚动组件（通过SliverToBoxAdapter嵌入）且他们滑动方向一致时便不能正常工作，解决这个问题 NestedScrollView</p>
]]></content>
  </entry>
  <entry>
    <title>anti</title>
    <url>/2021/12/06/anti/</url>
    <content><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <div class="hbe-input-container">
  <input type="password" id="hbePass" placeholder="" />
    <label for="hbePass">输入密码</label>
    <div class="bottom-line"></div>
  </div>
  <script id="hbeData" type="hbeData" data-hmacdigest="f399bcd89cd99dd295add6f637e534163715188e89a01b1e0fd8780ce1bf889c">850b39b29b344cb8879ce9506751f488737aa98aafe5116b1a87c0f3817fa6c5dc3e5d386f2d27acd20ce85e0b913e97942ae38c914ae58955b62546f2205be7a78c7953e3f6dabf6be714ea6fc8fdf0dd132891e9d4d55b857ae024b7b89e026211c582d6c726fc3c054b2f8208f6d95ef410cf8ad266840868d420b0acc6237a26d881dce929ca86e5dc1130293d5c74000a2f5991c9831074d5472abff9824bef927bea06a20f54255b10f16f81a8222632ad761ecaac75914fec3ebb7e88ed3c49d7610a8b2836062f9241893eebadc5d8326b089e3edf002e9ac96eb47c14b749108710bbe586f669e521880db7655509cd04cc904e81273363bf3d3db5976973dc8fd3fcdf74f390d8e5900276f5f7f5ed3c1f6622e4796cd59c7e42af70ea22c84d78aa3e7285d685171d503a9c5e8a6da2f538648eae1ce1068e002eeafb965814cd96c57deb9d25acc217ec738bac5f267319163e0bbbe4b9484267b38fe85f7dcabd8fa0dca2242ba150156766d931b3f1c58336e27b30f68433fee7d69b950df87b7a31e8da7c0192ef237d0940d27230d401c80f1cb764b643bf520ed965b67d500691ef14b074af4d2df422e9e55c44254afe92f7cdd8efd03e8d39d09c1c944e61f90315ecbe92f1c83c1d1729c0777e623a24a7a12464fcc110a7be73a697dbffda4f6f4a6cd2ae41539aa235425f70009e5fdbc6ae7f3cc22e5102e1a644861d6ee4154561f3227b8b9a0b00f02445ef575866d23b546c35000f3aeef390cb12b7dac3d20e13c8ef941549ba23eda743bb539933956a65759fd09cdb042cacd23f6769ee7f80113f1659595a5f567edf21cc582c72576f0d92ad2eeee39ce5f96357d6e346761f3223fab57e16ce69f2f40820ce84eb84b661549658a82e8fa72a14cd159b37cb587685c76f4a5207155a8fcf85f0f6862107d548672fe4c328ed80448a51f881d88066bc2f09e4e8f9bc803e8f540eaaae89876f0e6214fc14cd6a96d4a482dca97d3569b0e472405a89c7bf8a8b4aacd1fa06b12bbecc7b30b9f4b9766218aa33f551122fe53776187be3483e180826cb0fa6e8c636145593cb70bac930402697a5efb7fb8772a2224f0fa9055507be5704fe11a11fd5144bbbdc95b453fed0f997104e35efb9d15c8da481c3340b7fb6a86f013277d81c3b9e5b1cb3d86dd5a48ca779eb25dca63989d51a335104b9ddeeb73c614dbdb87e8638e99d4bb542a55471ba40e3bface490248cedbc53caacc03edff56de289849c8223f8d9fb48ed261b6f21cb5f5c5263264ce6690b866ddaee6e954ee8c2a251b3d5c579db8da30f9720a06e92f0e1f932aacb1f5edf6aa970ccef32109d738aa4321b0ed336d4438a1428a3e1e327442376922deaa9fa3a6b4179599ef01569f7e80047ff7735cfd58b9133256e57c228748937e2ab8f9ea4a1dcfddeed918c22cb1033183880febb70652fb16860ef74de45d0a9067b47854235dc9efab154baf8eb75a81ec20616604db5aeeeb9782b60a69fcc11eab22a934e2359cf2a444d0d787862d514bd683d718260b5f15b7f0d254c97cc3a5ab550aa8abb5cc0fad3a951a3efbfaeda89ad724db7ef55fe257dbd682fe51318936f2176e7f21ccb0862d20fe5b8e5322375f0f2fcedc9ad96b1745f7316b5e70b3bac9623575928a636416fa727a8de99febd24d79edc3cb3c71022178cb78cbd163cbb880aeea26e4793181399bb44b3a43c0bde9409ed1cec0a74fec70c2256778f23f054b0dd4f16f5557a50294f19f2c006e727a9d5cddc342bd41a0f21ddc7fd31c179e10a2139bc43d57c900ec5c4be5c941e627f128911fd796b7f97c689e5bf8ec9a73b682dc5cf912fb7037d09afff167a73ca11d74ae0ff7f5cfb9d4f17ce736bb454194abd61712881fc0bb3d2b27a6ae5eb7ecc7e3dd9d96a5793a7c8503091640f1b4c9898e7a651e4da3437d9028b0e1fbc5aeef3b23290dbe910bc51bf8901f997bd1307eefc4ab2b69f0fab7c2b63830c31e67ce5eaed248fcaef83469808eb79575f25672c1589d57adaf30fa3945180d76a847514c05aaf7d649248c5bd48328e6dde55100dead796a13efb5895d8e01769af03fc75e31b41a0be7d013d353ba5808560957a16f8646c55eb4f5b3ab1f1a0a46e03f94674dc1a3055ea2b1d2a1a89fbbae401c0ee47344aa9db6077e5d3e2c3245921d48a2c1ff448e6eabe19b9d3732af5c212719f4b6b6ab2d6cc949e6aafe3ef7a9cc8804d3417046e9831fa978ba09c4f166674da8e2ffc93fa78a3d8b918afc7561119c3610f9d3dfbce91cb89fc259091542aa3d1db7e71d299f2fe82451cc4e80202d252d310c7892688a48df3535ac45c80a71e84d11dd80a1acfed8993faec031144e9611bb316c9d9427f132abda96e8b7972cc3c8a0d57978cbc8710e3548606d7b9a45aff3f2a7e3b03d123f078493b0067626c4d4f05bfd574174dc1054c22dac3a79ac4431b90e23042906cad4fe20dfc630efdd27115a302c42fd81ee4600fa7984dc98ec07b050a2e6dc79fe2d62a5548c41ea29fc25fc2a8aa1b7a0447c4abcbb0c11bc59980b859dc13f25eaa6d7760d65ad6dd9dc61aed312d66fae3a59907f21c1ca15f7cba05006a29ab8ddd70ea7707107ee4eb5bb7b6429e9e46940c88c346a6ffbc0f4f34a5e2452963a57373128ca9dc23faced8bf277d7a9cc7dd1b25b6e67289e0fbf900c29bd05b20b9d35e3da06350b357ac1fce1fdf190173c7e5b9e7be2f1c29b86c7e396f1701e454ec5db6f191b8cb4bc5857360c8b99544e2a5609226525107a767f1f489b1a194a56c5ec888d80793b7a633df010519db4c3d080258d6cfc71976794d00dfdf3a6af905c80d18220c0458399579b9a41684c3c1f35e9e2401f7f731a66d2649855783d12ee0531d9038c2f9a7b0d26eb0ad94c03d0b7ddf39422acc4deaffd6a78a42d325309393d51c323d24c26b7333a879149d04687236631da216b252e1413d1ee3717595d7683d945afc7601e2c1317441c992722a9baf416ec9593a927781c4bf7f53a6d29494a4d3116c6559a5d275be0c5e0d79ef90dc29a3cd46a9f77adf4569d8eb9f1f936f1f3ebdad5464223aad19583676cd835a521aed31d18aec9b8c7ad801757c43115e625c575ae474687d55f04c84f669b53ff2646dc26d6ad3913d72365001d041e057c7269b2b07699feadb77b9a4f8dd4c6d391ef2af994a8a72d879091783ea80f7ee09f40fdd524cf19589aecd8356c6e6c1dc2831ad7d9b245422c68f2aa2e73bc19e8c5bb0d9760cbe7ffaf26027875e8dc1354ae1a27e01c674f6b58fa008336e8974a0f5caf9293156db4664586a5a712cc58de07e1c490627749e72b2baee48a792a15cbb49dd8678c0f2f72eb94501aaa63e3d5f048c09148b28609842068b83f22bf98e3b57fba9948b2390d745c917d61c3b96c4bf2a7a30e427206b93f9fe964d1adbaeee77c68b0ea9d994ac70c6da0aeaea001f85a7e42fe18897df09bbcc3fd89191a270056cb00a16cff5eb0cb2313c71132d50daf9371588283c16c32db5be459784f19a69fd4052a6c247cf8a5355fa3bc50861667b87952d1f04ea75afddc141c990bdae30a9c559b7a3a3c99bd59f5dd87d0301905390779f20f21bb6259c32c64c9efe3301fc470db0a61e3c1aa41336f3e18e453024ed29c48f9d3492a7011dae7024a59fd6b1e420801420daffc3d31d80c939ae804e0700039bf8fb3614eb50985298239c1d914ed15900d3eed2a059883ecc64ee12396ad2e1141e128e8b54cdae83366a60cbf2f531c09ca6efd3a4eaae66bc913672fdf698aa3dd855ccd6b18b89436e3bd81ea857f97fe3a9dcf42e3945875353d57f1a2f2613a025fe6e587f76c689a52b059f0ea2ad75daf6f5bb86874bc28fa2d6909a0c8f40c85e90465046ab9c6cc8c89a0272c6e5c04ef71f9db00e27cda3e51f742a49fe89c4b788eb2b21201b824c61ddcf7bc1bac27f3598a2c0d2b999c3a692f57ca9f2f3396d2e7d92f3ba73e0157d3b72ea31e06abbe7b04ebbbb7045159da80ec5d383ee07b6e6625633040e3f9756b8091857be0f627c07a50b86cc295ef9bf85d6e8a44781ddc09659f23f974b588502cc82ed2cefb6615a4d5136baf28f35894afcb0a9f630cbfd9146d28215159bb9c5223212e9b525c780cd9472890c74120376cc1412f104f7b737300398b885704b316296367aade0e60d6b0ffd8468e2c3e44fcf557c92d5851aa33ec37d8cc5b93cf97c8d4ec202042ff58af12c1f0c2daf4ce798e165971b2ca74683b41feea7aec3856557942be39afe518e5d1cc0fc020f96884e269fa57f58ec3c6373385db53a58f9a769b2cb0c922081616103f7297242392e7d8e9bae9aa82ac4589fd99b3e36e4045ed1b636c08eccb56d42d3583b8be84f520f650d37c53d8ae8e45c485d80b26894ff7484246a2c59f1a44d096d08ef23a9ca40c52336b79e0dcbafd5298ed15c0c9fe1cc3aa398b53ba060f4046ff4e3dc89c4eb34a230b81fa99c38e946a1218bd7f348983bfe777d0abba44f6bdae0432248d0f997bf65369c133498a5ab620969b38770c7893998ab7d483712de90ccd2c313c171dcc9c1516eba4e3699f3a06a06338b67abcb4bfa4c96586f312ce2adf5d783005628343ee25ab6350f72f9ebd7db425bdbb76c9e081e48c82f1db1f79e124beed93d8aa9715a84b76eb3186cb71a4f44e9937984673db0c505e94ade350625511f73346cca21b139511c1e9d8cbcfec5a5e4421a66060395576ec04c411d08114d279a52a91c1273d4f6d8f7e70ffe06cc8f7a9ae76b1dcb2606913e6459aa7b52ee31b7eaa1ff199e0a07bf4eecdc1e3234714edc06026db33df07b349e27c1f9687d137830d2126f1d88eb15f420633e6b3006023a5156d767958331a496a421c87f3e5550bc06a1ea8a1a2bc8c77bdf4e8b0ec736d874d32d47654eb8689a3f73228a5505c2412d27a0de0fdedf4bff869adc40abf5c691aab20b380182bdb18a54134d820691aa93ad429034a33f71cff3637dd9c1702152c783af46c45924b3545900b76e9fdffeb8a30d5d2042af35d1227ba2fdbfd512f50d4cc372e7aab8c8873f67ddd5d27f8e72937529d7b08c199b1655326ef231d197c43acc0d91dd9c36ad9ebf900c6edd93e29fe87f8435f09de470d0edacbeab237f7aa4aa6f79e5cbcfb58cee781d5b328c08404be8afbaf239e97200d929a37342dcb5cab8155b713c7e47bacefd3af68464eba62d400b23a2bab6efe9ce4b122328088760258a5e19b9a884abe4b7ef65bad8b0077f347c67b02903e6d1664119d73323a47d1d499350c1d270413e6627a2192df6a6cfc1c2fdb95ca2b65b9a76863ff78a3164f4c302457a1eae6eb29e763551682212c4bc2056672a65593beeb23d46b688639a52cad50667eb9376d324082940c78bc5fa9f39f703032cb47ec0abfd6f49ee08c49ecc389c3b97f6ae39c176143b715a8bb287d118dc7ddef1a3151c466a17dce6e968c3bf22fb914bda97d977a5333e9f3aa46de718a68e7c4d59a6eca5d0f3ff2e3e1a210329debf1f50bd6037b20c6a5f644a3d276447c52ca446ba99ac8d871c6e2ab680f3858f3d8f8742e5caca8a91f7082a324ead94448bdd13e729494ad8b03808927e34dd46396587e6bfdb0f298f940c29b1cd50fc9084d8ea16c145d1ae45d97d9a132658b2132d794029cbd35a5bf03f803710888cc688cebdbab2fc6cb6c4d7ca01a23c178174d926c0a5ca98e492beafafd4b3b728a4dfe39bc102876a5d2e09c8d59d642b8ee137f5a62f82665216f75d37c92ec14857cf0d93c4b8fb49042d94af346c789d7e0b99ec8dece04da8305d2fc032e0e67e483c80828f7e203537a72b4f4981b7217ce36e4f14625a2a7b5b1689843b9fb9e1850bd6ac16591935e12dfc617d8671f51548b99fe6a547d0289eed7878559d62946bc0ff340815591b7ec5a182b154f716cd68f9be07e56cff8d613171f93c50005b177f119104005a02aa3307916ee2e2c6d81761ff37be1b5f0448bc8949bb6908252ae7ba5cc765f16a07277e4235e4fe7df48f04f0a9531f39c0764f900f7b37ac1b5add8e584b081ea43b6ba39002461e6636d5f9ea4ed460ae53503e68f539297c02c55833d989c6a73e42231819453596b21c70a42d4ebc2e52fd603eca7d6b46f96758ea50d5c3c418196b94743acda5718dde5559d3809b7b0cf95d3b655e7cc01bb8595757572cedd2423f4df2ee1b85f31d205b39d9c9ba1380f32db4dcbb5b45412ccb2c9d4d20db7522502cd8b72c7b1e1e00c0027ec61d482dd1b2c16c693556deff15ec8e5e63232d475bb39ada52488e6c626903fc553e786e445515ce4b89d917bb8c0f952fbaad41836f8cc7013abd895c491eb40b08db0902d2b7b1357b85bbe6fbc1d36c3cb0d5a784a8d46cbce6b46f65c07714b424fed3d00ec7d6dc9b7f35373291ce31dcfc71e391e021568110e3430c8a23d00ab7413cc2f2d02c3c961abf38158e060c1dffd7a1cd9c2dc3c740d534348b7875b7e7d331cbc0fbdf285f893d36cb51ca616d4a43c80d0ff693dae454a5b681702e6cc2eb5082904180d48f678ca5775b44b02ded7ee3f6f99931b29bf4be1e83a6ccc06af532ae7e7ddb41914df60e1d92f39ca53ea437db575b52a18c34cbdebc42041cca7505c065e587610253f112af8a8cadf1c389449b67c7ed81105ab4610ca8baed7d8c255110dfe8bf8e7ea7d8f13d40fbe03624e5c3e32742097ee859a236a15cb20492ca284b1f521c2bc61745358121fdcb9d56947056932877768ee25232f172c8d259b8caaba6a03654a1974ff949846be4ec34215a37d4c8bd66b8c8d5bbc9025a5684ff9d1ba3e7a82ac1742ca0aa4426eeac740c742a80b3b5f5291c6e5589b377e80f8457b24fd0a207b06bf759f207224b322174ea3cd9ecb10cbc8baae8915fb1caaf344bda12e12b2af4a78654fec9033888fc1794f757fb1937f5a1e97afd04ffe225404e44f524a3475f493eb917388a679e93ec728cc70ef745d6187d2a32cf6946adef20482e0689296ffd15e7aca7f7e09c4d7698b5d3d955434df0860400766c9435d8bf3f1f43f1059102ce684d09842ed969fb4d4c211f74113eb0b8077a7fb06a4222b859463900bc7478a8ddd9e4ab037127bc2adc7f6c1226fbe51dd18dda637a9d79c9ab44d5aa7779a8b58b4214d128e112a8c98bf1541e27b789f679329b7812d58c67131f8c9652652612bf53d436da63462bbdde83a3bdbe90d640381a2e968274e974b4274314cd00a1011f02e433c547ad7ec4836e8a087835868803c0dbdbde8742ba5e8e26c745be1dec9f8f0a60150cfd0158f88274593e12e0d65c93e9a5a77f4922216eb4a4b181bd6cf28101f611a3ffcb3e49766e61ccb161c74f5cfd983952200e4622bd63a0eb1635cfdcc88e969a8921cce3bf505abc3648c35c3d9fb28c04a95e0c85f7f773755ec8ebc5f2911e4645cd32ea302f3c6a1734cf5f9cf67781a0efe3591056415c966118c2a074c9543d36b82a0ea6aa75c7df3e5a97825154a5d1aaf7fcdb416f2e0bb782e164d016ab8fe573882d7ca7f353c174b47f871da8a2ac1105b9f1949235ca006fd251c5cd58e6577b15b627c3a34f9a5dfddb72b3e3ccf31ee62155d315827c05ea87c17be5667104deeb091603b4217473c2ff06d2effffb5067e2ec7764292ee029d4de87e1a9942ed98c211e652a3c7ec81a2d219ff915aff31e37422f6eea943a5443ea00a6fb5d08699fb30f145ff1565139dfa05f2cc733e097a8dc03495ee1fd743ff51e3cfc4cabe9560af8adc44b5fb6f4c4b0262d6f8b2e40b43ce39efbb7fb438fc8d9da94e66760a660d29b7d422c6e428f0c379463c7080b4504d1c57f42546bb2f85c0b4e257842a26570bbbdf18fcddd5d3be19316106d67a2c333e7738acb0f5bd0f64000736a807fbbdc51669d90c39631b4c90f93a02d1fee4e918b6ab8b54c59b8bf8eddb237a6670df5c6a2f9d995c11044ea468118ab0e140055bb</script>
</div>
<script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
  </entry>
  <entry>
    <title>RunLoop</title>
    <url>/2021/05/27/RunLoop/</url>
    <content><![CDATA[<p>[TOC]</p>
<h4 id="RunLoop-是什么"><a href="#RunLoop-是什么" class="headerlink" title="RunLoop 是什么"></a>RunLoop 是什么</h4><p><code>RunLoop</code> 通过内部维护的事件循环（Event Loop）来对事件/消息进行管理的一个对象<br>没有消息需要处理时，休眠以避免资源占用，由用户态切换到内核态<br>有消息需要处理时，立刻被唤醒，由内核态切换到用户态·</p>
<p><code>RunLoop</code> 是一个对象，循环中处理程序运行过程中出现的各种事件（如触摸事件、UI刷新事件、定时器事件、Selector事件）和消息，从而保持程序持续运行，没有事件处理的时候会进入睡眠，节省 CPU 资源，提高程序性能</p>
<p><code>RunLoop</code> 是一个接收处理异步消息事件的循环，一个循环中，等待事件发生，然后将事件送到能处理它的地方</p>
<ul>
<li><p>NSRunLoop<br><code>CFRunLoopRef</code> 的封装，提供了面向对象的 API，这些 API 不是线程安全的</p>
</li>
<li><p>CFRunLoopRef<br><code>CoreFoundation</code> 框架内的，提供了纯 C 函数的 API，这些 API 都是线程安全的</p>
</li>
</ul>
<h4 id="RunLoop-作用"><a href="#RunLoop-作用" class="headerlink" title="RunLoop 作用"></a>RunLoop 作用</h4><ul>
<li>保持程序持续运行 </li>
<li>处理 APP 中的各种事件（触摸、定时器、performSelector）</li>
<li>节省 CPU 资源，提高程序性能，该做事做事，该休息休息</li>
</ul>
<h4 id="RunLoop-源码"><a href="#RunLoop-源码" class="headerlink" title="RunLoop 源码"></a>RunLoop 源码</h4><p><code>CFRunLoop</code> 源码 <a href="http://opensource.apple.com/tarballs/CF/">下载地址</a></p>
<p>苹果提供了两个获取 <code>RunLoop</code> 的函数 <code>CFRunLoopGetMain()</code>   <code>CFRunLoopGetCurrent()</code></p>
<p>进入 <code>CFRunLoopGetMain()</code></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">CFRunLoopRef <span class="title">CFRunLoopGetMain</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    CHECK_FOR_FORK();</span><br><span class="line">    <span class="keyword">static</span> CFRunLoopRef __main = <span class="literal">NULL</span>; <span class="comment">// no retain needed</span></span><br><span class="line">    <span class="comment">//pthread_main_thread_np 主线程</span></span><br><span class="line">    <span class="keyword">if</span> (!__main) __main = _CFRunLoopGet0(pthread_main_thread_np()); <span class="comment">// no CAS needed</span></span><br><span class="line">    <span class="keyword">return</span> __main;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入 <code>_CFRunLoopGet0</code></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">//全局的 Dictionary ke 是 pthread_t，value 是 CFRunLoopRef</span></span><br><span class="line"><span class="keyword">static</span> CFMutableDictionaryRef __CFRunLoops = <span class="literal">NULL</span>;</span><br><span class="line"><span class="comment">//访问 loopsDic 时的锁</span></span><br><span class="line"><span class="keyword">static</span> CFLock_t loopsLock = CFLockInit;</span><br><span class="line"></span><br><span class="line"><span class="comment">// should only be called by Foundation</span></span><br><span class="line"><span class="comment">// t==0 is a synonym for &quot;main thread&quot; that always works</span></span><br><span class="line"><span class="comment">//获取一个 pthread 对应的 RunLoop</span></span><br><span class="line">CF_EXPORT CFRunLoopRef _CFRunLoopGet0(<span class="keyword">pthread_t</span> t) &#123;</span><br><span class="line">  	<span class="comment">//如果 t 不存在，默认为主线程</span></span><br><span class="line">    <span class="keyword">if</span> (pthread_equal(t, kNilPthreadT)) &#123;</span><br><span class="line">			  t = pthread_main_thread_np();</span><br><span class="line">    &#125;</span><br><span class="line">    __CFLock(&amp;loopsLock);</span><br><span class="line">    <span class="keyword">if</span> (!__CFRunLoops) &#123;</span><br><span class="line">        __CFUnlock(&amp;loopsLock);</span><br><span class="line">      </span><br><span class="line">			 CFMutableDictionaryRef dict = CFDictionaryCreateMutable(kCFAllocatorSystemDefault, <span class="number">0</span>, <span class="literal">NULL</span>, &amp;kCFTypeDictionaryValueCallBacks);</span><br><span class="line">      <span class="comment">//通过主线程 创建主运行循环</span></span><br><span class="line">			 CFRunLoopRef mainLoop = __CFRunLoopCreate(pthread_main_thread_np());</span><br><span class="line">			 CFDictionarySetValue(dict, pthreadPointer(pthread_main_thread_np()), mainLoop);</span><br><span class="line">      </span><br><span class="line">			 <span class="keyword">if</span> (!OSAtomicCompareAndSwapPtrBarrier(<span class="literal">NULL</span>, dict, (<span class="keyword">void</span> * <span class="keyword">volatile</span> *)&amp;__CFRunLoops)) &#123;</span><br><span class="line">	    		CFRelease(dict);</span><br><span class="line">			 &#125;</span><br><span class="line">			 CFRelease(mainLoop);</span><br><span class="line">       __CFLock(&amp;loopsLock);</span><br><span class="line">    &#125;</span><br><span class="line">    CFRunLoopRef loop = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(t));</span><br><span class="line">    __CFUnlock(&amp;loopsLock);</span><br><span class="line">    <span class="keyword">if</span> (!loop) &#123;</span><br><span class="line">				CFRunLoopRef newLoop = __CFRunLoopCreate(t);</span><br><span class="line">      	__CFLock(&amp;loopsLock);</span><br><span class="line">				loop = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(t));</span><br><span class="line">				<span class="keyword">if</span> (!loop) &#123;</span><br><span class="line">	   		 		CFDictionarySetValue(__CFRunLoops, pthreadPointer(t), newLoop);</span><br><span class="line">	    			loop = newLoop;</span><br><span class="line">				&#125;</span><br><span class="line">      </span><br><span class="line">       	<span class="comment">// don&#x27;t release run loops inside the loopsLock, because CFRunLoopDeallocate may end up taking it</span></span><br><span class="line">       	__CFUnlock(&amp;loopsLock);</span><br><span class="line">			 	CFRelease(newLoop);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pthread_equal(t, pthread_self())) &#123;</span><br><span class="line">        _CFSetTSD(__CFTSDKeyRunLoop, (<span class="keyword">void</span> *)loop, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> == _CFGetTSD(__CFTSDKeyRunLoopCntr)) &#123;</span><br><span class="line">            _CFSetTSD(__CFTSDKeyRunLoopCntr, (<span class="keyword">void</span> *)(PTHREAD_DESTRUCTOR_ITERATIONS<span class="number">-1</span>), (<span class="keyword">void</span> (*)(<span class="keyword">void</span> *))__CFFinalizeRunLoop);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> loop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>RunLoop 主要处理一下 6 类事件</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__ <span class="comment">//observer源</span></span><br><span class="line">__CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__ <span class="comment">//block应用</span></span><br><span class="line">__CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__ <span class="comment">//gcd主队列</span></span><br><span class="line">__CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__ <span class="comment">//调用timer</span></span><br><span class="line">__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__ <span class="comment">//响应source0</span></span><br><span class="line">__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE1_PERFORM_FUNCTION__ <span class="comment">//响应source1</span></span><br></pre></td></tr></table></figure>

<h4 id="RunLoop-与线程"><a href="#RunLoop-与线程" class="headerlink" title="RunLoop 与线程"></a>RunLoop 与线程</h4><p><code>RunLoop</code> 与线程是一一对应的，其关系保存在一个全局的 <code>Dictionary</code> 里</p>
<p><code>key</code> 是 <code>pthread_t</code> ，<code>value</code> 是 <code>CFRunLoopRef</code></p>
<p>线程刚创建时并没有 <code>RunLoop</code>，如果你不主动获取，那它一直都不会有</p>
<p><code>RunLoop</code> 的创建发生在第一次获取时，<code>RunLoop</code> 的销毁发生在线程结束时</p>
<p>子线程 RunLoop 默认不开启</p>
<h4 id="RunLoop-结构"><a href="#RunLoop-结构" class="headerlink" title="RunLoop 结构"></a>RunLoop 结构</h4><h5 id="CFRunLoopRef"><a href="#CFRunLoopRef" class="headerlink" title="CFRunLoopRef"></a>CFRunLoopRef</h5><p><code>RunLoop</code> 底层就是一个 <code>CFRunLoopRef</code> 结构体</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// CFRunLoop.h</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoop</span> * <span class="title">CFRunLoopRef</span>;</span></span><br><span class="line"><span class="comment">// CFRunLoop.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoop</span> &#123;</span></span><br><span class="line">    <span class="keyword">pthread_t</span> _pthread;  <span class="comment">// 与线程一一对应</span></span><br><span class="line">    CFMutableSetRef _commonModes;</span><br><span class="line">    CFMutableSetRef _commonModeItems;</span><br><span class="line">    CFRunLoopModeRef _currentMode;</span><br><span class="line">    CFMutableSetRef _modes;</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>_pthread：<code>RunLoop</code> 与线程是一一对应关系</li>
<li>_commonModes：存储 <code>NSString</code> 对象的集合（Mode名称）</li>
<li>_commonModeItems：存储被标记为通用模式的 <code>Source0/Source1/Timer/Observer</code></li>
<li>_currentMode：<code>RunLoop</code> 当前的运行模式</li>
<li>_modes：存储 <code>RunLoop</code> 所有的 <code>Mode</code> 模式 </li>
</ul>
<h5 id="CFRunLoopModeRef"><a href="#CFRunLoopModeRef" class="headerlink" title="CFRunLoopModeRef"></a>CFRunLoopModeRef</h5><img src="RunLoop_0.png" alt="RunLoop_0" style="zoom:50%;" />

<p>一个 <code>RunLoop</code> 包含若干个 <code>Mode</code>，每个 <code>Mode</code> 又包含若干个 <code>Source/Timer/Observer</code></p>
<p>启动时只能选择其中一个 <code>Mode</code>，作为 <code>currentMode</code></p>
<p>如果要切换 <code>Mode</code>，只能退出 <code>Loop</code> ，再重新指定一个 <code>Mode</code> 进入，这样做主要为了分隔开不同组的 <code>Source/Timer/Observer</code> ，让其互不影响</p>
<p>数据结构：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// CFRunLoop.h</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoopMode</span> *<span class="title">CFRunLoopModeRef</span>;</span></span><br><span class="line"><span class="comment">// CFRunLoop.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoopMode</span> &#123;</span></span><br><span class="line">    CFStringRef _name;             <span class="comment">// mode 类型，如：NSDefaultRunLoopMode</span></span><br><span class="line">    CFMutableSetRef _sources0;     <span class="comment">// CFRunLoopSourceRef</span></span><br><span class="line">    CFMutableSetRef _sources1;     <span class="comment">// CFRunLoopSourceRef</span></span><br><span class="line">    CFMutableArrayRef _observers;  <span class="comment">// CFRunLoopObserverRef</span></span><br><span class="line">    CFMutableArrayRef _timers;     <span class="comment">// CFRunLoopTimerRef</span></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>一个 <code>Mode</code> 可以将自己标记为 <code>Common</code> 属性 （通过将其 <code>ModeName</code> 添加到 <code>RunLoop</code> 的 <code>commonModes</code> 中），每当 <code>RunLoop</code> 的内容发生变化时，<code>RunLoop</code> 都会自动将 <code>_commonModeItems</code> 里的 <code>Source/Timer/Observer</code> 同步到具有 <code>Common</code> 标记的所有 <code>Mode</code> 里</p>
<p>举例：</p>
<p>当你创建一个 <code>Timer</code> 并加到 <code>Default Mode</code> 时，<code>Timer</code> 会得到回调，但滑动 <code>ScrollView</code>  时，<code>RunLoop</code> 会将 <code>Mode</code> 切换为 <code>TrackingRunLoopMode</code> ，这时 <code>Timer</code> 就不会被回调</p>
<p>一种办法是将这个 <code>Timer</code> 分别加入到这两个 <code>Mode</code> ，还有一种方式就是将 <code>Timer</code> 加入到顶层 <code>RunLoop</code> 的 <code>commonModeItems</code> 中，<code>commonModeItems</code> 被 <code>RunLoop</code> 自动更新到所有具有 <code>Common</code> 属性的 <code>Mode</code> </p>
<ul>
<li>RunLoop 常见模式<ul>
<li>NSDefaultRunLoopModel 默认 Mode，通常主线程在这个模式下运行</li>
<li>UITrackingRunLoopMode 追踪 Mode，保证 ScrollView 滑动顺畅，不受其它 Mode 影响</li>
<li>UIInitializationRunLoopMode 程序启动后过度 Mode，启动完成后就不使用</li>
<li>NSRunLoopCommonModes 不是实际存在的一种模式，只是一个标记，同步 <code>Source/Timer/Observer</code>到多个 Mode 中的技术方案</li>
</ul>
</li>
</ul>
<h5 id="CFRunLoopSourceRef"><a href="#CFRunLoopSourceRef" class="headerlink" title="CFRunLoopSourceRef"></a>CFRunLoopSourceRef</h5><p>事件产生的地方，有两个版本 <code>Source0</code> 和 <code>Source1</code></p>
<p><code>__CFRunLoopSource</code> 中的共用体 <code>union</code> 中的 <code>version0</code> 和 <code>version1</code> 就分别对应 <code>Source0</code> 和 <code>Source1</code></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// CFRunLoop.h</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoopSource</span> * <span class="title">CFRunLoopSourceRef</span>;</span></span><br><span class="line"><span class="comment">// CFRunLoop.m</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">CFRunLoopSource</span> &#123;</span></span><br><span class="line">    CFRuntimeBase _base;</span><br><span class="line">    <span class="keyword">uint32_t</span> _bits;</span><br><span class="line">    <span class="keyword">pthread_mutex_t</span> _lock;</span><br><span class="line">    CFIndex _order;                         <span class="comment">/* immutable */</span></span><br><span class="line">    CFMutableBagRef _runLoops;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">	    CFRunLoopSourceContext  version0;	<span class="comment">/* immutable, except invalidation */</span></span><br><span class="line">      CFRunLoopSourceContext1 version1;	<span class="comment">/* immutable, except invalidation */</span></span><br><span class="line">    &#125; _context;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Source0</code></li>
</ul>
<p>只包含了一个回调（函数指针），不能主动触发事件，使用时需要先调用 <code>CFRunLoopSourceSignal(source)</code> 将 <code>Source</code> 标记为待处理，然后手动调用 <code>CFRunLoopWakeUp(runloop) </code> 唤醒 <code>RunLoop</code> ，让其处理事件<br>表示非系统事件，即用户自定义的事件</p>
<ul>
<li><code>Source1</code></li>
</ul>
<p>包含了一个 <code>mach_port</code> 和一个回调（函数指针），被用于通过内核和其它线程相互发送消息，这种 <code>Source</code> 能主动唤醒 <code>RunLoop</code> 线程<br>表示系统事件，主要负责底层通讯，具备唤醒能力</p>
<h5 id="CFRunLoopTimerRef"><a href="#CFRunLoopTimerRef" class="headerlink" title="CFRunLoopTimerRef"></a>CFRunLoopTimerRef</h5><p><code>CFRunLoopTimerRef</code> 和 <code>NSTimer</code> 是对象桥接（toll-free-bridge）的，可以相互转换</p>
<p><code>performSelector:withObject:afterDelay:</code> 方法会创建 <code>timer</code> 并添加到 <code>RunLoop</code> 中</p>
<h5 id="CFRunLoopObserverRef"><a href="#CFRunLoopObserverRef" class="headerlink" title="CFRunLoopObserverRef"></a>CFRunLoopObserverRef</h5><p>观察者，用来监听 <code>RunLoop</code> 的 6 种活动状态</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Run Loop Observer Activities */</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">CF_OPTIONS</span><span class="params">(CFOptionFlags, CFRunLoopActivity)</span> </span>&#123;</span><br><span class="line">    kCFRunLoopEntry = (<span class="number">1U</span>L &lt;&lt; <span class="number">0</span>),          <span class="comment">// 即将进入 RunLoop</span></span><br><span class="line">    kCFRunLoopBeforeTimers = (<span class="number">1U</span>L &lt;&lt; <span class="number">1</span>),   <span class="comment">// 即将处理 Timers</span></span><br><span class="line">    kCFRunLoopBeforeSources = (<span class="number">1U</span>L &lt;&lt; <span class="number">2</span>),  <span class="comment">// 即将处理 Sources</span></span><br><span class="line">    kCFRunLoopBeforeWaiting = (<span class="number">1U</span>L &lt;&lt; <span class="number">5</span>),  <span class="comment">// 即将进入休眠</span></span><br><span class="line">    kCFRunLoopAfterWaiting = (<span class="number">1U</span>L &lt;&lt; <span class="number">6</span>),   <span class="comment">// 刚从休眠中唤醒</span></span><br><span class="line">    kCFRunLoopExit = (<span class="number">1U</span>L &lt;&lt; <span class="number">7</span>),           <span class="comment">// 即将退出 RunLoop</span></span><br><span class="line">    kCFRunLoopAllActivities = <span class="number">0x0FFFFFFF</span>U  <span class="comment">// 表示以上所有状态</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="RunLoop-启动"><a href="#RunLoop-启动" class="headerlink" title="RunLoop 启动"></a>RunLoop 启动</h4><p><code>iOS</code> 程序能保持持续运行的原因是在 <code>main()</code> 函数中调用了 <code>UIApplicationMain</code> 函数，这个函数内部会启动主线程的 <code>RunLoop</code></p>
<img src="bt.png" alt="bt" style="zoom:80%;" />

<p>看到，在 <code>UIApplicationMain</code> 函数中调用了 Core Foundation 框架下的 <code>CFRunLoopRunSpecific</code> 函数</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">SInt32 <span class="title">CFRunLoopRunSpecific</span><span class="params">(CFRunLoopRef rl, CFStringRef modeName, CFTimeInterval seconds, Boolean returnAfterSourceHandled)</span> </span>&#123;     <span class="comment">/* DOES CALLOUT */</span></span><br><span class="line">    CHECK_FOR_FORK();</span><br><span class="line">    <span class="keyword">if</span> (__CFRunLoopIsDeallocating(rl)) <span class="keyword">return</span> kCFRunLoopRunFinished;</span><br><span class="line">    __CFRunLoopLock(rl);</span><br><span class="line">    <span class="comment">//根据 modeName 找到当前运行的 mode</span></span><br><span class="line">    CFRunLoopModeRef currentMode = __CFRunLoopFindMode(rl, modeName, <span class="literal">false</span>);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">volatile</span> _per_run_data *previousPerRun = __CFRunLoopPushPerRunData(rl);</span><br><span class="line">    CFRunLoopModeRef previousMode = rl-&gt;_currentMode;</span><br><span class="line">    rl-&gt;_currentMode = currentMode;</span><br><span class="line">    <span class="keyword">int32_t</span> result = kCFRunLoopRunFinished;</span><br><span class="line">  <span class="comment">//通知 Observer 即将进入 RunLoop</span></span><br><span class="line">	<span class="keyword">if</span> (currentMode-&gt;_observerMask &amp; kCFRunLoopEntry ) </span><br><span class="line">    __CFRunLoopDoObservers(rl, currentMode, kCFRunLoopEntry);</span><br><span class="line">  <span class="comment">//__CFRunLoopRun RunLoop 具体要做的事</span></span><br><span class="line">	result = __CFRunLoopRun(rl, currentMode, seconds, returnAfterSourceHandled, previousMode);</span><br><span class="line">	<span class="comment">//通知 Observer 即将退出 RunLoop</span></span><br><span class="line">  <span class="keyword">if</span> (currentMode-&gt;_observerMask &amp; kCFRunLoopExit ) </span><br><span class="line">    __CFRunLoopDoObservers(rl, currentMode, kCFRunLoopExit);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="CFRunLoopRun"><a href="#CFRunLoopRun" class="headerlink" title="__CFRunLoopRun"></a>__CFRunLoopRun</h5><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int32_t</span> __CFRunLoopRun(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFTimeInterval seconds, Boolean stopAfterHandle, CFRunLoopModeRef previousMode) &#123;</span><br><span class="line">    <span class="keyword">int32_t</span> retVal = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// 通知Observers：即将处理Timers</span></span><br><span class="line">        __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeTimers);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 通知Observers：即将处理Sources</span></span><br><span class="line">        __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeSources);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通知Observers：即将处理Blocks</span></span><br><span class="line">        __CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理Sources0</span></span><br><span class="line">        <span class="keyword">if</span> (__CFRunLoopDoSources0(rl, rlm, stopAfterHandle)) &#123;</span><br><span class="line">            <span class="comment">// 处理Blocks</span></span><br><span class="line">            __CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line">        &#125;</span><br><span class="line">        Boolean poll = sourceHandledThisLoop || (<span class="number">0U</span>LL == timeout_context-&gt;termTSR);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断有无Sources1</span></span><br><span class="line">        <span class="keyword">if</span> (__CFRunLoopServiceMachPort(dispatchPort, &amp;msg, <span class="keyword">sizeof</span>(msg_buffer), &amp;livePort, <span class="number">0</span>, &amp;voucherState, <span class="literal">NULL</span>)) &#123;</span><br><span class="line">            <span class="comment">// 如果有Sources1 就跳转到handle_msg</span></span><br><span class="line">            <span class="keyword">goto</span> handle_msg;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通知Observers：即将休眠</span></span><br><span class="line">        __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeWaiting);</span><br><span class="line">        __CFRunLoopSetSleeping(rl);</span><br><span class="line">           </span><br><span class="line">        <span class="comment">// 等待别的消息来唤醒当前线程</span></span><br><span class="line">        __CFRunLoopServiceMachPort(waitSet, &amp;msg, <span class="keyword">sizeof</span>(msg_buffer), &amp;livePort, poll ? <span class="number">0</span> : TIMEOUT_INFINITY, &amp;voucherState, &amp;voucherCopy);</span><br><span class="line">        </span><br><span class="line">        __CFRunLoopUnsetSleeping(rl);</span><br><span class="line">        <span class="comment">// 通知Observers：结束睡眠</span></span><br><span class="line">        __CFRunLoopDoObservers(rl, rlm, kCFRunLoopAfterWaiting);</span><br><span class="line"></span><br><span class="line">        handle_msg:</span><br><span class="line">        <span class="keyword">if</span> (被Timer唤醒) &#123;</span><br><span class="line">            <span class="comment">// 处理Timers</span></span><br><span class="line">            __CFRunLoopDoTimers(rl, rlm, mach_absolute_time()</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (被GCD唤醒) &#123;</span><br><span class="line">            <span class="comment">// 处理GCD</span></span><br><span class="line">            __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__(msg);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// 被Sources1唤醒</span></span><br><span class="line">            <span class="comment">// 处理Sources1</span></span><br><span class="line">            __CFRunLoopDoSource1(rl, rlm, rls) || sourceHandledThisLoop;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 处理Blocks</span></span><br><span class="line">        __CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line">        <span class="keyword">if</span> (sourceHandledThisLoop &amp;&amp; stopAfterHandle) &#123;</span><br><span class="line">            <span class="comment">//事件已处理完</span></span><br><span class="line">            retVal = kCFRunLoopRunHandledSource;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (timeout_context-&gt;termTSR &lt; mach_absolute_time()) &#123;</span><br><span class="line">            <span class="comment">//超时</span></span><br><span class="line">            retVal = kCFRunLoopRunTimedOut;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__CFRunLoopIsStopped(rl)) &#123;</span><br><span class="line">            __CFRunLoopUnsetStopped(rl);</span><br><span class="line">            <span class="comment">//外部调用者强制停止</span></span><br><span class="line">            retVal = kCFRunLoopRunStopped;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rlm-&gt;_stopped) &#123;</span><br><span class="line">            rlm-&gt;_stopped = <span class="literal">false</span>;</span><br><span class="line">            retVal = kCFRunLoopRunStopped;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (__CFRunLoopModeIsEmpty(rl, rlm, previousMode)) &#123;</span><br><span class="line">            <span class="comment">//mode为空，RunLoop结束</span></span><br><span class="line">            retVal = kCFRunLoopRunFinished;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="number">0</span> == retVal);</span><br><span class="line">    <span class="keyword">return</span> retVal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="RunLoop-事件循环机制"><a href="#RunLoop-事件循环机制" class="headerlink" title="RunLoop 事件循环机制"></a>RunLoop 事件循环机制</h5><p><code>RunLoop</code> 启动后首先会发送一个通知，通知观察者 RunLoop 即将启动</p>
<p>之后会通知将要处理 <code>Timer/Source0</code> 事件</p>
<p>处理 <code>Source0</code> 事件</p>
<p>如果有 <code>Source1</code> 需要处理，处理唤醒时收到的消息，之后跳回第2步</p>
<p>如果没有 <code>Source1</code> 要处理，此时线程将要休眠，同时发送通知给 Observer，发生从用户态到内核态的切换</p>
<p>线程进入休眠，等待唤醒</p>
<p>线程刚被唤醒，通知观察者</p>
<p>处理唤醒时收到的消息，之后回到第2步</p>
<p><img src="/2021/05/27/RunLoop/RunLoop%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF.png" alt="RunLoop事件循环"></p>
<h4 id="自动释放池-AutoReleasePool"><a href="#自动释放池-AutoReleasePool" class="headerlink" title="自动释放池 AutoReleasePool"></a>自动释放池 AutoReleasePool</h4><p>OC 的一种内存自动回收机制，将自动释放池 autoreleasepool 中变量的 release 时机延迟</p>
<p>将对象加入到自动释放池中，这个对象不会立即释放，而是等到 runloop 休眠或者超出 autoreleasepool 作用域之后才释放</p>
<h5 id="自动释放池原理"><a href="#自动释放池原理" class="headerlink" title="自动释放池原理"></a>自动释放池原理</h5><p>每个自动释放池都是由若干个 <code>AutoreleasePoolPage</code> 组成的双向链表结构</p>
<p>自动释放池本质是一个 <code>AutoreleasePoolPage 结构体对象</code> ，是一个栈结构存储的页</p>
<p>每一个 <code>AutoreleasePoolPage</code> 都是以双向链表形式连接</p>
<p>以栈为结点，通过双向链表的形式组合而成的数据结构</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">AutoreleasePage &#123;</span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> POOL_BOUNDARY nil <span class="comment">//边界对象（哨兵对象）</span></span></span><br><span class="line">	id *next;</span><br><span class="line">	AutoreleasePage *<span class="keyword">const</span> parent;</span><br><span class="line">	AutoreleasePage child;</span><br><span class="line">	<span class="keyword">pthread_t</span> <span class="keyword">const</span> thread;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="autoreleasePool-在何时释放"><a href="#autoreleasePool-在何时释放" class="headerlink" title="autoreleasePool 在何时释放"></a>autoreleasePool 在何时释放</h5><p>APP 启动后，苹果在主线程 RunLoop 里注册了两个 Observer</p>
<p>第一个 Observer 监听事件是 Entry（即将进入Loop）创建自动释放池</p>
<p>第二个 Observer 监听两个事件，BeforeWaiting（准备进入休眠）释放旧的池并创建新池；Exit（即将退出 Loop）释放自动释放池</p>
<h4 id="相关"><a href="#相关" class="headerlink" title="相关"></a>相关</h4><h5 id="休眠状态的-RunLoop，通过哪种方式唤醒？"><a href="#休眠状态的-RunLoop，通过哪种方式唤醒？" class="headerlink" title="休眠状态的 RunLoop，通过哪种方式唤醒？"></a>休眠状态的 RunLoop，通过哪种方式唤醒？</h5><p>Source1、Timer、外部手动唤醒</p>
<h5 id="PerformSelector"><a href="#PerformSelector" class="headerlink" title="PerformSelector"></a>PerformSelector</h5><p>NSObject 的 <code>performSelector:afterDelay:</code>  、<code>performSelectorSelector:onThread:</code></p>
<p>实际内部会创建一个 Timer 并添加到当前线程的 RunLoop 中，如果当前线程没有 RunLoop，则方法会失效</p>
<h5 id="GCD-在-RunLoop-中的使用"><a href="#GCD-在-RunLoop-中的使用" class="headerlink" title="GCD 在 RunLoop 中的使用"></a>GCD 在 RunLoop 中的使用</h5><p>GCD 由子线程回到主线程，只有这种情况下才会触发 RunLoop，会触发 RunLoop 的 source1</p>
<p><a href="https://blog.ibireme.com/2015/05/18/runloop/">深入理解 RunLoop</a></p>
<p><a href="https://blog.csdn.net/weixin_42350379/article/details/104543184">深入浅出 RunLoop</a></p>
]]></content>
  </entry>
  <entry>
    <title>逆向-记录</title>
    <url>/2021/11/15/%E9%80%86%E5%90%91-%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <div class="hbe-input-container">
  <input type="password" id="hbePass" placeholder="" />
    <label for="hbePass">输入密码</label>
    <div class="bottom-line"></div>
  </div>
  <script id="hbeData" type="hbeData" data-hmacdigest="5ca6c391badeb97be38a6428d1b89dfe4412679b7d431f6138fd208aacb4d274">e3130b10479b59f415c01696b2997142f4d09c8f70691cf341a4f7b7e34c3f387e73b9afcc8db9606e84428f5469c924913e9681dab404a1c9fd2c02aa573c50fef8366f60fbd8e978ccb5b076fc04ed4bf56ef0cca73bf44647eb8d4421a4c2ed5fe341b8507dbc67274c7bcb98bb528d3aff9bd456fe4b2703529f90978609b680159983752759b29cfd168560d7057646d7aa79b2200cc648e4b1aa69507ae661fd840ee9ddc29fba10dbdbb29be9652f6c6628af19cbc174e268fd82ffdb71156e1a002b2733b7d8d491f2b5ba729a66c16fc139f505cdc63ce8da037ac916af2fac3360e9e0c4762325f77c25fe129266e16979e4175eae956f96a888b4c1626ca5fcaa8859e1dadbab7079ea54cad671b6603fe6aa0ac457773e34a0f58ccdd6ae63ff355cdfc2ba9e508dfeaf0407bbab7b02a6b461387c78df65998f6a7ad97378098b497ff085cab8baed331733af46a69c3fa90d090c14e3d498723abe7671e3f770f631926942984bc371aebe0825fc75f309b43cc32355550cfcaa8cba72d940a40a71c4e677183c229fb4d89f763c30c0676ac87ab6aa8e286baaee4fcbad183bd35fe807d20f5fbe49101fbba9ef81b291510a9ab757dc0e67039b2dcc94940d9169881b26471b1344f6bfa1c100e08a5f40cd1cda3d0fe487af91b16060be6352ecd76e6c0a46cb81fc380e60e2c50e02aa3e6e803b3d019bd945eed4ff40d46d73ac739cb004b2094cb9d719514efd50aa039480a73c9d6a18ad57a66f0a3fb7cca9d6776fc74c454b9c4f36f693ec581b23921b5bfc8caebca733e57deed5b03b02ca9952335bceb5f6ddabe98c43b43ddbd092edae080c740b9f7a1fdd72f47b357d0d24a4c99b2294505ab17adda03b92d14f2c5becd769b9f479af99179a990e6d73ca5b1baf26b629938159a137ec713e0a01bb68655a358eac350446da3e9a15f510bc2999fb0724443aac0a3a05bb882071c1104ebaad8ab87baf6256eb965fdbae4c33bdf40a9ee12c4e900614074a9b6a40efc1e960a6db1e1b5e7a004b0dcc6bcdce0176487b1c713a28ddc0102441a03b4d145446580c540b1357a184e304876db93f378c873c5deeb23450ff404cfdc271ccfe7e7eca9f77ae67f50216754f71ce48040234ba9a1fcf5029697c1d0062b8711a150f1df066c87336be54341b06e2cbfa168ffe029252411dadec6cbd34a790f6030e5e4bdeaf0a134e532cfab592a71b1818aea931020266fe41d87cf793ed3f294df8260a924cf9fcd9ecb955d4c70b3711928d1c60cccbaec8648992aa2cfa1c2625d3d724b151a1658e4fd19f591a2b1c0825930d6096969939bf02de0ffe6be8f421dc690e25bd75012991b792c7b60f7e47f25a0ce12135133c28ac60eb76df13ee7c69f14d05d3c492194e31f835db6183b1c4f6db2018baf41fabc57ee15701960d7da4f926fe9d3d9e2c3c404b0d7687ba969675e88681ca059fbcdc92a2bf1fbd814c0f061a4813bfb1107eda76b26c687dd3230b8e70708bfe76d2c6e9ce7ab82c62b76d7ace927bfc1e6b7fa97beec205579e8ccef32e5c473aa330715b9d585f090fc36fc3ca0fc0f749ed23b26c9c158688ca2dbf95863931360610832705ab5d76f0e2885ef6b334deaef2417eaec2a1806e2adb152f0e3fc238d8fc6f2dbfd6a8b07e9d4789480e9c809a5d8e645e3f6fa4914262c5bf911e617fe3ee5e5b2e9654b4a6958d9fc3271965036db2f1e2a31b28658868fb6cd0da1a5d369f44be6b27638541db921eafd79c7fb2a3ef30a9ed5ae07077ae6a1ff724d701184f5687549d46ab5e16450b159c5187772ab2980ed6fafae9695d8579d23a4a4c14309a62792987f54cf6cf303d7d735c5591be35d13cdee749044c9566e8b66a32e19498f5c15438bf946750dec0e8bd62fff751af003f24aeeb5815091ad89494e43f96e25fd00fded78132a390d44601b95b5ca21eda895f871f291f4bd0826796b8a75af91ebe0aa963b9be48a276971cc936c66db070b0d56a2b74571376a6f74eca881fabdd2ca4fc459624c3e7351e6b2c1b5402c2d4123bfb646b92e1cee8a5fe57aa681aed2c849e693091af9ad81e691868d24ed2bd6f627840e5301d2a1b10b12d3ff9ad02c492cedfc71219acd751620334eeac9038d0c10b168a91f4f0df978d4e8d0439d646acc60aea9abb5d3bdd266d21783b7d6ab0f26266afb40516218e8ae19adfbe7aa071850bb5ed69e0df7b6c85f3884b058300f653d8192d4327c2fa9d0bfc5172a10e773dd10d6f01b29b91ff6b9b7ed1dc47fa11329c7b6f496c2b504688de0d5e1af9aa44c184879f8f9735fa6a0f218e2d26d416fe7f61ab11698a6c2f87c693615307cff960bea21f3970acccd856a749c4cab3b35c7e080398b3828758fa5d19cc3900a0a5620701d0cffbfdb2b6e2beaacf246af84b94ca47d319c9a0e2fcd0c5a921d95d89c170e7e7f04fc234ac41c6e6e5c8722e100c6241b56a0f840bf527f05aa7fe7e4071c3229927741ca0017a4100d50055b67b907b5f36ff279c15b5f9407c929383e00a6eec261204d04febd4f946d583c4495561ecd7919e92495234e9696e4283504c586a9e8b76da29e092a31c6020df474e714b5880b078e09f70920de4dda1f4ef2e60a8d3891a8beb37c39b649ace6c378dd5827b8c25d2cc2a5a29fd90de37c5fa5747d616fbfc5fef3cc8cd2c2d08253e53eff51be5d5ac6a89615c414b7676cf3f6e1badf6622e8e1393bb8d3cfc840bece28f2c49cd5c7241c7029ac724af21a89ea3c0e6e2c7bf7487c300571f220a15503b40d1c318989eb67728d372d1c6c6978962bdf2d0be111971c7be5668104091ed0a372c761bc7f7b0477bc5e15d2d1a8ff5acafc9787f186cfef6944375fcf47c76b91c5fc0a94beff066cd62d3220da6ca5eaba9413d7e39265a9455e8db7fdf69854598ed6772bdd02d137c3cd5defd1e57b5e48145ccac799c24d22f7e4a075e09b7082bf84c17dc7d096cec5b31f6f84228baa18ec6483fbf0b27c0d9fd616f696129bf982deff8afd8c49d1164632b6c4aa5407f9dfb46fb839baea0b0a9b6d3ac329595ccf94556ae8f55f7719b24e4f3890d13c6cb0570e2ed0704dcc913057d55e28a0c59ef78dae0987846133731a739199e7d619af5d2fde1f6a7cb281fa3d0aa15aa79ab2d3ddd2e87a4373a9de68b8a67c1e13423c5149565b102fd029a41f0a2d0205db1b21020854df2a0017a1c9b45aa90239210b1485d5cc0e3e85a965fdec7d8f43d1775f480bba452560664054dd3a63061d5c165adf3b161a79e86ea1b276b656df84baf3d6c569bb1dd05242ad9cf5a3145485b9e8b734b20c0c5066707cea890eeef20d1ed7a440344de5fd15e9e5e7d6264481707a6cd31280ccde478033f5c4872246c090c124701b41d9e79ea5472030727c5ec1f32d012e12ea06f6e647022608e1deffe8dc3f58390478ab68ce607bafa270d198ee3f0519ef7a5f494a741575259077e4f9148dfd44b32399127e300a665174e663cb9b1334da2ad63dd3e55f3f7adca9e2c7f3381af066c99e62cc64f2f157f08f0dd16cda959f01f4cb6188d2424d423232d8c560c13175d9061aa98762c7e4d0bd2a2df594c931a7fae9dd02fb3967a231547c64e713aec2b4ddfa1cd1b07675d66c755cc339fd079516993368f0bc5fc2df09e9ca4c3d30d9e5974956810e12ce0c1098bcb1c9f545602d84455d3dceea076893ff4bc4935dba0271b3cce138fc577dd97062de5b1c0a283f730bd036921c3e9c44b1532f0669d253ef47c32bf7699e29df0fc01ba07ab54ab47e7c57fc85cf411cc65a29e95d1e00c7dac348b8a65d219218dadceed05bc863f0b34ea1607b0232a0ccc7fd206ea30d5119f38d708b0eb42e87bfd8d8daff38817a7188edecc317362c2c4b0e4fd090c733b2b4ac14d8f8c9ba64eb01d85bc4c3bec9c598d3651ed49e6396062b8cbf99f3c16a95248e8c40339da944de7887e9f2471d67e5442e1f3270d0af86d12dbb91c8f28193242164f396edd1146358b2754c3bfc114192824f0eeb9c15b6b1d8abe9411cffab41778ba280059e303bda5fdcae311fd76a0418559646ae24dfa2f7144b5d05c9515867a7dc9378ba2fda650ed333e2a42eaa502c5e56307ad44889d862b87b0214b353d1cb5920420da1350976953d83e732801730b9d280ed4649644f40316c3822b769cc2aff3ea1e5327e27a0cd7c47c04a79a82e4e8453f7202c168e232a95c266ba1f13cb2c17f0c8d650c9f060c8a0da8b2d5bcbb7f1a86a86bd9e3e36e3e8a80a9d7df2d375c6024e64dca57f442bb914ec1f137951510ff7142ea5c16e95f6991ff0dc8425998869f6bad80e0debf31a0c81d36d71839245f1b2345435c7f6a8233feb36969a0b26ae88268009daafba6371bd498203bb7fd246794fc3f9844609b784c3e4de92022a2491a6861482a5fa0d7fd6a0fbd3a8f8ee2d9ac0543617b089b7f0c756f1f402ad355d42726c866d9c97adad844db3a40f737060e1f36117666d5e560d3f204d6dfc2c5b94c145b3dbc32a9d4dc002a491e2cf9f34c12b14cfec79a8f414ae2099c0926dec8bcf7a227a731b79c799d2dded73eccbd7938c8b090b7aa24939bcd3b1dafd22f7b940cda1b9c1c76b290c13dc7cc8496238597a13e5f12d1c5378611b79bcca4a6f3fa0d84b12fe2c22e81e17a5d17072aeadbd0abb247d4f133204d56dc7b0a7d30dc07f9234f20f58a501455f5225e2f62911e3e5b5e6e065efa13d59e8d29f5d4d8659bdc9bf64ae74bfb99b48ab2cdd0794682ced6924fcd874587a9c422b4a1010157e66c3cb209c3450c951e546e26f8f4826f680188c808cd1025952c77a19383f5ff6a738b83c20e33dbffc28d4b562d7cd7d7c0912fa85f0c284928e912ac0e0c92c2d9c18d11a6338b4fa4d7c050a2b217199624f5663d4b119eb07db5c2fe9418a09b8c6a95e846979fc84180d8ea9490bad1906d600651d0b3ca79b9c38dd2eaed7505f72311c6ddd75a51eaec90c3d742aea044d3c1a08cc1232fa6e68c40946af40720d198405240da17e9aee7c4c185f44df43534685d30e13f21456bfa09e024aad58014b94ac0fc5c93284f903b7abb4e741b944cf627c65be8ee147dbd8816d28461787e4dd80187e4f0b09bd6af80dbbce8a7d3f67d79218edde1d1d897f2c672c6f8a6925a5f8a4fc891ea1d309da179f7ea1519d3042977bb5d2d2a9ddc6c8a29281fcae2b97ab845d6dad1c1f437650ff4166dd82360ae46b3f5b730f79fe6ca972c95ccd98134a4ea88ad7bccc9eaba57425d53d1f5d8696a79b50482d586d4ad5265a81fc91f183df16f745e6d7f148a6e44bb34c711f172980ca75e0f3cce8caa7eb5601e0353cb54594bba3e8573186752d70852d7055371451144dd1252a52988ff69cde9623f1fbcdfda7215bbcdf1df774db22b751a629604382ad1eabf1826f0fa63d3468e03584ed975b67609ca3a4f94a112c9bf6b08464c9b1ee8fad784dc59bc135412035307ef14ecd0294aa51f0971a9132b247241f0734a2d436c15a5b63e329de7264c2279b53f89656871e4766b0b5678389943d442b4a0491357ff1fb75472b9b65197bdcfa1e7a8792c102b2615c3d9bd07889971a240b1c1e12bae469547d81b56441e7207a2a4128f6264e79d9daa56f08321312fa8626aae2440de972a74db44b3aa32d74de15796991e4db5a7f24057384c3c9518025d0e71c38b6be468449c9e42b5f85a770f7f3ecd2432ae9f3e0ce51b2e923f25b9667f765e05cee4fdb4d3b85657aae49c555fe8a52189f0e62491af9c9146e860c8731676bd6d4ed81a9ee17e795f3bc7e19623f15238fff7333e36b21db06f6a905f9f4e636c21bbdb08ca8f97a469cecfcdb1e4b8df2158809feb514d67f1fe6a14da697bb45625c53af47c1099b398be2d315424fb805adb2ca3a79b94b01074d91b70dd3be831cf018d74bc5719a131b9e69d04b4d31227ac8e0bcfcecac94fadbf49ba4f94cb3a53653662c08a7828b68858eda34838810bbf5b2325e6a81224828be6b7c726589505c339abd6ece9672f321b8131b364e2076eb0878da3ccdea1962d30c338cfa0535509bbb7a0fc47d59efaf4a2626c5baab880cc650e8e4e0a38736580860bd389909658e77204a2fe5db1f84b57d1e0ad3c640d011d1c260354a32de0d58272a83b33d58bcad0b71b302fd22e746b0ec09cd5f6e01edf2abb2d21801b759b20d5d631680093d038e3f1f06ef16b32c8c5d81a597cc1173e0b65c7e4a83d625622a94675a94f1f530a9ab825a11ee0a3e56a8a3e95e106d88a05130d6d86158699664f1507fdea8e139b881bdfadfbbd7f7f974dd9178c93f30e81eea611f2a086089c3983ecbce9755eed059d3e91b08d25b94b7d4f3c259d5eb3d157d820231263eef6ff9c53390fc4d52fb1206046c7c7caf46ce05a505eda90a2e99e68147a9e4f08ef92570a658d3a5226edf79944fae9417cecfa9474e21666f1697851767c569cc9dce3bb99f4c0e174e1eb63827bda2d8fe6f9c2dc5ec9ef00d500e24d94834801d95e7b6217ae78a05fad265791291ef0c16473c35ca04b4bda19a845313401b0ee7653d7de7e20a56f6f34bbe49106eb2508f783802e75df1031dbee101422729afa513b997df0b3f01801329a52b535e19dce51065ae887c84dd408e5ff94ae033486d08d19b1653ae80914666fda09ffeb13a8e945f8c971d52161cf456fc7bcbd47c42fedb758a62e1224c04e81e816fe3e03e779a42a43016f7b5b767d54cffd6fb6a075ceeb79342346d02b58a692d21b2bc9e8f432b155792dd9334c15c3b4aa98330d5bc87e7933c572db13fee9a94e7c253a649be8c2aa93a8202e878964249198b6711c1267f15bcd38b2544d8e1c524113da483362c456e0367b636b8e5a706ea9d906c0f0fdf980914a3961bd10515df772184806530e1d5cfaef86dcc74ff1ad7315c11581401de9fe98715de505850b1265dda28b8bdf2eec9a0deb856deaa627a69629190524335a3c7e9890f8e4e77592012b314e9f4a5effa1af30c244a148318af4a02ca6c8438db6d3986b19bede9582e9e9c911267fa27ca9142f0e8396a55e69a006708dbc72d47fc46431d6e2804b55a81c54abb960cc7feae55d72d333a8aa0e7f7e8760e7dd84681e3dc624454390f79d2c16c03e8b0a66e66350f3d53df393177d6287685da68c4b6217ff65e87b38755d7c5a16871c6720ecc9cf91b9df89caaa254a37eb9be19a1603129a26380b7eb296ba8cd6bb559dd84d7a425eb4ff624c11e3433e3795722631030ee4e0574f68705ddc86dd2b5da77aec4413468ffe80082a62ab4ff858cb7c06a1fd72708a32ab8a12b4baab72e6fe28f955158a6d470fa21aa36d61d0968f3af34ad1c9641e8802b48e0162efbed1a3fcf9d3af142a0b683a59a4ef81ee2baf676b89e3d20be4019b885d2344b194dd99ed1de6d264b79e1fec360be4fb33df8b836d02f82f6e70efe81330a6405c32c0c953762d3e70582896ab2b15ea78df9ab6391e4f2d415ec52595e2668b503f511bf2eabb0dc9eb29afa13fc31841f3d0cba067007431f167f3343e05ed1ecf379eeef173e074d0ae19f96afd1064cc626cf49e2a9d61ce7a935de45a931096208326bcd15bf4ef237118e8de6d0d829aa26ca47c8fae6245b53120bccc04b70693e365f0aae1e7dd02d2ca07517df0bd5bdfabeaf203dce0b3fb935d639c65cab110f56b0529475e7245646b9d8e806271c4a8b92b5375fdf07cc565fd7f3456105f18dc0d819dc0ec81efadd991f27aaa7f7386d6a8d349ec3bf55f23b0a58d6140db84f96710a95b2cff9b8c2e8e0b34afee2c15580558a9e1c6d88a037d16ce2bf26df954dcc700d8bc0476a24662c3d6ee7daeeb2d2e95fdba204558899784330d556f8ee1304adb778041593baccf0fdee17dd107ef8b6bb21fc78e221a548a2124995149926eb85465cef79e932e447d72c508b31d62a91261e74104208dda419f7c5efbea9d1ef0de3cc06ab3a385d38239cb6c18477d159debda0bbcb6d809606c89f45c609f18541421380319cb264948ca72073805998c3a3b6257d8e18c7f4777036e48a20f0c588cbcf1862c02d58211b2b7ec51c7ddf864df3a68c1d4b524b3d9edbf27aeec0218e6362d91b2b997e68bb64dca5aed7192e13d89b90aac1baa1f3f1d8014fba8c01a812cfeead5e3bd681143b1323fe91b36837a84059312b4fe1fb74f008701ae76dd58b66002be6511ebf118270478bb23c153d6e7effe087314cc0f428363e890ca480671865f32a7219ae95c1606bd21b4f66e861f55b8d25d57ece0fc6a37e0ea5b08457f50a09c391692d395b7a684a1c6b0729affb9c558c5ad19508b318df1c6b5027062f38356e09bb5652c2db18f80c945fcd2f7483fdd22ea3f5610e002704c9156a346b54db9cf027a66fc7e7d929b697b6561b6bb547efc31b88a8249149230b9b49dab34bba750c623635be057ceb254a1bd204cb2efea7231fc0848c3bf5ab79ec120c1a20b20881ac53304a9c815091d2c21f74abdb87d07b70062d56246241af059b710b33c81fae03de218ced4024233f72209f0f05d44748db6e4e7ab8f01d413142193e40a5a7b781586b5af7fded6ece8be5bc58663c9a2cd48eae1b72b77d6cc3443265eddb363c4df4a1f111c69b399c5e3b4caa22c0e2d1fc5f28a816e896b2db9b35b11530cdde45645c34481597a33305b84056b4d32e865c14124730ce280b2eeee67256cf7927668b3e51dd71defa3aa2dacbaeeab0c5d8cc003caf898e29b5994664f061114e4dec9e74fb68318e6abe6c353dcf7b479265b696a1936d774e8bb1e1f10a812e3217f6c5a4b736934ddffe0f7d75006f929a0f2373d0f555dcc12c543025e6c81b050045686e816296f993d52026c63e5a87b137d359ee499b3bb1f695289ba0e1489c6df7d59373efdced65a503aaecdb8fdea7d99cebec9e85a7d1c8212a4d36584dc6b62197b82dcb01b0c7344a571c0d4944c6e47e9fd1322bc2a260b6712242247ade4555a66f8e2083400abc0b93020e3a537dc10f73b4e0b1422196e97a4e2fcb1b2e8717deec91bdd8f762fb43667aa77e0610d874f0852cdc4e9a3858f6a9e37965e0ccfe2505caf7bcb198bdf8a3dfbf4b5de8003678ceacf221378d91672643a9cf4258dd98ee416de82fa31952f15df32c48626835f0e0212661b5a6a5c0574ca8ff5b237c1705377418396fd6bdb62baa31b14e1ddff87aed9b4ea68a4c3d352eb48079ee1f42d041bef0353ae436ad5433b38a6b9327ec5df125b1cfa13651d52fe7924c077c2bde74a9d75ae8cbbaf8d006b6ca9c05266024f8dcb1e8f54cfece3cd9307b16bc334414fe29ce3c1639b69003dd4d9698d226d16c0d1c3c90e8aeb9b2d15bdd2c55efd1270b644c102f32ffe036d608326c197239db4b6e38c70f2c428e9aa66d5dd423a472b45cc0750ec4c5841d4c99ab86bc9dc64ae794a16452b81af24288843b6b7d057244b9d9f4f45ff9a1b80b56620d26fb1b47bca16e61b597c29e91f71a0ad794f7b98e98aef2a9d134492d9b41911cb4f478f07d5d58543f122d137d527f01d84803ffd769298bdd1dd04a95a41b7a7ab6254e57a173b905aa9001b5ba38a1b02276abe87f74adbadc38b1239e103e6286181d6061513893d8a8a9cd0f9684659ddaf4836fbc3230900c87bb3913d057639a9e03b9db50a10c058e57bcf5ed2747c2c85cae26e8f24df86e03930adf4aecc741ef1d62ea91ec24b05fca0b05cc685e616d00ff5915304bd2101f54860600945c8c6e049e9932695657ee42b2a0362d75a95109c05c5504c353ddd18b298d6ea1c3ecfaa2ad896b885337534e9b57308085a9765fcf2e04737af6b1ca15d8e048df029afafc6bb51a55f843a8e2fc57380d69a5de997c05212ace62b5477b8e984aa62b2f1a6ce2de9f34e08e0bf026d38a6f2fb179071dc42eca384e0e4370782afe542d25e0c50f7bbd09dca371fe701b30f665fad928355cdb4e986855622fa34344feff7a55858b21afd9023ccbd18cccdb6e6cb4815f46e9f27accad9456bd3f687e149f23666bfb3b8507379fb190e7bd09488142379f5e714dd546e556e734bcbc2254e033d3f6132baa4f9b0ec3097ee3abb9fda802016ddf4fff22b9dd6aaa1fa069e425df0100a1bc6aa78da6ddc8c5551d82e9264f22bab8c9e2248ea7c282d0ebbd02692a4411f32617494ead257a3c34e3e21f8eeaa0cb925b1e15bf2ff8b7da82a84bee8b48b9e7ef2d09a2b60845b0e312cd0d086cdf7173436b5e4f20898cbb9cb820018b13cf53f5e42570086580477e0ada1e0a8ae6c35c5fdf2b86ade6fc36fce373b6f0ea1b767d89ff9e9bbfab26b8d79de91a8e40ffe89a2bd10c353bde70f496964711d4a5088b0c1956977d0650ff86d6c69db2fedc3552c158df34164c4226cca617aea1846f2d2352cb76d1627cf51c0644284576c11942ebf88ecb6df6fe24d5b74de2b22bdbd3596c5aa441ff46f67457b925c91f3f8c0c1ed9c3ef17e2269377e1d7c548b245e028594911f030261a5f039a2a20e44cf9387c272222eb862832c11d3721f6ab4d09b2c6e7c4529590543345e1ab64c2d08bb024fce7f15fb86b1daac7d0df34d133b0407492a56e2abc3da5da0ce06e1279d52fa10038b6c9e0e0ba6de048cefff6bad1cb82f1470f24fcf85c0448ea8de9067fc75a34fca7346a1761a1eb34b4b6587d2655788097decc0e00584a4b8b81a5834483e323d9484700f416a7f5a626022f9fd144f29d53bf539f44f018e37cb0b89a8dc9b17ee44c8720b3573590be1efa9e846bcc3b1d990a17303c0d9dff29f5e445883b8e81224b363eadc1efd0bd4523f8c4e780fb1584471e796b42e31d4504efc8ea6dbf38b8f80906afa655b052091b0d06f41a90d7d6256a35153ce069e87e890ab47f6987abcf16b972d9fc80ef00a81c83d46f7831baa0d2ba9efd1daafcf53cbd570c1225c05d62476c9a533440e002d329fd6231e4a5d7f07bca47613b091ca339428236f5b10b8cff4a71021b91f0da84e3c069d0370be8cad7b380f186b4949577fff33906932434ab47fbf83acc046ac4e1bfcb7f79093cac5dae7a9a2bbe6c2a7fd389259c3b6e1191f312cea5b42b5e0c326948ef711e3819f35f04bb3634fede239df8c22285c67dbf53db164de03b47030dc949baf3c93be5bb7426060744a80a3400e2f3e6d4440122857464c709d675b4016dd4acbc45f32706054ebccdd7ceb60f6a31aa93794c0d0532c505ecd47c5f84ac9ef9e6e5c92564d06dcc811ce18564d1a6efdcda38d3cdd6016010366b7107e160f2ff6c2483635ffa0ae9ef2e2d582bf8e33c6e53f49c9b8bc1a072c4499510d6bbc373d546e374ac10e49f3ac2f7b1640adf464d21eee7e6923e945c6b72f5a533ea29b78bed23fd7fbf07e0f3bec7ba1b8b1cae8c89f4a1bde4c782df1e6e0fbeb417093ad365ae4d2c4704cd1eab843e429d3b1ef2d781266b20182dc38e5d27b879a10db788c7233a29bf409017ee8ebcb149e41c0f6568cc741e7f99d0930bde43a9aaf6560fba29be830f40148af22af52fdeedbd30b2dd0bba93255649cf17ad25f19543fa58b973f23db1518941dc2e69c729364c444832085f34b08b2adcdb19b3c1fd4c43a2fd74e1e38fe234c494ecdd8a35d28df59fdd0a3efb4d9e337df13690eed21bbea9502d07c02eec8919979ba589819718f8344d65364e1bab88148f17fc00bcbc9938f0711d38e4742a01f8570edee2037b0cbb7b920ebbc0bc6fbf1e50fb0bc5cbd01b23e6b060f54c0d81e5805761f7adbf39bc16b358c5f6bab7a57e45db341cb5011d88fdc337a38d556718666576f2f35ebf9bf99cb32164f56b3b61f179798f30204127b7d44dd9322db3edbb41b2f91817f4a3254305f6a66a77f3539f808c62ce91cfa0d26821e3ca180898fd00867415a85aa9e04bafacfc089bfb98888400ff13ca87241007dc9e75dc2d2453659826a54a9c69b7d32648ae3a1eb514ca3c61f48ce2508153c1fd6298c83b277be399de9f25c57e710a094c34746b7929c829ba6e37ddf5f126bd0bccb2384eb481b756ddb736a9302978ba7357fbc9b7da910795587c89713aa7e0ac8cea2662d4877540e1ace65ea2d22873aea00e712c720b19c4b070f40e90d097208bb959625603b43ee2ab7e4e5d0e4532e1c7aabfcb2eccf4e18102720147ea90f682046a6a4fe268e5a4d5199fdee3f0833f9e5aa47df518325b3c9b57886bdb172693b59d089a5f5268aa1ea0c98752f6a3d1714683fdaa9aa7f62bb4673c417d8aad3a5660c32fa45b6ab0ac3398f2812af10ddbe2a2ea8660f00c244a45fca0fd0e0d775589e16068d8cc91379d025e866879564d42663abd87c7a1142f675ec26c9b21434bdbe2d39fecd5ff98f4de40c81ab768100a42b3b74d58348a50757aaa603f79112523bc829af977ac0630db5b70bd754a93baaee764b8d8c1642a20b599c0bcc019dac97feed293b0cf60e8f145056170c46f60b30d270d904bf72a2fc120aca23a23fbcc666e5724f901338d29bcd790aa857c83dbdf3a3ad13485fcfe6c4b9b859e1e24390c7f3b41b0f70fdbbcb162aa8224fc240e0cd77968b8e4ad1240db765acd0de5bb2fb2b106bfeb9ef6dfaed5127166a974d62fbe6a7477c971ed8a2585493f23812c72dc1e52e5227263625c6ae5b33c2f1e10a351c5d43d29ff45cf02d43298f0b7d61411fc6cc1f5ebe36a88e405354af42a1ec09570f1c4b81093ff77d383dae0e9c25a6198b265a86e999ad1eb76cd7d0de43918f89b1c6b484658e1470e9e662b07c5d81eba60515453904193aa8d643e524bf4981358cd4c3ccfb6dbb523b4adff8385e5b6a52a7686578ec7ed63b53ab972f33ee3011c48e863fe1b034b8a12b0296bc95f1578647fe0e5fecf4e85af47a348c8a55c77a97c4326f7504c43ed33329670b742c5a55883ce678af9e88ede1bcf1d26793c76ef2665a2e5ae037d029d029d108ebca77b58fc5eef528a711dccb4d5ff505b6d400a179b7b41b710c634b0f8843f9abbd0eaf9b3944b7f7fd29a28371dc08996a8a9bed9a58d505267be00f8d8c703a1e1891f67af70ec234d253b1ad073560bab9b2d21685db993e05b092054a3b18d8274e19bd614116306f8b3ed7fc919c87a4cef2697897f0a894219849714b970afbe34221056488f6ffda838a929de68d50c8c7996db8833a3b299d344edc890d7ac2c5f2f9e615fa666cd6c8697d50a41f8e888b86b7d7bd606e9ef1f203dd1b2dc860fd9e8d2c56c76ecb56a67d439adaa682e53586868175daa58c886a29cd055090ed13bf5b6abd184be63440ed97f1e76828acb9a10bb341a3dcbf75502acb07972e125c56910d70049813907d99ba3958a566235f6dbc9605d5bdab90cbfda0f37b044d53c17a68c026de77ab4a955f63a75fefceae328fc7d67fbf650b3d2645a977df279185bb686dec6aef4d940b45e21ff3df880183bceca09854bbf5bb52c04318d4e9b6c3b62e56b0d8b5e9f6cbf35f5d2e5dfcffe0701f8f8d5e5b203bf057e94b4f481213057f720118c9a21c2263af79dd2ffe785880cba38b38ce3583e0c908143e205e4da07e91ad1e5ab49e8fc9e7818e0672ed7dff3b2e66942ca43d41197471b80ec7a27897d3f575a2a3e0754d70a6e0aa879aa1477ac5c4e4f41437b2fed80ee9596ad7ac9a555b9b4bb4678facddd0e057052c00a7ae226b756e7dd49965f692905dbc2ce587fbe9a400d0a3da4c1efb9ad5e2d060cf9c01365864cc2399bfc0d73198535bab03ec6af7f0f5375a3bcea7a8077f2a84ebc0171c35456041c8f41e4adc953c191eb4db3a9ce20e3e3825c2117ae4be9c01ba78d6cc7d3dc2ada8a2540dde7bbb306c9975b1b39748f0a6f0ad673551b01329a75582c4a12e61fca46210b4861a0956cb490263d890a8cb644ec9c800a66ad8133416628b24fb94d7b90ecdb467837d8d5565d64bb796fd8c02ca3a85aeab6888e616655ab6356a9b1223bc99d5934817c68f8ddddc9b033a3731cc71a07d9295ed92a8ee76de16a87667162d8914f0e6581a41da14114875bf6ab4f51545df97366ea52f4309775332b9388457dd2aef1a1ba5c1220a08fc6a36dd149d7f18a2ad2447b1ae3a0b5b021493ee78305dcf5dc68a1f3cdbe1793aac7e978c2cfe8c8ea9b8aec47ee06c2a267f771489463ae29b188b4c4fcc9a7bf43f97ceea557ad883a6a7a5fb1dfebabcec488eb90a13c2cccba1d5bc5c09904f0ae7dce157793cf9e7fde082077890183a79c1d3f1da4905f8a3ccd54b4eaf6ac758af309e97c388444be00200646d838a390797d7afd97b2434267258b4628b5c52fbcbd5ed81ddf634a4a59247f57ceafedabf6b300377c0fb2799ec4db7d24ed6e4fd2c4f2e41673970533a8a328a47e263cf879f885ddc595a8b6d8c14d537a6dd60949f059155959e025f54870dc13d8852631a2355618ca9ad6637b0cb58b6a57561c6cd97c7d6e9ba5d2b553c27f015d2d5379e95dc0cca09391ba98714fce0d8062b78b8c16a86636ee2f9467b64bb84d701de17ebe03cf20000f8ff2fb24a44041adcf725808c5d835b7502cef791a39d9b82a43fe0e9e1c5acfd22db84de07744b4aa1656cce865fad071483f298871d15d82ec5baed05a38ac1dab5d38ce6ebebe0a0947f29759cd8c2359b9578b22c52584d92dfe6e984bb881e9feed3cf00070b9b3e0e92a102ca5c8524a8d081b12e950253769d7273f302a0d2c6918116029600d8d3bb8a42f9b1999a13955e3855b23319946cadb6225068981df0d130476c3271fb36fa69d33b1b88e0489d21c9b02c3fa8d8617c02a65d6d1a03e4dff263252a11b6555b3ec538507c77d4d47ac8cee95b7497b1759c2526833a27724746d2a33f1ccfa5b1409c549869357c66b3ae972b290f748cd886f142b88f89b6146fb2c5f1c6add4a0cb7b87ff7e005aefd92b85f4142ac94fc4d82b7bf5e060d7ba6387010fad2feb403dba888c8e794f2a2e9230c59b4fd54bae99b573af26c562184191336e2af162696fe8529c1128ce61e735451da43333b9842f0b5806f6fbbff2b9f83ca3fa360889dbd59135dc83992bac8fc5739dd14aec1e69aeb0fdd6f4a749f3091308a1569c8ff7e24c97da478891f11a0190e3943db299cb24165a8278cdc8a80a5488fddaf1c81fd3c7e3bd0e4be52bd7392f7469ea7661db6a2ec54604db89e65e351ce1ee18516740967a4bf3f52145f6da5f953745563d82558c1de924a951e44e7795e077722fab46486e37956a795308a4a0c89372142bde62649644fe0b8b14902e90f1a9a44b4386b830531035ae117e79027757c77018f9609a3b4532922c44c4fb826c1d4f4134e6dbdabf7f6f6f72769bd61672bd2b13ce1afd6c8b5514cd445ccd5de82b734571f6de7da8ed6e249b089ca2968a176a391a077761cce3a28292ce6160824f0b6f5ac87ccba07367cc3a63d41b1c194255582a6534d067fd6184161b9d45684deed4404ed48e61ffa9a05b66f6da5ca8a22bc7b565800a73944cacbae2ee0c0b931cf1fbb1e9028892630ab20b6d163472d12e5ed56b0c52e6e39ec1510a3a8570990ba986e723ce33b83cbf6c4456a5d31e96f680c0b2c6d5de37f0e42d0e8ea9db22769277449e2fb70a0fb1d033b36be1a4e855673fc1df83504d71524577c97b896036bc16c371366c5bafcb152a89022d86b626e2f9c9574c040b03c2a2f8265cba78cf729aa712db734b8bea2d88cc364bfe550ec12e7237161cc009079c959462f4ba5cb5c31a6fa77bd92790e4a4fb74e5b9b77448b900721ee2f5d6753f72ba493c85d5dc027f75546779c74ffb1f7406246e59fd25c877868340ebfaac9283088b371d45b87b753673e34cb988638b0848c120bc43026a26c0c5ff55df3e1980ddce115b903adf5095819b3d332fea557c432da7c9ca2df7655099f2955360ab045aa5d18af7663a978ddad777875d4bc51a241eb242b9cac07b571c43d813449805a84ac8801f2a2cfad4d024a14ce54f640ab629c246ec17c11391d5dfec8cc48e236bdf847a722dab59832e3fa2510285634df4eb1d83a0fb6aa9970164493a9f0b12b20fb134a28e47909358ddeeb5d1d8bf347923fba0bee0995a3953aa7b2f9000c7ba9c0deb4d777e0efa987b3dadeb49e13f5deee3f8d19e558426f35ba5b797cbb1d597408e89398ad9bb82b34c759bf341268dd71bfe55c9b7295554319ba85088bec01cc859d287eb00301c66afec5943825b3d87a271e71a10158c3d675c969f8d211ead759d210254e9ca4e854b5503a80d248861b92f00f569eeb33cf3eb52419f7464f2806bfe68e274488f43fef0bf24b9988712ed06203dccfe697a3384393b423d5db7aa0997471d6b1f07eef221a823f62a073ec9e1ce313675ff8307d524b438153c1aa48d36bb58c882f7962955c9ee81f0e3ec8bec9166dbae1b8249a68fd572e732079443aec7bacd54a2e0498db6c63339c5004bfef609fe43f258901fe9171f258f16a2e07dda06b56d2bb0329588cf8e50114622f1ee8395e04a3fb78e5429a28d0383b2846805a839955915ebf15b1c88978223d93f6c3e726ee7ac12a4534ee1ef0ed83b6d4dddf1c9b41c98922cca0d2b001a8d7cbe6b170c31d52fe1bfce20edbe54680726f237a88dee5385465a069c81ef66859ecf370f2830d28c3a1a5e53fbcec8b05607a7b7bcbee6f292728018de1429d1621a1b82fb4d719c3888ad0797df1e217e43df756ff68c2ba8eda735556d35290e4a74554fcc6feccd695d537ae27cca8ce84f8a84252dd5d727ff69843980b0e10e3351c94892978edbc55bda3236584807acf1d3488c5a615689010cf32fbc4d4aa00965af314c429570fc5a7e03511245b2bd2b50cc8cdcdf74ed7e2bbdd2a00d6b2985ee76f40a3c7726fd7faac5e9e342c0281335baef3182d76aa36567e4d2a4efea6a808f885aabbb4509d1da501089712bbaeee4ccf9d42c67665d57e2ab16107f8b6c982e2365aea56ac5c98e9cd7244baa372c5f967417ec7fb3ae698177a48b0da84b367e9973c6aef2b106c7c55bbd9ce237f11c85d5b40de8729bc497fa4d55305320b88e4c7df407468ced5b65876ba883b18e9d4f52de2123f52f1df17fe00f2c5469ccd28867e7c94ab00dd6fa1b0618fc67a371de1200f3c0b88f5c5c1e730ee95dbd206f7f6c62165647b8f16c6de1b6c50c039a7c7a2a4045436c75597d5db5a8a177878b36de66d262f9895aa4dcd7c08dab728f112b366ec45271013aeb47b5c983dc6e8ae1cc72fccc00363f6355351610fcfaf95b645d50bc14dc40bd78f406d9332db87b3706454e8c0a2801bbbea8af226d7677eb48c31ba904cee5336c731fda078007e778dc7f973241862f980e34944f0e7c75bc5c9518fc51ebe1d1b4c10720e73a28b94ffbcc8af94ce048b459c4c552cd08d49c6a869d2c9dbba5be6c71e951226b11d4f515a335f940fe9ae475f26f465807b0beded2acc5135379f537f1256de1604592a64f2af001436f767cd71c51570ab92649861959d2703e464ff1be224e0dc13ebd0d8065a225fe3cdd85dbb9728d16bb36ef02e35367aabe3d8adbccae88526f4638a6d0f6233c00c41339fb5b545ff68b9a2c2aab950c6c160e22dfbd43c435e0b133cde43b4ffafa550a14eb5eac539620a377460dc34242d2b083a60c1f88fb0c300fcd28c08046f1cc8a8e4c0a4b2289bfbbc3833271af85c4a8ac914db33cbf2fdb230caec8266a888af300aa162f74afbc6b7a97e4ac0e8492c7917d8ca1be75aa5c2bbc7d63bec3a477a20c3ce7899bd30dd15deeed3776d5263921a0623f945521c3f9a1c24cbfdd11f319ed1e2cf4bbdd18d1f00b6ef7b2aace4aa7f5c99f581fe83b18edfefa07d138e8cef74b8fec755c57bbd80e04a82e8ad4a9f8003d4a24feb074b77f97547afc11c3dba163c9a5734533cd366af6a37ca1973b8aa20671d3fafb435344e2996299ffb092c3418c991584db5f4b4d6dccb4f48f2b930c523c82b22f353ccab481aa275cda5e9174ce084b02a9b787aac4183fcb99e58a39458e225c53493d6c60a850e72363473515f3bdc7a6e6453ff990b2de1d46d8ccdf8fae8c7ed5e40753a5c0905e97184fe1fb2d12159033224f71d0a6cc4c903d3cd1c872e4ca04bf0a33d7dab5490d0909ecde4909f93075ef189428e15c34a6f54fe37053571e99a0ed0ddd616f9b2a756891045d84f366b253fb25dda0d34d4a12487a721a37bbdb17e696ba51d4b5a628373fb0fe84b69d9fc7005390b34836115a1f0ad5b914c0762a9c6d06932e91f3aba37159759e92626da56c67fd36555e7a68d6d3abc29e56f5f25285b3a222ea015b62493d24c215b37e7d1f67382af5e676b702ed4f3d4a617c203cfbfed52ae676bae08b4c5653d8c3e888c9c81cb207e0ba7dc8db06a4ee7802f5872c8f7c492000a0353674698f427d4d68cf208c257630b259cfc04721c5b5115599aa1e4f4a73f6dcb8b70cae704187b4b2f21ae347a151af4e2acf8d80edb6e0d0ab2c59b85b4a7efd97d7e5b34f41ab62819640d2e0647646576c2532529234bbdc8af25fd8e37bdd1380927cd1fb7a78857037668facf8334192be94202e1a1965f28e5fd51b36e7a67c025637d6ef171f6e6eff39d602a1348107824a8414c6b323c5814b1b67bfae5fa2702954b3ce598801a445f3f7017c7fd60d1740da621e258c698499d6aa90d7f38f5269eadc06efb6e03cb56aeae55267dfd5f2835541285c0840a436cbbdf7769979d9679028a0d91088d68d4a842b2328bc08d57813ed84acc6989912b6492f55a273f327dd2ac58cec3f5d50b221e807b69a7f247f9fbf0402ee3d89c4d2521b43480b6ce9c83bed59df40122688282fcc64490991938e0c2143b32da21bd603a3365a520324a7abbdb3bdc05a5d5ba62e043e6197897407050a17b8d15070baee601edeaeace49164a43b24842d8d148c27c3a2079d572710a98efc3a77e80e579b6b7d1f196d60926d2f95b9c8db0ba52e9ff1378a0a482a486a6c2c7cbf29ffe2a992ae9a5af49426158afc97b08410f07b354e4ce189f1c3e6a1bfa79d2cf4009eb8aa59d3c285ca25c4f648498a50400e908b93dd0c59496219070baf440180a7bec0202249e3f580b95de97d2d44d84435604b3dae9fcd4a3a5a79d7c82c159137ec5f8bfacc7f8b8e68c69d16af7fb2cb306c8aa0c7c26df02ae6cdb75103725240e3a8bc7c5b9c4e4215bc93388529ea1acd97a5d6f1d46e9ee855142433980d4a092d63490ca7de5f00e0cef774415cc0d126c975c188c5812395b27e5c8a2bff606360597eeeb6237d8df3db5c9709c61cc4b062cdd05f458ba0d015d7e52e08ee858cff6cc73eecf8e1f2ddae65b134d34e7f5765adbc78958708eb20a2e19d16a37ea11f81bc0420af0df001b6fc3be465d834d7a1f4b849bac07b81b3760cb1dc2954605000ae965f1c28bfccda2fc1ddedd1e984eb371e0fc754dbd6d1adb40444f2923e39ec089ff244cb28e95c41f6c3e0e05d15664baddbd26265a6a5f81731ce701fbf3bf490a5e104a9ce58a8489aa7b58c80af2885721ceeb31f9e105e344244bf15ada57f7674de3e9e85b31a7f0a5e1094bec176d8ef08b1ca3abf481d9b36ecadd350e463dc93f6536dddd4f1e86c82b2efbd02744402e97d9b2d7d4350fd38c3c55fb2a863a76b64f2e1a82acea4e654d8a5b68a0728520f9f8d280e8415d1f4ac7c05c080e848c927527b039d0ed5deb198ff354ba334e7a012fc97839b3da09dcfe0c7557fd8c55b780bcaebe67e010cda5f1454b41c7f682317c21428d945055aba0badc83361687dcac3fa083b97882cba6a7bf029474e5d3873652810c2237320470798e7851ff9e978b1acc95622d4d0a2599ceca16fa78e7ad7d4e0d521147c4881544a000f5bc4aa948572556e8b4e867f73813f85ed6ab76fe0087ddc3bf42503b7bd2ba86ea58cb2bb80f01fed64b6ba71498312a1314d34a290a01111a35c1831b4171a72bcb1e8b19403845a1183c851531d09fd4421b4c10923cf1a52394e082d4d4e745e9d227d518080b9b1d7a2a6d99c4706da258fdc049139eee35852273e8ac37e50de7140878e2db63c280d77be705d06f57a0275a919a6c7a308604e02994b164f27d0f26e71ff4529040357f94e9ed0ea5f7fc18181cb9d647a04f16ecb51db04fcfb917d2b224452dbc689c15554c775547c920f09f96754bd1e2fa7136ef88fb15f128a1ef52a696ab2435d58ddc52669436f6a341fea5b30d0ffbb5d146b9ed332ab5af8a465554f3fe462fdaf030b823ba47a7304b5da82bc4b62b3d2abfbc47fbd3b7f0e84db5ddfc2eb8590e48212c93167137415997ca9a266694dbfc5b1b5fbc934c32f183f44ba8640ab89d52704f94633e0db5157392a820496e7a8659ab8bff3d01eb44ad5cda9190b639d87d8429440559535d8ca74ec77b902c0c9ca1074d78ec2bb1ab121647d725873c2e2000dc6dcf46ffe1ffd6c1ff17fc12373c2b31a508307ce6d460c0b9a5d131c1604bbf25e8aeb4a725ef3e7b2d99b503fbfb1873e7d440e421cb929bfa3087ac5a7d333638f5b540509d79fb4b62a042f61e0ebd1a889f444abd33efaff0059293326d041ce0042983c13a9f9b8fa6766c80b446d42e06736d518da74697a35f02dbe4a427088f8b4f6a3ab7089fdeae9c121ec1d7ece2f71c890fc164cbadace60aea32fe6b2235cbd9af01e807f6b145c5bd57b2d42d55cd983d6089428fd3e845b05e7c9869b25fb7f7b25632c7ed44ab0c86465d24e4a60e95cfc4f2c456f666b1a884d413daa63209d22843d6b76b246488a92c90d39006b2af10d18118bdce797f7324939fd9672aaa9497302c2c3b0e8bedb4c217748caa1a458b667fec630d5d907f5a52b8ebde590a82d1c3608945f59bf692192541d4dfd61698aa1d7c4cb09deceedf427c4d1672d56d09c8a7628d87b3f2ebd523ea901f558dc5e1f5a3fd5f58d58746aa14fe87f4f81d5d50cb105f93cb9199fadb7d05949371d05ace2c016ee4e3c5fb26e291b724508f74a2ecc1152464a9b70d4b66d6e9c68d45725543da2c4c1323ef3a237ce5ed526a24735f6dacbfa41fb6d74b603d61cc119a5cc492ce7266d5061400e09b6d90e3f50a0f4430f029a5e6fd00c79a4aa58e9baf819e38761af6c4c4fbefa844fae694341674cf17b72cca20a01999232afea8cdaca574d4ea815ac03822479a785e92a6908bac01804bd7b333d32bcfcc2fa0c48d993b4d8554f10a59b305278ec6050631ad1c648b02b930ac8eb833e868e856a8031db187eda8b2163e056bac5cb356fc0f87fb49023329189cbb02c7e26edce46bae6f0a2ea7ec69555c7297ba1e4cb3e539e4ede3f0888606cc85c1351574cb430c1869301483074de4a3e199616da85ab1b542d92731e4601225f10f5f57dbe64eb49fc6d005e984dd3624aaa1512fdf37aee5541bdbc0e2b649092cbaeadfb00911a8ad01275dcdfedc6688c721b881cf2da87f28a69d57340055a9bb62878039b539d378edfd75c5f1ab9f4b6dc21e54d0ad492ce5b33d9f942ca6ae0971435488788d69d73c54c9ca5a0c7442b1b73b21f4bd207e3b6ad051db95942a314ea762f983438fe34507f6557c612d7f73d825ae51a129ac07ed14a17577ecf2af5b1fcbcef80935a7835169f95147259b476d204aa8c39bd03c3f55bcea5bf8de597bff9224c24e798e095cefae691838c78f793d356e3ed1898dcf835aca0129b20a3a2e3efcb84a174c383fc249a3300934c066fa65a00c2079c425c73c34db6dba3914ef1b7bb6d7eceaa11710b509a93f24b93d6e75d629f8d787c33fda89b469227e6680f58cb2cd6ed0fd4c06b42b4e09af53f21826c7817fa4505fc14a2c61cb3c33cea986cc6a15e92f17679bb161126a595cd3cf976c1d389f9422e92b77aff88d784fdf4f2d6d779ea6598c6c12236480e62ed0b346edd01000a0baa8905867b9ba617e314633c31e466568fe1bb4d1776b3f9fbe91358795af0d11484ea64676b30015d572e1ec38c8c1b32e3a796471d1b313750d47ebcb4485d4e35ee83e0f51a82bd5aca0b900dc8515b14e4207d90ada18efd3785ee0ac9f27299c37dea82d6775f3856a7fd674af01236e7d8f53eda759028d71dce0c21ad0fcca73bd44c8d9d267802b28cf87b76b9eb42515d11d24c4e7ff1c59769db37b733d5c28d0130497c522809321b78191897917626b41e862b937df092873f4067a34f16d7389ee6eaa3bec4be7cc8b4d8d8d547829b1fe1d877341fe47b7a8f5755e45bebaa71c2fbe87147fdc7db52dc36c4a3d13fc68b5c42401a8f600cf206f735370ae3169a99d1aeeed39c88974362adb27610350bebf764052602339af8aad88c2d6ab4c54e077cb80985b9b9039a2298e39fb174c8d309cd5235e84d53aba19b095b11270a646094a53bacdd9007a7886b0d3512bdf6c22642ab09219a067a8233e0c280e4331df3f81f46a9e54cd856d4688fd54ba2b45c6f6a1de82087d4399b0c37b1410223b4d9afabcbd82875fd1292eaf4578b16fe07b1bcac2be60bc7d4c22b28f5dbef34a4ab4be89fdc4cd92615edd4e673d3efcca7a059a9634d14d99fbb1f66c8e202a18166eb4c4c5c8b6c4d948875a8b374ed90e8160efdb4184f691e009c7760baab21f3cd2e57132f2a01869c4afc48e670da54e2385d1ce0713bc793abfdd82bf59986d07b804186ee1ab6baa4a9ecf48736b8b487773bba0430c7a2ec00c56a67a842685da673918f05a45773f525d7ccdbb5ff863fe0189790bf4f2a4060d39a1da9218f067351d8a691995864f1f15facd38c816b0b511a284661893879ded584aaf71c102e8daba4064f45257e8b20c9fc81992a08877c701dea2a00badbfeb810ee89ceac9c0a39dd178e50f0d6f9575cbaba35f72d8ae0332a29790c3b5660c17517e5a24246ea06afe03434d3c0d202af76865972b0e1658ee4130ea13e8046931bac251bc946cb6991169edfc3e2b10e716a6649072e728139e5dcbb7726fd8af857edbc622d92b9e73afeee0e4230cd7d34dedec69a687b52fbcd903ca854ef506ee56d96a0d288a956b5af2b79739a78b6f64bc10f0d7d0ff7d0bd7d7e917b9ddcf944e1aad9fc8afc75156420036d659aee578bb6bc8fde7c7113ee1aae0b69530c55d748edff045977df209a00096932f299fe8e1f28832514656121d24f2779a3af4f2811ec01f6d13944fc2e54e33f9d7043633548a7ad512b39efd8c2c4ba5cc9296cb4f9c67d76172648a293227319a1d7a0e3277dd2ac72f2f806cefe2580049b1bbe2a48b053d73f7d2a7d2ba3a1314cc7a983570a6d29a0aa94237412d3ca6d9c26342ffc2b0e83249d2df86fee68e3c5e277d794436b95c60158df1cab5291b09a7640fff191fe972e7acefd40245dfb72d5afbee9940e39b73ae27826e040b25f6c499f88a103c43a28c65726548ce885386a804a067c90f1927c8b174496dd5cd60621f915c24231c8dafff7222e0928cda7f9c6b47b56bcdd708184cf7a067fc2ec6a4e0b98c81f8f2111f1bef41dc2ba067d6a107dfa8d80f90740a2fe9cde5fbefaa6b189b674ce962f30ab4a7a3c5b99dbb2514e581b0fbcd52c0081e52ea25cfc578b60eb2edd07485924657c3bf8af91eba25ef3644db25bd41b6ca70241f75ee71e5154eb0ede6aa28a57b9e2ce58cd845ba96ec5af8354f565c59591dfc3063b58e6cb4eab8368bd78fb459bf75008880d7ea888040aedbe7581e77ed36e049115dda76f08b77f810e8fb62e592958614f2dcdd94fee3a05c0bd292a4f3dc014205ff230f1f9eee86c274931b44db43e5280a60fe61bf5aada79721d52b1c3cf2bc025f96562387987e6424b5b687ae5983ca62d4e713805101ed9ed0a5d480bee378bee4992007f7becf5527f2ae71d08aed599274bdaeccba39077f1a7eaf452748c66dc45d88650d92ce489acc52883882b9ccfb847185a00ef86a86cb6567911375f7e2753cdbc42133994d7d55abfe1bff01408a8a1de95202fa53238e6de55c9b6358499960dd3e8f877bfdd7c8040f64d158fa83b48b4ce454ec25ba45713cdeb140bb3bf71a767791d114fefe3359989acd8fa3b74cb3aed077824620130f02d7e3563cf48c2f2a6a1b43e8f5e86359cf4ad14269170da52c3f468312dc24b0ddafd4f91bba23995b6a94670d1e485054d40f65b6fbc6472474ec1e4798072ebd63fe1a1a555fbbc22a68d0c958ecfd267d01cdec30bddbb25428c71402cff36a9893d7df653eff71cdce07fe9a42c30e243e7e04fb544b6f0f005659f16d7e02bc39042cec64998011527999feda73baf3c3a8437ebcacf61ee08513a9aad5ca36c2b08fd13372763182f59d999375ea3ed032f77117fee8d59287bcb0995d148547fc1d8f985c94b6d0eb692a5f68663c391286a53a880b2b22605fd042daecad5fbf1fc547ce69f8af10f2c26e1c17efc34453bf18a0038dc38daad8ca1e7cedf023fe29c17467689cf43b9fd4945c79c70714dbef525bcfa01563d2a8fbcc112348076bb347662fd515bcc9bba3a1ea10adab67d23f386ddb4af1eacf66f9294ded41c4895556b3813fbbffe77b6424ebb98a8aae8988433b291733d55afbaad398df5acb3fbcd698eef174ef0699a3352c8ed7a5ae832083f18d6c9af202fe4dac421bbae017063390b3bf66ff28b69fa1c1325b5fccfa3914334f746870b69ff1fe4d7ed1eab3ee87cb36e364ad7b5a4e94710479b8c4f4fc5289eda9c3c8b6d6b0a90b58c04d15d3a16532fadace4c41eba1bf02fb002ff344ad215663346049b7f48ba8613e8f41f9955b99cf5adaf2395781ed928afd496c152e2d834b838dc27dbcac037d00b800531d13bba9b3242018b6b8bfb2c4b1f45b348e50b35ec2b5c5f486b50429cf4fb4e0931b03b8b1c17a67c9d615e5cd510ee8bc5bcf5e0151ed150f096fc6e99df6d6a0c00d09e6d5dd9e0e9bc732cfd0c9a9dab39cf45d502c1ab06b62a7742a74024d12e54b21ec7cd4e7b117f1f1825a388865b86cb2278c967f85884b476079c6a107943eecc0bc8f0abc4733f3a273d8b594e284a49d2f55df9b70cb2728b836da4627e79c747614777ad40b5999fc94baa1a9c41ff098651d526475d14fcaa40f07f2e752e26de3015a455c527c4cec0de49cef68971456794c2be48d9680683a314955baa47f830f19a01e5b6bdb5ce17297fd2a45dce449bd7c43cd228c4c4fce719ea413540461154a72b3b01f506ba864956d638d4c9c057da37cfad844fc8a32ee99b07a0dec952e0388a660f1d1e998e0db7587570dde13019c5ed254256dc4f8e934a5ab7f0c9300d6d133172b3da64ac2174e59807d180997cc6dd5a5cbbcd8d1b03004238887c050dba91c122b302c1cd6b9201e9742e476af6ea1c098b1bb4d3fd7b827108552ea0116de28e36d5084cba333649811219d39bfb932d36060c83356b6a08484ae5b8721d575f9a3dd937ab083c8bfb5ba98965ec553d90a52b915aeb13327f4028f05cc03347fc765402a8d8190d7929b3e9a8566b01a1dcb22a62f37b6b2e85165c4bf5c6f80a385b2876742821bcad1fa0413cb3d9cc364eabf4b94ed41122744050718326dc1e0ca5666feaa081f7e19be00df214f5ebb908b5157e260b0b2b13f17a531be0bc95c55f3c9186a2fc11967254c213e82308654d82806672435eda1ad147019a22c363ef9a9f3ac7b4e2b278291de6dc32dd548065d8de3aae3a3751c2035219af5cd9331a352ac3e8b00a5454485bcd421395041ed88486777434e2d0b4ecd1b163b06a959d9ae912720e6ad26d9ac3d365e7f269cd7add66e9345ea3978fea6a2a5d028bfeef1743fb6ca809065cd002e701eb6d2097046de4b23742410e5ba657d329e441f762bae64e0722b358bf9ff4dce973da14bb4047986acea598b1e3d4dfa714d01ac1b85ca7155bd424d73229209f31520e1ed231fc9837ca42676c63da952435aaf80cca2ca796a64a7ea0f92a1f03e72be81b065eee1285e202f9775dfd0f44cd61f4d2b3c27b7556af2a7c5434d67dc15449768360e81695d4f022f3a69ffa679f3c8b0b2babb740f743a0c0ac909ba05057e1f8e095d73df3c6e90b8b106250f296dd5caf1659468d795d13fc03954cb9aa6f299808d551837ba8df501f0b3166551d28806436ce38e385f65bf106b797053bb84da1a8e4f3f3c1c405d9b413abb87e8ed4a1d4930e19f905debad5df13c87cb1c292dc9fb1eed45e6ac5278e7e470301a5846f3ea4c28d5774ee3a7ea4f63f3424e2661b2e420b7a83194c99bd9076b42d203216e285e039903d15aeefdb860a5629ad69e177f94e2defbc9cc7705075f4be689827e8d04c545f2066c1c3f9e63225af08b4897eeac9173e46cbd29bf8538659b7b3be5a8bd5a17df5b15638efa1c9fe7b864c940cf7cdd2c8b5e9d6a0d76aae29343f6a9815b721581463deff562ad8f01ec8fcb2b5d4f5caf63b475e136d1d7b86a4b63fdc171eb9f6938fa3fcf45ee0bff43efa0bcf93f5517c55a9c65f4da44219920e27d738a991de6ca5a4fd62d9064d1de4edaef674f6e72a19d9b7d144ea5d8ede3f8eaa27fa0efefb87e3854e044444ae34febc4529d3faac26697da98ef42e58815eff7081620125e5b9399b2fa4276b095f91480c6f0d3453e32ddedebd2287cf7f59396b735b1dd7132400f208806c5c1cdbfe6890acb73b440b0457376f834992e517219d883c942932ea3964c58ebd6b99663813718d13c90637659dde6bfcb5a665e94932fc0d031028d190549cc274c13a94c63ffdea6c19a9377adde6ee18f484402503abbb6ac7eb3710cf50f7815fab1009159a82d2431520f1d994b837071fb90054a3978747f992d1b80e6696e8d01846497c5dbdbb4da495da046811b7917551bd1d7e74ea6bf0789d5ba151ba7fb86b4f9a0978424a6e951c2e242674812d71164c48627bae091f47d83e2ef58f6d1351dc88070c48124164ae283ad92b7db828dc1dbb890a6e920a6646faeeb1109891bd3ee42baf8d596e8b62dac997e02f38175bdc8ff567a0aa8c3df1e4e94a3412150802122b8f3c6917ab19851793efa1cad43f988cde1a1314f5d8c7c3c589985db1ec57538506b5a0c7fcb286a2197fd44229ce3067c3a62a8a67eae459e505f66cbfcba1a78f1d5a90a572358fc135930bb14d58f97a7681b6f42469cd91ca6251f790d54d1cd5c2a11449494062ca35e92e2b520c88ec937a6d6018a635150ee23267ed940b2ef231570530f4de7e5b49d79fe73c3ca712be3ed3f96da1821e1232c38e05762f849250a31ed95921dbf4e2dab26a8b8ceb6a7b049b11a01e9e856ddb7b19c0ab412bb9ffbcb2f64f8f08b1db4cf9fe9b1cc0f261cb17948b6bbdb07dcb6317f8d1f615af900d47d0dd659c4ba4de83961f17160fedaf7c8bb86e367263c93041f1e1926474f21389decc9985f8d248acf23426764a241bbccdf45e4116182ac797436c7b5619d05082e7c2afb80dd7b86ebb018abf3dd6aef15595a4f1a08170032b54b3b8b75c74719bcd667dae85db9843a17173470fb7d17cd706fc946582ed4e097f04c03b4a58e0dd4c5b99db1ef21c6422fdb4c1303363025c411ddf82eea9e698fbac79763dba4b8fcbdccb261d765ca64910e56541aff3b6e28e3006793d3418ed55a87091459d1d4dba642d242a81c5fe52f040b656dd1b06c85c05c7422bfaef248100dac92d33da3485e0bbdb62dcd275c2857d506e3db0ba3f0fee16b66558822b50a0318302ce81913f8ed27a4477dcb0a53184f8f9de1dc182554ef9d3c2fda217d07d04f75c6d3599a7a44affb803192d14c9170a3d355c3604ed665bb7585cb0920b915b02d5f5aa94d374f8ed03dc884e592a3c3085ff9d84cfa88838544591a4c5da1f11e73048a300a04b48fb9306d96b1e01c263fc9fc793b89e1c4351ee76f3dea040c7abad1c885306b30c51109befcac87045bb867395556e452dd7554977ed056e0be6b108c0c537c5c1c9f16e645db334eb00aa0139931304fc41428edcb8b82c9a425db44a08fa678c49394d83806c717516ecce1d9c5867c1f255f9200977f0b32e65073b8cc8e668f7b47fb3dcf29ff32b2c93883d8f100f75c98cb059822cb2c129238df5f9c70e231e35da6a2c9048f008f242c49a037093e4689786e6af3cdda5cf8941da5d854a21663b871034b7562be0ae6217eed5ca2959b4ad1fa53d457e9a7793188df53a253071846d48d0e2db7ab662747707e2a9af3d055c5894ceb1151d08257cd7f556b6dbeba0f989558b05002277765bb3ad2807c680b07e59a2a868b699534647fa4faff9e63467b7bd473971a4daa95969fb05506290067d4e72d7c47c0d9d02c61532715700515d31947df4b3a8ab928920bc51bf3a23d5ba48aed47fdd5be542521091ffe3718907e396e91263c38fccc43338cf0385efea81a7dcb839b7bc40a9f8dd734e073d256586ba25db9333f3c54aea9a1b558ff95304c72430af172e768a3b073c35f69b8428b3ce457aaa9e3085551443ba730a30576ba18c3ca080186f446bb46754a84624dc6d10206b104c12d00701d8164869ade151b31752aa64f5800566c5f8cf54789d6f4b860e0e87e29bf2329512081993b9a22dad0e0a04f2c159548a9323616492dcb2666e0eb133369e13968477f2500cd098babd3b3f8d8fdd4bb175e7be24355ea16034b404cc1ecac8e399a5dbaa8bf159503b829193ab634d0fb02505310c94cd27c136a42d760e9e391f85907d127e77fe39f0b7f7bbd687f09731a4895fd2f5bd78f98aecf07d254ef0299e6cc63063ac680f2c338e9a3ea05ec7a68352c03f86b50fedb078a52b29eccb3d529aaae6cfcae80b9ebee8cfbcf45187830c16d66dbc449b9306517f972ec45709bb6fa89b313e77ca0c05fcfc99190f6518cb9dec8d76dc2765e130bc818a29dfe950f2584c8a8b35ab7fd63187e9c9b61493892de1fb7922ffdab576d2d783b73a90764863889746f7c85f16e51bbb3572a60f44f1b58c1a6d819c87728ed1a2d1dd0a1d29d8dd3002a3e4186836f416310793d831b9cefde03ab44036dd1e19eebee6a2b4bce09f11ee28e6d012686213b5837e2290f792cdb19e4a2eb0724edefd7673bd8f6a4e215792027030499ddbf9bb92bc0cd87da29ffd2aff8808ae4fc98ddaca07ee93283ca5bdc881afc0d1e7b46a1b63f503408bbf483acc9543d859591332fb0233d5eb74ef95229896c81e493c8c2b7ff1b678e7023e813d28076650a384a096807908b7ea53d7182a353e72949a05dcb92ecbe27d1cdc027b90e0f3ebc7881ee1c3ed26db25841c1463fa03a77f336b48cb2499ec11d1e9d94bc7aeacd292b2112011ad05235a9ceb54bb41bf63aed978f01404f074185fe6b9bd0f43a31a9fda1882cdd0df5c98c318e84ce0ec499e5779affa2e605fa6fdc44b8a5e2601145d40bb6f0ff240ef9c3bf6053a37ee5c5d6e5a0762cd10e09824663d314dee31ae6e62320546a06942566cd98b978064eb57ae98af7440703da4809798017c927167cc36e9ef1338b9d9bc2793f19f45ec18c6398d8765c1a5c41536e6996509bca69099a97039a87c5c655f4678cccd0a7dc2c084992226544f1afaca0bc2fb0027a2bf552eb8472d77439afc40de68dbd4122d3ea5005834edb1924045b050fae2f86a821b59dca1a6af2c38de88fc1f2f2ce402b995c03e00922ecd43793a43280d3a4e0333746c87ac321e9491b508ab8f752855870e76d7736e8af613f48962ba5aa2d16aada861a579bd796fc28e79a589c0307b6eb9388150a6bc4956cedd3f29202394a8c10fca286303eb6546a37cbf589740f9c75121c7ce6463b80f3441948faa17879391f5de4aaf4fc6f9aebf3325dece89e173766660c3e1da8f91114c30e776763cee4146daec0d00f3759cfa702f92a510e11e0818b87d3e0fd6214dc2ae307325e88505a07f1499b8903d5d2e615c04782633a725ddd350253565f9289787b2565e3763895b3e2578613d5775182ec9110d08aed797b39abe1426cc93f99a92219082a7f8d8c5d1ae08e703e012b93f42bbc5f24dcdf36d3997d46fba961ed668ad3391bf68c6e7c482eb96a0922983c4524b46135a410953a1028243b167ceb2f5b525c8347056dd08f6145e1299385f434160a0b57241838996367f7cb4d20783a2ba767fa1aa904ed8ab84d9e7b0c51ea6c393aa470bb97d16938f2fd687b337a2861be7d0b8f1a1c019d5843b9cb2fb0c87b9a8af5b7c9fe97ea02267836e785fc2a2c6837ab220a955ba299d241701022a4aecb26ea31f27b232bdab90f5b25647d290fb6511f3a8686807613dace284fa7227d01863472f00084e9271433dccd1888965f180dbcc239d58aa3f08856e3d9f5b4fe973379aef54fc17a2f957f19cb7aad0f9bb81ce49fcc66fc7cd801646c5239522de1da60d7ec864ed6f189cd8f06229485a3c720706500b15bfd8e427ed6223feebc1b7c1ecb165ab3813c81d5eabd46aafed8398111a0c3e78ddbf4360aea51d5b3fb33f3a7136131f6f87c389de5e5b080e4dda42271ee413df45734ff4bd060ec89af0f19f0cb33180a1151b754ed2b5d8b087dc1bf09caef3cae012e9f3e8eade693a7ecb39a21e618088812a9a4fea9f4bbb956082fb3be49472825b089da727d407cf830630c2779d3f78c58f18fc1c17bbefa79e1117f923d5d8f10802e915501a259fc3725e292abb736b709ae269868bbadfed88b7df1be03877e42d70b30ef9461b1a4dae3133bc6c9b784842d3213d36e7b4863fb54b5955a0e3c14fb05224f4209d3953d1a782d1fdf5e16342c22ea25617ec7be7c031570589382349ef5f93a46ab6a11ed789b5503c6a4a960eb340161f2ba97d254840c3983993d5cfb324d30f0def34b58557dcfc52cc7b03ee15b509aee6152bdb91203e60e2cb08643dad5bf1af36e4078cc97378ca76a35e4a44f9f4ba053cd40d0ca6a16e29de1159a7ef01831245b998cc797c9b381b9ab9f3cfb3c9fbec190e683c211810bc97f2699d6fdf3975c781c81490c652741dab73b9a750ea097310abc5099fd87cc351c6b158cfb51e205e88db8190172ada04d455658fcf6cb1848b18442a373e04c75f3b25d545b1344c938e5ddd075b63bd1504129b4a4be8f0aadd06c039d48475b4fc81efdce9d34d3ef49d37bf757a8c5a79a1e98a437151db3e4a41394783a93ef0fee46b4d1810190da59878a33b0f841954a16b8684a102eccd5e3ee995d966dfa86e2941e32a4762ecae53d0767bb7e826d333f5a0740aea9c76be25bdda8d2af0144907d3cd4c63c93e769978286b368cce777497ed5087d4fd64252db4d945d303d31d863c23bbc00be0cc654a119fd934e6e1c0576228637b902a6a67d7bed5a687c16a2def170d0d7b0bf73ff2d74bb5c7d041bc4ced329465a3095195dded65bc5f363021298f9a8490a26e4b417c5ced768728039458d77e456dc2e07d5726aa7bfbd1f20e9e7a7994800586c259aaf0e6bedcacc5eeeb01069c3a0946fbe74c9d9644a46a5bfb8f212a2831c2757cad3834fda0085f86c90c41ab2050f1eef2b63d4d049bcf020d562f09514d727ab3898c12a8d261eb6bf2f535113e41209fc334a6c10b05a7b08fa55ffd0c7a8b0f3713007e592c2291f644ec2e3fcb0a1cd4394391585971d0666ba0e9636dd80ba1e2cb02b8db18a5519c714ebae17a94de359fbc44fdaf6f4e959efaf9b4d182f149f6d1da465d8c15aa341060c30cd6957da22aac6bc2f3cd6b082911d34d439385b8145a78846dff8a67373263424adca62721d1a2c7ee013bca913be63431c1b2863cb12cd67d1531af4a856fe24983303ba757823d9774de70beddc5810a322ec89a6b52558e3ee58da7853030085eb6b7bf756455c290a354d5f6f408659ff1b79a1ed64be4220fef5b507fb0b8185e33ae7f008e204814a1b570c07ccdcc7826dd8b7ca2d7370a67b9e5b385aacf9e368a3c1ca7c00c6e65b2faa31a951cb707048e75046406dead5de738499faf07b57bf7f6bc95efbc06dfaf4a4f27dcaf40c5ee4baef643f6bbfd430220fc15ea46a4be1ca3da10af5383e835c4b6637a92c3537d60405f438c8e5dbdb20add1f9898ae53ac27367c00d101c6317c822cbd5989c79dbe5fb44ef889126d4d29937d619bba24042e054737043eee02c0613758103a433503ff97669bf336dfb7db49238629b5b6c5c1598ec53e99f1acb777d346cf22c5aa747fcc77f67ed2f7c16bb79954a81383e6ac080d21db4537d57954fb9a5d5022af78ed4cf38996c92a9deb656208b439fa8011f5cf2037cfa370dec998631cc985972eaf8eea8fac795f107cb2fda658d5f87c823bd929cf41c9c4aa0c50c743ce9b6ad2a2f71a43b84a12fb98c61d079f70457c0c1630d03f5159db0c0f0127b4d689b3ff104735f9e1b93338036f39a7e86682638b954fd1a03f02d59e4ae66cefe02632f46770fb6dbc9de9c2b989a01a01e394ca957ee2cabe6c8c5d52b9035a5b1167643df13d6a3525d539d63e45d49ead972975869fcb53673184b2152c5c3fbe98e7f0ac22664003304c9aa0cbcd31b46eff73e3871224073fcf1b9af706165fbe0879e2082714b968be0f1e551210e645bca792c2e86a912d67d5d2864b61dd81121bd6ab0ad5727bdb09f6546bc3c330e496a9401bf4ca8fe32f2d51f394621c297940a48556a8f7b1423c7abd294e0503b8ebcf497e7a467b8a0c391ee088b46cdd11a6e323345994865cfbe1daf49156943525cd3c80340d38061d6f273582c1c573f5815cc3a809598c8cb73d8043922d90643022a7244141f89cef69c0c89f9db6fb105f4fd4b000ab9e051fee607c1b5ef2e0ed9f90b71c81c58c890020320b30e73ff3ae1165199c5bcb721f533ff3e2661d98d0db39dce795400d200ee38e8466c37aa5d3d504a81e470cb8a85c024cc03747353965e29eb33a626b7d85d68e811926735ec40b15310c77dfe3af88d3a8ea9f39d3fb1ce8268bc0b5e71889a7aafc53d47c9ffde2c1244281961fe24aaea8fc94652af1292b526f19e2121118528c0130e95a798f345f16f35dc1cb55fd9bd97cc4f0d3ae04c48056a8da61409e311fa4da3992ef875190be0bdca4506f84d7fc74b08b0bab13866c49247fe6be1c8e20f8874af0768152d0bb56cbee274a7a6e6521cde85b93b3eb5605c482db262b98afa756ca9a92eb327a13870bf953dcb8dd0a8bdcf897f36bfceae2870a2dad822aebd1a24e339eb25aa15142419c14af5bd15bf4e4daaf12f02ab2d3f0ab3393cd56f790bde05cf118bb00bcfcc506221cb0e06b847ba317f14c9c68166598f8cf885127f6943fd23fc6da8460994e533c3ee1d90012410b008a4d3a37c6902ef4d1dc3a8953503bd5cab6e5ce8ab0d5a210c6c15fbaed6cdc818840cba84ea0e8fa107cd4c430e47860ef30bed4a2c38559a4e4447247f2c509e4fea5de0e027d8d41d8a03323fbf41295c57004052b2564e7e499d7e7148e1a63825f5635c88ee81c11af3d4312bedba285052edcde2d4e91934327ae4189e61ac3800455cca21bef1062c2a4a5e67978afa999252ab53f24f6391418628e24c1cbc6d08c1d608d8686acfacf6d8ec7726d73114a7f7e8a28a462907c34242325b90cba9e662fbfd4ef5c8d1dc7376c31fd236edab95e27d8e96cdbac391c22c22b6836488db717e2b45eb56e9a1c92a8d0574e4c4ed12ed9009772024fe0362f5e4dcdcaaaa0228d1b8b71ed9708a2d0e9bd5eb6ed647f706d7db60028652c0426cc395414e3d80560a8a5765e0f35f9239590506d5590df0ff03091c0b8da040a4f080a2698b84e089f13d2d6824014ef0ab1f94bdef340b7f31f38c0b20ee303b957f7a4a4ba9ed1e1b44f2b95cd8d01e2ce24bf2e4b34b04bde2953242fbec98e1bbed0ad41d05043fa5fc9fae7e7f4c488d6561300984fd10740017c2d43254bbdee3f36ce110273d4c0d9d9559e2d17c93e31985b8ba25a01711c5825cd490bce097ff65c036706960662fdbe249b7a6e23b77fb6ed2cd27bfe8780b84e942a32d898f0400d8ace8c49f0c04282130364534459eb2329bbe5afa1c9f178b0b00d9a4d7332ca11cfea294b2577bacae644aa416eded6ab7b846160e3a18dbd50fa6b0e245668b70cca85062d06011944b4f1d186d93e74859be1612ae71b907cb45b4aa80d92c734eac55fa26cadb82a8e98639862be730d7f2400fab86a1446cd4038bf138a5d125a8da8c4be33181dc9166bcf3dad3b2be782743dc5c12158305d1c2d880c974513f9efd2d2477457e229b1d1e095ee2f05181b0741be9b3febcfad4e1a512509ba3472bcbeaaea3577fb1f1d3bc9b064da3053e9559c24525328dfc0ac1945d1cdd526b08aad6a2d8f9e1783b338df02131b98c08097bd028f6be610596f1cd1b3f9c7efab9229395583481c0d049acba691ea9a3070cd8b13865fa7311e3e2259ee9f0e069500ff57248ef21fd677ca52f552f6b30c713c82d8d2c296abaeddc3cbc27d120d6546d69524ecee82bdefa090a525a80272535a1c8ef8a6b031f0cf926cfdc097d2d56e629442daf772c2435adbbdfe6ca2c200bcac9abcc4365f09bfe6aa5daf63b87bf62e4b78aaf37504fce1a7fb787de104d698baf6ef38b503c53e94a3b1eea7a58addfa14529c74cab3c3f8d5659df6bbc1de074490c66d047e9a1a2a7b0e592790b07a80bd747d3c7661484326ee8a88bf8422533f7dcdf386c40ce56e992e275d24f91eeee25f59449ec82473c3b991336e656b487479ba14d5a73431c23829920947ffee88b8b8efb570c23bd5f6993e0bbcca650d5cbcb558af5beb444b325bb2004183cafb60689fe5d41e2cd401a7f24b5fdb263a006d353021632ac3ee780a38ad87f868a666040760ca26f3136dcebf098c006199cc30150d7f9fa642a99317bf8c7f22b5da723d5adfe79c128c43cfff7ae935cf1d5d5b4b5702773a355a24a232349f553c047cfcdb768680e3b366c2045c983862badb8c8c14133c2a6817994647f42dbcc1eedbcdd9f1a3fe048c4c3338b704f1130af665a0b84d20bee07703c88583d60dbd7bea5822856479d8b9465186b7987f211fc17defa56622de6aeff0a2526d86897e8f2d8604dc9451812bfc6ac3a41786027f6719663022707233bdb802ab612a13208d407120dc8445e152b40c0234c8814bc79aee5168e0491b126925dd4bdeeb6871700ebab1d58129298c868e2810acafae4d11330e0a91f65805d6bd40eae05958e7906b11c3bbc71e681e2656089dc8f95253c578a30560eace818876c0718c01bcf794e46bfb14f606ec2595de116b173c9fca933c48f53a98d88020a7fb7af92194c83f0851b4b390310a319703366ee375afc5f7fc700b5377a3273f836686343fe5ec3274d389017a09ee48f4ae3a1465f6aaeb3e4a06900de860eb7c0a21869c67b4e458afd3a7d9863fec0b0b6a80f1f0e14b0cab4bbafaa980cdbdbc9634c96aab208c991152ad6cc59f344e234f89d8664dda8b6b60423fd80b782b450e69fee621488408a83603121f8fc34bc75e4cdaab34500f7cb24e1f9a5a93f5e458119de390d1d560e486cf4c218da2aa81b0f2c96e2feb5789a3a1f55a27b2f4fcb4ac83c6aea4a2d593a7f49dd455f2c263fe5bb85fd5816ac6fb63b347e1cf9838627e4fd9b542af2fd13c6e2b39f7e77c3950719d7ec4676b80531514881b9a35ad950fdf0b3c5b5ce3baacaf7d029e7b2c5ad06df8e961482fa9562895d91e3d929ee37006a3a587d6e33b67b20617eee346996f46c0c773e746ba53674401be03dc2f8acd6d7a4c45dea0fdbaeb2417d4504430007fb5a64bdfc95ad1a03d906c053de649ffb77ce8a8b7de6824ceda2916a1441742b1ffe144d71342307c22c6c5df2e99f42f5cdd5ba7aabcb245f943a5661a2c979a9277fd0deca793ef4b208d55c4845a880ab44d5f29b7b1127cd7dfc799e65c90ae02547e556e205b05150629a5b9f08c075167c5bc563ce713c2f0e0869d31b139be83a057ff4a2271176b50851e3a1e1d96468c92bfaa76d41a3b4a589d24b670aa8b86076e08ed104ab7e9ff97d43e9c2ec27dc362437e5635f0faa9d1abebceef0ebe96b555bf70e334aaef37c7081f68dd9e491714d2426052cafbe02d998e1efd702480a7b24e7c4ee56de6a74d8b3e9345a80c444f2235115b4e86da42d1e7df0dfed01a215f0b298cdb53a887d6dd54ab9f3aac315356ffe7a4baf98e4d8cf0e26fdf53a8ab0c66cdd444589fca12e8c77a687bdcbc3e7a6790c8f096f7af4b9f56261aa9ec00ae7f1fd2826d7ba22de463efba9c21b76a8a2c5acda23a7b371c6cc32a4205723787d59cf09fe2a2cecae2d6c4f9db7b5f78cc8a384433403007944059e328e695cecee2da5cbad35e9665783a8b87b289a3c5b5b38e1aa76cff0f3edf1fed04093f3da612a3f607570196e9f56a0ceeb572091533dc06b281892c0b457ec4cd84ee869510e26a86551b8973ccddbbed537c3faf8b0c69da9258fe7487ce5ea787bca421e6528e89d91546a8a6453521e7212e9473ba756e8c5c83a9a88ac596285893b1ff9cd4cf957556567fdb6de97d03076b482e0f6bd6994ba41b850cae81002e1a8f5581a67510c2d010536867bd1d260d858ba1b1c675ed2be7e6a71834aa858eefe014fd02150e97dd5960c69b22a7275895716606c97c9b9818e4a39ace2af64746c850384c852f116d2d28519d89bb045f6f5dc1946bbab4fdb7caf9e46817ea1c5dd33ab2ee74b0b3c86adae3f0f2a2c7da57a405c0d505a38014c293fd1fad86a233fbb546fda44eae5c78821350010a15ccaa6e56ee6831010866036b6a0634e57b2559cf199949808336fdff2d8b5f8f6d787a78d3974f40735f9cabc25e12d29b6cb2e2bde574075b272437b5f50a20548e2778beb9ac9e895fb8e50c5825431e233c2856f42298d101ed0e78f5a953059060a8b117ce1755d41322cd4e246d887eca7f19b9f96e53f36795af2f6f1ce2444f48a719c7c6c9593f0d20d82a42d95c289975a8e6d1f46c5eea43f0680e9ff2bc1341769020c50e6a23bd330e1d9b1dfd3569e2d0e6bc025a876e49779826b9200588098233578bd592ae6c87e490145a4935ac36b3403461a73d6a195c15aa7775522d868f468bfa8e93eb437c1f193c912662bea03abb2bb41402e0eae8b5082cb9b86a9290b45335899ae29fe188657c0533e6d9f280f635379426773057cb183446357b0ee5dfaa4d0aa2af3881d48effa2eaff02156f32aa398047f73e8b0e8bf73a4cd635284b92d84261db0920e4aec9ec3732397a72920f7d30bf3b76c035b86b568a44eb2981b25405bafb4b5f19030f3580b8bbf9240735bd93fe5dbbf96d1147000fc3ae29d936714affc9ccc6ea20ac6b8b395519981d893e2c878593442aeafe8d76b18ab24b4dfc1524435673384767a6088d586fd8bea7ddaab631982020883578565418709b87e0edabadc2d4b001161dc15568439f68cf279ba79beed037387a5048a6ed74ff6db3bf2ed845dd9dbd51ddd5b807e1dd2cd08cebb8c55231db8672bf8272d66a9c0b8de0073ffb4e20a44d49623a6e9d5b37c124a5cefa9f122b4e30b0c774ffd12c3b925cb48ff0008c9573a0834f3c5af66694c3df94a0b1dfd99b3b8ccc729edc6ac278dcd367269ffd4aa207ec1b3d9b296752a2db4824f7e1d6096bbf54b00fbf3993e7497356d698af891da9826dbbccf80dcef52891db282b574854beb5e0eb4cfbf3d1892f24ecaae418e8e4bf81cd9a15027eaeb8c1ccfae3672ccb75aaa0100ccfde672184647814cafbd38c7c65f9566601e0481e6c07b8eff4281364418e8fce04d2f70101e7081713baec53ec647b18a0aae21e0718b99dff5bd361b4bad8cb9e141a9ce2932bdf43caec56b4952cc9cab7fdfe32d0bc22a1584fd9d720b35ab51e0941d4460a33f17550fa9bf665ca802bd306e8c368eed6c7591c1bc50a437479cceef73635bbeae6bbb9d13ce0e82dbed1b602c20a37cd3c42bb4f180d39f6f0c60567a0522c3b7b95e57f94c5685b035abc66f980eb5eda050e714f5516b022fa0052d2eb9e640aecc3792aebe2e1be687317d2621dba5a41a5f1a44d4887100d29e20020a99120df9601a71f4d1ba9d7f3c95272c82b1fb277e02074b02ba3c2c9f0bce65fc55a8f86e6004691508ad78a15f60f2016daf19c19ebfe759d93437d78e9ffe726d7e3fd6fe0ca1d5864fb2e49912579b3c1396116b75cce34d20a17482141e4f5501af6bd626715e9954866ac895ff5704a1236e04afd5d0cb798b78c8b212a5de883512c2e4ec96f1b592c505b33c7bba5fe563eae9fa41e44ff9b66162c4644eb6b2c808bebde926846233c4650aa7887f859a9676e8ab38ab5da81f77e47d88422f4f007bfc80d2cfb538f3ffceba15721b05e2a39bbd3e5b608bbfeb2a939b6e7587504c1313dc8cbab6eda81a47e37e76289bbb52ad35076d51e551b2fccf5941afdfd31bdb220dae20be4b14928711508adbe5adf54e8171f975dc359cfba0c2c7ca37aef0fc6343113f75c747600b44c335f46eb53c37bad038df643654ac4032220aabc83893d781a4fe7a744707b564d088dc9ed740b441063b4d45f1a3d1c4736b5facb5c9c381bf38bafd865638a2ea3f1cfaf135ea6cbfd4a47e700a88a1d84037955463cf74e5ee05be5398f32435bfd320c753f8ed142ed12ca32a97fdbc6642d72b70ae654cad8722cfb459127a6f128347905e7f6632643c01b85c8c55aed9c0f171c4aee601a5cb3e3893c8da8c438a22a2d50e4dfb9277b984fef5308500308b53d001993ca232bea4f699c6b9a5004a772070b50dba5f169dc6b8631285ef967a006e31a6dcd31200588c77941ab4dc7984093e16099fe8b6b77311cb428036e13225bb12521eaf1ac1852bbedd72a36152ec9a24920636aad5d0defefde9ce6bef3c598a067c66a69c2f73a1a4fff612e75cb37b4dc418f9af4e4b57b8fc78fb056ee41d4fab2198fbcc00a5a64d413eda6f58cc233bbe38e123d82ba3a81af3c27f85f4760ec8ed40637d6c004c6e671fe9d99db80c06be5c28a284eff409c49616001b09c0518bfe169e3caaec13c432106585ded688fc17be7cffdad243a52a08147757c1912ee994f8100619b3902ff2130a6ec0285f90503bea059d2144e8a68be7e5a3baf47df38c1217a3bc6d0b2bb6d340ec2b9c7c9f348afc9b179fcf2bd03548a67368b2fa0d1e1c626769431cfeaf180bf769cf9fcde506c5fd8368ae1242886bd1722f935caac36a713e3fe80880deb942d55d76eea8835a05a8a75d3bfed8afd09ecccecab42b45fe2369b069dd89fc4e6aa85f116f77318cb7053134de18bc57cc389d8b672e2d51820ad66cddd5713f81764e03d45ea3d28962246e4d51aba9d138fe95c7d5a12c1405666cb68bf73a7623df2072667ae6714c6bae1101654814612c2237d87230f12b15b341da7a7965d4d0cabf5e0327abeb264a96bfd32f351c620c0df95e9e712081a262e33e3a7a20af08505b1de8ea868d6eb01517f16c3647abe5979b8d62295b49e130d1a55124df8138df4131a1d3d6f98e2354636d2a1ab987e6c4866b1f0525a70cca1969412b51666365d840dbe8c5df192b8852347e14faca7f392e55a17cc45aa49b8b52951cc3478731f5204608b5090ea89abfdd9c5b89cf7af58618837257cf80ac09ea62b78d940585fec651d389d568ad99939efd8c719b765d8e7d6aa175a5fb4b8e07fe057556f7683ffc1c81c7fc79655e842d5b514cdd26702e8a7467aeb2397d62a0f3137e66c0a0be6d198ea8fe661d12afd544915d088abc7f6f1841334f76f388a3caa65d1db2806f39ce0d70f618a427bf23643489cbf4f975cb908f8991f96ba03a1170d2e9a346d784cbc5cb6531335c2cb8a26e995a7587872904753bd780216b749bae19749f7e4f593fbf288364bad754da83bfd05229fd47fa51912d494e15a21e1967c88675a2142d62e76b221eb3bbee6c45859b7cf1c16fcc61f04099869ab689d6f3025250f416ee45f10c4e4ff827eaf2d9cb951d51353a07ab1375cf5d1ffff2fc7acfbc09c115af40b948ae83af105b86f45e8470320aafa3517d9f81f19e3c3e4ff1ddbc6e27f13f184aeb4d8ded197b2de1abb4b1d57837a5cffe85364cf124c230e0afff4d0fbd20de579496e2bba952d428b56ba310e54d25921683ef827cee8563f29d25a2e57ed82775f99106100257ecb78ea1bcdd17966bd24c18e756117fe46c46f9654179760d504ea41d8344aa9f96036e07460ec39562d08b80a0c69948af9a5ca83b737dd8353fad958954a94d50dfb69165518c00e1ec1d9ee12aee310972b6eb64ef2e1bcbbc45b30891c1dee6b2d80bbbe9a292e85ae01233dd25a3ee183847b0cc3606e75427eba64a855e4b9058ec31fdd19e07d79a2e2535bc8e8bd78d3d60811e5c7a0a8c9f0ca56acef69757869444cb970d70233f1bfb4cde250fdc8b5ece343c2416c2339134805d21daf1776475f63d66d67e421fac34e4277398ac895069093541aa2057ea315012d9d609314b9e83c5dc58348084ce7cdba3cb0415228ff10fad97fef918f78f479c2e4fb4954c1cdea5db09c2d83d6fe42442e8ef302485eb7925e183816c29ff50475ea8bf0e86956e76eba025848eabc15f141d349defcef8cc7aa878f38756ac79d3fa043c150468a54c29ee4dac389d2efecefc5dc82209aea07d69e54c28dc6cd824d7e4f44a4ace34c530b2cdb4a93ab1de4c4fd066a80d1054f89b08e7ce5bcd4fa40e00dc512d15714b47e90e20eee0e29c8cc3c5a432156125024e5498bdcb6da5720853574869aa52cd2ea134cea430d25a79b227e841b0e0174dbc5474f362b51b692ada129df4f0347d298a0bc27a82c05537d9d44df2d6585fc0c71c3ff9ba9eb63d753f2b49081421b5f49f6dbacab8c5e1ea3282d9708c82b1af552167d8b7bff3677bb74c56aedcdb9c9d8170d51ef22737d3da8261009207d014406923fee3fe870be57e89e12c075405d441e85312604c1a20d2ac0d1f20314306d325b7f35d299ebc48dec2885d9a1fe4848bed0c1c0ba37a90905397e0ef0c2cf77106675794cd6be5b8bc47478d51284ac9bc41cb8325cca788fe968e5befdfcfcde88426d4db2d0da98746346f3a0aaade8664db3b5aaccaed8c5ddcc08f7c3b61fc36ea0e198d489471d79adba21bd81ba72f4ce35b65b8ecb202bb700b636d53d8e0e01845dc01f2be33198c6ab4f31ccb9065a41d6dd1410b90569390c83bf476a78de03798dd257977de824e1cbce9279d62db3ece2005caf06f909e5d47f7a9ac620d5e66fb23832b173d52cb8b5c78a3b21d062e2094e09b0d467198b5e5b8f0d05394741746cfc3042854b2ff0b6edb53482ca486eecece70a9abc799f99edc6236f8b398a0ef703c3a2d42aa84e454a85b63548e6c3a8fde5b74a4e77a195ab83a04cf8696b93e5a6bdaa64d4f524b2465414831254b7950998e14b77bbf93561f04ae4e1f76358d457b03edbf496ad26c9b83591ef03aaf207e551b980a3acc095ad094c6b259e31ef3e66ed51956b5ae2ab83ec7dda4450f63119d95dc0c209b94521542f6888e9469aae012fc4bcfb1ad7e79ee7be873838fd91edb8a48db50d54c6c8d5676acd78c35d0d2e70b4339a3ab0de448335ecc1c17bb669347a237a9c5a63a837ae7f6389102a408dfe1c3000fd815d9973b1413a9024d1f854ed798e274ec73fc1be6bf392fd1faaa21d245d728ce96509565b424f54bb76a457b3da07bcdd878a037408c2db3647adaafddbc329c4514430b29da98b0abdaa85a46fae06086b8999e558f2ad4ed47c0fb6c8e56346e204a75ffb556d2ce060858702dd47aa87e71e68c1253a9fe95a7e47a6b73b73826908d40a0d0fcc6d11061fd7042a8e04a66626b3a7588e45bce508c27258bc1524223f0182b109bbf037de255beb3a97c15c9ede12aa794de0eb4d74dd747fef37ba494a5619e717fe0d1fbbdea75deb5d26528107d602d8b0bf41f410b2ecde22a10e5baacc1a4dd27003028c155767cc1009768c11cb0e9d242d552ee656b294d9ef0c1b31732c8e0072d02d5a8bb6a9f8e9048f93997a48581b121752e974d0fd59b193bcc526e0bbb2735a200bdb87caf9c80afa72f1ccb693f471648939ab0f0432836d29e4c4660fa5f36c23cfb39e94b46b40ff7b2461a0d5377f1d60ec8209bbd82d423c11759a91f34fb76f8ea6410a6d3b94b428c26eab589db19c7742d610b1938d6f3cbcfdefb96b79c1c1e4dbe7067b3b0a85bdc697bc68820157881a68128613105ae4fc177be1c82259eca1ca7265784f7366188e1e7618627b478527071ae929770a0416f2fb616c057bd703e73ff6882e5d72e04680921d74564c733da7f0467bdca7a67f2bf9f9b81abf314966300fa392275374a092e034244b61cfa61bc4ce2f166f31d017d21528723ca3b461e4ff61d118d93600659a5a9802c17823581d1f892ecc2db9a0584f21f7116e0d3a69187ae7b0f14f002bc7ac05bb13485ecd193aca18cc2c1301672420214a777c0eadf9047859dff9e5a6180e325cc06430c6e6b31aa2a5305fab53c9b288d00c147bfc0f5824a198ef4774050d74ccea1d61dd407d41eff8fcb23c8b459d1008587f5f1f5fd335bf8cc19b02f0429bf6937a75784817561ede5a57a0433327d3592fda7e20dd05baa4cecd83dce184b80095fa1f87c2985b6c064ec438e7be39a8f051b77e90abffa95f460c64ce8bd846bcfed1f74bc5883cdb0b8d6a588aaa851419a9e0c4c1203d9ffc4fdf6b3523b04c9f49cb01cdd84ced881f3e9e55f2e74e21860aa7bd9072fa2de635157fba85182562723d709605eb80c3dfbcd965272978cf4ed6c531d63b6bd7865788b48f0860a565eccbf176bc893c159c38f9d252a2ea59736a7d25669b68531a6b15a836cd8fc621fe388dffad966b4340a04a0df409257abc53385cee9ca1bc3e62809b969f8ee1b0dddb2fbfcce07ccc120d6692dc1b1ff481cbdfd3eacee88987d716252f0a1de81988bb9488badef44b93ac1df36440625017a41e0a9eb1843835d055c82eb8e1cc932f43d0ed8b4f8f18c4fbac8c30f6b94876ae0e39e74597388ee1b420526552574f7a5755cc2ce45ad1ca26e8317be86363012b9ff746998ed0468e196280470582547a940db0413cdb82144bcc782535d6b9641e4bd19fe9710f15c6c26aecdd90c302edaaa02b62b7a14ca9c6ed0a5b0f62c5580f7045b65f734e2f2e7d922d75d47ae2bfc50be15eb892ecccfb233ca12234a7b62f654413b0b4e2e43a31bacf58a7067bbc03f3b81aa21e8022ee94260fdf532a23b892e16409d7bbcdd57958aa99478849e7738f40f1a52698857a8e1ac3d9ddb4ccd5c5d803c6d18492af2142b3faa2de10790e89e4c842e926bf113be896fd031ad4c13c1f5ce8ab54b5f01af12165e1b58ada72c0714d45e636fac358a5c5b409a0791fe0f78b15a20c0b7a6e46184400fb29906721f1f75748a06a80bbd94e4ef2b473c421c1c24fe137956a9914c7b7450306347a88d183636fb9944c2d70c31dfa2508d7e4de4bbf74a9df787259bfd90b961ada65b447f3477c0d9e7d7a93fcadd0f89b1725c04bda664e19287e5b10095840694711aea5d2e2b5649c3f564e08e3f801ab59a5abcd28f5fb3a14565704b2c689d9e8581aae4f9b7b75fbf69cb21ea2ea4b69fc01afac26f44cd78de1e1b9da1a0cf58d5676d4a8438f4584b5597bec59ef64cfb614c43168062de723ec3d7a5dc2f803b8b1b19347f6e64fac7aa324b8714fe37226f92eb786416b96a1c272232f72e99346c81a11c05ec482c58bd35e00eccfe7b9c1e51c30b079a021fb00084dd4a7990a4682f9f8541b1b3bebb1b32d986bf4ed6868c65ade7661f98f6301feebe4a571c4d422dcbe9c9e17dfcaf6644e691c28bf315aa943fe05a566aaefb2f5fa458ac2ab5d47a6e4f2b1472882ec0723a22dcf9acf4e5437ee27193b5ac51f57578f70080ef797739f51861fb375c7d8b3989cdda77f02e9c532f0dca50b8f453071fbe4a17146858fc9325c36f1c2db85eabcb8a4e1e749dbb30b6bf896c7f4b2fe0b6e1176e9d8bb7613b861182cfd970963bfd0b1dbb4f8a2576b439d41c9bbffbbea14b0f7d36e952c1762cbf19caf7e46a3370120764a26641ecc7b99db04d4cb54f0b5cf9456a40e4d7260ce868fa49c5a45de59eb32f78097b1b6ab3bcf339fc4510fe3770921e21a21969fc3603819d66a82d7d3564c2eb1ff30be68978e7613211eb545987aebc66a1a39ad75edbd4745b9d6a1356ecb0936f9ee1c0b271f8790720aa5fb21532e96a85cc4ff74854d2a4db6e762ac44401bef35b18a072ccc05732fd05af582193b5a2b27a44392df8f62e95fd90a66e2fb18df64a391327ea616512a26adc7a1e041e024ad7d486e647a1d113b7ae0303be09e915249f38f54185f6d19ab3cbb97c0eec400f36c00380d8f305fcbcf047624b465f73e1e46db9dbef680d60f92577a708e4aaebe1d6cd836c9b30299a2e475c3d90c0e419fae8d07e242eb5400180a1b26f7ad51445143a2279c3313d82915c2228f00399f226a358769b7e3110825b02e9fbfbd61e0bebc292640f0626753ea6c535a823573b0c4b29bddaa52e63d07edc80fdefb238d9edb54e2a2bdbe39c6f280a5242bfaa1bafc3ca1ef2422e5337b7fdd66402ff9a143d8fef52aa06b92b2eb772685544ea3b12282f7c22c486a954146cd53dd74982f0186d44c6c3a131215246805701a0164960340cddbd1302efbfe5c30b08b68fac7b02ba2c8cdcc43a2d196efa045b6b6cd41c4f47e1614d230972e9d3438c0176abc58ca4c3d76a59cba70e48f866143affdc1747ef1dc35dc76713fbd0f2f47c7082ee378002873501f146825560f8a29dcace2d3d1914636001245b11f4478f1f37b3e59d40a7f47a84d1882ac0fda7ada1db483d36e53ce4551294d3f7d2aa70669bd0f0f07b20dc5674126250f217f38aaf6211588df920ab5305928623723f6491d53e999698a7f966e8fb32f9aa90f56a2a71c6f9bf55fa8bc12700dc5a1c39951b4de7343d64d0803f8d4b031929e3f35337634eb1cb362b26c6a64d652a5861683347e4a135f8f5fda65db537cb8141ee772322578327e6e9b7b752bfeeb7a6d82a711297f6372d7488be5c58f087a72ab1547b06f4f5111a1098c0526321fef98a42512d4ed490022a7ffff405d60890c88c62a824675f819f2060191434cb1f709991b232fb0707e0600bcc812201a7d5b87c59f2706915aad3c8c05ef518947de88a51170ed9e44f81de6f81a97f3dc7f4adb1f3999f4c1d3774544be2ce7a27218f3882257922dc932463236675fa0ebda2d7529b866e45db38bff41ef8c0f7c6216ba0e4a413d9d2d2633c0618d9dab5d2ef3e652a9239d7a7b3c10f3bfcc7f0e7f25fcc063866053b83cf36dce1775f4fcd3b0cc218fc7132d06c90a3054ca1e7e52a15d806ebe0845fe5a65a1404401b44aae74247004f214bcb3ea7348a04f808e18ae87882e2c33c587306048f724f945b720a55ce455c864fb41d1f1157d380487ebaf4cfb497b1fe75c6a73fae7a7e95e2ac1d66b568d580c28f8241ebf6e159d327caf434f9a080e497500a92fc7ee707dc274b6a76d9acfcef89dcc1bf0cafdf6125b214cd32c01246f8e3cc1d2adfb7937b5b8d88a580b9c863ede69d8afaed6201ab284590a355dc09b987a08cf17995dcb960c92056a2f3dc2163eaa5d466c0b1164a4ffa2af34917a669285d0e3400f5fc885b77a044293df481eddbe5ac9706df0a3fdbabb7cbdd9bc047d649128fa78383944664d782d082c8a9be0d70fda09eaa73f0805bd7a4cdd62b8c851d59061e28c70e145eb1be88b3b1b4f437cf8a18f7adf975a7d1922637fbe4016d5be88050f64d4a3dd147463623ccb73c9493707cc433f1dc4c67f99afe8a702a17662102db02de9c3aecbb3ea22baeeed1357c20f58b5dc2372f4f67872abc818cbf917866dd485e2a55b26ef7e9c41c8a2031440d97655ef65a6f93012d894058e78c20d31e8cdd5ac49f2fe51b4881e783266aae5340705679777f12a89363497fa7371f91772ea013abe70b90075938a0173d3e7e92a98d039e405dd87f040c3251e61520e848096dc230c2755905d6fb2af81d109653adaf214a2b9ce160abfdcceff27b9a911ccace35d77f7bc17f43a2c8bcd42702da6ebe2c3b8a4fdfe87b08ec38b54b4b3231e4ca352af6c0e4119c8b53bf1b061e93886317a8e0ea7142203485e26cfad3b2005a7578fb4605a0dc2e971ebb414ebc4b1484a07302cf32f2f1a543f8a7d0447bd38c551932c74a0031f120e5450449b39f74eec97d478e45b6c7804fc1a2a3997beb98b167aa118197e0e3e63a8910b789d33429e53debad8a9c8c31b7370d999a393f4c9240490a12daa8aa6b9f1a2fccd2f19be2048c3b27eea2b03941e25e3cc59f41525f78f3374397e57a3ddb5ff2f22134badebaf05a91cf105664c8c5be5c6e86f0e6b903d6a75dfc23420e06179d71488961568950ed3cdba702d96a6c3d94363dcecc4794a86916251b293f4d67492c6e5517887e2738b19be55774bb92a48ebcc57260635d021043e1696d825685e7ecdbcee6696037324e5527071ccd66f0181ddd36bbe76b59bbbf55a737bbd334f97c95a514f50a4aeebfb6f5c68bfbfcdb810c14d66ecd9c3fd80d4a1715c077f1397caf95b72af8f73b0cf0318fc2f6aeedf52deef00dc102fbc1b5248586ac7628d6168b1c2b6ac8f6e99b65bc20061d6bdc5aaa5e79ee6db97d9ea7baa114ebff6842985a88b6120f3c3910804ec9db673446c2e1c32dc79860eb6b95ff50c1f4525a1d7bcc018cb991e77b17de0cb2f73fe838901fb35f05d9803380637725f1cbad0f803361a8e5ece3ec9bb3afc7d860daf61c3b2099964319fe4d32a0e11124a79651644f5ea5511c617b661bf51d643569ffc9e62d5156f3e6e9ca1c26c13e23c50a93e8f7efd695dfe114b13e2ce77ffdc3f785f40e4520b6a873da187322ba22431aa50d899877341086bec7f581c1604807ee03f8c98dbd21238792fa2ec61ddf8f59a9a977b61172156565218e3c3719ce7739062f7317bd2a308a322aa3189050e0093ddd10ff45deacdc3686d5ead09388ae8d7f3215bc6c4cedd49e1b662d4c9b45bac727b9c50fd15b3ca522a5925e66018b8a9e8f75e180ed40549bc403a3c04d44afc87198e11ba451121f527d569b45de39aabf9b6c77a13226b1ab6056264cdd7752ffab9b6b665398ee9ea3fa059ba3bed1687945af7a04aefbc1cf9ff5c759bd6622ada39364ab7b4041a1b2f4bc82308337dbe8e870a10de3eea319e3561839df510a0fc30782c2df493140285928128e9db56001af23b218c294ee6023c0bb2b8e7a3d471e920b30d48a5657b5836257259c3a8ae688bcd65c0b74579be475c783a7dcedc1f660b8296b8255cfa96e291a0098d71e02e5b439e641eea7fbdd5d615a7f0d9b8c172a7dc79f608accb503b9716e2e1085db05e74d8ebe8b0ac5a9064748ebbd171ed0bcce7d5a73f303e5736dfe0923cb5efdfa9c4b0e5d94e34563f4085a38f9c4b899021940b25b620ba3eab995a3e2b1f0c4c9d23eea19ff0d8d0b34fda939d18248fe502626bf17ff56f1dd5bd76c9b4d93035d08cfd860b07d82825bd01718a63cf077887442a30f3a3f2178f38a50aae31330cae4a05f44ec8639a3279fe551cb324a7ac9c92f53a80e99fc33294364499cc1435a1e81a67142fa07b662ba8296399a98d5be54e2d03ff7ad207c4c8d582329418bc339a0426bbafb034f7bad190a1610748561636f42772f68d03b963fbfff9db9d4fb9e3f2ab6f3c41226a0a3d0fb539ed8b75e842f6a7004fc64687a61ba4fab6ce4fa006403f46834c5bf11b703cdf542b6457b152ee472b8ee8d92c0ae8fe381ac55e49b8a28fca4342efb6a1cf4a19628dcc179eebf729f79effa5c26a8800f08cf490cce27bb419ebc2c0d0ecbecdd195678f4930ea567507dc749203109a19f1b7b9e3bb464ed1fd164e6e2ebf6228355170a1a14f8bdf9649d742abd3456fe25b46ffa43db38902e712a669f78206a332965a13ac97efa8a05adc2e42ce19851f3735a1d0dce6917083ef3bff7dd8583268d0b2debfa573b2d098429dbf19c1e38c4fb20f3fbae043c90d659a01c3f42191194f2909620ab3d2ac771703fea13a51f3575a91400236f82351ec1bf48e66fe56b3edcecf3d4522644463c1bc7434088c1200fa92b0bd528a5c2fdb7313366031cf369232dd46aa0c7facc2540cccfb14e7d058a03c0151f85d75e1938b1e5aaf74985e5fdca1eb5758496fb45a671301a49529286066ffb10353a857e8af804e5db21c7ade5a5283bb7ef120f6117b185d787620c727f8f84851bcadbce2ce8667af1024442923dc618ac083fa4229b480c00deab78e140520a8fe079886c719ac347c6f6ae51e8ab7593a61bde6dae7254fecbb82d1d43bdb01de23b5888146bd589237818aa83fd68acbd019f6fe59781ea17d7b876e2ec92832f25dc6e00b47bafe86fe1cb430da440d50fc6c9ba3a8c1f951716236233603c6f8cc8f6985f1148a36eceb069b6679831130c53ebb7f83535ad49d61a676c0f415cd2d1dc5750d86b663cf0772790483d39a7fc42f1a226e343e839c5f23a58766a3cb75cf7ce50210d3242a76dd473171cee9bd4704302fb81bfa5b7601bac14a6b00dba0f1b9f7800d9c20c83547e682345c5706b7dec9defb476d95ea9a052772a781f72fb9936c02561ce42c1dceee68fec217c75eca3c394d61c7c3c070f0c293a5feb8356e4aa73aadf635fe568f9835a5f0a66e4ff0a1b4f506c4bbbf68276855bc6a6a7b6217075a5926c897f2188f43302fcd89736e05abbea87709f3fc1e9380b90ca411b056dd07aa3c461dc4374796383017091da2599179742817c1f4f6fea05ad292430fcafb0ff967ce2a9d64649ca53be54dcbf142295d7bdd597866e949734eb4c6f6bc78e262825b699567838df011375a9f18267bdbb7c2ea7f967c3bb4585bd6d6cfbe0ffc8b021569a4ed0213dbf5e6f6fdaee5551d2e9ddade5f3019811d7ab5aebf16c22591910b6dc9ce98a41cdee6acba6fc1fc4f544ab421a668ddd9ecca1a1b9a3fbc768ddac55eb3802b436f3be14a08f6cc6ca3259d31aafa95250de718a37f2b1cb55d4300fe5701b9864d3aa78d776691b151af67c80969b7ea6dc33d8a4fdc2674e1588676c6aa5f49cfe85f3921dc1e849dd1578507f61921078939a65c1e2bd36a522710bccbd001cf49d5fb7424a627971e28818e6b851123cf853b2f83b52bb10edb432d981b6fe0da366eb5afe595fcccec362a0257a7b81069993a78f648faa9af63ec6b797087174d04508b9ee20e70508ddd007ab864da9f8610d750c0aef0ef3304960d42d91bb02cb176bc841295b7560c380787c41ceab4c652ebe2e858c1184db3f04027ca1b50707da9d9d5ad319dc96760787e3868962845523164be71c0bf51203367b4401a03b66a80ea3334a53bd97a1f47cf33957c25c9428aa9ce5869305eec848294631613e3e455764e9a34d9aa96f7a72e86f5f5ec2bd8edbf2dee97294b002bd4ed29e3edc23593533ef97cabf832bd797e459d5839def673428574fc0f920659e5c7d0e798d1bc35cba3bacca0546ab7b0c54980c44350ae5aa8e6a51a2f325011631be9da56c300629bfa78c048a8bbe35ef5545e51b242b3ab1ccef6c2931ad82bd0b6c55b80fe9233379746c4769e58a404808254ad1c909e9bafe95d55649593649a5181a0b78560621243e6fdbca5d8d0933757e4da59f3f49d2ad188045c96bff3f0760eda1b2f35fc4b2570f293898a97d38cbff611aa65195ade77a039273bfa253ebb2904b8e5b6f4262fe7910c7f3c13215d50a7609ce8c635d8ab764ae7c58b65744223ce9c769a3b265d39b34c590d1867874bc17b30c543711c3444c12b98264c67d1f734d14f631fbddb1af6fe272970c3c617f4389bd34a6c55f245135af8e04e22b9b5979f770a82d1cddf244b6da481a5a71ada0af5aa2b0d4ff39057e5715f709bc74fa229a0b1aa184a75636ab8380815e2e64fabb8ca5d6e554d44bbc434ea6649359843841f36c28c5e87e5df5b825e2922457bea9d27553ee5c7bd73ddd31d9a09389bddd404a9ac2bef92d3fd292398501bd372e1aeffdf4b6d13845b2f4276a1300b6c671a0fded93552e314fbf7ca8572ce86167679e616cd04d2e6d0b1e5f3a5f609e8d94461ae43ae8d7300838558cc0f84a2cbfbe7ef50920bdc95df3e290a891b938adbebf4242a835d16f71bb8e261e6bf0b67b4a3151fa3a8efff2fa03894f8a4039c733ccf367564c548c5a5bb1f8199ffd39426db486bf4480bd6b049f34daf3724f1c5a26ea67ad45868ff7926c97fef852fa2992173f1573b5df088840fc72b62b85e02dfaef0efd5c2d8fda30b709cac2cfcdc666d4a9a1053eb97039684b73b41db56facdc1ffcca538dc0fe71f487c1d2aa3735da90bcae8bd2cb64fde28de56e0c21e7839a118657590dd7c87ecb8e3d2e7511eb731f27ad2a00553299554aa13f302361891a095a4ba293d96bc1e54f05e9de8b7728f6ac894fbff8db6512392a7f908bf804b527a4010674434ae2034789a20320af04f1060b42b86f6bc38158cc7b9e31776628cca2d44090028bf0d8f1e3e500c13a63a322b45a40c625cba4c44de1d394f691e61ee4259857da02fbf71d00f3a0cad15b14d71efbb1540cadca18e178636c2e96fe324fcd50c12be621c30e1212eb3eb6758c01b4e6bf6a213338aa2cb51d9b7a733a9722b832d9fb3f7d0c5dda5ced501d7a7668c79e324f284e3016a74f2aa70d1ac1d2ad3a217130871cbe24525f76567af564b6ddad9a2e3c7ad42f6258df8e45ccebde8bbe0a1406537c836136e641b23ac440a28cf57b4ceef9dbd83e9ad6bdd8787d85af524cd3d279dc5bbfecd7c840ad32c377a87b35c340e6bacfa65ed681ca2b5bd648bfcb11356dc1a5a31f47919ad8af2f33997c025bf446649fcbc1de719481129e39b96fbc09f57ae07c1fd2a715e2a88b087f767ccd161bcb61aef197be83f9ec5906eebb70a4937cf8c462998850dbab81fc3b24f747543054a8dc9c0b60e09ac6f4c8ba1d716c8038fb1553904088213315c96486f01d3ca24ac4106f0b3e92a26a6ae57f0295183b5ecc5dcbfdbcf9e98957ff314d086e916dc2766471e41c3252000b7340ce4f335fd93c168b0c58dc985cbd1aa8f1e087ce620e770b860bcaa393f1ab2a1a2921242eff5e83108c511c61ec6100c2f5c36c02b8058277e8ee5e336b850ce3f6b813915e2edd43f86127f99ba1be36e93624853849cc9d925dee7fba846608bdbb13640a4a4b76231c846701760dfaf7a6f99e8daed3ea0c5690057cb5ee2b0bdc2c6d19239468065ae7f76befac0e13dfb171a934d0dc6430809afa1717f8b9509d6ee9cc259fbc326d49d1ee8237662e4973c8baab4a2010e259e096289154e86636eec6d0268325166daa0f8c121046f980a4ae196f65fb102534e3565c0e2ce9f33d6637495b727af8e545f0d098baa3c96065a33646e16022d6237ebcee59fc138c2eeb0ddb17af1f78243ee77a1ee38fb884778549fdfb561ec215596860fc8c2a844de9f9b00da6f492ded50812941a95be341fda648b928943a841120ab5df0f8b1c7f8ce4829fd4795f2ded88df245184f8b8ca3e057a44f4906b0120afe1ae7dedd76692fd71ee6ad9f2fb7b0ba3e4cf7db5aa9d631ff73510ff31cc03a03f16b3467217b02f9acc9c2711b9952e6a14c3d832bdd1a70061df6b393c284f06aa78b27a24a72b56717ac2b02336b096b432b3edbecf3ed6c6a918c01d3b8740d982bb832f9ed635844bb33749631dd63c2d4005aaac1e41fa402e580e862391a3af2d7feb4445f4d88c719eca0f71147274a14144eb4ce6455e3432547e7c028acbb070472260411394d5e2cbd60124a69a9485c11c7b64e32a949f42da1b108f4218e1dc079419765eae5ddc2a56271b7569e469bb13e7be375a9499aa1099f5081a6c768171dcb00aa8d6eac5b1a81ec89e7976948b3ba0ebd5e48888fd9c29cd8aae7e9305d19b29d3e89ae07d12b279e018ddb62b674fedd7eb412bdd70030a75303ed41a9fbbfbbcd1fd37dfbe3a10003ec287b28cadfb2106f4939ebfdb47eed2935a1bba0e7815bfce8eb0d3d68852ac1c8872203749186df3bf4341b45b1e0703a407d8b0faad6328801c765986d8e4a2bf79019d8639dffa7164c6aac4da8b0da249d7a1c96b1cc506fad71f381137326ea9b956b51422ea3489e0393b9b3374c6dd056ffab801e55fc3ef1d164a2eb796f9c25657a1ccb1fc6a8c798334946a5959100aced5b8b8fedfc1920cd8620001690841d29df43ab686001a441e162915f1a1578329d7bbecb4f29ff5aeca6101ed80fcea8defe2c2f55834a35b1b9dc1a490a30ea86cf581fabf2d10e31cc573c4059cd20b1d1570950c5b4f00d98de5e1286e122fbbe42199e8df5bac077b5e9c3476b2b40263db84ac457ca36edf7d27c001bc7d4a06330c29fcb5d83e1fe8ea68921a0491fbf8e1a57771dd4d06356cb5172ccbe6d94a2c34dda6b8275f3f276afc17a99afe2235c09791b9749387ce7ccf531aa510ee2caf9cc780fae03418b0abdb49ccf8d00bf5a498672f82537c0d7c9bd4ac819b8839144de14c4f0f4b6e6f62c45d5ff817dbeb00e8d65a069978e451dfcd800cb22b22da9f165481b01375709d2d03c6857f6e9f9e291698278aa3d16586d245faadffb53067baa97c0875eca6200ec255a50ff4c759a143335725f780d2ef13f278f5d2b856045d97d302a45adc31855a9dad85022343edbb8d693453158bb97e2a1c1188e6bd0a1fe45ec2b06989fefa65c2d9fc9583113ef79f325179985f52033b8198ef6f717b2e5cac3aba9c384e4b1ea2b4d1731f0a51684710d3476dc9ab2abad0d41bc9e722afb56e6ebda083fff410d6439fb4c67e68866d8292b8f4714fadfc22646fab86f0fd17395ae203559246829452b216444e7b17611d58bfb312cd0cb7e0210810b21b167f3761fb88239749a7011d308f647267fc10feef688074e4316d2b952d8144262d153e1dadc7b1e974a9a5ad89d3878bd469ab8d6fa60ba655ebfe538724240c0227ec95d16ffac5fba5b8849720d38cb34b2ccf20170ad34a57782248400991f742c4b83cf80126f0cb5a97219a186e159cc3d83ffbd1078dd279d0f4ed8a57f5f5bdf49eda212f7b8ffdf9db0fbb504d7ff25849fb08582e16d824d912959aa354772fe01227647be4421bfe86cc3b1e73bb610b312677796ec9bfac653aa03933678e04745740fc1525e7e0c1c1ab9ca493043dd518de85aac9bca77f432e81d4a1e581d351ac44f8d2be212ad28ae75aa02173fedb359867caca6c66f3badd386f9e6d139b253e35a7db93ba8bb5219c592320f3b5b1a8287dad0a1cbd083ec0fb5c726c38c7a5789a7f7bf991dd879a4d9ea7091c1765e5d3b03aec6b1ec8a93f6ed159c6682a5356ba23bb248b320321b3750c18ff2ac480470bac136e775a2636ae18880f0229566ebca09c2396f26129d80ec2dcb3cbcd9c4579a05a3b5dba0657ca8f831ed2ebf50c46bb6672a7b05cecfd8857f573fb2186bd37b4689debce9ee48b483145337fe2d33fa72e9d81d5ce0302567e253e9e96fdc4e6cad36e04dbb3b3aff0c4894f0d41329d24505e81db1aec5954a57fea12e710b38f27a67889e1dd4e3b2906db527f69cf8479a8e2d4d0ec5574212990cfd305bd3794c66d976930d1b2ad31af65c63b8dec1468181088125027c997206955bef7cb22b39128456ce3fec1624ca5fb89f0d1c592fa95a2f8aaeb32d720cd8605a478185e91b761ed312b4b709f7a5e4f68f8807649e1798f812efe6e69c0e23c27da74c015b9f973f76a91a445c85aa81f30071c8373c2794f3da86b92493f43135f057e2b29676c2b9cc6cdac47403d6a7f37fc6056e7e6b23da27398aa6966b9991a31245bd37bc8032fe28ee938b1daf87dda6bc1c7a04709bd576946f939b902a89f402a0e1b83e40574349d694b9a1812debbfb9401ebecf08445b11c664178a9209f428b5547ceb37eea53420ebb28e3f048771926c277accbae0b42d3b586f31015bb6a0bcf1d50dfe1497b52b905344eeb1090f675c82e9bf89cc3047b05abb14f9b1d1b1939c809e09621411b13d59dd28074b7a0ddd505a70f764e7900dcea759bc26d852b4aa88a9e8f029fba31c70ff1fec15409944eed271e1762ff9113fee914ca6f1cf9ac6bfacdf689b5def7dcdf1b254175ebcbad2b07e50deb68b9e7d1359b3cfe3ab2471136d57e76264b6de35f9bf37205eb11e3bd392116e6d4734c815c4048542001e69d0859e5d893ed965f17c4a8813ef748d88f58afc17dc9326993cc656d01cfbd9d0fe6f9a7993a1bba739b6277538e7d4df33045eb7f1cfffc324942ba9e7b464060080d0665263d22881fb614a4b46f35992cc6f23f121cdd2b21a1650e066877ab4f6a867d2d68b7798d914c34604b54fdb429d9911d38725159cc6efcbe60a95154bc806e62039d14b790856f1b83ae7e60de79e9f0f178b26584b8f4770c3883697040a16cb20ebcefc34d048fadb27ba70b506a10c142ac3d4b892e27301c213918db1b1dcdec1c210ce6391923497bb7e78d2a3ab9ebfaff7d70a885231907d9f1c0fbc63bb104e813be4952187c75fe0f2d41a45f4ec44316cb2425ebb5dbe8754d5a6f9ff8742527dde81e783a8f1a61140ace48339ba3bcd91663c333e64f80a3c97beb26b6b1c8def80e2e1b294d1e04f77b7a204d7ab3554845aab00aeb6840425672b7d52301ea650bbcbe1c850691b8c4fc5877eb1b2ce3111c69e586c5368556f3a0cee51560a4fab0392bb67503510b105c141f0b3a27329384b4c61937be1d9c642f2ba6daca03785cbdaa09e1fcece8b710bd195d174a0569a29a3e6008e57396967c1da2a3c885e31f1e0085814dbbde216eec1c1fb28c0912a51638ba427f6c814ce180a2dd1a64826662be9e1c29a0eaf5ef58c16a88617d82a22a8004882d1bf7aba03d06b7c18c2426d2aaaa3572f82c86e78e9db1917d53d249f7acf91de3e48b1cecdca4987fcb22fcb0fe4d328eef520766e820f7bc42a152700913c97a32888ffd8ca6f484bd3db1518820df4a2b94e4ebba992c2b5bc3a98b29f5a71c8864e611bc37592c96df4db7a5b29948ba6e5120daeb2e9ada774a1e312a6e88e212c475f6d34386357f8253a216c4326a044cd4f5bdb3b1ee5b50f82c9eeb4a3936104d812f46cff9881ad068162a9c9dddc267e89ebf95d544a2cd3ed107f9faa74119f614bd771333c42792c50a6e5b71d8371a51adbce313468727e235ce9d78ca416915db5f7e4050984fc4a88a2f460a6e9dc55f6fdaaa8424fd4cb74e2e591853222929cbc40d11b87e4f765cf3b97dbf14a954d94339c22c4b030f783d96accff6dcf3c1719b2ab6cec9e0687915b537e6b4c483a98eb67bdf5d345c77cc918e289fc19ae060db9a9c23dba68f7126f0cf50937dabd07fd3155ad82b386b3c06f1e40899ce4f9694351a9be3e092e2fa6de28f5fc29275db3d749d7f134d0a5f0599a57a060c7dfa6afe25f319f4b4cceab6fb512d0f4489c964dfc2fba4b6976ba9fe266eb8db98e5d1ca933c8004b4289eec0e3d738dec4ef4004994c774cc085e381037e9d6de629cf864d6be17319d5b271dd7772ec18aa071bd1292e7ac2e954340414cf54e2c51c4ddb5d6425a01aa629e85874899962a31d0d3c62ee48f68455dc10043f81189d91c60ab9b627dbba5ca1847fadf9365971e40350eb1f78749875319efc64d13e6e7ff075a768b3dd34dbca45b4661b01fa001a0e2cac57435ef0f729668ab3bf31b2e4580ac51c1497e58cb532e61db4cf1a1be9596166004022eb5b0c88b459634f510600596ba1e23b7d291b105f208f9c06c1ca51e4f226d0127416329226927c95f5eee644cc32d60c092c36c245429d39cbdf69ac5cc588ad4ee18b11b3a8149e699ac5d7fcbe4461564a6234f5d6bef443226f259049ac72f9d2278e600150ba2b9d1b74176029399feb4ba77db311ab3c93111544f29888d0bd982ee3bb435ab98f45fcc1db39d91e13a43075dbaf28ce79ccb8ad7ddaf81d4cbaecb831b91c915ede7871a566a66fe241b03f3d067eefa3c06e3b2f8c6843510c7bfe5868bc3c3b4311a75c688c854a07926db71c8f746f5b8eed0441dc26a3ca23745cf3573980b7f8e5f4676c367fd6d211568544a2c4e5c74c6352a2ad6b421551cb2812755e76702a4c916d9f0792405c5accc980f994a35d7a8533a01629babd19b14ea89ecb49ffdcd06b1aa6ebee01b426e0f297c96c54af816cb4388dfe4179660e11a7a7cda03fc72f28c2347a643b47f26b0b89e1f19b4aa5fb4d447ae6b72348ed84edeea989ba9b0a38b76567ced627b58b01bc6002a1cbb2544cbf4db2975f47a88fe2efce81ffcbbfa1af684c829dd732b5bb473ca1917357f038afc53d9e5d3c78cc747786a97591b6915f72935b281cf584eb1da3bdd8574cb3d957ac88abb27b0a8779aa9c62cbe7e9c13521dd8155d03972d0e5a4326ea1b696739d4edc7f7e357adce44f9afa3be4d4e5007a990acc175c03514799fe53a58dfd66021f29bccfd21d7a2b7074c094f2c6a1b338492df608f9c518ba0bbe475867c94d496b35e0f14c20bc3f4bdfaa1cd1243804a94a52021893097c689cca0457b80074c84e46f761f99b2e26ea7c771fafaf63a7b00b08117ff6ceb37aad34045e65abc0c9b6c411fe8c1ff45f194fc1710bfbce5074dac2d8fd4b0bb28dfcc673eea82fe239f5107fa2438b86006026d367ee1668c78e037591aa7ddaf5e617d9c43b33a6a80319771fcd3b157b731cf8f6f834517415f51129e8cd60f35e82005d3d8aa12d4ffba5f0d9bbbec63ab797e2bebb0d22880cd147507cddfe69e2c7b351f5e21b6519c24552908fa0250cd5d3358de8b1e2381ea04f1575e4648995408fcf489eabdfd5af6945578e347f576035a237fa4f6b0a65052616c93f3a6457032d0a9f0d0cb00777733fc3c2f2892b3870ac4c2a303c8ce913eeaeaaae62534b2a45701f0ddf82577b3fc3f2b7d5e81112c09ca5d392a3348db57f2e6616428161d7403d63a6defcedbfe1b3ef5eeb4ce09640c3b64cda44bd0e15b5be82defd1e2919026333a8e06aff9289bf512c36be8cfb2751aade2fb2bb5a37ce21234cdb54d0de9c08179886815fa546569e37d40f1dae2aa7db07612fe1583f3fd4e17f628bf9cbf761e4169f5f92b70640bab461c75f04d9a3baa5fa36ee278d0458244ca1d5502b1ac9b75fcb555f046a95a9ffaa6e95b44b6282052f297298480f21bc5ba1708945e2e73577a8b161da57062aea7a61df3df9ee372eb386c739bc8b558553d199be34544271dad6a7dec40e6f51f17f50c33b966de2d04fbd7dd1f05172f9d748b7cb1f5bfdee1522d2371c011ab9bac6a29ee61e006bed917e9c0f7fb6e06b193c8a38887856016c7afd0bbcb3bba35704a869e165b5d42f310e492cae148b37d35dc1fa8111882020e48ae80ebb80686e4f19666502021ba445343c7e93594afaf271621960b441e676f4760bab9b5e427742c4a10b62cff87a42f9eb15ff69f86dd8def4bbaa15e118751a4173a401031552ec6db2c488b615212d9b21e2131b83a673ecfd1676de02b3f31d69d72077279d0db3c2963351c7208e6698860fd066d8980764f53d5ea56db0dad51952ab6e1ff80f88bca9c29b9a4a76967aa04172eee43f2bb104aace1efd0333641d89103c269c5beb73a5480f76f8ce6495e364e6bb70a3119c79b7c9fda2662365bacf32762da24fa1477c3945a6001ff290108f0d925c5e011c53d0f189491b96a79d3a41bd2439fa77e42fd2819c97227c8b27238f7592ce3f05f9c99c47c85266b7ab73df32480705f85d779d1639c5da9be97f39280505dd4ebd1811802e42b568e36b0e90a35d01577aba3ff22407573e111c39410d72d97e066383ae9e788c0adb0905f85b7bbd5261fe66029b556d98b6eb747867b418a0841ebe911f2d39c52b87d5d260dbf8793340c78bc716fe02188d524e8aeff3726b4c5dd784990332bf08362be0ef5c85074c3f26d77121e9dd69b4440446ff7febd7f0b8971c34d36c3e8c96154b51deb29047f8f84ba28a289d1f91c79d8efb0cfe51de4dbff1281d56aa4261ff6e83704fef1eee02b75f0bc7c2cb1c12f3504b4159a32411b81ba981b8b069c7473f29d8c86e39eb607e3788a80897e51e4e2f3f80721e27b64a5917e3126ff82aa3a66dd2b823983c0319a92daa57cde01098a2673a0c2d2a83d99e03eaec893efa96a162cef98dd226f38045eb2effa246605089c27d38b67607754d86718e158236d84583a22fd65853dcc783d5287525c3ffe76f61448d79e1dcea0a71ff2c3acd458370d7f828e6f91c212cabed7c94f743257ca2345669629c8f727ae7f779d9476f3544192c0f52103eb09c6c2209b27f460f514d770bc8d216b93ef6edbb1e3e1efe1ace04f83c846e83211975160538fc1c916b5c5e4e0c313b8e20e3c3197ea77ded656f6ce8714e0fc2ecc5504eca9edcdf720abc3532e1c727a2715b91708c9140795b8927f8196a2882fe8eb4966f5c48a01d7401894a187f0490a9aead3098dedf699966ce8d4542ab88aab57f0f7e8bce8fd96f83a31f111244cca4f196d3e68b188b4c6c2d692cf8fcfbbe4def6994cf579931ac7961990444d4ff0f42e91bc0d7e760beb7aa90bf0820503265794eeee0cd5294c2eb26f257535dcab3f6e6fd0bfba52c19199d46b0f674a6501cbb8bfcb8da08c1c6e6b2c41330f4a84204a778b9338dd0a565233e7318a4fd5e0c9fbdc184fc1cd183b6d67caa38497a3b48a9a46d4980456b5514962ef8ec65198d9b099edfc43583fe013b7082e2600690a1fb272fb30b845e064ab28c7f6291044a334e8c511df06342da4291910c23e2147e8e71e5ec5493515a0db0ebd42f679e1959888da834f9528bca53074a391528584fa71bfc19d9afa23f9fcc268a2fd427298c0776b35221736f992bbf7b5887bb41e913cf164d06947a14eef4dd4943b3a175a2751a403317e94134e8214f9b95cf4af9b6e640c149ebfb8754732b1df747a5eacc2ade1326fa2eb6c94a3798466ebf2b86e45bb3eaf9d2432a2bb545eef46ed65d6b128c7fc42149fdc62f39638c949676a56194b9fb1444776b29d35dbbe81b1c97f62e7363930a30061764daacf93708f11b1a4b008b513b0d4bc4c7bb1d3123465195d407e45ba10b6c4e962a67ba4899e18ce9528cf6f346586d20ceccbc368a1a9f0a1e3fa575a49a91a50506babd3cbc49927cc22a2254c07710ac53a7db7069e5913d4f5fd0a4c5beee716f662b21de25ed36a4731a01deffe66df9f1848318537385d3816acb9adc9d63698be68a8769c370c06a1b201de1f5c9532cbe58dbe011ddf51e64c3f34a14ee007bb94c6e3d4b1fa505d2de8e51b375746c1cd3c53644990a662f987a39a81578ffe860d80edbe44903ba1b98016f983c56470fd699573a2885b5fd80307cf25ad9f5c93d928bf1e8eeb3f02de5be7e154f21615e8cf99321887f41c12ac09f50de814d8765bdef80df51056c1d97ea20e4d78e7aae5d8e2c4179832321e200000a02a36b7f6a8c5acf4549a850788027f627d6dd717bd8f7c26382c2c4f502a7616f022d0fd94d21f3b002835fd6fe8eba17ec4c743d5472c586995202040015817f01310985ed1ef6b4666c5b7ded62396846aba652618bef46b7c25d87970f082885a9c43bbf6da12989da6a396c7f63c0b970128735964a127bc688f9b62a554299ee7ae21c09f2d453f9c7d02b16db2e948c7ab83921d11688ee312fac8c794778a531241a51b41b2cee03972dcb3c1b8c4172748cc8949f21c7bc0672c7c3d22227eab14775ae4f0fa902cbb92a6e8f0377caa9c8cfe7ff600256200ca82fed0b4e8b5a7b4103092295e3ec595c33c1496a8658092c5126390bfa1db2597c8909806e6ecb48e3424ae07ae479da247658be3343eb08e16ba0f6569b1c46c1624afe7ac862b2f83e028e7ec1b65f488b3c942e14c7a4a448f9bd1b6d799ebbe63d0a8dbe90412d7fc9d66f5c406e99e68278ade989c8ef58824efa935499f61cce04793aef39d3f6034788cf41e409465e99dbd6e91b8a4ea6864ea5a3d7c158e98984bfa43a763bf582ad295b55665cb94d79e24eb5bf597339b886055b7228fcfbf202dcd79ccce5a2f3c18d7a53827bedb9e93dd24843d874ba759c508fdab8756585c6a48e041882b0af8a727f91ae2c5efafee9d5cdd781724eca1ee96d7aabaaaff246f9f6b496e1c424adde601f2d2c4b9273d947b3ccd35e663f92cddcf72f0bc8509b065ff87347c1729529023e7ba88bc38a98013bf843a70029f827bfb4a573867417a07e11c5b26c92c5070821343ee387848522addecc6745905874da20446707fedd46eb3fef290b16b7ffb35a001b80ea130d7589e12d8354f6d3b399270d41bfc94ae4ac525b8f0fd33c4d3e24486b253d7464b70a5cf432e3bb811dc1466d58580fe786eba1155660a0f056bc2fce3585b0e48b08a4c4384a53e79e1b60e23f5cece0ed70d30a727a0f00911af04bc260f848e08a1bf4b574dcae620c7fd30aef68ac8fd54619f23d21bcdc4ead33448bf0db0fd52d61a1bac5c3e3c16cf94e75e95d7562ea8f8e37281672b9e3c8d1fcfe2b982b587890435d7d20e63607f396712a7346927c4f2866afd307177e5e1f9090f84076ecaeb16378f7124ac976b42574fc04a9da7dabb0171407d83c40aeff9a7a9c171b7fbd39c07ed4628a4cc39cb13fab87f7423b23b5769f525a92d63012d2e93e3845c35ee51c44bcecf5f3934491033e50fde5d23d9a7aab7961b60d5fe8f03d91afc0a913d62cf0a737b990c76c8e5cf63f4b2e8bcc42002a1af467b047f7ec6d4679c1403f49e74bc46eb1a777234da6203a092a49f3d172b69a2b1837483b6632489096b9c8c041e77199c0d7db6a74a5e4d257326334874c8f38e111afb43170ba3eef8d78bfe6f1d9162184d5797475628b2832d29f18e01be1f19c5fda9e25b067961e33e956d816ebb31efe622923b503ec1cdec44de4c888b9a8b5ca504991b9ed2ecfaa4f05ddf2858bd062c096e5be683070ea74096acd09902f61889e9a9fd4a8d41e54843b72778538ea08d2a8dad0660cd5bf3c7ba31b5057247c2a2063ee47a7c09a58763326a9b1c7f1116b7c064a233bd7d5deb6f8e7d022d20428eb6b1b2b5a880b59dd2d9543ea36bf4db36cc285314cb6e644a02866f9bfd4f629bb6ab480c24bbb2768c44bd218382d8a3961c2a9f37d9a7ef0befe162637fe61cf7a2a370bac1a7e09b05f6f501f97c4cb6c7c4cc232c70e1a62f77360916897bbb2d1a955f20ea61ed405159c18f436aa900de1facc3b889e82adf89c7848a7eecf157df75d5942865ab43bedd6b20d46f1a1c0976225244cca7214cbfa6239012a2c262707f83bcc027a719e2f92be0a0547d2d6e7970049616f1118fed2023ae5a60711c34afa177a59a71830996feb2e9ea382d0e3cbe216679de399c0e1d99a4fe93b462972e73e2fd62d02d460a02e076f1f279aa361323e54c1c28d64a35fe9148b173533e9fc90b434143203f228be6b292cdfd55aa4340444968b5fe76545fc6f1ecb7919abf8c33cb33b308c1612b6a3b2820c99d86ce1d772ab3d18f01ab93fb559a254b7df5312e3ac23555f3c475c8552a70cc95f87d72f51e364e6426f103d7d16b8ef817eb424117c5d643394f09b86da212e572c58fc7041ce01dc9e7a14dfd2a248f18a589b685633c271f47f5165fc46eb7f669b2708f229aa17698d66481bf3852749db13fba0af2fa2cadad48a21213e5aca5685538392395c7946afdf086dfd3817c16bb56fc1ff9d248cf4b4e0f013552a2e9b08d54a6966dc165aab648cd8d273cbd44ecdabf8beddd7ac602934de1cd014bb307c7d6c4c15583485febce8a2e6ac4a722f4d2aa80015767039e5fa60f0e5638c5eb853bb049128f9fa1cc278d9662cdf63d5885e1911f6194d28727087171a99d0a45b493f6f73118b5ed794137496e04a27fe27c4be41a4d1fed970e90e5fcc084086d2740a3875001329f309c7b06cb9f36757dc61fba5b98bbad0de4843f0db8e56887e74dd722434ccce8f191010e5afa5af34c9a1c0c8c4f5ec40dad0339335b0cd50612a4a7edec4ccda5640f6d5f548f699b28e9d8d9e2acb177488b25927a29a29c6ca056c785d4cbb167e10d9992a50fabdde15d9de22971e0f4c6125064903be9449c4c84a9f8607b5b547d425103425f9153e8a93ba8c97347d51fd9b2650e9ffdd7858c197797b0e6630dc5761dbd2c0b7a206e74de7072f98a63dc5767478750ed0e8e9cf41420378992d84a5d217b273dc6ac5dc5f675e97563ef4a17a48edc5545faace434f6b35d5c51ca7cd2c0652dccac0643afd5013fe2f2257874edc2384382300c9b1d8bf5f75db26a6ddcb8c00da25c5f45115d469347445e21925305d5edfc362b611eed7660a9a39111d6269119b171c3a21ba102b91802f133879ffbbe99f8b78d5ce14cc5125f15f2777a4c445f2e3d982589c43887057241c80b9250cf4d3d68c5cb3ca7901264938bc9cd4413ac60a1e5286e52b5a3025a7baa3042dc9fb9fd295387f256ea4b4f126d567209f665420dab8ec26ffa58ccc540e70434dc4c84274e3b08cf9fc78061819e69700498e44f51fd6f6daf807f08fa332cf6f1ab1067287e3853492529552b8fb4f31a1eb6f024cb175d76c79f2bde0374ccf3534fbf5e5dcd76769e223d0ff3ca9cf98ed68fdcee4889bf67af76991a973e0c073cc91e0274b6535091538c2fd0e6f01706dd6f48168960f6294ebdc6d2fe67dfbcf0482271eede2e4b0b702fece90d794a5ec5bac327645683956f641da224448a5b862fd2e48203f9dd4c44e8f794322ec9393ee1ff61316e452876db05bf474fa5afda0064cf043120e9817d1c5d2dbf92dcd12b7f456d6f05a1fef9977174112e9ccfda8b97b5aeb4428f491940f2918791dbb628f3727763f0f05259e766e899fd27258fb598a27fd160ad70a2cd84f5074ab467a6ddfb10a39bdcdb103b5a2f3b28b4ed5e425ca10eb0eb9e3ba8f46840528206ba44a2fc68de5ded4a32ab2cfd20bd78e6bd90850575d9f689bcac99e0b51023c6448845b9b113d6a051f9b9b4953f1cf2bcdae0ab59d1600dbb9c2bc37917ef471a3fbf190c97d6454a0089700292123bba1b68ac6080ed434b55aed65fa48e525d55ff799f936b9632b26819e5a713e79d6fa8fbb5c34e9150121630b33d222c5403d8aafe2ca8549e5f7b2f1fb5ac2f8a7bc59d17e8f6d13eddc64324c0e1eb74b88e3265860a7519cd4b64b7710acfb119548a3d61bf369c78c9ff2d3bafef553c676a1d12241ab056ef5553d2b5dd2b921a3eb42d3dd40603a3e12f0b54707b7f7b2c627f0038938d9b3dfad093739074cdce5bbd13ca79f92b7b2b2dc0f60630af52f735b4837e41860cd17d1c44aae9a2aeca18c51a12c28aef98249091243b92381be52ec95e56e65d0c99163825bdc0d5ae6b7a314a6369407c53764940377370ce1705c64947f9639598e1c761d0e3a5fb168ab11d7fa7b59d30edb2c101cb72a5a3b86b4382d9eb8021e9d924c7dbb19d3ece1c917ea02f1d905d2e0cd1bf772b8a61a71722871fb49a99c6faf4a934414f7c7005112161d48c11aef7f70937e7443752210690cdb80226d1a62dc338e7c89744cb593373afbb13d75f20f2663e89f580f6f2dce265f835e88173bf109e4ab27207f0243ce612d40188744ac88d7eec9f98caedfc9b799a5e6028dd5e24c4f6773dce2057295fb46607ea221fb59592f208bec4e6dd9f480d46aa0c10c01352f32e30b202a5736255bc70e61186f87dbf48f7696b8f7491e33660ed8bc4297b028a98fc3f8ae3baa0237285d9156dd45f50d59f7423ed60af1338232127742fd6c12f032d836904cf4d47f8d3e9716d501fc27c4de224f1d43bc13940e26a4f9190c9ac7c8eb437381ce45e2b32e0b5e3e76b843ea062d5e567d8fdd998362316892dba9d07461ff9f6d923a5763fb09eb5aa48c57d3f8062b084254cceec9b44284b6b6655edde675cd6dbb98a23342bcca3f9df218f49b4b7db7fda3ad5274cf59c8887bd621ebff2b3d00526cc59e03f10ff1f8ac1f88813c52602b4e7c56c68ae883b23f8f9d0df2c20646c33e134f67074c016fd4fd21caded440caef8d17e538d5ebf860afec617a3af32e84983cf0fe9d60e17f831d2aac0b7b3755baf146087ee1177f40d6ed262c37067a074ec3ff237e35e3179e6e5c25834c2a2e14dcb6062c5023703a5ee6638e41c68b24f8685dc13b416b75732ae945a54909b3f677fc9b51b996ebc852a0ee7d7ec70643abf4d914011efb648d596db41f20900bf9f812a263db4e8036e09fca053984254c6f97a7a3a51aa849d907c7105140632af973aea4b874ba19f97c2bfd08a5017eae942a647853d9434a294e01973cb9fc3bf916d30a8476d4f1bb340b10a20c719ac32e62a5abfc4202defa58ac1a034f727acb0286515ad0bffa59ca5587ff2ad8c963e04b556ae3c33dac60396d6f27435a72b98dbf09a7c55cff31d95e930bc0a983605b94c30a1ce41d88c5c399025ffea9cd8e234657176dd0dc6a44fbc40f40abb39e9297127b889f18856e6f7ac1cf79c215bdc28950e6a15147aa2aa3bb2be187e378d96a18c4a8c53fe7c391912c9f23340f7dd4b6908d1e0c0c254de6b70a69d46ea76f1f6e9229115359c1f4f8f65f6d3d0f9a2ea32b4e074f4dda2933cdac52ead5168c624c9ddeaf8b32cc8e6e7722875b143cff560c5f5c327012c39f84f744b374e0c2dd6f748b18cdb94fdf5815ba70f6543a41bd81c0d49fe7a4c50ff38382351773241d118ba8a7947203025d64340ee290e5dfb3ebb6a2cdb74397b8d227b489105a9bfa9562f07d80895a65e50a64d0d8749eab42a35463e7f858b6d87ea3cbd7baa39ad5faa20bd917aae5cf590f3ce41ced331bbb7e1e54754b8c303a86256090d2fad45e9ecae41127897befd862983a199d420b7f97bee10d4bb73af87ddf63926ab90dc70bf90468ff453019902eb1d403bda6ea33515b83970955132bcb3d43d74529fdcf074c903a7343cd010c260850da8ad6b8f07b5b1bdcf04443435b73deef60f0299367376f4865e01ce039b015759baea6971c914fd2fe77682f2b77f12fa41d5b8788ea39eddbf773b2c6e6e2e5274b1aad42b395dd8a995160598bfe92e0e574ccc87f2751d87fa2804bfd270972ab17672c3538fd6def5355317eb71821e6cdbd06dff113c415736ebe32cb2d3188aee3d6c5d71e047a1fea15abb927b7f9454d229acf4e0970460308e1495371a911e7054045dd45a5daacb56b86ccc9fd1d9e30031b2849d78b8c7a78c0d8357845e213e4ac2499cffee19161c4079225274c309fedd63fc6ad22ff18358bff973cba827520f4f42be6ef93e422dfd0739002183f6bda2339a21893e92a890f64c054510a5f8fc477d9be4c49425d8c66743522f51e0865a4303f258127efe2ea8b06fe0f8345d0c9cb5e7f139c3d4d6561b538fcb4243dfec5bf5514521717b3a4659be22776d276b46d3a5a2dfcf5244a2ad5321a8aa44a2234f33977f1defcd06581c34100354d6cb5f12d5e7f8e39b73243433b190cf9b81e1b6f5d2fd6f63085f6ef4d4b8c0d58024ec0c8c5ded1109fe86e5ff8b34524a0cb5adf916a52ea30113f2b98e17f7ec3600fba7e3312eb014f028b16f244e73122bed59c46a33734788bb32637158e32f2e64fce7ad9c0db20dbd0990232b6187f2dee08adcfc3f042d1a55495286b59e84fa4f3aed3b94a7994f1eb85c193a20de768526ac947194754879a0ba5c6b6d6b087d6bd24e036c86807902bc84812278c9451707444768a400efac264c94448de20a7414afc27a264af11b1c83da73510d1148a1fcc59f092d5e68f9e1b3fed85f8b6cbf86f4c999283b3e608b2bdbca01d62cb14d3eff0405e53c34b4aac7eefcd5fd2db1e9df6ca9c955270b6e0db5fd6e827e7c7a7e645341aeca50891dfb8c5aa193a01e9ab936bd59d5bc4c3e1f3c2ea741072c2488d15f3467521b278b6c3ddf642b283805ca300d1b4ed0e4091bdb7b933329d75d83452ce9ebcab3da2919cda8fd8929b6331bab252a961968718b6c2aad9502098e35d5224a01b33ebb2b4136ba1da0e5701eb26bd1b1a669bb0901f6d547f3df59bc554b022d894d18adac593484b15d07f7f31c5f7315ea612a4f2a0d78e44a4775b1219550ace2290f952cfdc32c422aad405f02f84812cc29f49085a975351e03c18180d295e70e5e0b9d9ad68634a13e736663e49ae43bdb66c0ff112be9f3c43c5bab1a42c6b34786598ddf21238f94817834fc5ede88467959b71920a358995b33d5309b84278a5b94bf8263e6beda509df084b934ac0ef082bde16ff90260bbfb0d10a88c30c6102444105bf35a8857c9e1c77905a434e7ea0ca3548b097752b45e890ebec6f0073a8aea67cbc9941fe7591cb999cd4e09b3cb4cdaf0c1a6f40e1d1d2341a8e46fa351daea7a3eb32f3a8c82bc2315ef468beaa0f6fc8706d28bfa7eb06372716bac175895eeef82c16f48cac47323b8882a93872152dbad02751390dcd61cdd03428c32259335406366e31a50822139957c15e4eb3727d790dce76cc3cd2cd83c93087000e8c578c9f5ed4a8d85d69830ca537f453180415e9470a4a0d4ba905083a232e78c9b3d59aed67b6b7c86e6c1ec6c14a51a8db748609446d545cb0f22350228a61545306b50e7f03193d26537f466ce53a87652c7a5827fc9b6a370554d2dc13efd082eb6006497154ee1d5ae7b9656bd2d4d01988611ab321f381c3ebb9604e5c288d722feb631e33e91d0c09960764388148e110dd9f89b42ab9d7a591642eb87d79c74c6e293bf30f179bfa69da4352bd36dba6683515f693d7cc4095fa5c4f137a0519e5901a5b291f7d794df1041bacb9cda52618608e89fb252597f6ab9d55044a6d3f70bbd1a5a27958a0dcb88b70ad3d1cff2e4fcd687fc7490134e7698a3c16024973b12a88840c80f4430edc37c43e0b447da12cd79ebb0803c25a35023fb6c498ada02bdcb631f27d908ea10ced5b3ddfd492b308df5146e6bc43a39cd20644249a1a2cb244f2baec64909c4f1d468b69f94e8b69f811b18ceba623bac0231224aeb6067fe732d81193bb82c8010f09bfb4eb80f9395f184196b5033f50485bce9fde2a7985295eecceb908b46c435491a3f4a4dadb9bda27d8a94ed65a7bed7ac2a39d0298526931e9556d5f740f10a1e6d332913d0377c726be8bbdcf357e765f47d2dc5911c2faaffe90317df7d7aae6cfc60990a6108f51a6f8f638c639d2ef29560647888a62400c97f55f59f9453588d301eadd7b42047303602f776db950eb308e274280676db4a5bf3c00ae7fe07ac5b80313a60ac6d195a8dff2ef1e62e3f11ac6e9e6a3d38ee8859bfb00e63faa7502aa2c1a5a1d93ff3ec723712288c52e5942e98ee2a39992c4741bf89ebd9e416f52341a32061eaecc73800f344aba99b2b1554a70d6b95e3547e9426b2f371dfdaf28848e3b1ac7c465fd1a419aa55ff89525dccdf70c7f9e285ee713ef9c61674aeee2f1000c3edccbf73f024ecf60fb517f32f0729421dd25b6413c955c4c1c79617b8fdd4a0f01d24d230c344e817ad981b3926f307e8a7eaca5b09e07cbe9ffbbd21a7e9416c3bb44e23aaa03aad061708252d76e6c30f06f69bfd3f40a97412e97063a1a7fb69c2fda65edfd72db034a38dcefed972d89146ce4672b77a2804bb160b2d64fa7430a309782c892a3686135f122a5b344b35dfdbffce199c0121682ba041735122c724a435b589509d17681c5327176bafda658d6df10aad964db2d99e651fbd9767841c829472abe762ccd6f8a7a07420b12518bcaae4e492dd8fb637db6d736df459ffa6cef5e92cb4c80d25d5f93cae0fd1c5f128f95436918bfb9779722b07b7a444618a4ee3217a691d2a615a935532aa2534a85d7236c0d71f20e4f3c73bed2ea4b40db93787d99fca96c7e4cd052a7ca0ca59e4f6e32c4ab002b5b0bc57715b0c1455689b152699174cef39152a0c271fe0517da9dc58af6c8265a86dc04acba01d2d066326202860f74ce7365f07d1a0a4ceb96091daa5ef6c3110bfc7867fe7ff0bf6ee6d2fb611f75a4ea5529c9bb05daac2243aa46d690850fd8e49555c84cc18c326e5d29d9d00a1be212be4341fcfa55b075e0d5d2695fe7d0f9e20c6d0c2f05e61a3e6db5ad09ee8f7624fb6d77fcab4512420184fdeaf02989f81a7380969fc2cfc83ca5a121ea86434f18b8f0fd44349818bf99a83dbb9b08f479709b3a943b54965ea0ac46e31a0dfbef4184e0e43125c0f7a3671b0873e1d8db69819c7ec4ade11cd56783cbda6d1a1eaeb0f7d80bae6c17fed7b7fe37ee9d27a6c0227b004deb44b433591c118bb0957b9e1b9f473562d3c29b68d9d19230c4dce3c83ca02615b65b8927cc0daac8672de13527cac1f5f96afe70d0b99e3b8703ab8bd1286aa240dc0401896b53079a768af700c9f18ad956f1e0b9d44341f52fb75364d4e84fd52997b592861d934d797d2c5224f2a347308a1fccd1594df9a61de0aa52344af15603edad57441ff27d74d768f985f9bbbf904f333f85a5138ae1a6548fb9ab47b9ac218f07e196900034c713fd0589007d2b8b68ce1f4b5596a89c508648886647da4126e984e11b5d00822c8e79d66e3372f81fe47f0de6f6a17202df6c8d6884aa4cdf0bffd2043ede602fff36f792a86af11676856332db91c52d3771a504ddd9521398c4b931ac727392725e53c9361def36dcf6959e22a750a9970ab9affd2b2b802bca84c96d8863f4be887f99eb44b0716c434e38d90ff6a9a0aac1d5efceb347c86c8a87c8ab1730b8404e2545a38c6d5e25dd92d6f4baca71ce8a662386adea23b390a5ae6852520ae12a91873504f6b000e25be013696ce19394026387fc14f4b994d95da56de9ad06ea19b18f421bbf368b492ffefed2de37af85cbd8cb472fc5c436f2c1a365881124dfb39d93d33f7f19a034188f5950879357e5932421318d9f6757208a84326c3987ec310f45b1b25063aba04c93662f08738c44a9ea4ed2c327a9927d8f4d41d6a750091168073bb815a192ece3c3b6d405fb58740e731a26398b696e7fa11937967a4d5964612427a4e05a04700a74e76de78ab5975527da2cc9b9b814f9d54f3d326eca6dc937fa5196d3eeb99b2679f3444df5b1c44a1f9393d9f3da61065e13a1a0ef320944a13b3267217a1de6bd2b07cf0f327397c26ad50881cd59e7c434ee455f3288ef08500f1cf96ed27bcb4bc742d0db910c35d399d87282861cd8b6e81068db25c983c4eb3495a5eba09ce355db0bfe1bf7f124703e6c1c3612b21989dbe40f53a9df5ccac3ec6b7ce83c86eb202b78e36d54d3d1b89612f136c5484d8152d9a1b65a3cede6807979592f42c1c1a3b5c6576ed5241a8e75221b26e128ee5e1e256fd3d3f9d857de62ebb546a16633f77ddbc54a7a7fc31710fb177ed6426bea9ccc6c8ef41240725bc9e3533f525c016678f0091f57b98af845d3015ad9e9d560a1cda005c8f457230515226be63a7caf871eff104e7ccba491b073e408fa8d73b75b7ffc61d85feafa6bc591a06ed777633a39a8c78887a9903232f3a402f7c39ae709e509bc0162d9e2b58c14d986e8be566e7c8a0adba80bc6954e8079fa3ec0d7836e1f7cd5f9b515c030222becd0c598274038eaaf61d06d2c204413f34e23af60a8e782b1f161e1259994199770f2c7d5cde58a31dca06417f1b60f5dea0bf3d00e1ee68f915f1616de3974adb8f1090e269e8d3356ee9cca7699a750168eaa66ac2a1c9bfc9a82383ec886923ca55728d9ba06d9696a51eb31369162e2def3f30261956ed61edd9b37ac1ac65aeb543983b65bb688ecf4c0e5fa9dfcb020261390800870d1eef6c319f89ecfa19fbee4b8ce42dd73acf489ed0c0bef53e31965c271e746c7129e2d15c29375eb40fd8b614d8f9fa21909a20f470e1c8b3b2c2631b9918ca4b45dec750da6a51b8940b39b958bb05f09038a8e7d26ab0c226672890036c73d4713e7aafb86d1b93b85b0f94d64e4901153a2562fc9d5ec158594c8ab25c0bc3cce6e128cd3ef26af42ad536494de6fae2d07952a2e8490bae007dcbd09aefb0eb45c0781e233420cbf1915460ec6379988b4eb8314cd08cf5cc981c8a5d20f8c754c25b60e85a71755cbf98447194f49010bd1e79cfb7d2a4dc5934d19eab91a51fa87082d5006bfa6d3f306fcb981dfce8f3c79fa327130e4941c0c6c7d8309ee158fbcd5fd33e531de1853e366761b6051276a91071acdf568fa13407471d479b5c5b2b411adfb44d078fb2c350182a3923f63f4945bb8c22ff0b5a6c1822dbcb5bd85ef582be68ac9d4e2b0af48df310bfecae66360d73bb9ad4eaf5d4b1a0b34fceb91f486e1cbb130408991c3aa2332d3748842f1e321e261f0b9ebffe27067c7ed92161987c53e765f6ef3c699e1045cbdd3dc3cfefa81eb9fd2d5603a663e6b1f6d2398eb8c60e122ee700ed50f4b5957c26f342630f7a4ffa938f5ceecb2fd2d0ba00410eb99afad8c0273a866ba30cf928da01cbfbfd6fccbf944b19e6432ccfbc23a5776de97131f9ee4e753747b974ce8cd167b668bcd78f0919d34854a418cb90cdf9f37e058b33e6dbfc48bf442f422595737b5d4f620c6b5d0a658f650699a0c57618e21e37dc0d188defe3374eb7f770c68d6c9852e4b3e13212917ab56a4146efca7e6197317d4e948f8d86a91a9bdfc301e595bcbf2bc78474ef72cd9024abd3a8bea63e8ef613620b04782c99b6078974201e21bd52fdb67347ae1c0b362f3dc2a2ff2879984eea7df9b9375fd67a1508c8d5e856404b7d4a90e5b32035fb914e928a28566fa029f64fb3d9f847d93eddc4761a32a104c59af68eef84e23eb0ea4f72c81cbaaf06fac80b7d4978006a860abefc22fbf9cabefc21bab745d234b108dd5fe422571f8fc33f4751edf6d2248c165c571829ed0841c6ecce50c830c2b5b652d29746cdae0a1dc528ea66f4e420f5ab8ee243d74e12853198f77a0b8d2bd212814f235acd707a02a35999539675cc540de4cd9e7925ba6893b6108d9f4585ba2962863cf24e682bc9e54a20e4ec6d457a4af4d22d54ad30bbe65820599b7eee600d5e5e94b234d6813a5891de25b678838052aab6736bb7374bde62fa5fdb561db3a26cf82ba9619dcc1ad4792453b49a5004f79a9897b1bbbdb722c6be4e2b16a0b6cfa3e39e3e5c02575c8393c9cf4af378157338c3046e4fa758bf4b882f333fe53cae21f7f4a5517c05ee0255041c10e2bf0c410d627a752754bf6568dfd032fccac182f1bf5332e76ff15c516c16dbffce75aed11480441db53922f86478f9f97fb62e6b6d98f049b03d5c5f13d1c90a7d7349b84ebd375d1b832476430c3a034f22681982ee897a5d07f5c8b7fa39fc022da7f62a83b26d647f177ec0ab88ed4ee3b13eede8f1e219d404943cbfa0d2ed3b5e31df73cfba646015c55a078e84d40f7ef86ee5b60aa63c087c6c828d33b57a4196ac508f6b831e5f53736a5f9a909642bc7fcf49293edfda8af3a059ca9b8c196081038dcfe96acf477d238346f536e3009eb79505ba10fa9612e9dfbe920cb4364b90542c8e436e17d2d1b6538154e4a4d3e77e138f423f0ab51a58ab170dbf00ae1e939d377b8b5671e8f78a79379f2f6e214324f3ecb17e6a5922f23f4b5cf2984d9367dd86819b9b78b1a7d9ce5da1fbcc467a0b2664c15b8436750f9ba89cae9df33d23201b7a9ecd4fb23011f239842fe98308960b1545b51a6db4a6f9e3b2a0fbcf6f6a28e8c4b93fe78be40f12a1d6ef4dc98789fac6ef122fda58c9abb67b7b80004e61b7cdc44cafb12c6861cb682f17655c34f1298f00bcf105c6ebe765948924e86677ea7e8a623d7f6223fef29aeb41c4b09bb934cf89e255ed16b20280ec099e872d74a254def78b5c31e081b3b6a1117de5c826f88f1ece9fd163dc669536ccd4febc7515f995bc9c3fc3f28b648b0cd16075596a28dc85ac0429c4bcc8c1d0ba18366caea72f5c372cddcc2d9145d158a1df3293dd4ff911626854ba1cf65dd13535d364111c6d6c5b4a03192baa7d64d0accf4d5d89635d0fe3d2890debcfec730cb6c5199f4b0eb8822ac6d0d38d77a3794ea2c7ba00f4c1a33a706a27d8bbb4b5576865f5af25abf520b75bc4aa3d94ebc27b9a08c0730ea97c80c4640c4d09c8a1da57d57ee14052e2cb08b53e6c58417ff3611d299d126a0fde493fe66cb799b6001ad050e41bec49f0fd4a972d40b0242bbf79fa1747f1e8cb3cf3173e96e0536345b66080904e2261b66c46675751496bae5d8b3d8398f10dfe672a8410542e259fa88533099807a2b59c61370b2529662a4d8e4e71982f881481c5f03362e27fcb707ed67e089102876bd92b08933d07d5347937e025afa0a44ff16db7a6d867cb8ba2cc0edf8af455d8389f63bc8b27e6f91d3a428f978fb2b023c4a797b9605eac4c88ef0de02ca7521a99d9da26ee4218827032ce724e8194236066ef531a4566babc293ddefcc1b7d33f137817f4c4833f8ff43c3b224820f5ed2fb45d7598fe6bdcc69c1bf2a8388a4eb198e84d5500374ad334c10af6e682d9fd1424c0a65d9a22058bf1458d0ff9357b21e7e6272e2f9e18fbe554a3d60e043fe617b9301e0759f7980b5d314853c47d52f6daeba7ca12f78c3683b2aa78aac6e9f6204094ef8559bd8430eca3c4840216f2315dcc28a050b05757dd2843860c63954cf1979671723a60cb8d1cbc206eac59442d7065f98b96fef1d61fbea84794c7d88bb8622bc99f2d47c78ed418bf976fa622d7d27a34e9bafe0e8bf03f12286bb026ec4b3eb9fc3bab6067d7a376bec7897889a0a6a615cb0a642ca93eadf8c20ebb917e82252a76795f5c93d07cd7ca6d1c7eb5059674f444d2154297030b1479f0b664e60618efa03ffd13aa9327ca7ba44039567a245071447dd9bf5b4ff80c1927cae97d85ffec4b4d4e00b7e77fdd0d17e481e7b36d07e76775f2a18a6b16df1ea67773e63fd2c2e9ed2431a69ab77bbf0732fea6a3fa529fbe6befaa131f0516771a6fb3f83716607d7da3e23e88f8cf525d63eaa61f49ce7128f664593a59c281f2ff9f3921edeefec6d2d2a4e51aabfb81f745fbd4ba614e73ed1b5d069912e7a1a0005a8baacaadbe6ec2665b8826d85dc8ac03520afd3a49299ab6258d349baa8a9a4cdfadc6ffe4fd5e47e2d4c7c21cffbb0198b70a54789158214c53c544ee473790e1170a6254ea78653cce80ecabd39d2d2e217246794a744a7afc9e42de314ac50cd9c67a1d1bdc83d264ebd725050d8e091f6ea4ad21ee22f70f3c6e903e5f371c569b4e129712d603ff55168fa418bee23d7ba1cdb97e4581e2db0fdb9e8e4a54f0b8b9b246b8ba716c50d9f20844e34d4c390aaa1931a9655b70a913104bcb82e5ffd67b786ef560dc0025879a4c35acf0756ae8a425994ec7af3048b3a71fbb9c84c7fc0241d3d01badb1d6b8656166a8b6ebf094547d638c7038f6dac791b1bb9ad38c1f4ce929203659a0622be1c88bacb13fffa9b7b44fd454d4469300f52f761ad2b2817a0982ebfa014458a037e11b47ea85dbe7ef2882c8add38062ee1d44a6a0a6496fa419e327650a456d7f308df3ba2a94c0ce5390570cd4cdd3e4fd98059e47402e3a9d2f9e865ccf1ac4adf6c4b34bcb9f576eabc8c8f10ed859d6bcf168711eab83890aed873accb357f8f865a6d381219fa7f77757f292f6915bde086f2aa31a36973439fc6f3734f3724dda271f478463e4a86f7676fef08086fc94611a266750f8e3c3f67224ca3a5704c1b162d05a46948b207a2e78ec4b0f636bcb08749004df6a03d4fe62f5bf3a72b19704dbc75f816146e64d66ccce5db6d39a633b49391d855c25aa462d4c4b54a0b9ef82acf99c9d69454645cc35e8011db625d2065add08b54846a2c4ebccb040cd17a21a6d708cb9cfe216a25d74db5f4097ad07a785faf4a0d380ebc8413a02a535d07e5e3518d5b583e6287be3ce1cbbcecd67dc700a0388ab99463756a303626d67895e364ba23174dfbdbd1c1f2d866dc1941eeb310a39e84e286db299b447315260b88b407b5154ff04d410cd069ffb0c4af40e462f21f2b9b2d02c3d79ca11d6cbad69c0f9718f439893c9f7ed9cb35c177327b41615d04466931b1ceb9cedffa80b9bbb6cea3d9b0147efb15ca49f707d619fc01c4e7ae73f6a6f736ab7f668df979f8c004470accf775315cde70a97fb95000c79e2a89061d396c396d69ea0063e240edc5c4f1bf421bcddfd4727760a0f8dd73c56b68eeefc25db371a156825150fff22539cd6d72cf7daed1830f74346a67f8d3b4f4a395f26fa47d2a762c2752da1c07c0b812084c453b968be00232c551ff887f2adf35483e4b30b41e02af3ed3a2bc91e0c06bfcb75fee69c5dd6569af0d11ebf4dadb5b5d7db75aeddfad63ecae6099cbbaa257e6880f70821b33328e6d3aee6fae2634628c33875f81b7a76a4cbf566291877959777ecbf872c36124a17a7ad245872db40fddfce04764bc95ff9017f8a7289d6f388c4344c04e30920bf5fec8495282e532f144d26184bebc047e2335860f2f0134375a9de90c4f3bb70c949634380a591c8980104f70bc3ad6dacc5aff7e8bce1430411d7e529afc40fe69dadff884fd36a94bfa7b508fb585b457411a1c41ac144dcd76a4292bb0fa6547f10d8959e5656b6f0ea40259cbfb07d4ecc2988d9fc70354c162f0e524268613168d14cd4ab625f228e4f7f425c7f20b78ffaee4dba15284889024872f050bc70a01df89f26460776ca33c08ab8e5d38d5c32803172c6c813ebd147b91006e7dcfc26551675ef88dfeef91685a064581a26189df03a011d1b1414727945995e5081ebca55120ab2dc1636fb520b72f41c8f641af2b4691c2e50cf4bf56d3b7c9eb6ff94ddfc0a5cf2584c18abec2a970dd0964d5fccb3351339901de402bafec01204c0b1011c5d95bd5ab13ba119152e3b86381b7ff2dd6ea9222ec442277e0ac65b8c5e24672b65bec03c9b369d55fc26a771d3a68cc60fbb8385adceadf2de0d11913f95743d3f26c4f9c5c85e3fac5d902bea866e3c29739ff499529312650ac9eda7dcfe18daa9df65ef293cccef9deef3233c34a5fd861bcf49049667102fc9548e2c4186ab2e43f20179e57d633cdcb5f8a9f08e929681d2aa9d2289726dedc31f260d2dad2a25aacfc6dd34f5d9c66ef1528266a57ac61f861750275304e696fe1af7561b4954f300cc4c7e8ad7a6b7a8f4bafd9a516f70a8e100370c1229429c5f810c22ec7997366148561c707d6038f09e9612a2d6834ab6da81a16920784b7db77a42cb5dfbf3fcb7fd37aa4fb4958e0245ee50869035b1acb1231e9eabc33f84b97fcbe2c242a453de035dfd9eb11574bfcbc26b7b8aec071892ec06d5827f8e0ceed520b175f3752a37e0c128d4bf60ce8d91125fc953e66aa1738192d1f826bf03a16f9bf490915c1b52e56a5f304c0cfeced990238e162a5c4b5ffc359e487eadd016ea09c736126b5cce9341edaabde95274c23c0742abb32ad75b5b05e2cbdd9606fa2a517034b2eae136bc53ab2170ac715e82faadd973dc53b482925e5bc5118f198ba0551957116eb03e3f6f8fb4dfeba090d01b5607762ce7d498ab76baf2e2e8c78cb5f0e5bdf24de3cd6d02e93ab5ad5e7c4bf579e84681c17a7967c9b290982233deb46b96a533e27d76c000f1aa6a6000e65f7fff47700268a8f07948aea186ad3b1c602aa9b05ef8770a553b8c1fc79960dc1a074079d8913d9a6779e76f2fb1832b5c0a5e76e0c510152e394f743517db4ac522f71db5ec1c7dfe6e1a4c903ab6381632ee11e6cd57edef05cef182a39c1c5aa83aa0fb3f28750d77e5c16e05681e06c771449e31b532f28c27663495c0eaa95e0665c6ebf0374f06a8670b2792a1c6a9be78f311fa07e1dbd02eb55709f95cd2a1a9ef6847a76ac1630ec23d390c3dfa76ddb5e85b3138e4987dd9fb144d3d84053dff8199b092ca4d899ac78c2ed773990daa65dfc61df3771c1ada4b0e2e6c6ce9a294153b14b64127264f40ce3856042c3127f23c8b28edcf419b3a40a502cec117c212d299057de20df60880ad7ccec84c642ece2f17c53bf7bf3ea307fc9f1bc5e53020bc9a1b680fe9beb5903d6549b6e6add7df2358d50b5e9f052db70489bd457730bbb9cae5bff1609fe1c99f7b02107d2e409b799acc1863283c6748f50ded3bd55dafc120ad9d3ad6bf20901cbfdd2211296f26e10607f7dee0fb886aacd2939d7e0e930b6934b46729868242ed2a7834aed2c961c75546d1a1852023f6c4a06ade24d6a92ce6fa24ba28e723923c72d9a458c9a6be7bed4a394c77546103c5a20fbf88332d6771d5f0965a04d7343afe4cf3e43d4367ab2acdadb7037f8ad58161c91821a0c0ef2f6e408fe66f5920f9485e113456811569adf3b5dca845062b4f152f314128fd9b61ad1cc76b5667ed694aeeca1e13c17a1b170a4c7be3308621c7dd194bb6c0f575b0c4d971777d22bb75f6cef9e46edb52e7a2a214b81ecf2144a46933ce319d4afc10e6114850946fa135844c0a5bee54cf5b9262bf710a712023a5261ef08bca1520e0c43e74243c4837fcb382b400ec7bd6902696a1ffbf7438cab4233883f5bac49467b64e24e1c46b73cf7311c188364137979998c230eca9050772bfd112f55479831e3b298a02a408bcb1349a1e9ec771fd3722fae2c103202ad77834ccb9d0c542045f142522e45dc466c1eca0006de66981dfa9f977aa088e8e235b7418cb5109b0f5bd180c2a33fd691335e6655a25701b69a2dfd3d5242733a01ffaafacfb688ef55cce090f1b15681acf36c6b9e19b399125b2b7ba6279da6eda3c94ba7c511227d990ad5db10ce3494a240f578cea7b891e72362bc0d306e95e076d7a92e877e01ae5d2c1a0594f26d84cf46e368237ffa0fc5d475c8d5e5d54d23def3fe8482731be7d701243f11f99d2de46690373d7cbb45a8ee1b9a8200d9171e9215ec0c6de5e0d95d9ebd6f05f1a95a78ca7f3c8af41e094bda504e47050ab1bcb7a8274f627ddc5521ee79f79b37cfebf3c64c4916e398fe1d8e3edcebeaabc226e33a24bf04d0c59efcdb315f752ab803e0932e96fe3282d7597dd94f58fb842978a5c72ff7f39b72e404cabb059debce7dff91e21ed948d2059d0f1cceedc6e8148f75f829f1e7f2a45a8bd10c32596abcbf07c289b171693a9f42b91d2b29f19e0294ce78bea070b4cc7d49133db61bd1102268aaf290bbafc4ab272caf0cb41b7be9a7b33cbc93d7561aaaa43ad5d327ab180b6f7fe87f67e96166c59e6533b9d8cc34db1ba454a310d4ee82d94ed0069cbef06bb2364e507b79c87b07aa04c6502bbf9f0e9b262405d077632d9d4b42307614a73919b479f3893a2d38188d870b78abbf58d044fdead57225a9f244969e50b34e5d37f111cc53ff02401d8daf0bf480f4a5517299be427969914e2e588818e3ed8488ca485e64217eaca65da0adceec51aeda27e7f78747cf739929f10e7bdcab3f0ee04d532f7e2fd1355ac9a8d90689f49cf3e72b311623824c9e8c4a9027fad2247812e8d2eaa5255015931d8b61928b28387575c66f752d64cb9e792f496e22e319ff9b5c14e3817ee8638f01b09d6e699e25f9c402c310acce5b11c40f3ea6d3e8c8a311812091cdbe5246499bfeea3b0385c745d439035c3ed6b75511319fbdab083485ac7bec64b0992fc178270ce404143943118ca09ebb46d634fb4fc5eb3d8bb2df3a219f052260b3b557288acd90f79ced570a2fde8cc3f1e12d12eeb6490a9dde48349328499c73cfbe2505cac632def503e1670bc9ce02c9701def35bf47973da2106bacd2edd4b26cb15b2b9f9c448a65d036ca155fd1835b4e6bd80cac82f6d69ce06016562cc1f6eb2642f372a2d7e309af275a4253c8e9a74422acefdfd385d605148ca4c627801671338ea32d779efb537a8981da584de0cea32abca4d71056485025806b862c3c0fedb99fdd6a907b039bc7833dea42dca9a80b20eaee12708330ec3485b97c1f9d3db989a91272d35e81e756b003717b77d3a65d648e5c614740995ce009e43bd736166a7a1e1aa4ec1bd03863c40745e843c0a6278c5dbb806381195b6b25ba6b4541389cb1340e756af5a23fbaed7868b616db7c178857ba6c34edd97664fecda756d452563c9343f0f86d6571289b7cbcbed9955d05c5b90aa7fe403e1508687b988bfda39067dfd861f6916e63536d0b1de9a9760e39141522a67daab8621b28f53f5dc515607012adea830d4f8ff7b6862914e2e2adb027b14bf8479905d815afc52d702b81bfcf84652982e74ac8618608fbd0ef4b6905916a082deedccf3ca53d1a429d408f246aeeead662e4a5e22a61f28936f11f7836ba1a5fd1544e5379c894101fe24a1a8f607c714043c8f3bbde5523d1e0264e70f23684b0f8a68448d78e2772499cac629c1704288f119aa70bf036f7f0bb08ecc446e20f69bc1083becbb8a42f18f0bcc1ae0022f304dbd66279b73f3e0cd2c5326ab4e71cbde6d92bc008fc873c1d867f43cfeb06ab45a76f67aa069bd924fdf150eaaec13215c42d695af3f8d93b593f3a093f87b78a5afbe42263cec774d79cd364bb5b037dd920bdd06ff9bf82b3dd6f595d69f239aba11bd07163a7178ad5b4492cdb6e36a422f4c9c6a6a00267092a71f61184849550f0a04ccb92348adfc29c7a60f2daff49b3f229e36dfe42c76902aaf718b19968cf1fa78864b1dafc7be79901152edb2e7a52c46346494d8935de113d6ab13da85f228eac28eb5f2aaf51a80bd87710f6c89ca8e40f85be401cee83a29398e1aeee0feb6fd045ce066dc5a0e67d421801510df4bbed4da0eeb800890921155446b7ec6e0f58a07b7dc7a84fc1c8b369767a2f45fb77eca8e6d5743c5470492e260bc71a81b89288d997f68ec7f1925b184bd421e045e96258e82699d4bab8fcd3a3705f5477f793029bde7a37aa571892409e8363548c6842d3331871aa9475fea6ccb26198fb5f3019d1f210a56a95cfd96d1ad101a839b5fe92f00a19702a93cc377d9b3c337cdf5c2f6e7ed86dee8fd1eeb5801deb5d8d1687afe7f12e229f9949efdecfc0b66f65c2ad896343a7e25bda1ecc1eb1090905aae3543d47e10450e8baf1b9f748572779139230e57fdd3ccb8030acfeac923cda201aab42d2f978af932a697ad976165ce451b9aff983698e3ad5ed2518972d7b8a095cfa395f4db24404c539f33b676976370f436d08be112f921f90efe076dfbbdac074d275006a8b935fbb88ded0d93eb741f7ecfcc443136db2e52af25d66be85d60dfdcc3f57f9dd548e57a231e704b0d01bec16049d07ed4abc6a627eaf72cb4f762a177cfebd8e631899d69b25663eff0f67ab6b1fad884d6d8411c9b585f0e13b726077d2a303ddaa04b4f74d2ca12fba503a77de9c3dcf8c3aabce6e9b2067bf56762d6b75dea373bc1bdc3dc0c8dc374f9366eb33e79b54fb919f80f56ba3216abdd6c1c16c040ad7cadaa0d103d161051b51afea64a62f5fb8d26a5033eaf4e91c57251edae6e108986f47869771dde03089e7bf22374536b77575b702d56acc26525c8ab0b9e998f5228ba9dfca94ba138770e76cbe8bac80e9703e12af83df50feb2249d9a56676b847259fe766c6086e984e27eaee768b161dcd03f6c62a70bcce57b9154982d87ad6e886890481a7791880a0fb9229dbfe8bb22757e58017581456975e7f200ec465d7808e2ae4edd66903df151762843c9355d7cb5ea876f66a5a068c4aadab09af30ba4b21184cf81f78d58fbca9b19c90bdc56dfce8a2d0251172219ca4771685208efa7afc8d86aebfb9ca1026682d5a3c741552d2e81f1cc6b569a0e615352fe3ae63bee968214f1df91990d5340bf8a1d334312732532d262c8cb33febd52494269a8b056105a61ce32cc8cf8219b7047df5700fec3f3a9fd3af0ec37191c6b363566a88d60a3b569e895a57d18638b715c14393a1d68e096f3f37ad823a6d68b7c6301e2b9535bc3c854fbc878f19ba1f5aad057f1db60ab8bb0b9cd8d7c2ea0a329f8ddbccc292770021f7fd740f99e4acb1273c6cf50323741a009eaef8132e39c2de33731e28cbd850076260a6002ccb532092a26b44905c466bc12fdfdf662e10614e1e0d695aa49ed502cea661da6d35fa821ef553b976b7b245e3ee6364f411ac6a82846bcac0fe4e8f60b1dc2d4b5e14f5e70ebc1250e3b73563f4c5edc7e23a7c079021bcb24ef55d71cd4bd6ba06d42820e4caba39f47b607bff2f5cbcfdbf74b6589558991ff87293e0dd7e9ca08a5dc7179289e1f501de3e02cbe869380434c3866843d56c359a506f9d17f9c07d49e94b0029de6d71bd656cc2b46e66e96a97de1817a6735c6796d7589d8cda748f7a4e714449100a4a482136a5b15bb5e04575d00cb7cfdd62f663352a80e2ce5aea69a9e28b1a71fd08ecaa2bd67b5e3aba2748d0f8150a8f38fbbaaddb26e4d0d252c7f5fd22c1686ce9ece8704d3adb52f715146722a9b6ac03b175d608de2a666769d3bfaf612c8e44176bf1cd7de359549939bb059271f6f71e49eeedef66a560b56db198b9a24af15b31a8ba9e85c3706bcab4afc7585160c6f637141283f7732e3e9be7e1dba59074cb790d794dca9723a88a63bace37f401052340bcdfc75c1544692a14a9049cdb708287103171be8d2047c07d8ba499ba42c9e2f43dd8b7b40abc359b440b1b5b96688b00a2254fa90d0e1668dded770f8b36df0d74f3d88c44b02367349e88165d1cacff7a7fc80b11e4dc4c6de3c6e1dff98437a8c6001ff1863a0224fc6f97949baf41ca61e8813f82d462c271a190fcb4e8404cb7c366a33c983506889ac22f1e61d6f90d95a34784f324e7d8eea7ea45bf0bac93a0d8fbb589a6a5c9e3c12a6f9ecc160583e5a167accfaea569690208fb2244d6912ab8a161c11f5703d219545269a5b86e0f0d95c0e928ac95df3aa8a649bddf17f2cc05587ccd4d826de643895c5d9a43aaa6e4aaadbe0a5f6e438657ec93c922ea27c950a0207dd213fb0efa6fada7b93981897860e10522a8d82a7863234747a1ce88192c221e3187c86272df77f6d37e5bf7042c9b1f825be7b44612acde65b64b45fec8ba1d876a89c03e9ba2610ad4c14c9a8e96c2d8075f26d5e367297e6dc33548fb9a39a2e07cb81c18c9d25ec3e6e306088d172f9605c1f2ec005fa03b84b69f16b76bf8c25c55cbc6f3c2bc692c4bd6edf5e136b8479ab2ca8451fa10a690c2e182b7c33ff41ffb07070b470d5ab52d8e42eeaa4282096cb181180de8e88c27fbbf8dceffcd2842b7fe2313ed924e88695c81ef6b916f3eaa009fab1df999c3b3a4d3691700c829b715ad2274f31ddedc4ee51e27f2561453096cbe1c6e847f9994c8dbd6d1edbbc74fa2b16a150d0f613113afdd7b669aefae87182b6419b8b1f4b00883ceb56b879393f8c044e32006546e8c80b6ed00de578094008d971471a49ce153cbaa7dab8cdc60ef4aafa6fa6fd7e087fce0f59ac29607e9dabb4bbdfbe351a4bbc72cb6a4236fa68b65690782491e0ff61366484a2b4c7571ffdd4fe4f022561f987c2f16d35a509468cf53bea1d115c4517c842128037b1e47bc0febcf679056ef1ec47271ee456c567eca99a659e55f162a196b2e8fb549da9a7c3c5c3ab326b81020c726c2276f64fd6b1d31b84227cff570c2cad25fdd5bcfb781ab4d231c1a8d1eceff7c2d5c0fd3578124dd5530d4a84356685ac704372ce8f3fef32ed2a64f9babb643ed0b43ce277aa6f2c6ca1756f1bf0ac9a4764398566e037cfa7038f16bf2d1c535e7cbfbbdbc99847d7e6ebcbd41632ff3882abe8075cc8ff1e3ed6bf9bd47d5902ca4a199a5e25170a63415a3388ec4c13eb3610e7f64c6fb53787e8962c4049c9dd96775002a651d8f299116c1139d31fed981dbfbd20d902956904f2b8dc17089cc7f69fff3813c6d31e344cfa5715f74447cf2c88acafa463d0afb70f8746ed742569ba023c8a3e31b577e9742e1771898ec7db8ebc37cc31b52d1200ba7efaee4ee0a6e72e37191538268d81e36656db0811337c25834917bb171d2013569c3bc229515c78ae0882f6723fd93bd692c6dbee0abd285f73750f7f25e49af87df9e13325a495fa2d7b2202fea7f27df6bb8f1509c25306609ad58174925dea6c72046118222e633a9ccbe21f6f988eeb12fb47aa6605014f936bfb43e32f562448fbc826b41897010370e494a4e5806adad07bb69855ea7396d1bda0456b3dfb8d0646d4b3227c68fbbc6cad21fae5bc7209374c4bd19fe38bc3ad1ac9b7e7bd18d060f50e41f094e3f730ace84ff91893d29b8e0a254507f6d3200e634082996136a1bfc4d68e1ad40ea0552cc96c125463d74c12a82817ae18d720c55f8d12a039064579f38a1860ea752f2e16e2be8d5c524fbaa1b57983889a65b3814956120bba321e87610468155ad7bd98354b8694c66ecf56b2aa6ee9f4d08b54d3e771d7303c54fb042addbb4ac7ab583f49748ee8aeaaab17d7f85db203f8b80fbf79a53ad3476e44a79107708b6985b2e1cd082390eba0173a6f18cc50a3c94154d28cd02f99abc29d73879100ad02c523f1017f68452ac61edcaf8e4b6b40eb2ee815b4bb48f73ba0d982a2036af95c82a4fff7a88d0471af90f9a8d67d89be47b41a473a862ec0e7a7d120b932013d9c1c0e2f9ebe894222609e5c2065a44e92fb55deef2835cd5589d7f30f5ce2be530b8c2bbee308ebaf6ae4c5c2592076ceb7e0ebf04358de92091ad5ecb714908a3771aadfc9b8aad63f5eb4221738cd37fcfe75eba226408390c47be8fe95632c51284becc8ca68f4802665409be60c529d4a92efdf8d4caef2df489756fe805b02e4d732031df925aa77ee346d87137392e8cf6a639707b390a34e5716d43c81a345c9a8bac38e429afccf9f6c49ad95652c69bc8eb651263d74d57e4392b24dae1d9ac3bd8543b436b72e64dd72e9a231dfa2d0f6512c2499b4553e8dda0c0c898f1801ac8b610856fab7fa8622fd7c36d06f860a9b4474329b4081c11085200ddd7df71e60903bbb4227c5ab85490ef4a9095af13ff0f21d6ea4ab6a88c28ea24d460d279622d5d1987fb0db59b88e868a306d69e25cda1f5c5e2ed458f6b0933ab643ed2083db594c0be746be81a58bbbb9d1431ec8135c2d3962925972d62f52e9d8f8eaa27535459c9b55a90b1d387513f2120334c14d462f146ff06a5381073d14e2b034d771ea1866df490437127883c1975804390b6cb7ef7bee8da82e92c05f075c551afcfcfb4dbbbb63a2002e63f2c1558622821e306e5a406c79996c1b5fc8df936168e2272c1a84d4baab45959e513231ac219002238b58f14b2bed1de57f60e9340da562a2f4d2cefad828683548e66d73004d4204e1a283ec590fade9ebff22cd284153c92987266b91a091fe1bee7eeda5081eb29bcfec13162c8a642c9bc20ee85a3d6e31b3bbaf9246325a1ffa528040acca013e7d88d624259ce4a3563b491eb019e255029fa948d3fa943a6f2e544dabaac1b84046841be10f2c2143268808c7cac8969347de81d6e5bd0f44e02743602b7f1f4c21cd21e0897f0d72267acdb02a714d8a2f370b7e129f86896ca1ea0613b71ce297ffca13f3e8f75bc396bd985dbda7f52e51a93c8fa2ee46262945f6dead6cc40dc3ecca9aedff9a99e4bbd9f38195ae0394ed55dcd93b290d7ff016a1d64967b02cf3f8b5b7538d4e17e830b46b48a9e2b51142915e75f6f77f9c60bf0eb1a5c07e7739929fc1efae00c27bd2d36a90aeb6961f92ed9afd9eda8df2a129ec28f11859c5f1e98a984bcee4f237dcd03505f70410455c93ceab5a90764d2906061bbe81239c5d655a0297509221c9f6fae04f2b211b44baa82c380f2ae57c4322d6feae498ed48ce4fa6c742d767ce7a95056493054699180f35c807319fafa8d3eeed795341d6e85dca9f60cf9cd1d90f3b765e683fa37c3c390e191887f3b56d01e24b7d557e7ced5fca4583ae7549261412daf268611b15e7cab448474c652603c698c0eb2e6ada4ce1b799ef8c5fc52b9f79e8a444bc5e72bb0be050c01785c51c2a48c7095aa400309e92476df1a3eb24ddb1a7ef97fb204f1375a0faf00d0be060e8555e7bd8cdb9615a3a212db73c98705593a8c406db57934282499b55b31593c17e684158b5cca93cd3747dcf999cbd57de3d32fd90764a8d3f3ae7fb572188da196c350d02b1e6ade8a4d714a1a4988da7e937c8d36d4a49db68eed6e74697926575782a68c27c462cc2c3f54869af3e57b742e0f9621f42ae52ca76e392ec3ec9081297739d6d75a6af2893158a48a71b33f03ad024acc20508add10b16762c0ab0b46c04dbbb1c6a2ecf2495490d35e098d43343e2788babe01de4942596a99b5af39586f63fac435b7a734f436fab46bd49e3548415146c2b746996065f2988fb7efa51ab787f0a947d0338dab5ea5ac3a7c82fee7e7476fca3385a4e98f087b8b601357fd87f0d68e080de5b52b5f202be6f4e509c311efdd16ecc1b25efb8f8989e33b2816fb1536c71987535ec06e284c783fd6dca75ad489388e6be368211ff0d44e9cab48c4b218ab97b8904eebec4072a6ed41c7fd52365861a3e2a41cb297a27e793b2206a621bcf400103cc6420123cd191773cd29aefe8d72bad29dbc21f3b75cd704f74658cb3ec6fd2a386c8a3f97e6a740af6c01779ddb47a6e0bc23d55cb0a1ca12472b24dbbe11a2c418bd4325312a4ce846cf5726882570d12ef8ff7095439474d58f5d4da3e92859bfc36e6287e0df363605da3dacdb427287ac574f584feda7f2132e2a8bbfb8a1edb777875f96f5974bc8d35ff3ab9173580f47ee2226e0bc5fcc4fa563cd14a368c739910960855ae667614137183b79d65f48a9354f78f183a3367332ae0857db5a69af8ef3fbf31cc1d95c018db883c81d38d0b9536f2090865cd814214a152212e135ea0eeeb58045a093ce04bd909d90d2746980f06cb23d5d8917d4e702f886e96670202ed6a1070fb80e642a6faa34fac8527d4581ae6ad9db7882fd9d55dd5238a49ef1c59fd75e5e38429965483a2b372b403e9683ff032820c4e16065bf5d525fc8ec8f680c1cf9e00e87b10cbab6cfb947dd97b5e0f8d2ca8bb521f6e188b4ea1bca32ac5f8b507a799b85489210cc9a36d31d76a45be52f741a0ab7378222a6cba1293d19290c6d9aea3c90e611159d56ab66e91344b4e12e78ef4dd4add0c3e357d0de10318d3a1e8761e7f5375381a671a849e0f78fbccf9e40ae852e50c588a48c81ab05e084f4c776cefeb0c6bf812b152fb6bf2c5e4c8ea8d7ea7a6d0f0d587ba27d378c45263f03a1a139e51d03d1c1e12db28332f57f7a7528f30154cb4163ccdac49a1c877c15a646761e2a4a334eaef74e51ef8a4241e7a2c3c214bfe2c1d34c05876f29e85ce266de6e5418b02b141f25b2853cf13245f9391df6a85fbc1c25da807d24e3db74dee1ef58222136f723353bea578e2014b0651e4514060596519292d0b09a5db9098e56364df47b8a05e68ec44866924e25e5ac65af674cdcb106616e0fc3a2a99c2029cc2c28c04b9fa27578c7fd4a80c4dea5b4b20341bc19fba367cf31b8fa1a9caa9ea19febbbb6bee3c395968c2c4e2bc3b364061f02db0556930af449af8c5af0894e0a06515986fa1290176190174e946ec916696a46e546226372d7bc3b98a4103fbd8d6183b75e69b9296d3d75e5becd3dd88f5749b4f6954fdbfc47929facbf70368574bf7400e45817698229e2fb9c348f20b6a3218466615186e13172965b82f7b9c80c00f00e1d14417c0ab4cebdf597f82364c32fe812fbf62001381f9cb132d38b3e1e057bf33302590450998d5170b83984e4c7a7121b90d36bb3b2be8bbd8e956c53bbbb5da05c965a46650fdf8318cb87545c2a7581bc941a94ed37a70d7672235d8116761e703103e7648a7c56520b7212625ff74239191f9250f4a51cbc7d8997e74065d7a7bee049360ac87ea0ca6cf32998be5ef437aa099777220baa3aa8ffb1587ec56151bdbb223b52e7a6f9ef223fb9605e59c389aee7301e0ce219e80150306675cd5364c7f56ff0a697c52e61da7509852cf769818d8a31fd6279c0e87a98a9dbe19ea028bdc1413ba8645a0f7c170624a6c741946cd9bd896d0e8dfe081a9a2c752a394c132e44b5b3fa6aabd10983957d8e2dae8f311bd9f28247bb7474fed86678612995d83cdf581740b040774ea25709f70bb30d969c0c93cd8e78574284773ab24eabe1634e27837e21a03659335cc00a2914aafc9f997fc1424239d990dd90467fbf5dd92b0cc250205fe6fa4a9e235135d4519c8fdafdcfeaec6250db7c3168032f88f14b6f9c7a30302f5bb7537b38b8747b895bcaf53403013b30242fb7cdd2416895ac65e912e065cb33d5d565c74b58c2ba090de0ab56d9eb9f7d5a459baf86481b26e9e310be25f165424aa7a368089f38f2664273e125363e54fff0341301d3c8e3d703815722bf7980a411e5ebc7a1727814eeae1a2369dfb9adf18e98dfe4fb2503cb6b0f043b76c2e87ededa04d6931c4a1c7ffb05084e9536835479302543c7ac3d0b3fb0efc60fec08b8e6e7cb2f6e6610fa7ff2e1b073e40282dda88c8ff5f244f2bab1b8d8e24c0190dd3a1a40117001074151f0e5fefad350579d9d7173a5e5205ca42bb487ffe7449f75a049407e76cf7896eb3d83e402fc998799989b5f8ea05707fd262bbe878c8cf42aff1dd2c75f6b636cb7c0c0905099b838cdd831e33254d3e95d7f2efe81a795dffa1421b8f12c3bfa1d294eac619068dc6437ffe7e0dc47b2404245758f40398392e8574885ab1a1cdd6738e3ce97c688263c874ea6e8004eca9a0154b1f1d38512e71942ee6894e6610c1afa91cdf6df45fceb0f6bfcd9a34c670b1fdbbd236151952a04bcb3bb532d27b35fb117abcb781c618d2edfe1ce1163256db77926587ccf23c8307607e13bd830328f6fec0b78bf35f941207d5873236001f961ae937ae50ddafb0c5f223b4abe9b4767c197dd52e69f2cb1a347bf6f0c0d1f274f095c9c8b032f8ee3cce477dc48424b1c2d2f67db21757746d91c03ece22c0a18d03cacb2a9d62cf5d99f1bd75e85c1cff9d1d164ea26ef308d7b2ec873294f4ee2bc439fdfcf46783678bc6a65d9c47e6bfa0cd399a69a1d51a0af00adff3e84a7e1e1cc9267f9ba33b992c975f0b3865b6d424b116375b99429d728f42162d0f4330de0816225006ba1087f02db87729161bf07306cd83446051ab11d6060665f6f7989c95bd2e2c0a117c3f65ad04b128fd83ec7e4644131c28bbc2c60169fee6818573fe3eb9f7ef4d42339c968ad81f75e5068da94e8ed8c7e37d827fe2d5f1bad6cf250cfaa125dae0a88d0053574fab9d6b796034ef2ed92b0e559bf64d332fa5d5d366eed414371bd1852b4771b76f1d8b0f902e4d955773989237e8da206706cc8f94012597d4d1901544e7d833f01e8635bce79308308bf972af17fc637d580b16f5bd9b1b06af302cf6f089f7a4dbba3214f16d78b11240c214083a8df9d57c9757bf00003bfc6665b6b6a74eb73c1f308916f4299900132ceb3eb172b256821a7011b93687aa034bbcd1dcbfd926dbeec4a356aaca3e2cb5eca6d1f79a6fda6d1e0bbfc8624aab2ce90d19ccd27e2176b449df86fe83082af2531f9e81208c0d7e8570ada1b07e371ae5e44b9452a3c919b59d88e2d9ea94159b5c052615e1873c14b5347b750dd29da6eaedf380cd4fd80e25fb8c4f10f3f42d0079543b7b6dd9b20ff730d52e89591ac3d44ea73801119539c01fe7d87b7c9b0b8e893ffe8ea04bf57dc130dedb79b1ca865c2871bee0cb5a07a6f8a6846bb0ae231f31917c1cceb50957e6bd25efcc8c4303e591c6e4b47ab2064a0e6dc3038c63e8323f83bcf8bdd5c4e6c6e856afb6b395c997e7490587231b87e4560f9c1b8e36a99bb471aa5b22afc130373f3f0f37469abd814d81bfa49b5760e63a3a84da8e65c85ab3d8a23f50340646bcc93e73d734c5fbb9c8e168039082692309f2a97b26d19da564bd3c0518907c66bf5efd0ea76f050e5ed0d0cb9fe27db9ba85e3da76098446f40b5db3b89c67dc98e133f267d7bd57a9ca94eaea816927c0bd65cf20ea0518ee3422131a263f3548cf36adcd11c697bbdd522c97cd70a6519a1344a281d74dd81322978248f4a4fa853379e9e18d6f844f45a7bf8a5c543848e18a7ecc5533896d4a5dc462cabd7707a8539e8d10023fd257a64d0d951fdb44da1690e61b5629643f008f1acb3d7792580cf1bdb52a06c73227f01084fc6e22712ccc6148d77c0ac9a56765ef11ef8f0fbfad2988d352be6985e642b65d10fd6a117df7bb761fe3a475a099e41e145137fabe17cc2fb1d1d9387849bac84c910c349e9b8532808bdca13a97c0400b1dcb10032e0202ed9825aa905ded0e4a5f57f3e4b52b551daae3b6449397a1fd9f716a2419e364fcf9a4bef83e40e68fcdd1ccefd66c2152fd1a5d69707e9000eddd25d08e2660299d911b3ffeb82693897226b0e1301d9af4ef56461a1a69e84cf94739ea17c8885521a78f2a6c875bc95b570ad86030db0bdd2d1800b21da3527c7dfc296465768de1a36e4219a3c58517c8ad08710bac759082f361b2295452e25b651c2ce5faad848e7e9e39cba96ff0effa9900661a846284196ea030dbffd91ee877d8a04cbd9ecb4a5899a86b8fb121eb2e80d08043c5363d64cc3e18d8cb328fece6bf281b1a15abfdc065cd5f067b964fddc728099d04da101de0f442a1d5bbfca65ca2ab5e67693425fe2e1fc27d78d19f879e37885d3e5a4b11c2a4b18e395de1d11d683c47b7a7b901dcee8308eade4a88e7207906cd352c0e49cf044a9891cfd6804840d06b2295ff1f8ec6fa550afcfbbf99252d99b80aabead5926a20d1662bd584ccdeb9cde67bf254e6f9fea004b3fc705474147511373ef22d45b3a25db0c3f41d8e1895d52341909b8cd52ec98aeb9911eaf391745c1e89912aa696d79406634f319eb0afe65c98438a175639323a813b75a8c29d6f7d82d26f8ce80a3728af8ab02bfcedc64728849ce31a902ddee4a78a09cb5c6510d05a37e31fbf13efdd5522ba0e89e4750e567c552df697fbb61a05f0e15c48f9ff9bdecd27b12b90e075766eec5305a765973ca4c52708011623dcd741124a5ad53d59fe965c823279486eabe0e71f372a11c7f59d4329f06f49874cbe2caadf6a25c8798683bd26dc4b260dd448b7d4c6625f1cdd24e77aa112421f8e9544ddd2dff2994073c2ea4fb97fe22234972ab53cc9e645e98fc8f8f941ecb7a805ada422570d93ef00f92f75f7ce291b6973a1038ca215f676ca503df6c620c422dea1aecb49ecafe18827145701e64f167ac9d61350f2c595214dfe5523f7b62a858b16aad013ea96087791b8f8f5c96c7f9f4217c69a2286764bf4f2d9420ca1d37457fec7b464b0f771715c21901c68a95e5fd3b90afe341728ccd3c2193e11367352429d30216bd7c33545a0649679455ced84602418bf6094352c13f200166deb4e13777c0ae7b17369075fc4ea26ef402c228b58f28a372c7419e1b0f777b1a2dbfa48eec6ce592e4dc005f4364aae4fbd84f348d1b8a3fbdd7decfd6832c076e89e15878a37f254e0b7a7fb9d621e22a6227bc0f09018a356ab94e72f3b98d17cc2537506fee2ffae00ad87cbf5b43f8c0bff12bad941dd6aa889fde45c0962c7b2a4bd53ac1a6931e66ecc0392e5ab7a3f6230b4a8b50f40ab720ac2a53560710a55de378036d5921e76b441c3ede0a710235a4968965ee0885ddb0967feaab60a21f827dc01b0f0293e95f79ac8e0b964555dc02255f007195279bda0ece1429b6f68e68af04987292449765d4619b5531f1a29d8390b6d579a9fd0926d2e4ad269784fa0199d2eb5b3ce6602167b8e28b5a2eb95c0edd69e58cdfaa7ff1158dcdfa6169577cc1d1140e902144e66f50782e3cf3f972de8ee049ff3027183dd0ffed904b8740d2b7677a2c9cd89759e73bce74c3c058d6bb95564f3805cb50eac9692557a5db5b9fbccc23f2285ae120fa554a69185c9522421f7c03fb9f47743cb1c59cb41a88b80d24b4c9b964cf51b2902fe58adbfc902be3cdf50a2cce0aee2c702ddfccf364970f7478ea5f35f4a2db9bc86336f30b7532268c5691b1c8862c2711fe83684823673ece40d7cdea7092d5343c22d9bdbd2a8f37cb7e56869018d484edbc423512b73f979e8b4b5e151bd258a60f4a3b63dd874881692937c8f6fb7387ac2d74a0ef561f2d4e955d4d986ab5a7abbdad140e7e4e2a6a7624196273fc57c186eba6958b2191501cd2be1f36a2364b72d34b81dead992c9e989367bb04c9f9c5236ea974c3e5211845c18a7e5a5ceb8f0af1b2b22a4b11fa9c0af40573764f442a21f317053472714d56ed94a47eb46bca2bd6a56de0ade8038288c0e8cc227fe1b01e1f5019f20bff84efd4548936bf24c08d6576642ac14719c6c01584c6a460a940f3b8b8111268a3be343c7bd6e79b23f67fc2975a52894b193499b7d35b01e3f2a7c9a07acab30d6f76ca16a876dbc5d13cf7747a9f86f99538198a6388b0251b331d2275214d8f9b173ae942c981eedc9d439e84cd5cb75f9dbba00cae2db1e39a60a03d781645d6a4fe0c2690f04cdd3422764e74637e90089a953cd786ea55b5317efcd83a05b21bbdbbb71b9991f4a19630a5178dc244aca47e9af48078e2fe52515c290559eb7be8e6ff609756ff36bc4f0cb76c9ccb5485b4443f6ce564bd1fa9ba84e2082c685bcd45bc72f759f647f59b6def637fe89e73b6eef4d787c2af22d95d0c33d8d7335177f61b545e49b7d1c16a1ee27d1601fdbfa0564b5897d686debe6a910657f4d76cae02b11c7ddd4bc1bffa28895644df1bf6aec036b044eb6db1033fa5a1ba400cc2ed2e118a13bf9bfbb6a491c83a101a515820356a9a70d19c854e49b82ee7ac8e4c36cde5e3eb8bb89675da7054d5dc2a695679dc7298a293371ebd3d1d94127365248c871324482f82f90b3022f5603d4e406243e08143151daad1b20c17fdc5bc7774e0d55bd8ea5da7b57b8f1e2e339a3010d9c8b220110c3fe9b00edda4dcd86a8aa66d841f9f5418395edde61ad05e44ed31f4b85ff4ed303e7acdaf874039db43f24377200c7eb59db78ec5c9e0839752ea90f67cfca5978a3d1210c8f2324f12a02105f99dc98ed84912bafabca544ef917b94df276e8a0c5a191f669a61753aebd67bbe8331ed73ff3f1c294be985409d644bb2420a7959da6e61353ace7bb53ce9cc955cb327110dd0d7ac3b082ae770818841959684c3a022254aaf4b231fe089715fb15e6cf6551c1ab14f439e284c90d33af3c70cabf367ca9b474bd5bc2e1778f447d17a3051fe82bbdc792fd87ec5858b6070ffce68c1bc586f588530657e4347b4193faede1532d14a79df62e3061b69dee3a0150e6a57faba92bc884ad5991e721a663a68522d7fb548b3d4877a9a6f074d5620d1c3a1406193e4e75c6bd9c35f63592abad6b8fa81071386fac050e3364bdf5f859f5a56d31b2a6555644b5536cda6706c69f36bc7d5b485c3a71d7255435f10d94a60238e3109e98683adcaf51627248bcca2fee0f81975ce1c0951bc01b0f40adc6b0c143cb60195c04b1dc1b208b30f414d74313a3f6cc2314e377566e63903d4c4edd79016bf976e13cc3af55b1f344ce6aa92326dd6d2d7835694247abe3bcad34b972ac1b2c7cadbb44d8f24cd9c4f1b181649f18987898a58f222adf981fe26ba230ebe414e94a6b13eb87c35ad24b922eb24d290385be6991976df308077e72f1381eeaa0c1fc4a00ae6b60a673ddbbc2c6fb06a68de8a7773e20302f14e3884c73365d4f5ba868f1af0428819d7701faba68366dfefd83b19176b415a1dd0380ffea7e624dd93c741405e6cfac94ba547610d06dfe2436950c0ccca12ee5ebd82b883c051e21a07fcbe60c5e597766a71e6aeb7fa7d3db08139b18b7d257fd0e8ccba0dabaeb45ec8060ba5ad77ca7a6013527b2f2c4554d748d2dd863b493fb971b7b74ec9ddbb49eeece4d8f17de5ae34193f8fa40367c9671110140b5894461be10ce74094e9b87a3c14b3bde74b177e9ad493e8fab63a644dfb1ff09ade5f4f8fae1eaeed6cd3d168953f8621d3171d22f8d88828e1ad4bed35d95067ce9e498603187812015c72c739488f4714bb0100f40c48ef696cec59b299e28270d75364b11be33873d188dfd0e73ff8f319c993eaca5e4d6f31387253197a445560da8c9f5055f46252a80bd86bc45832ada8217501cebfebd7b4cbcc5a8001d40c6f76f03daf2416e07e6d72d5a4fb4404ce96c98531e56bd76210e54f858b1897d7defba7201089a07f5665db027dcf92750b9f061efaf6622d9b53203538f377f93202ba4950ed5d92a696d26b0b0ef7b7a0bc64d829dccfa4c3ff8f34fd1fe098f48835d168c8d764b602effb28eaafb5a22457f99aac581733b70e1c47b29f4f7ba133001b53105f6c0ca2d4a4df35503886cf626e671373cb5fa5b7f8b92ca93beb28139f5a4e22d0621bb88a79fa999c32df870a51ce022090b8d08c48efbf1bac83431e0f3a29d9c74341e16b32e030e385b2dff87bc5b0d63074363fc8cbe9d53a78d69f22c95556f44e6edda544e97aafbbe01ae5daf1c1f6dcc1a276f40a98128ec7f4de8882f3ef53c841e08643e793c6856d3fb2eaab3f16fe7ba94477f3f217b1c83cbb9402ab90b8a4daeb0f0e080f66146c9838d6ab74c3ccc754d868cf936a2e2d41133f2cfd61795cc33539490887385691b5fe57fed07df3f6400725dfccddd04ff4cab87d879ae9dbb92ab2f5b0217f938f382fe1fd515a05bc1e3e530df82169f464a8981672649b8bb55a27db0c562fffc171b308bc8a8f3b5e82cf4efd8fe69b9110e863bff094fc29eb3f88331499868bc4df2845716c8b28b8f9d1347d173b8b69f21a10f9c23348f294b440db6a3e9429710cf05beed2d5bc4f55288180a2eefe110404ccee2474b5df3442d4ab207eded6a9e4ebddca86c6a85d517f83ff9f9744f1cd8a6ede7af8717fb940ed0356826560d1f88577b57b6cafc1d9f564290b7454ceaa15b050d55b164ae8e2117426fca2f07efd04a07942dcd9a0759d37a03aaaedb5202df0f9820c4d2147fd2e8b944edabd0274bcf208d141814e706753f647c917f1f1f989d4cc7bab47b1757327d0459ca048f2d4e682ce37bd85f346e6f62505df3907c56d1855179c5daa3b8b8cdb02613a44ade69bdc05e4d016744c26ffc55db2efd1d7294b1d2736862010d060244240eb88c35a0d22799caea2afae643aa808b3a085cd179fdaa15c29fa1dfc495d928795ed8f0d0c42bc2893ac0f2df5266a27ea05c667b8b07e6432d61bc0fb5f8f2bb04a91da90d6c8fa4cb5fa05c98944be1fb7e776738706da28b677be509cf13409f5cb3758580f38711f831d996fa69a45260c060fd17f878dde1aac071445ce02ebca409f448772e7a2bd648f818c0c27a3d014970facfd974fd2517db49febd0343bb66e1f01b167282c5b1d8560cf04b3e46b5827db9b74d8c4c5a86843f32847bee83feba80bb2ce0a588c8273b0a0cc238875cdfd94737dbb7817c06d947cddefdbaff5c26647a64d13a1fefb10fc9c5c9570fedd7f72ef85c46c0baa721b4254818994de9804a619d563e0cd6935367863142277390baa1bab6dfcda53fe7ecdde13c65bb2c02d8cfdbc3a8ab3c028d37c3ecc83139de4709a62dda933bf9b887614f119a6c38fe2c6ed2fdc482dea446b6c02e84a0a4ccc209985e57fca652cf7d2e18d10f9f35c43b2a6fbda034827157632b891ca185f8861094458337fd5779fe8a6ad02510d3c65c5cd5c23bb32814c2818bd36a4fad4bcf84b97c3d407bc5087c6ca244cff5ecc79a2635d9516d0e04fd9443de8d39498ee53d4238e428f9a907a3c49d71aa2c8f9bcf34f7664289d3dadbf4f98777edd583a3a1ea98a24fd2a3458be837dc49b68cab7b23f7d5489908f3b47339b971aac87dd610ce2a6f84d16858ea1fc3c0c735b0cf73e0383a7aeb2b1cd8828d4dc03ce13a6f634b05dc128e05d01611264474cde7cca36587cfdd3e3a3e8adaa458564be675d6aebef4a2c162bd2429b9100e98a57bd7bd15a3b5c6631bb29b631d6f494cbc8f9752bb0b8721ca9413b22a39bbe5ebc0db1268da4a188862497c5b212ff17322899c58a58558bd7d276d9ee79156f4c113e2b3453bd58d1224e5add3c4e47f38a34523eaf10262760baeaa86544afc59c4e3818b2388111da35cb7419f0c706b49996b75c77eec76131ab50223f1f13b9a28a5cd39aefb6b7722f7ff203361daa0eb8fb4f055a1cbae8ca3ee5d3685bed43a306b9f4b88a572058f468dac4782207761f8e3ae4de55b19147ec18833ae347c20e4ad9ebb1414bc92b8449f360d931232222f5c1c09d8afd297c35c43620e1ace1933f70bacaf43070c1c23f869d20d649d1fee2720d0cb632876eadae30f159b5a360b99c2c22c96e7b58d33b71a5be00d60d21ff5d54834b9cf730612bb7197da54ca8296c5089c114dfd28cc2365c64d6e199bcee0822939e2d03657265612b06ceabae39f8854d08c041618559d65a3959146bc7d6deb0c48924d16a55f17db64b8e6422bea8d956d6ec976ad534ea14dcf41f7be44b304a3548d176aca9e51147e0925fe627ba922e0ddd8d823e913be573ce76e8b1f56a537ff47cb3a0c03d6e0a44916bb9ce548794ab02a758b4295a028fe340bb4a4270b1c964c7035dba51db18239b134ce61dd37fa686947d769918226d4bea3285ae17e0d2fd9ee5d365196f1a914f2372f735c181c52ef329f7190ea4986fe949905d984edb3917a4030a65ddb28e8d3e1f17d9a3b48e54e6f35db46eefb490ff734b5aed780574f208293c95da765adae831b8851a3556cf39d49e1820be1027e385eb8e933b7f594d8f4723295e87eaad110ffd9424a513cc2f763e8f7acc38357f34002dbec78559ecaed72d5afc00a25ec20c2e680f55b6239d4ac066acec6f15d6dada1e83247cb973a99890739203d70bb60c6c96a781f20ee90c45aaf207137d78e2bbbe57251ce7643be1442e7585fbbe5a473d45646109330c3f3cc74c5253c037fd76ab00e8ac118cd967d086a982593883f186fa7c2ba2327181d48338d8bc94bedaa5bb346ab6b4f3cd64d6ba811ecd34ab9431082a10131bd6b646f10b93ddf450e937951dc4c6ade9e8e027dcbd21baea3f6210758d94ca6d88f2c3a606899a14774feb4b79959d876a3b7f03a2cf379f837a85ff242ef0e5882b708ee8194e6c6b3cf849d4d29d8624a464dab90ec4ed8fb5416272e613badc58858882e68d6dd8d5003af33d189f72d01fb130328bbe2200e30dbd2598c2def787faada09f29034376327ea32fc34667c4e887ee4ada1fb9daaec71a283f9c23b4dc2b03c9c9e5da34ed53d9ff810d36d49044bd022a5f2bb8ab9d9a3a122e0296825c518ac581d982c80465a9190432b55ef8822a40cb2c309842d9bd08ec95bb9d1bb953f28b7245136025eed5a295ee9adfd6f4d821698bf675f60a63e9184d17f258f77b9da7c6e74055a6d18b1425e7520922e1acf4f6403a88b4997e33d05ab6332c0179c645316a58a9fe26f4acea996fa2ea0ac9a98e1b2a90ad9f8125374d1f89026c5914ea57fd34d2117d38f4ba29416ed75c56f94cba1b16d6bfe284e4de7ccf61e5f121d9b7831f9165e7f4492411f8de1a3482c5b6948a61744e13c932c6508079bc5911313592a81b863b330a6e3c36087e80f4be73e918f774a8f8f0f61775432c706d39ab0cedbd01ae62929054693cd050c09a69b43bb854ed0dab75a9899d60d18c9a3ece00b694f2cfc90e5abd47fadea8eb93ea62eb5049a9774891e2e9755d9c5b8690ca9b3762afaa0707d4b75975c938641f3831f5790f195957bb709a264e7cde161ef155059d8a91388cf355d23635a549d5f366b150b4dde8aebc9922837ba4de602915fc1358d62ee2d206405c3653ed8c0b9c3b96ba21c8a80b80316e9706515895e02b252fcbd3eeb9404021081b082c608c4a9876c00b98c630720ab662f9a179dad1085fe09ec3b937e7cffab8ca7b2d47722b370a23a090e686adb4739e62b5ddeaba33dde19a31b5de4bbcaf70b618f7ca17886c0c37c43c1c6f76b26002f4f4c2e4c233ac3ef0f2884a0e030fac8882ecbfc16a175a85a9fda31e894720f10e59946addebae702b5bf799bd8f3332478a1692f6a722129a3dc759dabec21433df81bd3944e6bf5d17fea0d1e60e9ca15d5eea500f6a59e70d168e97b995d3882947dc77e24516401b75762de64184b030b6039fa44d7e549c86df9a97e11fa4076f521d14b9d3341eba39695649886aca80dede7f6f4e75edb4dea75138938b69aadac3acc9b237a8cb6282f7791315930dbe9a7d3f43ad0dd9d0e81e0d74868c2e68865ac7a9313c55975b933cc16f44e1c164df514e54312cdfdc00d3604a58be0a732747032c00c8e4b23bcd09e2419abb2282184c5396e747506796a357760bc17c0c903c0aff2f563cac8aa4a5f014b52a62a967d53b5468e20877dc5650cc4a4b356e78f9fbd2eed8b547fba848ba80db4f1bfbd96fece4b0bc3bb1eb75c5f6f1a74627acbac356d44cdbb5e142ea18fd81bfca5e438bab9589509eda8c5e1918c39819e8a753c3a1fdc22839155564c3865c6d78b26349523878b688e8ec80c9b2da23374a046346ed1596492c8b6719a6ec7f87dc5a647914be76e52044b350cacacf440eca3ca1529c6435207d6450acd83c869d53a8e6b4d69dd5922bdf992ac041a6b2b865266c8c1fdd8d4f3c43f699c0de177513a58172e40e3a77a76d2fa8b53bccc32c777ae6f889b22d4baf8f6ab84b798ba1d0717b7c92b1c1aa360d57c8abf6783de880d301aec25cb3d8971636e99761fc947e3729b47e0d64a5ef01a35b56645f94659d344949065491dc065fa6c56b49aa98a2b6b969b75db3de3f0c7a2c17ae7859cc9914166baeb8109088c5e5383a6e282d1d2b38d64f52ac33e20201bd967f48193afdb7f7d2c8bbf2f710125688f621b0538453b786e8d7c4950dfea4c6102a22e6af68eaaaaa0c952730dd649383dee86a7bfea375e41689c6f6f1912633b54d187ec1b05adf86e1789abe5d4bee278d9bd74f916a8ffe664bca7252f29172cad741798493c944e5bac4766cdb1166bd5b7cb3cd33314af8befde4c27b4b652d60db736c8f509471c9c58d4c417c180146da8133dab7aefeccfa7f85a4a7b3068724abfed852d58052a3a9eca755781392aedd46505adbe20432d2180474fd27479c9c7425f9a4f2e3121516c0f60161684229642d79689c74f824aa101836426cbba7705050ddfa41e223223f8300ecfb1731316ee5f88de5a23512134ac56d0d4e04556add62f1a17a78d41a7609158e57efa89fdc9182ca76ea8fe4f3d9c1cb8627e71edbe8b82ee15cea6e70373cb2f0dfe07d29263a834c45bb746a81569ee01f647f7e718aa4860f0c41e8b41a2ba7234f2b451e5d9e8c5c44b122695139b93e7d7b544ecc45344f245fe056c483e55f965f7c8b8bebb5072e9536fc627ebea50e59a754046a8030f1eefabc3ef40f53c33927b176ac41f2751343226dfaba65f4c1145eb0992b787a631a69f511efcad391b997b39ead4fd919a010ed542ee97ae4bdd967dfc3d111a405c404620a3d4864382eb186f8d106e5a32ec8311dad573ab28aeff31b8e550a2ff5ba83f5e741502b10260721455a0e5d3daad14f148e1b442fd96f064d3c8a207d099dbc557ed513523fbf6f5f687b963e2b009ba9fab4552af15de4d9b246fdcb5c7c5c170882808a72e1d65d70814cfe5d8a9cfc3d74e3fe73523580188691bff874db055d2676cb17787b3c940e0f817e885515358590375502f3ec1dada5158aea20ced1d56b0a579e1f9cbebf9970f65a23abb2c70d82493698e3328128b9944c4f32122d692f46d86c477371f87d0f62d68a48424c0d94e740a89dcc174c6af4f76fca16fd01309d496686d8b53e59e61d5a7da897d1d44f4de81a8ca71c033a8e4e4c9d48dfe3b075fdb4977bff8a054c81cc144132147ccde1c6cb33c6df15ff742a44bdbd010ce1335427102ecee91159a4489dd0b0a6b2f61b4b51bf7a687254304dd5b74654f942a29b526e22301d24f65a4022a21187c1d9c1348c9e1869a5a7ca4078f9e909fd903c673ec6f77707ce0bf0f46b9faf09230fba665d29ed6488202f1a8293a94501b206803664f4cff5623387fbd65d0dc312d317dd4c66d3ae849b6a3e62f3a11f3db150629fe53b7dd61ab83d5a987fe4284a91f5eea619b2f2fbfd7b4822e9bdbb875815e2bce6718def7ee66f02997639ca62a0af1c72aeec68d773142cb49f3ff58a2f7de0e172bc41849f57d861d4bbc1e0e85776c915f7ed9cae00ae2c3d190285ffff4387498b24cb3aeb7b4b683879b14a169f4edfb53933b578f9fa54d4c7c0c379c5aa28f92e308f00e286cc7badf2570e2d3732ba4fa1c2700b519f2bcb9096d2ab9d909b94c7f9cadbed34cb7feda61a34edc19394e9fb2c81cf2613ebc29285f431e04682206f7f90aa4dd8740af187c3fbcbaff4a0dcf776cca2bbb329ff2ac6b044982c7913dbccd61b86421f4c05d59b506a596cf17d7c501e084ae7c8b7720965ac8b664cecf923ca61c8271371fb58170ad69b767c9373eb179b91496f6b1747a51be1fde71e64dbd54a789b757492fe4e443b578c7b729b7ce978cd6057805e1533a706d6a80248f230c9df6f9aa80dc3aee09fc49410eacc4f338515273d03fc3c59b9f92dbe82fdb335148d987ada07d537b322cf98a190664593c2d538eb947338bae96cd991fbebb4928e3760ab63bb09d36ee562a3102c65d6ea61d0f1d880d82a568b9a7536f7ad5a24a8b6cd7a408ae5c1e6d884c8c0838ed2091905428e6476e37b1ca9da826955e00c675816ae2a7d550487244e70edc96853a50459bf8181ed6efcab48f5173a337dc2c76b936cdffbddf3595a4ba9df4f822b30f168a8784feb49fd224125a9fc8978bd4ec0500bc251d19d22afc6836309850b5649d06aa83648dc03c29e6fc980682dbc214c43f0e5af9055c2ffcec47479383acc38251fbeca3225b0bf61a2c622c1d9018eb28cf4cb0a2d28a2abe367d7d2ebbf77f4bfcb3e0a4dff5ba671e00c5504224e249bd486391e1998d0008570af84b5bfbff31671f1d4091abf1edf2bf0484188c1479b909f02b72d3f402626ec390c881b2175363ad2e31ddb83ed70d47a0d0aa2a11a4190a2a56493a1f504ac750f2f64e6195b992158c49cce23a5575f22d6bf5bdd7911d3c543c96024f5cfc1e61fb39e3c2f949d6acf6546b971272e9910f7ea3e87ee70b5d423dd15253eb11778d05410e21d734163e2764a6f536a4dff49225649394591a6d12f800fba4c1181c501f855a8c65676bdc651a2f336c946ba792b97392e444e10408b58e0117f51675c3ce792c907627396b40a714b881d4c056297fd0125231cf7e370332827c6f78131dc733b87a14923f33bfc4fa77af50016f7c2b93abf6779166fd87bd35bc2d730c910ef9d8e51fbc03e4d2a57f147e69a65747855f4674ae6279385baf3feb683b55a19465d8bdec90b2363ee57c9f116fcb1f1ec2ddd8b454d7892b75a97b72720fbaf70ef1433bcdde7094ffbd026f9b8d19d14d5afc6b0faa4cfeb1bea6e39e9f3483c9f0057bdc5fb4939855fe46901b120d6b7adc294ed9747effaec7f104d2685668c2386c9d985d39d946d474116a06d3f99d9fe66ad2f9bd3046c3f565c5f5c674ab9d3518c37c0bd7c8a46cf1e2f174b356f466a5c9ed714cceea7596f11f8e1836f524550f86a1efe20bc51ef0d41b213318ad1e3eac3ba0540a46d2c793d0694291dee91f7850aca20abada0e285fed1f3127c877ace83d212d2517388e67bca873bffa01449a0a614ec8f3fec684a2e6fb1e6175bbda26ee9c199932a2d4c55a338fb58babe8d295f55af931f4b607d81b6eb92b6063a500fd19ae5b64b9343bd75162f91e5ef27a0dba35bd77b2ccd46955d8d8ed9f42e1818af50c3fae833b7c72565a8eb54fbfa5eedd86454275863a57945d2ef46e9e5d5130b4f00b534d4101092518c8d4e9d13097a13dc4aa3952e477cdfe8869b366cdf9a767f4dd1caefd22645643b172b3fd3c87640d8495322b3e5caa1b007967421acdb436edf0167d236ba946f4673619fcdc80b6c9ff6ee18a461e2b7bc94a5b67fad2afded30b4920d53321d164bb1a5b60c213a4f3b194cd0a5f97b09f10a6b2924ec4157c79600248c8a1eb4443c1ad9333840273c1c2c940ff8d77532163cafc70254d2443443f75d3657482e40ef242781f0a3fbff80f465f06e6fe862927831b2dc36c89685174a0fb2e22739bf10758756574d48a9216c356a0804399233aa17c8ee4f3bd86a2a5b55267940451fe760c57dee22f972561b85c398886ec14604a2591d756a90c6c7bcdd72b4b86c38199b4c8ccc963a31d40682ce8a77ad1f70889410f27f09cbc999af3f1a1bfb8438626fe803496e52463d36569d15f299de8c609e634ff673ed44a86faa48a3cba146e59115f14cab93accb59334e0991d9ef88957630d37248c613bccb3ea91b5892232b6f61cb4348387cbdce397848b08275a229472bc2961fb767d4dd6e39af3482b62d8b94bd3e721da1ffe3bcda353bab3ad3feb67802cf6b8a9c9d42f1d8e661816bd544d856c890106fbf299bb53bcc56108b587dff105437bee06208b5f41042599a8d52fc29e8a1dfeccd48f48db140c525893cfa6888ebea4e467acf1ede604e69c01fa5d7a974a0d2b7cd4af4ab0c55287b90bc2a1c2c77e7fff5acb753ca142d0260c89f484f1af2907df6e7bfe5408d037c9c9809d9b919a4ba19a40a285b6ded5467f3c2a77532d8d04f8e2b1be7b8fb56475d3b43dd3fd117e4f9b8f1213b60c3bb5fbb7a917c48201d32381368e5aadfe2af5ea39fe2293f7ebaeaa1c1ed43bf622995fe46742a44318f9e42cb31a99f3b9a1aa1df414496a92093f2fb0fe2cd27543f90c6e3b3382a32fa3d03f46be9f4d09f27b7ceb23f5e9ca4e95ec03ff6eaa8e186a62c018592daff06544b9c630c8f31f33fc54d0721c4bbf2b5f84e01e8ff01f5c85af4ef432958768bb4de60cb74cc92289e197bcbe2066ad47b81e74bd9b413c08a6eca8d85e053897a951f60078823fb8f9084c437d2e264fd2867fa9590252869f1194bff206d885997ddc39bf4f4949208a2ac439c27c79d94cc02f12bbef6147899ed8044376636c07a5c5c1f5e71b6dde60c347a221f3a5d0d0c76bbb069deedfd0ccef72c14559e6ec5577155d13d724bc847eef9e9ca219971e027a3828ec1d5d42072adfcd077c206006b18c5f37b14d3fd3155935aae72e8d8c2bbb77765077b737b7d7acf0f605f5b8a74018b06ee6c108b7bea1adaab1aa486cbdbabbb4c3e3387d01e430e09f18635bffb70a887412ff3d7ae650ee5a466001fc29c69392dbf71b5a7ae48818052d79e33114fbbad060b23e2eb47d84d0826cceb0d8ff8b5a4b53f157e58685366eb2759849bfe152f96e669011732e50495a6e97b8f1575cd6e373daef0288aa60519e288373ff62002ad8fea55f9d8a6841e6fb0022557d64e0ec908ab25050679154273da82aeb54a90667b6a69cb4872fdd108c084ecf03e2f65aef4ab0503d3594b0784573b6e285d39f4cd686dcf302c9b9519b6c58fc19b4dbb72501618c6a3eadc2ce4eb014e4d5765c3144f9b4cd516464a336287c950a70ea61f7b86620cde6aa2878c35fb5754cb2025f5913197f9c055b8b3e3857190ffed16f3b2b91d1847592d05e16207e8ddebf4d8a86a84728c83194756069b3d003300a71a1ebf824736ce1d4d4c8be0b786f38c53e5ac45d24629ba208f4d0185939d3414c502969e38996b25e3d4538b79f32bccbff30f61b4ef61ad6c9796095769b4fb9ec7ebf1b9e8d852bbd6b68332d55b99507609b83ac983b693bfbd9e97d8ca06c788a873088bafa426d6b14f80dae5f91b0161b40a58d751f7102e6ce9f66f2c510058b700cbe1e45809875c13a9115f108e74a4d80fbb23111812694a09ab96d91e1f2dfb09f2bca0407653fbb7503f459a27b5d3015bc08e37b479f3a7b7bf12b4b7f7d822db054a3bf476c30bacf8d71c56b1057bcfa249bce56ac68fb9116163e47a6bbdd8b3c1c80643cdbd84c5a40fdcf013c193198e5009ca353852a0cfa3c9f36c32d1cf5dfd4c30ecbca987379761b0d989d622bd8fe7aca7c427dc9e9043254e0c4576fb83113a54235f1c3d33d337ee99fa27a90dcd0b3ba291e8455cea1b5a2b205421bec9c1d9eb8c705f9ace441ead9df295d784bddaa3da949e17b63dfa645b5ce62614b8edfa5ed4837f95169fd8a9a671e4fdec1fdd59e8dbc53f4a0cf705465188bf88ad9d211c09c6b5c1b3bbab189229ce4433865af2fac747145d12380fa2d6b75d62fe38d38e4daa4f866516667d707c84993b0a5b1a399a2eb7521af51eecb3aa99aaa5245a375fdb265e611c2de7e34c56d86a0be0e028271f4bfd07eb745331692054cd641abb235245767cf30f44b30e2e558371c13da3c892f814491055c96a641c9e0bcb3430e48e719f6fe2776cf1571f4d1b6adb219236d5e75ce539583dd7b4815e019bb8bc49e9f61c03c580f9a11c262c60e4ef9e53383a3c39ba2faa260981d6d1ce788b7a999def5c8bbfe121e37e40609cb1f596053dc68d1f4126da4444010cd68e2d8d546689b3fe050b379e791a784de0e0df38083ffdc300e1733f72a6a14592697ce408949af3ed1d95a4683b596a0d9b3d8073ca68ce0fb301749a1ba291c2b8c147c9ebf65bdc87b482012aa5096a391d274638299806085c95190f6f2180b43ce722b79e1140ee503affd34e3c00cdd74b5f891bb443f83774d9f5cdcc27181c6a62da665783f23712cd27c673bc17d0f056c2f1c35cba1ee29c1a92509bae06ed7762c5f97e3d6037ca69601787f96eef38bc8fe2dcc4aea94090345187b533ea2b4f68a92daf10b8ddd4d40f906227e33bd20aa54350f8325c8c7fa5a63a9840b0db492629174a0f7ccb5720ac8f326ac8c1aac7122443766ce28f5d0a312dd387788eaeeca14b28a7ea291a3230c8cd7e6612b5eea3fc22d5d6c6cf57a949aa2bd8c1b6bfbbb8eb158872bfcf4fb5e5467aa683e0a27a0f5feac36d610f18a0dd0a04ca26ee0e21b5cef0e273c08f68dead38198baa021a7f79bae0c00b8337f844b0baa9f13269641ec73ae02a69de27f604c5910df1706c6bfc54a01d88762adb1942a5e1f0fa292be3c3ad12307aadcca59841ed7db3b607b30115466ffe1f673301f357db439b63921b97736899f43f3db97458f411642be22d4c6dfd1c03066f7399246209d581bf1ab0b7f2c9f3103d3c2e931a40e2c3eb63a048ad6cd3e74cf18aa2f9c6baae36935673ad9f798e399d3d4e26f5dadda85dcab6ffc5be3a7d935fd7dadbfccc2e4db0abde1882ec02286fca8a1eedf9a0a03bde6cf91af7e22b9b20ef3130b6dd5ad8fa6868433d0841aeae8358f49d16cb11d28769ef076692807e0c0cc0d0b4c05a46104021414adeb915885d4a8006da15d9bd6c9be1ba618b353589be1c9a1349f8efcd110d85a34ec7b8d13eca56a1b6089962e41e49da4bfbfc8574ba086a3840204482515d83248e9621372282ce6a5997584aeeb885a05476231aaa21c4c4a66b97eb2f0bf0404c262d587243731d085910f9c05fbc9ec4b3804787cc299759c4899cfc9df41b7a14c0b18bd89e83f4645fbbb90c207a7dd30ec6aba16df3b5a92ff674594332b00d9638bcbf6cca9b3de9f2336b04cd405a9b7fefa18af21cbf764f55a75384e533247a654fb8c5f34d14ba001c3cce3981de20b553747ee1752c4ea2dd62a4d2d928532b390eded17c509f3826acdf5b5b905bb2efee57cc18d57f94844052d4294755d789ef21b2e34f05940f6c99031e7b256f8b54993886bcc4d22290aeb72c87ab77c661ab5cd47e46ce1d1e25f0a41738cae41befd651ff8920892c97afdcd2c5d6553621e18052bb92056ea47b4b86d912dccbbba70a9c3ab5097782b9df5255f600f1ff9ae3ebbed68a7569be871b8e6a62ce313270b642e1aa60827487cb2fd97be6bbe985a4b25c7ca023718f0d39285c91c4132846e5435bc3df613f35fa041efa1c5523ca55f1556895a5a4cb64ea962d3f703565897da3df4dae4eb633b9522eee380da00b3b933d1c4b063aef677c92d6309ad5c3be1d7a551e9c08f73e14cb208fe7f34507379d9bbe79b455e09ed7ebbc5eaac8350465d74851b219c0cc4ef532d0d601990ffd6b669042234426ccd7e7f720b22656a670c7b5952f73b6fd8b305cbe262f146a3e836ab7238988ea15ba76ad7ea85a7c0f21ce2796498e75e4ea02405a2db4c24172db610c66cec398ab29651db05e900eb5836e79cdb64d4a8da59aa59e30850249f95928ac3f46d3b57108e550dc3f1ae88297918ff0e8c8d9d3a259290906219f828beed6dbd411a20172ef048b6f37308ad05eddb201e8a3fe066b4ecbdbd8b1dcad2ce38709d5797677498c56b09e113ff637d65ca6d861d3a6ec3d285155bbd5f80246b6a9d9ef5ba1c52bc2da184f69c2baf0582d68b3981db90c0c8ed42bad6970f453bb5d80fc450caa04997e2e018a1b9f324fd529721244e7706af157219d769571cb66db3f6f5beb531f6845f28b07fe793140f9a09916e06fac50dcfe3d6c14bf25dfeb5eb7e6236402b8b0fc317485a5e631034a0ecbdf65fb7c53ea6984daa4e00f45d54908080eea61f2083c31600a41a6cf294be811e43b694fabdb128d4a29a61219b1bb2414fc3a8dc733f3961ba1c370b67ad3fc7bf5548af8a12ad0076c20cf8403c67fc6f9e20d472bccb4d898df24042ab8cdfcaf835acfe86786c7363c6d19a10790beb320a2eee7f6158b3a7487e29565d5a2b1069a4c72b12cbe24af43bc88ec767f24719856192717f2186bc9b8e7537f278aa6d7e4bd6d7b5fb84c38b05b89512d4e4c5b22a52e10359f35e0e53573832ee0f232a4bc6cbe3492f8636a515039dd1dcd294faafc20d6c02f186d8a012697e4d17cecbc72d9bea4fa7e4c6c90138e191a372f46914e37adb8a6e83549e40b1b435eae31c5a5a5b91587eca44035cedbf5ca3f995addcb7e8bb767d1b84e1ceb1b6673438b38d3529903a176b53e22a40a61dde0f3880ea3bc9edc581527138581f4699d75d67274dea2fb13108b9af6913d6d384d5e0c7714ec0b8f8a4dbd9aa98a8f79501e9873df95236d48abc8fbebd2cd5a8daafa76e36bbae78a2c3cad91e78c2dfea201c3dfa41d6e14e35cbc4ff4a6558fa60470bf449e890b6d8f1ad7eb3ce12b4763b15af8f22dafcea9ef482a5de693e740450b730b901ac8884119f38738d8df02b1658fcf9d58e681d45d607f16a02af4f2c5700378ddcee25f770187d82e18bde0207fa731fa04467d8215b82ee7ce2c2adb4065c3f51f07abfa1a83388337232f42ff9738fbf9c7d75fcd80547c74d362c6e6fbaa761f4da3b17370cfeee7ad9c76d2e394cc8ba65935d369aa2acb9bdd01f4b87db545bddd6a9c70cf1ef93215b2095df5d0002b291bae2b731f91f96980c9ae897ca62811b6edc3721e6c286632ea937984e584ea84eee46f3f96455a51ed00b262c1eaeb7747d822946141757200439b8689f508692cbc032ae91f22b9c05d58af49fede76be6053370a640a2fa85ea7b119a1e748fd9566916d578183c62596417e9d336f1f84106c5507e086daec4547de95d9983527e047479d3a1deb2dd9042c9351308d148c4c10f12cf4a2e36c1cafe11386cf90fa8050a1c62e23c4ae9b12d581de69aebd14ab65144580bd12810817d8fb9a250652be2811c73fa51b7ed9576df6e1cc373393a1a9bc2c746a8983ae8432de0009997bc09affcf4a3ab56b5f7ae76921fb00b7b77793a58b71c8056aa1b89cd75e7fe688e1d85641a920bc5f95d36d38371f858481e111b995ebc8e2a9a24e0396acb706628de985a181a96a508517dd933dd2bdf9c75987b4dab37d23d91e32914dbf2800f1f31bcd39334f7f7a668c2f2ed2c61dae9a23e22cc6a85b3141e312a76c273ee51db46fab85c4dc461f1ef67af6502101dd3dface2ce2f337362c508d62ef0a4d44e358cfaece7088e38049404faed9b3202fcb74ebaf2ea7a525479e029cb76a7a789fa5e9775ad665287f925eb84b04618b638510662b57f6d64361ea3e36415df48a3545de5a72e8b691d6b73f548ec4b272cf56149bfb3221cacff0d7fa0894d3281792376528256e7291e291348c6034276e2a68d926f590967b7aef35da0496e5ea3ee409f394869c00ea2ad206f9900beb5e4a84221637abd64cd9a5a18ea868a3abe69eb15a7c65059b729a91e8c29bea87445235f6d93c517e78b6878c6d71e66d38575d30c37cc74f992dffa90f71f5db862f9af5dd55b614c5957935734c8fb05979b4113b27e2e3ff9fcd7267c8f92c535facacc3570494ac523cf13e445e5ae57ae93c8308934b5937032306747611d6cdbf0cf3bb59fda32ae4572b585ece8c43ef8c8abad832e7a12a913b674ed2a4005916cfc82ebdf0d1e1eab98af7a6058c67c4b61127ddb7377e469c917f7bfcfbb2c18dc6c4309680c5a1c2f07d9b4723961ffd386026d5b1dab95898d70580234d8f09e20e4e6040ccba8af50d39e1d59088f51ff99cc45a244b66e34adecb2dc06dfdc85c631f94c358ca49e176482fcf1ecadced7acbda88812f01077c883840b0c26b17cc58f258a3851b9d711280445cf4a5c92be42f716addb2e7e3ec40e788354578a153d2bccf468634f4740637e5568c138f23db08d98534215607ae4979f9a2e5efa4ad8880d1e572ed64a9f39dc13861c278e3e843f8afa156bbe676437cfbe35adcbb4a273a2ffea72ae1b6e144707829a03c028d9469fa54557121b93752edddf20969bf9b95a3d77a3f37c3b6e336555cb3c96f807aa3e637507280a945b6fef779c1c6d57665008634135e2bf0b795f993cca30a297b12dc28748f79b9327d1372de5c06e3ff0a7e2da47b8b84b09372aa031535d3cc41e1b55594ed9bd10ee09c4c6f27a924604181253c5392a43c180b41e4149bbee51c65ec2f1e5ceab8831e8e51882e636f9411f87c5b0f9b990aae34689a653daacd89c4dea5093d392e24f560dcceaa5a362b6d35196d18851a1e9cc3be75ebe7e476ca1b20050ef7525d9cbba863785b240880f7c8e97f4283491159bc870a48ec1797c233838b64f3c21166524a73bb26af0fb2f06cb69cdf5eede5160cf8bca6b40c2175d4f6ec998b5f7fc6e5846cda5da06612702318c9271860a8454044658b4f93a6a4e8f5fe680c900bcdecaa93a5f03438eec47c2f830e995740b174f1b7ff9e0d1849608072166bd5e0c76e4ba2523fdc49538aa7ce2e8380bece0d186c536f0ba9b9e144255867fbd8bf2ef96a56e83998b64fe6505d6b7b4728210a84fa63dbd842dcdc3d4a706d85df3480855d76dd32c8e8dc396e7e793aba8bdec91f585dd23400f6f9716a68289da43e64f61f5e1bfdca80dcb4e434e919adfc321ac0c2c2d6eecdc56b6388819ef4bb477998f9eeee2afa0925a6b6640f074bb9ef3fe836e8ac6f8a415c1cb66b8ed6a5164e06c18220c912d40b8c08e5e8b94521d43fe46749d6f33dd16cf74877a0a66f43432738d030d763f324f3d29d0bb32c8736cfd04f782244d1dc1d0011d20afb166dbd9520b28298fa85bceedc7948a74a30840d974a7b497c4af7cde830e21f8fa95c8cfa40354a992bdc9645080644c0b6151a6e616f246730464091cf878a4bd5e4b321df34428f63ddfff0a79f5d6817a3b5f3005240bedac97f63f83e40d00d8bee941f595dd5fdc73a3be308f8357f9de3447db820dd2897107dea45ff56c5a4f14401a228c8f0c7f3193d35a134f25060eed6a7ea88f248ac81b3772e7a569bf5ce55e06d59bf03aa5fe57f74dfade2fdfbd4f31d7894a0153a9516554854d5a5c5a9ab13474480ceb8e1aecc0075b3b262ec6711a0407ddb6024c4e017ef8449745116e0e63ccdfbb53d8a704c91f7823590a94d447bab4ee98de6edf3e489cbdc2fcdfcdfeaf652f45543ee9a5aaa1e44a8debae700d29d9e3d93e412b61318bd15ba11e6791bf2c0cdc47e3c512f57bd34466cc48551a022882a55a5115eb17f5ce84099807815837077fe396cca627270bdef5cf4531daca95514a7dd0a13749e3c077ddbee100cfc2d8f3b8a3f6d587cb930a654c1b7e66a10e89bdf58f50a35025ff82c84944cef146347c4b3a8360d02e7767540727865d87f350b378d947319eea398dc03694f1005ec46542f21d073a5141927041772ebd621dcc0c15acd12b45300ae342d4eab7fd813ec4f9968fdb24796e2d6581df2089b229aa7129425caefa3fe54e409915801d116f765ff07cc2a6d1c63a1e645d795e77a6d9a84b9adacda875238e617365d16740f8fb428b97f256bc58f0942609353b462ecd6ceb7c8233aefab695a8f9c09cf022eba4d33ae6df18dbf40d88cbdc7a4548add67a50a74e8f8d479fad5396c3697a9fe2487541386ad082f58167d253ffcb31ceeda061dd49f8f2af09a1a587627207e543ef2df9bc0140805f90d3d77375e9ed97d3b2530fe0fbe66af845964df8c298939b6b0737f787e68ebd32db97b0c351cf7ef3105c5421be9e7c963235f3e35cf704fbd2e0f3805c5fb64ebcafed2d1e02cacd5df6edad482c6870fe39057b4316fa62783a7364804fa7f76d1abdb6357c5af45117da512f153fa9136cfbfe161a5ffe8c4fb9d14e58b220c7a6bccb49e02e6746e002b804552eb958a7fc8cc7471fe3070250070c9dad4bc3a7645ae6d5e819a283392de30393f357072444f4d061c9174f639c56f218d1afe43b5e3b7cf8654ad5eefef263007f625ee98db54a297218b0c78a4dbc1cadf7e22d28c028e0260b690dbf8bb65b680a1774b035fe74ba49549f9d39501a7bb574586b2705820767d3643a011b848191ed59d990cbd0cbd24d9a9a0a642a4e067ee888d1c0ede4e60d2449cb6282481f6b3cf163a23655981bab66c60b4bfb657d008b4d41ea575ba59ad3dd90aa4208a19a798aed434897f9f4798523dc5b4b5e4d2cad96d54836b2ae607e41bb29ce6edf98d3d76177aba620b6799606c3901eb50a0a0b394fd71af69c57c46bbb9f4e4869d11b52297ab32630e8d1b0e1ec30be2a1580a48aebf75da06cff399449dd12c6cd665e8775aab65242cff1582492e358605cb99828e6452148e38599eebd2c4d8e6edc45630a910e52645ff129cd3f9493ca6c1a36cc7f43efcbfb76859f955768c8adbb36bdd2bf60b9130cc248837342acab5df2efa0fb5b4fdb11989b3027026228ad298f2cdbce34743eced7adb78eb7cafb5d273ca9965bf072a9bb90bd3d8f210734be8aa4e27ddd01eba5aa11aaa216f20b59a849a3beb2f35bca8e26a72e78bbd5204e3c65f125b59076ea658a805aadcf44a028cb4a94d1392c1588c1a58556e09e5881fd7e3697b57a4fbd99b9df8bd440786f9672c65741e550c7810abeae703dc393e390f9df0ae7cfdb1a99dbed066cb12925664fd541645f8591cd9dd9642f697f9f166549a56342851d52542a12fa6789dafd94153fbebe1d7250e5b521f7c1e1698bccd7752f869f6dbc1b38ce60638a6ea8fe064828b4a81b83fd820ad2b4d5b3fea439369244d01668ca5af83a544389b9e6bb659eb875c2828d069d138fc6de04d15842c868984b0931a377dd388a901fe29e43f3289f9b9bb9ad1cb4479d8e241679b61f7449e07b310fb64bc4e8d3a452226ffd87bf2db6fde988870f9cbbd7ce0b49522c04d4e665ef06fa6f435cbfe4d6cb62199f7cb55d02d610c28dc7dcba57d864632956dca5c480b5080c8b8fd838cb4fe97879d79378ddeb76c6f939a409f1f4e85400ad2ea429b7d0153d8efe51c7296ce6b9ce644bcedfca0fc67e5019d30f75ca0f8505119401f1d7bf4ae5164e1720f1fbe70737c5ea63857e266583b7f5b6272d670d3f06a49d3e46647a588a35dcb275449db6bf7bc0ac554d8053eab7ed78c1851f7334846feb0aaf6fdc7ee61bcd5c8eb1317a1196bce15235f815819da777fc5607a85282829824dbab15724d33ef1c97b49b907f84545f26a23313c583eb7b80cad4e85bd913de1156ca39e4e0ffae6d26f2a42b0d1b8098ba53a29a50fe00119cf30e632cfac4bcaa685cd28c506180d546037e392245b149b85060c34b748ca233a2c5db331a152c0af75c75b41bf50c72120cb1e919231e03a3c9267b9499b105e02804820bc9226f4e1475eda7bfa81e204cfb10abf2e5361d884e1c5d6daa20c2a19ece2bf44538569fc498bfddef2296cf7f22ed1a9692c849ade503c297612afa45b68d936726420f75cc1d4c72a7151c6e6f6b8994162d216f899f7d426f356d450a2d664a655c546c7ffa50e3c66b78502a7c36ec2f1fd11cc977f35a588b1a26aec3a85eac8a4d685004dbfec7007e0608b4d223497ac7d99c75418b278115eda95b670af18882b87c32a25b818d0fd342f6077c3aba4f97e40d495b6774a645476edd17b5c35904da731452b0dd138676f2e176cf924b37c33947ac5afdb66cd15f856a449b82c4bae8ba0b8b9375b0be4d363b5feff3cb687c706f0c32d5331f29ae35797a9afaa24004796c84f74bfa06311a690b003e6af80fd13ab01951ed78d98ccbad9735993d8378a14206f8182daad9ab75968ad977cc14ea67bd42377c9ccefb3d9bd4a9b024644e1616b49b97cfe533c012a836eec49f32a5b7347429165579545a3563b43298678bef5652d46020534351b0dee3a80669b2d4c3c44012aa665bc9a7ec4fa9310c84c06893bda5ad07a17e196a03623693341bc8abd18b62e328b5c768b3215cfa592cdd2149ea5248cc10804ea267cfb4ce9df146c66104aa8118e306abfcd5180660499e28fefb281a1ee868fa7c6503d424ae64461f6d5ca738b18bd3527e6ea4601f822721e45d2eeba91b339e00a17bedf7dfd7996b2d5bf73c48495debe45fc1a43f7eb8c124c43451475ade53e9e21fbeec86397442bd97116ee9368cb82b1c5d7a95c72aca1d137116e3808aac4b06a9b151b17379c79142390ad6789212bb89f5f15fdb43ca705568d84661f1938d3c71f5aff4c1f1eaf5c8d51376a75547e748ff6ecfa5f62098c78c905e579480d705ed14932b840cf5c31e83bd1478b702ce5bd9424a1dfbbcc7f684edf2490666907f6c355e34eabf6c8a8148a3b9b1f1237b84da58349153474c4204547d62c8f4e12849aa36c797740509466ade1432cf19d984b1abbbdae0814b314d0f87c77ed824f050a209316e9ad639a4c64cd0882862a086d7e87ffd667ff3f9aca451f4a5fb2ae209c2e8d45b06e12fe83213849b5521ef81071ff935423aa7ef7662cbc7e3628447ae45c6e34df663f7bdf2da40788c7ec68ce3d4918a6d0da8994b82e67c1a13450620b26c43ba53aac61123fed3a2f19fcb2632f4c43dc67446488b569468f8eadaeb1082f42a9388d39b1e4f2d484779725e54f444fc33e14de261bdc9474ecc3dc0947c3ca45faa76284e5d1a70e7ffa6e16d2f5d0d74f1b673e9823ec317545354c5ec098b2269e10340244cd6b65c9b39f380e24b90bc0d8669f171e60e6ba03fb60c44ea0d4b84c66bba0aa6d15fdbc5c2554de97dd306e40d45748731ea88fb2df06426f210dbe5fc7c4422ce8a9d039ee975aa410ac23d7492910b7eeb41e87c8821888f23af433f7de4c1909bbd62a029ce0d7957cd7387c6571c0fac47fa2eabf0c1f61f8e5d37b9f7124ca9152af113721f65101552d9079ffb7703d0deebf1f4ff30a44d793ae3b75073762696bafdd18106f5b9f929d9df55b21fdbe4dbe2b2b6393ef715218f2761832c947ea7d3fc1d965fc10a9e40f52f8be02bbe7cf9271f2fbebd9c3538e2b9a0b7f3546832893faef46afa50e2bc38b16e420fbe59ea1d4b0e0f00dcf5b741c84843af3d597554c1324a8c382ce0cdd685e3d7f27fbaab0b8c53fe1548f0b19ece71356fc0f9ddebf5b95c7b5eb874ab568a70fe5ca1c6463a8a579cc7c6243a1c11dece6014f0b9eacd50380e380b9f3e04bf4222ccff3fb403bdbc5ef0485e6c743cef331651b240f7fc4328a11eb952ed94fc3e46763c010378efda619d87f1ffc8db22eee13b2ad29d1c0a07b915b4254d6c69ab075da3cb65d368c43ddb27e842f9367167ed683c38f5443ac53fe18fdd1df139d511e0fa2e3f3d71383ad644a9301bd03db97065fa23b997d1e3b54c3106f60bacccea70a87fa88a706c8e5446de26faca66e8e93b98ef0bdf23de2f6b78ed10e681a6e3a48cce83d2077f91f77a0a722969e7b6329fe66f68617737e433eec812ad9e1433f0ea52bbab9964e2fcc6d00ce6c6621852991d1c36bb01c3548fe845a583d005d611ac072c290cea627d853bc47867ce8c2e8bfd66376adf195797c7dcd590c5fac05bec7030da907754e3b09ce8d283b1bd90272548665d3bc787fabb1843f57c1b014cc1f875b348e5fb1b13ea43920d0115666d4752486ba0f31b2f8859b1bd575fc6c49799ea9879b046e790839ed7a4a272667f490f9463461587811081f6ccd0ed8d9713b5a34760289ea6d49970874aa29f06a91dd89b87054d720f8d0513201252c8b4d968a00a7aebb421e085c4d7fe2e427345865e58a7faac009ea66692f0c63b0ad3d10fc60be45fbf3ea7ec6a92bb44fcd5f7ac44fe34ea2d24710b5cfd75f4399c752b10ee9e12bd6d78d1df77134a2e1c8f32266f3f1eaa4cbfee5b2f55eb24c4d3e63a3ac3ea207b0e1aa87410b16d87c6b26dfade4749dbf7f40f4d5bc2ca6d13dc1d05c7fba23f5b148bd9241f1b37bc9c383db92948ea637bc6d77c0110c47d22e10ba25259d00bbf8b3214ae7fecf88747a9da90537eafe08dea6535603d79159775c4f387de8c459c1282bfd33216e594de0a10697b83c81b722c34e8b881132781126a24e4dc0b44cf3e277c266c9c6fe8e06b5c365c1b3438aaa39975b0f05805788f86af4713f6055b73a1381d7d67aabc97418aa2323de82d58f5e6ca535bd6b125192a046d173f41e5e36532d35dd5baab9daf59013b9a08ea81957b2f3207193ac0bcee4764e7d2c6907169709eea12ecf2ca6166aa2c0abf48c5f8e68f9a47d6e5158375b90886380ef0d38a525c439c9eebe1bbbdd1e283c0a3db1028dd9e7109db1ada1af6c81037cc8714ab97db3f6efd82515bc8287bc82df520d55fc638d4091a48bf81156cd57772e03c6c89b2c5ead3cabe177055a2fac920e7d5cafc15a4f1c06a176c43ab64c2c6d2f6b260a2adefc0c03a2fcbaf1987bd2cfba9cae845bdbefcf3d8dc3192f07f071c5ba7162103585a904feae63f0bf1a55c5fc82ed221c140b1bb4139a76000d182202770545304df1cf8212ff7425160ae5debc18fea9ad7231d8a89a298be7227f37ec16cda7162221c2ff6825552d14cc0fe27d49bba100f7273d0229262a2691c4aedb1f3ea9e60768d5fe9b390981e5a263059cbcd488322a32c28ebcd0d23ee3e7651b848cc03f3d9271ae2015b537dd1e822465824447a43d4f1ad3290a13ef5a4cfb3f41d8397f0977aa6f787d32d62f0882c8d3c5e1fe29b02421d85b6ceea9b6568e44392b94f344fdc00a57d56fef10f308631b195f0eb83179f9c03530bcadf8421d38f1a31d5985c6ec58c23e83df833ab787214f100cd51f70cde3a4517e8a97bdd7704a0adb6336e17322d49e2f04f1423ae77cc93ef6d63a4a85cf135e5b665bcf1ae761f44886e6f8113c4deba9345b76f1d273cf2749842d5ff5ff283cd3039c36f983ddf51b79cdfa6e5cafe84f53b25e715f10c21490180e1654afabdbc43560fa04c3aaccab88e5d0bf235aeedb630e3bb933b93ddc402f82efaac50b02c1d03f5f8f84aac554f41a9e805a6ccc15a83c54b0ac87651b980f10d64f54f9381806aca3da0c2abbb1ddab0c781e24538bd61acac93e9deea8a9dd73a9250d96d87b827d4b6f5c5fd3c6bb1d7f80bf54a501bfe666e44d8f82f43065c37cca506889be56029881504c0a3b120def359354f27d9bdd7503bb3d7625121c7b9c2645b6334cd80e477aa635da24abd9c0753ef814ede71ed0ae523b01d7b9e92cf6e02ccde167742939520533bf3abeea0ddc9f57a7943abc48f4cd1db322bdf0b2bf72ed565afe97c24b3f8d0e7992d24612367620be3dd41d5e1cdbd71fd3fa64866a1269e6abdb3ad8e2f78fca5e4601a2434e0ebc2dce585f752ba9bfecba9794b62430e28cd329a786391eed784a3096f9337d2fef9e23c807b796f51c6462da7500980d154a97b8170604a0987ddcd7c36987582ae132f98171aa36b88245ad8251a5387088cca8579489106bd374edeab285b5e249e0aca045e9002a061d7066d07374adb91368423816420b6d2c745cfaf095f864d771f89698b6a19f1bcadbaa4091ecb5f2ade7a2b032925a5556f381d275331ce1d15a0a42c161ae8d1273aa05e47226c79f125e8fbe5c386ebcaf7796414dff48647309da2d3773c059bef43841ed87dc932b8b591438a03ce9cb7ba07172c685de450d4f3757198767435ec52bf22a18172e582e8f99d456a1212cae5f0f3c22af589ab441e01dfd276a43687faa6db29f80ea53b62900d1a54816bb279288c95662f5553508008d98941a73de49e1ff08dd75febcbe7937f1be08eda454d8865123078941ea01e5ceb3440edd2f468a6b169fea30465a47b517f9a570e24a14c778e2a704085c53eb72732fc71318178aad7e241f9d37b625b9b8ef4671bc6f61423ce2ea209ecc1abe00ff45e4c5ab2ec85f68cd457d1fa2b9316565a4c3de659cddce154a697c883dd6f4541a475558818b84f6630ab6f2508f4f51d83a66b76cbeea4305866bac8c7af430a7880346d25919ce97fa1255548bb9245d487f6abd6e84c0e3bd8efe1625797916824f7a082a0841fbd6cc95626fb84667e9e4cc87d939cf94a3b02ee838a1befaa9db47ffe92dff1eb508820fd6717ee7f230c9633616c67aa46fb084389cf676e00fd3e1d8c0ff10a7b356279782d6fb4de9567f66c0c49ee97b3ece2f85f77ffd9fb0593d51f98a564a4aad1ab579d4a86cd76568607b5f59d4b80e98544f3674f9a7e269c7daa98289f083080f75b8432782bbe56c6682c9812b51e9d8d0c0c399293fbbb11c11c619e671dfe258a63122bffdc01ffc3188e0d3d7a26d98cde8a119db8e1e2870df1bf56855a3ca13e66c69d7fee9c872e19dee893dbb8886e36424a0a192577c2d921c78e6bf3bab8262e7b8afdb807553d8ccfa12f8dc847265baa1ec5962a964b98a8af1a95b8ee79c12c2b6b3c169168dd0332d8a4aaa0f51dfb84ed872b174324ea4522abbe73b968b45cca46af7ee6da3ddf5dfe336240af272ccbfe6610b1df7ee177b5c613f9222c1d51d916270e809b213a6983f4ed2e64926ee53fa284fdd747a26527692414057a0705a98a48fb25ecc73411a569530af1816116ff1916fed475ff2e2c3f00833a8d726b1bcf1dad620e0b3f50632e0944a883b8b728cb39ab768d2ce0ba8843445561e62668f9ec9d5c64ae99aa56460c5917ca1e1153b59df1a03b669d3d8dcb2e5823b980d00f869b8c5f9af8686eb56c71d3ede35556cea407a7e9c7428c7a33142072a243e2171b6bb1a4135148f155258ae7ef6f918d113a7b715757270407407f46ce8b43c3aef84bb348439745141a6108a99db764e5165afe812c98d0e650e9389fb1e174fef298e59965ec13edd03d0e1ca482e964fd2d887ead3e6125101fe7755091398b0a2d94a432c7ea0ef3cb0c2f2173547be8532106bac7a65c074d6fb627f409c611e8bbddd60f6a51339ca4fa78cf3965e3be428d2969a74c5fc2fe0416bd954e304a60bddd19bdcb10acf82dca75fe3859337133990dc93484935de6e761c66543194263344427ed2824e0250d115597ac81af1a7c2256380fe3d8dc5c2bde455e573ed0df03de5dff4e27daad99b67d3a06bea56afbd4a108639508285ddd1cf22bc060aac457ece9145f490fc66c164bdf6372482e43b39763fe0f5706b1309de1c519b8f322bea4413a29d4dcc5a96510963e04ea6459391be061fedce0a77cdd589d11b2cf4616e44c08362011510f7680494a56c0a2167fee5197e19e3b0f73aafe26b089b6f3027677017508a9fe9f721a583b3a143c9d696fe4e530ef816cd382033f9b4d812f9224b4ea48e7e2ecabf52a7052f66048eaf572544013abb71f103e2bc826201e9af8667df7bb5c353bab733bca1c59075a9dd331776339df6f2fbbdc85f4870c532412bc450b348105b6e64b0ffaa717ddceb33ad264b66c5315134f77e4392b8d5f75151e50df3b97195f7c1202d7e44e3bbfc8ce6411199b28b4c495eb1e4a6f8146fefa0fcce03599ec8db6d35f5d7c9e5ae139ddbd7d74351b991b48ee7e4dab0dcdaa8b3ea2e2aa6f576b48ddfcf114a2ba076d481d1747dae84d0934a33e2e7838429f8289dad468acf229ec3ad262fc2c9e291e0b50b4a6cae14e9ef8015ea6bd165bb631cf65e2c57ac06934e40bf3b42c9957425f750bd7c296d877b6bb0598728b95e8584a39e527428d19f1c673ab7431ff6b56b4d520b3fc0207a7742a0a4fd0b9015771c119e5ae112f9fbbda7eba56e994fa08bc93c932c87ac15992cddc7f1496a58f67fad9b5b9a61dcf7859aeeba3b44538b39a2fb0e319effd629a6897532848fe85ccef700f338952a0c919c0c04d2c3b8e92315965bd7cee5def32e31004fb4e6fcff99c315d1618b25ad2f6c40f56eca13cb3565a641a225cb377c146120b51c16bfd9ea607bd965b042e2700c24b3b269283ad0ae0d621cac2c7c97c9f24e76efb5f2909bcab6a416130dd9a7e03350e1ecca91e8b4d9db84cc13758686fee81c99317dce95609df1be5453173d1cd1cc1a00a9c59983a8ac79fad3b9f63d24d4fd0a20225e643369bc52ff563cbf14e7b8f8d4e9d060a27f044cb8453abe7fd6611b62e6c96fd85b3f2c03e45c9390c3ce8df8ca77e7346fe1b058c3a8a2a363aec432040962f9f698fe225de9a6e1bd0ee9128878762b68dcfc9d1adf8b5f3bd9509c9d94e2d91ddcb6181ffbc836765c18263746210e3b548f60b660dcd1584d7effb4aac88591fd1084d0acf4e25e1efe2846966c275133bdd7b389426f395e391dd6dec6311f43dad188590d5f478745c113a8b352356c1f875d06872cd32e3d22d16f63b8ca71384ec75fbff0083ac974fbacdbc7c04f508599025296a102cd0907b4bccd1aabe57d8e228ac409b91d1de407c80042837b4465cd52d2f62dbe158e5b2440fc58ec30826e5d204f4b9844a279968411c5db39a9524cedbc6fb7043d5530cb51626e6af9209e9ae3ac95db6257ef4349bbfef5c426415765340619eecc5982476627fa1da64fb506d0adcd20e1ceb0f32ad1ab7103a02a420f56ea00f104a510a9a8d38339faff79adb4704592ea62e2793f5dd5e0852f9e3f1cde8ba753e5853c601512a0cf1beb0c4f1d18874be04395fff31b6088149d753edd0f042b0187b359a0b5bba46b0bfee3bdd2f99abb9ce339c65e448145745ec057d387ed6fe31a0af0de3e76f8996ccab45b920e3b0d01b0049e96d4562cc70880dd5d903a9615f38af6be0acb63a2c2436bb2426b710490b9cdc214b95f600185eb4cc6f6fc66620cb95e2d8245888463fa3a15634b08a21620f50d0f96161899c17c3c331e25064181b599b46d9860b15d9056a511da804058fec0268e09f15b90526d5680cfbfd5485dbc59d09aedd01c4ecd30f73b475a1bcce3d9677faf239da054bf443b1912057fff2a5fde5a31c5de19c25a0f032a2a121b2f6c7496cccabb5c438805ffa6dd5422efcf70736517322bac3c5df89c4abf98f9758c19611a27243ffcda64316ce8b6c224b8be8af691869f233c3682d4af22dfe4af80e7306c588fc27a6fdf6d5594550ad55fe02702187452dfffc1bfb6b44e312a435d7ab6a0ca1d22d1fa1b72eb8d39694fbc21d71da25a4a5bd841d00b978b95ed85cffd8e8f35e22c7a3eae0ab3adf81d9fe8fdf6d0ab5e59b3110d2f0183d9542d348dc304c5b8e95e2fb6ae6e82964c2160595559c5c1571cd28b7b7cc2db9ee0f62190a2ebe5f0f4f34a436cba46de97df2832b950692af29924b860fda708571b0d55df60d8436a0ca76936e2fc713263cb7eec80903c199f3f601d21bf1b0f9f55d3382f651403d36856aee6a7169c28fafb243e43035473b95a548895f3a323c489f63cf79247b649c8ad8dae14fdf8d986972b7158b92a4abce7dda4bbd178418f0e59eea48a8edfd86c06ffbf54af0f303d5b8623fcc8e2251afa958f9112e8030e6e8ddcdcfa6e8e92a12ce455f63b5f1b0efae530c6155107b94edfe202c156726e21d88d2553bbdc3312b2cdc7b25e06a49b94eb8c1e64d91b3a2281c8f6dfb30f11385bfc8a20e948beff166348bee40d9b76b300d28cc3525bd6a7b452404ba84381b8c460a90ec992c64c4fdb2690fb23ecd7a60a8ea1e5cd45c22c8fe02e7a4b3bc284a9df163783709014ebaf23841e792aa1889facc90e618656bfd25fb91415831352fd1083c10a5ea820b428d42f88708d234bbd5737300650ca8ff1deea8315b46edfb6fd6342bd4a9ab8497194110ae0eca33a1757a45b4c25eca50be7396d02c72962508a590aee1ea1642a57eb006f78c7e2e122c15ab9e14130c202278634dbf3683a873f5008c475d37b13dca3ee459be886c09327b73905d7579f9e72d5009e6282d5dc7ba3dfd86360aebf8dbdbb3385eadf5198c5861400e991371a745570a3294017b33274265de9821cfb8e4ff706b4ddb8eee28cad65247c9354f08ffc1e025535ba1450d722aaae1586d4cb8cf9f21d72b41d745010d144da41df34efed57076d73846948e6eae84c11d2a8ace026035a5108117053d88eaa836278ad9142fa6ed19991395de98d47abeb678ddecf65b306381abe983f1abbbf4a5f54862f19c104d9e6849686da32687501c6ebe2f37fae18f4f34016e7e16b3c37d8ce5dbf5bfdb2904455dcf29feeec524b20a8ec8e7f5e115151b80e37d38726e6e544f36a42fa87d35ac9b7eaa1f79b748d097f9ef157b219d6807ff0468136e5d1b948129569adff03acbe11e627bac1d3ff5a0f61cf09e97563ff974eb94b5b87d0d569498d3dff4429e49fb944e89e1d181fc18cd4f9f38658c56b5e6033c34a19e1b0e89d356af6199e6943ed5db462a211af3b06319db4f70aaae8696e9848e8b641ef76b35a340023b1daa5569a288175768568d4f8bc57b0c8a82a1d29bb07ee7c6e54da59671dbf7e6687eae9f22aded4f772f83fcc60dececa44c93dd0238f285e48af9ccc34723d403e6da2d85c6c58a168f5b5444f824ab82bb2abb91d137c4a3754c16c42d0e115f14002a84837a522a486b594f42a47d77e841fdfd44486b7f425a1614c570b8aa298b38b6b4066f0f4612f31226c149a88c18bd8543d4ef08c685fa8e4f8eb5bfcf97fe8a607b12ff6c3406790e6a485f02ba8f76c5bbb94881e3547512c8b2257dc5de5090553c803c070589b6a2aa49a04338a18f95096a187fe6f8ec2fc64a9ebab4fc6de6f461f8e502b846aaee8e45c309beb85648dc950000421967628b00dabe6aac72653ce062f5ddb1b4076642801fe992e3d4f8b2bed5f5332b8b0b87711a545e4252987b7b60184a7561e8f00783ff97aca49f7c9a9c8ea3c6816dd1348eaf4332408b172d40b6b83765b00e91536748d5f5da809b3531b326d350201c2963c686798b182ee81119c3607abf8a9827063cd72588a0140a8263d783b9cd294e641ee17ecfc9e3eeacd5b6f78efa91232bf6d49d9aa25506308b9bd74d4f4d797f3d5e91b81236d03a95ceb14a2a206fbe8171ea703b56d4289e019a9e7611a712321377292fe50e562cb7c78ac867ac23de51a3b5aebf0392df4fcb80588c5c73171c57d0eb0fabf5d71acc96a17135b09426d8a5a6377144c2709b846da6aab164f6a707a952ca3d46aca2ec0dc512ddb7c7cc141683db049a3cf360c1b7a5fb859ff3389ed1dfdaac34383ad15ef1418ee640c083c614cccf249e6da75186975371228b8ef93a401362c6087f3cf0355a58fdc8e6981da477ca308331d1e7d6ce94b8ede6206d1bc06e6e6734da6bc380631e0b6ab9a0edd345072d73b6f693d77186f80517b0b80debd5dd1130ce970e5c3ff6645cac107c983c61457aa4421cde2e063a5c44c22c33e40b5bffda8aa47df9a31ffe6d96994eab9aea54b47e0e45e5dea0aa5169ab50a178a98bca8c85e71c218e6dd321c40080d121a0a1484834a05db4612cbd93bec10e224f5dceb8c294d50b9ffd8e0370ecc70bbba61f0a537c8ac596f8d18010bb4b75285ecf404eb222a007c0f0534299b11eed8cbb652808d9bcb04ad6d7ff5219fd97494956aaa6b3e4176f61eaa3d4f486daee7bb6c3fd2364b84656ae101931c2dffe2f5313356e963b60ede59ae46b3df1764240ca5cada4cb8f9cc4835d14e7d023b82472dcad778ae46f11fd61609a58a28d231af5895eca54de8c46ed04473dae9dc5ef09a9cbce817b340efcbfdb4f67f4b622d5116bf989d71c588a9c373913911e37dbc498229e42fa1b39054299f7cfa8d1bcc3e8694a356e86f938ebbe2995ab62f85f2237c6af62adba5536a480a95aeb9fc7647276f9ef01bf616aff9ab673475c611409fcc834f41a80900797e49f7fef494052277b778c2fe873af02868de2a7f08504a6161b7a3db305120d6e3e262adb3e7ba5a5ccf5deb096d5b90d7d3bf115b480d70ee47ecd45bf0457cf19dc15a9e8ef58ca37e2fe2abc479d44aff2293608a0fed9985d579108e56d66610217d1afe17e50ae0b00fb95324566e47e75662acc030d41e74b7d651ff961e5df596361880e28a2b640b9b5e9f4912f66dcaa5317515ddeeb71e3d24ed0f20e7b1aedb2093a478ca21494b19dbdcac6d63fc2fec66ba555d3a82ebab63ba47e27a1d8443fd65a1a88b936fa69b871f2d99bf2199ce8d4e212ea55fd45bdea1bcb7f8704a6b3a9dc99eb9ad25c7b4cfb88f9965bae2e0ae2bf919412df49bc756a796759902b2c161c9b99c4fb8681b44772550f86a565ae3b83b2ed65766db829257e416432c025e1e566fe8f53a5967c9462381b2706566c6adde8b5d1467718e0b3bcdd76a4e84035a9d9e7dc8588ae457dfd54d1ce06c445bf9f7649ade05292f08c40d799c4a2ac58278df3a95033be058e9e3bac1552f3484eaf968344c0f3e7320749e339d545b98dbd2a56f54556ff2b188207062f9274a9c73c866ccada64563d164e8a001529ecb7fb1ae3e5de26785330bdcc8745ef843c80fe079c748ae54046f08dfe1513656e4d78b38dc88ebb596b359207d14b5e7d71f9243926e0f41afd02160ae3ad84f9ce50654003fc46030121a116555173277a821b8bbb8d4033d4831e8738b3f0b6093b11261030f4370d189a9b6cedd2b5833779d42c9c1bb366792ac75b6811b021797e64b389f264e7c46647bf65b3ad6c30b38f4a253899c4810f3d4712733529c28e15b63f625e52d1fc868b3ead7fa8691fa53959fc64fa406342212943ab3ee5220ce4ae3e64583cee0a13250c2c2220377810f7aff6160099e1f90f73762d4bb70798373eb15f10dd2bc48e11d6ad28aff73dd140afe5a6b3c623b7ebdf587f3d8d99ed7d9de9386c512b5bd8fbe657b1e494a15c79e2ac4633a0a80705e752953d0f14d2d4f73405e4d47a7a9e7f35a543ee4563a7b6dc47edcd89f49ff016f34956e0a4afb58c07c5bc30d9e9da9b2a4344193c3a13e326b46f5bd4cc55b794dc228de2279ded1ef9d9d44a08b8a8e8cf1fa6f7720338cdcb04b676cc18f69e5a2e369b8932d1811627cadba5e4a6a53faddff55b8210c70f788707da6d1b456a8c8171af8b2c3761bf28ac153411b96a4d712e30d0f3cc5858c4e1adc4dfb3be26db9be8ae577d89fd8f8fd068c0bd821add39fdae33fb4d7146b986390b52f5ca4c27a2c63cd7569af793b3382ae5fc448de987c12c648948d911a0d50e96fdb975a88db79ebd6dd6c048e1a4231f7b43f61706fdd63005bdf3111995b1796dcac4f5968f46bca63119aea1afe3c6229b13e1909ab3184ee3619ae7f1373d4d7b767d52cac3d07b3c2f548951f337f76c10b8322fb55ffc2e51456a399d08712890fe973a35a8c5e5786bf1a9d7733c56b2f41b9edd89c27bd2330bae65716fff67b727ee7bfdd4cc3b3c2b3f8113df2801bf94322039a3e584a5e8609e365d2cb8041d178b11337cab435a8aebd83fd6945a89badca0c9c78a315127f8a7f50888fa6e51f3b4523a9f245d907e445d552a1e63d5d33c838451716be838e5639d4e8a7a007e816122bb284eb4ccdaf2b5d62f0f7f9cbdc3686368ab0e97021a963f8e9fc3732c64c6986ed986b57696228cbad987a3a4bcd75668d4fecbb4e25937df4d5de0eeae844ec67eb304b2d71a99736bc14423359761a62a84ceab740a9708c9aa1298e14fd9c20a1087a51c7dcdd801390ceaf260507fd04f8f2534633b6a9d9a5f7a09d0289be1e89262b9c47706762f824edeea63ae0d40b928c0ea26742477c4330de828fb409cab9a49e913a7e5bf55d5b561b0b3eb893335328829b1f316f7725ae8f28698fce3d1e1a5e93304e02fabb259b36b61aff780b9213843b34794d7cbf89d81fedeea0b8d897b989d9a219f9f3f31d441dbec4b9f3a881f66f8993dfcbb5d4c1a0d8c5adc29a5ee23af90467ed6fe503eb8a37fae0e99925b0387a6afb179fa78c6db33202cfdc72985b247fbeda29d3fe4627ced480d8d997e220905662d7cebdf7bbfc3d5a043ef25f20fe5817b5ed2856393075ffb519b558560301910051106c7988ea22ad95a58d5065652e67d6ccad0a69d73c9764d7c760e7ec1218e5e3f00b197f3a7ece057d830a8f8f71a7c712cfc9ce2debe5b2575b6480c824b1e3395db47c0cd7144c52858527d9a3731a04b22fe0e4cd0b2a8b745fc1743fde9b578cefa122e2af03bf711583488ed53fa2807e5ed7c86879a210743c8cc764c6783faddcf94cc34d8bb464d8bc0e2a8f3878d41e0646f707db01d589ac50e295b617141b12f9a79789de1ff915633a64507e97c75d06ef8a34f234788f3fdf2848a5758b91e303ef572ee26f91c7050038b10f5187c81a0b4e5278027300b97f7c805560360116a6007d0d621c887e40fabd522b6dddbf303f5bc94177866d19c86a36c4de8c609ac9b1f1450f1ae651e212022d88fdb77687a438a2e7a2a0b13a4b20224c9cdc5d8b2d8ce0287601134ba4e3b44a82951eb74f08cfcb27b81c0197749c2e3b7486372b5c26cf76dca2a725b78a745734069f556856e67bd6912cbeed31675cf2f7674a364f5311616b220d1d5fbb0a086d6a207348e43d6fd524a272971a082bbe5c33e5493cc95356e1ec2051da3183fd971a1e1def63ca0104a0d9f3a46136b9050d259ff50943b1b891a4fe8565fb9bd0bb15e69ce41d415286fadc052fc00817ea78e769b38baec51f7b7e4ce6ca3823de4e84129fdd4ed84c92349cc4cfdb774a5b8d3f4e0d0c9b9528d075954efab03b4f654f7ba7cb623aaf076eba041ccb9819aa8c29058291cdda19d2c15a534975d3b5eb5d572118e4d12a428f6284e84c844402df2827969c80b3cb836b08d6ff4c6378590a83efa1827d521e49078e73d5911454856a8687810d4fd7d4996b4f64126cfef3e5f58a5a2cfc78f117cad134c1a97b64b9ecd4a5a31426d4a0950521560036408b468bbad33ac4215d98b00029fb126f722f59de90f6ebeb4716339f19b1935bb988ae63ead85f48341d30cbe0ee2d38d8c4ae09575cff359b987c601e4f99c9cfdc059dbab5cfc2d82bc15ab8b9996775e4660dc702a543d461e0c71d2ad45fbc0f81917c4fc824f5ce6392124d0f26317b594ea95bceef53b45ace86ef915daa06166de62b1988274a1883d6026721d8078332c703786a316c3c4303483b6162011b408894c18e440ffbb296766994d8bb9d5ae36422acb9152228050bf892446cbf73bf808a9a7ee8c536efab4dd75e1e3ee0351b97b0241da76b0c09855d9baf7d9d5e90187110a8c737cceb7314401939557a157300a6fc168ab82ce5d582adb3e46c480f0ce0bb87d348da0071c02360828390838239d0ce61ec21c5bfe8065bdb67919d0ea4719c03f80fd2a46d0f4bda2381733f18cd591484926b413d8a41b6aa314ff6bea2a52d8423721873bbff860e67d2c869a06ad9364369ad1f4d30f88f0e43c62dbd7433fe4c236e52a7c1ceddd8da757af9f719eaa5476f1f12c207de28c2fffac362254bbe2f102d36de09aec597e454e9927ac0b776e032026f23abe19522cf781b193f97c931e6131a64d127129eaf9c2c42470b6c8ef8b6f652fdeddd6d6872dfc3c3b685b809426e17f9610916656f6a689f85176cb2462bc7e0b058f6de12e4c430679ede838343a0a3a8a92a396496e9b63bc6bbf3b29177f3d829f1dc3a7e63a78cce767cc59909344d5fb52f79d77d101bf586d64b270ccaf87ee1de9bc7c94656c6736651ae4844a8bbbef2353dc2e304e8a15158baac3aa77af2e3d05ab971aa382266b89e0618dce73f8ae39a9cc59bc29733362efc558fe1b4bdfbb3c218c77f6412ac769194962f5d0e9fa7803f667ca8af84a8a6f9bfea1c8425bd9ecd924f7be85b1a893d2c193659b3ceb556c66e7eabc766bbcd32151448f3ce54f890f52d41b8271c7470be8f068f7463057261c2a4c0f28fdbaf3118b370d5c39b1d472278d65c08a69fa3ff60df3aadca36feeb6c6ff4ee453d7e80dbab77b2c45fa2f7d0af5d37a16757aa2e1b044de15a6ef36f1f7edcc9efc3051a16a486a9a7e6186e2e664b1f0bdbab162b493884ae5a98b51d41d33465a33fbfa1f676d00a0c2c2c28d088e80f119af83b40125e5c6dfb83e29555debab9905ecbab5ec5e21f26d5fde958b513fd94f3a4f26f6686881c8265345f64a73ff7c05038b3ae38c53fa8be578be3c5c67c68c8c1c0386f15252185cf8acc500c7286a81575616ae638b0e1fa639417a437b597ffba482537effe4a830b4b4baa362dc668c26dcce08a160e69170d068438faebbecd97df99873646f4cd1edfc6d2bf66e46780db36e23b976efec2244c9887cd6b475f145c3990f6f8af605fa0604fb90813c1d0d13518dcc00671b6a3f408eadde5a716085688b36fd0efd6d1434a05e30831dedc1dd92360d6d087998a44465ba4eca5b903760c3542e2f99e7fbfaaad91678c0886026cadcb90386ce70304a8a3a8a4d0242a4a6325a749e0c323172fb58d2a6faf0b8303e7a666ac1aa5bb721686cd5860b71b435898d2cae593153c920f11bed678e18086922d9a55babde995254b4d720f256b9103736d2ac962bd6690697e5105c97151572715151e02e4c220169962b0683e0ae37b3a34192d8ad42811512d3bed08f145911de05549e6ed51cb96a6118db48b349197a78bad30e3ccad35b416ece4c2875d69ae18a057d212f330c252eb43a4a8acfc06b5d15c3fb5c23a6d4009b349f9bc484a451d70b7830768bf8ab6ebd9bf93cb0d3a592f9f5786b61c37f4aa2be7cdb897787fa23a4ada19db0011c075f46283d58c5585540bbe66aafc2c85c4e2a6564586d22684db57a46b416a5a062a389b516444a76fcf8c1511071a1c5073a0373789a09dc2bceab49b8022be7fd9cefc47e59f7e25f170ad80845a799e161a95fe1df3b3806cc4f7e5ba5065b3a898c28588e37fe944bad997e55f7fa354b87207e8e1d6bba58465e6eee5a5d4e8524bd0bb213bf67f6cef936502754ab1bbb72bab2a932dd42e194f94508577f0f66a969f91d981d5cb0ae840c609bcdaf528472f793c4017f6156d89bcc59b0b69a0865d1f6b10455a40413a711bb56b9bbe83bae8bf01130bd0e6af5a94480597748ccef7fcd3d147296d4fcdd6215ed96982b2421b4b335d7fe66d66d2b9377762785a5c13739f0d092f8a6236ad4a8219373bee091d3448be1d2ee14328d6f396d72bcdd850cfe281e8bd64d5832f8468a96862e0c4a9eb3f4d736b534c8dc32d5866b0a1e90dfec638c5c557e461dff237d06435d19cb9da3fe276b65147a52f12e477316e53b565bb7081c1cf0fe8e7f20c7da169d766aa25255e83b151e3f4aa0188fa98f408ee16c6289bdbe9f6093066d060bc85d721a4be1aaa1a7a44c6be9179f03adbbe5f7b4894b6760275afb7c08b25119c307c142fd031bd0ecd563203385d2fcc31186b94ea9433380a5b37097a44b6024e02296f2029390e4f7f94e9bdc59fba59786157a83d6428a3c97c098f343e4ed50568079c895c6e1c57e763f369caab0b082df3db34ec33a8a458b37fafdccb1f30db33f5d3ee534da207e1b43aaa1073b6d36c66fc1ecc031e08395bbc63314a059daedf89939c8343d41dfdf6bb925d973abf2631de6bdeb50d50be41004bb9d4095afbd17b99cdadba26accd0f7e45e92779e56e8e47a9efb42bdf3fbbba5cfbfe9ba9ea926e858ae8f6151a51295c3c39c0279620243cf0698a6c6bbf03054f77582309175fda7127081678141fa0b2c618867a9185f1076b0b1e19ddfefa10aed166303e5334550e0713e014f80c91c7fdc1032fb173f4b7eb1c502c57f05a81af672572dcd83b4625b184eb99ecc43635a7266b7578fbfb8994e71320483c8f7cf6be6598f039e407dcab4da0a5cc25ae0aee935f2a586eef0494cef041177943fbc624ed3056a63a924f5a887fa6229163262e582c878c5b0941fcc0d91218ef53a080a81ea241e15399b026f2abe042cb107be735d75126414d03ea060f373cee91d846e45707c36ef3ee726b0c81b4ee9e55d8242b54e9bf8daa081c6a64a046d63d447f983690f01494b87c4be96e1b5685cb9966754a031c854b02eaa063258343ccfa4923795584c61dd566394e7c270e8912334611e59a41a98e056fc9ef9dbc061d4acc0d63d054125f8b3b54dc5f05e670a46df62377f069d4b725a5db296ae83cc9d8afec08abf72c0716f05fae6aa61d5ef9c034b6115878e3c71cd4081080f3139b288d0bfa0d098162e439ae0008bbfa55371d7ba1680b39335172664cbf73c837978296ff60c5a641a3571bff64319a8c26925b457352b0b555480bdab07aba789b4695e34b6cc6b5db0bf2290db31aadf7a57b9e91067562ed102d3d25d31d9fb1a0b2fd45d3be39295f06d06d02919f80f3330419a41bd1d4809a448153ce139d41879d5ca906e79f12222ed58daf6c5134e2e70b425c71eea74daa0ebfce1939b9cf15c9f1000609260aef17f3d556234ca0c8aa95209a5a7e4d4702c5fce5e7cac3bcc2e3344cc3114a5f0750719377eff3b567ddf424f189ba563f77e413860d86daea675878f4437c035dca70a916c49e41c0992aa73faf006c793b23d585f3c90b93af86c662e272f0cc73b7d0c7fb5da8e64d68516c65e65c59017b9ae7aab19d8c350a9e3ea8b2237c5c3796d80483f1e95e1937f6f8bac63c408498087ba3262043a20b351090ef2903b4d5cb1e0fbb1ab601437765f343a8292eb1361c04302a8d3af5604bca8d74df713d95567548327e0922612c860142882405817be6d7506390bd466d4007a19f9456b6db9a7049c137e51c3a64ad6167f4a08049264aa220a86c7cc1b3c4776e8e1480c01465792ebefc57797fdb298df2924c518a7e41269a5fb815b363592b273ab9ff63416affbc62f7be7af591a3547ba19b0158012a2bd19b0ba572a2a58a15473061b08a56fe90927b42b52fd6bee9bcebaf889e78010092c05b731e96f97e7a722a8e4e5ddf6d629b5cba5796b60b6c9ce9d5f2ec0e0de37c7b39775db98d932883eead8f6725cdae8a3a5ff8269eaccf594163d1649a1648e0ca3361ffd29b55f57b356395eea2a8d1daa5c542e768a054c24313021e4e26b8a98d7ddcbb044a48eda86d678f7261fb9840deb2c1ce9abfc60631a0b5f9ddb0a2fcd9b66c61293e16a18f9e2f10c735aaa08c5f8b81a33bfc8e69b0f71f52f6af8bf4dd6c22e9115642e572c31f26b3d0e55b0b5f390721ba98663370b8f15b234b66fc9ce016869b2be6ce71171621f9bb49b30a5a3ac10f7f8d680d106a75e9ebe105ca088fd4f11a05c409b9f02382ca85852ee8afc7589316ecac5c629a75a88b7d499ca489b79afed1c34af4ce1c41f53d51aaccd75d5384713b34a3ab670894e83504dd9d52c9b89f3081d5031be656074d05d2d621304f6a6afa032bb191ba56152d701792135dda58659e6826c665100fdcea49a0107866d089c7367802a0537e981ebeadd7946b372cb8988b21fcb715c05ad9428c1a7e584ff16730a6b1684849c5fe2d248f17f25cee401409e0157961c5f3165d6a703dcb8642d7b440e5509affd70568c576aa9a18d1472f3671d967652b82913f0c08f7ee732c95f019584930aa7a4ad6ac9101a613ba8d7686199f9cb91a0754c87d1012d7ef786a45590303c15795436f6bedcd5dacaf0eb29d55e218d6aab4c2fe85c5e65b0eda795d90fa8b46ccf37fa895be76d7f493d543fca99e3c95db53b72e064a3cc19bf0ce8b451e66419e4260e4609e0ae9c9998f0c669fa7451da15e2e7cc0d46b3c830ec5a0cc1e78bc42c7c3f27f9a896feba1f86b70db996177179a022ab6f4e802dfe5fab3e5bfebdd771ed5e9fd02f1cf31c5733fbd5af6e596018ace489b0d3ae304c7afc7fb21921b2132ad37f521955f916a2c043f5da6f0fe00f7141210829025a5cc57bed22f1eb6230b35f39e345e452bc3c9e0169d446574805c196a9e0df3694f8a54428f1240f101d2d649cb3dddabc8f1715eb6f1c54aad7f0ef54207d4d0336be0eac0d9816af18363e06423fc8ac18e85850dcfb6eb737dca3f3e107218a5ff9f301835db6923ccd916d180c2ba5db3bf4a28bffa8b8095a76cf6604d801c5d1a153efa16e875fb1e1c5bd630f93fd03f91b47bdb16b569ce43f307621ccdebe745cf92fed449df9d017592a010ec7efe624a1fed4927aa5971da2e9effc27b63718cb71e33a9f7a726781da8261c5d643aac5e82e91637ad75e17acd96f2aebcf7c82a1a01e37e44d5922b95993ae5fa02cdbe999d715966ee1f1c02c956cde74310f29e80c406988dbcfc26c09077b133de9882cb20035c54d46639719ad561183a35bde38ac9a88d27a3782e60cad8ff75fa0816e18f20280a48e24c6d0ad3015e4342ec72299d647bffad42678701dd6e0ac74afdd6c10bb21e38acb08ae429f206eb281db2b1531bde16c7b14e6be8e86f78f1b529cc198c9717e44cdd448dde17e863b9cf9982c239ea805eda110dd7722a2240408b8ac884e8e28678e7a064f133d0449cd4644c986334b099a82266b2d7921fed974d322bd3dd8b3a399ee39011362dcf385dd9522fe2cefa581c067d9f547578299a1b3ff54eac5f1fef9746fb3594309abac6d77c88c93ab546b0d52baedaee8ee5c1fe7545a3490b4ead9d2eb25d4e9886e256096ef7e43a58efb0cce45f554a8f8f672208f846542eef1380a9ab658c2003318afdce40b0672997c5f57fccbac7d1957935fe885312ad2a73efbb3d97d905b61d0517ba92feb7493266c2b82a46e3e0fd3037e3f22cd565135f70964c6bb7854a1bfc44c5c4f7c8a1ff27fd0c54c2172c4b01b090e870badbc92b07580b058c0edc3e7301ae223b7cbbd3e74903e8cac14bd0a6309201acd33e7bfe45bffc68a99a2850b202f5996f42d7916a24a195bf9316d54b805a1444ec6329321c5480520db14ce5e09fa4b4643131557ba766ac7d4ccec267863de4615a928a907c8d1320cc44a36541a78b998913682dda793b42559b75871f140c16dcdd40231637959d6d52f0aa94893dcf767ff9b6244295e423da6234fcfafb349c89b3a74ca70da1f2be58eb668f577cdbdeb2c2d9523c643fd74b5eb943c7a434fdc15e4c999555596ced584115854c3b3ce619669101539876c2eb6c120d25ecc5828a7185377e62be3144a4ab33b112b02fd70c59c49b4d08f59f9456d72b7feb717e7bd30e01455c560c98d987e43fca4a58e0e0bf3635c93c52d9eb415b2090b21eb8035fe3d0e0cd9c60519fea3ef281bd35257637996dfecbb594eb6422011488ff54ce7832f1a5fbd7781fc6e056e8cb12f2d712c44cb683b25e21620d77590fad14dc418c8715c6c111c9bd2ffa2edff78e8df6153012f8ff5554c8e2831bb18229ae39d81553fed9122aad250de2227b733ae807fc71d76d7324a140cf70b73d58b8b6e2f26a60ae118881ab3638a565e9672e0db2cca7b4cf9ba713a5762b37a69ced19305439752f94536355a0dec06028d054b00ca209165f16ee5fea29bd9ecd89fa8622dd4e93345808a2b7347662ff545367d3872cb083f94303f20de8fc83ffe4a43c42197e01d016f99e5e59555364b4a5d49c74b38a49efdcffbe8a2bdc15acd500e45d5679b96e215dd2048480a75d0b11b88fa629ecded7a8beb622efc73e8e20f9b8f332c9bedd9601032cee12eb204910451ce11ae85683b079782f129673f03a8d2c947127154b6815cc50a536d108390fdbd4da169c0dfc38983952b1975a6566e125082aaf8f01715128e7bf082fb79e6bcf76c5b8fb7f0cff2bcaaef06137bbf3e0e98084adbafa86d1d76d624a83e52d409f7d66923783a5d2bf1c6029c93f431e90e5520af7c55658d648cee0e6f29cf5e3f1616fc9a9367d069007b439ba7676ece7e5711a10f666070d51c15bbd6cb30fe68d9179d76e871d17c70261a1ff37d2422d4b36b6d3c4c783bfb14c2999460c6e186089e7b59194e9cbd7928ac3eb72868028dbce7731e86ca9821a242c6b1973e7b701b66a4571e6e092ee9cdbe1d786b13c9d3fa8d06b3b32fbc50f9e6e56168037b74ddb51cf08da651c17085200a2a58741aa790f262af618ed028bcb63ea863f38914b51261866e379a4932d503d9c260bb5ad619796931b9114531c3e3a17907324ac21fa80a5b7c11e31a032303e4d7260bd6f240740e96f8877a7bebdce75c008285e20d01ee837690feb4c02d07fd3fcc47ed702933554e621d1b223486a7b00aca66ff774ed8705494691b674368e3bafed55f098a5c223ea63805b53a59c8e4a0b1cc45415a959643c9bedb23f35895041151c2c9f4e1619c2f17a71c008b0303deb809deb86ad7b4789053d627b51a5eb9c114290282f1fba7ed8a5cf8346ecc47d168b41e5522c23a96e4bc85ab22d018192e118a5944e4dede8bbeebdd48efcc15aedfc0d17de5bfb3ca626fa05b1587c412c5fe2bdb4cea5e7c4748d21a80437adc3e2b5eed85ff0c4e8575974d8b78f0fc1f84f4d99fef0372fa56afc68d271b07c92fe35a89aa03c65d06b86e09fa62d0df3cb3f4ce6d7fde3cf5bd6b3250742466589b7b8c40f53a3826869005bdc50950e391ca55e643583b671f54193b59be7a2f4f8fa3eb5243611eec94333a4a0fe198a9bdfd34b36515512bb17be25d79ffe36d26d764397d028344e05df67549c46c84a76361394e06657f513bd8e24edf49a9342a0c0bed4ed4e44964174f602c5509b0a7c9df8365a39f5d29ca3a644afaad4bc5b37cbb98680d97d358d3b1bc96d8537a9ce19e2a5a10b2ba38073ad1a585b7104c95a266a2615960dd8fb91a686958e6c01e6333b901d8af1c6fa002f2e4e06d6f8cd28bfdcbdebb92a1ac1de90e2a160a0457d4e79c53ca040ab777b9f5e41c17808ff1a06f7d8d1953e7502ba4ccde2b0b3080c76de6808f6d7679982aea4923283e70b8880626f3a0dbc5f4b2c49c056f2d87619d514ad294d1786184131d5323fdce6fdce903b0faa36b0bc50d3b5e8175a8693a13a4d839e3c038562fe15d12991268ee3fa628ec18eddcf7cca198dc9509341c2562a8a958876909197d6c07d97a4d04f7061d901d193d034edc13720f136c16ba012eb264044f12d9272ff4737aecee93ba8b6a92c72fb428ed67f9469bc452c912a0374d64f6e231624b354ea5053b946acc26e063949fc91fb362a9187b73f619acd74f3a6d309e458c8ed264273db343a538b76bbab6fb8008268aa21a403adff56c78f320cd43f02b77103f1c7c483b886457d6ee9438b96bbe0d4e9fb3de1d206d9b0398c280826b58ea4135a5f6dffe42e8fe9f9243a4e2fa3bc6e121e473092f4524e3c1eead81a0cb61ad85c166d596d3a9c9ba1999e88d4b19261553740148708db38764b8fc73f8fe7de37d43cb359f85ee77f6eca7afee2745eaf95fb20a1d08f9535aa297236f7fc40f8f051fe7a99f4def0223b4f1b2c2cc4a3027a05858c7766c84bd0aecbf4ee712ae6613b79edb154ceb8d6429b272c3f17ecd55109c31506c7b5ba87f58f6636491e95659d9a00b039a065c5adc8932a294ea3e3415869bb660302a9c3cfb081e0146bb46b9212d1765dd318556c87257406ccce9197ad8b4f091d0665a1b3af220a4d8a0fe666ef19a1dd57b4181bdea3e3cfeec117f0951d0229140d5f710bf6c9a0a13fa27ec47fd6509c7213dadd62c82a6aafdc82bd5f92cddbb4c786799d55393121c9b42f91a96be8ea250707001a61f69b582826fd9fd112b8f69b8a14aa4f953a833509bfe9d595002de90477481cd58cb13bb15da3ca331f9c76433d0ca3ec1146d9a7cbef4082ab05942884c2742629d055aa6dbe7b9123cf43c345a095263da99d385dec23d890d7b9aa6845f48d1acbb82795566a98c612fb1547e6a097dbfe27c8e1fb9c076bbce7f5a459e121356ca9158136097b5055b1ecb2a000514bd0174ef3ec61956573c7d4c1a462cdaa8806d3c124f1673f6de7fb2d70277aa53fb2d6b88311fa036c98a3c2403a62e04db3fa9767c6d63b84eaeeb3de03eeed86313a06dada972d25d5b3900d6ce3cbea7e8123591587e60255ca6169bf4a2db9f7dfc80fd9f9138ffb9947c178907d45a2c6a9d844f3dc72f245aae861a91a58ce9a554dfcb684ff6e535c0efb02bd31a2bef173cd6cc4e85db415b9162175bb6ec405f5a1552b8dd0f70793f0e8a55b02464fec1e90aef03f89b9db4365072527fc77f169bfe179bf9c57fed31909049332346b787cba7b90be3315b1a441bd2acc87c7fb2e7afb48dfb68a8a614fd395070bbbdd0f3d5a33543f69234f00e41171572396851b170b63d53d59a7f1f8cee43c8b530906e8414ea7639e8b9fd76832d5d4282447ccac61950af0d55849510ea436d81a705875683733ec74eb2cee64337b657979b18c4a50b80e32f71b420994642b2ac4829248699aa2832061e33e1d52d1b3137f21af731f4a69b325bf0e05a9ae331a130cff0da39a58098fe0275c857f560b8ff6539a360c4099aa9a05f8ec3792824dd31bec72e5f28566ac86571553b9698406a6328f6a69c816693a0b582cb038cd496d81b2370c9658f6369e7fc1a0dc2ba0a6df876a23c42e0825b00d4d25456040aad9fe666d766acf9840c7b0344e253c62414591d5b6e1915ab33b1c2d41df7f43fbaeecfe358a94c899ab252db50c29cb76df660d0ca2cf45c5e20815fd5a1325c9729d1876f6c6d0d6e5f7ddfdc4b9343111a516de981c21d89cd0b709f3e43808a11485d63895f3bb54ebf6f7b8c4cc956f6ff5cdbb9644a4a0bb0517eb2f145b73526e40cf21a66c9a2c7a27a36d940e3873d7bd7e28fcd186b4718ce90dd44861f35b4a89eb97231535b12087af9b15b820da80191306d40719652e29d1400b1aacf0813c9a62eb054968c96491845ddb882ffac70624432108804b568fb0b22347cc8d3fac020acbe9543a28dc7f071c8907f5bc997abab93c11e3050386834138ec2445dcfa0fa556a2489d2f2dc99b2ce7d1eb5a8100c2008562646e25c9053d6c2c125bb5c88f1f648967d04492b0377ecc5fe301c756ef057c0c0a6fecbc985bed95188fef9a2aea9022c39fc1127cb16995428f1d170542e747ed2298451b76540d048fca884ebac36fa81d6206bdc5327b5c4692ceeb212719308be72fd6b9a63ca1ac0f43e61aa2ef7be68ccc56b376423d6a97438db76286b9e90ea5e4a3b2ccf3a2908fa77859ebe5d655a1f9be0156509c6889414cc600fee5160e2f8a304e216323723e2060122f058707005980f35051f6ae7ccdb6813968b4e68475d5f9a76da73e7f81ed7900630c858a06152caafb25c86a4bd4f32f2ece970d1ae608bb2c58936839bba956f8dfa9c02f7bad3b9926ab0418280fced797d1777947af60df3637025b5dd5819ddc21f39c445d8b86adca94a052f20c07b1ea79bfc15960567884776545c13c44ca20600d498517121dbca5a068bb01bff8f374ed71a3ed9d7ef0738641c5bb23ab3f42a69e96a76ff78fa257e95c31d542483feaf6996b7b1e53541721a23cdc4e91df5806dbb767d608a5d0918f818834bd654b3bc6f4e4f5bbbcfb2e4f276bdbec2b9b7a543122c6e5d77840d7ad90898c661ce966696bb4c37fd86ea0f408ca104b0f653ce95d19aab696cffdc1400e9568f317d3d21ea269193a373c13f7b4bfd48638cec523d14012099622619ccaf15cc8de79bd55f577898141ab740d82c31e16fb57a2d4f5fb898bdb778a163f995b36c2e2861b1bd2bbd0c376a030fc58d2001a2917d97df9f3fcf95f9d262b5bf6c3400923c7bfbdf0f761f9d2e5632392a47c6d15e81ee7ee2191ebdd94aa3c7025013082350ae6ed4680603b23cc19be649f8527f3be2c369db4e861da678cf44394b5257b47b71bef29e866fdb11cea0ae47ce2483c56f7445116c822ec73faefb4772ead7e9713db928269cdb5929be075afd4b2074949cb04b3bcb311b7ca812ddbcefbbccb1830bc5f093ac21feb4b3f0c1a9a8f567a2d6f24f5f34edd7005699a6b67aea3779568408b6dd371bf9b00610624550a1f1423d476e7fc0e76db082dd591a35bed3c41d0ebe5f8753b98118410e694b5b817f798847a2a60505ede3eeed68e07b3161644d1e56fbe3108ff463921cb1a46b8ee097488d7e79e6d7eb09d3874eaf88e58eb46a852317238dc99312768c25c6670d2147de54e6a8b416ddb6558968835fbeb9332083d43a754662499185c26982a2d1a602a99620ecee49684eceb045c4ed981d5c221f166af139a271efbd15732b38d2ceae3754ea79b094666521b80abd1dd26442b6a4bd012c741f555a59b11cdf6d39ae3215be33270fbd33dd27e44f691e6db432c8e04c8d6c177b671645f3009072e56b77ea3ab26589ff1d6ad4f8741e6425bd6b27f6cf690e9db6e61ab8c7a3b67ab16fec86385b0d7563bf7b3c4d1aafdcb68b1e4133b139a4748e0355a53c53275d4c0e1ef605552470dc83339f4d25d6950f3738dfaf4e5515309bf801c3b9244a8e3e42eb6646d0d72b35c6c8a5a4e8810e928553ec9da2131809f3d716504b40ef1a4cec50410195acf872424d4ae7b5fc96ff27cf2246b3cd2bbcd6b83080cecdd906dac9da88e7c29072e7e630290b1143e80cc91099a9588e59e09ca8cd8accbb74833105bc215abcd573cf8b5d58a6ec318d263921f08d448fb921dc95dcfa7e8b05052091333bfb6f2ea1d00f93641f0f7c69f63c811e1a96b335eb0c571b48fa36692e481080ba46e98913fd8765d0a98af076ac3b63d8444a6cd7f6bc1285c08390e6a8391a43d2a50c7061810b58805304db06a50880979e8a4e1d32403398079752621affb9ef35d20d28d6488b20a9ab9b9c63387975410edfe5ce7fa5487991a5b0eed1d5091fc6fca4c06a35b30b2cd17ed09aea6bde4a795411921cd11ed35975dab5e8a05c99c7dae87f61b6ed32872ef18a2188c7df14a698899058b69981c94ac976f7c2865224c81707f8e96c247c605b845ebe7d9b3a963ed512bfda81071de42afb5e4c4a727d781a9460d1365cc4996232a134a4e0aeb374ff9a826779fc4013a34cdc613821cd99d74c05bb65c1b4968d2623c0321b9a1180986e262f130add838b8be181fb3b18d6dae419319310a60919428c6e6309e657282f9137157a1f7043adedfadcf16890bb03c37caa6c1afc3c1e3fb2519380de45c6a4202c5de343be370209707839491cd6aa55046269920b1432949276d3550eb50553a12b0da6dc5bd4b786ab67ef630831cc1376ca3f3b8f00a5737c8a47ef078897bfb625a8518fb200eaabca1340aa064a9cd9c46f08568d8300f1a5bc3acdcd007f340cfe6f58d9055031fe91f3a0eff1096d6ae268767bba49327637eeeee92fcfd97fea278ec1909a28c9411b06f797b6b177ef25ae351e09055014513cbfd81857cffb55fc68fe35e6b72a16524f7b47a8d5ae4ce2ea4f1541b3795cee90d553e4304d6fe65805cfab344a2f4001151ea5484d651fa3e232658d3e157639019280023f926147ae38339e81e07cd244089169221859b6acc06ec7342cdb2b48fabce6b463a6a13be3c6bc6641404a96f521c43dfe626fe40715921718f8237ad89995b07dd1200bd650ca5bf4ffd8ce897a83ca86b70d5543c21e6e221dac49f6177c98afc78d538c6ba329777cea080cefddb8c80e9382aea8074ef4e323af56cd45635f74b5da7d0a5cc1503c5a74f3ea69e93107b032caea6322d8e3678a46ff29eabc6e3f806d0ac5543c3170e9b738fab9b7c0f74edfb63617b64df0544fb776286fdc05ab9839df9acf94305b70b7dd2d8198f339895e3725b7fc00e65ec26aaf693dc9a6ba8c5346c990e82ced20813f046a0f47aacc9395cace71e3e18f9507ff9940e2828627ff32c3e3d3dd6de65e0cd0363437481ca7189c43c87c05be332996fd5d0edcb021d8bb45fa9757275cc5ce4500891c14e8ce250c2f95faf033dbae59f302c3294bb8701ff365ca264e7322e5f158101e6454e5904910a7ad782ae337573272da387eac948a53898346ff11e33e789637102d0ed45807325d919c92b907ee057d528adbbd66de9b1c6699bbe52b26507d9f916a5af1f061b0b8c5ea79c304879930373e9c1b60f0a51b71b4fce494a57c1ca6385cdcf40e13078a507e2bb2ecf1e8cc082c907fa0738f20cdf27169e61f1e37767d5b7a828b278ff5cfb2ab1eb586a4e894b81ad48051afc449bc0c4165317e4cd8ab31c4130792b087beffda50a92fdfd7fb54a042c8d30ed0835ccb9ee2022ad7a4ba4b2748e503f6f227d65d60f0bed71e2ac6c1615cb9c61db7b8c7ec992dffd6401b4c320ccacf1f00c95b96c7fdcd27437affcb4db2a5b08133d7e3c6bbe1f8d15616f33a7e6ffd13239ec86ac684a870facf6f55547d025867de2a9558229f32fca387145da5135afe1883f09c66acf81549069e8ac87c4e38176e9fcfb59193f52af6d80e13ba7d0ea32aeddc5758fe69aefc96d4f16fafc5107cde48ae1653f0ba01fa09c873180ac660d0d9f79fd056723d52b8ee3b81910f72d34a54b7d9f0d78269104972306ae1220e2d59f22cd99c2f4a1d48bf7d43662d5c255b41d358b961a7e1f93b2e8d1bcba88c5e5feaf0f876830ffb411f8be9e1be452eb56dba9799bfc41495abec392eba1a85809326a7f5c2d65c575393b79f2482784876890079d931c3d74c2f2318b11fe6d5a38a2ac86e736db81ab88a90d19821ca46a474d4cc1f80fb381937301bdd07c4f48f620164e101e577522154170cd6cae440d4cb32ee66390a469fb3c9bf21daedc8defbdfdcdb2ba08cee9b42974f20a19562ef50f8007971ddfeb294a46cc7202337cf75f4bce2d7d47187e4e68576d1eef746a143a7941a19067b8666c80f453ccf717eb767389dca2d0f8b62160d49ab6d1446510078352f2f5eb3413d6fbe4ab1af3cd511e9e7df3612627c3bf0c9da5a8783fb76f85113bca5f294fe5a01d1b96e61b5fa6906b39d25e201b5e9acbb8d87b127503e12e14d8c4683828895a3a4cecbc92978485c8708c410658defbfc5b4a5b4ef0c91992a71caf348fa76f0615a09ad02f5eac8372b4f2c0860ccac4923847d2347de3519fa0ace1d5464a288b9658687bdab916c2fc1964899c5e49d752890881853ef9519be2a2818b03636e00045ff0a8a7ff0163857f6c089a4af36690ec2c6dfd6100f359a0f604486e78d5d1160aa7c4028e67eb8925f09e3ca33092c2c1bdcd809649e961480f1669785db11241ad7e49b2d978aafccba0acb927661f4f6c188f3823e554ee34cfe9dd56532c872eb5c3a31bdff740dec44e2358a9edc3642f111ef8b0e8bdde75b97e974a9ab5325113e6690def89337592eb228ad67f2bb5120d7fedfec51b417c3b18d18b2e5f1e5736d7ebca8f95a4958906005fd0da2d1551cd164b8ab31d3e119c58857d20c578a69e8cab0186469dba402fc6a390ac272dcbc3b38734612993b03322fbb61a9f48962115abb5446dac8c3a97963c0c8b475787e40eb0ded2a53501a47964a38f0638f43d1fef8c41a4d7e4520e9eca5ee2c32388db2555345eaba51cfd3bc85e14466ed8791868c13eb2394502dd77b2a1010b047dec38f792f20103c76404ba8598c9871aae526d40b5edc64f4b16683c0fe6c95c0cb592c6d7547bd9fa53ccba941a70d45eeb47fd8d112b33c78b549c0007a1cb9f77c215bee0897974e1be6cca157e1d941686f0da9930255fa807976d4f1e1b9884256d37eea7ddf0c7a8564a16f79de85887343c6b5a21aafe8cd56aa84bc9003236a40e1ba69a2eb862d069ef7b98bfc20117a94ed21b1ee4a83c63ff13ca71ae4226dfcab668001e259f89a7cb6c4bad73f917d8eb4603d031fa04c04eb4d08b1555a902e498d5126c270dd5a2b893239223a8e5ee6815c64bb3bce165f36a8457bc70f27c9e2d99f3a17e705afdbc915ae89ae17c0f9e6233e52dd0d59756cccb578743c4a9c4257f67e67446d516703119627927c8ca00d11b79a4d9a5f8c13042a6372bb9b15c7bc4ddd82f67ca282881174b7029e19088e385cb28ba1ecc047c4be8e331a1492aee3f54487445100b1d355656726d8d07cba31af376b27dfc6a099ff7d3b2b2826dea0a812c8c35034a8e0f742645c01b1b83ebde0b41184bd345fbea4dbd1897d417f6747d247d25d212ab4575e3ec0307d3103ddb1db4332faa8526913146026276e0877a748509c312752cf0c3df533ed346f07262db9b870177eb4ce03279d6c037db0a6dddf5c443cd345a54a6eeb87e6bff3add544d0b369fcb66388f39fce6e93910a71536ea1b7e3177fb512aa69a36f66fed4d6b60b1d94a3533ca261016d6e8c11224e9e746ec5ea2d748a062525c1d4e9f24ef535983eaef1482b94dad4afd3fbff74d16f5f83b91d548d04c1f3a6aac360aa16161d91f66b54e03d1c144789770d742455c6b87e5e663b1812088af96434726e0a8d19bb7bb1938e41fb42e7527fabd0f6cff92a2fd67d7cf0dd9223f5c5bc3cf12aca73a5516e897274d41785f1e082adeda877421ba3438fd07ecd914ed105ff0c770538a66136e3eefbbf83eaf6920ae70c132ef97c6e93a82e699816cc0ec8fe44c101cf1206fdf9874a1f4b6d8608df4dd92b747e44ed09ba9eecb8c4065db78b20efc63ab8024ad6aaa3fed8335ad349e12bd6b5583697f76e291282c2ea42ddb8f60e7158c605be3a9cb5e7394dff4bdf0e1e4993f0616459199a1b3c613a46ece349159c9785b7062da429d871b289f6e9fd955f95c973b8fdc9a48df74aef503edefe51b7f6e4101b0c62ad6a0ae84127caaf6e2df1bc51d118a86564e58e6b560dc963fe9d3d2a54494dd510bdf260616dc607560c5b0be17c8e06ff1fe48bd041c59cb29ef1016fe8c343c534cb217196c772031f289fdfcb1f8e7daab1eeb1ce7ece934f747b71270ad35c30bc1c74071749f4b238ae9b0e247dbaaa5f419a73e1ba88896b557c4352257fbbdf25f228818fefe66468c07a49e082b72123bb8d37355abdc0af501f90121243476334693d3cffbd1f31080e6bc94fded1cfa6e8382b0179c3cef83154a98768a12cd408879902d1e3336e900a5387da9bf6113dd7392814bff4e2f8f9c87f5ad77867af2823c6f249279fcbb06f14a034991a9518af3a16c6d5599ed41b21ef4d5bab058148df208d180899724c37adaab5e4eb238d75fc756cb96ce749cdf94374a1fa4597eae999798a03dc17119bfb1cf1a8adf572071155873b800517b8f24f1355efc5626c53ad0815f4a82d11f7820f6165a284da07f4e7216f4bd7c20836eb468e0cc04d753863e22fc245b43efee2f2f3effa9c2e75f740f4ea334abbb8c1f414543b78672fb5aec63cfcf9ff5f08493fed1fb2f0d146a5767fec3f67cc814a223d198872f339bc4c595c8ae2cdd5ef89324ea40a4cbdff98d5fcffdc131238cc9243d2b19ea7430696b2a2896029611ef57868db9e7e693977d86b60aae32bff81cf74afe89276361b630bcc92a67897fd63409661b90520c321da925e5adada0e5bd6026b66c75321df3dfd7850b7c2648839a7e36d28615a19c7767735747bdbb4a1961cdb610f2b18c48c5a7e60ef20d0899389aed204b53d5c6fd142aef745003ad08d7f5ca88cf77b69ef81e9705d6958f6b4569f214c5eedd5b947345ef090d2d1b51fe4761b1d6984416d3bd3be089eeb0f2fd8497f99ec41c2eebfa67058b0710aaf31552344f61dc1c47e3d383ef0b4ef6ce9fd0d701c3836fe6e7f5110807c8d59efc966af7cad786dcc83d940f1f84c110d366b1d4a678581c4b7df964aa74bd7dd4db97c334f6165197db5597e869b30ff228af5ddf28d297c62422e0dc48f5b3b4c4508f2c7e90ab3e45067bcaf33d5970f55734a0a6e45999d6f66d3b6d59ce5178caecfbea73a427917ea481005ca558ca84d6883dd0442944d67cc24570710a8dc408c8872f6d7c7102e4db1fd3aaeb9ba3abd9b0744069f57d1d44120076c28cdc2105f71d0911f654094ecd4e86193082e8882825a53fac62744f6ebabfbbb6ad35bd01f24fa218fa52f5075e0619329815ab31a0e5fda302c66c0461dd8a01cf7c69f943ef2b5a5742c24d4aeb6bd69f27e1ab28e5ee66b09e197cf367ca294a3f2d9cae611dcad3e87e1ce55a3d142902679e75783ac35f59ea08418a63289d1005367e8f2f40e936195ddbef5003bd9fe726420822a0dd5be0cbfe53acea386e3d5ac03e1ed63deda620ac8b0ff26a39555faf25c54582651a9f7225ce6a9bc277d44d74a7b865bce2d21edede0e193777e6025cc07b62fcfb8e1f666cb443301beba228ec5dcc0117cf094b81efeacfb31841df3e998d9a95f7b9cf43b61951cf5080d7ca5aa42077ee7e6c59ecfd836553ced2bd11a43211caa0cc1ff333428059193affd09d90cc3a64a2c17f2289fca8c06e0e0541fe960ce615a9b2727aabe6b74e256d4f210585f437b36ca7ef6e56a520130b6f08ffb4e71bc5ac296b678b300067fccdcfebf220af4453295b1e8a8af669fe32cab6898c15ae1047bd9f3930d932ed20d9c3ae9fba47b17efe3d9fe458be2741e94ec8ccf63080b87522870c2c8c2d82ea94eebc97e2d1d1c03815265d42252d4d3c67a6b778241fb8faecbe6da81f707662801755545d4a0d14590456fc1f061c68f0ea19400b2694bd0c0884bb8d6a7fba172ed0cce228b4a312e321e0587f42e8e97804cb9c8e4e0c36089f2effaba739ffd60f48f1c7c6d86029f9fc0585048a56945354689c8e2a6ea19f9f624c110cefcf31b0c0e893bf2d64c44f4dc0e36ccc54219aae1df957619bf2974f70446b766a47cdd4ed23c6fdce13d383bbc3bbbbee9e78ac22d6e29abb1dccc4dca9abb42fa788881569f276891a6730e6946aaf0978a3df010a2a3c93f83abfeb8d3a281565ad851e87df1e82190d957496f767607925a6eb04fd5717348ff4f12faf6f32083ea5aec15c5b3640c8a4c8c35a2fa1b9dc7f58f5e04e46799e5720bdd644aebfac886909daa00332d58fb437b0dd81a5ee1966687627271011262b88b493fa21a6afc7a58a31be6e6b5d9acba6374042d5e5663c11658e1dca2f81354b8ca5c08ef8ea765e9e6d574848b08f3a480bcc47f13694b2978b6733132ac88bebb75e18a1e93a4e2582053a103033120b5befe046f99c078d481e2999b52136f642c2c22e0a5251b0ad1ed4169c0aaf24f9a747527d5c4f982c041fd8796cd12717c4016d613239b9ae045e9b29a66c1e6d819c4e774d06c6182c801ace7483f91434b748e4a6110959dfe6b84a0ed2707b2bd8b64081be36e03171269cee8c548f4530db76033f379f1682b864d631225cb51d179dd3df27911311a91f985cb450fc3a46e6712ec56dd135785da488678ed27d8c9cd9cc8b747a5de7c9afc45e86530cdbec775a3b668e6df827a577c3ac2b5e3612c1fea23c280c29262748dcad5be5fbdd46b3e04dd7167c03740090f206d6032b85144c79bfd54b851ec2dd6092337d062352ef2aa1da0cd113efe6b679f439ee6bbfa0aa90be17995692265bfc7ce9dbc8eef490016f573c7ea9ac95666209291b16ee5ff656305468f406f9091354b781580605563642219e8a0be3b920d11d863c87c0d173b2d4e30f04c23acf624fc9d6e10ff41f30b3e763ebf9689c93f2d154924dbf693b967129d2e5978fc379d09a14b218b97cef1d99dbbf7c61ec83ab0c4d989e78048101a9ac40c26f6ee99331001e68e482d2c086358cf599160ddb9d4995d3e750693c87a339f8b58656875c0c780bf33df402975fc4af259dbfac1d2fe18823bec423a4487bd069013661afebc7b604030c3eb599edd671f760cc30c9526e45e1f46ff4ff972a4d231b9b02e9e2f6f202651f7a4530e28a806e7347affa103f356b1f8781e6b19c062a5d7c497ab1a5e618ae0fb38ed2a0bd58c5f6d15365dced3a7710767118ba50377df60ebb8bc3943b12c82c3f5cc181ae9cea8d332bd49a2c771d0128f0459b7a7315588be7d6ddec2d2343f1cb4b706ff90007bc8cfaae98ce2f06281958073cf02c975722ac8ae37eaa057ab36ee9377cbcab81392f166e0e306d293c7bab25ea365a46e82d4d03b4e4ad5729fe6f1142deb219e4c2e20eeda2b03fdc31db6906d4dcb16ffdea21303fb4680a94e219d32ce3cf10708b0fd9655cdbc7055dd66696c62af716d68119afc5c955d8181e82091eb60b4d0c03875a2eeab4dc477066e9ce56b13366790783419100e8ba83e32ff61de0b901352d31fbc6e189d1fbff7ea70259518584de4e031b95930465b3a51c785d197264205a0447fa15afea1df02e130bffb361ff97fe959ce0727b81271aabc74507924f9450c52a2d3603ff9a9f62e7a0359a412fb3e94022682355fb7f8c13017dc32c92fdbd465627b9c6be2aca380bfa3d24863cc56e3b4f47ff4a4d69b2a32c360c400ff57a10b7df628eaff56f7e94f11be500d3a328444d19712689cb5f9df0fbb47e9c904ea7f522b13dc3ca306539c82d708bb8c0256120cac64c071e10ae4220ea1b12de240920a0aae632777d5bc082c5aa78c34e14b1f56b10e406d4387763c02d098951a68d868820ef6cc4a9988329c77881376f762235729bc09baec8b6af2d03e1bee382f4542af4722a4edef831af822df86eeb9140b7d450aa21073e53bfdf23fa0421dfbecbfe48895656edfbb2f7401b74d36bdf56530d2e3bd2d804ad72c7930b99af9144faf9571c6dd6928fa0f73501979c745f20540ee40ca08dca1ed6753363f81e0b2b52d795e9ee7861f5c4fe4fc8b6857414ae87c451cc2b2e12bb4aa8e5cf6eadc878aba5ccf4a5e35c139db53c2ef29b46b22e7a3f049a72a000edef32e6900024ea95448db818ee08434c4db2360ae9614c74da1417a269d2a65c19fff3f3456606d56c13314b8c84d252806cc18506c82cb3cc84daf6ec15a9d57975759136a5d8604039d9ea57aeaea4230e14431457e42ff93a585012e4bd971236c89c3bfefa3c15fd22fee1af1764862f0a11f0cce0fc6d5fa5025774b93b3e0d70e77c79388b9d35e8013d82a59bb65930200714ce383f9a133675da41daa93095a6226124aa7dd949bfc08813175fee62bcb1087f9f27f9340ceafcc79030bce4796c4153e2ba1dc924db9364cb6ad8f647c58101f3d132291283f24f45efd515dc2f106d04f0482d8639cd6ea58c4964fe51a57ce6c975fcff9a0975ecf0aa69ef8d8d2c61615993a203791b1a11a3b6f8c52a1eea0bafc79dbab1255445747a39673e3d639675b8214cedb22a913251a94b7ea3988810c81296d42c4ac8a15dfd92598f30b7d7501b85a30007088c1ff3321a98379a16a46537f92422f275757a570b37d49609456611f22b5bc88d7c4b539e27c696eab86655e4341573a9e3b057e7f4688e074d8c1c750b50a6bb10e55386e7ec9219be2834b47d2c717ee49e7de46d30d85e50196a90100850c7219ca2b8f82c811b123e8fa288addd3a8f90a77bcc70c09c805ccf3afe218cf6410c0e27f408c98b8a980cdcbd777b89859b25c06defa1fb396cd13866517caed9bdef6893ada6c611c034bf2161bc4b7ac894fc945ffe5e74f6da03eccb35ad51e1987a42b55b3682a45b0fb081167add787583062e3160cd70b7ab38a029f0ea6f08bc1fd636d64e4fb6dbe277cdde114956c38e80fdedab3f628e2e640c1348e238e543b3a5fa8ead3add014b354b7dbd01f675f543ee8cfc89205f9013b4a97286851306099481e447e5001072fb89f839488d3efc1db0b5f1f446ea60a41955ae0199dcbacf181f049305c026c57824ee2371584e95751217641d6f4259d70c9481dc4f9f792a7f6dbb4731f58edefbd27f2c985627df05cdbe30f3c72f60b4a8e26f4a799c94d70ce4c16bc13074178b20030cb9b0068a003f1ff2c39d84c0a7c98bf04b19af2802affec069d9f857befcd34eddbaa0b4c154bc8fd7b76e9373e7ac6a298a93f90dcefafcb74b0a9ff2c9e3eb5a146b674f330220d4c33a34afa0aa19e7071cc362454ea9d349e4c8f9040928cb93b437d082c21ea5bad595e1abe35d19f06b74af17ccc2469cd270427c38f1e085f819b469653d7de15a6c179563eeff0b58cd536d67c32c232dc70ba2cf4c18f09f8a57d7361ca5b77275fc75935e7f2645972f6c64e878aca0ce120ad8e9b9e06f00b48d1069fde4c439490bf0afd589dc7ef397fd0a32a3406b81d6010424caaaa389138159c03a6f74cb603f168bfb9c9d385f44760c78c91d17282a1cb3f2e9a71776aa41d01425933a3e416ba7786656c7d6cc26d6fdee1e613de3cc03c23adb76d42ad030a43a0f71b93196a3d0e8c04d30591bde6eec084c02d67d7a6f9109044d5811a3c4da309f58ceba4ab463fd1fb4893ca884184fa9bf547f2ef894f13b6d0801f82ee3262cca46d7931dc4930cfb202f2463d4c881f4d3a4af528272a411f2ceef5de12455dcf2a4676a383eed0d14adfe5f3b75d507e9d38340c36933a7a2bc96f06d92bc9eda04bd731b53d6adc102b44d2276681489c3bb7fd5edd3fa5789f51494d22e5b1ed2ef707c4fc4a5a3645f083b14f4567c66fe0b741d18d099702f1edc2b55b763dcb09c861e68c7888ca9250fccd17cb552883faa42e43d04b789f4772dbf3a16dbe3e226903a87875454c22d70d54c60fa2c3a88b2b277120a4f37dd02ada49e9752f171fdf702c9d4bc2e001b9d8a23f4b9fd736e0c7caa28c362080de9886919993eac5ae93a5ed3ecc3d0304265fd0455c12ec012c8da9480173737949ddaa5f17e1665d14361b99496cb2ce32751d63b9456d841162d75eed351855a1c082022bb6aa17fcd20b5f1bbc9aaaa73a01a35cbd407b142e9a6643fcbcf01a6a3bc30a5a591c11b38f92cb8f6c5bdab8d6e9fd64e052478319c9d5900a0e9ed6eb3dce7d09130eef8fe7ec56a39fa5b933455bc40a3efc60a8941e20adf1021b8931656789919bf1de02e6920565f6894e87314df11d2903dcaaf1e56c625d07a76a836f478d59f4b6f055a5fd3fb34408fdc8496a1143e4741bae07e4c38ef47a6429270d6c12031d3112d3f035aacf468cb8f75ed5d2a37f6146b705aa50a7c68745411448eb55a012bf266713f6635cfc1d4500fbba42543b02feee9c1316a59ddba8b06e49f62ee7bfeed5061d303cd849265e76ac5c87f40117213f157c9ae4997ba4d6360c6f587d8b4f4cf035dae53660ad3bee06e66e55823fab50504b998395659cfc19642acdaad2374adb1d672e445d42ff2f0c100477886b07f60548bf22ba457a82b66217325b3afd3f283bf798d504a5f34333681f80442e0bc11d57e6d77bf0f3c5fa00181c27875379bbc15ad265adc4c37ec31ed1d9a4ebff1753670cb85954f5561f09a242e068935ee103170cdb458362ce39959c6faf1729c076c9b2b02737c9ed207bf45a9c9b69422a80d8c00d0c74748f40d65372d722226741a26327118a759038ecba652132d03e0ae85ad378fb038afb09e66eb375837f8bd165e380d74ac9aa6c086904083f139a6039f3334a70be550ec8d156ecd39ed62655ddcc31c00ecf5bc3c39dd55f3b50f849a5d764be9ee026e08c33ae794295ef85b75808805ab9bed0ced65129b08e3c646925e591d8f6870eb521353f73bac737f7b6fde309c98919c06b8d21694012f8b68fd3d6bfcec562a300817bc0c7437f8295b7d6feaacb3510ac138cea8777e06c5f8d3171ebfd1c98c5b734ca81a382c4dceb85681bb59bac177cfa13cf03a87f65f7558edf2d94439ee4b2da6649181a8e9133966b8e5bb1be260c636170bbcd657b5932933ed391aff5628b9f05a03f218484f141e3dc261a4534b7b52b022d39cab16a71ad443068d20388b5c07765997d68672e92a824b3717a28e23fd3975516599a657af72c36a42a2080c29f000249983914232734c63178b947edee878d22ffe5387fc0800b63832dd34d7691b8bb06cb7bb3112b9dd873a3872d347ce48deba0fbd245c0d83ef0a368e2fe132609fb33f8f48dbd4bbef4726e2e3886e9e35b19e6e6eef202076a17599bf71829d817b6a7a5d0c3268e8f30b3b341426ea88a4b94e79d06774c321484bd5170b606234493145f450266745d37ee9c9d2a49e58bdcafd5ac6f95fa8245655bcd33b6d87e4e1fe2ed8ff39bf905231daf6f1d78e6c696102bfd5ebac9b1cd5c3bec8d08fb49d7920c428addef891dbb97904fe9e16d720df17187f62e7fce3c56e668e58ff72f8a48a225749930d25bd73c926c5c3fe2b4d690dbe4d416785561ae947da65ae926ad4f13aa2df96b952dcfbeb3229b46cc7a556371ffc95c7c870288cf363ffe0983277e589b8f8279bf9d9fb15a1c0223f90c05f29cc6b413c840e5fa69fca6d05ddaf6b5b005f316e7549340b9e938f100e261619aa499fbc26fe319cd91d302671224d43908fe685db1ec49334aa1bcf240e32c28bbf102f18d3aa64a985a21d4e05656cc5d9541abfb228d8d07a8dc1429c917ed438fcdc1601b3548b7436ef3c7d1dfd990c4966e9322a508bd975fb7e39754915614320ed9a9049096ea62d058966f118cb3ee03c21eb8acef25829ef0112d0d94fb283c963f3cd8269276bb71062f80294be768fa54325dbe377de792967c86bef12a1d4045c18a6315d1264304699ff18fcb129c55c897789f959813833a2458bbee17abe4f163e8555ab7eac04021c75dfe79c5024c1bf1c14c6993d3dac5e0edea405ca53563d98ec1bfcade89637cbcb12ed015563b2a8c16baa71ca11193b6ee97bf0fb88e12088516dae8f739d468d8703f563acd3c5510ba8eea8d869da4ce085526f2441744712a06063a7561f68463bd8e855aa4e05ddcdf035ad68b6b5755cfcc5c9b6accb56855bdfa79305e1949416c28f07498c0bc9f0bb1b17cf1e057f1e37cdd95777d5f10bdd686ee62dfc86e0149d6d878b0d789d7a5b8e139b4f55b005c251fbc42fe2c24ed15588b90d92e56c294c6d21c43945effdd82038fd0806a17ddad5a1db0995201723a5e93ec8b10e48d795c250ea1a0ce2a628cbec33a732822af573c2d022894311fe3cb607c0d17149886046dddb5e78af45cdcccc0fd2b040eb90373903f6d74ef20b82f7890876430f235cefb27c0a0202e5796754acdfa94674d09cce444682305b6a8acb46ba9f543d3f606da31d3d1e10396dd58b4a4f41a8c93227f8f6f9628bd540d8009706e4274388d79360d23f7f2849df94939688f786703e4951699cbdceb7b2ff622ce60a55daec0fd0d6291ea4480c28d3261141d9acf1cfb9510c180acd4682016ead502a57c4c43bd20258217305d0df800bae52989db46031a0d2094b2ea41cad3adbab5351e9b8b1a60a4566b8a5129a8bd61555dffd651287c09ae8cdb4df13711ba4ab92d2ee234f1784ab1a23ae1108eb4ce14460f982d6cd297872bf33b01fd5f269c233fd5cb6792d5d51e784ae7a656e166e5f3a56fe7bdea4781056b155d1d7e9a26a4408bac286535e9ab367bc80daa24d59fc6efcc8c8c21773e2470e50920a34c26bd8f669fc0bfdb89a6776e468742e15766a522424abd23d7bd5f53560de55de19147a2877e4d643c3f0288e15957430324aabe48232ea93464f032d5f94aca648616ae1f4bfc68be1ffb525ec1d2f2a5dbec361bceb95094b6eae49d2257ad7aeb32d63e663ae38f44eed7528ca75e0a05159bad6e652695ba15c0385f9e8ef912cc25a1cc0ee43f6ab894b8178ad21b1bd059c267a94fab71b0b3fdf67e6d642bfc95aacb6475336652e201246814054dbd18556eaac2e9ea79194590b68772d53afbe5c7dcde340799b9b58a3ee3255ef86b5246164767b080c0e57ef567245cc7978e9fb3b73433134d487d14eb0cc5a1081f5691d943e7370770825b8e9251bf596735ff4f72b5ff9b0dac13314f4df426340cdc3addb722626769233c09d750a1e6771881b4af62c48963d92af85fd1bba73956de805da492e286265623850d92e50892385add1442dd41684ec56ffdb49341329a885ae146db6ea07dac9ff1eae01f3231420eb23e12a101e9636d21b5b6113878d989e16382e0eb45d651e4957bbad9f0fa47e3a471c394a63df1d9dd14ae3422d2d15b4c71d54d6d22b1f6d8a16a0c87efeb6e0087031f90ec245c796e6654553f730620e18b7f747cad10a0b8720a0113d0bb850c0e8b6f843c6ef1de94a11b2e5bc69226ea6fe975adb372021cc227934320e3fcd74a6e77b632463b68a0a43f00f7c1ca62ead71fa47e4b3b1754c835b092a16f1100b09aedd92ea8530766cb8c3e2258bcb699e2575646e18d06a365fb8d4ebf2908f39199be3612dba8286950a146624b9e6f628c3e6d31fa262b8ab8bf31d14eec342d20799c41e45ae43947b614696428a8a772cac1da3e10bdde6dde4efa9f53e2db20b485c3256150f8a4b012357710fd32932f7a9ac9dd9b99ecdf088b71e42492ae4fab44b023f8c4c70c54332aa43415912a56d862913b199fac8174b211ee0f9254e1141991bc1bf630c77e11245db749654ef5bf09da5920caf68824c1316791f42f886e5491964353928659d6def9e0fd697a971e59e682db060a8ec5193083a5d2f295d571958259f6275dd87be2dade85d2da7c497562d2b934849f6a434c6ad5abc919efc0263bef41205f61630ad2ac301ebecb1afc0f90749f780f435fb62214ef3cb9f4bed22ef051ca2e60d37803d897f78b476c4df177505869e33bca59cccf32db8412bef04939c379fcc6550d3f8a37a190185c3236f69e1c7e828cc11319e3b426906e820fb5b03c1e3ac7ff6287bfb1514f4ad02acad476784c143d5221a3381206d8a14e9688b314ad9bfbc3bda5893dad96565bcbfd494b867e35c17cfa74a4817a7e15f9bf5de3b0cb951f0124a58eca77606b2b3947a028407a738112d685c236ef0e7e6855a2a4f7549fcb6deea490eda1b2552a3a15aab65cb5d1c1ab8bb55268e4f1284a47f72b6095f5f51635b73a0dbd722845d129b2f4d3d721a409b9cae8f7c6939841026ae65d99cd8c7abb09ecb4f89501da502586c944654104d3af794aa3a6cf5e35eaf4c8082e6b020f6b9efcac0eace9d174fac56670e57dc415a0940d16a661aa4497905773e43cee67ae04c2755cbe49b4ad808f14e9664f7c301b29d0f1f46a4de4ccce754d4882db5bf483c12329472012b802de6457fdc96dd3875b7beb374abdf1ae7cfe3de65ca057f755b73702fb75b4ac4304de4422660ca0108a030080a45427ff20e1c98d7904892e3485998671bb49350c9552c7e3aa68a3364959d0a9d1070d0d0be97700c668e74b6d422cffb6d605594fc01fb15817055e4fe101274d8920289a814a069a08c9c27d3585f59f6c7a92baaad68be8ebbca0813e4e4c63f2cfe48476da374fbb43cb076a7e4f6028cff8c01ab1a48d3e4207a3a1170dbfd95ea26a86ccb4748b6d363ba89ddb6b41530d6b79524b8ed659952202cda757431712cfe44e935664c76c6a3ae4145752da3119bb0c66d7ccd0baa636bd7ff75be6a562ed030439a808bf3c752d0df3c8a31f93704bfaed744092123d5c7f2f2cdeb7a27d3571c6905773cc46706ce5e5887cf0290daf3202737560d67292b68e9d2d43b49247cabaf8c2bd2dcdc94f95fe9ef6ee04ba6b6876226fea6ce757978f8f33937cecd4465ba9a53196fa4b71b07b3a20697d89d7069002620d70ac19be20ea377d52d63920742b1e2ed44acb7138e53d6a539c1d6d9599e03559ecd447547085da8f963476e464d02e8d8ac537b3633cc9fe58119fef6b4e06e11209b98108d13a87c340c994869aaf3d90378b3bfb64c045b9b81273cc84fbb0c052294e3ee44533622008c9ddd9011ccaee17986c9b64b1c084ee5977ca1d7f372dff109ef8efef5eed22f05cfa8883aee7511af5139dfc3fe3722734fc640903ea51a627fd755f779b9426f3f5afc3b39968c7237232ed74a28c833acdd0a068cdc5e149cf8c6312ac56aba53cb3bebba75a28b0432a404043253848564e11c4c6ce3e52e99f4a27352b95e2c3478e04b540a18ea78f02fdae83e6834ec7694b18ea9b31f03c5be077e0dcea4529ae85835439e02a194dc7696745578947678bd11ebb7cefa04e234c3d6cea85d048577a9dbd2ecd31a2626dd03725f2aec0642cee86609dafbee9fa2a649b7e7d43ca49aaaa580f12130492eaff94324cd04c5a2e0899445d1042bd20da2fe2f5d045027aca7a14d63aa9011bd28765b52cc320acaab806087d01d0eca19d8fd87cfe7ad12e5168d6e6a40b93f155dbbb5895956df24add4f8c1bba7195b26a24dc68a1c0dba6b6c5de150e0dccaacbc2fe951df0fe30c5fe99cc955bad69e719ea307c6c9ecd9b0ad50b010b63a906e62da71d75edf32e6cdc5349dc45f9f2ebc3ea633c6842ea67fa05b032f2ab49f2267905f3462522b52eb517dae0feb2e81bbb00183168061768b4e1f2267e5ba9d98ee97528705e8bc8ae8d614d1cf4c5749dd7a26fdb894064fd053544e2edba21773fed41fc38f8e3f20e27a19431df52ded3ed548041ac8b49cbcdbebb05f6c09a19596f0729ee34883e144271145f811cb7b6fe3d17c03ada2b282b48c51df8a32cb77a745d466c0ae0b86f6b723325f6a2ac90d5ca273b5bd6b46f7246e953f107e90e784aa6d383fbc3872abd2712f0a8608c7aa677652f8ee275e6bf7204f8b5bfce0087f545c078ce3553af93c2082a9ba5fd581c8edf45d74a1332bce483e65e714a03a41bbb3c9380043062e41136f4b5bed013dfe236342adcb9779ba970181b3b27871c36c3538084ed9525433ade7779609f156fa8494c5cd3970fdeef516fbea634901cc79b9274652c491987add2f557aae213e89669b36cb529d388005616d7bac6154d66c0667fd1928f83e5595714e0938f8c4124f1c51e7cf7ebff87240619afa92d76e1a05fb9381fa6e060561120c5365de4b417bf526d383d39b12945685fe123b2e5d735696f1442979e65143be8bb31f1c617431996da2e60e53817c0c84f172f9b7e9a51d3cf71b283b31ce1c55ec63e2dcbe56bf317c6768829618c9e535fca51dc10f88b3fd3df5aa423030925ef8d13bded10201cda45ae881d98b81a09559039f5a07a0a90e99d7c3e0b2c64163129370df8a397ec5218c7319ba2e69e8941a8bf449d48d19cdd140f52d518b25ad9137c12ba3f6f67fadd5136708b7c1f921e6194ee5a6f24648572fe11cce3a920832c179839b3ab71b548929f84e9b24c92e7c2d0e0e9c0c5197536610b37a898092b4b47b232e7b1ae37dfb7ef1196c1ccf7badc1a60d9dfab937faf7965aac10be8317cf2e5c0d592148852c4276467e3b08bbbb8c9a16eb40da3a4d0ca1fbfe0e99b43eb5069ed5808e8e43593a95c18236fe3b7403dd330b48a354d81bb1d726ecebc9dec3e2307e7d3641ea8d238a4427dd2a633bc221185a65f23a2015b8a543d02fb83e672d9567464d0279891de975ef820d32e8a0bcae8866e1946f85905cb0ba1e0db3b1703f32d48da76ae43c57cb5ddd447a705e0885f0556934520dafcf93d52e65a701b5bd3fddd55aebf7112fb35ce05ae8a39a4ec8b021823370f1ad4fb252cbdd236e63e804c94be6179cb3acb9baa746de6aaf7c33894f64275ca7b393a4b16f0a014ad0d49675f336c43760e3895a9a9c1e2e85424786ec30d176b04c98e3d416b1187bdc962b49e11a391d9e41f045e0099b0c042e6ec942df1b3ae1fc82a3a7cc6fd61216d7d9457394a060c3f3d67e22a2e02bd9e77d34e6c1ca47751f20573af4b706d807261563b512d793757d989044a8d4c1c2f2b6f11ad82756b2c2d28fd4c7d23e71c25bca70c84c733ad1b18597209748a07c10e73f93f2b7012c273cb7085ff24b07ab198ed62dcd3427621028ceda8ea60ca12ed615643bdaafa196a1ef7b627c23134aa8cacd60b352901b243e03af5395be833e0390ee1ba6b6fce4c919790796f8d922780c7488b871dd2d99d1015abef615e4144ba69000e7e354c288848cd36d34a0b1f82f65327b220d5e68e5606f4a6d1b847eba6789c39147f469dafa708eec4d7ed6ee6a9f130abac03a476af14eca6ef6e97d0f8ffb65498c82706a626adc9f9e18f8afdf867f2697d49384d4f040470c0e1d9452d62610c16cb39b778c98a47abb87f83bf712151eb9b0f95746beeb55a6622daaead9abc8c2371e70944ead0e486af32a1dccf34164e3271be54055de124ef816ca3d9b6dd5b007c3f5959a6bd528ca53b478d34a06a76e03045cc484863bb559cdf4cc6819c45bd460666808cceaabbfd8a0cb650c5ee0c6c2432d77274ff7df566bc147916822fac4ffdb10303ebdc06e8f963f97794d213f925bd22d0a4a80b980f301e33a5e3b27113b39741f039f7070555d5d4fd842e3de81ab6ad1e265d611dbfa5c4f2c4608c28e3984bdddda847fbfb3d96c6e7a510617b8ac19d109e1e99a8b4af5fa67ae7ba52a5fd3608ca509d2047dca2085ca0e6e8591ab2ec2b2893ad44574432e7dd5c4358cf350a3ff53ccda76e07c9c4c9dadd566a8fd784269c98413ce2bd3583cab579bbef7227ea791f055c1527a5a1ef4c99c7365bf29e74ea941e86a8b40664be5562d5d0fb14b569c3214381bd6878937a931fe70dd4fc44e9c0c9ada5030bbe76b5c43c4a1eac6f33b09b8e9f1e9c49d934a26278e9abd686f2704a74a0592800389a2f8c7eba1d327553f561057520b0f136cb670bdfdee873599081f0ed459d2749526eddb2e4c53e2ae1119c8933b86468cb0655d3f45930de305b188ee6ea28b68af5528698e3c6e310d1528dfa43a854c79e2e9bdcae0eba13f57e52586fbc7bb85beed455c8e8efced99d44359d9605714f51153a92c7a76dbd54745ac07187ac4ccdd397d8c5ff9dcf4383e3511db24364f1c35bf57f23d0216485bc1f12478803a8e8ff6eaf491cc97f19fd217e31f77474b8935cfbf327d06238f0614205043bd43fd264f1c948e060b6f8113b3915141313ef3e6a6c07da9e7c523fa2bbefb989e3e92f9ff434b44610eae9903528d8ec3b11ff2b2b67baafd6e6f16e861c1d8031d950c218e2588f96b40a089190b1b79be80fe07e5f964d00c6db66d258b6927d61e6d321997021337558bf3e1b8598febc3d2202136b557b1805311243e8a7c2fe63ad20e4b70f10fe34fce007d4f5be44218cca372ab37940ee4226637cdff6db5066f743ae14c110cb618b93e860c31e4d7ad63c43e2a22cce7dd4f9fda55fc122d33944389c8d61d520f3d1d22f2a83544ee9610017c50b791baae70713e5fe8454f211f824a74201dc75265082baffd985a9a7118333e55090e1a86d67f2ae14f9e34ec3a5a2c6ab880c9765c41ec1fdba84b62a599f6d7488d43a5595b68d7f524cd7a7742f76444858a88454eed54003439c94c60d1c5fe38f42568d56893a03248bc3a176d741ec05c2d9e20ffc0bf98fc581e359eec08c60bf010792a1080fcc138e3c46bd55bd3fcca13c67092cf035e039ed8e06bbc07329cbede1382c05b19c71bccb6241aa0a13b9e55654b2fda09188dcf16c4f25b409fb59948f413ef1149fe117725cb366187a99846673c26e4fb790a5bdb7856bee57166203f5f825e426ba5b075f882e245f74c3ef0713bc209ca79ca1d2ac164e683c6ae6ff88ef842df36f63b2c13430840f1772a20b2eec2a60f7d57616d53cc0bf6b2b2f5512fda8a81daf5eb8b494e464a19b65e3d99fefc32f64dfd956545739f9fa4d88557dca18ca3724257e0ec4cc049e4f82ad254df57d69923761e2a993c8b9b2693fab5b770309aa86eaf43be87cf21db78b936fd2e739722682f879659439cc59494186bd8bd880f9eccfd45e1dd482f2f0f8e03bd6f0adea87bae0479dd4f589c90d6d546cbf6dccfc88db86c66a6b849c32d6ec2c1bb0aacd8679dfb084ada89e4033439312308026ba53d8d9bf5502acb22ffbd88a9f968330dc9a4a80c7ea157d38f94a4b837966367d250569c8c634d7eae609dc3c80c54185fe5d9066d1a06252c9ae896d8c343d0e19015d476a36982adf7269999db26125a574e7921fd41b151f0b7bc1da6511b6dc92223d430efd56ab4be2ee88c7b002907192dbb78416f6b54ad39cdf2cc8c1a1fae0037a49e6d339dbb003080e47d74d6912417b873f7a1a34d4be0c60f195fb12a5a99e5414d4df1e73d98cb296d8318512adad42737bc1c40a5d903d74f31ea8a846eb2f4beabda5d3e14fba4f7b474eadabae36be4612f863ef83c51dccf2800ae944383fc7122a6f7dece1ec0a2a3db5001f2af7957e00fe29525e5e7b5e4089531865c8e9c810f4645cfd5866ed4544f3771156e0dc0cd2e6a6ac95d2d082be99f9a450d45662e66c5eb60e33d96321693fbd537223f0cbfad6a063b5d92244c9064eb96dd219afc67b60210310e9b4bdd26aedad27a7d2aeca8cda2a3ea2a9d376f7a51dd48eb6b525ba159b23a07d80780cb10518413d026e0618cbebbd04c00e9042e5e15f5232b7d01495ed0840436fcbe47a50438b089763f39bee40d9525ea62e965196e5b157bab84585cb55d5edfd87cf4d7f5c3ffd9595ba37331b56ead249b2ccf3d6cc6491c58458d76643a9d712467b9ad568eb350b4b6ca67fdb10bdeea6c984b072c93252e87ce3bc5cb9d5859fbf10520aa64b4c9461482614b3b00db97cfcd337619a51e24d3b3134f72b42a044afb4056fdea9e5374cdb64547bffbd4d5a30a63ec9b12236285735ecaf0b33c39e23636ac48d1982d4ca984a089dbf659d0572157509c0a9ba71946045f89a7b3b9b3cc5781d54027d8e284a9f1ba7c34664bd84b4fc18d671d3017c53e6a3a4876885fd7c4040d7c0de1c770d11536a1dd600d5784a96cbe2008d23466a1e5c08933c6bb58627953532656770cff3b0267d4a36a38e8db31b2daec4cf18fdbb9014e48fdcf505eab54a8810c2f37cbb4b9163a5d41a9bb4081d24272d081e1614f67858bcda30053d4a2db0a84a6dcae57d6707c20356f4b3e51c0bf2fd5190f01631b6d758695f816832a3b7f0f084ad5f103ceed00b601146dd096ff93171def3a3edf7aa6cd40de21036e764b65f9b89dcebb645726fe9ba13f116574c4b89a4a04132a9543cec0e97a1d28da5e4be845f443823a975d9bdf9c2c7804d6dff58a575bc5332014bc5268dfaa0f8385cb82e0bd6b0d924b91f8fc3a0ef12ad5b70ec44b10a9a05d27ba70950e4cbf27637d457ad22ca561991f944f250a2f2d9afa12f137e08be8c2ae58974808f486af8d501e6995175cb6b3cac0c72dd151930dc4a9618ae525478ab6c0c33c2df342384a7d5bdee1181dd7083f6c217b3f82fa62d57c5e311356dcaf256e6fb0672b529aae0b11409959957d2e6741e16c58a3ea0a43111894117cf705205da1025ce5f0b65197630f4f9ad88c02b375d59e70f763e2507fb8e207b9f731870f935e0eea1f1adde48c63920216177765dc24460c91fb802417e0586f22bb78d272fe1d5f44a5059d87115a42b50aa10cdf3ec544f09a6ea240a450330a7a1c598458cfb551cb55b194055871d3b83ed0632101179768154f574d55b4ed12c78466069ab075eeff8e7a79b7e9d71119c88f598ba3f676116c4f98863b4d0e0f168de081762496bcf272e35ee5d9b8a71bb7a66f6e3e854fd3a05cac6444949f7fc9f396cce1d9026e0665e23e29dc1991bede033b2ebc38a744db80e30c18968ec66e290758cf839349594b1f5bd1b387986868f84d5b413a544d99b8d8f88c2b7c920ec20c86c0499cb18515ef476c7e818168d81fb0d0f60bdb3b50c3032d039c9e3d0b37a032bd9aaa665d6f33e56769b83edfd0c7a2d35a39ad14a81dabf0262de2f1d6166b0d9bde383389189428adae7219a8c73c31cd70f0a94f727622ac6eab813b91e084f8717d92165f2aec402773904e5627dc48205ef29b0417723416531e09a3a2a4c7ea4ce15b5a5bf049974c2ad88c5a50b47c6a0fead5da28aafdbc0b3cfecc91715431360718b3b281fae3c4fb68d0e0fb689cc16d67ca7e169f3a200a9a90017cb4a972eb8c7ddce3003640094dacd20a70a6249943ad348c205fd3d6633630b79901276018f30181bc893f716e598eb7a48331fcdbdbf7e0124a25a4c3a62337465bdf651166d737a6212df7db2ec87b6ba3c56a18ae9bf3e104feb5c3b4182a9580aff427c1f9f918350db445f3566e3b504e95a75481c70512adba310f0f925f4124e9cb6de5d18707be16706f74f837a98ddcc87d179a049ab3896cfd23b3a4bc1a91d8c7db8032b06418b78d51ba5c3a231ff390d684641f93738339af8012e2518ae96b853f3cdef84c07d3baf437f780b171116bc5f55fb257dd92be31f0c55c6a3407b054be70078d61930ebfe5721162e320f20c9f44b74a52ef731134a7741184c184c9f00266e21ebbb513503203752754c97573b7a81d1bf2001e3dc66b05225607de4489dd14f05a64e63ec34b8738cc2f4cfbf85c96f2d4b96e1bc0f54b4ba00b5498b611daadc892f6cfb8df517881650b666520701b58db06c4b7880d8f842cb0d9bcd1b158f27b34ea14800259c1029311e26a1c9481676fdadcfd416f9bf85725ea4866f8febb8cd0a591437ea6e62e299821b73f05a3a820cb37ddac141b7dc85f88dcbf87ca329d767a7cf605ee7e3ad301c7afc19fe11192c9326373fed0672b0da81c0dad3ba85b8ab990002b70a311d687d0697a3312d7ecb011e66cffc929d6d6d18e630a86d67f2df4a0544722183b3ed15a7cd12161efc733255406b8f16f0d3d9c0afe05c09e7fe9276b08b1e6309e5e2c8e12b6173bb7586eb44f14b4501465b25187cb5db06853dac1ac258344f7ce6ec4a6bf2cab4b1dd26d1793f3b502eea92f6a3564b1a9bc7b6ce73f8e86b28431441166cfce0ac9ee3076b2b8f1a16d4d68ea9cc83ea6cb382b7ea03728ac45fd7a849552c112c064492221d8b46e5ccd481173a0d90d96cfc5a794cef6d02a5e89fd56f1bf7bdcc9ceecc88c907b7344fcc809e4fe43b8694a1f756e6e67e7a927ab53ccd685503ee8443202dbab7148119b613f56a4bc90b4c4340f2912d27eac475b093765349a32dc3c401dad13c8476dbf1a0c0e1f6d606d21757eb04c64722458e8697f60eb5e3efbf5ccae37a651a6398fac197e9c70edafe2e14a84184a756b66f00b0fadc3cf6f71ad4d676998b95e77abaf273a406a4d41bcaacaea3c6b5ead0ded81c5b090b124e29a0468adbaf23107c684a56ec14a5823c8857fa9c8c773553ccd05cdc7ed9522a1890247170f4bf9b6121a6e3c3fa3e2a5386e50278d2c398609641a8179c506f12f2603c95b4123d85a736a7b04ba44ff735e0d207aad779095539b2ba773b997ffc507dac631bf307956d95fa2847b15b421ec6beb0f544be780965f5cfb7186bed3318066f69ecdd6c0e6ad249dface4955257ee636b564aedeaf8de1193d472b686bb95d47e802320a187518ad9f7ef48b019365de8f7eb3fbb4adecf60b58d37171fe8cfefe8033010d0a050f932eaf63440bd19263a7245ed1fe5c55eab3cf73a726b0d2917dfa8b89725436fa7f78a7648c1bdd811362e522ee890d12e4e6fcb987f88325e42f049ddcc56e3df44bae9932bf1ef366316d5413b46302c440d958c2b03845567f8d7244c4080e6d9d25cb0c844ac5ddeaf5d2cf2a6349dd8e83d97752315717a5cfec5bedd5b6ab179d08fa4d0de5016a097e81386e4048b42dfeb2044c4005504a32d8f1bdbd6a2e5c4d37d71126b67ceb12f4e42568cad08f5aae3097518dfa9a54cedf456c13bae15b757d63b96d4504d794355d8267c5e7b777383391451df61a4e373cac3ed421d9ebf9361d66ea0ad6c453ea7daf3f8dcf15fec1f6a04e006e7b5ab5756ec334440123821db645276c8f1ae643f8d70e027d5fe3f6e4b19979afad1c9f028b664b0b10c25b4b6bd0460f06b0baef8bf2919f0426d7c128c1a12f281ddfe2c09824392f9f3fdf87c44f6c7a821e52e3824dc0704a901c63e3d9ae132e0e20f10d8b5957ec709c207bc16f92d2126953f18426d928e4b0ea7fabee1a0bc53f686f5eca4e1a826e469eabb8b7d0e61ddde7bc60a495b0d537ea9c5f4d72f6e83dc310cab53c9d31dcc286ac4d3a8a1c6c06d6d8f56e1d54209bcf3222fee0e2a4a6755172518c60e47a78a712e59bf0dfce9b3a75c336fd30c6cd325c0794779bb0c63929090a30e8ab5603ffcfe04c85be21eff52843765426a3fbf35ecdab66fcabd41efad8a20a4948257f676dee08111b05630a8b91d2e0d4557c81ff2bafcf8c4274d6ecd588f362d5d28136392537583b40f3c68076d62e58db0f405c59ab72f2936ed14b5f088048499b9999ad3f0fb9ef61ff17b789ef0f7a0e35a2a1b8d68441fa695969def7b64fd8c7958af723d2a8e1576dd5593fc0d922d27e1543d93c931eaafa92b7340883e96e3866a3577b6f8d37bcf140af8e71c727274e80a087d830c1bbe5fa756eda599d806856a84ca6686f6975c31d599000a12d8dbb1f931e6a785a1fccb039db06a57d947878b190feab141bb6bc939e98ce0499353933d97bc574267dfab6433e444083c93808bd328febbcaee4b1a12bfc187eb52c5053d8064ae979ddee8594a5c60878347e1a1fb1785e1d36b73ed49dc9c09bd67a8322fa91b5d03a11c77e9847861c7abbea3b0a3e9ae342c9b5c56fbb077c2148f47338ef65c8323b3857f69e9466787cacd18d6c142551d4bb0ab2e725002e32cd89bc84765e95abdd03281fdde4ce0d52d45355a15b7994b91fe9c0a3e310893ee1d5e65be729095fd628022a52c805cca8564ae9a636752814dc07d3a4d952edaf3d60dc51b6ab3068a446a4cd9743c7beeba992794ef5965fde4be8d6eadfcf3582e7f47604afe37fe8e9c45222726c984827b668aadb336616772516d587afa98da65462ae8d08077ce9e8cf718eb45d55f8832e7dcb9ecd87f93dbec87e174b0b12194a789d1fc270bea21f433b5b6a258ee865e92740280dbce42e0685ee8221b1b911f97676404339a43889277f50297f4f9e61ee54d0e87adb703b8e7dbfc98b68bb22172a9e5633318b040049d18b0e0b77d2dd7aae9fc876f3783df06e1c531df3cd61f217561b14d6fa201f968afcde1934286895ac62990ef8522e2293ab26909b084d9f48d4af82a035c9c642fc213c3092c8ed203afdebc11ff7c1c5afd7dbc3cc4b7892bac87ebb9701b0a12d15d632414625426819b7194c4f8a7f3a1d21b1e3df3a28d304e5796070a266329d827f15d1a7cbb16230201147b25a6de999be24ca924884fb1a11e9ea11b8a231c159d8fe9c720774a6b7b9c4bcee90f2d22764bcec29169e52cc6d0f0f9b2d7af7c16f29470a729be325531d82a34d4e0bfa21965528676ca6dc09ce9b433abf2ab4326a6707c35e7f99a6cc4138752a91336f7996cf5699770a997c5c06cda3005d99841cb534ae56632b87e65f689f43baa587ac660b01fbeb835c65c8355173b9ec7374c19334cb85936b583166921b4cda4e1a27bd5c949c16c6cc18bf3458bd63e6c9c5789f300477a74784a54dad6691baf2b055053afb9099365a4ad5521a20d5e949a5a087338fa61cfb5fb319fcc78fc1e888b50e97de99caee241ad7eedf31658c69af5286a0ab4ea82234d36cccceb3b61c8d80c1d8a5b235792d599efd133741ca5716e189b43538a98d4714b6b5e68905df21a22b783161aa4c66fc18a1f4169b1b1353fb0cf8449b80ea0a3d2ed3c620140428c81c820c88cd13dd283ba31f9cb90142ca3e248cc6b965aadb5bca9f53a833c19248d8eb70d883d6745e9d5b6e94fc64c8aa6c60b67b42231e2ac9d3e8d0086d58acf03d1befa617cfc88161f78e93462e9a59f425e1f3dc636c5757acf341f2cff7eec33981a19d6319ba247d35c83a226bd1a3b080b8809f24b49771c983ecb78e31f868b07eb372747595af307931d2d1ddc5ec57029cfbe7e843cf0eea2c8ffcc29bb7d0afd1141778a209ad5214527b7cf1025f916274b169a9adbf1667e16b821b46a4d9bf43803527e70709ad2846c41fd6339df5bfd57ffe9bf2b034ff25bb9194b63b87fbfc55fd87dee4957f10a18a1dae639664002928c323d4813a24cbcf9f628b86de914d2f0e435ebb1001ee490e893a16a481f8b9b3fefec6da8e7344258c0878e4a27fc211c838a4aa54e01c1eb5e47398ef12e2408e19969d6388b9e1a77f63c08f3b082c1ccac93fc010c971e2706b260db2c715a7e7a0f6b294320937dc89afb7b98eaf081bc9fcdc6980fe6e5b91ae0adb83a28fc13e816d5b477e52c7428b4d24194cd7b692fae92f4b74f85a8ec8854e70e0428337b7f8fe5890f943d22459d4f6d735dfe993a843a86e1411ef1223ec317f9fc27ea018e5b11a0e68bfc365530b1d0f1750acf204b15233b987705dd794bdec83206747d80fed5a24ef8708a3141ab570a2a558b1097e2cd6a17ad4c209a9970d7a37b240e9af6f3851a2ace0df88ee98669cff759daf2689cc5b2b33dd71b82102922ce3984e49f1c2394d9f242b588f9ef0a7b769aa44101c5ccb7368de98c1df2be1fe1b4db4e2f19e165a9a0632a27d17b91d608c57805777f18762fa65f8b7472b021c38ee570478626549093f8558f784cb26df8b042a02f926e86d14c3f85bcf7d4a94cdda7963bf838ce5eb77e69e1123e5cfd62540dfd2e81c58713babc39c17b148a29b711e4532607ce731904c4cd8f5611694ab56c87957247091f980ce6980a5357089ccde5c9fde2205d9a79dd206eb62f9646325a950d7386702ffd720b8167024929ef21b3578dccecf43fcaaed6d94bb9464cc527c2e40a4dbf55b85512a55692763eae225f0cd2d028968e84751845bb286aec724698e9a341d5b24ab8c0b6404ed6a5281375ee6fa1249e50778fb076504c2637214c5a5afe1cd5ef895550a94217048bb2c0167d7eea7a4288057f8d522ce13d2990b8c9008ab46481fd03958f6cafbcacb13d31d545b938acc5bd4ae01097472f2ae87c1b2fe66ba37177150ce470d4a417ecb6e10b2507810d8b846e37827abd6a65c1e6f6d29cbfea7b85ae67edc7bd2d14e122a6420c1de70a410f8b5a502a4680bdc090c28fffbb18ae9d444a797ec3aedc0b1a6703d58b090692d96e1ed4c35bcc29a2f808de403a80918776d577eb90503e40726794f2053edc74e4e6b9698bb20bbbe85110c286bd90de8e4cedcdda37259db368f062511d2db658644f728a9ee40ecde759256edbf63387435f7409a4acbfb325321954d76e6377244e0b234ba53c62bec274be0ccab414e279c149c6d18e997760e184e11ec9c751336f4c70c5ae8941277959e4381b7498c8e02ee7d37b843b796434bbed396a771d71cbe30ea7404054326ded616a60554845b43be992329019b3e264c3cc6ee8cdecaf69e9ab46c1948d48a975361c9660e3ba3b2e6d310abcc13d46143bb7b7f3c5cfe3a0bb4061814052640e7f8eda0983d73d72122adf02ffe3b92df2f222bf17b53b89b0f694f0813f0b3ce19d0b832e3b2cb0748bb67f0754cfd63f22f04cf5a34b7dcc8f8f5bff73e4ddfed3e0fbb21182c57487068860fb74df721686df51ea21926fbf0967307099f821194cf14962aa0c40e3643682d75b1fd0cd48feda4457bf9d1b7856e76cff8614eae4c7fb08ff64cb0734c2a1620affa7bfff97c0a27db3deff791eb2fa6712da8d9f3a4a31b6204bdb317cd34b8d01fcd31856dad27a4948e5062b686621fa56c729dcea2d79ef662576ef366e8af8d3f308dbc310f769f8abbda39a976603c243fa578148bdf5a22f61c041d2b975ceb6d22df5ee8bd6f4b9ec6c41bb2849e3c68c72480a545acd87c69687bb43da0bf88225624f094e37e40bc5aff104b663f4b7d73d00eb1b9f0845d710d3e1c5dfcd92345ad23c82ea192a1aebdd9b83ef0c8349c6bb09c56942e65aaf760b34a9bbe47e2c4e2276eb6bb2ff111a76691d99db7c6858add2e880b58ebed39c61c78e22a71f92c73bb42702a6b90e475d72292f00ce33e735d5d96d81a040e36a45a4012dfd5e1b589aefb3f042053c180a9a55f1e9a1d7dfd07a7e2ef21bc7f431ac87c6a08ca96504e75e796777322529e23e9770a02afbbe6d211a549b7878b7f05271c9bc2fe8a08dd69399fd24f52a51f9d8c36f80b2bd3b0c70028e5a98fac3111c5badc6ec0a3bf81373736cd5f08952306a1e74e9e48b4d0a300352cd3b2dec325da1a278a3b43c51171e34219b164cffebbe14d7e8d2d0f0e5ca40e1df196aedbd74e7173dca974a38ad043e9cd0a9eecf70ec4639d11ed66c86aedc525b9a5cb025e9b54ff020f6182355a171f922b69a5af85bb431ee9d0223ee9535388f59d95386ef3cba0e08589fbbed9813e2a65c4842ce738b988a5f161ac8e61a393b1aa5b48d4f80c22646d071f17ac38d1fcc07646779e3f7d45b6e811b7974409f6d6fb8181d19ac082d2928b13cfdcb82d88d14e8ba95afb98f3fb1d620233005886024da1ec0572f5e606e477ec5f082120981b781e412079713ed17705d4a46673b2f82ee3ac82757b14a1b0882033f1be203a2998ab021b3acbd17009db32bc2f6fa717325213035b9cef85e4e6bb5594f031b5f53fd5449a8243b775cf4be58f0e8a89010182ea9b0e62eb96f4d59fba04212ed4762c63e886de2e90bc28f21c041d67097a15bf6415290b63c54e01af1584314515554e61e681933f15b1a85673d2e437982cbb355aa082e5cd6c41dbe372b702e9e0614b0c09ab5b8e329582dbcf065fc7a0387e9875d78b9fc375137aa0ca4f6df030786c3d6efd5774e0ac609f050d6cc31448f434537e71341217d985036147c1a772461f11ed47a4d5e5b729c57edab2d04745a542fa05d5f1584418e2a73a7cb266d22eef428e54ed831e8898322f4b32a3849646ab90e51e6ec6549f25d22fb584eacafa613e590bd0b039aace5a81000b0b7d417b789ac38daae8f44c8f6c6647bcdac0e9149a8018aa3364b993eff03376761067499714b0f14dc00e9acf88c24d471376d2cd83be01a179d141127e6560762d8ce82b8e3fc1acc876e9cc196d51a2224b0a364322e90632c48978f382c2d0cddccd67d7e0ac9559c745ccabafaeeacf4d9cb31856bcd236bd6033fc4c2539b36799ca0b981692e332401838eff44fb4eae748d9a14c4f7a449f36e211b5fbd858ce4a0faba4d00ca17431ce499f27f8919cbf3fdcf7cfffff2ca730b3a63f2df1df7c8b23a820c4e34b4bd19b69301998b371c263ec98d4de4113a1420d6f9aabaf50eb9b1328f512be0c809f1aea9ec3f3542c75fea5d4564d3ead398d6b28e3a5e1ed8a2b979d6e130bd4d88ca57833b41b062db983676f0c5fe13a723294b9b8dc367cf20958e6f12740ff6ee95e24887be4bb19022fe4df374e91c195f622152e0f8fcfb5df1eee5fb9ad54b1da6ae61723f044b18a60b3121d3c4ae4d3a75cac6775d1245cb5c82aa27aa024eace04cb90610c714890fba006a5046561d0cba8dfd69033b3e6878e1460115a40dab073eebcc9e440e3ba15cdaf0738c44a4acb4f6fccb3fac81328e7d1b70ceef0abefacd584afb222a5471e26736d1f9e5551ed94cf7cf276378f18e6dfd84ab702f72d06db54137001fcbc73988916bdf5df1c0bd6255cb23fb9e911179221b663f10b561079fc09a564fe24957cd26ea8e15717a627970df71cff6b024517c0a0db66e5f9216037b41b8953f0a1aeca17082667c48e02692c1bae1c1bd3263dc672233934ac383c800d19b5eecc1bfdf1804bc42eadededaad1d10dffe9f8ba312292dc4db2bec1cb7673ca5aec11a9737b6b9f5a4dae980aaf97cce9ba8aeabc137512c8b786e25e34721ad38631235bf22bdbe69e27d74e15d29af311f83879acc535b11d500ae1705515220d8137c946ae87402f1207d165523e45dcb794e02b81b0d52d149ae3e8475656ed4cdd177865248f6d32bb53300852a62e46e4acb33bf1344c182f80877e6ed783260c0676d73b66d585d8d26cea7444b7d51dc16064a062963e5ac63954baa5536dd74cd27e53ae2bc376edfa6beb7116dc3879750dc344fe202871a4e7394ecefb029b9e6422632f1d39e4ad8d62b54dd03e4042188a2f18597419bb5b6fe795d5243dc3e63236a80dc7865cc4eb51ac35689f7d5c14e2173fe1b704ba306eb9aa5a465cc8c00c511f81f10fb832730abc7c21143bd6231e3d4203a0d89a6257fc678279b123f0023ff64aeccf3f841b7d114db826009d5980e03376e6938c17b14d8d9f30b5f020839c4dd788d81b8e06311b0df06606fcda0e9061adfc870a9c5563d9ea689c7f19d64c3958107d1dae9d081ff1397d78bd2c95c15e2ed881c2a95fba9302cddf09a1c8a568a234ec6ccc7228a5230fd9dcca07a380ea080d17e077f01f254101b44b4ed6fe00676c80e67e11afad8b556cecddcff5bd987f3d5573f938c2203a255b75c5d94829b388c55390419083131349578a6b8f85b5787faee334f610b6a230e7ca579c78e4ac57a8370dcc512e633f4558c08558454d946a67bd462534345b65b51b93882048944f3591b0e72d6a7ac78dab2e6e648522cb814246c9e7830c528c57b5c676de2f2f9736a9a9582a33dd8c901dc51b0d93cf9edc4b80f6f5991befe8671be8351970cc4db49455bed6742336c1725588cd312acdcffcbd3a47e174010fdab9bbb9075f0797ebb6a0cbd24561ee8ae568664e79561fd9e9bab859ca8ff8945499fbdec511c035c2855cb160fb82f5739d1c0d21e9923c631bb985c931c27dc57db98734bb4154cf43db6b15db5f866141e02628e927c0c67f27a91badf7f07cf80acf0085734685102233a718915cecce807a958b2e4826d0487caf2380b58875cb5133e7290f2e9cb45627f4285ab048afbe80c2cb305af5be9a9f609e5ac56b378567a3070ad1562f3ad5d911f9154674bd608b8242caa59d01349f8ae3e8b9ff00e1c2492509ae0b5c3a6c43d7efff914efd08bfd9cbbf8623a7b8e6b17123520d07d91e1fd00965150ec8346fe4007ab1376914a0ea12c367b4bbdb70d70f253789d41dfd2580d7cf0ca75ff39412968de62c659db9541ec09647a0b70738f2b33d97a2ae28bd7c6d104b8d070f492c7d634275ea9befdef1cb0b1079bd6c536a81e7a497a394c1358162e604de8b03e9cb12b404ade84b8bb281719c0c5dce41c678d61d65c05578876ea2135b003e71955a51470e24e1d997392219f785d8b1e0053ab0271d54cebee8331a8d07511584917289e0e4e3c42d9ceb61fab78c77f1d5d3110a24a5cd9427caeb744f88e0c2ac1e545c656bb3928a49f63133d893f70db88befecd61bc10fc4cfd849404c2f7740eda5a7a89c2f40e9a52937de542e8ee5be93b5cd70e1c1efa86ae6b8e6c8c6424508391c7b705921682f3f9e04b06bf5fc23ecac922aa63e07d20d3a69a907d958cbc84a4e5bcc0ef745833306589d8fc136e0bf4adb4f65f7467c448c225217bad358025d521d511bf926d814225a217455bd145a30dae041538366a8bb4723b150e2beaa08ec2ddfc83a7a39909bc51a6559831bb423608652959718fed32cfaa34eab693e4d8e769662faebf0267c417134f070b8222f569117b001c3cc55bd5bb3aec896325110ef68ede58053d25e02a6855144d8534fb09545535d490d46df2db045a335fab8f990491ac8d41fb52ba65a1ffde35c7812c2fb34dd081e5991bae57172126d5a64bc6aac88d142f502e1e652184126cf48dd7da983a088c5427bc6454c9942edb20e7716e82c2edc38ccc190a377f9a03c1d6cfbf2a67b6b12c1a307c997d98f37e119a07949347ea6cdf965aff50e2fa9e39c1ffcc9cf89ca7af40491a81f7756301336f7bec19eb1ef05fa7b81d10ebec9fc90c17b5b280a6d8673c139332fa0fec48f668b3528cf377462b5a17afeed53fff30b27e16d3153e10943028feb05e96298a408d4ceea58019efe317a50dc4c760601d6b7d401c5d81c0c5c6b65aeeadea0b0c1460304852b9b4cb2c8c6a30a769f01417145910faf64b55a4faef13aa37afd771e2ade11b1ef25688cc8d5e75071cee0f79bec5271b140e853da13eaee16bc40a582ba623debdc0295c0bf29d04a60e0e7ac9921011142642996ca4e3daee8b870f89409dc3d9256dcf7f8f3437a93e3d636ea7be05ef69c35ee933074f297d413d63cabe680048c4e4d34117f55240f4c8a32277ad5b270e32c16d951c84eb701bae7c74bb187f1711d6ab6b2b384f2f7104d1bf65cc91b380e943429391b93c05ef94cb2df6ce4ca885a51e32423ee6fbf98a6fd29401b5444000fb4dcd66714dca20cc629bcd265353bf3fe2c1dcdcdd927803ef3e8d874f5cf25df61fd2aac752c103b93ec87301d7c7473532b956bc7f44f070c5be8f8b0eaac3edcd0ee09e46337286859b7834f91efd21593d3d35803707feb76fd20f8c46be04d872c920c06a2092b9803b9a74a70f435b61200ae8826fa3fb083fa77d3fa3ea5b6cfd10c835e8875ad033556569b149a60660fcd92fee997310cfdca36e980ab4b9b789a67a13aa3e67e0acb77a53408d16f533bafe38f83d2b71c70fc5c4069eb4f9c8fc2f42391e28047f9fe0520b63f3c675e5f42571e86d7f6b26c3b1a04d26e238d8c8788ddc6d0b6344c29c728d9addcee2b612bc2c127da334724145aff6d0bb49f7f6a542fa2cbf8578b77a6294649d1ab1790389e48ef2599bf30366839fd6c58ff0d1790093f0c3799f6d002b2c609bf91852ec31b7f1248a5677b79b173d97c55dde93cfd6f5f79e95363e594687a3d26f18a71bd305580965a11f1cf41a81682e120ba285484bc162ce2880489bc301a071795d35e456756eb711810bcbe8c7456bf5b145f028533920b9a2e99e8c304ddb53d5de7c2e5ed767f8528429955f7cbd1e4e016c134f28c1229580e3e64b0024979b61e54eebd31d49ab73acefb419321ce789780bd3711e39d1bb308bb57013d6380f82848d7d51ee0f40b0796fc91fe60076ad223af95779987a4760bdc0402ea58a16a876ce082dc24bd6b5d0953c975bfe71dcc49e6cb6375db3f3546702435643856451ffebf7c90472e2db0df04eb331edd355855bfb59ea542d85b882852c98d837015f80f1e7308a7df86d24028cfbacf4cbe6c1f0f18c6790e13975716433bbfe70c6c766cf1b91794a96dbca0593cb7a44e9c1196bebd8eb621f1562d6e12952f78c673c51380c263e8e24fdc7946c42a9cc867d38875a8f14b730caa150fea2103b2ea71eae08eec4f1fb021be41ff492c8b0cf6d5492c66b7741f703ab9054c5698c2d474784db2753fcbc1ee51b25b23223d8b28f1048073f3aa6f60ce70401d35ca5ec18d487d89d8f5a50905bb5c12deafc796b2710e5fde7083e123ce0394ead6ce30e239ca5c543e6f5d300b097c270892d995ae54c0a4e296b8e840881a7aadb652130bbfce34ec028ef0acc11b1615f6bdcfc21a17f17282acb7847eff57537113aa86e3a09a1f375c7a90e4497a7015324eb94d287fb621da69299a0b54aa20c733a94cd6f1a7db025d975bd3c4549537649671cb49d3f61b79a354133ed336f8b8790a420446f0bb7b2645d0fcc65fe6ecba0d0dfa2c79629d7db8c11d11a53a256e00d1d5af7fff4d053f0bd9c0c09dd10a1c9c8cf8f82a835de320376d5dcdb2d61c31cc757de2592591ab5a5c4a98a35ff3f6b998889ec82261ad1c3a64cfb5de8ee381f6dcc46ff8f9dc9b07447a62a766cca9bb2073729fe4038b1156576dd102119ff9b192b629e45fc6991a5f2d23aae3227a081181d612360f606e395c627d323d0d3e6dd4b27862d271d13c50d41a368bbce9feb554ccd60d70e6c7c474f929923db3dd25f6aaedd7c8fcfa70e31456bff6ce733285521e6230b0a1eda0ecac212456061e0c4a0cc56eae6a14328186af530c454420fb38f9aff044907a7ee9231382873fd387fd45a81b358bfa3e3e2268cbcc0519b6a3473a7ec4df06aeb56eb45268164fcbb927d20b93d68956de791ef712abc32e8369448e17ea686f6091a32d0ad155ed0b86c53150059a5677de7df88974d291a5ab062256bdfabece046842b8572ad254d47763e80d97901ce2edc8a341c1bf484110285de28f28f81440f453e1db099ee3f0bd80b68305c903df57996441a6f011fa2b8b35ef89f8bdf771fbdc825ed795cb71cc2141600fe9b7c2f52925ef664ce5ba2207626d0980dc935800e9d4db99d152e97505c700b3c6e843ff9f7c537108a861d0f129eda8c3cfe23e8703a4620ad5df4a133701f89e18246db29bda97ddb5f5ed76ca365243ecf26e229056af5cb7b0e2cf22d87b345b7842da6ae3a4d8d0d2b176051b6b8dd97d13d5284ecaba9cd30e1a13db8455cfafab3c2aed2998fcb9ae789dd6b4460548a513959283a7bd50d0319553373a00dd531e4829ffd3290330e99679aabb1c7dae94360f629ec57d94a3fad6cb40d523e51029e0efd3d7776ca00ba691e7d1dec767562e37cff072aabecf7a8d61c635b7c6fbecba2c99e1ade42b1fd48263b0ba9eed9a7f185090521b6fc8a37b72fd025c774bf8aa86b200a01def9699f469d7ddfa62fdcf6cbc8c7c62502d94a78ddd9916f39eb07b6fb6be0cfcd408db99bc7864d12749b2f08cd0bc080e87631cb65332f8878988e828b03e43ce9cb4d72dddba56566e801083550b3bc50eb58b44caf1cdc33f515e47e5e398cb762d5fc58a5e076afb7bb264e9a50c9095a8ffccea3aef0856ede00a6822f5edb23d8f7d501e614b4df926d2bc24a4528ae8cf81701d982156c13f81719b77a1d2508091c29d7557221251dd12597367d637e63db59a937d6f245aeb4f5961b3088928040ab93079500b6d8af9aa6c3f6c8b789dc8d88d2d35708bf798443ccc44feb7f81cfb7603314ad9b27fa7fb9d095ad2fd491a8e919188ce7827551eba3e36f893cd400a65ef67fb232067e825aa8ddb60e4fe60ae7d6c2dbffed9546752cf5a1a1cb660bf122c9da787cf61ca4944d2fe4c0f28d688ed3dfa6ffe8833d11f78165727b53d6fb7909d7e5bbf4621935dec6c37fa84080af5d59cbd088fd89d1670db7d80720d6d8dfa621bd046cb39d2e9aa75178518b2b354bf3ebb2882dfb6e97cc428e86bf9b12d8af5615a6d49346fdb85249c5762a8c3e85ca704b28e8ffcb90a460bd8ca2c5f3e8a19f272ff06ab6ef3673dd9910c97d4575f27c7ba062e6c15790678165238753d7a964bcff273bd91d88123da89470f3cbf658dc557674f1c5a6048e5125a8955ed687e27c0c8801e54cb5a77a059b9e58ea918113bcb0a5a75df4698abfd0ba99c4930404b5dc548bce6f5d30de0c10f4bf95b12c28e155cd22f857025214628cca3c805efd654fb286e048be84412071f02a03f53044d9069dc6e8cc8b4fd6862c18e91598bd6a1fcb9f086eeadd0fb0d1966f5947bcf2b85d87138d38cb3cae0cca452ce42f5fdafc5863e86d527547ec0c85b1d8682671cbcbb9e34424040c395e153d6bf2210393e0f92bdf548d596d9b8ae1abedf46494525244f60647da92175b8963d6f7dae8949d08a70c03e8fd1f8b75a04e5f6995110ebdd6de335a7d051dc7eff43e09d1d8342302c982e9ef725bc7907dff63d8427e98237a36ac1a9be872db207b4b64f69e0542f6511d8d566e4932d5f8b93ab531856f3f71fbdc423022191aace272a16ed73afa169b7a7b5c3cad05af2ad17b0957e31fed008f7403231795118026897c4e624fdd581d1e694cf01fc5d1500aff69a93d054093061e44e553fea210bea3e7d297db835d0251a52d17bda34d357fe0b08f8c8fc174d73871c5b30ded32995acbb58fff2617a5e18b5b15d464d27798a9983d6ba3bddad05ac9c7685984b9040d735176d9d98200d7a97fa3176f46f4085a3b1bc70fae383386d74a3b800c9ef17790883af0352a11f7d534866f49b9c00917cd260a27d7a1894738d98e02557767d959db8521e1a468a7da3142cacac2af6df176d594c4bb4a76377b7fefadd61279533a7ea40dc31dad605353eba071602bfd9ec0e0e3f58e445f7e204dd7d1b051a956ff4a6ecc13149a52769d3d2411454681fac4137abf5034f328fc312bf0a0ddf65a3574991380e773c7e1c3436ce6f82d87e2ab09caadc5f6937b82f4600ffa088a1df70430b15ab555ba8936819d69cccc044dcdc77b7382657f38b90e0ef2676a7ba5cf597b9fff8be46bff31f27328ecadd2fdd7e0853d2c89aef3b017148331372183ceb616e096c7f6430577bd8c14296c60526934a9ca0ade19ccbf06680496131fb5c965d527b11bf47e004fb1b88e2d1b454e0fc85cb0386a285108ea2377385f00a3764691039a2c4a112d611bfa212ac5bdc0a007ab9b451fb5ff981d09d38e03d82ee6ce4b89ddaaf5ccc14829abe03dbf93305e50fa566ffda08188901626433fc4aca2ea3119059c39bace3ea0c3ee61c0bce8a8ef6b72945680598945c08b09ac55109e00255f68f659c4be6e85889af48d57c16957899c76084af9c5724a55164a95622935a1967a769a40c332c2cc87a60f2e03b7d9bf3b3c281fc8b369d846545965532f7febb10591ba1bdfaab3507ae483837f08c994fe21b4572288bc46486ccf50ad281213aeb539d281201f07179c8f1b7eea28a71a402d3fb8253028976a9626de6ef69c4e1d0c3a01125a6ab0212fb9244560cd7c8c70d37176698b7bf1d0e07cb5689b1cd608bbfc065a81ec285840fff63040a666be34ca3dc5fb383613a14be81841884a2eaaf57c2e4a5a8c6850bd68c9a52e5636afafa65aa73b0129a4c3335974f7bfafc2d5770f90662f090dd21dec11453e608e0c11a2d5894154f784cb7a61ed54df0eb42a88992c39c300d8e4606b6ca2c1766a2b4e464c44a3b41daf28f9de645fb99d50b0c38fda6b12949338f7cb1c96c79898b595fc1db777d0a8889e9f141c6fad65caaa72546836b1fda8589e27731724823e825e01d814457cf1bea678d2b740ef62d718b92bafee13a866b3040bee4dc8e8a1ee4d59deacf602ba88370d6c45561cf03438078726915691ab72a56a8065656801143077d5cf662925ec9518ca44ccfff2ac426e66a6a0211cdc51da885856b82fae594403086f879950f3b94807584408a05aaf6a9b61922592899fd0d6a0f2792f5e6fd2462def5a3f9a1a663aadcf4463221799f0a64ba7bce885347413900bf78ca28abc4f4518bea2757d685fb5708418cb33ed026c12b3efc433b02240aa027ff68f02b25ab2b6ef0a795ed8d12975e98c1523a2554801193d5e4a7b44f55fcae1a88cf451cbe57d2cb2f2a698605ddedd2c3c09ab019762c834256b223c2c5d8dc8e8ec6f5daa9f17fe353bf533f8ab67a03a78b5e96a03faf95b669206fb054ea5fb84b82902d5698ef5f4c33631756eedfd99f8b9d5446f01c5c5886369be167a69b8cb60d7cc97e27d0f75ab28c7dd6a40d38d0e12a2f5715e1f0a04eef536e9db15044dd64f0b589f4f9720bfd9d5d03eda5b20fad06d67cd8dc6d31e5a448d13e97a8f2ca3b53989c290c0d2411771da9e8097e2b0023555cf950aa252224be95f3724755ad5d175fad3e52f8426c285635c945d408b2eae9d7e3c9dc7b887e79babbbd0c60a2740460750b97e9d9f9575830dca8aaf140ae7b2b386d0e3baad3aea8ceeee4b3e809cac54a8a925427a91debfa537e8d6a5a30506f7c4bcdc1f9e297d14d1889ea6f3d9f1424aa1c56eb6cda4120152d99bcace283b8f87fdff1e16b54047448adfb6ec7b9b944e3c36574ed05f2a028b705377a143aa98d21b17c4899f55afe332478d609d337178fc5198f42d6d6a426a0fb90776aa2cf6b07dae125b42b70d464bec5f1c7fe4374e00933d93ca188efa2f26ea472fde85a253fa04e8e927dfa23cc53c61b6eec7107984f31634965f400d0095185b62bbbe7006c812671fb28ebfc4db100e728849a7c86d0fa981ff6c90939df7a83aef5007112bf3d80df63caa6609ece153f532f5ea7c7005e8da928a1264cafb9601f6c5fe598693de87170d15b2a0ff63eac79900fa9ae04796fc165b2e52dff3d7a179367ba545674810686302ad16183daee144336c04123cba88f42982c58cbdff9c663e615d61068374d9f0bd2371f6017659162edc01548a4ebf4e95302a356936f3b907712c79dbda80327be083d5bd352539ffe2437919cfbcf08483a952e8706b0cdc8d3f5ea6e4c1e31d6e3f1a0a7799050cc5cdaf148a55972a64551126cadf7d659d8158ab7285a912eec1a74f9013f5b8f8eacbcfcbb15b105c70bf695f2b713e88bcaa28bacd7f8e4df09cfca9287e68349422cf0c5ffe417ba8154ee9abd2e64461966e4baeaf17828d356c4bfe3df0dd788d0303f59caadd421c6aeba3e1e1f278aeb653ab2cefe3d1f3dc821fac9fe62b476b7ad02da1e65f33e802b5527efefcc001f3acf9f15c6891877b31891fdc794b75d25765b3e393918a0fe68b761072796e3e493b9baa0955218f8fa3a3a7bd1c826eff6a7b7c70b0441f756f91249773d990de5b1937b97c5ae2b4c1c7a193d5874cfed920ac65a8bc506e4a3de7c583a4aa8f9fe0e819b259f0fdb8b761e24a1ffde452d2aa958065dac4fb604533f0f1b998f214911b4c7c88d061ce75b393a92c172c7f441fd20f0e19c328d24283ba39924235811a2b2558b680d940edfdb205a7840f3be61313988cecb346a0af7cd9a87b74f7f149653e696d1598128909aad167d07b8c8b509b4ed18243cea9ada183c735ab0bc6501c36cd9af743c83811d6e710baf2b57a7359e92df36387f9432cc58ebfc42acf24559c0267fe7602ab013243f1307258820173a2b1f5e7021fb17c042bab3d9bb23b3a2d4031c8a3685902109d1d187fbd78fa8c909b5c08e348b1d128b8199abdcdc677f11dfca5668c86a39c8b0d31f3ab72609e095b26d0882fcec683507be51ed8792c8ca823917b512af3b87f9d442f1d79f7f6baadbf71525b7b4a83d4e4a8d3e18f4d63c33a4d5af67506fac5310820a16f2fffad74ba175332faf9c1be24394fb997df4b2df3d8f8c1139b24e877c76b9b91d2f0fa97b603d27ced2ec786c47df267cc4bf083bdb1edaef43f7dc501fd0ac73e0a90ffb67473c7a438dd6515b54b81d2f0f38a0a15a6a30e4b71876c41cbe277ccbdb2cbd345fcd0f3e56860659d48023e5d316400f77f2b29c9f95568c07aae122ee76323e1ac4c4888f3a51c62f7f52976a111ad6ff58e85aed4cad23bbf36345fface637c2eb1c6850127a89271b1e27dbef56909df88145c513e247a24d10fa350675b4c172aa45cc46ecc3bc7925c79a432c5de352f3a5bcc0610679e11ff2542888a0fccc5e67fefc9bebc5c7d32a89c2c106da9a35d445090a687f6f09a746da803dfeada0eb28368cc3c80c8bb9a76fed38e7a97d5c65d7360334b0aa004ec52fbb266695fa28e99416650aefe96d05b94b46db9ce26e4894b34a3c5cf6236251bd8685aafc42313f6e02ee4c347fcb9c07b4e75ee448162acde11b8c2484abaee9ba9d7a5cb9a06b6590b8d050114dad45ae3bdf0fc08a29472e8fc7c6e52890339c7e24663e6873b6649f9a04bb191bcf2939a64380f031dfd27667d8abbddb9376708524037e7f694cf644e87df2efa346e8d4562709cb56e31c416c8886d224d0cc0fd3ab11ee7e19d1bf500ef0ac03132f8bbab14765707ab16f3ea7ae20997bfa2e823d9fb5d1bc60f8db26fb806c1dddaec45a45534f916a29070e27989efabb52bf19fcad3df94555b307c470874435290b5ce2155ad96fdba57495254bec8c8922eb42c7712d55a471ab974f454c3cc101c08feb908064559761ca52006f5b86f6c603b45c5dfd1094490d62f3a9a7de35d62821890f4eef0198df4c139d494193dcf5d1fbf77b3eaf2dd8f22e75272d261b20d73dd5e4d19dddf15429c00cef3e6c88af78552ce7f66fffedb83cbebf7fedbdc17813336a6030d6a8344e83b69f59e2ee7d628ff3caded9ba2a9fcf77d523b52d67044bc1ad4643d9096ef942c9c9b3f143af5a9c29332d9b483b76757e79cc68808c63df3d204c41375536fc4417795ebe8c0fa8a23afbcc82e5a85519187e1126e45c488d7b5973456f262166d21f8571001be5a333e6d06d6e953b26df51ff19f2551652944fce6d920b0b27b2f2a2477ada0831a6a20580fb7e16d88c52bbe7991871eb9455ebfd968dc275ebaa9da12ee496775a4ffd79dc23f9294f1165ec03a288aa7d589dc4471d34b2105b3e8f13b1a9b28dae782e6bf900ed9db3ff6787c7f449d0e3cef7bd273d7eb4a652475bd90b6932a5108f952064a97f61a53f8f04108f89fcaf4b10d38628b2d461b33bc44b183dafec35d8259f82658b7df4763087455bbb8f0209e60fa300d01b24fe5be4c96842cf7ea433ca7a87bac9830e4a3ca2996772a7349eeb06b26adf4fa82551f065fac01c19508686345afcded9e41233db6cba73da7fd14f5cba3ebf1519241bae7d4832e3c7ba31a2a8a02371d31ad3b72ed4105b165886ea523d23cea9ffd61862923d4a9b2113fccca9ed4bf12815e61c10b63f98895c1dad520644e858d97c91fba835bf2234d88c753933dfaf9b4eea4306285036130b86628cfb2ae9adfa41e9323695edd15bd06f1afcf2a08f48490b4e85253c04eb137efe59b50c3202b1d80b85db1e872644b5a2111f7f75edd4dceb56c50de4d7164fabc0e61c79c16696c36dbaee27cf103bc8931c1eca9506adb023c1c48dc6fd85e84b5eddaa6dd5073f11606b1b2b9b65d57a705adba36110f3a069346d14a88d706f6ab4a8169ad313b71150b233609878016bf2ddd173ed2496150b9bb5261a973e0c819d396e15f496839022ebe673395e2da828a521a56a46e819f78db310df025bb8a1f6d41742ace094eff31962cf9ecd5d0d75eebbfad555b8cca7cff47863cec5a5b8e9f766dfed06c3f83c14922b71d308c3f1987c07470bf4d9a1198a01776ca637805f5c28a6d910d0bdcc1f837402e87da7a643b78a73ba67ab8528d642f3017deb9cc5f6991008395d45ae586fd177243ecb82f433536e2c0f73c9a3c1a08d1a49729d7f1d20ec006bcf7f91192945a30eef944568d46af79d39a58c44a2a061b40c206e8a024d9851080448aea9cce1a908bdeb150d427416a39bcc82fa9a9a0801e56997f93e72ba5c52a49b06cb7e08b76debafae6ad7e8e2e690a3c3143f73acf67c9517a6d119e9ff81ceebe613177832b0fbfd100d1739058a9bb0d85a462585890e1bb882ff635b13a8174209fad1ab85f52eb89b3e2262c7db2b73ec55cced456c996ac62865d02ae11bbaa3e47612384b547422537e78db5eeba3edd6cade908a317a5e029e7d3410e88075e9e92b13f9f7dee1389946fb901a973a094a634492799c815d1ad29cc474868e7ed3af6289e6e7fb2e857b683f4407b163e9c8e9835c3931c07bf0c4696645765d47f343b9198060c50753ea6cde6eab9dac151a9448dbab9ceecea4bd9dd940cbf5183ce32b717d8ad0ac22bc546ee4a7b99b6f4304fed1e1c510fcc347d73630c11ccaae4d5d04e20eae67e925bb472af8d557a26406700ad5311e79802b2fd0c5d2989b99b9a16631c3abcdee1b836b0b2f13fd5f08fcee93b2909fe65c62a594e74f3ec4cd60f34f59c11af5a86c76d2c7a9d3ce5dcc63dfeb0a48470027e68fff46a821b623ea124a858b58f4df3fc79e65e1098605866ee7161a020270d7a590e2ae1e05d2e794fe17db3494869214cc2b37ef2651501fab5275d30ec5ac4bd20ac8f53916ac99caf32e393f910333cb3fb4a61cfc4983e507a1731d84f13ad57efbd6240831d7b18c15a0dd9247f78f7afde6569713e9e89769aa45182dcce32a3e94f93d770def5bf5b3a3b0ab0830a1f760b180de61dba27b2c1392a8634e363b5fb933972bbba8687fe9ba032678c7def22aa12fe807f85ba5eb4557baf7725af6485789dba061624da7453416b9b8838cf5954e798ad1b5360f487848fdacda867597d451f1b626419cec8e2135b4d162e6d5498d8b5394e6225a77283c0c5e598d2a608774ebd71292f5a8d53d6dc4ac0f2abdf6218fb1ff7dbbb597a0d962a3d6a7d77814f5f23da493995dbba3738a316120506e945c505e846a8350ba7807f9cf063ca762a62563a41a80683314f48fa2c3778ca1936394ed74145f7c806c42d05fd300b968d051a80b0f30c7be55db11a0e3faaaf58ce4ff0e047bee48cffde076d57365dc5c3cef764d3d78d4aac0656466f1cf97086c8487f8e0787b739c41840292e72ae0019ee19048fa088fd85f040f403b801bf8b3dc57e66db2262094abb68ec9145ad8d5a291f45daa3ea049999dcebd0a364c38aa276340b83b7840bb996b8461a6baa75061333c2d22ad9450d3fd7d4df030bd3586eb3ee15a26104ce969e12f8943f58ac930ba1014a92f19e2f8f50991a4529bc80d7fceebc47376a22fda1663a0f998777cc68bd84787d91952b274307788a9e42858c5f8cbff56e00e6b6efe552af343e46ef0aabd5814b1e5b2ef40a2655c3fe4732705288624e975abe170c6764c5b1d9264b63f2ce8f168c5f65f59e1569b93182d1628cc7cfd547bb7cbba4226746dbc1861232e0ad0a257512bf6dccb6bf7f0b53535bc59e4beca10f9f54676f6a02982410bb22e2d61b8545785099bfbd833a7a8c00a39173f0d4746a6f1c48356f7f14929e43a12ecf746388d0ae6a14f63da97451f509cc1ca0f94f78b3825a4600ba699e4da39289f49a12eb55393dd56991681e5beedd327e48a02332365169b0b82661ba99dd884f3ed4a1ed59004d9b08cbb79028833ffc7f0609ceb9ac768f55bf896cc3b3ffc25f220f18addf78c801808ae363e4bb0598471c7841feb80f9c59e8946fa34aea9fb8d6b4f88a39f266157b4f3ec2d5ab057da79d7a1853c289a851106d3c914f9ae00535c102823c6bd62c514ea7aa2e41d3d23c3e8e24f3eff35665d4fb28f4306982b55ec9cec2009c1a2c2a71c92d3575b4a9376e368c541833e29a20e75413000a54077841870d0c2310bd6f1e0d27a2e07d48d4826ee4bdd879da81462f518dc0a500596119d5f13fe93b2d83368ceb1061f5a88f71448199dd96ac60b3a428e974f3e5626c5f23d5efd041f4f34c18bc2de49c248ab21c5c0e04342e20f485b9f1f1528d7022497cf7927365997ff2e1c4ea13542c1f322b2ed89d0b6a7fff6ae34da97a1ba7521a4c120acb5fa15ea6f421144dbe4320a589153e2d82a8603e19e73a1694c65a8d1480777ad3bf396c8a8cf9f63dde34b7ab03db7f29149fd93c3dbcad52199fc8a3f178646bcc0d3db91d489dcfa6c3a824457339df320be61919652a6b7026c9ae591c82e2f626837f38abeb18117a867dd03d0b94f5b9c7fb2c2658a3cd26b1abeb2cc1ef4e81d369ab9b08f7f9784ac45488d99ad9fec2af26a309d2cdba89a0a587142409915fc1ee249021a7e28324161814d7a2b2815b7c126f3c7776605546a6a375811b7b4de6f02571ea85ad95e8afc8f4aed3eb5b6f8ebdf88c3aa0e44fa8528e26785f0182b3337980b9102022674fbde518bade0d7753b122c57ca1958a084533bb8d43cd17e54d677e2b6fc0d9ac2e37cc51945c0de4c18feb1bf311e1dc4f9b49bfdaa93f4df1016df0416e26798c99fe9a1b62f597f0e52676dbf84c986b32edce1f07ce2fb9506dbbae408cd3df19bcdc6517c3f7eb5caa5896d33ccb8a995a0950d1c5217893764e6788923f694a3fc22c0aae8d51fb4060584c068db5772501f6cbfbe10b2a2e2f7375b0010f6539ec8438b64ebcb790940fe8c5577116fdd1fbf248af12abdf6cdedff047e55e938c2be1debc2d8dbf2a46f900db1a48123566c2e6000f28272775cdfd01292741c1dc8baa10da0af23e4c5153cfae64b305d3e670013b66c64545bf2cf5b3fe063e3ef5efa1829d9799de4a80f19a1097ec6bfc13d81b3c44bfa91ed8cc0318f36f55f9c9f1659173c249402b0f4c7447ad9d64d32d446cc507d5b30a170745599e92630110f173aff0b98b8887182512c7b6ef09267399ac7788f2ffdb951de1e072030f3845fb5bd2b40a3b80a2513104c8bfc04f4147bc2b3f511e11bc33209b213b386035d4c652dbf627b1d9245d17d5ebefedf56bfd1cc727bbb4eee86416206867c07b8825207a10ebef45fc2e18f599dbcc6ee99b13ed10e611ef5322a8dfc33eaffeee2b4bf69165f2858bf4cff2ab95f0d0b8784b3ea2ba565d57083b4f2da8e84be2ea2cba8bc8a245877b71244ee8691c3f8a7782344a6f13d73f053fbcc20c37f5ea6334b858c0a816aa3f796a166569eb1f27201df09622d0852ff0aadebc23392d7a25d7731d1f0631417fe358530195e5eed6984a9a71e37efe743645daba8776b17124d59f66453dd9bd57b0a27de9faa6cf79f15bdeb0a64b1057cd794ef31d1800aa206dc380f5f94fdf7ef2198794d0ceb070e00ab567aa255728e6c54237bc1c62c4401463929dee50f52ebd968c4472ae9b7b85cbb6138c6df670b5b1f741607fe58c557bf3bc67b275526328a0b309b9d8f35bc0f8bee04953e7f4656de09f543610c3b4922ec97e79850cb53721343b94a55d70e62fa94513371abb6f8fe03b02220b0fd0b2a83f19f126c37439792fb005941963e2753b6e6ef91ed0562a657fa0fa66c017b46251511e5781c049994b6f493c4d71dc8761461c657a083fc4ffe8b62ac2fb3791aa27fb9f90c03e691d74b9903bd5fa27bb9b94f06212f50e9f713dd4570760d2381d13ae9b1ee43ef5db99dccc68a41a58bcfc9a53e7da1d881082d5ed4a9e7314c3f7dd626aee267d3a102ab24da443ffd01257982708d8eddd4031fb74b1ac9aac357261e2ecfb792fd9808644794dd5c6891ee3f05f9b21cc493505e4a2943223a9157547f1a128a7c5e949418507067b2d9d1b3fb2edd69a0b2aa434038b156b826d3d1f095e9f35c9b5877adb50b7ba01fb0e2d9631d8eb95a9f55beff202b8d1df79b5831064b588eb6ec04e723b5ace606c0717052c46793c02c98f8414fc66d48679ef4794f70eb1944fd5781068569a8add2ad433cae3a890deedb500dd63c82d7cf3b0948d2a0691f47918dc6f05a70e2f7f039677a08dd0b8a1f6c1f5ea9dbe77d8e6166bf5f533acd02ad5533deb30f6d0278a9b3d2f2fe1a38569e4fd83ad1b2c7c13f65f11d8b2d9fff15011342551714f32bfc0826ab2241e16d89df302f3f276377045387ad8bf7caac762762e339835421d62ee7938d52e7e4edb03c7fdb3643dbff75bcf0fad71557150deeab087bad84530223a80a0b30704b3907f8f0432b4c0f3b111c716c725ea86d01c25e271673f93efae7199bed652d38a3297e15db0eb4c585a49868e0737253f28ca1bd877924fc70ffbf08589ed743f921f61e89ed866f76a9a746fcd3bd4ba88d8caa05f5c7d620d0fc155fe7a33a46e358394f075b0947794a70855243ffbd07c39550cb02e2010dc7425f9a6cf6452d69f044080102bbc10e93088e982b1eafee494d1074a6f7ffe6f38aef7abecb82c916c682e7a5ba043c86960594547d9a9aab0c48c264603f5c9847b2786928f2fee2f898534f4fd169844541e8151c0df2f637162517a2588a99549b0660579c769a358ba4c20a33e34ce0bd2a5d932c75505f3f9bad4918027ea4b61492f53f9f2d3712620fbb1e3b90080af6327991ec099584179d5ca8da13debd1faf33b872790f7ae2cdb659f151110f0d799f3ab215b02a7d122c450f76e8390d7d606b709a2ed8aaff400ad0b014f9c6dfd9777dc89e97b3ffd539f1a3e0f6e581ff0fddcdc02165ae26aa37341079a6b423770c542b82e42e2851e6a1b802ee74712f9cde6f1a0cfa07c394d86efb94e5cede484a8fe5c1c988ad233bdf41eb34f08a1b57b1309b4249f2b773a2c675228583aa97df5f9bf5dfe681949b2bf0d74ebb0fe4b0f02740a8b53f705e1845b0e27fca1a408d414ca688b482e303479513a53d300ed8a1ea2a013c023f325cacdf74c7609c9b51d491ac0f949f389304b2d06fb526f21c70a50dda1e6ecec5a901f5b8270992ad9d7da5fc80544c96659f2c1a419f8b33c3b4148c7f1612137262e8a4940b650ef5481a4518d74193efa28bd00a06d7ce6f20922d54f7389df707c7a5f4b4b53a2198624eb17feb653a418e19d22ce12bbac3eaa9b190966f102ce748b642d7cb829fd232858264308c57354e801ceb9a5eb72c11429c0de8b1e5d47f9f3e087dc2190a572e4f5a5177ea1f3b1077d16b373603834eedcde750dc6a9859faef21c634c88d8c611fdf9cea538a8d53431035c0ef9dc1367d4621e27a5659e5394ed87b38126f8093c2ab1892b60c1db55b0c7e8e614e67e08f0fc1812f1dd2e7c6c1b877bfec96522f25899d2ec1accc99632b1651b38984085e36f67d698b7dd041c45918adcdaa05b89476958200022e52093a14f9846a7b6e7c52e64bed0dc834ae021945b413602fed6c5ea2cc04bd34f638b37b4a64b0d657cfc70d2ce931921a1694ee989d96747289121d7e490905e082a808566a8dd174dd9af1eefcad96178cb5f186c7ac67895ff816567d329e6a3ebc34dc8a2fc57937a21a2ad25d4a2d5740ceaf3d3194b9bee1367503a77bb17bf8835c03fea868d334a5cb65e6846ef893f40d250da881c99d8d3767b55d970f5fabd1bc2708b5ce2aa583533f4329a5e706c8b92fa15e4c6b94221e9901f58a17eb4790501458d11c87b85727cd6a8eb48bf0baca853a6702a6bce7cd36057d6cfb2a699741e780067e5ee8bc161baf11f420cb6ef15c2978c321992ef7a57bcf7a816cdde58ed2288858ecbb6e518f9e98a0bbc74cb3f4fc96547d94679e4b4b4872158c555835b512ebcc856ad79d3ec273ac83bca367b701744c7e2c6519db4826a4677d8c713740508ea6f08695d83fd0eb88a5862076e671416028acce6bac812081f4e240cb312078fda2566c7d80580f12b283379684b23523e7669eef1bb9de84408ffa770e158f4046dec970bc694203de90ac5d0f3d199127a3e5412d996f187cd1d8d9424f6d6b11d919532b5621b288be8f08c77bfe3bc587ba7eef381bf58eeb5a907e55d618dd91fe239af9718d35e4342f7f99e15912ada25134d2ea17442cd61f33407ecbb20a38e50c70bd5e7d0525853deb66bb5399dce7704a18d1079b9a1ebc1602bb9db0bedad6c4ba87d1d0a3778ae458672955d963f1b2facc6624962026b0fd82071d672ac25002f7e3ec8901ef9c34ec330e3126a34821bb2cfe3704336bdd66a105746a7f5c0cb2ca70b8a58d6e1836a2be42531d25f31628380477ac2b2382afdab8012e9cbb90851d3d0b9a9e6ca3195d813a09588745f66a6ebbfa25460f8c8447d5418ec13b08de2471e8c615c880a938600753875dc7d1c464f609e7bc0e7223fa43b86ecbfdb910a7bf51149e1329584cf8dd8d34c41a35ba588fbedf7256b570040df6705b09f0c1793cce42dc32e064376e6855a1886ff703074c6bcc61c42ba0fbeaca0b6c5a9b04ab1111f3cf24bc6af83138e1c2c67c3fbc7b9edd0cf04df3b96493241bf5863abd340919fe16bdcf631b4e90dd9ee0def3072bc3224726835c80f769879171d88e89db0907cf6071251663d74a93d9ff381ea77814c0a10db9da8a90ccbdec0e27295456bbac0d73d9b2d38c3c2531de1e21f2c3e2ff7302997497034a78e08e5bb331796add8f5cb9b8fe86e99dfbc523c693df981e42ad527310d1570f37db27f7bb305c1c619ad265f7677d65b59dafdbda6f9bf60c64d1a537f06a1651fb0aaafa99e434b40b5a2b47f9687fa0481cc5b0109a90f35f6d5ba6eefa5684fd7bbf69f0695c256d75a78ae99f8771e070210e26eef23f0a29b039010dcd738652709267d1a216e2bf24b1959623904e00b96d79e23581106e388543b95008433461388e5746c3691e4dd1d304d8bbfde0987dce0a7d4acc84e97eba817bf379efef8484e8fa8606805fb4e5137c909a6b2e12e3af21d16e89fb26920fb8a4cd4cdaa169e851720b4db91b3ea6123fd86d0a094427c3a469daffc27c4e4438ecc39fa7b2ffa268b7b4f4e2bcfbad420ad2e2cdbd443c32970f4df972b3ac4ad0520c14f752e8bcc861151e71a3eb383d9bd5d48364a5e6bac6b51573b52ce9f84e7395559a7886d15b304c8197267c12b7a9e98772ca5a8dd0fc72436f560288841247c7cf26e455316367484d7f8fac48bff1985ae24a1273c10fb501a34d297760fdad3c01d2d6717f9a433164d4a62bd05ef4870a484afcf0e130b5a72c2820e8228e3df94fb8848b97a0115ec53bd592aced5fcb101b2ff0816f57b2406022909bbb646a3d99f906cb1e35a9f86553afbf7187cd7a218e3a68cdf63200f6d5d441f7eff503752847e8f31362f214821b7465b12a79f8c68e5a7c3c9962567118609004df63459f70b61ef2750cc74b5ecdfe6dec9e4a47300f994fe60adea91a406743133041dc46408a4d321f76fbe7973224927b9f73210c2e0f8e93080d481e210c22bb0c62ba828b280db230e13e7eeb528d6137a4fd33eb43e082a8e493149af17e4cfbba7c3d352bbbc8a0ebfbc882c2da946e2c515b84a42e4f93020c3342639bbf4cfe4cf94fdc00c179007ecab241dbb33fd6e397bb6fee1a27c1f87f19f421591835c75110d9a17614d4ac8ca42e13e29e6d4df976af144ee2ebcaf81a2d013abc27e85c53ffbf45212db7cf5f350082111bb67332cd57f7d4154cb10757cfea30c0ce8d83251db72d69bc9c3b27e48cd17769adbbd3ed27ed07ab4ae265617f8818354822d713fb7207f8032f246a2511669a4687ceda606dea972b1c7f77524044929c1cadd0829b5e774bc2b77ae1201175a074a264be35c13cce649db4a6008f5441dc5deb6c2e2e157d241c9b5688a1c9f684f8afa40fe982f0cb701d5c076d530a21c6c4a947cdf3597b487b04d548e147dfdde3aeaa627deb7364c1b994992973be5d7757fbcd2a4330b2aa668277f8145ffa3702df86a2da3d505035288d76a750cf862d1e155b012f479ee105d386367c7559c22b6afe1034e754b94f7dad8f8e3332af8c99a5f3fe4157b277aec02015c0f191e2ab30f12fee78523b95862ce7a493633c4c55c0bd55a3be82af46539e6367e9d60964611d178850f83ec8fea8c039ad180486f189c36a02663c5cb53fdf279ea1b5dd3f4ffabdc84575fa3de0f335fb5e85fcdf64fb1cf171618249d5d967066053f19c6c945008ede5e9eefea988cf3978e80f6f940df1d96862fc6448ec5832b802af96f82c4189b8884b62ff4475581e436a61385145ed13a23668cb8ba9d1521ff2382c373ea383c1a023aab1bcb7c2fffb05281ed090a4e1403bcd20c0975c8da146e5ba8ac7f4157ebf544a799d575b6649b0c2ba399047efe4db28fdd4f393dc1ad15efbce954fdb9e690594d6d5acc8ba6c7188abceee3fcbf9102daaf8571a9223fee74f1b43f0e23f9dbf375564a3027cb9a170c216ac7eacf1b2767dd7057e8c2648e4cfca3ff3bcce4908ebaee740da11677b867141051ac3b03b3aec4d69fbb44a27e0afe0f1e4acedbecff2c527a8c13ba107974d05ef845e9fc607fc6c69f86f4a3149c903dd633bec35adf54aa041a922b513e3ddde0346ec87693bb0de13d64a973c5f7681d0bf97a6b013f45e293c8f947c0ae1a0b260968addc8029d77df19558f800c963ebd3c7875b375f23c5eb60237a051515d394a2cd441ee57ddf70e706e41bc1e0f850a14bb1bae2bb6ab168fd886ebf0528911c13a5be526b601465f08d6c5014d593d571ced43a5458c99729f5908c245e9c5364d28c39dae8982a4a047c37beacf9ab0517be82417c1391a28b1555755d219b8f3b2bdc75f92a2e820c4da77b59e6dd48b3d38377147ddef08382973154d82b4b12f32437f99cf2609c35e86a77ed2afa67f35709f8beb3f8a8a4aa271abe1f2ac49e787822c575c97ef1976ccc8117540824a94e9b3961572d0a3f1c737b76af81c2f572231060857f5b001b78b46a35da47f7a724d9f717abb6acb6599957ae762776712d314b3fd94871e88c9f8a8205fb0afe186b86a32b85822b87d5d6c14c370340320cf9af75d73e1422478e172d25f9fec7bb72ad56abf5f9d29820fb81a8a044ebaf651dd0734b97534af94f7b4715ca7699c1dc0524dca0cfe60242e96649e6afd8e3a418e987b4ed3ef8fc6a2ee9eb76b01c7616b9d13282681d0a95dd71fad0cb35f015896c5730670e5189b1f7c30ac84078b59476d26d8d09c5def5f841512861adc0d04ce1ad6974bdc05305e1a803469ff1c5b922d9ec03c40262762f624af5927f9097c9f3a80fe36aefef57b12eceedaafc3ea1fcfb063301bfc3125eb2d836a5b86bbe6edfcd146fb7d1bd532cfc3539a7a3ee379c12ab652b894353cc0147591b2e001cc9a328aa0473718101335de5333ef29dca697367b283e2ee24f7c659ee21116ec6b9db41448957760e8f509bf6607f03ea352e16de36c729dd1a4043e62a7017ec07e78558680ab6dac40649a7271edcd4ee1edca02242431bf6636ba236b044ad57ca5fea69171311128b3db696c18a7c6f5738c4e4f217ce37930e63c5c738447e75cd129021c306bb5608497c7a61750118bbbdec48f771eb5b945fddc0ed94367640a0b9fbbbc10787264c4cf00c097394ce63989ade710c8ce66a0a55c49ba41dea44c92a0eec7e6d0cf86b7029b9acc0e92f485efb84b1c7c7720ee0fca27cfa997df545e5a038fb8a12774d71418fd3d744263e2491b671544c1e6bfafaa46adba90a972f6826188645346f39ddb17d25895a20b851161dccd2020b29bfa0d6cfb84669b1357ac9a7e746dfbc0c95c832f58f5fdd40bd6738a1e4260fc84f7e6cc911879e936938098354a6806f8cb2a1e9c7ee76916f1673d0ab8f0715ba862eaacc1d751f2ff9766025fd7aa9d16af9638fcf787f4230b5096908046dbe6a1d683924db38b7a9b34308bc1da1e18423a62c1e691c9428a649d4851e9266eadb843ec311d7c58db63ec70fab50ddabae1bd7d00d8fb275ab52c01640eba832d945d238ffe988c78da7f37acd3fa9bc05ca1de3ef08f0948f203180ee68bc2e375c3abb81972d46cc50e8e286cd3cd01917a6ad7875e5a1ac33626bad668275b2abe723b65b707be3526aa8056fa8e91d21c35f2b6235957c0a64626f6fdc3a01fdda319a0ad3e048b389f9251b83103cad3265c2f62a5c441867929317d35812daa88402b574e73b8527023964800bd9cdde0872000655064d3c634d3f3a969d45f9189db060818cd3cd0629ddada2e0c581ff932d60020f34fe2f47088dcd7cccdcb0f5ff6e3bbb9d6ddd6cb45c36dc1f767e1c465a4b58330cb678544281cfbf37e6c2d2909bc1258d74211aefc3028b6c789e66a04aa3b0909be49885c46128c9880f603dc2b3b5d47c413bab9db8ca098d4b521abe08c3c69eb780f99a19e173e6d06cc19a103f615191d979013cbfb19459385c674a1a3318236f7b477b9d1dff4eabf386589e96cb42ee4972d0b734e079b81d2a545d21c6a660de345418cf980e372a82a713468c7c1b047241cd3b7696ef03e55052b2db09ca476790fc1fdfbafdf3ee6754f5a2b35b62b2bd15064b5623c667af8ac005f60637e7ee92232767d6e6ade9fa644f56ae34e3ecb6065ffcf8e0706504dd939792b875ba802c68ae2dbd1603f0c91be5256927cec02fa358da63e7a70a3df93d68a0ef33317520051b9bf460cc49e8a8421ded4be46561c29fa8ab4142d5e29b5949bda04fc7971eaf21c346c20066adcae7ed209d5136d0fc60b25e1d527146b5b951a218db962a0f19826b5aefb2d7c60f05e2ee8855242b4736e1a0e2a2284490530bef42905f4f165d5b0fcb051ef5b1ebc1786e74d6ac22ce1c66e4c1d32a40c9e50ebfc2030ffe59ca5e837dbb3867b299ebdc0f4b48574fdf6bcfaf306df3ca08661e6e3208fda1364ab0b4d304c8e17b2e6edca96ff71e4899bc70961f542e84cb5d765f99cd2086886d1019062ddeea3c290d3664907b52201555ee2448f0455368cf53fe287c88a77f9f2fcf463e82cb3066d406fbfc4755ce072e226f4b8ce85c58fa49800b4621b7fbd1b88fdb65b7d102816e98eb64c4103e8559971961e72e8fb04957b3d826c545fca21bb01986cf347a2b7efed5148482ee54a7ec42545684bc3dc4f2bac2d52af4700d6703257dfd6a475c26eacf63c0d831770077a46fa693d40b23987765b512a6d0ef988199cb4527ae5319c4316d9cd8c9b579d3604ca6fca1a51be07823ebfa9b10d8d4965094c4ac645c181f28bfc0e702ff8f41f04505fe1552fcb206af17ceedf0a280dd561b30838e4da6408715cde7226938c9355143c28633922392d1de78672ad15c3043b8203ce24f2edf7867ac28f7bf58452ee22f99cdffd95462e4911aa6d14e320edaff2c075cff708a6d0c62eccaa092a018979090a398375f1899bdf8f78d4e3d34af44be1069e12aaeb7a2bfa9beedbbf97b01ac80d7cfd55cfa5d6a795502fa1a40cc291a2baf84e55d168255de9b72687f24c1af965bb6db6902f5eede8e4132b24b57c72fff81bc7787f1da09a41e0c6f640747d328b48931b56295bcb4ea138930db8290b8b331fd3e1ebbdb73acc164baed4c70ef7a0336d22ee46b454e0c8c9c8af8915d3221d40286b6f5fa41e4635802fa2fdc161d83fec0c342c5caac7bf3b858810a6e899537b153d74366a7757dd324676b910b772cca3de5e355798c7fca3514cbd4485ff89890a4693fbffea7a22db9f18bba1c35c2720ce082eef20c0a65888a5f2cff1d76ab5adfbe7d84b6f1d1b039933d38b20cd571372508ac66fdb5fca9fd5805c379ef9de67c2fa08cec5f72fbfb2b2bb1bf0a542b777dc01701315da1ee2467b998f81982acf871d268f1337ad3742077d9ca5f3cfdc50b2738fc0c5c4cfd1967b8a9ed1f79fdf2dcb6edf28ffc92d71c5e324bfa1b04279fdb7abf51ea4f844cee8429b21ebf956e6081101b5f779b9cbf3e6764fc1385e848c5ef863a3e36d4b1ed45f77cd5d5e02dd111f67eaf2202dc22bd8d8bbe7403017b59489c69a0b5b17087a5c348b03944f11400fb0c490eed0e7eaad0d350c1a8bfdc8c1cad5f8b95fb286e672c25d05aeb1ab260ababe9c1207851b5eb9c4a945f504cdd6cf717347e7eac2b55c5afe5a09ca067e9818a18a978e164a77fa65c08dc852c30d66a8be28e61c69be8528ce0671195bb756ef0b44ebcd54ac51ce2423dbc661a5c2eb92653780ff8265201af662841d996da6ff5d412b321ba83a83b2337e36db106d5a0231705d2e972279663cd98c931c3e8efdfa10513a428547c1c07ac53eb426edcc2c3013da48e89ae91b894641e31f849d72a9dbe7640049beeb50c153c1e2de0be33f5b3f149f4f8a153c261ba0c3391e4a5b808bdf5517a47196a7fbb080058bf446cbf3e2621a04d0becc3100949419d984ced5f93f30603357f392da9e0cf9f2cea5815f53353101e33d4e2ea067043d77e7705b31f48ffd0acf1c0073ce9d64ccf58051335d44d84bafad5146de592813c3aab2f09c1479a7ea001519dcbed6293f60a9d9651ce38dde04c38755f2bcd46d082ba1b1a770d64b45530ed4ab39446e7a5a953b52b1d83abcfd62a4e87dd885429d9e8b30849b8272b775f1a0ad95142ac9295d5825b5c2f206972d3674ac5bf961e7c4afdbc36b83fa40de6de87daa1bbdc584be6bd03dc0f3583d68b4614d8bc7468abe22da2e7f818f4d509a24de807f5e43c83c076e7e1599dab9daf296565684214ddfdf27760293eda2c8631dc1936c1c513ceacd754ec79fb5a8db619dba464db47d78cd0804598c781550acb67867d7a91914dae012726bfc8be12e98eb84d3f2e1389e9e5733f206307a49222502be39dfa8e5e77cc18789d5fa26ad68a96a8d730fdc53fcd8999d800fff4492766c7dae9b4b2bd747f207374b5ce8da2cb569c3a2c2a044e7dcd073f0066bb6552e39b8f24df3d39208a9687cf8c37658961a6976747fd5a3b3e48fdc01038becbcfd8fd537848a2138a2587f458a57933c2a5651171148492367fabac882237624a2d8306c3b469f4674a6f161da4549b2ba4c4cdf36b6f9e8f6ea7b6772e27d61352507af4fabb885c088b1ab48b525268a778415880a159ec43b572968da326335cf1291c8192021da4c410bac095c06dcc0563faf42a46fae0aafe7da8753c294a56706e43c3bcecce150aa5dd5dcf2295457a1a1ebdf41203d009bbf520da6756acc4964f0c25a941fa1b42c8c942220bc54d1248a5faa6b20f5d658cd97710490d82acdc31a9ee52a6e32e91dabceeea3b649e297a9cd1181b327230d1abcc00c48d4a7f106545f3c2ab83b4c9357cf48773522fe4b1140faceae3922381f2c67c6988f5600b4dbf3a0bfc27788bdc84bc277accf308abe5942d00cbff997ebe9414d727a6f5942d49c99c6f4608d2002414590a0c56045b9cd2e1616352bbe05f9ed175d9cabd68cb94b09a315b03290f4fc104ad83ea7eb072de69e012483742046698bbecef36a6417a318f3f1b086154e5e010f3ec6264aaa16a9ffcfbd3eecb89a0c499d52736f5c1d5c06b9689b03b3d4286635e00b3519a26546bb1e4db5952c65939445e05a4648b59d2486f5967e8fe4696c76982bbb9ff67b9a060ff69cd0fc70967c1cf0442f43d1197c029b80072931ab9a36b46270438d3132078a9fc926a776ee60e13f5bd581869b86d218f815a45b1cd1643c7ee99db8196540ec249e0b8766db14caf108d678477d8e141ad9e96cb335b83c0ed899b7db2e6d66f95cc09668a792d511718e1a4d135a49387cbe09e5767f8838b1162e9d931494b356756d7eb3d8702813726dc4494e1080d8079b97246689f0f395bfd0b645e8b36f2231cab9fca6945e344e2ba125ae6070c0d936d74489c95b01e2a8bf4b5a275d11e38bd666ca5228fa84c04e177b0992be892b3056eb6850cf10e16cbd1e4d28ac980afc60a01d3108ab02f0696f8af1f8c58a2fea95307b552d50b9998a29c77a51b809f99cc377c0d3a1f8c22083b308ab64a16f81573ba0cafcefa6b34c517f4131100ad7fed4b23eefdee6f771008860f178d24d1028165b83f70d657253ce737c5fbe12d121ef7599bf8c160981eb1ac8aa484d2719d5981c648bd83e41fe2ed0479c0a4be6c21dc7556734819a19ad4782a88ca7abe0c8699c8959e34f7f3bd95cbc35dce60721e382ef55662ecfda03d613d3563fdad84f07503ed57e313f7684e148ab1bf1a11982616de6552bc84c9a48ff26b96d040d73cc4e337b4440d19798185a8f08dba66c908d5d6789e6f7892119fc7c5496ccdec319be2a85de0069a72586ede95a9ec850283a0fd7a336be50a237452d4b4832d37e2d59e2029c36785d91a993535a3cb211b36c89a883c1cdb2c7bcb8e16c466cc165fb92a81a439a262dbc8022e2ef76d069629da783fe815034f1b17d1fe4d0655e652c22ea79a85b1140d90d1a91b6c6e6b76c42519391ec8c554e965e576c176fc7efdc78849ca4f3ec8973aca6c7299c38e6ad49f7925bb4e44c2a8602d7356dc51fb62e10fafdeb46a8a000245637fd0258dbab8c2a1f2c3f259d309b6c979404028e894be4ea404471d2afa2527648f9586ef1027802889bcfb93529888cdde829d2b019b97efc4950b1d7947d7807a0534ae1224fc1983b54662630e81a99e2b03de283d0bc58bc6cd47e4cb973f6c27fc584c96c85010ae4f4ab1dfc5d3df0f800bdb41779d21969d4401d7bc17de1777e598eba60eb0bfc89973495aad9ef0daac488dce9a7c145d869228cb9d7cc0a1853eb711f315dd7389175b46fb13e0960892c2eb721244c2803109bb6ef7199e02674edf1b9f814ec24d607a904bb37e93f83b00adc2ff5a1ad85657de1eef717319669cb858ad0e49a250e4450671e3b211578f16c79979ab600a15143f6dbb9a87d2dc2dd435d09d4148356a8516500f1ea8fce37e9893c6f28a3d1fcee95379cb4841b725d90ca8113e0b1555132cff44fe6a83ed5a3fdec10cb2d2a6ec360439551658eb6c238a7f4df381aadd8d58d940acd78a88a61cfdbc1e73dc4113480342844653421cac435134ba7951fa8f5cb8bd13a5e08866c41285d0dba015a6bf2ad39d4afd9ca19e5ac7875b52458d582b72f434903806b38688eac1a19570e5fc4a1b8e1e0fed08c4af82805eb818b29ad765c112ba62a1e3a5c18155a7e6d11621dedacd43157b95693826332c9bf831d964bce89d35223ab6ff00a9ca52f6a7deea3bf6602ba5ccd4bc11e3de1c6812755c7652ecb8e3b1b41b5e475924e083a7e1a9fb94e018a222fde5e9a647a324a973900f84acc6d7f25272967dd99ce48c5cb12321201a6a191131bcc1aefafcf78d53922f3018d0ed0eaa22b32b91507b417d8beb18e83a7892dcd3b19cb0eafa2118fc53b1a68a8ef6fa9b0e84128391ed845937908276c8ace5f4f6aedb8666a698fae7c7269377a1c5736edc565f39f66de8c6a3335f5b8cc57a2cec16455a50198c0f196e9f27d5d307baa118aad06bcf2fefcefe0b9d84c44d49821089ac8adde925e4f6fca8ea5a2a5a467925d107e57cdc55d7de32fe5de89cdced72ed007b6cf3352a23a5cc40a4b861b3cefcf9dc987b6c7bb310ac7e6d240d9dc08117168216f20bd47009d02ef7af0df385fb8f005bf7130a91d4bc8864ceb297f0aab59bde8c5e303d0b41561c89c5b6cdbafbd6b79b54b5322fe4f46d5e01d865e71ed60dbd139b49a42d60b832ce5189d8a5f9355338afc7a95e4b24c4363412f4ab670c0502dbeb72b8fb285d5842dd3165047c37c2e0aea189f63b878787260a56ac21c9d27a605dc967c72c3daae0972fcfe9c74834f03d6b80e9e533d9dae1971421ba0c29cd38577aaae951fe82655e64c79b1c479dc40eb81f3f77ac132c4ddab1fbbd9ef3f13465be1c7e71c93cfc5161507b113c7a4f42ee1e7d7c2e0ee615e4dd0d7f3e1c05a26e4902ada5f89301ced7630eb495ee876da99b794816a7959b352914ba48f754b5d6dd2c93fd3e95259a9a32dd49c32e2467fbed7596215cc24191c8a3a7c075914d3d25de4a9f3b996921d83288813169a9a370201fba43d666f2a888e90eb1671dceece0d3dd3bedabc6098e436eb52a324a443036ab3d91c769b17cef0b2dd7dc4d490461d001e7d68c7adeb7e7172b7d3c7660433477f0e9d92c932a0817e2ce29cc15fd325621aed489b44616a086ede8cd4df973a05bcdbfa91240ec5ba4747d4c32e45d7fb2f6a91f2ffa92e0fd68bab70bdfdb2008bebebb5abbf9229f51e2195c5a7e6239f92aab8677151f1d14aab9cfe1982113479ea158d965214cf0ab14b635b92d1894f3f31b36ad8426644144d46c2701e49251bb3bea8af7900537bc133c6ca27a8e81500982d5d16b5ee0aa4bc8ed818c44c89590516f36c45b7af99ecdab2b7f9aeba97c3df5000ad1be8bbcb0d9f86b3acf57bf61c70361a58b0db900f348f419102dda679ea3582db64a3d0712a8763a3421e742974a522f67aa732cffe962e8e2782f64d7121b1ea64b6e931c9dc02a26d9f864955794ff9640672ed1400050042aeef2195344e66f76a5ad8cada2ef7aa957962bf61ce3fad9c7f49ad7d7ebf4e7c594d61e2220513b2bbbbab2bc3829867cfdae929eb87caba8c47955a14e7e5f67a17b63690d8367956391316228b4c407a808f1c682638da3d5256e3711e8870587486c20237338a7098b70b52bbb8706f685dbcc63dbd6e84f2282e031f12d6e0b61bc1e1f01f243ddb5954c67be8adbea90eeb3e72334a671a7df45e0c71923e0aaaceedcd7d90776e2f34b3e6beb6b26e3dbba6c29e47305b3f94e06617b129c1cb249a6468dda47e484cfab0cc2820ab3f1ee1feb421ef2f532ce5b7defe5602c6f298b002b7ff46fea827e344bc6c97019b0e6d103b403c4f001c094c5b8eeaafc9fd7c3aacedfc8c6e905743f680b6a033c3bd85ecab0ddb566d194eb0f674db8fb456a78df03970d8083b734556de646490cdb5c1169711804e0a4e4a590255f8534ce292cc7cb8e3c2a121a2c37031c26c943b633ddc40688a373ef080b14051514243d8bdf0e356df92d84fe824b76370184f7f36844c9844bfe14aad6a9f20346519156a7c067123a60898754e40e35ff96fb1aa823f0ad289aa2a204516d7c8fbe314e1cb79d001c561dc0ae09476e932f485248558b9479574bec9ab9bb24cea012bcb65518a9369616539bcfe8729def423353f8d6dbca677c4bf68ba9903941ccc299ec4d0b4a86b036757571d5f20b865b34223a4acbb0bfee372b9f547ed2eedee9cae3171b2d2bd099d7138537b3e4fe4f1da0ba46fcdfbf8e2e73f81132ce4c2a1ad8242354d98a85d22b38b2c527a1bb56ecaf175f1f02b56da3ab15d50ed9cefb13559b9cf6d470998d73ab85b98f19fe9d401ddb0f2661637d07ca2c8fa394f0643198a1343507a05b1fc3f5164e69e3583bda8c9c1f650e0776110732b3571d86926c57cd548d8c30f0e7c39c53cfe572a3e4fbedb14a1f42021e3b65034bd0df54f5711bb2311cf01ece76a8cd8b4807c3f8672957d21fe8e400b7af9d888a8bc16af806f3aca8eb22762ba93f29344017d413c8a9289d5d39071872448528e322a6eb4628bbdf4318bb30211aa384c22ad5c39d3315c80cd9e83e1dba7cd5374afaf595730e80da75f64b1b436dfb540a017d91ac6835b302b903bbf9e5e216b102f446d67926f29070a85bdd8436932f867d14afda3fcd990da637324a21632ec58d1dfda40756878922466c759908a8b12259e762121f43462d46440f270bffcac177c760d245d225f1cac66de6ed2b8dc49542df82a0ba18f94ea1f6767b47a745f0f36ff47450fd4e578f808f12f0043c3bcffaa9cecb1782d71696cc8d4a8f0157e251f47e8024cf17ec03915a416a5d6226b0e3f34c329754004566bc74f1cfd2445006e8817203efed107c360f074aa3576bb8ef0dde09b9a52df375a35b014fa80740caff217cc4d8a04517590cdbf472deded7eb843e9ba78b81dcc61a4ad73aaa996abab75f909ce537a09789bb59df6e4dc124b509837afd05050c8c0e0de98b8dcf661c8f75bb89db1382bd7a6c451a49bf16750f4fdc66b58e69110b906ef950b4f87aef04784e594521df52fa8e8ee6df74c776807787c7138683c164aa35bbb1df9791aeb05d2f0bc960ba59fd59b9b509761daa80b673def9091cf9cda1f03c52121e106b7a62ab3f005ff2df373fb6b985f15343f87abc5c97b75f6b5404614b9c17e0f75b933d999d90fc13dbfea9df4fc594f15b24c251de62eb55e9d283efed451d9c03864545c5a511c0c67b4b72bb7c6c37bfb92d258e0378fa10ce66f5c65e4d489756a9cfd41f39395dfae1881b2196f61eac7c597cee0a40ccbe92086a960430113ffdeba5fdff5b3255b634e47e5dfaaa05261cabb92b64a3092a2891ce43e55dc147d7712906aab416e508bfd8dc4e0f8c52de700ddd4e102f0d2aee76e59043b71ebcba7d808143ded7ec7e00d97148536cedc46a63d23b78bb88e38549538db86fa3681010072ba59d83b294b10c6d8a0c4982d8c1d485c4859264a5fb2d245cb69a3a860ed5eb0a1f892bfb5f2cae7bd7b2d7f5f343259529d6843583e87b8c058b2a79734a22fb213dac2dc93300a7f1d42c69afb55b9533b5e9c222d3d474061d26785c448e9b88db608bbeaa4cd8f481795b1bb2184fecdaf8000289bdd6e35e57b3a2b1641fc311459dec613d6e7e332f3484585d6c93b91d963af54d18d436d949d7c0526a84a11049d3e450e8ceed356918a3952a6888b5945651102589b8b3bd6d97a9a19e758da45d9bc9703ef2775c6b0ee2a4584d76e590d5be0c24378e89aef9725318487df188d4a59193a26c672fb834e24e4155f1397d698c1e59ca19101fb4ad1c1ea2c880ea36133013fad3d899d219f0d83a53705320b30d540a08bec2baf2cb42ff830bc59d7d64f381008caebe3395503d590a6ef082c143be3d8749baaba5863f884935f0571cf06c36969918a0cd1d89ad4fcc8ec36391d0fb7471cffc03b6c67cbd69d5e71ced79a1ce564185db7b94c65757f5debd5ff7602387da5935e335d98d56dea028cda26d0bad983d1b3d18830f859d21991ba28f7ffc286bc9bb76498c62098d2ad826ce0bd5d12943dd39df9bb0364df1d4c7952093fc9bf2116105c2aec310508d9c6af2c9b7479a6bf10a7acbcafc7e790bbe33e0ac374f3b23326da7eb872922d18bd4a789119a60f90484077d92fc4a3a5d9d10e26ad618791c3fb1c9752ebc783b60f58110dc3a62c83595d3933919a5a5d891730798a500aee74cd196afb2542567df0c4a5dcc55a382a21f610e32d2e59a1af9d38b48d29c32451151abc122cc8c694b12852458cba335a0d517eb252d560d84e69ffee22cd25dcbbb4c0c2c1aab58bbad323b5de51470592d5420f2fecd22339307d01e386f697d1e3d70ff3c9a5eb45af06cf0e3800cb8002270df8e057de3d56ff873c98e545041df02d4469cdd5d97cbca453ddd406fd3352f197a853129af1e6f24f52cc5ee0d3a30d842213c12fe144cfc22dbdc3779ddca88e041058816fc5b34acf5891326f9aa0b3e8dd8b34a620656f7ea5cf91fd0c1872d5c1c15b7b85a05c5452b0c2075d32631dfd26b137f41dbe11ff4b7b93d624ca03c43e2927d0fb04e07e6b803d40dc7dea5ed3be232753524dff3996ca0e20fe9208d5149764dd6e6ccc49be01c499943a49027a06349e128d5d437c65b60a03b65db88e689a275d24a8729d419eb14a9b84f8e97638a79520cdc066ce3ae4c814fc3196b38809e14a44a73f8e0c990bd99ea4046f31b0026bec71c1370d9bd35163691411719d4fea966c1c15b8908e45ca79a281339292274e6820eccd9f6ec0e5a785c62f93a1fd21cb5f8c551840ab74a9e529d0e5c4f024bb61e66dd02ae041dc9062a22311cdc3cc17eaeeb36619cb34ed4b1bbb6b657ca546e047749a798cc351ec6e06eee06d6a0bd56ce0b38ca510e410c9b972bfde2c1ddf7812d34e366f8e46608bbf323215d8b567c825d8d7b242f5788e457944e6ad01c262f7163de060082ad018d4824b813add41014d5be7df48d6dd48eba39db6539570df96aaf624d4f3a0f312069525f0a298107d6f8c1227cfe50076382f1dee9133051d47df41a9f5347f6523965319fa622574df09f1573dd6aea857f3e9ae39fd9545207cb5ce3c7db6512dc3e4e283e8cc1609a1ba039aaca53efe8b6020a4a6eefc4faa4ceb1bbc7af10837b93f3e9de45f81958c0fad59c3fa84af63af09afb4a7094d5db2ba38cdeb39f5557e4f96f74369b5c1153c276407360b1e14f713c3e575d658c223f233589db1cbdb220ea58f2d815daa0bfd6d1b1774d405b24bac4335094efbe04a66ae2f77dfaa5f69b5d8e8789fbcbb57b335944558a197d6a95d00a206f7a8a39a385ae1206c15e64ebc04d12240c01cb45fe32a6d923f31b8462a90731a8a1dce3f84ac8883b38719bea96b9e4cdb6022e1a373e7067716fa57e4626e95613600f74ead559fae7e8df69c6ce55e53b9e1640c75c18ade1e979045af291d3ce5168a024c89d994f132a445b5d7b4848af10a7fea7e6b5c4b5eaf76af729f41bb8c85e70b1e9618dfcc983417e60cbe3280ec9752aa0c8bd93ba40b317eca5b9cd88bb6cc52131fa29399192e6a31cb61a575be650b33f4cdfd341e5150aa5664b887ec0009cf01c562aa11f49a2a5fa8d4729698c69a68649175b17d1d4ebe1c1a949bbbc9f6b96b1131706e43dea321c2457ec2bf4230600f35e359ef63d342decdb3887baaa552116fe2d6e86aab7c1a31daa819716e94bc6bc307d63a17080d89c480928e31b3b8ad3b0def6af1cf662c4e7e536981c8002dedf46157d9021194466e5de5b91f526757bab9c8442a5e45f95e74b00f92d7c1c07a8cace6572fcaf4c00e63110f25cf570dca41dc287742d8472ff9ddd40f0272dd0e8a6054ff21d4547c101529423bbe9da4d07a9963ad066e6c615e5c9b0d0a2f5f824306871f187640a7d27f1eae84777de3fe15606bb21c7d85b20f45a7514539a487f7b23ed61ffbbcdacac7f380f3aba7d2c51d8f9f2530ff78c70a775a058af2cf6afa867999fd6ad371fddef804b858d54b93d4170cd3e13dd7436a4100b81e47fb0f5b48fda3e29493c01eb8e86cbe3b964de1b9b93af526128ee784c3815d333778b2462a8f4541be3e38fd6d52a2905b2c339608d05f872b712b50c3512f44c83db4181de30000f3f497f0b833908da408d17b402d99afca5d2174fe9c3d8b868865ccd6b6f2f73f89082866a31a8ecbb4b38f55a88f928c9782b7362d4d374e73d93215c2b08916c615ca094ed894aead3667a976020ef96d0ba4b19320813c4389ba8bc5832392ccef800fc95d0d1c97a2ab743a83d1a72a1ebe8fe199793103eb705815afeb3824523a2206af558843cbdb371ffbbdc0a7d092c63ebbc8a898a54b920a2786b02f7d06141de46452f922be58cce5605a5206a370d8392c056792071fdbbefd013863cfe70cf5fbc0d8528ad9e709023383b7649eb11709fe7d2d75498ed617647ac9865a5ca4d3017ce6c4b67557fdf97782839d5e3b8fb1819dce5ebff9e0d86be4fa3e3effe5a8993da92f4e0bd753879aab6249fdb8e8f9fab4547b1a20aeb8f61684a5a0ee8d1d372da93d80f47d449a4fa0d9d2a239dc600e5a1ba36bed5467a18da455b87f1b74bed8dbd665b209d00f4d4b9407679569bb5c3ec5766b471d59ad69c989ba4113bfd2f3a7a7f51b36cf1b8d460137cf6d1d5ac1e4a56be58b3ac6693657ce50948bfce5cbfe4315b9976b4d9cf3b8c4408d64c70387a913decfba2445af375cbfa5d064175270bce2e9080a2292856a8914a1bc5fbbde68a7838ecb03814a94b80f7ea28af9ff7d71625670d0f4676a07b7b463a937b2dc6835cd6c3468b8a5e4cd7eab1c074553cba6a32268ea08dd675cba6c7a7da401b0bf598d2e4c2e85ed82b14ea3d695f68c39703bef4fa966bd2788e544e2d6d9fe4478419f0b350c60b107a8de5c5ab3fc6ce37353751ef858d3df9f03593ff1ec3f2fbf0f4bae07cf6573266c4d021adc1766282765b50770f168a44d08ca28840fc8a077a1cac0f62ca1a9441012fd56d55be34d1c6b5a9434607a3b4e2a24ae1468e1e34a8bdaf81cbee49edc6f49f28e0f50d8cfc4506c761aa987c7b3454250d304716f230a7154458fb495c63a4fe884beecb3e2a97895fe69e8b7667e6eb3e6879d3f0ffa6c3a403ad41e263051d9c415624cd8fc954532835ee65932f7d2780aa34b1a6d6d0df4eeb04bb435e9bc941a2b3a93cdee48deaa6014de9785ea3c990f6d25f0dfc03f1972ad145bf1e86ff1e6122ebd1a5cdce57b4e8ff3e7bf722f93867f44aef4aec9016416553f470f4d44181c15f73d4ec4114c416d6de84d3d0165ef0532d99932708bd05b32a816cd6151fbdb737292caf302d3d83632765ec430927bb31343945a6e250a9a5454e490dfa2c508e3ec57d21fd181bcc8dd359f101d452f35e66195f7dc4ae8c297e9bce420430332184823948115dd77e0d38e4ab4198e4fe979d18740cf504b8f30d53bcee3134b833319ed51f18d2d6daaa7315b30b4665ac90021f90a51ea6021ba48c1f2b15f77fc1a996bd7022110c020593f60920b59585793156842c3797b1ac20413d4eacaf55f181ac56cc97d791d18986b5c31a2f239c974dd458758a882fa3ccd6eec83ba56ec89fb1611a3ee30af0ec9fa6b655932a61c85898621593c067c0188e7af035e9b815ce13fba3c392c343d9d35559184d56e56c7a3de0937831b6788a2eb6fa5bac7f56c823276c61e1e1d7b04412fd14478b7fc65f524783c159f159fcf019fe8b9a18c4269ee280984a9cb9c21b2e07c4be3661e263ad5aca6723e638140bacf4ba2d1efc9e0ab551f8d255ec50abf3f8cf2f2321b9fa2ec5f9df012efb8f1a5482afe00114c3105d2879676ae1a171404f919d8acb4703af889b5f0732054f4d52385edb3aa2c6189eca0cea6c2df73c97681c048aa8c324afc98f6970a2dc0e1f943099c96c1de0ea6598a7b3aa8d206a32aa95514b914a93cc7611746738369fd8185e86b1d2f3722c02af6ccc241175a65403308de03dd38f5505a4b1b40091a2c65c51a82880909f15d9b3b9181b5c525a2eff7d125a255de9b1c3e191b52e38b559e041ede71dff7ccae365e3c937b26bf022c64d23e07670662cf638a78f56cba3dd874ed2c9fe12f3c18b91eac67acd8acd51758ec0484aa75690b05d26f6c635c603bc3bbba63aeb41090ca405918f6d4d39f4fa9699fcc8697408dbec5de244f2178b70ba8e674a60741d8a7819ee0b5c05e9d98fc2eb4b063b29a0e0e824f7b5f94d4ba7d8adb9152732443374dca00fd3436e1ceeb2e2e606e9f54bd66e579894dee279ff9fa450f841ef4a02235700cd7187a46dcd2ba7e96a4b4ac80f0bcf7f99032e32d456df3d7399c320d8ad98465e558eae34542c647e37f69dd41e3c6661f3d98be375e1f9082ad382bf0fdd5a71f952e2f1746a5a4f4a4a146effb0a6bed0c82309679869ff680048c386b4eea6cf1568bee6962b8643bcd5fc0144bc990d9c38b27927d05244b7800714985512460cf086910042b55d7160fb150c2a5cb52284e7a1b2adf2dd688eb68d7a7129060ba4262af63a55e79c4b96233e8126f1ac1f40b0c7dcf92bd2faeb12f2237331259ad64149c54d31ebddb50e4ae21f8bfdbd812481ab0b4701122107f3017857e38a3ca65a43f7f8c8d3ca4d5bf04c1ef3ab8d750ceffbb797ebc88df1f1fe69281902940712252a0deb4f90fbd3f68984ee7e7f52fa1eb22e8017b809c815b5a5fec98986297bddcc649ffcda8e36e87519a5005a33697074eead8d932ceecd22962b2157e34c7e7c96101f5f1fff8340e31f885e60aa70609c26e6b7696a8186b2bcb3f375942b1909ffe316406e973eb5b8ab1084d09ea5452b80fe2bfee35a73dd01b4c5ac1a25ba46f1174fa3e598913a01ac63896642c771485a540e177467c71caaa1a77861bf9e84711e42e499613f0f68bcf5ae2781b4270fbc9096835ce21dfe5da951c11c87cc6b665316d93eb9c27880b19a1be1a55f3f36f53bdfee67a10435360ee07072922c81993ddeda378a8b11b7118fe6489fcb32e56d5189be0ff8b228a00f20f3dc62154e172db9c5bd9ded1e8a7ed823532144835fe2392706061ac116e86db9f7d01ba9dd70bd64085e17a3824fb0cc8e76dd2fe57112d753731c7569f11600d7b147fd88e9014ba9efe4e76aff08b66c0ae21d6cd73163463e6acb33f90b6bc0c39f858146d3a8c8d2a00290b60457ef4795d276ca83a7fbb605ae4724868f29dd39add9262445f75e89d3317639b91ce82adfb10072e5caac9335418ed1f7f925d334585e80daa6ac9dae29106ec4a6aada3d2ee75893a0e45851c470cd0d947aaacdb518339335ae4dca031ce5e7a67b89b0c8bc6ab587f86d1ffd1aba4d7d955d17b1c7d73fc2cca55a3d5e7ca73ac21473fe656e729c1a5f4565178352d9d6f1f92b2a9d1d0952bc10304ead6ffc34d78979fe5c33deeb27c7a82fa37731dd5a3989fed6405f62169e3d172277923bb0607bdb3bfcdbae3114c9247483e97fb8ecce15634e993e01394b62eb0c10882079336637de54ab6038c39012ff8bcce18a75fa0e07b6b4be11693295b3dd7d4218de8a6cee6350ee646eae260098371e9a74e5444fe046234bf1815dd0afe0418c658acc528252d2563f177ec8cb721cd3d7066061a7cafc0ccdc69f90b40b7256f2aa240ef911c6821b917833be779935c0058a9c804d2e92c87938be302bb7ce53897c1659fbd9eba120fdbcc2a5837412ff8b73e31dc432f6c40992939c8d90f347859006a621aca3da9360b65941b48cf822ef2f46721eff6f84b7d5333e66a99b7b5728bbbc727edcc51534bdfa12181a6a86539a7acd873c6943109a538b812dac6bb3a08dd56a2eeb66f577e774519bc3eb288a5e7a05d7c4b1fdd25dbbb176a9df1a5fa8be9f756feee15aa7f40da8f96613b0281c67c52cf0459de1ba163ff58f74ffa4fe8feb55883eef1894b2a769121d9587796c680d63c475193e0b7720c6383a1873f991d7f039425dc7883e7cdf4776671593bdefa1b863a7517350b6bd28adbbfc69701a6119e7bf4ed6e55306bafaa3942a0e999a7cbf30efafe6ef3631d5a14555c9e229c1792ca4ef4a3e44735bb3853fb9100f466134a3a37510524c30ba226a3a3ead20fa7201eb310e91caf7ca194a28479491f2ff388e5b79343887371e36aee490c550b69d1d0076f404c3ada0b5335c07f3de24b7180ef04d7246df185a706af6cdcf2968403316bb334bf311f5f69c0dbf962a7ceaaf250f6e2e0117b06b87e329b2e2af2c5b0385a1a74f4600da8f0df5760e7d6eba0aee7e66321f87e01386aee9e428e939f8f356874fc2abc618c2cfd709bf1979b14f51ccc9cedd4d902aef483ac1116c4a247c6b3dab8b7e2838fb1271cd9222704b50d31086d6b2fa6f06a9118efd7192f7340e8f121be88f67a2b95251f3c18c5a9c92aa96d613392486f0c8918af5bb8c8e636fe24dd46e75988d7e3bfc9392bcc45a793163609e8e2e322483ac199929543f3a38f3595d953d8ae7b6ba44681175a22bd38463e5070075e76a479b58a72860b86d2b9d8b742cb42cd1edcc54612fda2c8b0759d8468c89759c75df5651e9598ceb61d329cb909f3a8e831b36531a7a485b38646790b42b6ab360fafc9c27d025c6f807c55e6f6914c694f355e4c14d4d4b9e4095914dc8fc601f7a3f94bd59e4167bf63b95cd80b1c21170ed51499b81f2a2e16bb606eac19b1f7e332d3a6ce96a4bd1396b2562d0e90fa6709db7c937d271ae8535fb41439d01fa06831d7962a868747b7117dff6522cb2f1f18b9f064d7d7214356fb19c60480a3fcfaa84645a3d5fe467f3f5ceb4732dbbf53a9c1768b3a905b18849348cf97bbefd60a2052047807b17297fc211591b73ae0a50c967da40b69a66c4c0074aec8217e376bbda01f21c32b4ed5d9a597e08df164d7948880ad28990ff7b7b35215b96b7b200d62373411dad69405496189c8ff6360653d5ad51c58eb9b78b72a9d428291c71392b7d1756f8a13a2c031d32dfaddef2bcefb701108bf0390159a703eb1685f98a50cf56d39be78448dd1aca7b43f2c7a020993607d02b4b5f07ade2464a1ad5f3cfa076f2d97ecd5bb5f41dcde38043c06c1b7c2a65076ba4f9f10328dd1353079cc2ccee16dc073d9013beb5095184ac2faf1432fd57f5c638a484d1e1423d9a2536604ec1296ec55888ee61d44429ea3899f31d0dbfb0774f0b3f6af32a44af87b96fe5bf5d06ccb3bf354c743cbbdf08b8083523fe4dbc49b44bffa61c3f063951d7a284140b949b0cb5713afd69c18fb8cbc36581497510c744d89ace1007393b16308160b77dee5441abdf8a3f2add1cae51dd1a003ebc46dcf7798d7d7c7fcd859b15f8dc1aa26da80c7a235d7dbba62d0c994aebb6ba8f20f0b71eedb9ba44ca9d2809c87e7778428cb56e98c1dcd011fc5eabb2345af4cdf35a4a959699af531f301bf5db148516d1dd5dba403ca96ada2019f8a43333df0434478603a8155ce038f36282722df610bb71d7c2afe8cc96e18d70e292820ab6209fc47865639b9ffd1462b4b924b65a1110340fc406a9415e3e4e1099ddb88d5e305b62a5633289038e85b978c4de20b719a0bcd534752e45d9481e16e62a36107ac6114179a896e3927cef52a6c7264ff4e34744e498be9b6cdb1d93a6346afd67de1fca6903d58bc6f6eed83e1443166f5cbb72de1e3f7ad0f754ca35decf4c89cd4a0b873609670dd504dd8c765c9bf56e6abc0de510f5feb8c03dbe2f7154bc2800638745837c3890379b3e455b776ab8a91d6c284a85c2ed8e0c82e5eda0753e1318d3d4eae9955ef9b043b6b3ab1688445275dbb079fc336d874969cee8a01d79e6fe4c5c779b8f28e26222a7f1bb15ed3349df02c7c8d89d1de0842deb92e2319699c50147e5373cea237289bface737ea7fd2725864742a5e91d809b032fb907b090b7203237cf55390cf15dc04da5265a8e0e83867cc6f76506a050d0fdb523e7d99feb55407a28ebb05d9358b87c594d3dae7360bc59136b0601b92c3b42c5d0c82b122eee5942ce459b1790d5bfe329e146bd42b0c358d3895c25fa68ad382e92048fc88c282574069f02a3a3c3a42bf45d9f41ff2aa4bb785ba43e5064fc81c708b2f49ca67cd136a4a30ecefd78fa5b3c334aac41c4dcf814f7861918f0a3f05348cfb2ebbc39c70f0de87fd2ffefaff9f12b5c2f429d42c12edf50496fd3f75d55f38c485d240d44cddbe10eb42cfb924729d07333668a23053a2374db61e0b83a35348f7fca6901a3514c73cdde257bce224e71e8da247e57369d35b88c646bb1bf7bc6631bd97364cb1b3f8477126981227be14f7cbe817529c4b2d6bf24a78915d89916a79ee371533618be37106f8672e0e79fc91e7fe2a856d687c0acc9e9a69ca8c6cd8764e37514f69d8646ad877bc4575bb513c8cec04fd0cc79adb9e04645c66073c79240c4e1094a53e7e8e57ae326c9c3c305fa13ea2e6847e7c18b09b11c4f9ffeac8c2103f8853602249eb71531a08dc35147339cde15125e3f3258e2d11520f57f3e727aedf33bd7cfeaca5536984e900e22632e1fe582163183ca9da4eca63c52b3decacb24fd96b0e83a05c35ebeb793bbd982d51d4eaaa4ad6395bbb20a358957d38e4b1a59cd49b2d3dd3f6f4ba58f961c40669cbd0eec10b094953e2858f8fa1feea0b704d1cea49761cccbdb29c2dda140cfe5154025978a8b9e950fbb082e6d7aeb18723143d3d7fd4a71c2f4a5a387fdc01042eef30146c8e8af9fa727878da6752ee581009cfb660b05e690e1713097264d1c522ddb950c7a6666642bb5adc53694f34ea6c8cc90abdf7316cbd4596b78baeb75db39b5565685ca4ef40a1ee6bdbe3385f47e0169b0f188a465b730dcc5185eafb3b2f80aa818312704cd68c234021dd3ff2854cba2c3c611c80a565e6bf1e21bf0cb9a39bfe5695bf62f048a613eb5b4bbae9aa489cd98b4fd98d1e19893d528164988276899919de5695ec20f253da92ceca99f1066a2a61f4608d00ac9850b0f6444ecd20fad6315805a720240fa8deb4da9da2690b8349140db4290450ce6f5849f1729182cebabc54354306f4190b208c66cc02dc1101fc59e5a8f555d2a86836ecbc2eae5ad285491cb021295ddbc12374a648fa545d6a42fe8135378872cf85a55b159bee8449702f685a9a288ab165de197ea1627416eeae1d9b7acabd0fd3447814506e5e5d3eae72145f082562c4d1f6a214425fae383c2f4aff89b97b3855d5aac89bf82f93e99ef84a9306a5867068b5b91600246881280b4e5647bd9653c08b693ffb94f720b5f873c5467237178936f2c35f84eae2e48829c54a4bca61b59d3c126bdf1eacb5023d4b504c5c9ae057090cb100784c54992f28d1cc47c98d68baf6b80d1d818347b6c316658c0ff95eea55ea87dd2e63a63c8288f216a5004addec7c0a95181564d9e4f4e6c4b1713883ee06dbb7096dc736b7b44e9c69a2845ed3ba0b0b042ade2ca72661a7b96db830437da4e7d270b1f3d4dd5729ab18cf9575bf1639fd7d49b6eb3b99e8caa92600b6b0357935cd2893a54ecbc3ae3481e784d85d14ca4db50547a4a1c62f3021d4a8bf276c9e8ce70b483cafb9bd61cd3a25ff13096592616898fbefb603513564d3ee7fc5ef2e742232273e203e74500ab843d9d6b39d32cd3b1c0af8ae95079c7fc8931eb867d49c4ca56f7763f8df50100012a2b1c214adc615c08df48378065f466e2d68a25e4e9b0b8cd6389be5122b7980f78a342c8d15889f05d658a32999d9980f283525ce3b35c2c962eec180bd295b74ad4d040402a419634707f82a4157c05ed6a3d5d3bc1f7d9baf309d789a5b89783ddbf8da3aa9c47bf42f140bf5843f070b22bae118dfda0bfbf74cd65ac35fb1bafa5e4ac6da2b60289b6dc3a94f8fb5654a6c5d81181aa8de79cb6d7caad4a150479cb74bc1a2ff033ca6221306592c4c77b1bcf31259f751fee13c7e0404f961844af7d90053d1a56ad8f942dfeb5fd04281507deb96e3f8d9cf2b7773ee8c5a16e4d0b79d20f68b9c6d55430d7b2aa359b319066b5986a44d23102728bcda88240d25beebb29ad7bfcb59f51b72ec24fb192d4c361f6fb540140b0576786122bd6441d27aa26d2479e280cdf027cd394584dca559144a8155d95d852c1694ffd8e987bebc122d060cb1ae9d9e666cf94ef170ca57739fa7b2c5ee4867b0e5378d200f7765e5b457244dad9ba2d1c4a7bea1a15d6c468838462e12a0bb360f7c9082c5f0f72c9fe9c5f49a67cb00b8add03a10e127ddab9b8f7184452cee3df135edac1c169085d1710c13a24b97b055ff63d1d5789585c45e8529f2d5a0dd61bf114659f815ee2f4774ec144d0838c4f4eeefa7005373c134252481e006bd52ac91a73163afb71bc17250edd2f96545d45f56accf12c484de9b84282a22c923f7b0c3b8dce72d68794311292e8a1c54620d9eb6cc1e1c7a99edc8b4d86d7c0efcdd20dc701fad98ff7037d86a18cf5967b70f4c8447057bb333b85724cd43226fcc0f9baa67884ec9556e0e001a3fa064edad716ad5e21ecf6a2d2035fbeb1484802b855541d92f59d5c2c8dfcc41c3238ad4e3a0ffba8f609a7563688b74e4342912d741cc1160a436e9ce233f6f8b60990bc58506e8dcd96cb042a0bc13108547f4d603d18ba0e5543a486aca51209462bf7be54aa92a11bfbb099adfd7b48814bd2d5ab6656af56e3222dd70a3ccb649818bed8d6d163aa27625dab347f2c5deb54a7f98b260e99fc51cb12096f3c1079e4c033f7c6f3da16377445dd0bae39e2056af416e69fc957473af320ced23c00a6d636d3b3ffcd8662e1f3168c73a5f25d482087a9a887f46cf38075bde381dad7358243a8037a8cf447d91936a010774ab48bf0a8f498b1beab5f11d2f20b7eb0b4880b41ef1682b58f5f1d193665f68455a86e884f568700a17ca58b304f044d7b7cbdeff7594d2df642223af256066f9229852a0c9e23fbb45e893707068c6260830cd488fa079fe3099c572ff91b9b4f351fa4de3ce3f3fe52651477a1ebd6300528916b520d20c85261b96d769fe493db3b583081c659cb7723781726cf7bdc7fc6a28e66dfaf83e0e4022914ea4c0ddb1c30810d4d4791dfb759a74faf02468bb10df08fe97481c3535b95f7d973e7e371e6d466ad622902b4e5203050bab3bdb0798d79d709c7ce973c45a836c881fb05df3f71848be4a4f9ed576ba3262f39cab3cbca54a5b6a1fcca043163e632c6172f89ae9344115119428f7cab1be136baf9d7754dc1954c9d04f01849e508f344f2af8cebba98bce694b780a9d7ac40e22e93c5cdf1d7322378cebdc05cc76b07797453dbf27162982ed11c1e602a69b27224909deccb5c765196941346d084c36a5539263f8f2d0a7edeb638779f0416dd705857c2b1b19181aa898f9df5fbc34d216066290b196feaec81524f8c1ca57ca1378a5ff31d15f1dbebcff4922f4cf67c515980309ced85e1ad76a53e84e2bbdd0a6f2050311f023c93740b9c6b022fd8818df41682a2631ade5c3abb97a4ea154e12765fb13fea5d292d3cf5bdcec01b0a55d6afaafe3a4a034810e593b17886eb8d25c8db615cdc141e186282df3eae02053ecfc11642b339b2d8931891c3221c6e6cfbc5006375848d2a927efc02357c2ea54b3a911b9cb7a39ab23ddd82961f031d3653aa30f15360c0282f88720699f022bc803593d6272eb7fcbbea7675bbe6764db4df901fb364e5a7e3dbfd26bce10f96ce90d69cebc24d35310b45f2715d033b3db91294531074f7000a68c706203bbe592323b1f9dd1435c53d930b25743c998b0438daaeb9fefcaeb64569ef5dbc46691c2126276a6f4235b0618d7a6829ecab5fd0d60e6cd893ded1f1f57646fa7ded00baf43d806312f2599f15d8902f15679edf12befe37966b81f051105279959e8b1f5a1de922d62bd67d97bbe62dbcf7faf8ea492b2a3c69ea914301f9449b6c303a792f6eeb088b2f9bf134df00f94618b9bcc75c803c254e2915c7c208d4c2ec2b08be521aa1bec7120b07511b3b70489ad1621533905015db09c0bbe731bd126c8f087da733b68904d0d2e590d15103a3b5ba0771352dea3867282b023737158a96b76c21cdadb776042e61aa549cd56ce02f667466d55b2021d6fc3deb71da01c77b02b9503911461d0e4a304cf9f97b71c6b4042bb876d316b7ccbbcad61377b101ff48ccda56763a99ce6cde2671c4b63ab496d81526a4dd26de3c6872ca78cf27b93fd5f358623132859c255f9a1fce248d035bd27a0af85f4e8f3daef9ccf70d1ee715a1fac5b5d4c7f0a596d07f6025a731d6cde48e19807639aa88677c7273a8a0ac2dcb0e1a7eff74480f78fc35d9de680a88d66392810b716057ffd7593dc43fed2117b08aee00033971a4358aa4da8b32c60563f84965d348688e2d9cead7819329b28bc6b32efba63e1974b7cc8b7402c49a396d7a664db7c6f02668aa26c0b4aa4bc9ce4449b33534e180fbd90114c22dc2652e7ba15fb7315dcfd350a82311c6ac7158f01bb0d86b10e4c60aae5737176104a25be3bac94a9bbde68ee259edef6d861a8b9e8d39291cd9500493aae44cfa8dc25200c84fd9b0586479e1ee5260ce5cba3c2fbe009c4a357e5f19a85a026878b7af6e8e366a71bbbe9a4c9aab0f3fa2c8ff1fafb55fae8e86d1252df8cb85a1decc650d3f948d8fe8ae25ebf1b3c59a332c0ea16445f920bf4688910b3edfc311e62488a0b39836685f7ebbc951e9372bb4418aaa8a5f097657cd4c080b526015350bae36c1430d9a431880b6a4b6cd20e00681228af070d9da90e7bd091387f7dc83c0b5a45089c8b41d0bb9545bdde3e4e14d4000d57d9123478a4b264b685e27d4978af8f5f6006b39a0636e26185fb6869d93628db0cebf2e0777f4420e897cf1ad7850bc0cd01e15efe6a3d75583eb4ca451dc547f07f3d1f97a9aa02a8a7e5abd4a2365e433beb2fd03bb0ec45bf598d605c22943fd897a8c4c3df9f49949becbf7430aa3b225ab2f00506fd993c242f8478df0ab872579fecb8278bf5a3917bec466bfcf5459910afc182ceaf3d75b243136c4831a6e48aee2c03a84ff064782c4b6fc176a7a634621a9eb61883fcfc110ce1f522dae582298844d20a3a5ad918cc9b5317aa130fe2a0716cf7cb714430632265fbd82fc095dee5ad76f1e406cd0064bd920e148deb7ccc0f1417c1e5c6725abe066077f33f9eb0d12947e7abccb62134ef07b6d55abdc8a8dd83a7f8255db4d840e59b2fc5765d423603c0d1eca52dd9eac41573fb63ce4d14d6ffc7bbe885efaaf19a2d0d45009249ea9dfe062d6fda1e561acab5e6f93677c857c1b377322424978ab71a014b4f0f371aea99ad06cbda7f85e2defce4e5558a39526bfab60b9e2b3c12814b824b037de5d78bba991aa208b4ac40969b948ee6d5fce1ded99bb13498198ea4cc5ef63414362f969366254f9903478c551d13e8b865306e1b251e34d3e446705dcd5dff95a424cd8d77b61ff0c4c9abee4711e7232d962adb0e8a1ba689b4fae30aed01eac2d94cc2b2dffcce3d04e60733c950161647d1397d1f7e1e95ca81fa7e3b172ea5fd0eb826f1697f39b9d8ec4c156ace2c2dcda4c17d4a04de249d5e77a3ead0f53d0d1832ca971676599873d3f020f4cb3ba4fd0f3e2183628623a05e26a54ab17f3e222f843223d3e02cc63aa950c534721c19670772c4b2f36dce9bb3fb695d517dbb5630ebd172d1039a14bae3a33eb4ac6a68fe9325e8b4b060b1762b2f97477c011727cbd62ad9ffab9677dc215d6788b523d568e0d62264723a8e0ba11834d3863ca193af4976f7dedea85069b29c7f840134a17c5857aa24d54aef1bea5c5de5a4275d98a95bdd0576032613ccda485929a95787c1d93ff666df34650c500f0c1f81faef49e7b83b2ec06c24e1de30329f602b856321134c56c15f53e7e420cc49e09fc7b0fe69b5e8cebe7d1af4bab903d08cbc0af69af775089e0dea09d7d16899ce4ef6b0463e5a8e9d89e7e0aad8558ab201369ba6eaa4931d078da4187a10cfb8992c25c9a3a6585b29f86e8eea8b616a143287e3a64bc5dfbe42932a10ec535205493a70eb8b56d4953c6ce2745920959ec0af48de5fbb9c17fff6cb98ed61cf1f63b1d2e3fe59a9f57cd0cb6260956ee15ff15ace7fbf099b2ebb1a215bc439166fba19faf40225d9546071db5468910924916048ac6698aa1e93560fc2b0dacb8eb6956aa36eeeb7be298bdccd0847b03c6abfd4c51ed88b44580e3cad35c9277cbae8c8017d029ad50e7eb2e31620b82aba4bdcbe976546d506deaa9042b71c93ce224f5f66567696f13405d08d25d898c0978256e8c7f26d04456f7fe40b479ab19a694e41390075ec49442f44214f4210ae215af394ec660429b59577a4eb0f35cc2ee688a48b930686d46ee0b0cc2b0cd3edc65f12d3e6e5efb650d904afb23f6058fda0f29536786b676a770e571af86e6097361228eb67b0235fb561a3f73767506b80636194f667f64ccf5836fbb4b6192713d31c2d7bc92e557f06de3f7516b89458f48711579a02786e053b44b03dcc295cd190b4335fd979e2bb18e2d31a9f78384304ccb308628fbe0316c65b9a5af9d0442e9f9e23fe4249907363e2c54fd4a617a8f72b1bcb8a617d04a84d027a6b4ceeb61f2165c2bc7b03fae383582edfe118ea60ff4132b2419b2d35d168c4a05463f2ea4b00e7b4df7c9fcae11af99d772a766fadfe275e9bf310f4063f5b23dc0d3f931ac0e067f4f9b79a18f269f9b9e166bd806a06dc028b95cec39bb6cad434d4f4eb6934c0f6c82498ea10316fabcf4d06c0cb2d9682462720df6d082c97a413acdecf9145002a4716b0617ca9d37f8526756d9660237f61fad8184163cf30c184ad26ea93a5d0692734b558a2296258da9852d7a13f0d38694bc47fc90cc55c012fdff24b7852e3ee73513244128a5d793492e9b15f494387f9b22419d0b6d2d506a743835e46a75a6250db2beeca5586ee302fdbf6f8bc68cbbedf65036ff8948bf4ad1a3d41b833fcbd77d120d4f6c8670f56f65c512f8dedc1964a981d0f3f21645cda14e9564edcb5569bd0de42426d2030bc0cc8533bffe28cc11ef747cedd170b236c0ddd10f5eb279eff33d317b19f17525cd70e6878071a243668e091d5c093bb7f3d7e6d0da9941e133a6f008e6d1b95b334280805ec15e7f3af94c4b3859a074c291f268c3373e64b900e58e855ec640b45fac4b1d5f5c2212ae65b7bbba043c72a064198f0af74da9f62a4931e6896b565da0b74dd41d79cac10258dd680b7964acd0d9652a0be2d87429c950290e6ced6b0a0a878ef08311521a2e6f23551559230eb270fa82e4cfcf916a3b4d5f6fedd112c149ba27f417deee5d7103eaec03266ea6f79a31faa0c3f114200591f2ff0b28b3308170893330ff96e48773a89f631784c2cbf0a98d1a793d449505e8d6d86b2e1fd4b7a7078d6e2186ab8d15c3867be8088eb128db89f05b34f4338f9bd3db1db174d09b0e7e183f40292bb3b1dc3a292bc321b416c91c0c206c20b929b847b1be9d370446a67ad6bc5c970eab5434847a35372d8549ab60b6e4242799203a3d5408f10288d2b3669a08802f18545d07bc1ebaf650ff1eaafe31356496783a5487a91882ebd515b9f3a742d24affdb2ed90329510c2b1c938979c6c2442443eead1a875ab604ae919ed0420eaa3ca68895eb8acfc96f2b30fddfd420faa984af0c0e458de7f6096a118ca3db5452170ff9ce4b08fe13c1eb2559f75cf5ca8e53df7df78f193d5e0d46982165bcc03d2020ae5fc2bdd7d1a9d17d06a08f1e4855dc87ad7b5cc0dd7a7669807fbc968675862b3418e4f8dbd5d9ceea18d290d5aafc20dd7cc30b40432e6e3a28166414c5661ef68e66cfd51f68a4b3f5de229b76b5611e5cd0331c4696b1fc71d6bcb938b4219007487658d78816e217536188f3</script>
</div>
<script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
  </entry>
  <entry>
    <title>Python3网络爬虫开发实战-爬取今日头条街拍</title>
    <url>/2022/04/14/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-%E7%88%AC%E5%8F%96%E4%BB%8A%E6%97%A5%E5%A4%B4%E6%9D%A1%E8%A1%97%E6%8B%8D/</url>
    <content><![CDATA[<h5 id="6-4-爬取今日头条街拍美图"><a href="#6-4-爬取今日头条街拍美图" class="headerlink" title="6.4 爬取今日头条街拍美图"></a>6.4 爬取今日头条街拍美图</h5><h6 id="抓取分析"><a href="#抓取分析" class="headerlink" title="抓取分析"></a>抓取分析</h6><p>打开今日头条首页 <a href="http://www.toutiao.com/">http://www.toutiao.com/</a>  搜索街拍</p>
<p>打开开发者工具，查看所有的网络请求，发现页面返回数据不是由 Ajax 加载的，是 HTML 类型，请求链接 </p>
<p><code>https://so.toutiao.com/search?dvpf=pc&amp;source=input&amp;keyword=街拍&amp;page_num=0&amp;pd=synthesis</code></p>
<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-%E7%88%AC%E5%8F%96%E4%BB%8A%E6%97%A5%E5%A4%B4%E6%9D%A1%E8%A1%97%E6%8B%8D/WeChat49f883417f3f8bd97ec5880e80066787.png" alt="WeChat49f883417f3f8bd97ec5880e80066787"></p>
<p>现在页面上显示有街拍-视频，街拍-图片，街拍讨论，其余显示的可以按分组显示，每组有标题和一些图片</p>
<p>现在需要抓取的就是分组标题和分组下的图片</p>
<p>先获取每页列表数据</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_page</span>(<span class="params">page_num</span>):</span></span><br><span class="line">  <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  获取每页列表数据</span></span><br><span class="line"><span class="string">  :return: 列表html数据</span></span><br><span class="line"><span class="string">  &#x27;&#x27;&#x27;</span></span><br><span class="line">  params = &#123;</span><br><span class="line">      <span class="string">&#x27;source&#x27;</span>: <span class="string">&#x27;input&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;dvpf&#x27;</span>: <span class="string">&#x27;pc&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;keyword&#x27;</span>: <span class="string">&#x27;街拍&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;page_num&#x27;</span>: page_num,</span><br><span class="line">      <span class="string">&#x27;pd&#x27;</span>: <span class="string">&#x27;synthesis&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">  url = <span class="string">&#x27;https://so.toutiao.com/search?&#x27;</span> + urlencode(params)</span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">      r = requests.get(url, headers=headers)</span><br><span class="line">      <span class="keyword">if</span> r.status_code == <span class="number">200</span>:</span><br><span class="line">          <span class="keyword">return</span> r.text</span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">          print(<span class="string">&#x27;request get_page error&#x27;</span>)</span><br><span class="line">  <span class="keyword">except</span> requests.ConnectionError:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<p>接着从返回的 html 提取列表文章链接，通过正则提取</p>
<p>网站点击查看每条文章的链接是这种的</p>
<p> <a href="https://www.toutiao.com/article/7031340137846030856/?channel=&amp;source=search_tab">https://www.toutiao.com/article/7031340137846030856/?channel=&amp;source=search_tab</a></p>
<p>查看列表返回的 html 并没有找到完整的文章链接，需要自己拼接</p>
<p>正则提取列表 group_id，拼成完整文章链接</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_page</span>(<span class="params">html</span>):</span></span><br><span class="line">  <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  通过正则提取一页列表数据</span></span><br><span class="line"><span class="string">  &#x27;&#x27;&#x27;</span></span><br><span class="line">  pattern = re.<span class="built_in">compile</span>(<span class="string">&#x27;&lt;script type=application/json.*?(&#123;&quot;data&quot;:.*?&#125;&#125;&#125;)&lt;/script&gt;&#x27;</span>, re.S)</span><br><span class="line"></span><br><span class="line">  results = re.findall(pattern, html)</span><br><span class="line">  <span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">      listItem = &#123;&#125;</span><br><span class="line">      <span class="built_in">dict</span> = json.loads(result)</span><br><span class="line">      group_id = <span class="built_in">dict</span>.get(<span class="string">&#x27;data&#x27;</span>).get(<span class="string">&#x27;group_id&#x27;</span>)</span><br><span class="line">      title = <span class="built_in">dict</span>.get(<span class="string">&#x27;data&#x27;</span>).get(<span class="string">&#x27;title&#x27;</span>)</span><br><span class="line">      <span class="keyword">if</span> group_id != <span class="literal">None</span> <span class="keyword">and</span> title != <span class="literal">None</span>:</span><br><span class="line">          listItem[<span class="string">&#x27;title&#x27;</span>] = title</span><br><span class="line">          listItem[<span class="string">&#x27;group_id&#x27;</span>] = group_id</span><br><span class="line">          <span class="keyword">yield</span> listItem <span class="comment">#返回生成器</span></span><br></pre></td></tr></table></figure>

<p>进入文章获取响应页面</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_article</span>(<span class="params">group_id</span>):</span></span><br><span class="line">  <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  获取文章html</span></span><br><span class="line"><span class="string">  :return: 文章html</span></span><br><span class="line"><span class="string">  &#x27;&#x27;&#x27;</span></span><br><span class="line">  params = &#123;</span><br><span class="line">      <span class="string">&#x27;channel&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;source&#x27;</span>: <span class="string">&#x27;search_tab&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">  url = <span class="string">&#x27;https://www.toutiao.com/article/&#x27;</span> + group_id</span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">      r = requests.get(url=url, params=params, headers=headers)</span><br><span class="line">      <span class="keyword">if</span> r.status_code == <span class="number">200</span>:</span><br><span class="line">          <span class="keyword">return</span> r.text</span><br><span class="line">  <span class="keyword">except</span> requests.ConnectionError <span class="keyword">as</span> e:</span><br><span class="line">      print(<span class="string">&#x27;Error:&#x27;</span>, e.args)</span><br></pre></td></tr></table></figure>

<p>解析文章页面，提取需要保存的图片链接</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_article</span>(<span class="params">html</span>):</span></span><br><span class="line">  <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  提取图片数据</span></span><br><span class="line"><span class="string">  :return: 返回图片列表</span></span><br><span class="line"><span class="string">  &#x27;&#x27;&#x27;</span></span><br><span class="line">  pattern = re.<span class="built_in">compile</span>(<span class="string">&#x27;&lt;div class=&quot;pgc-img&quot;&gt;.*?src=&quot;(.*?)&quot;.*?alt=&quot;(.*?)&quot;&#x27;</span>, re.S)</span><br><span class="line">  results = re.findall(pattern, html)</span><br><span class="line">  images = []</span><br><span class="line">  <span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">      image = &#123;&#125;</span><br><span class="line">      image[<span class="string">&#x27;url&#x27;</span>] = result[<span class="number">0</span>]</span><br><span class="line">      image[<span class="string">&#x27;title&#x27;</span>] = result[<span class="number">1</span>]</span><br><span class="line">      images.append(image)</span><br><span class="line">  <span class="keyword">return</span> images</span><br></pre></td></tr></table></figure>

<p>保存图片</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_image</span>(<span class="params">image</span>):</span></span><br><span class="line">  <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  保存图片</span></span><br><span class="line"><span class="string">  :param image: 图片对象&#123;title:xx,url:xx&#125;</span></span><br><span class="line"><span class="string">  &#x27;&#x27;&#x27;</span></span><br><span class="line">  image_path = <span class="string">&#x27;img&#x27;</span> + os.path.sep + image.get(<span class="string">&#x27;title&#x27;</span>)</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(image_path):</span><br><span class="line">      os.makedirs(image_path) <span class="comment"># 生成目录文件夹</span></span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">      resp = requests.get(image.get(<span class="string">&#x27;url&#x27;</span>))</span><br><span class="line">      <span class="keyword">if</span> resp.status_code == <span class="number">200</span>:</span><br><span class="line">          file_path = image_path + os.path.sep + <span class="string">&#x27;&#123;file_name&#125;.&#123;file_suffix&#125;&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">              file_name=md5(resp.content).hexdigest(), <span class="comment">#使用图片md5值作为图片名</span></span><br><span class="line">              file_suffix=<span class="string">&#x27;jpg&#x27;</span></span><br><span class="line">          )</span><br><span class="line">          <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(file_path):</span><br><span class="line">              <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                  f.write(resp.content)</span><br><span class="line">              print(<span class="string">&#x27;Downloaded image path is %s&#x27;</span> % file_path)</span><br><span class="line">          <span class="keyword">else</span>:</span><br><span class="line">              print(<span class="string">&#x27;Already Downloaded&#x27;</span>, file_path)</span><br><span class="line">  <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">      print(e, <span class="string">&#x27;none123&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>根据 image 的 title 来创建文件夹，然后请求图片链接，获取图片的二进制数据，以二进制形式写入文件，图片的名称可以使用其内容的MD5值，这样可以去除重复</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlencode</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;Cookie&#x27;</span>: <span class="string">&#x27;msToken=fftEubI251GAmJDZSNTUKj927FcCDPj7RE_XHLi_NMtm-cHnBx-iBxBVo4mygLcZI-dEjePff5pZeXl4c7mLta0KX2SDDPiTEslhfNOw0iNz; ttwid=1|xqpvNtm5D6xFmuFjl3WTtk_jkA4ybMYfqHLzIzKmi2Y|1649864470|16944aed776db4b21fa0d03d6e09c237023b5fc301a3df68c81d5ef03b17c355;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.75 Safari/537.36&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  list_html = get_page(<span class="number">0</span>)  <span class="comment"># 获取列表html</span></span><br><span class="line">  list_items = parse_page(list_html)  <span class="comment"># 获取文章列表</span></span><br><span class="line">  <span class="keyword">for</span> list_item <span class="keyword">in</span> list_items:</span><br><span class="line">      print(list_item)</span><br><span class="line">      article_html = get_article(list_item.get(<span class="string">&#x27;group_id&#x27;</span>))  <span class="comment"># 文章html</span></span><br><span class="line">      images = parse_article(article_html)  <span class="comment"># 提取图片数据</span></span><br><span class="line">      <span class="keyword">for</span> image <span class="keyword">in</span> images:</span><br><span class="line">          save_image(image)</span><br></pre></td></tr></table></figure>



<p>书上还有多线程下载，作者最新代码给去掉了：不用Pool多进程是因为目前还没有办法实现跨进程共享Cookies</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#利用多线程的线程池，调用其 map() 方法实现多线程下载</span></span><br><span class="line"><span class="keyword">from</span> multiprocessing.pool <span class="keyword">import</span> Pool</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">offset</span>):</span></span><br><span class="line">  print(<span class="string">&quot;xx&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  pool = Pool()</span><br><span class="line">  GROUP_START = <span class="number">1</span></span><br><span class="line">  GROUP_END = <span class="number">20</span></span><br><span class="line">  groups = ([x * <span class="number">20</span> <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(GROUP_START, GROUP_END + <span class="number">1</span>)])</span><br><span class="line">  pool.<span class="built_in">map</span>(main,groups)</span><br><span class="line">  pool.close()</span><br><span class="line">  pool.join()</span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Airtest</title>
    <url>/2022/04/28/Airtest/</url>
    <content><![CDATA[<p><a href="https://airtest.netease.com/changelog.html">AirtestIDE 下载</a> </p>
<p><a href="https://airtest.doc.io.netease.com/tutorial/1_quick_start_guide/">官网Airetest Project Docs</a></p>
<p>AiretestIDE 一个跨平台的UI自动化测试编辑器，适用游戏和APP</p>
<p>自动化录制脚本、一键回放、报告查看；支持基于图像识别的 Airtest 框架；支持基于UI控件搜索的Poco框架</p>
<h4 id="连接设备"><a href="#连接设备" class="headerlink" title="连接设备"></a>连接设备</h4><ul>
<li>连接 iOS 手机</li>
</ul>
<p>手机通用-开发者-Enable UI Automation 需要开启</p>
<p>需要安装 Xcode 的 Mac 电脑</p>
<p><a href="https://github.com/AirtestProject/IOS-Tagent">iOS-Tagent</a> 基于 facebook 的 WebDriverAgent 项目上进行开发的</p>
<p>可以使用 Appium 的 WebDriverAgent 工具来部署iOS真机，也可使用 Airtest 下的 iOS-Tagent 工具来部署真机</p>
<p>Appium 的 WebDriverAgent 工具安装 <a href="https://testerhome.com/topics/7220">https://testerhome.com/topics/7220</a></p>
<p>Facebook 的 WebDriverAgent 工具安装 <a href="https://testerhome.com/topics/10463">https://testerhome.com/topics/10463</a></p>
<p>下载  iOS-Tagent 项目</p>
<p>Scheme-&gt;WebDriverAgentRunner-&gt;选择设备</p>
<p>product -&gt; Test 报错 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Building for iOS, but the embedded framework &#39;CocoaAsyncSocket.framework&#39; was built for iOS + iOS Simulator.</span><br><span class="line">Building for iOS, but the linked and embedded framework &#39;WebDriverAgentLib.framework&#39; was built for iOS + iOS Simulator.</span><br></pre></td></tr></table></figure>

<p>解决：选择 WebDriverAgentRunner Target -&gt; Build Setting -&gt; Build Options -&gt; Validate Workspace 设置为 YES</p>
<p>需要 libimobiledevice</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">brew install libimobiledevice</span><br><span class="line">#端口转发 第一个是mac端口 第二个是iPhone端口</span><br><span class="line">#会将iPhone上8100的数据转发到mac的8100端口上</span><br><span class="line">iproxy 8100 8100</span><br></pre></td></tr></table></figure>

<p>访问地址 <a href="http://127.0.0.1:8100/status">http://127.0.0.1:8100/status</a> 可以看到返回的设备信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;value&quot; : &#123;</span><br><span class="line">    &quot;state&quot; : &quot;success&quot;,</span><br><span class="line">    &quot;os&quot; : &#123;</span><br><span class="line">      &quot;name&quot; : &quot;iOS&quot;,</span><br><span class="line">      &quot;version&quot; : &quot;13.1.3&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;ios&quot; : &#123;</span><br><span class="line">      &quot;simulatorVersion&quot; : &quot;13.1.3&quot;,</span><br><span class="line">      &quot;ip&quot; : &quot;10.1.253.216&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;build&quot; : &#123;</span><br><span class="line">      &quot;time&quot; : &quot;Dec 22 2020 14:54:08&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sessionId&quot; : null,</span><br><span class="line">  &quot;status&quot; : 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问 <a href="http://127.0.0.1:8100/inspector">http://127.0.0.1:8100/inspector</a> 可以看设备界面，但是报错了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;value&quot; : &#123;</span><br><span class="line">    &quot;error&quot; : &quot;unknown command&quot;,</span><br><span class="line">    &quot;message&quot; : &quot;Unhandled endpoint: \&#x2F;inspector -- http:\&#x2F;\&#x2F;127.0.0.1:8100\&#x2F; with parameters &#123;\n wildcards &#x3D; (\ninspector\n);\n&#125;&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sessionId&quot; : null,</span><br><span class="line">  &quot;status&quot; : 6</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打开 AirtestIDE，连接 <a href="http://127.0.0.1:8100/">http://127.0.0.1:8100</a> 连接不上</p>
<p>Xcode控制台报错</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-[XCUIScreen screenshotDataForQuality:rect:error:]: unrecognized selector sent to instance 0x28070ffc0</span><br></pre></td></tr></table></figure>

<p>重新下载xcode项目 <a href="https://pan.baidu.com/s/1FCZ-FPQSqYmiGc5QjdjUew">https://pan.baidu.com/s/1FCZ-FPQSqYmiGc5QjdjUew</a>  nk77 可以连接上</p>
<p>左上角 + 号，新建一个 Airtest Project</p>
<img src="Airtest/WeChat74e3de483b997363ebd9b50d174b58cc.png" alt="WeChat74e3de483b997363ebd9b50d174b58cc" style="zoom:67%;" /> 

<p>自动生成初始化代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># -*- encoding&#x3D;utf8 -*-</span><br><span class="line">__author__ &#x3D; &quot;midland_whk&quot;</span><br><span class="line">from airtest.core.api import *</span><br><span class="line">auto_setup(__file__)</span><br></pre></td></tr></table></figure>

<p>辅助窗中点击 touch，这时可以在右侧设备界面拖动框柱想要点击的区域，会自动生成一行点击代码</p>
]]></content>
  </entry>
  <entry>
    <title>Python3网络爬虫开发实战-6异步爬虫</title>
    <url>/2022/05/06/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-6%E5%BC%82%E6%AD%A5%E7%88%AC%E8%99%AB/</url>
    <content><![CDATA[<ul>
<li>event_loop：事件循环，相当于一个无限循环，可以把一些函数注册到这个事件循环上，当满足发生条件的时候，就调用对应的处理方法</li>
<li>coroutine：协程，可以将协程对象注册到事件循环中，它会被事件循环调用。可以使用 async 关键字来定义一个方法，这个方法在调用时不会立即被执行，而是会返回一个协程对象</li>
<li>task：任务，这是对协程对象的进一步封装，包含协程对象的各个状态</li>
<li>future：代表将来执行或者没有执行的任务的结果，实际上和 task 没有本质的区别</li>
</ul>
<h4 id="定义协程"><a href="#定义协程" class="headerlink" title="定义协程"></a>定义协程</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">execute</span>(<span class="params">x</span>):</span></span><br><span class="line">    print(<span class="string">&#x27;Number&#x27;</span>, x)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    print(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    coroutine = execute(<span class="number">1</span>) <span class="comment">#方法没有立即执行，返回协程对象</span></span><br><span class="line">    print(<span class="string">&#x27;After calling execute&#x27;</span>)</span><br><span class="line">    loop = asyncio.get_event_loop() <span class="comment">#创建事件循环</span></span><br><span class="line">    loop.run_until_complete(coroutine)<span class="comment">#将协程对象注册到事件循环</span></span><br><span class="line">    print(<span class="string">&#x27;After calling loop&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">After calling execute</span></span><br><span class="line"><span class="string">Number 1</span></span><br><span class="line"><span class="string">After calling loop</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>引入 asyncio 包，这样才能使用 async 和 await 关键字</p>
<p>直接调用 execute 方法并没有立即执行，而是返回一个协程对象</p>
<p>之后调用 get_event_loop 方法创建一个事件循环 loop，调用 loop 对象的 run_until_complete 方法将协程对象注册到事件循环中，接着启动</p>
<p>async 定义的方法会变成一个无法直接执行的协程对象，必须将此对象注册到事件循环中才可以执行</p>
<p>前面提到 task 是对协程的进一步封装，比协程多了运行状态，如 running、finished，可以利用这些状态获取协程执行情况</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">coroutine = execute(<span class="number">1</span>)</span><br><span class="line">print(<span class="string">&#x27;After calling execute&#x27;</span>)</span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">task = loop.create_task(coroutine) <span class="comment">#将协程对象转化为task对象！</span></span><br><span class="line">print(<span class="string">&#x27;Task:&#x27;</span>, task)</span><br><span class="line">loop.run_until_complete(task)</span><br><span class="line">print(<span class="string">&#x27;Task:&#x27;</span>, task)</span><br><span class="line">print(<span class="string">&#x27;After calling loop&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">After calling execute</span></span><br><span class="line"><span class="string">Task: &lt;Task pending name=&#x27;Task-1&#x27; coro=&lt;execute() running at xxx&gt;&gt;</span></span><br><span class="line"><span class="string">Number 1</span></span><br><span class="line"><span class="string">Task: &lt;Task finished name=&#x27;Task-1&#x27; coro=&lt;execute() done, defined at xxx&gt;</span></span><br><span class="line"><span class="string">After calling loop</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>定义 task 的另一种方式，直接调用 asyncio 包的 ensure_future 方法，返回也是 task 对象</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">task = asyncio.ensure_future(coroutine)</span><br><span class="line">loop.run_until_complete(task)</span><br></pre></td></tr></table></figure>

<h4 id="绑定回调"><a href="#绑定回调" class="headerlink" title="绑定回调"></a>绑定回调</h4><p>为某个 task 对象绑定一个回调方法    </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">request</span>():</span></span><br><span class="line">    url = <span class="string">&#x27;https://www.baidu.com&#x27;</span></span><br><span class="line">    status = requests.get(url)</span><br><span class="line">    <span class="keyword">return</span> status</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">callback</span>(<span class="params">task</span>):</span></span><br><span class="line">    print(<span class="string">&#x27;Status:&#x27;</span>, task.result())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    print(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    coroutine = request()</span><br><span class="line">    task = asyncio.ensure_future(coroutine)<span class="comment">#定义task</span></span><br><span class="line">    task.add_done_callback(callback) <span class="comment">#回调方法</span></span><br><span class="line">    print(<span class="string">&#x27;Task:&#x27;</span>, task)</span><br><span class="line"></span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    loop.run_until_complete(task)<span class="comment">#注册到事件循环才能执行</span></span><br><span class="line">    print(<span class="string">&#x27;Task:&#x27;</span>, task)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Task: &lt;Task pending name=&#x27;Task-1&#x27; coro=&lt;request() running at xxx cb=[callback() xx&gt;</span></span><br><span class="line"><span class="string">Status: &lt;Response [200]&gt;</span></span><br><span class="line"><span class="string">Task: &lt;Task finished name=&#x27;Task-1&#x27; coro=&lt;request() done, defined at xx result=&lt;Response [200]&gt;&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>task 执行完毕后，就可以调用 callback 方法了，同时 task 对象还会作为参数传递给 callback 方法，调用 task 对象的 result 方法就可以获取返回结果</p>
<p>这里不使用回调方法，在 task 运行完毕后，也可直接调用 task.result() 方法获取结果</p>
<h4 id="多任务协程"><a href="#多任务协程" class="headerlink" title="多任务协程"></a>多任务协程</h4><p>如果想执行多次请求，使用 asyncio 包中的 wait 方法执行</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tasks = [asyncio.ensure_future(request()) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)]</span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">loop.run_until_complete(asyncio.wait(tasks))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> task <span class="keyword">in</span> tasks:</span><br><span class="line">    print(<span class="string">&#x27;Task Result:&#x27;</span>, task.result())</span><br><span class="line"><span class="comment">#5个任务被顺次执行</span></span><br></pre></td></tr></table></figure>

<p>这里 for 循环创建 5 个 task，组成一个列表，列表先传给 asyncio 包的 wait 方法，再将其注册到事件循环，就可以发起 5 哥任务了</p>
<h4 id="协程实现"><a href="#协程实现" class="headerlink" title="协程实现"></a>协程实现</h4><p>当遇到需要等待的情况时，程序可以暂时挂起，转而执行其他操作，从而避免因一直等待一个程序而耗费过多的时间，能够充分利用资源</p>
<p>要实现异步处理，先得有挂起操作，当一个任务需要等待 IO 结果的时候，可以挂起当前任务，转而执行其它任务</p>
<ul>
<li>await 关键字</li>
</ul>
<p>可以将耗时等待的操作挂起，让出控制权。如果协程在执行的时候遇到 await，事件循环就会将协程挂起，转而执行别的协程，直到其它协程挂起或执行完毕</p>
<ul>
<li>await 后面的对象必须是如下格式之一：</li>
</ul>
<p>一个原生的协程对象；</p>
<p>一个由 types.coroutine修饰的生成器，这个生成器可以返回协程对象；</p>
<p>一个包含 <code>__await__</code> 方法的对象返回一个迭代器</p>
<h4 id="使用-aiohttp"><a href="#使用-aiohttp" class="headerlink" title="使用 aiohttp"></a>使用 aiohttp</h4><p>aiohttp 是一个支持异步请求的库，和 asyncio 配合使用，可以非常方便的实现异步请求操作</p>
<p>官方文档链接 <a href="https://aiohttp.readthedocs.io/">https://aiohttp.readthedocs.io/</a> </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">url</span>):</span></span><br><span class="line">    session = aiohttp.ClientSession()</span><br><span class="line">    response = <span class="keyword">await</span> session.get(url)</span><br><span class="line">    <span class="keyword">await</span> response.text()</span><br><span class="line">    <span class="keyword">await</span> session.close()</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">request</span>():</span></span><br><span class="line">    url = <span class="string">&#x27;https://www.baidu.com&#x27;</span></span><br><span class="line">    print(<span class="string">&#x27;waiting for&#x27;</span>, url)</span><br><span class="line">    response = <span class="keyword">await</span> get(url)</span><br><span class="line">    print(<span class="string">&#x27;get response from&#x27;</span>, url, <span class="string">&#x27;response:&#x27;</span>, response)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  tasks = [asyncio.ensure_future(request()) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)]</span><br><span class="line">  loop = asyncio.get_event_loop()</span><br><span class="line">  loop.run_until_complete(asyncio.wait(tasks))</span><br></pre></td></tr></table></figure>

<p>当遇到阻塞式操作（await）时，task 被挂起，事件循环会寻找当前未被挂起的协程继续执行，到第10个task，全部 task 都被挂起了，只好等待，请求5秒后几个请求几乎同时有了响应，然后几个 task 也被唤醒接着执行，并输出结果</p>
<h4 id="aiohttp-的使用"><a href="#aiohttp-的使用" class="headerlink" title="aiohttp 的使用"></a>aiohttp 的使用</h4><p>aiohttp 官方文档 <a href="https://docs.aiohtto.org/">https://docs.aiohtto.org</a></p>
<p>aiohttp 是一个基于 asyncio 的异步 HTTP 网络模块，既提供了服务端，又提供了客户端。用服务端可以搭建一个支持异步处理的服务器，这个服务器就是用来处理请求并返回响应的，类似 Django、Flask、Tornado 等一些 Web 服务器。而客户端可以用来发起请求</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"></span><br><span class="line"><span class="comment">#每个异步方法前都需要加 async 来修饰</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">fetch</span>(<span class="params">session, url</span>):</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> response:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> response.text(), response.status</span><br><span class="line"><span class="comment">#response.text()返回协程需要加await</span></span><br><span class="line">      </span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        html, status = <span class="keyword">await</span> fetch(session, <span class="string">&#x27;https://cuiqingcai.com&#x27;</span>)</span><br><span class="line">        print(<span class="string">f&#x27;html:<span class="subst">&#123;html[:<span class="number">100</span>]&#125;</span>...&#x27;</span>)</span><br><span class="line">        print(<span class="string">f&#x27;status: <span class="subst">&#123;status&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    loop.run_until_complete(main())</span><br></pre></td></tr></table></figure>

<p>with as 前同样需要 async 来修饰，python 中，with as 语句用于声明一个上下文管理器，能够帮我们自动分配和释放资源，<u>异步方法中，with as 前加 async 代表声明一个支持异步的上下文管理器</u></p>
<p>对于一些返回协程的操作，前面需要加 await 来修饰。返回的是协程对象，前面就要加 await，response 调用 text 方法返回的是协程对象，前面需要加 awiat，而状态码返回的就是一个数值，不需要加 await，看对应返回类型决定加不加 await</p>
<p>Python 3.7 后可以使用 <code>asyncio.run(main())</code> 代替最后的启动操作，不需要显式声明事件循环</p>
<h5 id="URL-参数设置"><a href="#URL-参数设置" class="headerlink" title="URL 参数设置"></a>URL 参数设置</h5><p>参数设置借助 params 参数，传入字典</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    params = &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;germey&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">25</span>&#125;</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> session.get(<span class="string">&#x27;https://www.httpbin.org/get&#x27;</span>, params=params) <span class="keyword">as</span> response:</span><br><span class="line">            print(<span class="keyword">await</span> response.text())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    asyncio.get_event_loop().run_until_complete(main())</span><br></pre></td></tr></table></figure>

<h5 id="其它请求类型"><a href="#其它请求类型" class="headerlink" title="其它请求类型"></a>其它请求类型</h5><p>aiohttp 还支持其它请求类型，POST、PUT、DELETE 等</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">session.post(<span class="string">&#x27;http://xxx&#x27;</span>, data=<span class="string">b&#x27;data&#x27;</span>)</span><br><span class="line">session.put(<span class="string">&#x27;http://xxx&#x27;</span>)</span><br><span class="line">session.delete(<span class="string">&#x27;http://xxx&#x27;</span>)</span><br><span class="line">session.options(<span class="string">&#x27;http://xxx&#x27;</span>)</span><br><span class="line">session.head(<span class="string">&#x27;http://xxx&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="POST-请求"><a href="#POST-请求" class="headerlink" title="POST 请求"></a>POST 请求</h5><p>对于 POST 表单提交 Content-Type 为 application/x-www-form-urlencoded</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">data = &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;germey&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">25</span>&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">with</span> session.post(<span class="string">&#x27;https://www.httpbin.org/post&#x27;</span>, data=data) <span class="keyword">as</span> response:</span><br></pre></td></tr></table></figure>

<p>对于 POST JSON，Content-Type 为 application/json</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">data = &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;germey&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">25</span>&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">with</span> session.post(<span class="string">&#x27;https://www.httpbin.org/post&#x27;</span>, json=data) <span class="keyword">as</span> response:</span><br></pre></td></tr></table></figure>

<h5 id="响应"><a href="#响应" class="headerlink" title="响应"></a>响应</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(<span class="string">&#x27;status:&#x27;</span>, response.status)</span><br><span class="line">print(<span class="string">&#x27;headers:&#x27;</span>, response.headers)</span><br><span class="line">print(<span class="string">&#x27;body:&#x27;</span>, <span class="keyword">await</span> response.text())</span><br><span class="line">print(<span class="string">&#x27;bytes:&#x27;</span>, <span class="keyword">await</span> response.read())</span><br><span class="line">print(<span class="string">&#x27;json:&#x27;</span>, <span class="keyword">await</span> response.json())</span><br></pre></td></tr></table></figure>

<p>返回的是一个协程对象需要加 await。具体查看 aiohttp 的 API</p>
<p>链接 <a href="https://docs.aiohttp.org/en/stable/client_reference.html">https://docs.aiohttp.org/en/stable/client_reference.html</a></p>
<h5 id="超时设置"><a href="#超时设置" class="headerlink" title="超时设置"></a>超时设置</h5><p>借助 ClientTimeout 对象设置超时，例如设置 1 秒的超时时间，超时会抛出 TimeoutError 异常，类型为 asyncio.TimeoutError</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    data = &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;germey&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">25</span>&#125;</span><br><span class="line">    timeout = aiohttp.ClientTimeout(total=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession(timeout=timeout) <span class="keyword">as</span> session:</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>ClientTimeout 还有其他参数，connect、socket_connect 等</p>
<p><a href="https://docs.aiohttp.org/en/stable/client_quickstart.html#timeouts">https://docs.aiohttp.org/en/stable/client_quickstart.html#timeouts</a></p>
<h5 id="并发限制"><a href="#并发限制" class="headerlink" title="并发限制"></a>并发限制</h5><p>asyncio 的 Semaphore 来控制并发量</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">CONCURRENCY = <span class="number">5</span></span><br><span class="line">URL = <span class="string">&#x27;https://www.baidu.com&#x27;</span></span><br><span class="line"></span><br><span class="line">semaphore = asyncio.Semaphore(CONCURRENCY) <span class="comment">#创建信号量对象</span></span><br><span class="line">session = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">scripe_api</span>():</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> semaphore:<span class="comment">#1</span></span><br><span class="line">        print(<span class="string">&#x27;scrapping:&#x27;</span>, URL)</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> session.get(URL) <span class="keyword">as</span> response:</span><br><span class="line">            <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> response.text()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="keyword">global</span> session;</span><br><span class="line">    session = aiohttp.ClientSession()</span><br><span class="line">    scripe_index_tasks = [asyncio.ensure_future(scripe_api()) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>)]</span><br><span class="line">    <span class="keyword">await</span> asyncio.gather(*scripe_index_tasks)<span class="comment">#2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    asyncio.get_event_loop().run_until_complete(main())</span><br></pre></td></tr></table></figure>

<p>创建信号量对象，使用：把 semaphore 直接放置在对应的爬取方法里，使用 async with 语句将 semaphore 作为上下文对象即可。这样信号量便可以控制进入爬取的最大协程数量</p>
<p>main 方法里声明了 1000 个 task，传递给 gather 方法运行</p>
<h4 id="aiohttp-异步爬取实战"><a href="#aiohttp-异步爬取实战" class="headerlink" title="aiohttp 异步爬取实战"></a>aiohttp 异步爬取实战</h4>]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Python3网络爬虫开发实战-pyspider框架使用</title>
    <url>/2022/04/19/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-pyspider%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>pyspider 官方文档 <a href="http://docs.pyspider.org/">http://docs.pyspider.org/</a></p>
<h4 id="基本功能"><a href="#基本功能" class="headerlink" title="基本功能"></a>基本功能</h4><p>提供方便易用的WebUI系统，可视化编写和调试爬虫</p>
<p>提供爬取进度监控、爬取结果查看、爬虫项目管理等功能</p>
<p>支持多种后端数据库，如MySQL、MongoDB、Redis、SQLite</p>
<p>支持多种消息队列，如RabbitMQ、Beanstalk、Redis、Kombu</p>
<p>提供优先级控制、失败重试、定时抓取等功能</p>
<p>对接了 PhantomJS，可以抓取 JavaScript 渲染的页面</p>
<p>支持单机和分布式部署，支持 Docker 部署</p>
<p>pyspid 提供了 WebUI，爬虫的编写、调试都是在 WebUI 中进行的，如果要快速实现一个页面的抓取，使用pyspider</p>
<h5 id="pyspider-架构"><a href="#pyspider-架构" class="headerlink" title="pyspider 架构"></a>pyspider 架构</h5><p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-pyspider%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/WeChataffa8b62cf8bf792b16728f4f46c0065.png" alt="WeChataffa8b62cf8bf792b16728f4f46c0065"></p>
<p>每个 pyspider 项目对应一个 Python 脚本，脚本中定义了一个 Handler 类，它有一个 on_start() 方法，爬取首先调用 no_start() 方法生成最初的抓取任务，然后发送给 Scheduler 进行调度</p>
<p>Scheduler 将抓取任务分发给 Fetcher 进行抓取，Fetcher 执行并得到响应，随后将响应发送给 Processer</p>
<p>Processer 处理响应并提取出新的 URL 生成新的抓取任务，然后通过消息队列的方式通知 Scheduler 当前任务抓取执行情况，并将新生成的抓取任务发送给 Scheduler，如果生成了新的提取结果，则将其发送到结果队列等待 Result Worker 处理</p>
<p>Scheduler 接收到新的抓取任务，然后查询数据库，判断其如果是新的抓取任务或者是需要重试的任务就继续进行调度，然后将其发送回 Fetcher 进行抓取</p>
<p>不断重复以上工作，直到所有的任务都执行完毕，抓取结束</p>
<p>抓取结束后，程序会回调 on_finished() 方法</p>
<h4 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h4><h5 id="启动-pyspider"><a href="#启动-pyspider" class="headerlink" title="启动 pyspider"></a>启动 pyspider</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pyspider all</span><br></pre></td></tr></table></figure>

<p>这样可以启动 pyspider 的所有组件，最后一行输出提示 WebUI 运行在 5000 端口上，输入 <a href="http://localhost:5000/">http://localhost:5000</a> 可以看到 pyspider 的 WebUI 页面，可以用它来管理项目、编写代码、在线调试、监控任务</p>
<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-pyspider%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/WeChat941a660af574ca4e9a6f69c141140d7c.png" alt="WeChat941a660af574ca4e9a6f69c141140d7c"></p>
<h5 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h5><p>点击右边的 Create 按钮，弹出的浮窗输入项目名称和爬取的链接</p>
<p>接下来就看到 pyspider 项目编辑和调试页面</p>
<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-pyspider%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/WeChat3425c6583da1e0405c27d3f40dce8510.png" alt="WeChat3425c6583da1e0405c27d3f40dce8510"></p>
<p>左侧就是代码的调试页面，点击左侧右上角的 run 单步调试爬虫程序，左侧下半部分可以预览当前的爬取页面</p>
<p>右侧是代码编辑页面，可以直接编辑代码和保存代码，不需要借助 IDE</p>
<p>生成的代码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pyspider.libs.base_handler <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handler</span>(<span class="params">BaseHandler</span>):</span></span><br><span class="line">  crawl_config = &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">  @every(minutes=24 * 60)</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">on_start</span>(<span class="params">self</span>):</span></span><br><span class="line">    	<span class="comment">#新建爬取请求</span></span><br><span class="line">      <span class="comment">#（爬取URL，指定爬取成功解析方法）</span></span><br><span class="line">      self.crawl(<span class="string">&#x27;http://travel.qunar.com/travelbook/list.htm&#x27;</span>, callback=self.index_page)</span><br><span class="line"></span><br><span class="line"><span class="meta">  @config(age=10 * 24 * 60 * 60)</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">index_page</span>(<span class="params">self, response</span>):</span></span><br><span class="line">      <span class="keyword">for</span> each <span class="keyword">in</span> response.doc(<span class="string">&#x27;a[href^=&quot;http&quot;]&#x27;</span>).items():</span><br><span class="line">          self.crawl(each.attr.href, callback=self.detail_page)</span><br><span class="line"></span><br><span class="line"><span class="meta">  @config(priority=2)</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">detail_page</span>(<span class="params">self, response</span>):</span></span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">          <span class="string">&quot;url&quot;</span>: response.url,</span><br><span class="line">          <span class="string">&quot;title&quot;</span>: response.doc(<span class="string">&#x27;title&#x27;</span>).text(),</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>Handler 就是 pyspider 爬虫的主类，可以在这里定义爬取、解析、存储的逻辑，整个爬虫的功能只需要一个 Handler 即可完成</p>
<p>crawl_config：将项目所有爬取配置统一定义到这里，如 Headers、代理等，配置后全局生效</p>
<p>on_start()：爬取入口，初始的爬取请求在这里产生，通过 crawl() 方法即可新建一个爬取请求，第一个参数爬取 URL，第二个参数 callback，指定爬取成功后哪个方法进行解析</p>
<p>index_page()：接收 Response 参数，Response 对接了 pyquery，直接调用 doc() 方法传入相应的 CSS 选择器，就可以像 pyquery 一样解析此页面，上面代码默认 <code>a[href=^=&quot;http&quot;]</code> ，也就是说该方法解析了页面的所有链接，然后将链接遍历，再次调用 crawl() 方法生成新的爬取请求，同时指定 callback 为 detail_page 解析</p>
<p>detail_page()：同样接收 Response 作为参数，抓取的就是详情页的信息，就不会生成新的请求，只对 Response 对象解析，解析后以字典形式返回，也可以进行后序处理，如保存到数据库</p>
<h5 id="爬取首页"><a href="#爬取首页" class="headerlink" title="爬取首页"></a>爬取首页</h5><p>点击左栏右上角的 run 按钮，即可看到页面下方 follows 便会出现一个标注，其中包含数字 1，这代表有新的爬取请求产生</p>
<img src="Python3网络爬虫开发实战-pyspider框架使用/WeChata1afccc130dc604431124e411f736a1b.png" alt="WeChata1afccc130dc604431124e411f736a1b" style="zoom:80%;" />

<p>左栏左上角显示当前 run 的配置文件，callback 是 on_start，说明点击run 之后执行了 on_start 方法</p>
<p>on_start() 方法中，我们利用 crawl() 方法生成一个爬取请求，那下方的 follows 上数字 1 就代表这一个爬取请求</p>
<p>点击 follows 按钮，可以看到生成的爬取请求的链接，每个链接右侧有一个箭头按钮，点击该箭头可以对此链接进行爬取，也就是爬取攻略的首页内容</p>
<p>再点击下方的 web 按钮，即可羽然当前爬取结果的页面</p>
<p>点击 html 按钮可查看当前页面的源代码</p>
<p>上面 index_page() 方法中提取了所有的链接并生成了新的爬取请求，只需要攻略详情页面的链接就够了，这里修改提取链接时的 CSS选择器，</p>
<p>首页切换到 web 页面，找到攻略标题，点击下方 enable css selector helper，点击标题，可以看到标题外多了一个红框，上方出现了一个 CSS 选择器，这就是当前标题对应的 CSS 选择器</p>
<img src="Python3网络爬虫开发实战-pyspider框架使用/WeChat71c9e7d7b2716e5c496dc2dde6ef328a.png" alt="WeChat71c9e7d7b2716e5c496dc2dde6ef328a" style="zoom:80%;" />

<p>右侧代码选中要更改的区域，点击左栏上右箭头，上方出现的标题的 CSS选择器就会被替换到右侧的代码中</p>
<p>替换 CSS 选择器</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> each <span class="keyword">in</span> response.doc(<span class="string">&#x27;li &gt; .tit &gt; a&#x27;</span>).items():</span><br></pre></td></tr></table></figure>

<p>重新点击左栏上右上角 run 按钮，即可重新执行 index_page() 方法。</p>
<p>此时 follows 就变成了 10 个，也就是说现在提取的只有当前页面的 10 个攻略</p>
<p>现在只有第一页的内容，还需要爬取后序页面，所以还需要一个爬取链接，即爬取下一页的攻略列表页面</p>
<p>再利用 crawl() 方法添加下一页的爬取请求，在index_page() 方法里面添加代码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index_page</span>(<span class="params">self, response</span>):</span></span><br><span class="line">  <span class="built_in">next</span> = response.doc(<span class="string">&#x27;.next&#x27;</span>).attr.href</span><br><span class="line">  self.crawl(<span class="built_in">next</span>, callback=self.index_page)</span><br><span class="line">  <span class="keyword">for</span> each <span class="keyword">in</span> response.doc(<span class="string">&#x27;li &gt; .tit &gt; a&#x27;</span>).items():</span><br><span class="line">      self.crawl(each.attr.href, callback=self.detail_page)</span><br></pre></td></tr></table></figure>

<p>重新 run ，就可以看到 11 个爬取请求，follows 上显示 11</p>
<h5 id="爬取详情页"><a href="#爬取详情页" class="headerlink" title="爬取详情页"></a>爬取详情页</h5><p>任意选取一个详情页进入，点击请求中任意一个右箭头，执行详情页的爬取</p>
<img src="Python3网络爬虫开发实战-pyspider框架使用/WeChat75fbf9e380178eca4d6202777db75bb0.png" alt="WeChat75fbf9e380178eca4d6202777db75bb0" style="zoom:80%;" />

<p>切换到 web 页面预览效果，页面下拉，看到一些图片显示加载中，再查看源码，没有看到 img 节点</p>
<p>出现此现象的原因是 pyspider 默认发送 HTTP 请求，请求的 HTML 文档本身不包含 img 节点。但浏览器中我们看到了图片，这是因为这张图片是后期经过 JavaScript 出现的</p>
<p>pyspider 内部对接了 PhantomJS，只需要修改一个参数即可，添加 fetch_type</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index_page</span>(<span class="params">self, response</span>):</span></span><br><span class="line">  <span class="built_in">next</span> = response.doc(<span class="string">&#x27;.next&#x27;</span>).attr.href</span><br><span class="line">  self.crawl(<span class="built_in">next</span>, callback=self.index_page)</span><br><span class="line">  <span class="keyword">for</span> each <span class="keyword">in</span> response.doc(<span class="string">&#x27;li &gt; .tit &gt; a&#x27;</span>).items():</span><br><span class="line">      self.crawl(each.attr.href, callback=self.detail_page, fetch_type=<span class="string">&#x27;js&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>图片被渲染出来了，这就是启用了 PhantomJS 渲染后的结果，最后将详情中的信息提取出来</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">detail_page</span>(<span class="params">self, response</span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;url&#x27;</span>: response.url,</span><br><span class="line">        <span class="string">&#x27;title&#x27;</span>: response.doc(<span class="string">&#x27;#booktitle&#x27;</span>).text(),</span><br><span class="line">        <span class="string">&#x27;date&#x27;</span>: response.doc(<span class="string">&#x27;.when .data&#x27;</span>).text(),</span><br><span class="line">        <span class="string">&#x27;day&#x27;</span>: response.doc(<span class="string">&#x27;.howlong .data&#x27;</span>).text(),</span><br><span class="line">        <span class="string">&#x27;who&#x27;</span>: response.doc(<span class="string">&#x27;.who .data&#x27;</span>).text(),</span><br><span class="line">        <span class="string">&#x27;text&#x27;</span>: response.doc(<span class="string">&#x27;#b_panel_schedule&#x27;</span>).text(),</span><br><span class="line">        <span class="string">&#x27;image&#x27;</span>: response.doc(<span class="string">&#x27;.cover_img&#x27;</span>).attr.src,</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>左栏中输出了最终构造的字典信息</p>
<h5 id="启动爬虫"><a href="#启动爬虫" class="headerlink" title="启动爬虫"></a>启动爬虫</h5><p>返回爬虫主页面，将爬虫 status 设置成 DEBUG 或 RUNNING，点击右侧的 Run 按钮即可开始爬取</p>
<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-pyspider%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/WeChatab3cfe3bff369db2397e97e00e3ec0af.png" alt="WeChatab3cfe3bff369db2397e97e00e3ec0af"></p>
<p>最左侧可以定义项目的分组，方便管理</p>
<p>rate/burst 代表当前的爬取速率，rate 代表1秒发出多少个请求，burst 相当于流量控制中的令牌桶算法的令牌数，rate 和 burst 设置越大，爬取速率越快</p>
<p>process 中的 5m、1h、1d 指最近5分、1小时、1天内的请求情况，all 代表所有的请求情况</p>
<p>蓝色代表等待被执行的请求，绿色代表请求成功的请求，黄色代表请求失败后等待重试的请求，红色代表失败次数过多而被忽略的请求，这样可以知道爬取的进度和请求情况</p>
<p>点击 Active Tasks 可查看最近请求的详细情况</p>
<p>点击 Results 可查看所有爬取结果</p>
<h4 id="pyspider用法"><a href="#pyspider用法" class="headerlink" title="pyspider用法"></a>pyspider用法</h4><h5 id="pyspider-all-配置参数"><a href="#pyspider-all-配置参数" class="headerlink" title="pyspider all 配置参数"></a>pyspider all 配置参数</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pyspider [OPTIONS] COMMAND [ARGA]</span><br><span class="line">#OPTIONS 可选参数</span><br><span class="line">-c, --config FILENAME 指定配置文件名称</span><br><span class="line">--logging-config TEXT 日志配置文件名称 默认 pyspider&#x2F;pyspider&#x2F;logging.conf</span><br><span class="line">--debug 开启调试模式</span><br><span class="line">--queue-maxsize INTEGER 队列的最大长度 </span><br><span class="line">--taskdb TEXT taskdb的数据库连接字符串 默认 sqlite</span><br><span class="line">--rojectdb TEXT projectdb的数据库连接字符串 默认 sqlite</span><br><span class="line">--resultdb TEXT resultdb的数据库连接字符串 默认 sqlite</span><br><span class="line">--message-queue TEXT 消息队列连接字符串 默认 multiprocessing.Queue</span><br><span class="line">--phantomjs-proxy TEXT PhantomJS使用的代理 ip:port 形式</span><br><span class="line">--data-path TEXT 数据库存放路径</span><br><span class="line">--version pyspider的版本</span><br><span class="line">--help 显示帮助信息</span><br></pre></td></tr></table></figure>

<p>-c 可以指定配置文件名称是一个常用配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;taskdb&quot;: &quot;mysql+taskdb:&#x2F;&#x2F;username:password@host:port&#x2F;taskdb&quot;,</span><br><span class="line">	&quot;projectdb&quot;: &quot;mysql+projectdb:&#x2F;&#x2F;username:password@host:port&#x2F;projectdb&quot;,</span><br><span class="line">	&quot;resultdb&quot;: &quot;mysql+resultdb:&#x2F;&#x2F;username:password@host:port&#x2F;resultdb&quot;,</span><br><span class="line">	&quot;message_queue&quot;: &quot;amqp:&#x2F;&#x2F;username:password@host:port&#x2F;%2F&quot;,</span><br><span class="line">	&quot;webui&quot;:&#123;</span><br><span class="line">		&quot;username&quot;: &quot;some_name&quot;,</span><br><span class="line">		&quot;password&quot;: &quot;some_passwd&quot;,</span><br><span class="line">		&quot;need-auth&quot;: true</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果要配置 pyspider WebUI 的访问认证，可以新建一个pyspider.json</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;webui&quot;:&#123;</span><br><span class="line">		&quot;username&quot;: &quot;root&quot;,</span><br><span class="line">		&quot;password&quot;: &quot;123456&quot;,</span><br><span class="line">		&quot;need-auth&quot;: true</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样通过在启动时指定配置文件来配置 pyspider WebUI 的访问认证</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pyspider -c pyspider.json all</span><br></pre></td></tr></table></figure>

<p>运行之后再打开 <a href="http://localhost:5000/">http://localhost:5000</a></p>
<p>也可以单独运行 pyspider 的某一个组件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#运行 Scheduler</span><br><span class="line">pyspider scheduler [OPTIONS]</span><br><span class="line">#运行 Fetcher</span><br><span class="line">pyspider fetcher [OPTIONS]</span><br><span class="line">#运行 Processor</span><br><span class="line">pyspider processor [OPTIONS]</span><br><span class="line">#运行 WebUI</span><br><span class="line">pyspider webui [OPTIONS]</span><br></pre></td></tr></table></figure>

<p>如果想要改变 WebUI运行端口为 5001</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pyspider webui --port 5001</span><br></pre></td></tr></table></figure>

<p>或者配置到 JSON 文件中</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;webui&quot;:&#123;&quot;port&quot;: 5001&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="crawl-方法"><a href="#crawl-方法" class="headerlink" title="crawl 方法"></a>crawl 方法</h5><p>callback 回调函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def on_start(self):</span><br><span class="line">	self.crawl(&#39;http:&#x2F;&#x2F;scrapy.org&#x2F;&#39;, callback&#x3D;self.index_page)</span><br></pre></td></tr></table></figure>

<p>index_page 方法的第一个参数是响应对象</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def index_page(self, response):</span><br><span class="line">	pass</span><br></pre></td></tr></table></figure>

<ul>
<li>age</li>
</ul>
<p>任务有效时间，如果某个任务在有效时间内且已经被执行，则它不会重复执行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def on_start(self):</span><br><span class="line">	self.crawl(&#39;http:&#x2F;&#x2F;www.example.org&#x2F;&#39;, callback&#x3D;self.callback,age&#x3D;10*24*60*60)</span><br><span class="line">或者</span><br><span class="line">@config(age&#x3D;10*24*60*60)</span><br><span class="line">def callback(self):</span><br><span class="line">	pass   </span><br><span class="line">默认有效期10天</span><br></pre></td></tr></table></figure>

<ul>
<li>priority</li>
</ul>
<p>爬取优先级，默认0，数值越大，对应的请求会优先被调用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def index_page(self):</span><br><span class="line">	self.crawl(&#39;http:&#x2F;&#x2F;www.example.org&#x2F;page.html&#39;, callback&#x3D;self.index_page)</span><br><span class="line">	self.crawl(&#39;http:&#x2F;&#x2F;www.example.org&#x2F;123.html&#39;, callback&#x3D;self.index_page,priority&#x3D;1)</span><br><span class="line">第二个链接先调用</span><br></pre></td></tr></table></figure>

<ul>
<li>exetime</li>
</ul>
<p>设置定时任务，值是时间戳，默认0，立即执行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">improt time</span><br><span class="line">def on_start(self):</span><br><span class="line">	self.crawl(&#39;http:&#x2F;&#x2F;www.example.org&#x2F;&#39;, callback&#x3D;self.callback,exetime&#x3D;time.time()+30*60)</span><br></pre></td></tr></table></figure>

<p>该任务30分钟后执行</p>
<ul>
<li>retries</li>
</ul>
<p>定义重试次数，默认 3</p>
<ul>
<li><p>itag</p>
</li>
<li><p>auto_recrawl</p>
</li>
<li><p>method</p>
</li>
<li><p>params</p>
</li>
<li><p>data</p>
</li>
<li><p>files</p>
</li>
<li><p>user_agent</p>
</li>
<li><p>headers</p>
</li>
<li><p>cookies</p>
</li>
<li><p>connect_timeout</p>
</li>
<li><p>timeout</p>
</li>
<li><p>allow_redirects</p>
</li>
<li><p>validate_cert</p>
</li>
<li><p>proxy</p>
</li>
<li><p>fetch_type</p>
</li>
<li><p>js_script</p>
</li>
<li><p>js_run_at</p>
</li>
<li><p>js_viewport_width/js_viewport_height</p>
</li>
<li><p>load_images</p>
</li>
<li><p>save</p>
</li>
<li><p>cancel</p>
</li>
<li><p>force_update</p>
</li>
</ul>
<h4 id="任务区分"><a href="#任务区分" class="headerlink" title="任务区分"></a>任务区分</h4><p>pyspider 判断两个任务是否是重复是使用任务对应的 URL 的MD5值作为任务的唯一 ID，ID相同，两个任务就会被判定为相同，其中一个就不会爬取</p>
<p>很多情况下请求的链接可能是同一个，但 POST 参数不同，这时可以重写 task_id() 方法，改变这个 ID 的计算方式来实现不同任务区分</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> pyspider.libs.utils <span class="keyword">import</span> md5string</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_taskid</span>(<span class="params">self, task</span>):</span></span><br><span class="line">  <span class="keyword">return</span> md5string(task[<span class="string">&#x27;url&#x27;</span>]+json.dumps(task[<span class="string">&#x27;fetch&#x27;</span>].get(<span class="string">&#x27;data&#x27;</span>, <span class="string">&#x27;&#x27;</span>)))</span><br></pre></td></tr></table></figure>

<p>重写了 get_taskid 方法，利用 URL 和 POST 的参数来生成 ID</p>
<h4 id="全局配置"><a href="#全局配置" class="headerlink" title="全局配置"></a>全局配置</h4><p>可以使用 craw_config 指定全局配置，配置中的参数会和 crawl() 方法创建任务时的参数合并，如要全局配置一个 Headers</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class Handler(BaseHandler):</span><br><span class="line">	crawl_config &#x3D; &#123;</span><br><span class="line">		&#39;headers&#39;: &#123;</span><br><span class="line">			&#39;User-Agent&#39;: &#39;GoogleBot&#39;,</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h4 id="定时爬取"><a href="#定时爬取" class="headerlink" title="定时爬取"></a>定时爬取</h4><p>可以通过 every 属性来设置爬取时间间隔</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@every(minutes=24*60)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_start</span>(<span class="params">self</span>):</span></span><br><span class="line">	<span class="keyword">for</span> url <span class="keyword">in</span> urllist:</span><br><span class="line">		self.crawl(url, callback=self.index_page)</span><br></pre></td></tr></table></figure>

<p>设置了每天执行一次爬取</p>
<p>上面提到了有效时间，有效时间内不会重复爬取，所以要把有效时间设置比重复时间更短，才可以实现定时爬取</p>
<p>将 age 设置小于定时时间</p>
<h4 id="项目状态"><a href="#项目状态" class="headerlink" title="项目状态"></a>项目状态</h4><p>TODO 刚被创建未实现状态</p>
<p>STOP 想停止某项目抓取，可将项目设置 STOP</p>
<p>CHECKING 正在运行的项目被修改后会变成 CHECKING 状态</p>
<p>DEBUG/RUNNING 这两个状态对项目运行没影响，设置任意一个项目都可以运行，用第二个可以区分项目是否测试通过</p>
<p>PAUSE 爬取过程中连续多次错误时，项目会自动设置为 PAUSE 状态，并等待一段时间后继续爬取</p>
<h4 id="删除项目"><a href="#删除项目" class="headerlink" title="删除项目"></a>删除项目</h4><p>将项目设置为 STOP，将分组名称设置为 delete，等待24小时，项目会自动删除</p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Python3网络爬虫开发实战-分布式爬虫</title>
    <url>/2022/04/23/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-%E5%88%86%E5%B8%83%E5%BC%8F%E7%88%AC%E8%99%AB/</url>
    <content><![CDATA[<p>分布式爬虫将多台主机组合起来，共同完成一个爬取任务</p>
<p>Scrapy-Redis 库提供了 Scrapy 分布式的队列、调度器、去重等功能</p>
<h4 id="14-3-Scrapy-分布式实现"><a href="#14-3-Scrapy-分布式实现" class="headerlink" title="14.3 Scrapy 分布式实现"></a>14.3 Scrapy 分布式实现</h4><p>利用 Scrapy-Redis 来实现分布式对接</p>
<h5 id="搭建-Redis-服务器"><a href="#搭建-Redis-服务器" class="headerlink" title="搭建 Redis 服务器"></a>搭建 Redis 服务器</h5><p>要实现分布式部署，多台主机需要共享爬取队列和去重集合，而这两部分内容是存于 Redis 数据库中的，需要搭建一个可公网访问的 Redis 服务器</p>
<p>推荐使用 Linux 服务器，可以购买阿里云、腾讯云、Azure等提供的云主机，一般都会配有公网 IP</p>
<p>阿里云、腾讯云的服务器需要配置安全组放通 Redis 运行端口才可以远程访问</p>
<h5 id="配置-Scrapy-Redis"><a href="#配置-Scrapy-Redis" class="headerlink" title="配置 Scrapy-Redis"></a>配置 Scrapy-Redis</h5><ul>
<li>核心配置</li>
</ul>
<p>将调度器的类和去重的类替换为 Scrapy-Redis 提供的类，settings.py 里添加配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SCHEDULER &#x3D; &quot;scrapy_redis.scheduler.Scheduler&quot;</span><br><span class="line">DUPEFILTER_CLASS &#x3D; &quot;scrapy_redis.dupefilter.RFPDupeFilter&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>Redis 连接配置</li>
</ul>
<p>方式一：通过连接字符串配置</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">redis://[:password]@host:port/db</span><br><span class="line">rediss://[:password]@host:port/db</span><br><span class="line">unix://[:password]@/path/to/socket.sock?db=db</span><br><span class="line"><span class="comment">#如 redis://:foobared@127.2.34.25:6379</span></span><br></pre></td></tr></table></figure>

<p>中括号代表此选项可有可无 db是数据库代号，默认值 0</p>
<p>settings.py 里配置为 REDIS_URL 变量</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">REDIS_URL &#x3D; &#39;redis:&#x2F;&#x2F;:foobared@127.2.34.25:6379&#39;</span><br></pre></td></tr></table></figure>

<p>方式二：是分项单独配置， settings.py 中配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">REDIS_HOST &#x3D; &#39;127.2.34.25&#39;</span><br><span class="line">REDIS_PORT &#x3D; &#39;6379&#39;</span><br><span class="line">REDIS_PASSWORD &#x3D; &#39;foobared&#39;</span><br></pre></td></tr></table></figure>

<h5 id="配置调度队列"><a href="#配置调度队列" class="headerlink" title="配置调度队列"></a>配置调度队列</h5><p>此配置可选，默认使用 PriorityQueue，如果想更改配置，可有配置 SCHEDULER_QUEUE_CLASS 变量</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SCHEDULER_QUEUE_CLASS &#x3D; &#39;scrapy_redis.queue.PriorityQueue&#39;</span><br><span class="line">SCHEDULER_QUEUE_CLASS &#x3D; &#39;scrapy_redis.queue.FifoQueue&#39;</span><br><span class="line">SCHEDULER_QUEUE_CLASS &#x3D; &#39;scrapy_redis.queue.LifoQueue&#39;</span><br></pre></td></tr></table></figure>

<p>任选一配置，即可切换爬取队列的存储方式</p>
<h5 id="配置持久化"><a href="#配置持久化" class="headerlink" title="配置持久化"></a>配置持久化</h5><p>可选配置，默认 False。Scrapy-Redis 默认会在爬取全部完成清空爬取队列和去重指纹集合</p>
<p>如果不想自动清空爬取队列和去重指纹集合，可以增加配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SCHEDULER_PERSIST &#x3D; True</span><br></pre></td></tr></table></figure>

<h5 id="配置重爬"><a href="#配置重爬" class="headerlink" title="配置重爬"></a>配置重爬</h5><p>可选配置，默认 False，如果配置了持久化或者强制中断了爬虫，那么爬取队列和指纹集合不会被清空，爬虫重启之后就会接上次爬取，如果想重新爬取</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SCHEDULER_FLUSH_ON_START &#x3D; True</span><br></pre></td></tr></table></figure>

<p>分布式爬取不常用此配置</p>
<h5 id="Pipeline-配置"><a href="#Pipeline-配置" class="headerlink" title="Pipeline 配置"></a>Pipeline 配置</h5><p>可选配置，默认不启动</p>
<h5 id="配置存储目标"><a href="#配置存储目标" class="headerlink" title="配置存储目标"></a>配置存储目标</h5><p>最好将存储目标存到同一地方，可以在服务器上搭建一个 MongoDB 服务，或者购买 MongoDB 数据存储服务</p>
<p>这里使用服务器上搭建的 MongoDB 服务 ，IP120.27.34.25 用户名 admin 密码 admin123</p>
<p>修改 MONGO_URI </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MONGO_URI &#x3D; &#39;mongodb:&#x2F;&#x2F;admin:admin123@120.27.34.25:27017&#39;</span><br></pre></td></tr></table></figure>

<h5 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scrapy crawl weibocn</span><br></pre></td></tr></table></figure>

<p>每台主机启动了此命令之后，就会从配置的 Redis 数据库中调度 Request，做到爬取队列共享和指纹集合共享，每台主机占用各自的宽带和处理器，不会互相影响</p>
<h4 id="14-5-Bloom-Filter-对接"><a href="#14-5-Bloom-Filter-对接" class="headerlink" title="14.5 Bloom Filter 对接"></a>14.5 Bloom Filter 对接</h4><p>布隆过滤器，用来检测一个元素是否在一个集合中</p>
<h5 id="对接-Scrapy-Redis"><a href="#对接-Scrapy-Redis" class="headerlink" title="对接 Scrapy-Redis"></a>对接 Scrapy-Redis</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install scrapy-redis-bloomfilter</span><br></pre></td></tr></table></figure>

<p>配置</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#去重类，要使用Bloom Filter 替换 DUPEFILTER_CLASS</span></span><br><span class="line">DUPEFILTER_CLASS = <span class="string">&#x27;scrapy_redis_bloomfilter.dupefilter.RFPDupeFilter&#x27;</span></span><br><span class="line"><span class="comment">#散列函数的个数 默认 6</span></span><br><span class="line">BLOOMFILTER_HASH_NUMBER = <span class="number">6</span></span><br><span class="line"><span class="comment">#Bloom Filter 的bit参数 默认30 占用128M空间，去重量级1亿</span></span><br><span class="line">BLOOMFILTER_BIT = <span class="number">30</span></span><br></pre></td></tr></table></figure>



<h4 id="分布式爬虫部署"><a href="#分布式爬虫部署" class="headerlink" title="分布式爬虫部署"></a>分布式爬虫部署</h4><h4 id="15-1-Scrapyd-分布式部署"><a href="#15-1-Scrapyd-分布式部署" class="headerlink" title="15.1 Scrapyd 分布式部署"></a>15.1 Scrapyd 分布式部署</h4><p>Scrapyd 运行 Scrapy 爬虫的服务程序，提供一系列 HTTP 接口帮助部署、启动、停止、删除爬虫程序</p>
<h5 id="Scrapyd"><a href="#Scrapyd" class="headerlink" title="Scrapyd"></a>Scrapyd</h5><h5 id="Scrapyd-API"><a href="#Scrapyd-API" class="headerlink" title="Scrapyd API"></a>Scrapyd API</h5><h4 id="15-2-Scrapyd-Client"><a href="#15-2-Scrapyd-Client" class="headerlink" title="15.2 Scrapyd-Client"></a>15.2 Scrapyd-Client</h4><p>Scrapyd-Client 为了方便 Scrapy 项目的部署，提供了两个功能</p>
<p>将项目打包成 Egg文件</p>
<p>将打包生成的Egg文件通过 addversion.json 接口部署到 Scrapyd 上</p>
<h5 id="Scrapyd-Client-部署"><a href="#Scrapyd-Client-部署" class="headerlink" title="Scrapyd-Client 部署"></a>Scrapyd-Client 部署</h5><h4 id="15-3-Scrapyd-对接-Docker"><a href="#15-3-Scrapyd-对接-Docker" class="headerlink" title="15.3 Scrapyd 对接 Docker"></a>15.3 Scrapyd 对接 Docker</h4><p>将 Scrapyd 打包成一个 Docker 镜像，那么在服务器上只需要执行 Docker 命令就可以启动 Scrapyd 服务，就不用关心 Python 环境问题，也不需要担心版本冲突问题</p>
<h4 id="15-4-Scrapyd-批量部署"><a href="#15-4-Scrapyd-批量部署" class="headerlink" title="15.4 Scrapyd 批量部署"></a>15.4 Scrapyd 批量部署</h4>]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>opencv</title>
    <url>/2022/04/15/opencv/</url>
    <content><![CDATA[<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install opencv-python</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">from</span> numpy <span class="keyword">import</span> ndarray</span><br><span class="line">bg_img = cv2.imread(<span class="string">&#x27;shot2.png&#x27;</span>) <span class="comment">#读取图片</span></span><br><span class="line"><span class="comment">#imgCanny = cv2.Canny(img,threshold1,threshold2)</span></span><br><span class="line">bg_edge = cv2.Canny(bg_img, <span class="number">100</span>, <span class="number">200</span>) <span class="comment">#识别图片边缘 得到图片边缘的灰度图</span></span><br><span class="line">bg_pic = cv2.cvtColor(bg_edge, cv2.COLOR_GRAY2RGB) <span class="comment">#将图片转换为RBG格式</span></span><br><span class="line">imgGray = cv2.cvtColor(img,cv2.COLOR_BGR2GRAY) <span class="comment">#将图像转换为灰度图像</span></span><br></pre></td></tr></table></figure>



<h5 id="读写显示图像"><a href="#读写显示图像" class="headerlink" title="读写显示图像"></a>读写显示图像</h5><ul>
<li>imread()</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">img = cv2.imread(<span class="string">&quot;PATH_TO_IMAGE.jpg/png&quot;</span>)</span><br><span class="line">img = imread(<span class="string">&quot;images/dog0.jpg&quot;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>imshow()</li>
</ul>
<p>两个输入，一个是图像窗口的名字即title，一个是所展示图像的像素矩阵</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">cv2.imshow(<span class="string">&#x27;gray_scale&#x27;</span>, gray_scale)</span><br><span class="line"><span class="comment">#gray_scale 矩阵的数据类型是 np.uint8，浮点数类型会有显示异常情况</span></span><br><span class="line"><span class="comment">#同时需要在语句后加上</span></span><br><span class="line">cv2.waitKey(<span class="number">0</span>)</span><br><span class="line"><span class="comment">#在时间k（单位ms）内，等待用户按键（例如关闭图像窗口）触发，如果没有触发事件，则跳出等待</span></span><br><span class="line"><span class="comment">#k=0，则无限等待触发事件</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">img = cv2.imread(<span class="string">&#x27;shot2.png&#x27;</span>, flags=<span class="number">0</span>) <span class="comment">#flag=0读取为灰度图像 flag=1读取为彩色图像RGB</span></span><br><span class="line">cv2.imshow(<span class="string">&#x27;demo&#x27;</span>, img)</span><br><span class="line">cv2.waitKey(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>imwrite()</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#cv2.imwrite(FILENAME, IMAGE)</span></span><br><span class="line">cv2.imwrite(<span class="string">&#x27;images/img&#x27;</span>,img)</span><br></pre></td></tr></table></figure>

<h5 id="调整大小和裁剪图像"><a href="#调整大小和裁剪图像" class="headerlink" title="调整大小和裁剪图像"></a>调整大小和裁剪图像</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">img = cv2.imread(<span class="string">&#x27;shot2.png&#x27;</span>, flags=<span class="number">0</span>) <span class="comment"># type: ndarray</span></span><br><span class="line">print(img.shape) <span class="comment"># (164, 290)</span></span><br><span class="line"></span><br><span class="line">imgResize1 = cv2.resize(img, (<span class="number">100</span>, <span class="number">100</span>))</span><br><span class="line">imgResize2 = cv2.resize(img, (<span class="number">1024</span>, <span class="number">1024</span>))</span><br><span class="line"></span><br><span class="line">cv2.imshow(<span class="string">&#x27;Image&#x27;</span>, img)</span><br><span class="line">cv2.imshow(<span class="string">&#x27;Image Resize2&#x27;</span>, imgResize1)</span><br><span class="line">cv2.imshow(<span class="string">&#x27;Image Resize2&#x27;</span>, imgResize2)</span><br><span class="line">cv2.waitKey(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>不想对宽高进行硬编码，也可以使用形状，然后用索引增加宽高</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">img = cv2.imread(<span class="string">&#x27;shot2.png&#x27;</span>, flags=<span class="number">0</span>) <span class="comment"># type: ndarray</span></span><br><span class="line">print(img.shape)</span><br><span class="line">shape = img.shape</span><br><span class="line">imgResize1 = cv2.resize(img, (shape[<span class="number">0</span>] // <span class="number">2</span>, shape[<span class="number">1</span>] // <span class="number">2</span>))  <span class="comment">##Decrease size</span></span><br><span class="line">imgResize2 = cv2.resize(img, (shape[<span class="number">0</span>] * <span class="number">2</span>, shape[<span class="number">1</span>] * <span class="number">2</span>))  <span class="comment">##Increase size</span></span><br><span class="line">cv2.imshow(<span class="string">&quot;Image Resize&quot;</span>, imgResize1)</span><br><span class="line">cv2.imshow(<span class="string">&quot;Image Increase size&quot;</span>, imgResize2)</span><br><span class="line">cv2.waitKey(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>裁剪图像</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#retval = img[y:y+h, x:x+w]</span></span><br><span class="line"><span class="comment"># img nparray 多维数组</span></span><br><span class="line"><span class="comment"># x,y 左上角坐标值</span></span><br><span class="line"><span class="comment"># w,h 宽度、高度</span></span><br><span class="line">img = cv2.imread(<span class="string">&#x27;shot2.png&#x27;</span>, flags=<span class="number">1</span>) <span class="comment"># type: ndarray</span></span><br><span class="line">print(img.shape)<span class="comment">#(164, 290, 3)</span></span><br><span class="line">imgCropped = img[<span class="number">0</span>:<span class="number">100</span>, <span class="number">50</span>:<span class="number">100</span>]</span><br><span class="line"></span><br><span class="line">cv2.imshow(<span class="string">&#x27;image&#x27;</span>, img)</span><br><span class="line">cv2.imshow(<span class="string">&#x27;cropped&#x27;</span>, imgCropped)</span><br><span class="line">print(imgCropped.shape)<span class="comment">#(100, 50, 3)</span></span><br><span class="line">cv2.waitKey(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h5 id="绘制几何图形"><a href="#绘制几何图形" class="headerlink" title="绘制几何图形"></a>绘制几何图形</h5><ul>
<li>绘制矩形</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#cv.rectangle(img,leftupper,rightdown,color,thickness)</span></span><br><span class="line"><span class="comment">#img:要绘制矩形的图像</span></span><br><span class="line"><span class="comment">#Leftupper, rightdown: 矩形的左上角和右下角坐标</span></span><br><span class="line"><span class="comment">#color: 线条的颜色</span></span><br><span class="line"><span class="comment">#Thickness: 线条宽度</span></span><br><span class="line">img_copy = img.copy()</span><br><span class="line"><span class="comment"># Draw a rectangle</span></span><br><span class="line">cv2.rectangle(img_copy, pt1 = (<span class="number">800</span>, <span class="number">470</span>), pt2 =(<span class="number">980</span>, <span class="number">530</span>),</span><br><span class="line">             color = (<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>), thickness = <span class="number">5</span>)</span><br><span class="line">plt.imshow(img_copy)</span><br></pre></td></tr></table></figure>

<h5 id="轮廓"><a href="#轮廓" class="headerlink" title="轮廓"></a>轮廓</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">img = cv2.imread(<span class="string">&#x27;shot1.png&#x27;</span>, flags=<span class="number">1</span>) <span class="comment"># type: ndarray</span></span><br><span class="line">gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)</span><br><span class="line">ret, thresh = cv2.threshold(gray, <span class="number">127</span>, <span class="number">255</span>, cv2.THRESH_BINARY)</span><br><span class="line">contours, hierachy = cv2.findContours(thresh, cv2.RETR_TREE, cv2.CHAIN_APPROX_NONE)</span><br><span class="line">draw_img = img.copy()</span><br><span class="line">res = cv2.drawContours(draw_img, contours, <span class="number">-1</span>, (<span class="number">0</span>,<span class="number">0</span>,<span class="number">255</span>), <span class="number">2</span>) <span class="comment">#绘制轮廓</span></span><br><span class="line">cv2.imshow(<span class="string">&#x27;res&#x27;</span>, res)</span><br><span class="line">cv2.imshow(<span class="string">&#x27;image&#x27;</span>, img)</span><br><span class="line">cv2.waitKey(<span class="number">0</span>)</span><br><span class="line">cv2.destroyAllWindows()</span><br></pre></td></tr></table></figure>



<h6 id="灰度图"><a href="#灰度图" class="headerlink" title="灰度图"></a>灰度图</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">img_gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY) <span class="comment">#灰度图</span></span><br></pre></td></tr></table></figure>

<h6 id="图像阈值"><a href="#图像阈值" class="headerlink" title="图像阈值"></a>图像阈值</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ret, dst = cv2.threshold(src, thresh, maxval, <span class="built_in">type</span>)</span><br><span class="line"><span class="comment">#src 输入图，只能输入单通道图，通常来说为灰度图</span></span><br><span class="line"><span class="comment">#dst 输出图</span></span><br><span class="line"><span class="comment">#thresh 阈值</span></span><br><span class="line"><span class="comment">#maxval 当像素值超过了阈值（或者小于阈值，根据type来决定），所赋予的值</span></span><br><span class="line"><span class="comment">#type </span></span><br><span class="line"><span class="comment">#cv2.THRESH_TOZERO；cv2.THRESH_TOZERO_INV</span></span><br><span class="line"><span class="comment">#cv2.THRESH_BINARY 超过阈值部分取maxval（最大值），否则取0</span></span><br><span class="line"><span class="comment">#cv2.THRESH_BINARY_INV THRESH_BINARY的反转</span></span><br><span class="line"><span class="comment">#cv2.THRESH_TRUNC 大于阈值部分设为阈值，否则不变</span></span><br><span class="line"><span class="comment">#cv2.THRESH_TOZERO 大于阈值部分不改变，否则设为0</span></span><br><span class="line"><span class="comment">#cv2.THRESH_TOZERO_INV THRESH_TOZERO的反转</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt <span class="comment"># python 绘图工具</span></span><br><span class="line"></span><br><span class="line">img = cv2.imread(<span class="string">&#x27;shot1.png&#x27;</span>, flags=<span class="number">1</span>) <span class="comment"># type: ndarray</span></span><br><span class="line"></span><br><span class="line">img_gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY) <span class="comment">#灰度图</span></span><br><span class="line">ret, thresh1 = cv2.threshold(img_gray, <span class="number">127</span>, <span class="number">255</span>, cv2.THRESH_BINARY)</span><br><span class="line">ret, thresh2 = cv2.threshold(img_gray, <span class="number">127</span>, <span class="number">255</span>, cv2.THRESH_BINARY_INV)</span><br><span class="line">ret, thresh3 = cv2.threshold(img_gray, <span class="number">127</span>, <span class="number">255</span>, cv2.THRESH_TRUNC)</span><br><span class="line">ret, thresh4 = cv2.threshold(img_gray, <span class="number">127</span>, <span class="number">255</span>, cv2.THRESH_TOZERO)</span><br><span class="line">ret, thresh5 = cv2.threshold(img_gray, <span class="number">127</span>, <span class="number">255</span>, cv2.THRESH_TOZERO_INV)</span><br><span class="line"></span><br><span class="line">titles = [<span class="string">&#x27;Original Image&#x27;</span>, <span class="string">&#x27;BINARY&#x27;</span>, <span class="string">&#x27;BINARY_INV&#x27;</span>, <span class="string">&#x27;TRUNC&#x27;</span>, <span class="string">&#x27;TOZERO&#x27;</span>, <span class="string">&#x27;TOZERO_INV&#x27;</span>]</span><br><span class="line">images = [img, thresh1, thresh2, thresh3, thresh4, thresh5]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    plt.subplot(<span class="number">2</span>, <span class="number">3</span>, i + <span class="number">1</span>), plt.imshow(images[i], <span class="string">&#x27;gray&#x27;</span>)</span><br><span class="line">    plt.title(titles[i])</span><br><span class="line">    plt.xticks([]), plt.yticks([])</span><br><span class="line">plt.show()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<img src="opencv/WeChatccfd9ec187d01b4329b4ce667c160300.png" alt="WeChatccfd9ec187d01b4329b4ce667c160300" style="zoom:70%;" />













































]]></content>
  </entry>
  <entry>
    <title>记录下1</title>
    <url>/2022/04/25/%E8%AE%B0%E5%BD%95%E4%B8%8B1/</url>
    <content><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <div class="hbe-input-container">
  <input type="password" id="hbePass" placeholder="" />
    <label for="hbePass">输入密码</label>
    <div class="bottom-line"></div>
  </div>
  <script id="hbeData" type="hbeData" data-hmacdigest="5ed15af852f2ae3aa4ec7f83bf320269a79fa5a70badb64aa5217c494165e265">b7efab11c9994bf8adc02f8b2c89561bd520a6f18e5bbbf23bd746caeae468b33842d2921b6b00c15e086dbfacc373528080fc8eb528ff3a3f11276f6f63a49c6b844a2f531ce5b4ef255d0444eb3220f42d5ebb66b6eea283897e73188d6d4ca30f83c654fc08cbc8f0d99c3e7241854148ec4f551fd37ff3b07ffa8542376f77b8a63dff4944efdc1b0194ffae40927a89da99858784be395f7e9357183898fa1d7025c23239f874ecce15f99e5e8f4e359e3e7369951b93f8df9f8e2c00bd002b2b99ab0b0670a78fe71cc08b170228071967457caccc4e8de835441e70e7e7a89c744d63d5c56da2b8a3094f45c5234415ee2ad9b9df961b537d6267766280f24040af923dea3c9ecf4f4f24c4697ccd31f2981902767ac1460e421c22874031404bdabf937bd9ce82d3f80aff5154183402648f09d5a6e432c8193121b3d07b2925ea9c9b3ba1039a772d38ecb9f0dd20dd8ba4e042ae27fe782d0ebed138ae23337fc4fa965644ea0ee0660fc9c711a4223a5834296d5a6feaf0255ef485f98bac85bb091587a05067b9c545a373360daa4398aef13bc7ebb97833e75a9bcb241d3edfd35b800cd2417c7b1623e6d5cc686c7ac2b671e79ce3e25f0d3e64f74b94434e74a459646a279b979e5f7513c810bbecb328a48498826e9d706d25853941875e7c45d3238883feeff30c795fca150509e065edf80c4747d8e200ecd293095860946e76bda811227213944a39b7e0d4e00c783fdc911b30fea60738ac7235dc799bcb18d087675a2ef08c69a7d759a3eaebddaeb002484f4b452a6059f5dd2e5706e75905bda7c7020f5e528708d85fba7d7efa966d43b83c2935b66543b97aa5f7eeee8e11c00ed940873025f575e658d0e371b735e3ac183af5a77e2fa04c1d9eea759ad1d2eb5ee739a23258b12dbbaeb95cf18e3b815ed5305ba7cb33c0ec6f9d12952522de6ede152feffbf094676929e2a0b7653d38ea6a8dff4479964eeb7bb96999e7072877bd95cbd2e1ff97917aaa6c14048fa94a3f2a49837a618c1f54b06adcccf5b41f0e11aeef1a8163f621ac1256c1e78f8736b8f6a043882d6050607bbe5f56ff00cf29e6efc6b49e27e4a40e46d24019b2648ec4b71c8f780ca72deddb557176d84fe376b76a2442f141e7f964281f8935eb7d6fe264c78c199006308f0c6194dfb46c191c142d33522b74a93261be22dd050d5ae699c4decbe747e4f432d1f9b10a945d21c151e568ca75f974cbeafe90b10b2e24b1ff5deb91fac1dc2bfdaa7999e71e7f175d82deb26ddbdbd09c07ff4b7761a8f6fe40ba163a1e9134b466235fd535121280667f8a0db0e27f1d7431bb03ce7f94da88004ae940a5a493eef1e9fd271408c9982e707de54421535f69b4cddc11b525709dffdcb1e60bfab851e8fb8700748566954ffa3c70331587c8a09e2195b29a7ea24fd551ef85ce43853273920fbc2b7b58a1ed57c3b0f50643c33093a681730262001fac391e733dc52f326411c2f6bbb89267be696090d302154513319a81aae71a1348c817876451982519eb7cf69d2ef1a4969db0c3056addadb685a8d7e2bc198c2cdb00d32cbdaae52c9c6551fb32f421e157892bddaad452a74e69726b5bb18bb96222c8d599afebbfd2cdb1d44f50308420934e41b942f52df5f440b05539a64ce37ef3eca187d394be4e46e4be987cdc369377cd26025c2603c547d0ef112f3351d5e69286efa0a0ddcc3053152e95495cc48883877d05e811e41dc624cc45446dafb0783fa971d4a370d8f17436a88ca1347e938fe365025833afe2b3b42e99757a2bf5e1881b09c13d430acc649322708d2a08b2bf0e2b5282233fdd01d92e12a7c45ee84cab8b5a4057c52f3998ab5bd00438ad5f23ac563af742e299630a12e3e564d39cd9b105a319c17eea979ceafe836ab0b0b34caf4daab9eae02554ce1b7e4d489f1398fff1626b44d757dfc8d23d03057ff7ffb1e6b4023ed14029b6e64a0de7991226339afe89b22f6946d3fb46d0d97b6762c4a674c03ff1e93daeb41ab8ec395fb5c7fc3ca6ca07bc317baeae8363df1ebacf5c3110e18412b18d9435abe6306298541fa7251d4e62094327b5c04710fdba3a18efbf2e4eb65082f037d16b78c0aff3fcd3c492f4a709283b4aa4b3693d6bd4739b84ab40af898ee18b20665644332701cb95d2af734637384380fc9e529b7d9d7d2afbfe16b11915fcc2637aff6e67054569da735f2bebee9fd0169edca95f876722f826303780202c96280af9598b97d46403bf83f3cb73a098e12e87368de4d2e0c1d36fb7071902a0b2dcb94b770bc21b69f6ec250e2c55449df0d918ce1081a3af08ed78789ed36d167de2b0f792405905086f95c03e161cc6e34f1325f022e14dfe7c36b7caface468df33f82a6702a18007738ff2a9afcf210d6f9318dec9297e415252cf541e54b8715ff2654994fc1c50762eb37bcaaf37dd1cec8826cdb04d18f299297e15d912a2f60c75c435a576d4d9e498fde422ad44ca8b71d0cea7d7284e1acda6c5bc408074aba46ba0701570181d0d0587254b51042f9c1db256452ec1d18ff7c11cd27564840fc0220f6e3c53b4f7a53478781ad246a6c75ff6cf2f1b3fe4bf200734c1334b740978563e01f1cf85086e5f4d1fb482cc64b6bc1460b66367e12e22dc2849691142e241aa81803f99aae8552cc2622c9641e93dc265cabbfbfabc3461b496a9d6104fba426f53b05259331e494ee346d1fa8c45b5f621538b6e67c84aac07814c8afd68bd7934b611a79abba2aca7a32cb8881aebf648b2e1b0e11fe0c55904baff6c92497023c548ac0cde1a8fca046dd58311805828966abe7506127cda66f37cdb630afb5177c5bf41be85244c249e00f596586bf1c74af37ad68e51a4bb863acf3b0429b5c297303e7e4aca3290055fb6bf0aed9eebccce8be38e5ad1b6d95cd228dd2680de3c35c1fecf7423f1fe750afd216fe9dd354d82d719d7244723fbfae018bcee27461506e9b1bc3f79503e79708e8022807ae6ca435d6234a423474a101b7ecb749e563e9431d64c80f6854f45036709332c48ef4f39f0baefede40d1394f66cb6be9317915478d9cf91253762c56a9264c99ec67ba967892785cf65134a57af0ce3f5b98109336485a333faa0c7520101b5b2048f84b896147b749fd317d678159e85257cac988ffdb07ce5bf1f3a8d7acdaadcd6c2a02254ab13786b2dc0c477fda2f0397c2ad18063316d66f75ccd0dfb786e896fca775e7ed954e327941af69095010f04e4d89450c08c007fac36ab4d393fea1365ae9b80f178e097fe7aca5387eaa327aa6577e6675cffbc5712bf95245a49d6216ea1b969b1b0000d13cd9ddc805e81ffc2022b0b9170e85d1e8217e88d0c3f5479f030ac25e14f0cf45e9457c444aba647547aa94e6e41ba1c41bc3abdfedd88caafc5b8095aa101fe2f5977deafae35adcca04bab61abcd6cb32e8f0a66834177b3abdd9ceeb20cdd0b960f2120ed8b5642643aace76404a5a5db1c153b88c5966a48c0ec135f9bef394f4db6f62ef0e7a38a585481ae4a1f4fed2fb00a633c72ac85503c8e687b5c323a0783b5146185f61bf89efabf88415a956a9ee1926421f504a361a2cc0ad7e1945c689a8bd8d0226ced4f6b72da5909bfa80ca5134b866840e87c9ee738b6ae492710d660515cd865a607d589b74539c97b41e93eff9139d0e959969f7c3e61360d2106c77319fefe456f5dd71acadc0695a1ec4252f714c10e3e69119f254e63b2ed062eef50cacfcf2d95e330d09fbdc18067650dfac0f44037538800d4bacbf4093fa112043e69f6ecd1a3317a5d95e6e7a868f83aef79569c19e31ce83a7a7227a62901294ee5ec674086e9b92fb92072bbaf4e8d97dd7650d5cd9e8ad3ead25136c83a5f2f79b5163f19ef2f6e6092fb458776bdf63750a60556d86ba0a2101cf185b50eaf75ee1dbb04fec6798518ef902a0e94c42733649c64f10d7cb92c14248bef06c8396e4c5bc0ba1f3311d58f388fd9f91d234faa05e7c929f0a00d4f3186014e7d467c389ab6e7a6ec952d736b4a5d90d9fc9f435b0142cf98c5aa32c9d0da60be3d46537a6f740fdc8e2694e26f200f55cdb3a0cd3109a198a88033b50ff994a2004151f414150c9226eb9847c37cdf5a092640d32871474858b946873fcb31bc0f34b83b4b9b3774d3ae052de2b34eb44517afb1ea75c800651be2db5c95e89e0213d7393bc383db5beb59293a30cfddef539fecaed3b7a4a83fea949df438900550d0a28a8de4b6a7713a5fb143631471a79b6e3f838bbbb386ce5364025a6416f66261a9b51cfb75e50793ad03682f253c10515609539c7495fbecabcf434ed930cde3f4604243271aa235696808878a4d7d29f26149bafaa15e3ee394cf074fe467e48f0174f2588c7b2a697b8036dc4c2833916e3669da2fc85475d30d8b2ff7f9b4357abab9001715b8aa7864470eda3e1e2bee87bd8bd70ed3c4dda27619417f89c35c18b584720f36f5cc8b869a5f004bcbd65fd3757a2770db79ca79931748b076fafd0f115a41c03d45bd127c6252054981a6f89d1ed2f86d298874b203695e4c192ef2ff84b2e09ff168f4c245eb0000b1b801eca0851c6997c08ccc0526b5206d0ce2c351905f4ca6d8b6479d28f16ad612391993309387b513ba333f8479c62a82df8bb7b638e005c1624553e21bcf4c80ceef6e61328c690f38af0d05fbbd99ce95f9a185551d9ed8a2b0cde36225ca2ee5c4e5058547d06b863e30d380c1cc0acd1353f371d696bf9848820b5cbeecbc70ae74e194636b35f232edf75e7b85aa77f2428c6a8caeb19d4b71da8cd171d1917a561d8b901e37871fee94c9c851e235ed6d420c3259a2c853cf74061780e852ee78ac688015e394149334d2e86a32444661c04ef3feb9bd5121d5b88e0f09d282b166ab6dc0c5c04cc389fbe4056da764ec17bc75c5286e9e5d812893797307ef44667476bba6c8b5a642571b858993985e2b9b4f3a666159b20cbfef97850c43b874828f6a718ac8f81ef2c7d3cebc26f5c93436c5f7a9e7c736ecb0545d3fe511c91deb36d66e28396d81e673bbdfe0c6bcf9b6c47fb5e10ca5670bfe579b6d3bc7bd52c873b9380aec9f529ed55d1afdfa530184d95263cd285a5f5f9fe653920dae85e6271d6054927422373d0425f17a466ecb97d191b650ad02cd24b8bcae4117f6a69c8f283b045da1aa1b463b59eb8b4ac2f6dd1ab51dfc74aa0ae8555f3717e05d973587585e0287d6921bdfd3f299cba4c7f4efa901bac25e1b4e48e47dc8298b32d2a3b05a9c0d3b2998516ae6d8fc76a3ade04f4da112890c8e38fafee71096228b161a21766f6e83c017c869569c1493d5c2a60536897765cffd1501f0a6f60f9ac9c126c865d3e5766ed5ae39c6c8d9accb7225cb84c8296df8efaae74491b2d873374cf96423e9eba03501ff1f371acb02e808e528d960fe213b0137b9cc9cab4b1ec1c4483893bc9b9158895c0428b815ee3a9c69fbbcdb0453a99709a26d36c91dd0a362ec6cdf392e7770b1878d43bd1113157af3956d346d7641b2cf4d6bf457b37e27dcd6415285fff47dd29505983af2dc61a5d61e211d186aab08126b1ab50c3d533c1a73dfa251aa4d85e848fed42bace883e15f55f38a3f8aa6de874a4965fd7844b0a05afb7b00746d887801500b9fff97b4fc10736b7108df9b4a943f8b6d1a0037248865d0d0f0f822fc7c250f13fe272866492dd57b71d0470a5b9ee9f2df0347635bdec2c4c023cc1578f668076b271f8a8b652bf5e5c49a851301effe6d7610285fbcd685892a5b516bedcbfdbe83b4373f899b59b518db6549a5c3cc2a9ea9d27ad83b658ce2b19368344ee19fc8760509cdaf7a3bdebc61e792600c10559cbd21d616cf1dc17c3d3da55df3ed7765a3ec0dd064e6e5e6062140073b16cf96a372b0e7d5de998168c4396ad357465f8a59b34143a872ff431eb93803806c2dfdb007b887c670efad4700a6cc649761e28545c3d0baffeea5640b777c948f00627ec2515d0defd935f4a8e134428256421376a3d78ba067429d9944072c17268731bf4368085737ecbeae46e19635e9707c085507daef14e14e5630bccc329205f510fe93328d3f244671be81994842e046a61d0d4c0f63e5150299fda5529da1fc0982e40ea167140b2cd6e92646eb33383878061d6c911d41857bcb958c6d997bae64ea7d3ab14546ef295e73d458f6169120f9e3561672d733d70eb713461f97b7da6acf890cc7a218694800c4cdfbdba0a5ec34bfc0316b96feb7d7b26cdd006cb9929f22491ac3e01cff5737031132d4705d7477a61afcc46905dc94b140a897d875c4da302a1fae358b759fe5a068d4f0e711a10728fc04cbc17fc2e69ba323499272b0528e6566d0c37f0fc666c41e934aa61572f141b797e8a91dd934162a14af457f5e17bb34d9c01a77eb53fba52c91da37befa3da40d9b4b30cb051d4788e3022b079c45167a5f35a8cc0cb772b3d0839fe6547c8aae61061846f873a2384bfe88bea0cbc0911a5325c81a5043419a01143391539d6e2903c30ce33b788c0199ab4a491ddf6d7abacd0147a78918afacdafe3d4583c02e8b905c7c4f9fe7d9e8aef33d7032bec03f80472d7f04e572dd8bc5723ad25d1588d486035d30efe8caf319625915027f2ba9c40c0de11100a0a2ce1ceecaa6543848d203d81702d50a4fc315d2d16a8cc0ee9e79a2234817487c2b78b3cd3173acb8f00556bd25ce59fbcebf4d117eb9f4ae4b26ca14bcab7800ae651ff12f75095a8ea04677218c9b20d7d0bf3495f00aa72af2b47eb0b7071c08cfcae2e989d11d72c3ca2a4f8483ea62e3b7e32f7dcd11c152160709bd4cb16030dacf717b05a7599ebbc396603d13d77f7c4a67350f24a5696e435bfd9cd8ae24748ed23f2e4fd9e3f6cfb5421d48765de30bc18ee749e24c1442bc4d249dfc13eda617cf9b6928cc3e0f1f131de5ab197b216bf969efa4213adb36c856aa904b3b6a7cd263e4cb0ccfbc55aa0ad277a2591295d7431cecc2c47ffe62a8e9a5d254e2cd25244a4e47213ad8f353a88dbdb3b461c98c183b187755cb9ec0724e31c46c2b57b9013874b4536854ea3586f37dc989e491fd63bc1c121744369d8a347f4c19124cdf4b625cce6cfed67f61d287d717583412a9c779824bb5989ae1793f38a5390f1fcb4cde25b6b33f5da138e5cedafb1a28b6db8f9dc97f9bbf4f60313e77ac9813f7d7480d1d756a59e4680957d5af5f2b8504159bc4ce6ec46c56bbdb0138e31590c818ea3714701a4b83556b022daaad2f591335de638ba8ea557bf3be8d72bff7841962bc5943c92a18b7b4c53f4a279479c2fb6880964bf0d0a83e09c0d798106468f413e6289064a398fcb3659b48d063deea9df7db6990f1f8dcdf77202b73e16a35c7b99128c18e4a65ffa8a1cc92a06c2801f919c645acfcc3aabf8a177c04e05677cb1f601d73226e14f5c15d68caa5bcb95686d72bf3e375a361396f312ef7fd8b9a04f9b2a0cb1533d43f6d65528dafd8cda1e3061d15287b126d5935a927f5e3a1f5d9ffb87ebbb121872f1d1e6f8fa2090659eba0632822bc7d7e0886054c9ddb631d05f67aa5a847ccabb134472da9f7f2dab4a24e07cb428645af3bf2ebc8391e13869484d6a23d81abcc760f209a3c22f006da58035ab2acc68da95c98329fad7d22388871def2ab69e20451cf655dd4866ae11026a289e0254d8ce363787e77053e8769a22beb6df9c7375635221904c5c903119a96b337a8e07cd586210f546f5321106aaa1c4604b3cf12723cc70e4d9319db45b30cea4d121affcf573ed1292a94c61564fbd23ae520123b2420091f262cd429d5c46d068886fc53e5b124ca498cae26ba01560dfa54e38549843ea3dfe6626c15cd05eaa86acbe948db02abcdc9199a506e9fdad4b7d2984392149c538962032b25fbb11938613142d6ff6afe1c6261864dca036ae0bf3d9fb230ae1842f2ddaf7ffe3799dcc2191d08eed0fe92483f7c1f643e89532c77281aeb29b18cf090e8d35fe5589465ff9db8a99f53b6026f3428f7244e896bef4d49b409374ca174ad01076dcb7a254bc2c3ea41f6720faae6c72118fc03fd49dc81c74c07b6d183ecfaa83a54a60ec5c4778c0d56b5a63e0198204c90a1b5a17171f221cad892402e7de5aefa93d604bf7097ce6909ca8179585758706d649be960b42c212aa31c13fd6a7c774308e200e428ad3fb1658a2788e03e8d626172badc78e953543875fb5c55de3f1021425ac864c814f5ef4c425d2a7eb52c74adbc3cf40b74193f041dc1c06a09e3396dc80b1d4ac1f08513cf97231a645926fa7fd511ea9701bbb9ff23bbb4cb3da1afab101e2db8742f1e43ef30628906c5aa0b7ea96ccfe68afefb95fed33f080603382c6baebdb8324041faac495595ed7e2b1a70adcd8e8bc8190bf48aa33ca8e441b39ef5b84d9335545413811f4772965719daab36989983641303d94c6053a90ce15563c71b51d3f65304940cb4ac158077f8e6e33653c56446a9feea103278241cebe409f8cd0f65291b57de6f823e093c66f86331b8859f602ecd81724d4bbe9d34a908df66da62805a63eda1557027beabe28d8de28f11d98f756a94fec09743aa04d9f601ae156787262dba3bba144a4d08f3b0a5043c5d5f8e650a7777d505319b0accdb1633799dabb8419495e85980a6834e8ccdf73cb61b5509263c8b9f8d67b5c7da999653fdabf7b6382e2466a5e5b05f3f574afac41d2456ad4df5d3515799406aa20b47a93c6f6b68fc6d321f25f5c65f81051b4ca9bf4394ba9b833405b0516c6de23921e363e6bf5e5e289900fb5cc99cb94cdaa9f5de2211d15bdf5eff0bb2e3f6e10409c97d5b6cf1f137d9dd5db4eb122f54e897a963e5da0d7cecb0a55c2c5ada903ffc0ff313c770959cfc86e9ab285f7c12afd769b553b2479d33bbc2ee65f67bc725c884bf5e2d2d9d424d61993b2aa4155c03f1ba97133bdfe69af85e97b8c3b350fefb92f11cf34387c47d025bf861a85d3d7be32a9c1ad59217c920d51465a31caac48253e5d0b42f2cbf191a700229085c58f042d6eb187662a33e4c991fd5438faafb2815fda32d1a1a6fb5f21347e6fc566133772f5e07650addf70381edf572d4c651de6622edd18125e3b79fef91302f8b97ada357c30b06830654f8a46cbfed6d21cb058ebb98159cfba24a34f8834d3be4613be8c3ed19517e2f64346dedeefcde7c4d13286f5e0f43aef0d544953672b862e5dfbcb46b537dd2e56edeb0e234d71a699d56b9df7e173b26f4db80d55fee829df6ca49b7891c12b77d3f4fcbbe1cef2bef373f7a38dbd030a8fcb3c47cec8380c23927122c1b1c6eaab69eaf8d1f1db4e3356423a123bb0c06b5a288eaa5f80a18e955d8d23302144fe01aff11b157493143de0b3348eddc016a0b3f481ec524b6a1f0dcfd604c26653a21f2373c7686adf06427739aa25fe6f7983816a857450c73e903d1d32db558fe722539c04fa2ab3cffc74c720ef02389e6197410060e749ae6e698aacb4a0604edab23f25c8a712c5e765aa289692d0ae9ad9855fb720810ce24fc952e4920e5176a239707653b23c1e3ec7cf0aacf9f4751e9ed439ed097353f9a1b9780a3dc4ec4d63d472f1df09309386ecd953c5fc81f6df2b737b8494bb5b9b644e27e07f1b13c072bfca0d82ceb39b0134e47c58718945994cd0cdd7d168b020f37a7bd5004e4226e994726779078ba67ab23cf22fbb0e70c9518a00cc465d519561354d43eaaf1727de017d9ce142192d3020a46c97ec2286c8701b2740cd36dfc5d0bad9a204a41012660dd1b2f449eff527c15f54062177c07c84f97ae09f5995aaad11976a72a55dc64b07823f48eeb68ad336b7bc4d995d38ddbbb37b593be8cb2ae8e4574947c26c9b1a6e04c09e2e2f2eb341f7c496ad0c9a3aac89efe2698c32521d6a41f8cfb38ef0030a45ca470a5475e42267d014b1b6b035030389d7bd5f98992a70a52478a61f504f8806571aaca6a8e1e13ed7866b8a33576de05db4bacb3690a2dfb6a4e80b0a0fdc4e3531c5c08ca570e7571e653bc7e68b1388d972c16d8f6bf5ec3c6f1cf2a073f487375be00e9851e99e949ebde4143856c5b96979c0cb62e1747ed89b17844cc2529fee0dc2315672c931f6bada8a16389acafa8b6c5f4e2f3b1d1650a4a5a930963370c9a9a4eb306e52e6707e5823ace3c5af779f071b05431d6c881766889898068576fe393880b1b4819638a65f65924a7448bc6b678404290194df1a11eabb9090365411f1a9a3c0b724602c5709213a52e8bdeeb8eddc7e4d31aafa1d104d368929d79931d65b9bf382325943c7dfc6938ff14181d73154d946586fd439b6331ebe2ebcb5b19569699866965df45b8df8759694ff1a3df9a773834c9191edcf00b2945db5830434f8aeb08af8dd4e125f50c2aaf4f8a7381f0690c3f36b6100bdb84524531e903390ef66a61008eb873f609368b705bc1ef192b6c585c1b22cb61030f8cbed5e113f2cf478da5de8d6806017cfb08bc4e1b8b8036981af532a188c79648a2df5294ad4574b78a5ec6e6fa50c9cfb12bcc7392568da7baadba36495a635fe47bf1a62c8d3fbb60ef3f71bac6d01824a3c3e350e9f929ecc2db974c98e97c4959eb9c115499e34fb8301577f95f8b264dc5fdd33b834864c3ce221291abd06bd72d660ea67a9db25096bb9e3df77fbc7bf27517fe593e7d24ccc223f5bf0ce87aba4e9b458ed071b422adc84d09ab7e0560f0a6be6ce11f2e3bc021dbf500841d0bcd3c637d3a8df707904369c825055fb73da2df961f45a8899f945f65e5824cda77278185f70532a894a588c3b67688cd23d0a5576e463baf835c49d9db7e3027fb60e2f14428f77da283dacebb77c449996f64cc55af06a124c95d53c8fc4c55d811dbbb86d6858a3bd6434988c2d34cb5af8204b7a4b0d358fbe427cbc39e42fbdf3ec543d9251f8afaf8f6de9d4a4e10b06ed0d71957671e63bb76adb8753e175bcfce8b02db98d0e90ff7d6a41afbca60bce4c9f952643cea2d6fa7a2a790b95ff9d1e6cb5ce46334b2307c72b711d19b3099b9a9ad4d044ad9540ff60637a8e5e6c14d997cbffdcff865679cc96865dbadedb388c8de03ba071ba80f7f04640e88f828f20c1931be77d6a8dadfd0fd7021cee104dc77a9a0d7da8ab1424a9527a6b79a5d6dff9b5af844c9b794d985e726522ce3381164898901d92a0a4eaf97ca1a90fbebf8f3c32d1cfa7c12c9b527c293d8ca04e4a9b0ddecad1bd43b370829867d198b3d639571351dc84b7cb327be4a7ebd35b05995a557780bec72437377d359162685d9bcac1ef46e05a9101daca09033d0cc1cfbe1b45d60d323bed2744dec5a367316b07c557b55302f62e414820d41f4870bd5a36a937e0620c4ae8a3397dd2349cf1733d1cd8ef43e7f7f4b565003ea351ad521e0c3d4d7939604e30b042018b06284178ea6ac0fc8a4f6a410da35da3acd54f3a8060701c5622c7a62690b589a1df15d9915b4ccd265e7acd23e94476b9bc789e2db4cff664c714709fee03af4642306d2d2c3dd3ecf19b3a59559df487599f445d145f2137aa922071f8976159f0d670c091456eda5bdce0f732c7f87e2230d60791c65dbb6842005f6e3f690012b20fd619b019103ff45642c0f85a21d00e116a4b79fd2c8117d4521c19ada7024e73caa994e3dfa2fb37bd28f007e66e32398c0d694d55f8baf40aefc9954897bb10f4d8b53ad98b8896a70289cad673f9856013fdd90cc280c8a50b9e419a6b4f76ca690fce4025d9228660e10a647fe320991cffe4c706a71b3de38c13052d837dcbb4c4377e41fc39ddf118aba7d149ed22e12c0af5d805c26d74dc76f540d6a8ae2e74a5eef1b69ce4da263b4fbc901e8b9652d70627df1dc5f4edef6da6d3e3c321b9083aed7e239060d05231584dc354b8e3fec0a54520eb146d1389c47eb5150ca0d2dc86573bde32876494b42ed1805b042b0935325c8899d4d3ea41820665caffc43960dcdf3d9ea44958cd3ddd0c9934717d18e58bea32e83f275c5bbd0c788a71e0ad808ae9c615ba47182f8f91bc9d2fcb8e3ed528727c6976ea60f8d3af65f98f28d7c5d8af1ea4cf8a28b18011f19d4ab065ec748b8c79574557af7cffad7093084ab7dc2f4934ed1f45b97a4667d6063b2020a6dfce67d51323585ce36f8bf9f0e3b5221c2d9f421c6b5ed0bad796f149c86f71d51195c43be30618db082de76e1b64c071aba9b3a3462fa5a6ef6d7ee46125a363614f9f54adc6341a8a393d0b13d42010d3b4c36b34ad0fff5f8545a61585f8008bf14c641f53fdc3f63e145b1dff15d8728917ce1b72ddd06569d064c077c9de902a3bc1adb518b8366e1399c60a8694b14d9250f12c9ef0d88262f80223951c4efd4916d6065f7ef1a49c0dabce3e4f98133b9b52ef5987808823c8f8970036e5091d1c27494cc3093aaaa76a8ef1fbc81b2da070b9414c025223f9bbc65780beebf5686f0cb7a8b4ed5b49cd1fd16f59998554d405e1622e4bd5e223e91bc73c54a661868db284a7e13632d4f3c1ebdce380d39aaa269eb85a2f8b1c58a161a9a57a72141a4d35ef8a158eb1f06051235eba0584f899becb8abd00dac26e0a9721f6d9469ed1c1fac3cb74e12fad3e44e118253a8a2fb63afbf1f8618970ad78165e1b5663bbbffb21b02689abcffa3636b3aae743aa4c50942078d58b436a8a378fe76533bf966bde8da67e33c1e97a38f1038c639a92e39a826e0cf0f2699fef4cd6fbbb43176e1db93fd1cd52ef9fd8081da9d3f96a68b7384da50fd43e3fc16795cb2b039444df54730c2457848d3a726512396d0f872f462005414c5eecd77ed9de054b56589e4c5a83edf53eab2c1cb8382de35f1e64c99cc4f14b2d3ca2f81296d3800c783f4d3a18a23347678e157f2c65d5b6329e69b49136ff3c6039249933990c08214b49f3294bf753e38919470675300dbfd5d89fedf91406270098c476e4a93953295f17ba42b88051837f020dcb4644e41dc38c83f453ad9a8edc0a75fd59abae636ae00bd98ba608eca2890e0d6d94d25038c2fb863d22d6b52126542bae52ef8fb064fc4cf01b53f56010bf313155724053ea8e3a1f9a77fc3be4dbd74debdbe7a4ba53b61acb51884f862667de9d303e5ac6d6c58d96bb16b0170c0d024f0be2c3eddba495ceca186b9eea214a686f320a734df479238b056030e421375c2478cf693f7af2495efa34298b0f74cf9cfa26faf06225c8b752867bfa1c0d35cad80a71a1f8965691e99956bb5c1ba6864dd56b22be4a1ea4a66c918fe6ee5025d89f75f53e371065a467a11ab35ffa279b95e8be47b5ae5432ae3f02d4fd6c649cfde76d41f2efa46a4cf64562c5bb94f516dbb04045c91d14dc80115700e85ec38935f83cae3d92d6e2877a4d49cd6413c02beb84636a8c225448114b7c9d7b6d794b2b927e1e4014f898f39b96785a7882d66294c68e2f374114ee811729dad3c4e2f4932c27c55998ab04bd54f2ca8a86e9deebde7a9281ca4ddbd5003d7ad11ac981767a0a74bf7dd5a6737c471f62a69286996f5cea771f750cff3bd626e49f2b9e8bb3b5bef2e49feea89b0a0218bde5fedabe2486ff6abc9aca1e5bb65d48ae5fee7e58ef59e0fcba981d9cb1e33b49c96055d409e6ade6532de70341ba241d30c0f9591a52e861d77fd954c2b51d4f17e479dfc2fd0dbd109a375e8754c118e1efad27193cd6e7c61c0c6e32744820ae731468eb198355f141dbaed8e883d0b7bfab184e3f23c3c87ace73deaf193fccdbb1b9275d96f0dec2b912bd45cdb5a3232d77aa95e7ce0e11b690770b7b4485c85705106de591efbd6137a96406346508409f1ead8d31c8a7b9aeffa3c2d8b838b8a19fe59aa57dfd0a7b5e1643a498204f6d9d5c8d4d457c3bfbd5ac1abd58786c92d3bf8772131814f906194c9f122d63f9bf9d9de5f8698e71649519bc34790bba65a1796128243b4c581de488e0103a4b455b2f1b1b0b2ac611f784764e5b780f194b9d1b3de7671392e7d3222731740aa14bac73d0debcb1f85b86419a573b2b0b944ba7ab156c3eda0fd3e8765e5531a17da0625942b20d28482d923f6e6f71df2903d1678f46752e624d7fd4af77390d4450d331b42b19d39b031a791f5e70adcd41c3e7511b762e8f6aaf31f2e362119c45e12fce2c5b31b19a756fc3987fb433d4eef4de1b95da1452e608582ffbd9c6bef103f0391b9119cbf3dccc6ef9ad8844a34404164d201bacb8733a80f4b4975f340bf98fd36d31cfab33d8c2c419560901148d7f23fdd876cd270e9d598077581fa39181a7332d146b624dab24ff8647364ef5fe472380c8f0bc7a81685fda2f61ec944264ab6b5e62cc878cea985483a528fca7d14afc0e4fa1a6ec4e458b83832bcb87c6d3492ae2a23adeb825f4f1004200d23875a6a7719bfc354b21a3228f0bf4430b529da97af7e91d76bb75640a86a0deb7a73287f542f31753c9b4c8b367d51f09208bc27b777ab98bcfc940c0422a9fd1d9934b53662a0adfd61e965163a97f9772e6d406d680924d56284e7ecddb5ab14ac02072e1c35bef815a7e3676bdb309fd7bde6e4c295e7cc223f097c48c69e38175afb7473298cc8f8e6d91a7e5cbef513d3480f118f7021943abce3873134e94eb3e2553ee419245b9984cdfeb420b3601c7cfcf39ad1b370eb654851b0865a1408b2ee49341a10bad14dcbcf9deb451f533c1df5e005eda00ee7c884c818bd6dfa2bb62f4b3bda64df54e63f043418b854eed1c6d4e226b07f68a8360ed6435155d91370bdede8754cb87d19b2e628be3257b356b24c35832f6455c53b0b7ad2c6c5d6b2647545ea243a83d0713707c24050654177caf9214bf12e038fbef80ddd496a1f923087df9b49b800291b4771605897e03da3828df924f444bc359a6ccedb8a8232ab62176f3531df9b0033aeb2ffa7df4aa59b43a05c40e34937e8b5785641dad11eead11c8a5f0bced357f62ada2034c8658a1c1eee7ac21acf59dabca616759fd39403dbf3714783ab65006d1f0ebe6b600209fd80c2fa3c8df38c68b320d6c436c9cfc07f3ecf605a108e8533e7fa7e70d59d1bde24ce390d9747c237d6e00e72eecffb428e13ccfdcfd2400e50f1f07efddc58a1eaa6790affecb81b6206ee252114d8fe5d10a10c83249de44ab4b8fc37e606e0cc1db1875578e5fd70ade7cfcb58bf17a28cfd133758ca1325fa70ba93e4cd4852eaf4e94fba5d6fc389bd503e8ed9bb7273ae402d35b02f1511b6718a322ab7617a91e78eb26f8ac910ece9c599f0ece8ca4922e94c3d1ea5b861825b3e9fbf41ef5e8512d4a2c043bf86e2aba852393d12814c7ffdaa737fde7c49912ae9d34d97706a9436e47e4008b0c965214854eeed2d27e505b118fc0a91599d3ada81fc43f5497c231bf41a494518e208a971f313d3f70c047e7ac8ebf2565198046249fe93ffc88f399d00acf67d945ca5c39ccb21193b9c90da8e9e2d9a157cf85cf6a9a5543b91de1a559445662b95f4fb0d7dea57ff6ef7286e07a8b6a089c78622a95d3c1c996726dd164b7eee7378857b37aacdd145bf264ae44fa51b4228cfad2db2690e4bab1e962b30b5ebd6ff5d456d4ef03df2ab2a57f0c2aae124fccb3c947e2f7795d9e36475c1056de7c72161f4fbbf4a8bb9aa2bcffa0e361cf69aef4941f7c927b168c303e5ad4a58c638ccab3ace9f37f8cd790b39dde1f157eab148158bea19f8641e1cb8960c9e970bdd5170324f28f426a70607693bf30cb0c666d7dbcf44c499800b1e03c5c0d77e4d5aea4d7093981a7c1054c66fabbe4c06de5fcb912cf5f47f4692f172d4c20376ce79175a5dd5aa50874a419346085af7dd1f0812ba263b28b0d1e79c9246aae2ed7f4d950062a7e968377ea9ff363598069b08c56343f43acc422f694ee8d41fc9e5cd2234de3116e304213403528f4df946ac3b9ebbd7f1e909e35d1c5cfe37cc4663103cd1b75bd822845856ab97659d12dcfaf46f1461c09eadb2530104a4d9f4d4f734913a6c7c92fa5a9fb5dd4e0e40c81760591dc7148c14fb5b4899210fb4819ad5aba97520396d56b77cca22f2cdef51cf92af24b1ea1eeb59a34fe87547c1d91df3f36cf3eeabdc0cecae4e196750bfdbb749c608af6d885bdd01b34d825be452062a7b1710dd03582c2fb7ab708436bb89e62b794e0bd1822381bf4b4a0ba5d77ffda9cf8f097dfb407336f1d7184ecfbfc26ee6e44b45a7d401a27f4dbae672ae5b8c0f95c008873bd29d49f7bad7003d005089d88528a43f7fe5b3686cb7f8638de618ca810138b98b975225d13572aa3f6fbbb6dcd3017fd9dd6f52c2279acf656a22fc6f9686ac53f2dccac2d4ad9ac23d6e76cf05b4a29813927acd2649bf3151d997101c48d79d77713b4a8795ba6de05c25f4c9d0fe1df7957748acb789dee648259bfce0738fd7255e9ec24e1a1e45b000fd71865d36a979385e1c2a4ffe2cb99a2b4b31e46826370f7ed035eadd5f49dda4bc80c301932be00d5db39f9e17012f6be077ef8197d1b91f226ec0267a525cfc8ba7f0998613a1ea57fc74ccd1c5c941b58bb7edb158d1f64af9230748161b32af78b48c76912879ab3fe8a73ec462256d6eb2b4b287ad5f8b9f2ea0f4eb7a572b14722d7035917ae89ae948025bdfe38cf55afed6d25c36463980766be96acba9d2d82e24d3801820e244088272dcf7f61fd982a7028eed72dba5e6b73751d046727ee791c167bf7a0dec8485b374ec3817db0a5ab404ca252cf5e8749713155e35755f3d28f54fc593ffb0af7a18a8298376eb366ae9cbbdcbbcf008de90f218d6d7aaf993d799d1f97d274ede6da7cdf59945f81205e373816ae53cdcdb4dee7fe15d754fc9e93472fe67ba8f9f35158ec546f197bd4e2b07b08f9842084581dcd71a01bbf5571a143334ef52b94b3bd8f8d49b20c76a0f8e283ff91126c3772a6edb33765f6e0de93bb2e7c56dece3eb2f4189005cd8e1a251953d7cc45eb495376d7db93a8c9963ae128fdc8be9803ac11840c53de3e4081ac2af6404ed4b00c9e05ee38bec50bc5f298780e99266d578e931247e1fa8744e67ed299949ccf4dde8e01c2d69723b6e92d5ea19414a8bda877186643ccf8d060112bab60d1a0b8421d56fca06bf34d69613c68fbb2414bb1657d7f9766d84ad823f24ab046f6db1c7b3ad97fecc97fe80a961a9942f79dc0759d25f527827c128cb1912440ba8c63c7a4e7bf0712d80a002fe7ddf2b4c1338682805bb717edec4ce4789d776fabecd8f5b9ba246f099aae92bc81bb8ba42003970a3ead2af1df31e53cfc75e3ba9fed72cb168ddfe80c2dfde7f5109b319f0c9743458c849481d5edf48c5b4d3b0da3fb778437153160ea448ac5a3f60c8c4e6a5a6ff6e32285dcb7321e3e480ffb8ec047fb055e1b44fa7c383d7f494e8665d0124c9684959f15cc6eaf1817247831ac2a77e158cc9f047f04d9d281a7d319d97bafdcc4822e9fef2b3f299a436c10b825362805f10b0fca0e33e047cbba6c4f21b9c5ee0849739a6ed0d6b785663b3e956a86b763a88e827ea6dc536ea534d1a33bb9659b518553774940d9047c908270efbec83f22eafd1a7a1de8f2241ce348c31c105ac773fc1c88e4761cdf49acd74ea7bf7b05ff21d8b840540d542b97f2e03a2db34675d87a8159ed68674daf57be4deeadfc1e0dad2a13bcaaf3e2d3347dffa57263fcd1a595191450d969106d62abcdd69bca7334432fdfefb4397570adcd21968961eee751affb7ded2d11334048e3bf5d000885cf89cd4f9829d582bc9e252fff4bf9c04185aaf0f827d6ec0c27d0178ca4fa4a56f6938fb7746b3c98d07f78c2dfa3e89a9fc818d18469dacb817398a75b764f6c300d9cedd69a05886ff730546d795f5249ada5d2f5bf7978a1a06e91d9a388a0d767019466fd285e8004cd28e6d1c3837eb2537b47bc991f2f6f0644d4e1be6abf8ba9b9415350ce5352be098a44e47c668c703f5901944abb707f6c34cb3d0de03ad2a6d67004babe20316bf7d5659a105001652ef1bf3710917751ea73394ed34f1354221132c959f2e8f8a50c0065458e7e5f8dbbea9673b99dae9839f7f9f4fa428161c1d8e1d401f295b0ee2e1f9e14190c0269c3daf8e23d4bc7677d51851a081583b4ea1968db91819d32b7b37d6fb6686a988914fbb77d96643eadca513b344b6e601281701c07e9b3c81e188376c168383698750f8a4bd34dffcb300ed866fee25c170ee439ad6990844b53189431ad96ea9a33377e64d00bede26e3c0ffd62a55526e0c948fb3c22f0e551904c2ba984538f15fe0fdc56b7997161e3059413efdb440a8ba5561650076cae34a9740aa591e17f394fb4675475b92c6cf2b2e53b96746e4dbfdf0cad59b14a42d15567d4ab1d5a157856939c623a75e4417143cf41eb444d17678b54f3f99cb344e114e01cb0167e25cd9bad739cb72881b3ac2ef49afa3fe6e43b4e21310e569a0b95e9bd1a4de62e51759a442f6b7eaefedb78c17af420ade42ef8e8bd5e745ae6a4c3db03b1ccf57a453521e71f74d60a1b44bb9810bf0dbcc9505b1876dbe0ba9a19cc42ca80699e6c61510d71b2ff7d5c1920b487c120de6ef86458cd170a07973ce722c199cb2f825c38387425c97e259b94da761032e02916e70102895d2a23d1bcbf5163acb8c667410c189ece36b5aa237a6815724916a32f599bd479a155079ad59159c4013a0ea1aba59469f441e5e33751d46871d2910d339fae09cb7f60d540e035d024d7dea269300e7c11e7b1e7fc0870844198e5d3b65f97b313422d5c56693db1cdef977881ab09a92648bbe5bcd16661bbe20f3cf77054d6e4e6e9620b805b03013baaafefc7d08df4e84b144f449ea8e525af5e340f3549719e0fd68be3d61943215ca2e1addf709398dadd9dd4811f6fde84c7608bd66e591241de74ea21fab2e3f1372f5986d2f83495a5b74823bc4513cd75abdced69f38da05fcb4f242cd18bf5b1dd9c49209fcc6c60ca592dfc04d54e018c519138e89d13d550e008392dd0c9a173adbc121b9f19b36fe0cf2b1dc4701f34841348268a54ad818f43d4b77c59a0ce5aae7f01cd0c8e38969b68af8344137f9c905775f461b48e82046b0602e2118b17f53834e2e6e83611675c9ec2e1765fecf88db74444cd6d732e7129559db574c901a524b92cd123e386d829baa5d61c8e43468980c149cf5c03f4d780d8a3f10f57e7b420c0a284169473849a93e6ae0f90551e1d04ad8f2052cf91f5969a6bfc182a1af1f7cbf4802e5d7ac8ae9071c9f97087f68b9292cd751613373e69d30d511237b9b465eab0c51f8b6e119a6ed43539250fa7b52154e6354c5b9a15c69bdf0913e7fe072b1022f3f93af79f8340eba72434374d0334c06e7a74cae9d29f2ae169496d360d36db9cf8b2bda8aaf0299016d1a1388d2f2d840ccc597763ae50021a9c5356acdd677897c770f75ab34a31e13fa6f89bce2cd834f85af255eb7599184469e6edb4d0be0ba23262ee495ddf6114640b18469127fa1d6beca2b70e0395700035d7427b7fc16116bf186f8f75ba1fcd4c46b034ed6a1874e173dd7d16de9646cec6bbc5699132731af86fe74f229a48c202bbfeb035dd3faa8025c582376c95d3f1716d293a23d2edf2269dd2a8a40a51ca57d1ffcd24bc03ae883ce20d2e8171308ddacd1b83a07f9b65b4efb5f7a881e2f5245bd09cb24f9f72155d21d5f99f4df649c603b5413002ec45d025488dfd0320bd0ea5eff08d0c8df906fef3157dc36392126da1dc827af6dfd0785f7c11efba63d65a63bb19b9f1015c6d0ceb3eb053fafd11b2952887eb1f2e67a87e25c3d54f8587c3a391b0e3dcd97ba0927d2be661ff45bbc26cb775cd468de1a62d6aee45a871114b43cb0c769107a526c9675e14ada914751ad72c029a8600c4898d4f20335b927e91dbafe0fac02593a65623bcb1bd2975b3921ec1a844a61e3e9fe7b69a864a064d1dadbcf188c3f43cc90b8e3aaa38ace9866339188c62ecb2adc003e0e2c5a75fdbdb64c0def5dad3c6516076779d0505b42ede58666d7023751e52f562aa09c3375aa567c1bfaf8dc2d88f1dcf0f13ea3261cc5aae0db30dc462836f307249a458a30ccc5cebf4e37f95f53ba1fb2f4fe5996bcd270e4c9e2b003c3b655fef5195dffba8c4a8b425d6c0dfba18e7dffa429d58b12f20101ad0ef704b1b19b447fcfd2917e2aa10eacb4741843752d0baa0632dcf04822f571505c972a0afbeb30e3d7b42f7493552148ae892bdc313ab697d53665be4d1dbe6ae1dc5d5a35210af8bd5686455fc9e140da7d50e7ad14246fe5927016ad72454c7f9c903575f89d4d394a849841960f82e5675ab9496d4279bbb76667be51a4b4d8ee2adfbde4c660eb6e6dd8321d9415dbd11790308026bfe9f62bcd91e23f96d8154caadbaf83bda2c9292fbcb4fa38c5e431abd3b09a44ca292503bee506cb297524430ff24fe99c7ba546d3bece8dc07c213d790018d52f123f089954a32b88989dadeb905917d7cf067f7505c3815ae1d4f22d35274389770b3d86b3393659f270d422c44af380e7395d235fdbbc5533444a09c78e247b3a9e5bac1bed8fda190c08a3731a1dddebaa54f09363bf34a412e911eeb485367a2afd22eabcf76646adea2f44e5795c786ae74daf6eaa4ecfb780428d9465aa5ba9745379f2c0585ac8203f9596a0d5d8f143e6df433e6f839ffec1e36cff0196740777f5c388f62f1c140df5afa27d4c1adb8cde6e18da3714afcfa075a6ca35b26cc9c1ae7b1e5814ed557b16588de2e13e19a14c1494c667d175af70b64d1432d460974408441a6091a13b89b6a2447e12b67f977bcd34c8498f6bafa267bafc9556104786ee255b77f5416bf324d5e36487f22c81134c2b9af19cc1d56064a018baec9847999171d3dfcd043be06079072d5d6f137120f7d30a38b0f40a440cd2e8828de8ee974902b9e930ee5de0130af9772fe077db860b01733e4c0209b3d683c1c72e8ce960e38ea476948dc586484c565efe6a10634cd882e1941cb62d91d1127174d1247a06046f3a8503e120a12096b07c7c15af10567e8e2af6a4be5533f2cabed0667c0887943f122bec422d81a77c528d4c1c77ae843bf6fb1005f31bbfa679a563ca7c106e83aa2e40ffdebde262d2328d981581d37cf0d7843ccd2602fe5c301f810563d872ad3c4c64c58b4c8feb4852d265362e0468e88ffb4cc2183dd4664149544041561c46019fe195cebb5bee4d9ccc8adac526c1c13aac28bcb053fe2f3bc3bb996621f497f1ae4db57f6a98d5f8259af5417eb0d741a96e0c231138b04ae419e4dde71fb151cacc4030e6d9d751f5b4c8e85e8bb1962e6f907823310e2b458dc228b385cef82845e4eb4bfa71b72eef6253f2d1913c1e4d0fb949e48280e24517e0dc350dfaf8309f79587ccd3537d49dcc0415cc95a4d9f1d5628858cb7e026c78bd72c0f7b4215b8d7388156ff92e10caaf0c3be7cca5987a95b6b9c8bdb5c82cddd30d0bfe0fedc6a909775cba1b1df1fc2d81fd51d7f269708ca51b6ba33d1b7cb45aae6d75e68710b21ae0ee79c04c48146ed228a11668ef82ce3fddaac8affaeff8d2032c9a2d6ddfc358cf101a7016bb16c7c741981a0b756e6acf96c065fb27601b3f1fcab76b8292f1c6744623d74aa357fe44a8cc9ccf1e60fc4e803294ed4ca9fd225174aa5fda4ac87163a8511e008defb18f9244a977dac62ad230dca324be6363d6c29bdf4eafb9d99e12d2edbc150e575b26f2adfbe15a6c55f90bdd92719010a2b618a3514f0a29411cfc4d4bcc67ff77087eda2133d712cc12bf53d0f88ad6a658a0be1529345c91d016fca10d272f8982b73794669f1cfd7814dd889c615f4125aef3b89eac8d7ed1c20cebce4d6679ebf7c20e801e4eb1e42b4383c46d077de862b1c476b91f4fb9650ef1b2f8a8e06fbcdf8311161bff654d10001c5fd40c2a8f486fe8144e0b0c236d8515b6c7665389dbdd80f70c6d1df78ac44aff42ecd47ae6c786acec912e29f93a52e3e19fe0695edfdbbcf60753029ed241d4e84076b6cd9cb1eae1a6fda9202c640fcfbe61cecd4891954f1d7adad27ad8926de0a565f63af0ad5117d1d89947523cb6e1884cfdf44613322abf443d7cb8439b554721f064313a941cfedffe50f5f9dbc70302b6a998537e12734fb5eca207b8c2fa75d96c67a9cfe27006d81b3a005aaced61868114343a07fd9f5fe5717ee2874850b143aef4ec17fd01470b029f48e6aa2de42afc4b8a7d1fef5e15c41421a7dc6e10fee9403061ed067754318e948caa45e3a0e3df370f3d024b8f086d050c7f9e39469bf581b824fa68fc1539db37c42ae854167042d33282cebcb0fe0646767fd09b1c616df593f0d179432b6004d67575b14325a429a31f175be4625232e7a6be5c37dc3f150ddaca074829a6875ebd080ad29d996c3441d44cc2be19fa671c4c5088a1365d89e427456e345c69441af6ee16ed294c3798b9fd7a83844009e979356ca63a64e4203cbe487e976d3389976e5db7e33ae2f8b44eaae06dbcd6d69760baa93ca9deecd1e71eac7c5a8db803f8379b7dacc3d58b37daa1b1927b1b80eea265415dddc9953bb68823024018251421d5f041ccffb3c99de6df4252a04d004259d850c865928577fb33fd7d86ffc18a25e0520fd3d592603315f100713b35ceb873b3e9ae3eca167051167b714f3f648d12d05474e6fd348b102c5fd4efc48ffc60ff71a3230490514aed38d5d673aca3d3e964dfcf7032a63d78c96188b6901d5fb817ffdc0ced4aca39a0753b939d17944d7c18c2111ab1f9084425f43430a8ad9c76b590359b579c8fb2108a0e748837144fdaf8dc26dc4574cfe7cbfc312c3a4f310acf74380084d0727ed6e77f3469fd1b80eb57114d85ad0cb56ffcb8bb5ffe69c56139fed67dd42e2c4ec2b04145935db603c2662e386b0b55ff4c5a2dda49b6d043cd970d4e138f1a00ab1b8ee4fd39561135ba2e8f0b15459c91b80fcd0ee3d50789780155ae1d87014b5823ec1b12e1b818bb31536c3558ed22213aa921e192d8d572f00a02619dcdeb893a8f589bc7af8962c80a832aa5779ca7db9a7ac8956e0b1477fede1d60d9876876303d9242eefb1ced2f84fce09805c350276477a49a4ef660db21ae2057449fc1bc1985766589b99cc01916ab4a91fed6a31cc519cb6d7ef91e26fae6f6fb694251dc0210788d38016db61eca35a132a944d752de734d53e4caad98ac51f4ccaec54da2ceeee277a5e69ced7fd2e66b923a5861d33f2ac10b7a6053599fde8941c1993bde45628e64823ce7160729cb31cd06fd19c500cff4dc34e0288ad5dd7c5cfd70b1c6c772bbf92d287657ef0813b85a9744aceb70a4107a31d2879ce45fed74240b764af0abf6b02ae0956287f6d19b3000553332c2ef0e5137e54c70fed4b275bdf575163089a98ead07be61a0e39572e8e69bef4fc43e67bd273199e5a275fb7d460697756caa845a3517ba39d5e0b494b8f72fd386366b47448f66b04f55e1c9ce07556a76269a5886edb650ddb617fe2334ff8c7bfa44ba566240f9a498fce37f9abf650415def7591b6ba89dc8be7782b42eac16b97ae8ba48bde310fae713c5bc955256a4f53f00b3468442eb509501b1475389bcaebeaa16602e44e65e5e1d75172bb794cea86c4c260fdc2ec7707d288f6aee06fcce2693c967b5553f73eda9f272c3f7a1b2f7fa3011dcd4e63348364b3655295f1841e5bfa5c3ae82b39678c439c80e6f86b7a5c1865367bc230cbc88af18b5a9eaebfab5ab5cd370d16a7664facc4544b6bbdb8b7f30bc774d5fb583d0df6d79b82d263ded1b04201af13c82af3a63a33b70970136ae13e0dc82f0a6ecc8e8d0457110286dbc8f2b1cc1b1bd7dc84b8d184ced6a13c78fa722eb3f9125443dad6d6ca009160c8c2a945a151fa95ad789b72ce037bc672bcc29c80a104581a0462cbf7973d783fbfe2a1a677d3b9e65b19744d0767fb64ffd6762d6c610f92b29a297f812714f4172bd5f27e94083678dac6fbe663899cb3b70f1a9c81f5544917a89d11726c0d917a78aaf90374ac94420ad961a6cdcaa5719a37fa757559f08ec3f69d6a545579c71793cea546e3459c1891e7e9f9f58625d14356aeb4db5c4642bfb6bc3b2f6f308327c48acf6f518d3d233651fc4a8b29a8016c2fdc0288ae0fd41a732960afef390b9ac0e0eaad0368a6c802b322d3668e1c0c28a8b439fd4604610ae3a92f75a2b3bbbd06e276b75ae7ecc531413178bd4391ba7eefe02abce0a77b5845e0f92c773b8f76bc92a0f2a11b169e90259b0fe941f237b218ca72f7361e0b6777f517188026ec48587b10985837c4cebf739dcb2e555cc2cd04ac705546c78135bdac784b9cffae0debc2d60465fae06baa4816e96701f52e7c32b398f42a2d86774968c48583c88566c165146264bf4553e89441b785c923cd106f2097cd34377c9a35dc7b684b2be712a9286ded1b087805e2425bd0ccc551727b8b3053393e1167450f9975743d7649e1affdc2a059911633a3dcef5cf05115678a7d48496350ee3811d52b8f3d0ccb1e989fb23b802ddc0e5062d30375579230df902aaeda8b4651953ad8017febfea4afff00e796b661b816d8e50865226aa53ac5240163ee990d334e12283264ee830f0a469d55e48f4756d757eef6741518dd3456313c8752ae5efe6a6c9bf0993a7ea320fcbd13488656dd22340af32dfa337d0f6265ea251dfea5d2fbde4917c827f075d1b32c027148b37a3b247520942e9b297e187b54274d97e2754db659e74945a7995915e1c7593a2b511013135eb38e3baa6cf7de3b8342d3c95eaebc3b1e0f7346ff33d6dd80b04468c1528389c7a4762f2bc82d0b3fe19226b52e5c956b94667c6c58d4ece910eb07343556bd72b8b330f8872e0bccda05c57853ee2d99159f0e02f9aae0302c735ad19232ab79ff08414dbd740c7a5ab72d572751ec99fb4c857a920165c60a86d0c817e7e80677a02933b13a8985b504a06f0b0c39f1253fee640108117b27b5f6aa97129d310e66d20a2a22940c20e0c7149ddd467c6684c1d7dc0b18b546bb8bc0ab483eb5ac27aa1a4c7ef35c517e10fcabb1a7cd8201223008b3064cbbf99ad66116136288e40b39c8cd3a459b08cadba50c1915405712206596fc7cfbf9e52bd4eac8297c9ccd397d77249c3f0f3baa88ccbbfe8eca058a151462188ad72e9ce8a8ece1cb626a07c635e7da5b337ed872faef576d600b3378187f48c51bdc70d2a381f724cc2000e71fe24446fbea167918c387b80773ef9bd463a0da3c841d0615f0f9b2d7a4a65c9b70ca55ae2ce0069b0192fd50acd3efde3b26b6f61dd58e22f12af81fc22fbdb89bf4a13cf0ff45fc9ca0e66a84f2f72e766473f28e6bec332a03cfd96459cc097a2e3aa84f08a591bbc979eb5d68a6db82c9e78cd299679230790a765fcae3d36099643727e460b8adbf996473982d08e5ea78742c1e3c9781aac4e59bfe26195a44a3cf163c6929a1740868dd3b87a95ea1abf28c922ae884ddb27a89deceb8f64f0c7aaae1b08a90e6b7ecb275d4ec05edd62bdb647fffa44502963c44900cf63e8234134b4fe6475d684adc5230cdc3d100856aeab618bbd02226e2965f35f8e8cc1079b990fda635b4b5152f1208149d87abda6805da3132c4ac5f29c5346d945d4ac235235b55a38885aa94882667de5d6dc0dd491837d4bcb02b381c3bc75f8b05da02563036daf876aa12cbf1cdf80c75174d7f59056c5ff9a22ef6cfbdf4de860797aafddd80612eef86bb3895ef273d440324297c40146c2d4a3aef79df969d43d22a86ed7b5b3177117585f2b3ea4a8661134985314a13e57bf68bb3dfb8ee7305011386db7fb909ebbd2765f65b0a0c55afc9cd6483d134c857f7459104ef5d6b65e2307c92da8cbc69043f970b9e519d22bb74740c8e04058adf3a5cef312b23a503353ca3e68ee5ac246b937d5dc1377f31b50f35d3a6dbb848da56ff4b5dfce6331c6aaa6fcbb74ed1ab216faa60ec0ee34b93c37c8731b1640e8e6eead1d3a6c391209fb33f4b770b86532744bf02d493ad46ff805f0becf993cca78ac37e4c107a7d5e0ae6cff538d0b5cff4461c8f26c4da180f86f6d131dc61e7dd9913d7ced12b3a50f2c2b9a5a989e0b5255b5e71d4b330105286564649d84e5063d3c7e28e8a912563ab4b47aaf4d9a115582c9d48180f4254e83971236d02a5a835a71c6ff8fff5caa18f52cad37bc4e344ab4e4f4abd3b82110d5757fed5929c1b241ff8e146f2ac72a8161bfe4651b9b584519bddcba2fb459d995d03c0f3d9464aa387eb4e3c8b7332f2932fd5750ca7cc79b5ac53608ac17f5feb87add1a969ffac7239867e8cd92e44ccbbe5b63c6b623c9d9fa2a1c636b5595a7e765233829654665ee82933bf73f7fbcbe27c250a47a5da32424951fc926bd4f688196b20ccc321d8620ce2189f2e52365e5d19acc9645eb268db10be14c8c9af7674dc24c1711424cf7662b023d9d6f23048f1e7a467d85ae9f40716011df0741c56afb9fe4647349d89be9bdd28865628400aabdb7a97e7eefdd4ca3ddac98990a232302c25f38b97e86f1c880e80309d7e159c8ecf42deca3bf083659a1c02f446aa400dae1e4337d57d47e51b8f5dd6a67a843f4423c9b7cea49a909b33f66efcdde02ca77d5baa5fb6ceaea46f576aa56c5ec0cf0a7ed0306088a3c2105018ff8acdf8e75f083e2e933bef7854bf78bb2643d49a74577e5df7d15b4488c915bdbbc825579416cc9fa257a2fde3ec8acde590b5871a0e49d1d59db5697e2fd478517212740ab4999ccf9948c2d1b800ddb8d862b7b88791addfae340efaaf587aa032b1debf9905222b5231bbd2184bc3b94c6ee2236a84f60699782e52e83c26e82df4a9bef90901982606482ed472265f0709f2dd84fa546d9ae9831bf520b15a8d05c4bfa84321486bee94afd86faf0069625f940b04720a4a9ccfa89ba7157df73fb2806828539bd14d1753c9b60af5e5262487848ed4f3a31757999bdd392d530e912f20b566f30dd42afc6b51f09f79e935ed854bee1b810abdfbc8da3d1721ca0326de8b1b0e740bba923be921e68b86304027971894244243cd08328d42446aeac53e9a926a697de3fea2d619e920b23d054518cabea5e36f58f393eecb2841ef24ab21169eaf749e85d3fd6c0f0b9b3e6dac31664410f2ddf67de064283039fb3069a63e8cff39de5440137781945dd2d166aa862497556bc92c82b77e69fffdfd433049ed60fd16f80984e54fbd476a0e5f7fab99ee88e97963c9cac0915fdbb91888bd2636bcdb25702183c2bf3b1bc32b8aec2695c65a45d75f8ef06661aca3952c6897451dbc8d22b1fe6a613953eeeaefdafe971240f16cb4fc096cd4916aa2274bb97c00567e7e75bf90dececa7279d770f52c206353b25ad5e611c0680d9f5493dd6a4b089e8f400b2cc0d27bf6dc7e7dbce87eb54aad1ae94d5c5ac6131489b3734ead33cc7b379900aae71cffca5e6c1f8a5089fd2dbfb9dc3824d7602a1457a3ea15820b0d118df30f78c1c5f478aaf313486f172605c785ef1c812691816b0453556a843f38d11c0812b5e04e810507c319d0accc9ccd55b4c7f8132dca997458c357dad308060d3c3239a0666b3ca1c63e5bf58a2b0269212d8c9227ece9de232e44b07877d8f0ca7eb0eb6cc510322de5d48e51cf12cca4fb8967a9b5e7784aa5a68f6f9f15154ce05cfe569c73a0d2de3942f7b67bf9180bb0589e6db74af9981139fae40fd2f80a1dcdbc56c0aacb91b25b95eb6d8641534502c55d606a39723ddd6726f53d497209c971edaed82b3a2192d8055153808fb38ea7d810c7354f17500ef693a11b79f6555a2f010c9d6c3e8d12f5e97d2b1a977b6409c8c7f3027310f21cb2d368b85065a478b6fd8e375298a922763ff5c1420df32fc909e3d338b60bac71616b53687dfaed7642672f2b0c976db1d2d4606baac3df7c1a6373145c7f4a721e7612f3ffa76236e4f46ecd56b8ee77ff6163ef0c580e32f5e69d6477f3c4d59762dc88ef6beff3c9fbca734d31878af3212dada904b00be8bedcf23be771122f76456fe4d3db8fc10c426d8ad5de552b97ffc0bc761859d468cacdeed6bd00b9dd11b5c57ebc28dfb080f94e3bd1b24379318c3eba866ec63e5076eb05da4d53625e77046f3dbd6bb8ad304a7bad297183eb2acf5708ccddf21f8fa21ab5c76f5c2fa3c98e31b96cebbaff28434beebf054cfd7936a5d3cf43d98c73117e91e8bde647fff314fc6199a27382755a8b7b62d9d4c791af7a90897a6098fe870f18c84c193f2a5e6e2e15cf7946a3cdb5bdcb909892544658ed7d44018dacb18af1a840ac76d6b5b977a50b666ec57c43ed4a5567ba006ef572d2b3ea5e75b43d81be8014672a26bb25fe4914fc64c4193f2997c77f62d9a512cd84be32f3b9703744f2d32333f58d9f453e29e6044035102a6af7c2caca605f6aaf9a76936cb9127de2c2a92b6ca403141ae5c4da5308ef2080cf63de7142def23f3bc801e83ada26f1c51670378ebdfaa13c793979265e3e35f7d37a11581e493c4ef2e072fc7851a0ea721115c95eff5803c2a0fc70ca3bcbed485d05a7fbe2a28ad1ec8af11b638b75c7fdbf45ad57548b5ba90186710b642d9f322a7590260d3d081ec5d9c6c56e7ef78362bf0e23da8c28bdb311dc97eea5ee6408e205ba43ec96f0bf7f3096f69ad23f95e9d0e4599e7afb65f109a8460c4512f2c450308bed52444db94c13ab3653f5a6370ad57cd311aaca715a3163935c8fbbba3079d23c527aad244cf150bd009ede4057e52cbc2e9c117cae45596e724899a3b4c5c5dbc1dd9838bf37b510bf0c649b8a18a0aafd7363d41a238722fde64e8a6bb2e70a4c24ce56d661b4c959bf15409e44b984b1e70190ab421fb3b173e7034d2319209823b5a4bc1bd01cd1ce7b2680d1a03c20aa274c87e8cac7af2c01b34ca33d6e1811034be57b9991455a5694a03a79c6064507aaea3e8b2f71d7c12622a763267fa01d01e8667b44672587a55bfdd681cdebd443f57fde1eddc9b9b679ffd9ef9fc5c51e68f1f936a10548e5568bd629fbcbc01cf0f4041c362aa729f7c4d04f7fe5730cd282552b72fe45d821835fd7e9b69a363f9a54b0213dd50c7ed4e4f4f885acb5a2c1191f1392a466a2ec0c4e48b8740dd257c9e562edbe85b4a1c8eabfd69af3d4917af47307436690ff48831cf1f463f5896dd9ebeca015cdb153f8cc2bac97b82dcbe0350a188937682cabeb75c294c8262b169a258dd783c0b519b0895fc572c340f9ed5bc1ceb111861a19ddea1f25d40bf166ffba0ca11aa9a520132bb574718c45d9f2053982df5f029e1ac9a3588b3ecd9d5a443c8e2a2b54454d7df5e29b58347c0d50aa12b880cf70d4f7ced486b50f5ebfa9937b87813ab7ecc2bbb52352aa41053b34002a5db49853d24c92973c1b8052e6dcc1e6e6ad9f8838d8ca9fc64ea20f2921d0f7fa6677ae4cbcf9429f95983f8edac728563c85cded2598fd9747c8b425da32ce0ccef8b5a75f8775fe11397043a6e973072c651c09f2e1df5c43763010f7cb1a6169d7b64b622bb9b478ce918ff1416a884c45909d2c6f6d1789132121ad76d2c7254f6379fa94c8a7f7cff096b80fb3dfe5ac24d4ad5d4459eb5b85b609427e3d978cd8da3217a4bf7cc050584714f3d7a164feb33977eea87ff234038d2761be55633d6a0bb636a89933501adb4eb120459a95ddce0d10aaff7d6ca8a445382cdcda9a678b996148df445b6f1b2ba8aa24cb54e6025944ea3298c0421f125a3add882d8b003dde9fbbbae4f5b1752c7b77eded07d60f62d1543482cc164e5ecedbda6b76d89cceddc1a6d3eb0d4f5c6ae88346a8a8d5f8247c9c882630b9f400beaf805e12dfabd0c94024d26714e75a4e341df4a9aea0e91fd3615cd15f37bf9c45b35e963a3f57bc2e1e4aa2ff89afbd9c1cbace556784ff33f7680f07b162c8d731f25c62b2b9218c50093fd39bf422dccf6b050235dd63588e4b54073f6a83511d3d18a25bde5a04582fdb7fea8891dacabacf00e1b258171f1042f7c067a4f104eae810e7b44de5f8504863d547d63906452e140491dfcbe4758014e33236d1f5b989fd9a905f9283de4f3ee5334cdc0f8a4dabfffbf69776aec7bd59b004ed8cd2b5d280621e028565e9d40354fd18bf12bd053491ced37f012536cb8506cc4a93ce2a9bb1c8b62a7c685c93cabd63d5ee20b7e0d2d9a061d4fe74d3ddf57057b954daa50905db5c94acd10d2944d5d6a3e266c912292163dcc6ad323a4405a312a21deafb9762b56a5fd859c694d38f28037cb431be8d710de98fd781bcff86312c92fa5806bc8c1e4603d968a6546a199fd85782af5ff3e85f4427b18652f339b2cb8502d84b76b85fe8b8fdb82af71b1e87579a7fc863526539a5ef78cafcf4766a279ab502f77bf38823302fa866d9ec5b346529627f7cf52d8700f15f410ba5accac2c83ba96da3cb50749cfe4b3700cca1091436b3982e26a489340d6551d13138b3cf760dc831f8294fdada83f0eaacba64f8a0a6041596da68a47ffcb07607676d4e0e8e3484fd9239aebf34e411799a0d043dc23819cf55db75bee210450e1be6413934a0877095a485f13baa74a4bbe98fd03d1f7be429b1d7f0e08534205dbf10d22569ae0acd408437799719597809ebfbe6d6bc5623e4381a0fbe258bf986b4784de42ea541292a2c387f8e868a87c356bf23abde90ad0244fd9ca6b7a3912f7949fccb1ae21f8a37f08218eb91a6d672880277d4e9040d1f559b5bdb79ec5b15113841c5744351668e719d550ba7bcb7cfac0850e44a51e227424ee649be5dfa438897bde64ea250021cc92241f9b0a1fea407284f475e4bec62647d45b97bd73324cbc7689869ee15a754e052d03e4f5015647cf4ff11769df19b411193e98783180a2fe0a26b370b6d08b6496efdb02834bc513e5ba4d0fef185c5e3de64ff6031eee319dcf3671e20f39f3e244319277546998a81b1f732930b200c8f6fb20c556c5b850b9fd8fa2b6a8cc127349e064adb2766ab748bb8183db90af11e090d4e6b8c6d9f980c518ad26e2efc872a28294c11bc55a09138b5748d42c0707d905e8efd10c1cb3c6be2339d70196f40712830625df9fd5a64012d706728f2343d0bafc292172ba8595dde5b3d891b12916d54c5f44b77d136d9bee7b0a8de4a15b4025f8ea0a7a8266b92d1ae271222dd72cd8211ba7c241435f2ddc3296079d8b96772c0a9208873d391148215834bf4da0230d90a13df83eb0af663154b0db1f851b8b9027810feb084e0dabd6ac0f7440effbc88c86fb932d5d7965294eadcd9d5032a344b6d93f1dfb477f235d7b08a9e71e9797f80e00c6b10753610be0e253371300fa973b5f2966ffd663ae28c15c7fec67e910afaac6770368fbcaae9f2b1794abe00c0d5fcfdf4c6d57a18a62c0ca39180b1075af8e4617a7740e43230a404a4c768a1656e066303a80415a2a5ea0009b6f27936c67e4e31feddcd4689498f5d7e843d87d4d9104fcbd03e1bf9afccf8f51e9429676ec140d448ea04b2c6a86f276f451a0e65647a033489a9e1d9b7c0ff8498c7298f4fddc9e94a528ab40127d37bcfca37ca2ee15b149d2ef68840484f973f381a539cbde7892516e2d72544fa12b8f8689ddc90aee005e43adab00a5c9624126e01d7fac8b29a76bc0247bffd12ea0a7b3efe75286f2808c2ba860d93db479d44f1c4214c70cf21afc63019808cd9457d90fc77c604c3283255f4e77d84a5ca194a6d507114e4a438509a69cee60475bb7500315f76dc9071b7c69dc0668bef925bdccd84e2cc4373ad9a63bf096b477c7990d48856e9a0f318158f09efa171e70a59045635c7ecdd54048d8c2aff4b59b4655ceb8d8a8702c928e267fa9e2ee7ab334db5c15f6d75084700920e2b15b1df5b3896adfb26f2808146e539f2504d2f0f5336ad0ea319a9443b952d1eeb46bfa0c3601c02bdcaceba0f2b4c1bde24df104d72dea7877dd9d0011518c0205547ece5313069102b3af648f9991ad3bc2e0512e897b987e0fe67d698af1a4c9302e2832c8a13c53d6905f0626d9b8d73e17230d11dfcdf371ecc98af92d8365e04c692b1c855ac32fb177772827130d4c88f58d51ab09441788f144c0bec42c9117429ac67d8bb2ff884b88088a627ab314ac5dc3ec7fa8887505bad85f775c0df1d436223350d2b6d4d7850ba8d2a4c5b83a7b6c260552b09bbbf3f96fbd5d167d5788e69506d04ed006e70c722c9f9003dc925c84143283c721669341d2226f5a67ec5683d3306d734a2187ff969185af0132897120b01cc5d81bf46f379dc5423af55c55540789c3906eeaaf86954ff3bc454c2bd4ea458e814c02c694029397e9db6cfb8b83aaa076e749b6d0018ffe8b2fd88dbd0a773eb7e29717e4b27e9f496f42b7d7c19621061aee5306d7ee20cd4b127076799b05aee394cde74214464228048e513701afa6e502bfd381936cd7153ef7490a58db8f0fd2e491de366b9b71c57d122b9ca91268ad8022c5834dd79db026b4a1e254d0612d47472262a177386e9881b22c678337d35ab8c09a2ca602ae5bc20231ca5cb99ae76feea8afa0ebf91275548e9a38cebed4fe67d97d112c87983d12b881f829b8c8c9594365cd46f02998fc39013c1b4864ce714a244651a1b4168b60003f1f6da8fcc8920fe233f63921c047826f717846dc9c2b4cdb627c884bcabd0960ab9d7ac046397b7dd362aa5e1c7e2e20ffaadfd334837d446879c0fc60c8acb55f11f08d1af0b20910172ef5fe9832d4ef92c4598d86ee711fca58ce1e685f7229de430f663fef397dff5415ecef57481e4c3133b5fda46b8b7658d31496a5cdc542ec362ce15df5e61786b598a69055170df1f712956b2989146c9b1847f82d8083bfcfb7fa37ae356cffb1cf0916cc2a19d26fea840cf54276a1d0214d97cc6cceb57af43d709e6391af4fd8cee84f666e4bf4c027154a6906542258fc878a9d312c18aa365773e94c736d702bf9bc692fd768134c282e3fa72d258de4914f92b509dfea592281c2e87bcbe0c83a3ce744bc9144851bdbb84f8705716c92b98d539f3e035819ab173ab684e53fc3c5983f18289eead525e37dd87e81caa22262b58f056cda2b9a606452d65fce5619ca9d7746636e7ecc1924aa55c7a689a87f2b215b1027637e9c81abe60d2e6e52d7fda7d0e0f5d8a5021c278f4bdd4a80aa0ce1e4c531bcaaca26db2c48db35b19aeb91b0d48ddf5eabb4e2e57c03b9e242d88b38959685985d239e5926592707faa3ce99faae10cf169ccdc9fee85af7bca95bdedcd6ee6a09b966e3c6b1389f789fc0a6abd0ebe2560c14545b59a7c9f379fd0f87f9eb11b37cd6499746ec88ff3b574481d2fccb891174c570436d635d1c9b0a5191c545bfaf716b960eef81d33aaa3c3758c944f703ffe8e3eed34156c9ba79033cfe074b7536d3c1ba3bea487158538de1d002c9654537db5db010129d5a229056743861e8cf3ddf01a03db93da49d279538c149928b97b422f52e6d36bed468337870a53008b683b17081b6e38f8efd987976afdbf4226b55cb7f74c606a31e82d9d49a31da35b13fcf998991e01f22408b4b8547c94cb9eecab5a6019aeabead4d396e959b18b0b6bcd3014c0341d805b5c054a7307304242d3c30bd28234dcaf2f60d365bf9eb80d2aa1abb595d7a62a3d2f5b0b9044837621af75d273098d6d469c16058a4ffa92449255169577cc4d9c3749001e9a8746555b99b734332b5abf7c8ba503ae68d9fccc2ce712fb06f0d22210789400d64a973cb3062ad21b1b281b50e7ed87d1fb2ddd10a6d37437c0952cbf03e6f56ae3f821a7cc623acae7f588ce5891f468ed6c23f754e63d6c44b51fbeb46b64f7ff2cb413acf9ecfefb1568041916e81fc011986a43494bf31b423bc48eb0ab347d1100ab905cca7936ec9706b655b1f0d06c25ecb7c16391a1c479fc788c6f362ef0dc1d2cdc879cf386aaaa219700ac77c5bc9a82c5f29ddf4965911c86a292c9ec66ce1ef0fa5075ce1e3afcfd27b57ccec58d9879259afbdffe7a85b111195aea8db624f6c1b52c01161d424a17eaf2e47bc37fc30c3c0d48224a270fba5aa7dc1bf44cc8118ca9abcd44521d3c02782395e3bc06097262239d8ba0d2861d3690049707693218b5c739c842ed963249d2f46027b286c607212c3eb289ce5aa09987e12ddce1f32018d40c162e5242e0f166582cf7753b92abaf759361fd4d59466d528a2ca1d78e9b938cf88e81ffb13fd8ec9df1f308a0b6bfe2b3eafd60e3667b3e31cf0e0a783c40cfd3f0559c14df2a33e2503f59555efe1e42fbeea909551e248410695e2e7a4f527be3dd4e4f9868caf56346ef767c1c03503fdee6171b1bea6f69c111bf67b8dce10545b013b2807bbc9cf39b62c1621e52e1bf3f6d803812419fe4fad20105580fd5d85dde997e424fa89b847d87e1177fbebfe3979c37ff6ebee750545cfe559e3759f5686b75cac329710ce622792b6110962115eb345e5b7e069a34522065af08adb74dfbaa6b6d7200b140bd36c822d24f4186c0683b3b724b5b3595936a9464fc4e8f2db34556e94970e326fd8af550742be2e9ead349c2afa1d08dee5009e4332270a3d6c0867d538fb27bd79c68dd11f9de160fe3dc1f496361b3161d3e9f9fd2c15ea4f5a37fc873f2f8d388f19bf9b23b862c2fec9406dd3b62b99c1146c6bcbd4a0e157d2a225baaa84fe2e3afa7b156a8390d4a3c1d83865ce9af3b74a5accdc6498dec19d3c2ed90e5bf4e760ffa2af463410d04f2dae112728ec5b6ee6010df0db3d28ce6c01dbd3d5e46bba27ead4bffe09b4f8c6bc937bcaeaf5b807f694e6be636ba24c37da971ad58e26f639c52c9ef69761aefb221dbe3be93059121319c8e79a17a76c4d5b484e80106855107a5958ee91e535c300adbb3ee17671b0e99a2a43c94995d0927d12e3ab5c4d87d72c85ff926e6b60e529993917c2cf7161b868d4993a61421da6f21bd49c11063d73d758e740fcd00f4f42c7a9573868a0c360923f34dc50f3ddd3ae7ebb74a5860a6550ec35490ac26b74f07b1da55c437b86a20e8874e4f47fe11ed7058692875fb2ad07906f275b5d3eb73a031e4d67d0b6c24c63b39787a74432e31bb7fae74e5ff6df19c012180f6b5ce8c10cf2b15cdfd8c93eb3d0367f191efce4af97eef05bee295cbfee72f70e3d572d183a842f6a57e25739cdfff271a727fd991ad68a874ea06b80e0d1585062b6c4546bb28b277bd6c6e95742878d72077399fa66b47d18a7b6e2d17661158dfe0e95b44a26dd9e7b556378dcee62c9defb12489a886bb5f650b9272127eb22fabd606d54d803354f9488ec78adb223980efb105f23a03a60babae662d33fafb176e678b0993f4f09929777d4c94c04f04f1bf77a1e8231c58f9e6828c9d904fb3f9bb902af78be173bae81cd52c9b60285e53c09de34b513e8977006610a289d8c9b13bdf5186c72506b5d74affce3f066b45c74261d4a2f62d36fa1a66702182a3c96560dd6fc0f5a2183684c6290421a35a28ac3aee5d7a402fac979dececa6dd6ebcaff855a38f6812be19b8634b68d666fde39f07f782d3ca3d227e93427b14c76e7a8dd4bf24368b643129cfefc5c14b4a74f3763612e2e13af80c4ce4c5345b6fb2fb8ddf0c37a5c9a0a3db7a2e32d51cb429eea425fa24bdaf5b5204c2702fe480294cb59aacc2aaedc79ea6a96df65303e92720801baad2e31fd12b36d0891986ddb6a372b6fba080ce87a8b5f39a6617c15559cfce56cc0c0e5f0990fc7a2cf78e23d11602e7dcd3936ffece9236e9472fdcc7858e67d4bfd89299e07cb30656f85569f398ccaea0b0ede3b07517a3f63d00d37b6d12fef7b17c44ef751c91b4f3c23664a77a59888159c2d05bd50f44bc4939d9e109cf69ec0f5acfa578484673e98f898c42174e87ab7456c864e1fcf8fd159e97be91ab96ac2d4dc18e9d7faa21e3717f6b9362b3c13384572bb108d57ad04112e87ff0c95b05ad386255d815e99f0b4a7b45013a953417392e4fadf7561aed373206118a6ea1d389d08e7920619b36bc5083617089254178782b578401b96846fe51d14d0c61a759ffb61e5644ada09d2c4f7247316832c98b05319e782f638e656ccf45b9b43a0707254d119043606f88fe7e66de1099e0646ccac270178cc7d06864a02d1c8096bb28d96925a6e7ebea814424f437a5f68e5eeb09f5de328a68a45652e7b7b2958c1c33c7b8a8df7ade694e719e7656b6eff03164a5426b59ed5dc36a9a2504d43c7f6036cda5390ae4c10540a4464a96a276b7ca0a9c22af66d50041980be5b6b9531099402fdc8ee49ac6a5e71fbb6cd1236e9621b88cdd55b4d94b1ede0f6b3ccb0cab1f94a2df26deed66f5c865df8f6ef22480f42d812b4300a2444b06332d910b0182e7fcc50e8900a83a9049538d7b8f49de5bb209e99ba9ee6240073b5f402910eabb67ef720c81319bbaed1d22015d3acaf0891089e36668d79614ed593071081f9720c1d785e09ece3eea32cadb24d9606d3b34db9a066caf3a090d66e851b1a3512a4c8468d1c0ab2f149de73da1ab605ad0296b131d371415dc7dc8fb8fd5a5773e23f3984f88d61e6115208a29e5de7c9cfc7a3e64e65b4d9e658cd56ecc5e72381ee91190ce410689f9001945b5370c516dcd4ec8818bbbad73ec21ee479aaee27740dca935de5777e86eb14851e13b0290bffa95f56af31ea24810176dc24bc1a237e792ede215f0cce430f7cae379ba8aa4bd02969951a0a58a0cca69a4857e536493f96f8e0251a04f619645d1b8aeb6772624c272819b78a36af792763b6439b85fa0ae06eafd7618f13ad323050e3bbb4f7e31d6f5593ffe26f7e99b98c8e11acc84da98fe238264e77d476d065cc10321f6f1ecbd1d34ad89763ffe45fd805e911e9d0b15bf23730f19f0f51af519af481e5dd31de6a50eacb1f07feaff0a459ab5e402040a35c6c5ed897d2bb033d02af006a669f36f0114978d578c0e78dbf34b039294c7990211a0d81c728a6358659dc77a981d1fb744d9fae3567e3357eaedf2463cc2b013edca22126c1b82ca45f1a4fc447f9162acded83d6d32be70f221089970924bd0ab07c4212fcfb5dedae16d2424d42237b35b58fef8eae1e2d524c3e3edd74191e498557403a42ab2197bff4c2719a8efb5c9bea9ea11499540f3f3cfd1157c3f4487c056d1b7b0fa882bc88320a25fba229a6bc15bc1a1c8485fe0943424349db42a9ef157f5b1c676209e2d0b07a2687e0a86cfc277787c5307087d80ca41f9473f3572fad0a8a19a8404eb3ad51accd29e5eaa165881a40ab8e86c39b48fe834594918f4298d2736e6eab3426d3ba2bd69bd35aa7d07802c5c9336a73d2be2e7588f9001014466a36f1672ffc5eba4c2ac684005b5d14b0b32c6eabdf9bd58f570f5d63969e77ef9f159c857c7452033799c0f7e40b6d98bed75e1dbae4a3ec4794adf9611aa9eeeb2ce0e873f15115048c07707afcc59209ed38d3b3f9056f48623887f2fe71d7a84a2b8ad15adddb0dd2498674f55e70087938ae1e42aaafd499ee59be932d87df03d9e8522c06f7b6cb3df0cd3ac9302d08efd24b94a72188489fa76d84226e4eb3a9bc1576678897547ec8bf8e24a0b8259a000caee2f39811bdd780525a5074970fb824fa892c8d87843124d21d18e5cd438d16a3d369d99b44b24355bd23ff771d3d8bb8f5aebada292ee081d63f63ed4796aea78819a314b4580009467dc73871ac9c8a4f1f6b8029158623d8c07a72c85ef7936573119dfa593537a90094f69ba594b949f5d9424602fec90346008a2dd335ae1c0ce2f46f210fd211690cb49816325515ae90cc0cbcb9ea32adf7c319a52c932becec636dc27c6e04373b0d3b7cdd144ef69bbab46ee04eb70e384de4c787746399b9bcb4b481f57d79c78db6a9f8baf59e2861e1bfb1b5574e5159501b30e6a9dc085a5b9cf082ce88031c4575efad96b590421ffabdc6701cc12c6f1526029c6e2ae15fbbc40027c656ffe60cb1df543a056b551950dcaae412be33aa6dcf5e7cfd3f0bc2a5a21c42fb72f38790ee9885ee731b0c41561c05047e9ca3262d012cd086786747067fc0db7644f97cafdf1e2f334f6237b5baff4c639eba036561497dddb0f4c23c487d9e326542a565ced64574e0254c81c70c90db5345296945f9b91aae7e44493e3184d705676fb3f543ea44a6b4e1dd0a1142b8c26b78743a63e9fa1728f1fa7004f1b1a6e25ec88db16e0b84e861e8c174a62e7f274ced9861f35be09dab99e363be745a13758e67dcdd85c1aaf7a4d91093744f2063ea1e24790b0147451fb861429c580bf56a7b230ca7f525e1fc2697b9ddc4800e2b9b02e92977bdd16ad755933173b3cd086fb89f9d35fe15bd64dd750bb9fee7a249187cbad099f1605570caf4eede4b46dc2d8dad68a316c8e3369160c6723a39503f8e9e5535b67dfee4230ca6ee8f2c5ee0cb6706b9b7ca237084ef8ca263ccea697acf846e985db48ab9cf46f75a063e097058a22c58ea27691eab8c0d4db56cc063689f63bceeaabee8c579bcb782ae712b14b10a6d7c8746f9b41690c8a1be72c07148b666abdee24ae4cd0e537a0d98c24c171868d19b53220cf91f6ae736fc1e0f37ea670f866b89af2346c48e90e375629aee3454a975c5448dbe2a91a7cd4bb07f9266b20f7b754df82d531cf25938449c2781f3f8855953f17bbefccb0f0a5766c07ac8b1919e01f020a0f5b2e163472e40a838c563c002b0c89b2120c6e92c7595da139dfa696a1c91f47eedc2d0487efd338e902419257c0fe555bf0071928f0ebe41570f7c9ee1d6b10e8406a3538ca8dc0a3edc93e4fc596cdd8e124c812ec4d9517b4b6c1479bf215589d8c8c60c024cff22421ad40c12d66650d2ee13c3d8f7c08f80564abc30d6065645f00c3e969b5f77011e03bfc9231a1af86a72a8db982cc611d6fae3b0ec2365824a885114edaf729e294ad5137d276ad2b2863dfd696a91bd29799ee71da8e987a414bfcb19abb45387be5e82241a4548c212ab87503d6b9152bdb51c0c3a8667c4cbeeb6821c3e8e984f65470083a62f5bda8c782a58df801a89c392bd6b427ef62ee0ecc5ce4d6d007fb8c53b594176c02cb0341c1b0a4ba9afa57ec97be06b36eb714b8088d76ad8500b12b41541f9a400a9d4a14611a2cf0acf69f396c3336dcbba1a2dc669ae5d18194300475e17f06a1c1f88c44f520dd1f677be65ca48a789ada54dd05034efd42db362ed608012511a5ff79e5bd7a35382257194517d5e5f2bfc2d501736e726e2c36b9504c830f4348695158e9194ef84441809feffabfb5714ee9b6f3d88a78a1e10a7cab5432c2ac59cbc2dac3dfcc362d4d519d6e4c55d4f68d7240466fca69db007746cb923e3e1ecc9e0818cb4d558a6e480466637f272d9bc1fc21042b26bc26b4057514ac905e43cc8c653faff0463eb12de882bc084956f15f0532bb7b76598853fd046c3b69d94e06db95e9797dbc75d7faee0c3697ee277c545720baf72dcdaae1a747fa085265c297614d30ce7c9fa2d663bd66db8575a14a6ce84121cd13a4e28ca094c833b044830790e5b85fbb6912604f401e963afc39506c7048ce4f6eff032c96048f4dd52d98147467163afcadab839819d931d2edcbc946f87e58317bab154d03f9049b30be868573e652e7f5c105fe9bddc0899fa5333fffb720e31caa7cc60dd19cfeb7cfa8fc0b86660be3a66dd33a6c64a5e16c9537b6e82dba445881823129c5d9b6d1c9b633f55b221bcd82c9b8ac80a3f0837de6ee2b528e0fdaff3ca0ad153d0d9d6883e98bec9a1135eda9a2dea1138ace18485a94ac19b439d933c7f21c2df6c50d3c1512d635998de6211784f670d7afc3eff881341c3b9f046e0ad1ce3480aeaad8f054089517e8ce39cff243533a64480dfbbd8b857ee6749689ed35f113922a4c81b8e9951f58446a225ea221bcbbaf4c1226e79f3f70f17d23e034f28037ece0dd8838213551afddc4246b4c564e7b060ce61179536a122498b1652d94c1ba7846b1b88f71c6d5647a1c53a1fd0dbe53275b804a3aede7af80ed90d85eaa160486b956d3c9293fd57ce4a3b0c89f0c01ea7ca5e8642265b49b51aa6675737b14060224d84625dc5bdbddd5b8e94255240dfbd2c1c7cf96e1c8086860c8821aa56c90fc578d6ce001076bc7426429d6c52a76f9c446363799b12360866c919b9c27ab2a89965a8e11abf2b34611d18deb9d9740aa261b5ae51c95245d995787cfc0989f5fe6af7af5ec0049e1b99cae0872c0ea771725ad411c57f72131469dbfb3fb9820c53406163842109bc8be7c95257f5123dbb2bf35056f2a147dc19da4a229a5817d1c6df263b42ba4228d1454fad04e00f720972bfef27f476dcecd32720a67df4ea58624199fc9d27e9570b05d13d0974cec69f74db5e47aac747ffc6a5b964ae90ed27939a9fad0f39850951fcca4fa45a47b65b307ddf2fae708ef9414dc4eff08651fd2380ca78174c1e5651af75a45f9883a58acfd0629e57725115237ace7934cc6c9db23dc1f2f62e139286b72c009ddb985db6503be95508e37f0816bf029828486ea693bde254da9407f7850ee7324e20677376562b1769fb49c72b393bdde7620932b4c51e7ef30aefaee0ee73552db866c057fdc171b47aa321e86fdc8d4313cece25669fabc66464ae6657ad040ebfaae28f4a45f0b1a768bbab59af04780d18af8577989000c7aa02dc55d9d40dc1a7d848b12f6643d4be7279fd3d2950bdabd3d718875cfbe0327cf246286072d92559b135df1a669e1de1d872f822ba8f51e0b1ddfa2bc4051e1ab336d2e8542f7632627f702c6a9abbeec6b0a29ba87593b1b566d5a103fca521bac232fd91a0e434e8cbc72b1064eec6216ab05a27e9be4a6cee9ec4a872c9586fec678cd3b2a8c70b2f6d620fae185dc989b9fd3eecd8dc72b72f2fa98729522eb46b58e16f57b95492fbbcaa33de12911c8bd0d953cf98e2d8786ef5f97be11f9634d3d183d961736347acef1c1bbf707f863a7649103c216b51fe9bb22518d0058006d45fb54bbe5f38abd6e112d25db2dba3ac8f002a5d6bb4422e49a54dea238b975c506dc53b1194b7f13eeab23745da39d383798bf40de895618bbdb39795353725446ea9c5da478ec4458a31ee6140a3857dc30bcbd27d896e396e99c808f1e0912d749c0c399bc728e16faaa964f322e6c688ca726c8d6e81f6ac63d54336dd48f5929c71d31e65946118007e78eef6098540f34dd7b825a494f4efd0ee548542847a3137a67ac3b2b708b5d94f1f256a54d7e72a3e775df83a93017fcafb8ad3b77da55dc44c21ff9536fedf692d4e970f092ec8534c532c0ebd8f93e7f734d807baaab47fb0d5066e56edd7aa84a78c20b50fc1c5ed0f627b4ddab42815df07bf7257496189ae119ccc59a20b86674c05401b1b82fc7f26949a82d4ebd132d0cf697822442cc6cb4f911c5b13abe640acae5988933daf7319f4ae731a5a32b25d67b9199dadd822760e9835f921c3ada1daf62f064496863b4d0e9f9fe6b522c2dfcee6a505b1a316a6babe42918d8e3d986bda2f282470afc8fd47c777e711f80bd3536a7ac5293f0036bf907e3690521beaa0bcae177cb9aea1e6607d65883e2d821cf612ccece57b4a86f28865786191a187d19eb6325c7b5a13114b650010e9f5b57428c22186e3fcfdc16e9804ff369a8a511f9cb6c2b95c0bb8b831cd527312d97230d88ed68130e1f4c3ef68555aa23ddf17d29e9c4c747a1ef9da41cb0d1a0579f9eb78cd1fa4eadddcb69a9547b9ecf43680af3e16d353124f3ce150af29a395b7851ca66ee3df45413371e1a6f797e0f6a2b79a4d64e3f52f5ea08dfd31f206fa97e4b1b356e86f546261ec5f4ee0eea444de099c786ed3f4aefd5d9f3d034e13572334c2bf3a6100ebd85f55fa274d6bf117fe2c4687e8c4eb7abe0f377b2b59b4c89da6a2e11749b371b9511a703b7cebc3a7ece7f9a5f77faf9a04eb0839bc2d1ebc5bc6e0c21b88023f8104e6a90561d58cb358e17e7b8bc445e9495767d013a98c74fc2ce0dc9da03d3d1fc08fef01483ddf8d2eaff746e6e3b3a317bb1c6ee9ff6dad23ec54dcd06d909aab7eab641bf2eb51187e5c7cdd5d5f066b8987039f57e432f8729911fbe5a26dcafbb4ca38670a6e6d76cebb5a298e620a2b97f7bc1d2e0fa2507eceec870c09c5cb36fec0f53b97238b9945aacca0444fbb5140faeedb43cf529494aa45e48b5b30e3b7fd791d38913d147158925c8d6955fe86c00fb90f6</script>
</div>
<script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
  </entry>
  <entry>
    <title>记录下2</title>
    <url>/2022/04/26/%E8%AE%B0%E5%BD%95%E4%B8%8B2/</url>
    <content><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <div class="hbe-input-container">
  <input type="password" id="hbePass" placeholder="" />
    <label for="hbePass">输入密码</label>
    <div class="bottom-line"></div>
  </div>
  <script id="hbeData" type="hbeData" data-hmacdigest="f0fc1b52b81c290a2fa392c209830822f3630f38b80601783e1d5aecc23db942">f52eb17464deb7d951323d6412142093972b99e442cd6fcdcf1ce39eef403470eb90b715056397b2790ee61afd0364577a9aa2b80857960fcb13757b4876a9abee70128ba62c5a1129dcdc9c38ff56e332c177da3bf4b75c3edaab499365d846ef6e615666e3f1dee9145918aeecf0b73a09ee1e1e7fbc2693920b0d3501e58f90b6822c42ed9bfd81fab189461ace1e34850297bd0e5248a551fbfde607ed609289ff1119ccd771b4d963c30bb54eeab1fca820d7078cd4f27416b7c8f265fc54459160a5ce5e0a0ddeb4b896d4bb7201120b34941daf1ac0d58fc5056b26898ca507c6ba4e1ba047277000882564e66a6128811a9810c23cfadb542371c5ae023bd2e29ecf03f624319f3d7f353334790bd3898457a0508bcfc5eb618016ad5365bb9315c71f87cac3eb3c2a874714534e69068279b006f2fa3b8c287e8c0ac32d75e4b4b42220ca37dff4578c1e3773ceb5ca6e3c9e5b9e7616e4b72e55f54ffe77a33a3d02362d00253add029eae8e0da1ec818b8465ea51194ad606e7cdb4cb87272e793a3dc0cd7a6883d731766ddd059e904c35a354e0bec65c061c23309d968ffea7215d74a8e232efca08c1a05d19c512c50f5d43911167447a0f04eaf783f10b93f301016c7d627531e0c3ce538a5a98452a6588a880d51ababfdd725dc0ca0dc71cffd51e5bc0934f098cd5fd64ee672a467e0451ca367f886f09d837cffdb3c33defef4e669e831deb7b2c15b6bbd419a00df683cac0370e59bf8fdc48e3854563c8ae560302058ad3f7c35d36eec51d8e810c8afa32373851808ddeb5494a4fa33d68fa458534fa519c341172fc71f4a4211e3c08203ef9a1b0017db5a7b783ed8131d91b999fa88f457c94315fd3f614da98e667b25bf9a5f27234844ab6912c9f5e5f17dec2d417c87a0ad8fdb9061f288e1553994afa02ad0485372b58d4784de920cabf04beaa099f9e1be664ad6b9fa77575697452dc9c751277d9ff19257594b9555e42e79eff8f21b495910347f1343be68bc782ae5e1805bf94be3529fe36ddea34d536b782c9481356d24e0579380914108ac7dd0ac168e8d0db3572ffc8436d734c696555721e2590e97b4b5276c6978e305291253000fdd48bde62bc07456fbf983f8489200a8f142a4c0422d3172c6610134588ae7f0127fb0d4e408e210dde948f20cc642aaeeb319a1f821dc5137cd87f72b8262dd2932bf8f8b47498fd08e4c0f7d874c613fafda96111889a8bf0064893bd4527cb23b2bf11b5dfa58ae373fb78682c6deab57af66f529936d47da24bb2a9d0e2b5e150993b9d044c40b3f1c8296f4c06e876e3bcfb1c69d859695b11f26e862b6a14f6f66e256490ad95e62e486e1fb884afed813c6854af098f5abdddf93a9285a94dc75c91aabd92270eba977703c88eeb6156a8e3e0234aaffe0dbe3416bb0bae75383f2bf2d448925d836ff30286e2c149f447c9546285691a09eeb6f33bbd854a34cee76b41cd467431a2a02d783199e9233b0b781ede78be7f1d2d65d281dfe66633f2203ebf3080bfb5ca0891e0c712af802c22dd3e5a19c789a09504d0dface2cd38ca289d6b929a127e47287601b72c0e0c5030f118c545285d7f37078336406331fc3ad163b8821684dcdeea52847ea6434528237606f1371586f490532d46c9818605ac4358420ec0ac73100db2351d1c3bb68d87bce520f28eb155da5f669090d3721b43c0fadb2a6939fe2d3cb83ba2cd2cbe711b5b230cfa715bd7699fcd14329e4d70e2f7f055a4b16c3aa7306ce35c576b4ed38e678246171b75322f707d882f97563b8b4c8b97732297caf63705caa4eed3680952e49712d699fe7f99f3b02437f7f40c2215a9e7397c0f7aeee22fbabe00992ff2cde1ebd47eda14d8e8b8a020c5159799bca8972b189fc024372d22d269f5c6483e1afef4dd1d3bdddf4c4c78a4e9821e8f3ea6158da068926d0265c9a0319a3c7009bc8b44df2ed7e2bf1cfc135abd1be7ec3fc78a887b5084e4a7c2110f264fda39e48de07dde869802636c11e39664fe33abe3820475788a3f0dcdfd3633251abe1216ce0ece7b374bb2a09b8ae71899f750ae5c6f0875e532e113ec124018df3e75865aa5b0190e1044077e4fa438cd00cb9c1cd8c6f2d8da6c218fbbd5a3b30560588484faf0f0e789ec2028f51d330dc6c71d20f7c28ed868e8ef1f57aa5a5f0f7d074405f7d887762961f81063f3fea403f642c1de5e3db8d79acd71d94934e05c53868e7e9593f87e14b5a266eb864104aae1f54fc5eca109504f0133b1d0a0057af96f752478d5fce19b114160a361258df081ae25b715267b9b9f3afac0162dcd04551bd963d321397481512606d4cf5a9eec038de1d2102c2b48f9a562492ccb6c60097aa5563d20499eae2e1ead22f04597f4243f8fc7892498d8881308a26f7f3dae3461b2ff18784a82c60ab7c43d299b6f2db1adea3b36b6c0f7737302733ca98267a7facfc3b80787f66c3ed5afe9f9a5ca967254d76ac2f07f2b0e204a6addda472944661412cfff1c2cb7478256885203098b3164dcd7b2d66286635e83f155f3f84070168e12222bb46bd5ba062bcd58432a4c702fb01d6ed59b0fc9915b9203019b09bda1e6825a087eb6e8ee16f3b859505fcc35ddb1b4c0ddfdc3e0fb377703458cacd63139442054898738cb921234fa5c53e9c31f3c1c87d9c127544a2c51bd56dbd590bd9fd1eab4e1f8395a7de2ba75981f8ec72f84542b4b1c2d6dfb44a8e985c6592b60a40084710d5c7d4b51e3e456d6f27a84a5cf84157f87cc440b0cbc0bf1d44717f4e018e569708c8efd6f9e3804ecaf43c9ec17a9a6b7d70d8913dcaa14ddea84331bdef603c96e7d63863400eac7638071da015a460400ff2e5f8a8fc574ae6bb8755d66b8a92af46711c4d2ce41a044fd976e719e0f8753f1828c8c47d5ef2abd062d61818e7608a62f6ced71e465a8c7fce2f363f84d0a2c83fce32e6bb2b4bf681b955ecd282e6cead5ec8e7c0a4681121988b86b7072c8141e0f7a0ee97bc9ce1b8197aa7001ae0c6b900cfad02bcafc09404a9f0b1fb75c541d6fe43e0a21cf84e2e6daf201dfee143b34cb272be4ec3565eefbc12edbf95918531a0fd7b27aa698a5f236697435eb5a0e20d5daa17c38c2f1d3a17375156f794f8bbf60bb99e42d9d0cb1da11b966b5265a0737845fabd65e8137358aab06dab9a5cf1e0b80b97813098bd710a9d3db727edd363bc6ad34e2a411a75ae5d95551bc799f3ed0a6c6f9f3febab0015e07f9473cb9f3cbab2da2f186504ccd2c40a3975dbb89db414d2bbeaf55aacc6e9d1341c1be70a0580071752d702f9dd06965eef44b662c216bd4624c6d4207e220691b630c694a74709b89f311b2b9e275ddced6ad614282a424a59b3e0c5071ade4ac517beaaa0a707edd778f3951829d3871c4d49e72819a94179cd9162a70bfbc096eaca128e5d26cff2183ae0842a06387e340e230f45105f2cd18211b20a13cc191e888296f95e40e4c7c5bf5c2cad540e34021e38e3537d1332f0feb78e85735ef38f0904a4689be3b819b9d37a0d996614d6f451643e0f5d46841808d564d6f01d0f85fa00d699556e415ba6cc925059d57adb5a93e6099c8a4a22339f3c026af0e3241bff4db60115aed6ed83a729bd8b2d5572c564e22b899a8c9d16b502cae633f5845096153a7c7c8f4b3f9acf620aacc6914ba8f3aefeb89df8fb2f9530a44024299a6b469b351199bffbceb66134334a1eedc4f6ff075859c6430592be0d722ade39c7bbd94a13a2fb80edabc85a5976a497604d8d80e2a247dbd3bc0caf854daa29f069fdc46db4130407cc16c7cb0f4024fadc13f3e57b575968f52bf95</script>
</div>
<script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
  </entry>
  <entry>
    <title>逆向-Frida RPC调用</title>
    <url>/2022/06/17/%E9%80%86%E5%90%91-Frida-RPC%E8%B0%83%E7%94%A8/</url>
    <content><![CDATA[<p>Frida 提供了 RPC（远程过程调用）功能，开发人员可以将封装好的任意函数指定为 RPC函数，提供给Python使用。</p>
<p>比如应用中存在一个加密函数，开发者不想分析它的实现，只是想调用它来得到结果，则可以将此加密函数导出，利用Python来调用它</p>
<p>利用 rpc.exports={} 导出RPC函数，多个函数间用逗号分隔</p>
<h4 id="1"><a href="#1" class="headerlink" title="1"></a>1</h4><p>定义 CoreClass 类里面 4 个方法 </p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="built_in">NSString</span> *)getDeviceId &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">@&quot;e10adc3949ba59abbe56e057f20f883e&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">NSString</span> *)httpPost:(<span class="built_in">NSURL</span> *)url &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;URL: %@&quot;</span>, url);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">@&quot;test&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span>*)encrypt:(<span class="built_in">NSData</span>*)data key:(<span class="built_in">NSString</span>*)key&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;data: %@&quot;</span>, data);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;key: %@&quot;</span>, key);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">@&quot;encrypt successed!&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span>*)decrypt:(<span class="built_in">NSString</span>*)str key:(<span class="built_in">NSString</span>*)key&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;str: %@&quot;</span>, str);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;key: %@&quot;</span>, key);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">@&quot;decrypt successed!&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>现在要在 JS 里调用这 4 个方法</li>
</ul>
<p>实例方法需要初始化一个实例</p>
<p>类方法不需要初始化实例，在方法名称后面加上一个 _ 就可以调用了</p>
<p>JS 脚本: rpc.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;\n[*] Starting Hooking&#x27;</span>)</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">var</span> coreClass = ObjC.classes.CoreClass.alloc()</span><br><span class="line">		<span class="comment">//JS调用OC实例方法</span></span><br><span class="line">		<span class="keyword">var</span> deviceId = coreClass[<span class="string">&#x27;- getDeviceId&#x27;</span>].call(coreClass)</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;deviceId: &#x27;</span>+deviceId)</span><br><span class="line">		<span class="comment">//JS调用OC类方法</span></span><br><span class="line">		<span class="keyword">var</span> url = ObjC.classes.NSURL.URLWithString_(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line">		<span class="keyword">var</span> retString = ObjC.classes.CoreClass.httpPost_(url)</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;retString: &#x27;</span>+retString)</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">var</span> str = ObjC.classes.NSString.stringWithString_(<span class="string">&#x27;testStr&#x27;</span>)</span><br><span class="line">		<span class="comment">//NSData *data = [str dataUsingEncoding:NSUTF8StringEncoding]</span></span><br><span class="line">		<span class="keyword">var</span> data = str.dataUsingEncoding_(<span class="number">4</span>)</span><br><span class="line">		<span class="keyword">var</span> key = ObjC.classes.NSString.stringWithString_(<span class="string">&#x27;key&#x27;</span>)</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">var</span> encryptString = coreClass[<span class="string">&#x27;- encrypt:key:&#x27;</span>].call(coreClass, decryptStr, key2)</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;encryptString: &#x27;</span>+encryptString)</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ python3.8 cmake.py rpc.js</span><br><span class="line"></span><br><span class="line">[*] Starting Hooking</span><br><span class="line">deviceId: e10adc3949ba59abbe56e057f20f883e</span><br><span class="line">retString: test</span><br><span class="line">encryptString: encrypt successed!</span><br><span class="line">decryptString: decrypt successed!</span><br></pre></td></tr></table></figure>

<p>接下来将代码导出给 Python 使用，JS 代码里定义 4 个函数</p>
<p>getDeviceId、httpPost、encrypt、decrypt，4个函数分别代表了调用目标进程的4个OC方法，然后用 rpc.exports 将 4 个函数导出</p>
<p>rpc.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;\n[*] Starting Hooking&#x27;</span>)</span><br><span class="line">	</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getHomeDirectory</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> NSHomeDirectory = <span class="keyword">new</span> NativeFunction(ptr(Module.findExportByName(<span class="string">&quot;Foundation&quot;</span>, <span class="string">&quot;NSHomeDirectory&quot;</span>)), <span class="string">&#x27;pointer&#x27;</span>, [])</span><br><span class="line">    <span class="keyword">var</span> path = <span class="keyword">new</span> ObjC.Object(NSHomeDirectory());</span><br><span class="line">    <span class="keyword">return</span> path.toString()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDeviceId</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">var</span> coreClass = ObjC.classes.CoreClass.alloc()</span><br><span class="line">		<span class="keyword">var</span> deviceId = coreClass[<span class="string">&#x27;- getDeviceId&#x27;</span>].call(coreClass)</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;deviceId: &#x27;</span>+deviceId)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">httpPost</span>(<span class="params">inputurl</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">var</span> url = ObjC.classes.NSURL.URLWithString_(inputurl)</span><br><span class="line">		<span class="keyword">var</span> retString = ObjC.classes.CoreClass.httpPost_(url)</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;retString: &#x27;</span>+retString)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">encrypt</span>(<span class="params">inputstr, inputkey</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">var</span> coreClass = ObjC.classes.CoreClass.alloc()</span><br><span class="line">		<span class="keyword">var</span> str = ObjC.classes.NSString.stringWithString_(inputstr)</span><br><span class="line">		<span class="comment">//NSData *data = [str dataUsingEncoding:NSUTF8StringEncoding]</span></span><br><span class="line">		<span class="keyword">var</span> data = str.dataUsingEncoding_(<span class="number">4</span>)</span><br><span class="line">		<span class="keyword">var</span> key = ObjC.classes.NSString.stringWithString_(inputkey)</span><br><span class="line">		<span class="keyword">var</span> encryptString = coreClass[<span class="string">&#x27;- encrypt:key:&#x27;</span>].call(coreClass, data, key)</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;encryptString: &#x27;</span>+encryptString)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">decrypt</span>(<span class="params">inputstr, inputkey</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">var</span> coreClass = ObjC.classes.CoreClass.alloc()</span><br><span class="line">		<span class="keyword">var</span> decryptStr = ObjC.classes.NSString.stringWithString_(inputstr)</span><br><span class="line">		<span class="keyword">var</span> key2 = ObjC.classes.NSString.stringWithString_(inputkey)</span><br><span class="line">		<span class="keyword">var</span> decryptString = coreClass[<span class="string">&#x27;- decrypt:key:&#x27;</span>].call(coreClass, decryptStr, key2)</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;decryptString: &#x27;</span>+decryptString)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	rpc.exports = &#123;</span><br><span class="line">    gethomedirectory: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="comment">// homedirectory 必须小写</span></span><br><span class="line">      <span class="keyword">return</span> getHomeDirectory()</span><br><span class="line">    &#125;,</span><br><span class="line">		deviceid: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			getDeviceId()</span><br><span class="line">		&#125;,</span><br><span class="line">		httppost: <span class="function"><span class="keyword">function</span>(<span class="params">inputurl</span>)</span>&#123;</span><br><span class="line">			httpPost(inputurl)</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="function"><span class="title">encrypt</span>(<span class="params">inputstr, inputkey</span>)</span>&#123;</span><br><span class="line">			encrypt(inputstr, inputkey)</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="function"><span class="title">decrypt</span>(<span class="params">inputstr, inputkey</span>)</span>&#123;</span><br><span class="line">			decrypt(inputstr, inputkey)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Python调用 cmake.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">bundle = <span class="string">&#x27;com.CMake&#x27;</span></span><br><span class="line"></span><br><span class="line">print(sys.argv[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> codecs.<span class="built_in">open</span>(sys.argv[<span class="number">1</span>], <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    source = f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment">#f = open(s, &#x27;r&#x27;) #打开frida脚本</span></span><br><span class="line"><span class="comment">#source = f.read() #读取frida脚本</span></span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device(<span class="number">1000</span>) <span class="comment">#连接usb设备 1000表示超时</span></span><br><span class="line">pid = device.spawn(bundle) <span class="comment">#启动指定bundleId的app</span></span><br><span class="line">session = device.attach(pid)  <span class="comment">#附加到app</span></span><br><span class="line">script = session.create_script(source) <span class="comment">#创建frida javaScript脚本</span></span><br><span class="line">script.load() <span class="comment">#load脚本到app进程中 这样即注入成功</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#rpc调用</span></span><br><span class="line">rpc = script.exports</span><br><span class="line">rpc.deviceid()</span><br><span class="line">rpc.httppost(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line">rpc.encrypt(<span class="string">&#x27;str1&#x27;</span>, <span class="string">&#x27;key1&#x27;</span>)</span><br><span class="line">rpc.decrypt(<span class="string">&#x27;str2&#x27;</span>, <span class="string">&#x27;key2&#x27;</span>)</span><br><span class="line"></span><br><span class="line">print(rpc.homeDirectory())</span><br><span class="line"></span><br><span class="line">device.resume(pid) <span class="comment">#恢复app运行</span></span><br><span class="line">sys.stdin.read()<span class="comment">#读取打印日志</span></span><br></pre></td></tr></table></figure>

<h4 id="2"><a href="#2" class="headerlink" title="2"></a>2</h4><p>rpc.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//打开URL</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">openURL</span>(<span class="params">url</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> UIApplication = ObjC.classes.UIApplication.sharedApplication();</span><br><span class="line">  <span class="keyword">var</span> toOpen = ObjC.classes.NSURL.URLWithString_(url);</span><br><span class="line">  <span class="keyword">return</span> UIApplication.openURL_(toOpen);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//播放系统声音</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">playSystemSound</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">new</span> NativeFunction(Module.ExportByName(<span class="string">&#x27;AudioToolbox&#x27;</span>,<span class="string">&#x27;AudioServicesPlaySystemSound&#x27;</span>),<span class="string">&#x27;void&#x27;</span>,[<span class="string">&#x27;int&#x27;</span>])(<span class="number">1111</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//导出RPC函数</span></span><br><span class="line">rpc.exports = &#123;</span><br><span class="line">  openUrl: <span class="function"><span class="keyword">function</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">    openURL(url);</span><br><span class="line">  &#125;,</span><br><span class="line">  sound: <span class="function"><span class="title">fucntion</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  	playSystemSound();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>rpc.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  <span class="comment">#附加到目标进程</span></span><br><span class="line">  session = frida.get_usb_device().attach(<span class="string">u&#x27;App Store&#x27;</span>)</span><br><span class="line">  <span class="comment">#读取JS脚本</span></span><br><span class="line">  <span class="keyword">with</span> codecs.<span class="built_in">open</span>(<span class="string">&#x27;./rpc.js&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    souce = f.read()</span><br><span class="line">    </span><br><span class="line">  script = session.create_script(source)</span><br><span class="line">  script.load()</span><br><span class="line">  rpc = script.exports</span><br><span class="line">  rpc.openurl(<span class="string">&quot;https://www.chinapyg.com&quot;</span>);</span><br><span class="line">  rpc.sound()</span><br><span class="line">  session.detach()</span><br></pre></td></tr></table></figure>

<p>本例的JS脚本导出了两个RPC函数，程序启动后执行rpc.py脚本将rpc.js文件注入</p>
]]></content>
  </entry>
  <entry>
    <title>逆向-Frida拦截sub_xxx函数</title>
    <url>/2022/06/17/%E9%80%86%E5%90%91-Frida%E6%8B%A6%E6%88%AAsub-xxx%E5%87%BD%E6%95%B0/</url>
    <content><![CDATA[<p>IDA 里看到的 <code>sub_1000061B4</code>  这种类型的函数是没有符号的，所以 IDA 解析时就显示 <code>sub_1000061B4</code></p>
<p>1000061B4 是 IDA 读取到的函数地址</p>
<p>定义一个函数</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> add(<span class="keyword">int</span> num1, <span class="keyword">int</span> num2) &#123;</span><br><span class="line">    <span class="keyword">int</span> sum = num1 + num2;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    <span class="keyword">int</span> sum = add(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;1+1=%d&quot;</span>, sum);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译后将可执行文件拖入 IDA，显示定义的函数是这种 </p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall add(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2) &#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(a1 + a2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先去掉符号 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ strip -x &#x2F;Users&#x2F;xxx&#x2F;Desktop&#x2F;CMake&#x2F;CMake.app&#x2F;CMake</span><br></pre></td></tr></table></figure>

<p>再将可执行文件拖入 IDA</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall sub_1000061B4(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2) &#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(a1 + a2);</span><br><span class="line">&#125;</span><br><span class="line">sub_1000061B4(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="built_in">CFSTR</span>(<span class="string">&quot;1+1=%d&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>编写 Frida 脚本</p>
<p>IDA 上 C 函数偏移地址 0x61B4 </p>
<h4 id="cmake-js"><a href="#cmake-js" class="headerlink" title="cmake.js"></a>cmake.js</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_rva</span>(<span class="params"><span class="built_in">module</span>, offset</span>) </span>&#123;</span><br><span class="line">	<span class="comment">//获取基地址</span></span><br><span class="line">	<span class="keyword">var</span> base_addr = Module.findBaseAddress(<span class="built_in">module</span>)</span><br><span class="line">	<span class="comment">//函数地址 = 基地址+偏移地址</span></span><br><span class="line">	<span class="keyword">var</span> target_addr = base_addr.add(offset) </span><br><span class="line">	<span class="keyword">if</span> (Process.arch == <span class="string">&#x27;arm&#x27;</span>) &#123; <span class="comment">//如果是32位地址+1</span></span><br><span class="line">		<span class="keyword">return</span> target_addr.add(<span class="number">1</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> target_addr</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;\n[*] Starting Hooking&#x27;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">var</span> target_addr = get_rva(<span class="string">&#x27;CMake&#x27;</span>, <span class="number">0x61B4</span>)</span><br><span class="line">	</span><br><span class="line">	Interceptor.attach(ptr(target_addr), &#123;</span><br><span class="line">		onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;onEnter&#x27;</span>);</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;num1: &#x27;</span>+args[<span class="number">0</span>])</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;num2: &#x27;</span>+args[<span class="number">1</span>])</span><br><span class="line">		&#125;, </span><br><span class="line">		onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>) </span>&#123;</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;onLeave&#x27;</span>)</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;Return value: &#x27;</span>+retval)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ python3.8 cmake.py cmake.js</span><br><span class="line"></span><br><span class="line">[*] Starting Hooking</span><br><span class="line">onEnter</span><br><span class="line">num1: 0x1</span><br><span class="line">num2: 0x2</span><br><span class="line">onLeave</span><br><span class="line">Return value: 0x3</span><br></pre></td></tr></table></figure>

<p>可以看到输入 1 + 2 结果 3</p>
<h4 id="cmake-py"><a href="#cmake-py" class="headerlink" title="cmake.py"></a>cmake.py</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">bundle = <span class="string">&#x27;com.CMake&#x27;</span></span><br><span class="line"></span><br><span class="line">print(sys.argv[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> codecs.<span class="built_in">open</span>(sys.argv[<span class="number">1</span>], <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    source = f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment">#f = open(s, &#x27;r&#x27;) #打开frida脚本</span></span><br><span class="line"><span class="comment">#source = f.read() #读取frida脚本</span></span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device(<span class="number">1000</span>) <span class="comment">#连接usb设备 1000表示超时</span></span><br><span class="line">pid = device.spawn(bundle) <span class="comment">#启动指定bundleId的app</span></span><br><span class="line">session = device.attach(pid)  <span class="comment">#附加到app</span></span><br><span class="line">script = session.create_script(source) <span class="comment">#创建frida javaScript脚本</span></span><br><span class="line">script.load() <span class="comment">#load脚本到app进程中 这样即注入成功</span></span><br><span class="line">device.resume(pid) <span class="comment">#恢复app运行</span></span><br><span class="line">sys.stdin.read()<span class="comment">#读取打印日志</span></span><br></pre></td></tr></table></figure>

























<p><a href="https://blog.csdn.net/weixin_42400619/article/details/113385014?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165544788016782184643503%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&request_id=165544788016782184643503&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-6-113385014-null-null.nonecase&utm_term=frida+%E5%AE%9E%E6%88%98&spm=1018.2226.3001.4450">Frida如何拦截sub_xxx函数</a></p>
]]></content>
  </entry>
  <entry>
    <title>逆向-Frida绕过iOS反调试</title>
    <url>/2022/06/18/%E9%80%86%E5%90%91-Frida%E7%BB%95%E8%BF%87iOS%E5%8F%8D%E8%B0%83%E8%AF%95/</url>
    <content><![CDATA[<p>macOS</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ iproxy 2222 22 #端口转发</span><br><span class="line">$ ssh -p 2222 root@localhost</span><br></pre></td></tr></table></figure>

<p>iOS设备上，查找应用进程名称</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root# ps -e</span><br><span class="line">8082 ??   0:16.32 &#x2F;var&#x2F;containers&#x2F;Bundle&#x2F;Application&#x2F;XXXX&#x2F;XinHuaShe.app&#x2F;XinHuaShe</span><br></pre></td></tr></table></figure>

<p>启动 debugserver 附加到 XinHuaShe 进程，监听 1234 端口，等待电脑端 LLDB 接入</p>
<p>debugserver 主机IP地址:端口号 -a 应用进程</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root# debugserver *:1234 -a XinHuaShe</span><br><span class="line">Attaching to process XinHuaShe...</span><br><span class="line">Segmentation fault: 11</span><br></pre></td></tr></table></figure>

<p>提示 <code>Segmentation fault: 11</code> 了 ，APP 做了反调试的防护</p>
<p>目前公开的反动态调试的防护就 ptrace</p>
<p>启动 APP</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root# debugserver -x posix *:1234 &#x2F;var&#x2F;containers&#x2F;Bundle&#x2F;Application&#x2F;CB03D455-A7BC-4762-84C6-3FAE31A3C67C&#x2F;XinHuaShe.app&#x2F;XinHuaShe</span><br></pre></td></tr></table></figure>

<p>电脑端</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ iproxy 1234 1234</span><br><span class="line">$ lldb</span><br><span class="line">(lldb) process connect connect:&#x2F;&#x2F;localhost:1234 &#x2F;&#x2F;手机IP地址</span><br><span class="line">error: failed to get reply to handshake packet  &#x2F;&#x2F;报错了</span><br></pre></td></tr></table></figure>

<p>修改启动debugserver</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root# debugserver -x posix localhost:1234 &#x2F;var&#x2F;containers&#x2F;Bundle&#x2F;Application&#x2F;CB03D455-A7BC-4762-84C6-3FAE31A3C67C&#x2F;XinHuaShe.app&#x2F;XinHuaShe</span><br></pre></td></tr></table></figure>

<p>继续</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ lldb</span><br><span class="line">(lldb) process connect connect:&#x2F;&#x2F;localhost:1234 &#x2F;&#x2F;手机IP地址</span><br><span class="line"></span><br><span class="line">Process 9824 stopped</span><br><span class="line">* thread #1, stop reason &#x3D; signal SIGSTOP</span><br><span class="line">    frame #0: 0x0000000108c91000 dyld&#96; _dyld_start</span><br><span class="line">dyld&#96;_dyld_start:</span><br><span class="line">-&gt;  0x108c91000 &lt;+0&gt;:  mov    x28, sp</span><br><span class="line">    0x108c91004 &lt;+4&gt;:  and    sp, x28, #0xfffffffffffffff0</span><br><span class="line">    0x108c91008 &lt;+8&gt;:  mov    x0, #0x0</span><br><span class="line">    0x108c9100c &lt;+12&gt;: mov    x1, #0x0</span><br><span class="line">    0x108c91010 &lt;+16&gt;: stp    x1, x0, [sp, #-0x10]!</span><br><span class="line">    0x108c91014 &lt;+20&gt;: mov    x29, sp</span><br><span class="line">    0x108c91018 &lt;+24&gt;: sub    sp, sp, #0x10             ; &#x3D;0x10</span><br><span class="line">    0x108c9101c &lt;+28&gt;: ldr    x0, [x28]</span><br><span class="line">Target 0: (XinHuaShe) stopped.</span><br><span class="line"></span><br><span class="line">(lldb) c</span><br><span class="line">Process 9824 resuming</span><br><span class="line">Process 9824 exited with status &#x3D; 45 (0x0000002d) &#x2F;&#x2F;直接退出了</span><br><span class="line"></span><br><span class="line">(lldb) b ptrace &#x2F;&#x2F;给ptrace下断点</span><br><span class="line">Breakpoint 1: no locations (pending).</span><br><span class="line">WARNING:  Unable to resolve breakpoint to any actual locations.</span><br><span class="line">(lldb) c</span><br><span class="line">Process 9841 resuming</span><br><span class="line">1 location added to breakpoint 1</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;打印调用栈</span><br><span class="line">(lldb) bt</span><br><span class="line">error: invalid thread</span><br><span class="line">external version is 20200929_18:15:57_6075104</span><br><span class="line">Object_Creator constructor</span><br><span class="line">Process 9841 stopped</span><br><span class="line">* thread #1, queue &#x3D; &#39;com.apple.main-thread&#39;, stop reason &#x3D; breakpoint 1.1</span><br><span class="line">    frame #0: 0x00000001b02a33b0 libsystem_kernel.dylib&#96; __ptrace</span><br><span class="line">libsystem_kernel.dylib&#96;__ptrace:</span><br><span class="line">-&gt;  0x1b02a33b0 &lt;+0&gt;:  adrp   x9, 213850</span><br><span class="line">    0x1b02a33b4 &lt;+4&gt;:  add    x9, x9, #0x110            ; &#x3D;0x110</span><br><span class="line">    0x1b02a33b8 &lt;+8&gt;:  str    wzr, [x9]</span><br><span class="line">    0x1b02a33bc &lt;+12&gt;: mov    x16, #0x1a</span><br><span class="line">    0x1b02a33c0 &lt;+16&gt;: svc    #0x80</span><br><span class="line">    0x1b02a33c4 &lt;+20&gt;: b.lo   0x1b02a33e4               ; &lt;+52&gt;</span><br><span class="line">    0x1b02a33c8 &lt;+24&gt;: pacibsp</span><br><span class="line">    0x1b02a33cc &lt;+28&gt;: stp    x29, x30, [sp, #-0x10]!</span><br><span class="line">Target 0: (XinHuaShe) stopped.</span><br></pre></td></tr></table></figure>

<p>x30 寄存器也叫 lr 寄存器，打印返回地址 p/x $lr</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(lldb) p&#x2F;x $lr</span><br><span class="line">(unsigned long) $0 &#x3D; 0x00000001003139e0</span><br><span class="line">(lldb) image list -o -f</span><br><span class="line">[  0] 0x0000000000254000 &#x2F;private&#x2F;var&#x2F;containers&#x2F;Bundle&#x2F;Application&#x2F;CB03D455-A7BC-4762-84C6-3FAE31A3C67C&#x2F;XinHuaShe.app&#x2F;XinHuaShe(0x0000000100254000)</span><br></pre></td></tr></table></figure>

<p>地址转换下  0x00000001003139e0 - 0x0000000000254000 = 0x1000BF9E0</p>
<p>IDA 中查找 0x1000BF9E0 地址</p>
<img src="逆向-Frida绕过iOS反调试/图片 1.png" alt="图片 1" style="zoom:100%;" />

<p>这段代码的含义就明显了，动态调用 ptrace，达到反动态调试的目的</p>
<p>这段函数位于 sub_1000BF9A0 内部</p>
<p>定位到函数右键 Jump to xref</p>
<p>看到 sub_1000BF9A0 的显示调用这地址 start+20</p>
<p>![图片 2](逆向-Frida绕过iOS反调试/图片 2.png)</p>
<p>双击 start+20 查看实现，它是 start 函数，在 start 函数中动态调用 ptrace 函数来达到反动态调试的目的</p>
<ul>
<li>去掉 sub_1000BF9A0</li>
</ul>
<ol>
<li>可以用 tweak 的方式</li>
</ol>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;substrate.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;mach-o/dyld.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> (*old_sub_ACF0)(<span class="keyword">void</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> new_sub_ACF0(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// old_sub_ACF0();</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;iOSRE: anti-anti-debugging&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%ctor &#123;</span><br><span class="line">  <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> _sub_ACF0 = (_dyld_get_image_vmaddr_slide(<span class="number">0</span>) + <span class="number">0xACF0</span>) | <span class="number">0x1</span>;</span><br><span class="line">    <span class="keyword">if</span> (_sub_ACF0) <span class="built_in">NSLog</span>(<span class="string">@&quot;iOSRE: Found sub_ACF0!&quot;</span>);</span><br><span class="line">    MSHookFunction((<span class="keyword">void</span> *)_sub_ACF0, (<span class="keyword">void</span> *)&amp;new_sub_ACF0, (<span class="keyword">void</span> **)&amp;old_sub_ACF0);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>使用 fishhook</li>
<li>Frida replace 掉 sub_1000BF9A0 函数</li>
</ol>
<p>hook.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//获取函数地址</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_rva</span>(<span class="params"><span class="built_in">module</span>, offset</span>) </span>&#123;</span><br><span class="line">	<span class="comment">//获取基地址</span></span><br><span class="line">	<span class="keyword">var</span> base_addr = Module.findBaseAddress(<span class="built_in">module</span>)</span><br><span class="line">	<span class="comment">//函数地址 = 基地址+偏移地址</span></span><br><span class="line">	<span class="keyword">var</span> target_addr = base_addr.add(offset) </span><br><span class="line">	<span class="keyword">if</span> (Process.arch == <span class="string">&#x27;arm&#x27;</span>) &#123; <span class="comment">//如果是32位地址+1</span></span><br><span class="line">		<span class="keyword">return</span> target_addr.add(<span class="number">1</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> target_addr</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ObjC.available) &#123; <span class="comment">//OC类加载完成</span></span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;\n[*] Starting Hooking&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> target_addr = get_rva(<span class="string">&#x27;XinHuaShe&#x27;</span>, <span class="number">0xBF9A0</span>)</span><br><span class="line">	<span class="comment">//NativeCallback(func, returnType, argTypes[,abi])</span></span><br><span class="line">	<span class="comment">//或者不用参数</span></span><br><span class="line">	Interceptor.replace(ptr(target_addr), <span class="keyword">new</span> NativeCallback(<span class="function"><span class="keyword">function</span>(<span class="params">argc, argv</span>)</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;hook sub_ptrace bypass&#x27;</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">	&#125;, int, [int, int]))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>hook.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">bundle = <span class="string">&#x27;com.xinhuamm.d0001&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#sys.argv[1] 第一个参数 </span></span><br><span class="line"><span class="keyword">with</span> codecs.<span class="built_in">open</span>(sys.argv[<span class="number">1</span>], <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    source = f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment">#f = open(sys.argv[1], &#x27;r&#x27;) #打开frida脚本</span></span><br><span class="line"><span class="comment">#source = f.read() #读取frida脚本</span></span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device(<span class="number">1000</span>) <span class="comment">#连接usb设备 1000表示超时</span></span><br><span class="line">pid = device.spawn(bundle) <span class="comment">#启动指定bundleId的app</span></span><br><span class="line">session = device.attach(pid)  <span class="comment">#附加到app</span></span><br><span class="line">script = session.create_script(source) <span class="comment">#创建frida javaScript脚本</span></span><br><span class="line">script.load() <span class="comment">#load脚本到app进程中 这样即注入成功</span></span><br><span class="line">device.resume(pid) <span class="comment">#恢复app运行</span></span><br><span class="line">sys.stdin.read()<span class="comment">#读取打印日志</span></span><br></pre></td></tr></table></figure>

<p>执行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python3.8 hook.py hook.js</span><br></pre></td></tr></table></figure>

<p>报错 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Failed to spawn: the request to open &quot;com.xinhuamm.d0001&quot; failed.</span><br></pre></td></tr></table></figure>

















<p><a href="https://la0s.github.io/2019/03/07/anti_ptrace/">Frida绕过iOS反调试</a></p>
<p><a href="https://iosre.com/t/7-2-0-ios/770">干掉高德地图反动态调试</a></p>
]]></content>
  </entry>
  <entry>
    <title>逆向-Frida记录</title>
    <url>/2022/06/20/%E9%80%86%E5%90%91-Frida%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<h4 id="py脚本"><a href="#py脚本" class="headerlink" title="py脚本"></a>py脚本</h4><h5 id="start-frida-py"><a href="#start-frida-py" class="headerlink" title="start_frida.py"></a>start_frida.py</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">bundle = <span class="string">&#x27;com.highaltitudehacks.dvia&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#sys.argv[1] 第一个参数 </span></span><br><span class="line"><span class="keyword">with</span> codecs.<span class="built_in">open</span>(sys.argv[<span class="number">1</span>], <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    source = f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment">#f = open(sys.argv[1], &#x27;r&#x27;) #打开frida脚本</span></span><br><span class="line"><span class="comment">#source = f.read() #读取frida脚本</span></span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device(<span class="number">1000</span>) <span class="comment">#连接usb设备 1000表示超时</span></span><br><span class="line">pid = device.spawn(bundle) <span class="comment">#启动指定bundleId的app</span></span><br><span class="line">session = device.attach(pid)  <span class="comment">#附加到app</span></span><br><span class="line">script = session.create_script(source) <span class="comment">#创建frida javaScript脚本</span></span><br><span class="line">script.load() <span class="comment">#load脚本到app进程中 这样即注入成功</span></span><br><span class="line">device.resume(pid) <span class="comment">#恢复app运行</span></span><br><span class="line">sys.stdin.read()<span class="comment">#读取打印日志</span></span><br></pre></td></tr></table></figure>



<h4 id="1"><a href="#1" class="headerlink" title="1"></a>1</h4><h5 id="hello-world-js"><a href="#hello-world-js" class="headerlink" title="hello_world.js"></a>hello_world.js</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;hello world&#x27;</span>);</span><br><span class="line">    <span class="comment">//或者send打印</span></span><br><span class="line">	  <span class="comment">//end(&#x27;send hello world&#x27;)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ python3.8 start_frida.py hello_world.js</span><br><span class="line">#打印 hello world</span><br></pre></td></tr></table></figure>

<h5 id="log-allClass-js"><a href="#log-allClass-js" class="headerlink" title="log_allClass.js"></a>log_allClass.js</h5><ul>
<li>打印应用中所有的 class 文件</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ObjC.classes 加载的所有OC类</span></span><br><span class="line"><span class="keyword">if</span> (ObjC.available) &#123; <span class="comment">//OC类加载完成</span></span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">&#x27;\n[*] Starting Hooking&#x27;</span>)</span><br><span class="line">	 <span class="keyword">for</span> (<span class="keyword">var</span> className <span class="keyword">in</span> ObjC.classes) &#123;</span><br><span class="line">		 <span class="keyword">if</span> (ObjC.classes.hasOwnProperty(className)) &#123;</span><br><span class="line">			 <span class="built_in">console</span>.log(className)</span><br><span class="line">		 &#125;</span><br><span class="line">	 &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ python3.8 start_frida.py log_allClass.js</span><br><span class="line">#内容打印太多了 可以加 grep</span><br><span class="line">$ python3.8 start_frida.py log_allClass.js | grep Jailbreak</span><br><span class="line">JailbreakDetectionVC</span><br></pre></td></tr></table></figure>

<h5 id="hook-DIVA-app"><a href="#hook-DIVA-app" class="headerlink" title="hook DIVA app"></a>hook DIVA app</h5><p>app下载地址 <a href="https://github.com/prateek147/DVIA">https://github.com/prateek147/DVIA</a></p>
<p>里面有个越狱检测功能</p>
<p>查找包含越狱英文名的文件和方法，越狱 JailBroke 或 JailBreak</p>
<p>eval() 函数计算 JavaScript 字符串，并把它作为脚本代码来执行</p>
<h5 id="log-allJailMethods-js"><a href="#log-allJailMethods-js" class="headerlink" title="log_allJailMethods.js"></a>log_allJailMethods.js</h5><ul>
<li>打印包含越狱关键字类和方法</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">var</span> className <span class="keyword">in</span> ObjC.classes) &#123;</span><br><span class="line">		<span class="keyword">if</span> (className.toLowerCase().indexOf(<span class="string">&#x27;jail&#x27;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;[#]ClassName--------&gt;&#x27;</span> + className)</span><br><span class="line">      </span><br><span class="line">			<span class="comment">//获取类的所有方法</span></span><br><span class="line">			<span class="keyword">var</span> methods = <span class="built_in">eval</span>(<span class="string">&#x27;ObjC.classes.&#x27;</span> + className + <span class="string">&#x27;.$methods&#x27;</span>)</span><br><span class="line">      </span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; methods.length; i++) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="keyword">if</span> (methods[i].toLowerCase().indexOf(<span class="string">&#x27;jail&#x27;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">						<span class="built_in">console</span>.log(<span class="string">&#x27;[-]&#x27;</span> + methods[i])</span><br><span class="line">					&#125;</span><br><span class="line">				&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">					<span class="built_in">console</span>.log(<span class="string">&#x27;[!] Exception:&#x27;</span> + err.message)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行python脚本 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ python3.8 start_frida.py log_allJailMethods.js</span><br><span class="line"></span><br><span class="line">[#]ClassName--------&gt;JailbreakDetectionVC</span><br><span class="line">[-]- isJailbroken</span><br><span class="line">[-]- jailbreakTest1Tapped:</span><br><span class="line">[-]- jailbreakTest2Tapped:</span><br></pre></td></tr></table></figure>

<h5 id="find-threadTrace-js"><a href="#find-threadTrace-js" class="headerlink" title="find_threadTrace.js"></a>find_threadTrace.js</h5><ul>
<li>跟踪越狱检测方法调用</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//跟踪越狱检测方法调用 修改返回值</span></span><br><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;\n[*] Starting Hooking&#x27;</span>);</span><br><span class="line">	<span class="keyword">var</span> class_name = <span class="string">&#x27;JailbreakDetectionVC&#x27;</span></span><br><span class="line">	<span class="keyword">var</span> method_name = <span class="string">&#x27;- isJailbroken&#x27;</span></span><br><span class="line">	<span class="comment">//通过ObjC.classes返回当前注册类的映射表找到想要hook的类名、方法名</span></span><br><span class="line">	<span class="keyword">var</span> hooking = ObjC.classes[class_name][method_name]</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;className:&#x27;</span>+class_name+<span class="string">&#x27; methodName: &#x27;</span>+method_name)</span><br><span class="line">	Interceptor.attach(hooking.implementation,&#123;</span><br><span class="line">		onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">			<span class="comment">//args[0]:self</span></span><br><span class="line">			<span class="comment">//args[1]:The selector</span></span><br><span class="line">			<span class="comment">//args[2]:方法的第一个参数开始</span></span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;hook success&#x27;</span>)</span><br><span class="line">			<span class="built_in">this</span>.class_name = ObjC.Object(args[<span class="number">0</span>]).toString()</span><br><span class="line">			<span class="built_in">this</span>.method_name = ObjC.selectorAsString(args[<span class="number">1</span>])</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;onEnter args[0] class_name: &#x27;</span> + <span class="built_in">this</span>.class_name)</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;onEnter args[1] method_name: &#x27;</span> + <span class="built_in">this</span>.method_name)</span><br><span class="line">			<span class="comment">//打印函数调用栈</span></span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;isJailbroken called from:\n&#x27;</span> + Thread.backtrace(<span class="built_in">this</span>.context, Backtracer.ACCURATE).map(DebugSymbol.fromAddress).join(<span class="string">&#x27;\n\t&#x27;</span>))</span><br><span class="line">		&#125;, </span><br><span class="line">		onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;Return value of: &#x27;</span>)</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27; &#x27;</span> + <span class="built_in">this</span>.class_name + <span class="string">&#x27;--&gt;&#x27;</span> + <span class="built_in">this</span>.method_name)</span><br><span class="line">			<span class="comment">//返回值类型</span></span><br><span class="line">			<span class="keyword">var</span> typeValue = <span class="built_in">Object</span>.prototype.toString.call(retval)</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;\t[-] Type of return value: &#x27;</span> + typeValue)</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;\t[-] Return value: &#x27;</span>, retval)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ python3.8 start_frida.py find_threadTrace.js</span><br><span class="line"></span><br><span class="line">[*] Starting Hooking</span><br><span class="line">className:JailbreakDetectionVC methodName: - isJailbroken</span><br><span class="line">hook success</span><br><span class="line">onEnter args[0] class_name: &lt;JailbreakDetectionVC: 0x12100c9d0&gt;</span><br><span class="line">onEnter args[1] method_name: isJailbroken</span><br><span class="line">isJailbroken called from:</span><br><span class="line">0x1006e1770 &#x2F;private&#x2F;var&#x2F;containers&#x2F;Bundle&#x2F;Application&#x2F;4259E6F5-A16E-4275-B615-62B05D26F2D9&#x2F;DamnVulnerableIOSApp.app&#x2F;DamnVulnerableIOSApp!-[JailbreakDetectionVC jailbreakTest1Tapped:]</span><br><span class="line">	0x184c926c4 UIKitCore!-[UIApplication sendAction:to:from:forEvent:]</span><br><span class="line">	0x1845c4a80 UIKitCore!-[UIControl sendAction:to:forEvent:]</span><br><span class="line">	0x1845c4dd0 UIKitCore!-[UIControl _sendActionsForEvents:withEvent:]</span><br><span class="line">	0x1845c364c UIKitCore!-[UIControl touchesEnded:withEvent:]</span><br><span class="line">	0x184cd0588 UIKitCore!-[UIWindow _sendTouchesForEvent:]</span><br><span class="line">	0x184cd1ea8 UIKitCore!-[UIWindow sendEvent:]</span><br><span class="line">	0x184cab948 UIKitCore!-[UIApplication sendEvent:]</span><br><span class="line">	0x184d34dc0 UIKitCore!__dispatchPreprocessedEventFromEventQueue</span><br><span class="line">	0x184d397d4 UIKitCore!__processEventQueue</span><br><span class="line">	0x184d30bd4 UIKitCore!__eventFetcherSourceCallback</span><br><span class="line">	0x182224848 CoreFoundation!__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__</span><br><span class="line">	0x182224744 CoreFoundation!__CFRunLoopDoSource0</span><br><span class="line">	0x182223a48 CoreFoundation!__CFRunLoopDoSources0</span><br><span class="line">	0x18221da28 CoreFoundation!__CFRunLoopRun</span><br><span class="line">	0x18221d1c0 CoreFoundation!CFRunLoopRunSpecific</span><br><span class="line">Return value of:</span><br><span class="line"> &lt;JailbreakDetectionVC: 0x12100c9d0&gt;--&gt;isJailbroken</span><br><span class="line">	[-] Type of return value: [object Object]</span><br><span class="line">	[-] Return value:  0x1</span><br></pre></td></tr></table></figure>

<h6 id="修改返回值"><a href="#修改返回值" class="headerlink" title="修改返回值"></a>修改返回值</h6><p>将 0x1 修改成 0x0</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ptr(0x0) ptr定义一个指针 指针地址为0x0</span></span><br><span class="line">onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>) </span>&#123;</span><br><span class="line">  retval.replace(ptr(<span class="number">0x0</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="修改返回字符串"><a href="#修改返回字符串" class="headerlink" title="修改返回字符串"></a>修改返回字符串</h6><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">onLeave: function(retval)&#123;</span><br><span class="line">			console.log(<span class="string">&#x27;Return value of: &#x27;</span>)</span><br><span class="line">			<span class="comment">//返回值类型</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.key_value == <span class="string">&#x27;MT_Device_UUIDString&#x27;</span>) &#123;</span><br><span class="line">			    var newuuid = ObjC.classes.NSString.stringWithString_(<span class="string">&quot;12244386&quot;</span>)</span><br><span class="line">          retval.replace(newuuid)</span><br><span class="line">			&#125;</span><br><span class="line">			var typeValue = Object.prototype.toString.call(retval)</span><br><span class="line">			console.log(<span class="string">&#x27;\t[-] Type of return value: &#x27;</span> + typeValue)</span><br><span class="line">			console.log(<span class="string">&#x27;\t[-] Return value: &#x27;</span>, retval)</span><br><span class="line">			console.log(<span class="string">&#x27;\t[-] value: &#x27;</span>, ObjC.Object(retval).toString())</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>



<h5 id="enumerate-modules-js"><a href="#enumerate-modules-js" class="headerlink" title="enumerate_modules.js"></a>enumerate_modules.js</h5><ul>
<li>打印进程所有模块信息</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;\n[*] Starting Hooking&#x27;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">var</span> base_addr = Module.findBaseAddress(<span class="string">&#x27;CMake&#x27;</span>)</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;base_addr: &#x27;</span>+base_addr)</span><br><span class="line">  </span><br><span class="line">	Process.enumerateModules(&#123;</span><br><span class="line">		onMatch: <span class="function"><span class="keyword">function</span>(<span class="params"><span class="built_in">module</span></span>) </span>&#123;</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;Module name:&#x27;</span> + <span class="built_in">module</span>.name + <span class="string">&#x27;-&#x27;</span> + <span class="string">&#x27;Base Address:&#x27;</span> + <span class="built_in">module</span>.base);</span><br><span class="line">		&#125;,</span><br><span class="line">		onComplete: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ python3.8 cmake.py enumerate_modules.js</span><br><span class="line"></span><br><span class="line">[*] Starting Hooking</span><br><span class="line">base_addr: 0x102178000</span><br><span class="line">Module name:CMake-Base Address:0x100f54000</span><br><span class="line">Module name:substitute-inserter.dylib-Base Address:0x1010ac000</span><br><span class="line">Module name:Foundation-Base Address:0x1834f6000</span><br><span class="line">Module name:libobjc.A.dylib-Base Address:0x196d01000</span><br><span class="line">Module name:libSystem.B.dylib-Base Address:0x1b2c5c000</span><br><span class="line">Module name:CoreFoundation-Base Address:0x182181000</span><br><span class="line">Module name:UIKit-Base Address:0x1b6d1f000</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>模块基地址 Module name:CMake-Base Address:0x100f54000</p>
<h4 id="弹窗显示"><a href="#弹窗显示" class="headerlink" title="弹窗显示"></a>弹窗显示</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; NSString &#125; = ObjC.classes;</span><br><span class="line">  <span class="keyword">var</span> UIAlertController = ObjC.classes.UIAlertController;</span><br><span class="line">  <span class="keyword">var</span> UIAlertAction = ObjC.classes.UIAlertAction;</span><br><span class="line">  <span class="keyword">var</span> UIApplication = ObjC.classes.UIApplication;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 弹窗</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">showAlert</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> alertHandler = <span class="keyword">new</span> ObjC.Block(&#123; <span class="attr">retType</span>: <span class="string">&#x27;void&#x27;</span>, <span class="attr">argTypes</span>: [<span class="string">&#x27;object&#x27;</span>], <span class="attr">implementation</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125; &#125;);</span><br><span class="line"></span><br><span class="line">    ObjC.schedule(ObjC.mainQueue, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> alert = UIAlertController.alertControllerWithTitle_message_preferredStyle_(<span class="string">&#x27;LinXunFeng&#x27;</span>, <span class="string">&#x27;欢迎关注公众号：FSA全栈行动\n博客：https://fullstackaction.com&#x27;</span>, <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">var</span> defaultAction = UIAlertAction.actionWithTitle_style_handler_(<span class="string">&#x27;OK&#x27;</span>, <span class="number">0</span>, alertHandler);</span><br><span class="line">      alert.addAction_(defaultAction);</span><br><span class="line">      UIApplication.sharedApplication().keyWindow().rootViewController().presentViewController_animated_completion_(alert, <span class="literal">true</span>, NULL);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 播放系统声音</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">playSystemSound</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> playSound = <span class="keyword">new</span> NativeFunction(Module.findExportByName(<span class="string">&#x27;AudioToolbox&#x27;</span>, <span class="string">&#x27;AudioServicesPlaySystemSound&#x27;</span>), <span class="string">&#x27;void&#x27;</span>, [<span class="string">&#x27;int&#x27;</span>])</span><br><span class="line">    playSound(<span class="number">1111</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> didTap = ObjC.classes.T1TranslateButton[<span class="string">&#x27;- _didTap:forEvent:&#x27;</span>]</span><br><span class="line">  <span class="keyword">var</span> setTitle = ObjC.classes.T1TranslateButton[<span class="string">&#x27;- setTitleText:&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 保留旧实现</span></span><br><span class="line">  <span class="keyword">var</span> didTapOldImp = didTap.implementation</span><br><span class="line"></span><br><span class="line">  <span class="comment">// hook</span></span><br><span class="line">  Interceptor.attach(setTitleOldImp, &#123;</span><br><span class="line">    onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">      args[<span class="number">2</span>] = ptr(NSString.stringWithString_(<span class="string">&quot;Hello LinXunFeng，点击我来弹个窗和听个曲吧&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 覆盖实现</span></span><br><span class="line">  didTap.implementation = ObjC.implement(setTitle, <span class="function"><span class="keyword">function</span>(<span class="params">handle, selector, arg1, arg2</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 调用旧实现</span></span><br><span class="line">    <span class="comment">// didTapOldImp(handle, selector, arg1, arg2)</span></span><br><span class="line"></span><br><span class="line">    playSystemSound()</span><br><span class="line">    showAlert()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



]]></content>
  </entry>
  <entry>
    <title>逆向-MonkeyDev</title>
    <url>/2022/07/08/%E9%80%86%E5%90%91-MonkeyDev/</url>
    <content><![CDATA[<p><a href="https://github.com/AloneMonkey/MonkeyDev/wiki/%E5%AE%89%E8%A3%85">MonkeyDev安装</a>  <a href="https://github.com/AloneMonkey/MonkeyDevSpecs">MonkeyDev插件库</a></p>
<p><a href="https://github.com/AloneMonkey/WeChatPod">WeChatPod</a>    <a href="https://bbs.pediy.com/thread-265106.htm">破解iOS微信骰子和猜拳</a></p>
<p><a href="http://blog.imjun.net/posts/restore-symbol-of-iOS-app/">恢复符号表</a>  </p>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>确保 Theos 环境已配置好</p>
<p>执行命令安装</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo &#x2F;bin&#x2F;sh -c &quot;$(curl -fsSL https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;AloneMonkey&#x2F;MonkeyDev&#x2F;master&#x2F;bin&#x2F;md-install)&quot;</span><br></pre></td></tr></table></figure>

<p>安装报错</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;Applications&#x2F;Xcode.app&#x2F;Contents&#x2F;Developer&#x2F;Platforms&#x2F;MacOSX.platform&#x2F;Developer&#x2F;Library&#x2F;Xcode&#x2F;Specifications&#x2F;MacOSX Package Types.xcspec not found</span><br><span class="line"></span><br><span class="line">解决：</span><br><span class="line">sudo ln -s &#x2F;Applications&#x2F;Xcode.app&#x2F;Contents&#x2F;Developer&#x2F;Platforms&#x2F;MacOSX.platform&#x2F;Developer&#x2F;Library&#x2F;Xcode&#x2F;PrivatePlugIns&#x2F;IDEOSXSupportCore.ideplugin&#x2F;Contents&#x2F;Resources &#x2F;Applications&#x2F;Xcode.app&#x2F;Contents&#x2F;Developer&#x2F;Platforms&#x2F;MacOSX.platform&#x2F;Developer&#x2F;Library&#x2F;Xcode&#x2F;Specifications</span><br></pre></td></tr></table></figure>



<p>卸载</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo &#x2F;bin&#x2F;sh -c &quot;$(curl -fsSL https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;AloneMonkey&#x2F;MonkeyDev&#x2F;master&#x2F;bin&#x2F;md-uninstall)&quot;</span><br></pre></td></tr></table></figure>

<p>更新</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo &#x2F;bin&#x2F;sh -c &quot;$(curl -fsSL https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;AloneMonkey&#x2F;MonkeyDev&#x2F;master&#x2F;bin&#x2F;md-update)&quot;</span><br></pre></td></tr></table></figure>

<p>安装成功后 MonkeyDev 模板</p>
<p>![图 1](逆向-MonkeyDev/图 1.png)</p>
<h4 id="Logos-Tweak"><a href="#Logos-Tweak" class="headerlink" title="Logos Tweak"></a>Logos Tweak</h4><h5 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h5><p>Xcode 无法识别 .xm文件导致代码无法高亮，需要在Xcode界面右侧设置 Type 为 Objective-C++Source</p>
<p>.xm 文件相当于 Theos 工程中的 Tweak.xm，直接写 Logos 语法即可，编译时会通过 logos.pl 转换成 .mm 文件</p>
<p>目会自动链接 <code>CydiaSubstrate.framework</code> 无需再手动链接</p>
<p>项目的一些配置在 Build Settings 列表下面 User-Defined</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MonkeyDevBuildPackageOnAnyBuild     每次build都生成deb包</span><br><span class="line">MonkeyDevCopyOnBuild    build的时将deb包拷贝到设备的&#x2F;var&#x2F;root&#x2F;MonkeyDevBuilds&#x2F;目录</span><br><span class="line">MonkeyDevDeviceIP       目标设备的ip地址，默认USB连接，localhost</span><br><span class="line">MonkeyDevDevicePort     目标设备的端口，默认22(做了端口映射填映射的端口)</span><br><span class="line">MonkeyDevDevicePassword   目标设备的ssh登录密码，默认为空使用免密码登录</span><br><span class="line">MonkeyDevInstallOnAnyBuild            每次build都将deb安装到设备</span><br><span class="line">MonkeyDevInstallOnProfiling             点击Profile才将deb安装到设备</span><br><span class="line">MonkeyDevKillProcessOnInstall         安装的时候杀掉指定的进程，填写进程名</span><br><span class="line">MonkeyDevClearUiCacheOnInstall    安装时 clear uicache</span><br><span class="line">MonkeyDevPath              MonkeyDev的安装路径，默认的，不用修改</span><br><span class="line">MonkeyDevTheosPath    theos的安装路径</span><br></pre></td></tr></table></figure>

<p>Command + B 安装提示：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Showing Recent Messages</span><br><span class="line">An empty identity is not valid when signing a binary for the product type &#39;Dynamic Library&#39;</span><br></pre></td></tr></table></figure>

<p>BuildSettings-User-Defined 添加 key CODE_SIGNING_ALLOWED NO</p>
<ul>
<li>Debug 模式安装</li>
</ul>
<p>Command+B自动安装到手机</p>
<ul>
<li>Release 模式安装</li>
</ul>
<p>Command+Shift+i，这种方式不会看到 Log</p>
<ul>
<li>查看 Log 输出</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ brew install libimobiledevice</span><br><span class="line">$ idevicesyslog | grep &#39;xxx&#39;</span><br></pre></td></tr></table></figure>

<p>或者自带的 console.app 查看</p>
<h4 id="非越狱APP集成"><a href="#非越狱APP集成" class="headerlink" title="非越狱APP集成"></a>非越狱APP集成</h4><p>创建 iOS 项目选择 MonkeyApp，越狱设备可以在 Target APP 填写目标 APP 的名字或 bundle id，工具将自动使用 frida-ios-dump 提取 ipa 文件（需要按 frida-ios-dump 的 README 配置好环境）</p>
<p><code>/opt/MonkeyDev/bin/dump.py</code> 可以指定 ip、port 及 password</p>
<p>创建项目名为 MonkeyApp</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Config cycript的一些脚本下载以及methodtrace配置代码</span><br><span class="line">AntiAntiDebug 这里面是反反调试的代码</span><br><span class="line">fishhook 自动集成的fishhook模块</span><br></pre></td></tr></table></figure>

<p>项目已自动集成了 RevealServer.framework 和 libcycript.dylib，如果选择 Release 编译是不会集成的</p>
<h5 id="MDConfig-plist"><a href="#MDConfig-plist" class="headerlink" title="MDConfig.plist"></a>MDConfig.plist</h5><p><a href="https://github.com/omxcodec/OCMethodTrace/blob/master/README.md">https://github.com/omxcodec/OCMethodTrace/blob/master/README.md</a></p>
<ul>
<li>class-dump</li>
</ul>
<p>工程集成了 class-dump 导出可执行文件 OC 头文件，build settings，MONKEYDEV_CLASS_DUMP YES</p>
<ul>
<li>增加自己的库 </li>
</ul>
<p>将需要注入的 dylib 或 framework 拷贝到 frameworks 目录下，静态库的话，直接添加，指定 search path，和正常开发没啥区别。</p>
<p>动态库本身的 install_path，可以通过 install_name_tool -id 修改其为 @executable_path/Frameworks/xxx</p>
<ul>
<li><p>集成网络 cy 脚本</p>
</li>
<li><p>更改名字和bundleid</p>
</li>
</ul>
<p>直接在Xcode进行设置，想使用原来的 bundleid 进行重签，设置 build settings， MONKEYDEV_DEFAULT_BUNDLEID 为 YES</p>
<ul>
<li>生成IPA</li>
</ul>
<p>运行之后在源代码 LatestBuild 目录 双击 createIPA.command</p>
<ul>
<li>支持 CocoaPods 集成第三方库</li>
</ul>
<p>需要设置 use_frameworks!  动态库方式，再执行 pod install</p>
<h5 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h5><p>MonkeyApp运行后可以直接断点调试，但是每次修改调试都要重新运行安装，比较麻烦。</p>
<p>Logos Tweak 也可以 Xcode 调试。重签安装被调试的应用</p>
<p>Xcode - Debug - Attach to Process by PID or Name</p>
<h4 id="CaptainHook-Tweak"><a href="#CaptainHook-Tweak" class="headerlink" title="CaptainHook Tweak"></a>CaptainHook Tweak</h4><p>（不易上手）</p>
<p>Logos Tweak 和 CaptainHook Tweak 都支持通过 Cocoapods 的方式集成，记得以静态库的方式集成</p>
<p>所以记得把 Podfile 中的 #use_frameworks! 注释掉，否则 Tweak 不生效</p>
<p>CaptainHook 无须依赖 Cydia Substrate 框架，直接导入 CaptainHook.h 头文件后使用里面的宏来进行 Hook</p>
<p><a href="https://github.com/rpetrich/CaptainHook/wiki">https://github.com/rpetrich/CaptainHook/wiki</a></p>
<p>Hook OC 方法：</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//1.CHDeclareClass声明一个类</span></span><br><span class="line"><span class="comment">//2.使用CHLoadClass()或者CHLoadLateClass()在 CHConstructor 中加载声明的类</span></span><br><span class="line"><span class="comment">//3.CHOptimizedMethod()来Hook目标函数</span></span><br><span class="line"><span class="comment">//4.CHHook()在CHConstructor中注册Hook</span></span><br><span class="line"><span class="comment">//5.CHSuper()调用Hook原函数逻辑</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&quot;CaptainHook/CaptainHook.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">CHDeclareClass(XLMemberManager);<span class="comment">//1 声明类</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//3 hook目标函数</span></span><br><span class="line"><span class="comment">//-(void)loginByUserName:(id)arg1 password:(id)arg2 verifyCode:(id)arg3 verifyKey:(id)arg4 finishBlock:(CDUnknownBlockType)arg5;</span></span><br><span class="line">CHOptimizedMethod(<span class="number">5</span>, <span class="keyword">self</span>, <span class="keyword">void</span>, XLMemberManager, loginByUserName, <span class="keyword">id</span>, arg1, password, <span class="keyword">id</span>, arg2, verifyCode, <span class="keyword">id</span>, arg3, verifyKey, <span class="keyword">id</span>, arg4, finishBlock, <span class="keyword">id</span>, arg5) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;userName:%@ password:%@ verifyCode:%@ verifyKey:%@&quot;</span>, arg1, arg2, arg3, arg4);</span><br><span class="line">    <span class="comment">//5 调用原来方法</span></span><br><span class="line">    <span class="keyword">return</span> CHSuper(<span class="number">5</span>, XLMemberManager, loginByUserName, arg1, password, arg2, verifyCode, arg3, verifyKey, arg4, finishBlock, arg5);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CHConstructor &#123;</span><br><span class="line">    <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;__inject success__&quot;</span>);</span><br><span class="line">        <span class="comment">//2 加载声明的类</span></span><br><span class="line">        CHLoadLateClass(XLMemberManager);</span><br><span class="line">        <span class="comment">//4 注册hook 5个参数</span></span><br><span class="line">        CHHook(<span class="number">5</span>, XLMemberManager, loginByUserName, password, verifyCode, verifyKey, finishBlock);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ZKSwizzle"><a href="#ZKSwizzle" class="headerlink" title="ZKSwizzle"></a>ZKSwizzle</h4><p><a href="https://github.com/alexzielenski/ZKSwizzle">https://github.com/alexzielenski/ZKSwizzle</a></p>
<p>语法接近 Theos</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#import &quot;ZKSwizzle&#x2F;ZKSwizzle.h&quot;</span><br><span class="line">hook(XLMemberManager);</span><br><span class="line">-(void)loginByUserName:(id)arg1 password:(id)arg2 verifyCode:(id)arg3 verifyKey:(id)arg4 finishBlock:(void(^__nullable)(void))arg5 &#123;</span><br><span class="line">  NSLog(@&quot;userName:%@ password:%@ verifyCode:%@ verifyKey:%@&quot;, arg1, arg2, arg3, arg4);</span><br><span class="line">  &#x2F;&#x2F;调用原方法</span><br><span class="line">  ZKOrig(void, arg1, arg2, arg3, arg4, arg5);</span><br><span class="line">&#125;</span><br><span class="line">endhook</span><br><span class="line"></span><br><span class="line">ctor &#123;</span><br><span class="line">  NSLog(@&quot;__inject success__&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：finishBlock 的类型不能用 id 代替，改为 void(^__nullable)(void) 即可</p>
<h4 id="Command-line-Took"><a href="#Command-line-Took" class="headerlink" title="Command-line Took"></a>Command-line Took</h4><h4 id="Logify"><a href="#Logify" class="headerlink" title="Logify"></a>Logify</h4><p>Theos 自带的工具</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ logify.pl xxx.h &gt; xxx.xm</span><br></pre></td></tr></table></figure>

<h4 id="ANYMethodLog"><a href="#ANYMethodLog" class="headerlink" title="ANYMethodLog"></a>ANYMethodLog</h4><p><a href="https://github.com/qhd/ANYMethodLog">https://github.com/qhd/ANYMethodLog</a></p>
<p>用途和 Logify 相似，可控度更高，只需要了解一个类</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* aClass 要打印的类</span></span><br><span class="line"><span class="comment">* condition 根据此 block 来决定是否追踪方法（sel 是方法名）</span></span><br><span class="line"><span class="comment">* before 方法调用前会调用该 block（target 是检测的对象，sel 是方法名，args 是参数列表，deep 是调用层级）</span></span><br><span class="line"><span class="comment">* after 法调用后会调用该 block（interval 是执行方法的耗时，retValue 是返回值）</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">+ (<span class="keyword">void</span>)logMethodWithClass:(Class)aClass</span><br><span class="line">                 condition:(<span class="built_in">BOOL</span>(^)(SEL sel)) condition</span><br><span class="line">                    before:(<span class="keyword">void</span>(^)(<span class="keyword">id</span> target, SEL sel, <span class="built_in">NSArray</span> *args, <span class="keyword">int</span> deep)) before</span><br><span class="line">                     after:(<span class="keyword">void</span>(^)(<span class="keyword">id</span> target, SEL sel, <span class="built_in">NSArray</span> *args, <span class="built_in">NSTimeInterval</span> interval, <span class="keyword">int</span> deep, <span class="keyword">id</span> retValue)) after;</span><br></pre></td></tr></table></figure>

<p>放到 %ctor</p>
<ol>
<li>打印一个类定义的所有方法，包括公开方法和私有方法</li>
</ol>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">%ctor &#123;</span><br><span class="line">  [ANYMethodLog logMethodWithClass:[<span class="built_in">UIViewController</span> <span class="keyword">class</span>] condition:^<span class="built_in">BOOL</span>(SEL sel) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;method:%@&quot;</span>, <span class="built_in">NSStringFromSelector</span>(sel));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">	&#125; before:<span class="literal">nil</span> after:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>打印运行过程中调用了哪些方法</li>
</ol>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[ANYMethodLog logMethodWithClass:[<span class="built_in">UIViewController</span> <span class="keyword">class</span>] condition:^<span class="built_in">BOOL</span>(SEL sel) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125; before:^(<span class="keyword">id</span> target, SEL sel, <span class="built_in">NSArray</span> *args, <span class="keyword">int</span> deep) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;target:%@ sel:%@&quot;</span>, target, <span class="built_in">NSStringFromSelector</span>(sel));</span><br><span class="line">&#125; after:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>打印特定几个方法的调用顺序</li>
</ol>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[ANYMethodLog logMethodWithClass:[<span class="built_in">UIViewController</span> <span class="keyword">class</span>] condition:^<span class="built_in">BOOL</span>(SEL sel) &#123;</span><br><span class="line">    <span class="built_in">NSArray</span> *whiteList = @[<span class="string">@&quot;loadView&quot;</span>, </span><br><span class="line">                           <span class="string">@&quot;viewWillAppear:&quot;</span>,</span><br><span class="line">                           <span class="string">@&quot;viewDidAppear:&quot;</span>, </span><br><span class="line">                           <span class="string">@&quot;viewWillDisappear:&quot;</span>];</span><br><span class="line">    <span class="keyword">return</span> [whiteList containsObject:<span class="built_in">NSStringFromSelector</span>(sel)];</span><br><span class="line">&#125; before:^(<span class="keyword">id</span> target, SEL sel, <span class="built_in">NSArray</span> *args, <span class="keyword">int</span> deep) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;target:%@ sel:%@&quot;</span>, target, <span class="built_in">NSStringFromSelector</span>(sel));</span><br><span class="line">&#125; after:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>打印调用方法的参数值</li>
</ol>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[ANYMethodLog logMethodWithClass:<span class="built_in">NSClassFromString</span>(<span class="string">@&quot;UIViewController&quot;</span>) condition:^<span class="built_in">BOOL</span>(SEL sel) &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSStringFromSelector</span>(sel) isEqualToString:<span class="string">@&quot;viewWillAppear:&quot;</span>];</span><br><span class="line">&#125; before:^(<span class="keyword">id</span> target, SEL sel, <span class="built_in">NSArray</span> *args, <span class="keyword">int</span> deep) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;before target:%@ sel:%@ args:%@&quot;</span>, target, <span class="built_in">NSStringFromSelector</span>(sel), args);</span><br><span class="line">&#125; after:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>打印某个方法调用前后的变化</li>
</ol>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[ANYMethodLog logMethodWithClass:<span class="built_in">NSClassFromString</span>(<span class="string">@&quot;ListController&quot;</span>) condition:^<span class="built_in">BOOL</span>(SEL sel) &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSStringFromSelector</span>(sel) isEqualToString:<span class="string">@&quot;changeBackground&quot;</span>];</span><br><span class="line">&#125; before:^(<span class="keyword">id</span> target, SEL sel, <span class="built_in">NSArray</span> *args, <span class="keyword">int</span> deep) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;before background color:%@&quot;</span>, [(ListController *)target view].backgroundColor);</span><br><span class="line">&#125; after:^(<span class="keyword">id</span> target, SEL sel, <span class="built_in">NSArray</span> *args, <span class="built_in">NSTimeInterval</span> interval, <span class="keyword">int</span> deep, <span class="keyword">id</span> retValue) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;after background color:%@&quot;</span>, [(ListController *)target view].backgroundColor);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>打印某个方法调用的耗时</li>
</ol>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[ANYMethodLog logMethodWithClass:<span class="built_in">NSClassFromString</span>(<span class="string">@&quot;ListController&quot;</span>) condition:^<span class="built_in">BOOL</span>(SEL sel) &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSStringFromSelector</span>(sel) isEqualToString:<span class="string">@&quot;changeBackground&quot;</span>];</span><br><span class="line">&#125; before:^(<span class="keyword">id</span> target, SEL sel, <span class="built_in">NSArray</span> *args, <span class="keyword">int</span> deep) &#123;</span><br><span class="line">&#125; after:^(<span class="keyword">id</span> target, SEL sel, <span class="built_in">NSArray</span> *args, <span class="built_in">NSTimeInterval</span> interval, <span class="keyword">int</span> deep, <span class="keyword">id</span> retValue) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;interval::%@&quot;</span>, [@(interval) stringValue]);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>追踪方法调用顺序</li>
</ol>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[ANYMethodLog logMethodWithClass:<span class="built_in">NSClassFromString</span>(<span class="string">@&quot;ListController&quot;</span>) condition:^<span class="built_in">BOOL</span>(SEL sel) &#123;</span><br><span class="line">    <span class="keyword">return</span>  <span class="literal">YES</span>;</span><br><span class="line">&#125; before:^(<span class="keyword">id</span> target, SEL sel, <span class="built_in">NSArray</span> *args, <span class="keyword">int</span> deep) &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *selector = <span class="built_in">NSStringFromSelector</span>(sel);</span><br><span class="line">    <span class="built_in">NSArray</span> *selectorArrary = [selector componentsSeparatedByString:<span class="string">@&quot;:&quot;</span>];</span><br><span class="line">    selectorArrary = [selectorArrary filteredArrayUsingPredicate:[<span class="built_in">NSPredicate</span> predicateWithFormat:<span class="string">@&quot;length &gt; 0&quot;</span>]];</span><br><span class="line">    <span class="built_in">NSMutableString</span> *selectorString = [<span class="built_in">NSMutableString</span> new];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; selectorArrary.count; i++) &#123;</span><br><span class="line">        [selectorString appendFormat:<span class="string">@&quot;%@:%@ &quot;</span>, selectorArrary[i], args[i]];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSMutableString</span> *deepString = [<span class="built_in">NSMutableString</span> new];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; deep; i++) &#123;</span><br><span class="line">        [deepString appendString:<span class="string">@&quot;-&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@[%@ %@]&quot;</span>, deepString , target, selectorString);</span><br><span class="line">&#125; after:^(<span class="keyword">id</span> target, SEL sel, <span class="built_in">NSArray</span> *args, <span class="built_in">NSTimeInterval</span> interval, <span class="keyword">int</span> deep, <span class="keyword">id</span> retValue) &#123;</span><br><span class="line">    <span class="built_in">NSMutableString</span> *deepString = [<span class="built_in">NSMutableString</span> new];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; deep; i++) &#123;</span><br><span class="line">        [deepString appendString:<span class="string">@&quot;-&quot;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ret:%@&quot;</span>, deepString, retValue);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<p>实际使用时，需要在 Makefile加入 ANYMethodLog.m </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">iThunderHelper_FILES &#x3D; Tweak.xm ANYMethodLog.m </span><br></pre></td></tr></table></figure>

<h4 id="BigBang"><a href="#BigBang" class="headerlink" title="BigBang"></a>BigBang</h4><p>功能比较专一，主要用来 Hook 某个类的所有方法，打印所有方法的执行顺序</p>
<p><a href="https://github.com/codesourse/BigBang">https://github.com/codesourse/BigBang</a></p>
<p>使用只需一个代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[BigBang hookClass:@&quot;XLMberManager&quot;]</span><br></pre></td></tr></table></figure>

<p>使用时注意，放在只会执行一次的函数里，避免多次 Hook，%ctor</p>
<p>Makefile 中添加</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">iThunderHelper_FILES &#x3D; Tweak.xm BigBang.m </span><br></pre></td></tr></table></figure>





<h4 id="报错"><a href="#报错" class="headerlink" title="报错"></a>报错</h4><ol>
<li>安装插件后报错再安装报 dpkg 错误</li>
</ol>
<p>ssh 连接到设备 <code>ps -e | grep dpkg</code></p>
<p>kill dpkg端口号</p>
]]></content>
  </entry>
  <entry>
    <title>逆向-汇编</title>
    <url>/2022/06/13/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/</url>
    <content><![CDATA[<h4 id="通用寄存器"><a href="#通用寄存器" class="headerlink" title="通用寄存器"></a>通用寄存器</h4><p>ARM64 有 31 个通用寄存器，每个寄存器可以存取一个 64 位的数据</p>
<p>使用 X0 ~ X30 时，它就是一个 64 位的数据</p>
<p>使用 W0 ~ W30 时，实际访问的是这些寄存器的低 32 位，写入时会将高 32 位清 0 </p>
<p>32 位寄存器并不是独立存在的，比如 W0 是 X0 的低 32 位</p>
<img src="逆向-汇编/通用寄存器.png" alt="通用寄存器" style="zoom:60%;" />



<p>Xcode 重新命名了 X29 X30 叫 fp  lr，除了 X0~X30寄存器外，还有一个 SP 寄存器。</p>
<h5 id="X0-X7"><a href="#X0-X7" class="headerlink" title="X0 ~ X7"></a>X0 ~ X7</h5><p>用来传递函数的参数，如果有更多的参数则使用栈来传递；X0 也用来存放函数的返回值</p>
<h5 id="SP寄存器"><a href="#SP寄存器" class="headerlink" title="SP寄存器"></a>SP寄存器</h5><p>Stack Pointer，栈指针寄存器，指向栈的顶部</p>
<h5 id="FP寄存器"><a href="#FP寄存器" class="headerlink" title="FP寄存器"></a>FP寄存器</h5><p>Frame Pointer，即 X29，帧指针寄存器，指向栈的底部</p>
<h5 id="LR寄存器"><a href="#LR寄存器" class="headerlink" title="LR寄存器"></a>LR寄存器</h5><p>Link Register，即 X30，链接寄存器，存储着函数调用完成时的返回地址，用来做函数调用栈跟踪</p>
<h5 id="PC寄存器"><a href="#PC寄存器" class="headerlink" title="PC寄存器"></a>PC寄存器</h5><p>指令指针寄存器，保存的是将要执行的下一条指令的内存地址</p>
<p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/PC%E5%AF%84%E5%AD%98%E5%99%A8.png" alt="PC寄存器"></p>
<h4 id="寄存器操作"><a href="#寄存器操作" class="headerlink" title="寄存器操作"></a>寄存器操作</h4><ul>
<li>读取寄存器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ register read				#读取整个寄存器</span><br><span class="line">x0 &#x3D; 0x....</span><br><span class="line">x1 &#x3D; 0x....</span><br><span class="line">$ register read $x0		#读取 x0 寄存器</span><br></pre></td></tr></table></figure>

<ul>
<li>修改寄存器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ register write $x1 1</span><br><span class="line">$ register read $x1</span><br></pre></td></tr></table></figure>

<ul>
<li>打印操作</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ po $x1			#打印 OC 对象</span><br><span class="line">$ x&#x2F;s $x1	    #将 X1 寄存器的C字符串打印出来 打印出调用方法名字</span><br><span class="line"></span><br><span class="line">$ p&#x2F;x $x7		  #p命令输出原生类型</span><br><span class="line">$ p&#x2F;d $x7</span><br></pre></td></tr></table></figure>

<ul>
<li>内存读写</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># -c 参数指定要读取的字节</span><br><span class="line">$ memory read $x0  #读取内存  如果读取数据超过1024字节会报错 加 --force 参数</span><br><span class="line">$ memory read 0x0000.. 0x0000.. #按区间读取</span><br><span class="line"></span><br><span class="line">#--outfile 读取的内存数据保存到文件</span><br><span class="line">$ memory read 0x000... -c 1025 --force -outfile &#x2F;tmp&#x2F;1.txt</span><br><span class="line"></span><br><span class="line">$ memory write 0x00.. 0x24 #修改成 0x24</span><br></pre></td></tr></table></figure>

<ul>
<li>反汇编</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ dis -a 0x00.. #反汇编指定地址</span><br></pre></td></tr></table></figure>

<ul>
<li>调用栈</li>
</ul>
<p>这里看到 frame， ru #1 0x000..f04</p>
<p>用这个地址减去 ASLR 的偏移量即可得到文件的偏移地址 </p>
<p>在 IDA 中取搜索这个文件偏移地址</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ bt</span><br><span class="line">$ bt 2  #指定打印 2 层</span><br></pre></td></tr></table></figure>

<ul>
<li>单步命令</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ni  #单步执行 遇到子函数不进入，会执行到下一行</span><br><span class="line">$ si  #单步执行 遇到子函数进入</span><br><span class="line">$ finish 完成功能并退出子函数，如在 objc_msgSend 函数内任何地址输入finish，会完成objc_msgSend的原始调用</span><br><span class="line">$ return 和finish不同会直接退出子函数，原始代码流程不会调用，该命令通常在反-反调试时用于跳过检测函数</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0x104f227bB &lt;+8&gt;: mov W8, #-0x1</span><br></pre></td></tr></table></figure>

<p>加了#号表示常数，将 -1 赋值给 w8</p>
<p>orr 按位或</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">/<span class="regexp">/读取 x9 寄存器值</span></span><br><span class="line"><span class="regexp">(lldb)register read $x9</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 修改 pc 寄存器的指向位置</span></span><br><span class="line"><span class="regexp">(lldb)register write $pc 0x182a367b8</span></span><br><span class="line"><span class="regexp">(lldb)register read $pc</span></span><br></pre></td></tr></table></figure>

<p>我们可以通过改变 pc寄存器 的内容来控制 CPU 执行目标指令</p>
<ul>
<li>mov 指令，可以用来修改大部分寄存器的值（不能用于设置pc的值）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mov x0, #10</span><br><span class="line">mov x1, #20</span><br></pre></td></tr></table></figure>

<ul>
<li>bl 指令</li>
</ul>
<p>转移（跳转指令）</p>
<ul>
<li>ret 指令</li>
</ul>
<p>默认使用 lr（X30）寄存器的值</p>
<ul>
<li>Xcode 新建汇编代码</li>
</ul>
<p>Xcode 新建选择 Assembly File，命名为 asm.s </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;标号 告诉编译器生成的二进制机器码会保存到代码段</span><br><span class="line">.text</span><br><span class="line">&#x2F;&#x2F;告诉编译器 全局标号暴露给外面 _A _B</span><br><span class="line">.global _A,_B</span><br><span class="line"></span><br><span class="line">_A:</span><br><span class="line">    &#x2F;&#x2F;将a0存入到x0寄存器</span><br><span class="line">    mov x0,#0xa0</span><br><span class="line">    mov x1,#0x00</span><br><span class="line">    &#x2F;&#x2F;x0和#0x14加法运算 结果放到x1</span><br><span class="line">    add x1, x0, #0x14</span><br><span class="line">    &#x2F;&#x2F;跳转到B</span><br><span class="line">    bl _B</span><br><span class="line">    mov x0,#0x0</span><br><span class="line">    ret</span><br><span class="line">_B:</span><br><span class="line">    add x0, x0, #0x10</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>

<p>调用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">int A(); &#x2F;&#x2F;声明</span><br><span class="line">int main(int argc,char *argv[])&#123;</span><br><span class="line">  A(); &#x2F;&#x2F;调用</span><br><span class="line">  @autoreleasepool&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以在调用处 A(); 打断点调试</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-&gt; 0x10031a7f0 &lt;+24&gt;: bl 0x10031ab44</span><br></pre></td></tr></table></figure>

<p>s 指令进入，就到了上面的汇编指令了，ni 按汇编指令一步步往下走</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">(lldb)s</span><br><span class="line">(lldb)ni</span><br></pre></td></tr></table></figure>

<ul>
<li>LR 寄存器</li>
</ul>
<p>也称为 X30 寄存器，指向返回地址，存储函数调用完成时的返回地址</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-&gt; 0x10439ab38 &lt;+4&gt;: bl   0x10439ab44</span><br><span class="line">	 0x10439ab3c &lt;+8&gt;: mov  x0, #0xaaaa</span><br></pre></td></tr></table></figure>

<p>lr 值就是 0x10439ab3c</p>
<h4 id="状态寄存器-CPSR"><a href="#状态寄存器-CPSR" class="headerlink" title="状态寄存器 CPSR"></a>状态寄存器 CPSR</h4><p>状态寄存器用来保存指令运行结果的一些信息，比如相加结果是否溢出、是否为0及是否为负数，和其它寄存器不一样，其它寄存器是用来存放数据的，都是整个寄存器具有一个含义</p>
<p>而 CPSR 寄存器是按位起作用，每一位都有专门含义</p>
<p>CPSR 寄存器是 32 位的</p>
<ul>
<li>低 8 位（包括 I、F、T 和 M[0-4]）称为控制位，程序无法修改，除非 CPU 运行与特权模式下，程序才能修改</li>
<li>N、Z、C、V 均为条件码标志位，内容可被算术或逻辑运算的结果所改变，并且可以决定某条指令是否被执行</li>
</ul>
<img src="逆向-汇编/图片.png" alt="15201620642085" style="zoom:70%;" />

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">funcC</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> b = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (a == b) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;a == b&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;a != b&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>if(a == b)</code>   处打断点调试，查看汇编代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">b.ne 0x102fc68f8  &#x2F;&#x2F;带条件的跳转</span><br></pre></td></tr></table></figure>

<p>断点到 b.ne 后，查看 CPSR 寄存器</p>
<p>控制台 选择All Variable 可以看到寄存器的参数<br>查看 cpsr 寄存器</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cpsr &#x3D; (unsigned int) 0x80000000</span><br></pre></td></tr></table></figure>

<p>第一个16进制位是 8，代表 N、Z、C、V  这 4 个二进制位</p>
<p> 16 进制 0x8，转换成二进制就是 1000 （可以用计算器计算）</p>
<p>正常流程结果是打印 <code>a != b</code></p>
<p>现在将修改 cpsr 寄存器的值为 0100 就是 0x4</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">(lldb) register write cpsr <span class="number">0x40000000</span></span><br><span class="line">(lldb) register read cpsr</span><br><span class="line">cpsr = <span class="number">0x40000000</span></span><br><span class="line">(lldb) c</span><br><span class="line">a == b</span><br></pre></td></tr></table></figure>

<h5 id="N"><a href="#N" class="headerlink" title="N"></a>N</h5><p>符号标志位，两个有符号整数进行运算时，N=1 表示结果为负数；N=0 表示运行结果为正数或0</p>
<h5 id="Z"><a href="#Z" class="headerlink" title="Z"></a>Z</h5><p>0 标志位，Z=1 表示运算结果为零；Z=0 表示运算结果为非领</p>
<h5 id="C"><a href="#C" class="headerlink" title="C"></a>C</h5><p>进位标志位</p>
<p>加法运算：运算结果产生了进位 C=1 ，否则 C=0</p>
<p>减法运算：运算时产生了借位 C=0，否则 C=1</p>
<h5 id="V"><a href="#V" class="headerlink" title="V"></a>V</h5><p>溢出标志位，V=1 表示符号位溢出</p>
<p>正数+正数为负数 溢出</p>
<p>负数+负数为正数 溢出</p>
<p>正数+负数 不可能溢出</p>
<h4 id="常见ARM64指令集"><a href="#常见ARM64指令集" class="headerlink" title="常见ARM64指令集"></a>常见ARM64指令集</h4><h5 id="算术指令"><a href="#算术指令" class="headerlink" title="算术指令"></a>算术指令</h5><p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E5%B8%B8%E7%94%A8%E7%AE%97%E6%9C%AF%E6%8C%87%E4%BB%A4.png" alt="常用算术指令"></p>
<h5 id="跳转指令"><a href="#跳转指令" class="headerlink" title="跳转指令"></a>跳转指令</h5><p>条件跳转<img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E5%B8%B8%E7%94%A8%E8%B7%B3%E8%BD%AC%E6%8C%87%E4%BB%A4.png" alt="常用跳转指令"></p>
<p>无条件跳转</p>
<p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E6%97%A0%E6%9D%A1%E4%BB%B6%E8%B7%B3%E8%BD%AC.png" alt="无条件跳转"></p>
<h5 id="逻辑指令"><a href="#逻辑指令" class="headerlink" title="逻辑指令"></a>逻辑指令</h5><p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E5%B8%B8%E7%94%A8%E9%80%BB%E8%BE%91%E6%8C%87%E4%BB%A4.png" alt="常用逻辑指令"></p>
<h5 id="数据传输指令"><a href="#数据传输指令" class="headerlink" title="数据传输指令"></a>数据传输指令</h5><p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E6%8C%87%E4%BB%A4.png" alt="常用数据传输指令"></p>
<h5 id="地址偏移指令"><a href="#地址偏移指令" class="headerlink" title="地址偏移指令"></a>地址偏移指令</h5><p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E5%B8%B8%E7%94%A8%E5%9C%B0%E5%9D%80%E5%81%8F%E7%A7%BB%E6%8C%87%E4%BB%A4.png" alt="常用地址偏移指令"></p>
<h5 id="移位运算指令"><a href="#移位运算指令" class="headerlink" title="移位运算指令"></a>移位运算指令</h5><p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E5%B8%B8%E7%94%A8%E7%A7%BB%E4%BD%8D%E8%BF%90%E7%AE%97%E6%8C%87%E4%BB%A4.png" alt="常用移位运算指令"></p>
<h5 id="加载-存储指令"><a href="#加载-存储指令" class="headerlink" title="加载/存储指令"></a>加载/存储指令</h5><p>加载/存储指令都是成对出现的</p>
<p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E5%B8%B8%E7%94%A8%E5%8A%A0%E8%BD%BD:%E5%AD%98%E5%82%A8%E6%8C%87%E4%BB%A41.png" alt="常用加载:存储指令1"></p>
<p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E5%B8%B8%E7%94%A8%E5%8A%A0%E8%BD%BD:%E5%AD%98%E5%82%A8%E6%8C%87%E4%BB%A42.png" alt="常用加载:存储指令2"></p>
<p>ARM 指令的一个重要特点是可以条件执行，每条 ARM 指令的条件码域包含 4 位条件码，共16种</p>
<p>几乎所有指令均根据 CPSR 中条件码的状态和指令条件码域的设置有条件地执行，当指令执行条件满足时，指令被执行，否则被忽略</p>
<p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E6%8C%87%E4%BB%A4%E6%9D%A1%E4%BB%B6%E7%A0%81.png" alt="指令条件码"></p>
<h4 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h4><p>栈的增长方向是从高地址到低地址的。栈低是高地址，栈顶是低地址</p>
<p>后进先出，高地址向低地址扩展数据结构</p>
<img src="逆向-汇编/栈.png" alt="栈" style="zoom:50%;" />



<ul>
<li>str（store register）指令</li>
</ul>
<p>将数据从寄存器中读出来，存到内存</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">str w0,[x8]  w0取出放到x8所指向的地方</span><br></pre></td></tr></table></figure>

<ul>
<li>ldr（load register） 指令</li>
</ul>
<p>将数据从内存中读出来，存到寄存器中</p>
<p>str 和 ldr 的变种 ldp 和 stp 还可以操作 2 个寄存器</p>
<p><u>函数的调用会开辟栈帧，在AArch64 中，函数的参数是通过 X0~X7 传递的</u></p>
<p>函数的返回值使用 X0 寄存器保存</p>
<p>X1 是方法名，X2是第一个参数</p>
<p>编译器生成汇编时，首先会计算所需要的栈空间大小。</p>
<p>方法的头部通过 <u>向下</u> 移动SP指针在栈上分配空间，把当前FP和LR保存起来</p>
<p>方法的尾部恢复栈上的FP和LR到寄存器，然后向上移动栈指针SP，来释放栈上的内存。这两部分其实也是为了保持栈平衡，前面开辟了多少空间，调用结束后就需要归还多少，从而恢复成函数调用前的样子</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sub sp, sp, #0x20 ;拉伸栈空间</span><br><span class="line">stp x29, x30, [sp, #0x20] ;保存x29(FP)和x30(LR)寄存器</span><br><span class="line">add x29, sp, #0x20 	; 抬高栈底</span><br><span class="line">...</span><br><span class="line">ldp x29,x30,[sp, #0x20] ;还原x29和x30</span><br><span class="line">add sp, sp, #0x30 ;释放栈空间</span><br></pre></td></tr></table></figure>









<ul>
<li>函数嵌套调用：会将 X29、X30寄存器入栈保护</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">int g &#x3D; 12;</span><br><span class="line"></span><br><span class="line">int func(int a, int b)&#123;</span><br><span class="line">    printf(&quot;haha&quot;);</span><br><span class="line">    int c &#x3D; a + g;</span><br><span class="line">    return c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc, char * argv[]) &#123;</span><br><span class="line">    func(10, 20);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>printf(&quot;haha&quot;)</code> 处打断点</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">	  0x102732730 &lt;+20&gt;: adrp   x0, 1</span><br><span class="line">    0x102732734 &lt;+24&gt;: add    x0, x0, #0xf2b      ; &#x3D;0xf2b </span><br><span class="line">-&gt;  0x102732738 &lt;+28&gt;: bl     0x102732a7c         ; symbol stub for: printf</span><br></pre></td></tr></table></figure>

<p>X0 存储的是第一个参数，动态调试可以直接打印 X0 的值</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(lldb) register read $x0</span><br><span class="line">      x0 &#x3D; 0x0000000102733f2b  &quot;haha&quot;</span><br></pre></td></tr></table></figure>

<p>分析</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0x102732730 &lt;+20&gt;: adrp   x0, 1</span><br><span class="line">adrp 就是 address page, 每一页就是 4k，4k就是 12 位</span><br><span class="line">意思是</span><br><span class="line">将 1 左移 12 位，(1后面补上12个0) -&gt; 0x1000 (用计算器)</span><br><span class="line">将当前 pc 寄存器值 0x102732730，低 12 位清 0 -&gt; 0x102732000</span><br><span class="line">相加赋值给 X0 0x102732000+0x1000 &#x3D; 0x102733000</span><br><span class="line"></span><br><span class="line">0x102732734 &lt;+24&gt;: add    x0, x0, #0xf2b      ; &#x3D;0xf2b</span><br><span class="line">X0 加上 0xf2b </span><br><span class="line">(lldb) p&#x2F;x 0x102733000+0xf2b</span><br><span class="line">(long) $0 &#x3D; 0x0000000102733f2b</span><br><span class="line">常量地址就找到了 -&gt; p (char*)0x0000000102733f2b</span><br><span class="line">(char *) $3 &#x3D; 0x0000000102733f2b &quot;haha&quot;</span><br></pre></td></tr></table></figure>



<h4 id="循环选择判断"><a href="#循环选择判断" class="headerlink" title="循环选择判断"></a>循环选择判断</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cmp w0, w1</span><br></pre></td></tr></table></figure>

<p>cmp 比较指令</p>
<p>BL标号：跳转到标号处执行<br>B.GT 比较结果是大于，执行标号，否则不跳转<br>B.GE 比较结果是大于等于，执行标号，否则不跳转<br>B.GQ 比较结果是等于，执行标号，否则不跳转<br>B.HI 比较结果是无符号大于，执行标号，否则不跳转</p>
<p>b.le 小于等于<br>b.lt 小于</p>
<p>dowhile循环：判断条件在后面，满足条件往前跳<br>while循环：判断条件在里面，不满足就往外跳</p>
<h4 id="Objc汇编机制"><a href="#Objc汇编机制" class="headerlink" title="Objc汇编机制"></a>Objc汇编机制</h4><p>OC 中 X0 寄存器保存了对象本身</p>
<p>X1 寄存器保存了方法名</p>
<p>X2 ~ X7 开始是参数，其它参数通过栈传递，由于是 64 位的程序，所以每 8 个字节一组</p>
<h4 id="ARM64"><a href="#ARM64" class="headerlink" title="ARM64"></a>ARM64</h4><p>汇编代码里以点 . 开头的关键字不是指令而是助记符，也叫作伪指令，它不会被编译成机器码，作用是告诉编译器做一些特殊的操作</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.extern 声明外部函数</span><br><span class="line">.align  字节对齐的方式，如4字节对齐 .align 4</span><br><span class="line">.data   数据段，用于存储需要用到的数据</span><br><span class="line">.text   代码段，告诉编译器代码生成的二进制机器码会保存在代码段</span><br><span class="line">.global 表示一个全局符号</span><br></pre></td></tr></table></figure>





<h4 id="内联汇编"><a href="#内联汇编" class="headerlink" title="内联汇编"></a>内联汇编</h4><p>高级语言中嵌入汇编代码，这种方式称为内联汇编</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">asm &#123;volatile&#125;(&quot;汇编语句模板&quot;</span><br><span class="line">	:输出(可选)</span><br><span class="line">	:输入(可选)</span><br><span class="line">	:会被破坏的寄存器(可选)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>包含 4 个部分，各部分用 ：分隔。汇编语句模板必不可少，其它三部分可选，如果使用了后面部分，而前面部分为空，也需要用 ：分隔，相应部分内容为空</p>
<p>参数 volatile 可选，如果用了它，则告诉编译器不允许对该内联汇编进行优化，否则启动优化选项(-O)进行编译时，汇编代码会被编译器优化的面目全非</p>
<p>Xcode 写个加法函数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">int arm_sum(int a, int b) &#123;</span><br><span class="line">    int sum &#x3D; 0;</span><br><span class="line">    asm volatile(</span><br><span class="line">                &quot;add %w0, %w1, %w2&quot; </span><br><span class="line">                 : &quot;&#x3D;r&quot; (sum)</span><br><span class="line">                 : &quot;r&quot; (a), &quot;r&quot; (b)</span><br><span class="line">                 :);</span><br><span class="line">    return sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一行：汇编语句模板 %w0, %w1, %w2 代表指令的操作数，称为占位符。内联汇编根据它们将C语言表达式与指令操作数对应起来</p>
<p>模板后面的小括号内是C语言表达式</p>
<p>上面表达式有3个 sum、a、b，按照出现顺序分别与指令操作数%0、%1、%2 对应，操作数最多只能有10个。百分号 % 后面的字母表示这个变量的位宽，w 表示 32 位，x 表示 64 位。</p>
<p>第二行：输出参数，= 号表示，sum是输出操作符，r 表示需要将 sum 与某个通用寄存器相关联</p>
<p>第三行：输入参数，r 表示该表达式需要先放入某个寄存器，然后在指令中使用该寄存器参与运算</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#汇编指令，如果多句用\t\n来分割</span><br><span class="line">asm(</span><br><span class="line">&quot;mov x0,1\t\n&quot;</span><br><span class="line">&quot;mov x1,2\t\n&quot;</span><br><span class="line">...</span><br><span class="line">)</span><br></pre></td></tr></table></figure>







<h4 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h4><p>在反汇编代码窗口输入分号，就能够添加注释</p>
<h4 id="Hopper"><a href="#Hopper" class="headerlink" title="Hopper"></a>Hopper</h4><p>在反汇编窗口输入分号能够对代码添加注释，使用 shift+; 组合键可以在代码所在的行后面添加注释</p>
]]></content>
  </entry>
  <entry>
    <title>逆向-砸壳</title>
    <url>/2022/06/13/%E9%80%86%E5%90%91-%E7%A0%B8%E5%A3%B3/</url>
    <content><![CDATA[<h4 id=""><a href="#" class="headerlink" title=""></a></h4><p>脱壳原理</p>
<p>dyld加载MachO文件，将MachO文件导出</p>
<h4 id="检测是否加壳"><a href="#检测是否加壳" class="headerlink" title="检测是否加壳"></a>检测是否加壳</h4><ul>
<li>使用 otool</li>
</ul>
<p>otool 可以看到二进制文件的信息有个 crypt，cryptid = 1 已加壳，crypt = 0，未加壳</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">otool -l WeChat | grep crypt</span><br></pre></td></tr></table></figure>

<ul>
<li>使用 MachOView 查看</li>
</ul>
<p>可执行文件拖入 MachOView 展开 Load Commands 节点 LC_ENCRYPTION_INFO_64</p>
<p>可以看到 Crypt ID</p>
<img src="逆向-砸壳/WeChatc7de80a199f342265e06ba9817134a60.png" alt="WeChatc7de80a199f342265e06ba9817134a60" style="zoom:80%;" />

<h4 id="脱壳"><a href="#脱壳" class="headerlink" title="脱壳"></a>脱壳</h4><h5 id="Clutch"><a href="#Clutch" class="headerlink" title="Clutch"></a>Clutch</h5><blockquote>
<p>使用问题比较多，好多砸壳失败的</p>
</blockquote>
<p>全自动脱壳工具，原理是应用运行时的内存数据按照一定格式导出，并重新打包为 ipa 文件</p>
<ul>
<li>安装</li>
</ul>
<p><a href="https://github.com/KJCracks/Clutch/releases">https://github.com/KJCracks/Clutch/releases</a> 下载最新版 Clutch 2.0.4</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ iproxy 2222 22 #端口转发</span><br><span class="line">#macOS执行</span><br><span class="line">$ scp -p 2222 -r .&#x2F;Clutch root@localhost:&#x2F;usr&#x2F;bin&#x2F;</span><br><span class="line">#iOS设备执行</span><br><span class="line">$ chmod +x &#x2F;usr&#x2F;bin&#x2F;Clutch</span><br></pre></td></tr></table></figure>

<p>输入 Clutch，输出了帮助信息则安装配置成功</p>
<ul>
<li>Clutch</li>
</ul>
<p>Clutch -i 参数打印所有应用列表</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root# Clutch -i</span><br><span class="line">Installed apps:</span><br><span class="line">1:  今日头条 &lt;com.ss.iphone.article.News&gt;</span><br></pre></td></tr></table></figure>

<p>脱壳</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root# Clutch -d com.ss.iphone.article.News</span><br></pre></td></tr></table></figure>

<p>脱壳完成后的 ipa 包在 <code>/private/var/mobile/Documents/Dumped</code> 路径</p>
<p>再拷贝到电脑</p>
<h5 id="dumpedcrypted"><a href="#dumpedcrypted" class="headerlink" title="dumpedcrypted"></a>dumpedcrypted</h5><p>脱壳原理：程序运行过程中将代码段里的数据 dump 下来</p>
<ul>
<li>编译  dumpdecrypted</li>
</ul>
<p>下载 <a href="https://github.com/stefanesser/dumpdecrypted">https://github.com/stefanesser/dumpdecrypted</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ cd dumpdecrypted-master</span><br><span class="line">$ make</span><br></pre></td></tr></table></figure>

<p>生成 dumpdecrypted.dylib</p>
<ul>
<li>给 dumpdecrypted.dylib 重签名 </li>
</ul>
<p>可以使用 ldid 签名</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ldid -S dumpdecrypted.dylib</span><br></pre></td></tr></table></figure>

<p>或者使用 codesign 签名</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">codesign -f -s - .&#x2F;dumpdecrypted.dylib</span><br></pre></td></tr></table></figure>

<ul>
<li>拷贝 dumpdecrypted.dylib 到设备</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ scp -P2222 .&#x2F;dumpdecrypted.dylib root@localhost:&#x2F;usr&#x2F;bin&#x2F;</span><br></pre></td></tr></table></figure>

<ul>
<li>dumpdecrypted 脱壳</li>
</ul>
<p>查找路径和进程ID</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ cd &#x2F;temp</span><br><span class="line">$ ps -e | grep WhatsApp</span><br><span class="line">#或者</span><br><span class="line">$ ps -ax | grep WhatsApp</span><br><span class="line">$ ps -aux | grep WhatsApp</span><br></pre></td></tr></table></figure>

<p>使用 DYLD_INSERT_LIBRARIES 环境变量将 dumpdecrypted.dylib 注入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DYLD_INSERT_LIBRARIES&#x3D;&#x2F;usr&#x2F;lib&#x2F;dumpdecrypted.dylib &#x2F;var&#x2F;mobile&#x2F;Containers&#x2F;Bundle&#x2F;Application&#x2F;1C8620F5-AFB5-46F8-9283-5FF70F4ADB5D&#x2F;WhatsApp.app&#x2F;WhatsApp</span><br></pre></td></tr></table></figure>

<p>生成 WhatsApp.decrypted 为脱壳后的文件，将文件拷贝到电脑</p>
<p>有些包是多架构的需要抽取指定架构</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">lipo AppStore.decrypted -thin arm64 -output AppStore.arm64</span><br></pre></td></tr></table></figure>

<h5 id="frida-ios-dump"><a href="#frida-ios-dump" class="headerlink" title="frida-ios-dump"></a>frida-ios-dump</h5><p>通过注入 JS 实现内存 dump，然后利用 Python 自动复制到 macOS生成ipa文件</p>
<p>原理和 dumpdecrypted 一样，都是通过把内存中已解密的数据 dump 再修复 Mach-O</p>
<ul>
<li>安装 frida</li>
</ul>
<p>iOS 设备 添加 Cydia 源：<a href="https://build.frida.re/">https://build.frida.re</a>  安装 Frida for A12+ devices</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#macOS安装frida</span><br><span class="line">$ sudo pip install frida</span><br><span class="line">#如果报错</span><br><span class="line">$ sudo pip install frida -upgrade -ignore-installed six</span><br></pre></td></tr></table></figure>

<ul>
<li>配置 frida-ios-dump 环境</li>
</ul>
<p>下载 <a href="https://github.com/AloneMonkey/frida-ios-dump">https://github.com/AloneMonkey/frida-ios-dump</a> 放到 /opt/dump 目录</p>
<p>安装依赖</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ sudo pip install -r requirements.txt --upgrade</span><br></pre></td></tr></table></figure>

<p>可以添加别名</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ vim ~&#x2F;.bash_profile</span><br><span class="line">$ alias dump.py&#x3D;“&#x2F;opt&#x2F;dump&#x2F;frida-ios-dump-3.x&#x2F;dump.py”</span><br><span class="line">$ source ~&#x2F;.bash_profile</span><br></pre></td></tr></table></figure>

<ul>
<li>砸壳</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#端口转发</span><br><span class="line">$ iproxy 2222 22</span><br><span class="line">#列出所有应用</span><br><span class="line">$ python3.8 dump.py -l</span><br><span class="line">#砸壳</span><br><span class="line">$ python3.8 dump.py com.moutai.mall</span><br></pre></td></tr></table></figure>

<h5 id="DumpDecrypter（推荐）"><a href="#DumpDecrypter（推荐）" class="headerlink" title="DumpDecrypter（推荐）"></a>DumpDecrypter（推荐）</h5><p>Cydia - Cydiakk中文源，搜索 DumpDecrypter 可以一键砸壳</p>
<h5 id="修复闪退"><a href="#修复闪退" class="headerlink" title="修复闪退"></a>修复闪退</h5><p>脱壳后的 ipa 包安装后闪退</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#解压ipa包</span><br><span class="line">$ unzip decrypted-app.ipa</span><br><span class="line">#导出ent.xml</span><br><span class="line">$ codesign -d --entitlements - .&#x2F;Payload&#x2F;WhatsApp.app &gt; emt.xml</span><br><span class="line">#codesign重签名</span><br><span class="line">$ codesign -s - --entitlements ent.xml -f .&#x2F;Payload&#x2F;WhatsApp.app&#x2F;WhatsApp</span><br><span class="line">#压缩成新ipa包</span><br><span class="line">$ zip -r WhatsApp_ok.ipa Payload</span><br></pre></td></tr></table></figure>

<h5 id="LLDB-手动砸壳"><a href="#LLDB-手动砸壳" class="headerlink" title="LLDB 手动砸壳"></a>LLDB 手动砸壳</h5><p>LLDB手动脱壳实现原理是从内存中 dump 出解密后的数据，并修复 Mach-O 头部。</p>
<p>点击 APP 启动，内核开始读取 MachO，查看 MachO 是否被加密</p>
<p>如果没有加密，直接交给 dyld 加载并运行</p>
<p>如果加密，则需要内核解密，得到解密后的 MachO 文件，再交给 dyld 加载运行</p>
<ul>
<li>SSH 连接设备</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ iproxy 2222 22</span><br><span class="line">$ ssh -p 2222 root@localhost</span><br></pre></td></tr></table></figure>

<p>ps 命令找到目标路径</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ps -e | grep SogouInput</span><br><span class="line">4096 ??  0:04.69 &#x2F;var&#x2F;containers&#x2F;Bundle&#x2F;Application&#x2F;3546467A-CBFD-45D6-B27C-04682210031E&#x2F;SogouInput.app&#x2F;SogouInput</span><br></pre></td></tr></table></figure>

<ul>
<li>拷贝到桌面</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ scp -r -P 2222 root@localhost:&#x2F;var&#x2F;containers&#x2F;Bundle&#x2F;Application&#x2F;3546467A-CBFD-45D6-B27C-04682210031E&#x2F;SogouInput.app ~&#x2F;Desktop</span><br></pre></td></tr></table></figure>

<ul>
<li>查看是否加密</li>
</ul>
<p>要在内存中解密二进制文件，就需要知道加密数据的偏移量及大小</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">otool -l SogouInput | grep crypt</span><br><span class="line"> cryptoff 6299648  &#x2F;&#x2F;文件偏移</span><br><span class="line">cryptsize 4096		 &#x2F;&#x2F;加密文件大小</span><br><span class="line">  cryptid 1			   &#x2F;&#x2F;是否加密</span><br></pre></td></tr></table></figure>

<p>MachO 从位置 6299648（十进制） 开始后的 4096（十进制） 字节都被加密了</p>
<ul>
<li>开始脱壳</li>
</ul>
<p>LLDB 附加进程，然后获取 APP 的内存加载地址</p>
<ul>
<li>LLDB 连接</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">iproxy 1234 1234</span><br></pre></td></tr></table></figure>

<p>设备上</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">debugserver *:1234 -a SogouInput</span><br></pre></td></tr></table></figure>

<p>Mac</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">lldb</span><br><span class="line">(lldb) process connect connect:&#x2F;&#x2F;localhost:1234</span><br><span class="line">(lldb) image list -o -f  </span><br><span class="line">[  0] 0x0000000004e0c000 &#x2F;private&#x2F;var&#x2F;containers&#x2F;Bundle&#x2F;Application&#x2F;3546467A-CBFD-45D6-B27C-04682210031E&#x2F;SogouInput.app&#x2F;SogouInput(0x0000000104e0c000)</span><br></pre></td></tr></table></figure>

<p>image list 查看 APP 在内存中的偏移 ASLR 为 0x0000000104e0c000</p>
<p>如果这边遇到报错</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">error: rejecting incoming connection from ::ffff:127.0.0.1 (expecting ::1)</span><br></pre></td></tr></table></figure>

<p>debugserver 连接改成 <code>debugserver 127.0.0.1:1234 -a SogouInput</code></p>
<ul>
<li>Dump出解密部分二进制文件</li>
</ul>
<p>利用 memory 命令从内存中dump出解密后的二进制数据，保存到文件</p>
<p>读取内存中的数据拷贝出来</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;memory read --force --outfile 输出文件目录名称 --binary --count 加密文件的大小 ASLR+文件偏移 </span><br><span class="line">(--force 按字节读取意思)</span><br><span class="line">memory read --force --outfile .&#x2F;decrypted.bin --binary --count 4096 0x0000000104e0c000+6299648</span><br></pre></td></tr></table></figure>

<p>此时发现多了一个 decrypted.bin 文件</p>
<ul>
<li>修复文件</li>
</ul>
<p>dump 出来的数据没有 Mach-O 头部的信息，需要修复才能使用。将 dump 出来的数据重新写回脱壳前的文件，以替换加密的数据</p>
<ul>
<li>dd 指令将Dump出的二进制文件写入MachO文件</li>
</ul>
<p>指定大小文件写入另外一个文件里面</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;dd seek&#x3D;文件偏移 bs&#x3D;单位为1字节 conv&#x3D;转换方式（保留未被截取部分的内容）if&#x3D;输入文件地址 of&#x3D;输出文件地址</span><br><span class="line">&#x2F;&#x2F;~&#x2F;Desktop目录</span><br><span class="line">dd seek&#x3D;6299648 bs&#x3D;1 conv&#x3D;notrunc if&#x3D;.&#x2F;decrypted.bin of&#x3D;.&#x2F;SogouInput.app&#x2F;SogouInput</span><br></pre></td></tr></table></figure>

<ul>
<li>更改 cycript 为 0，最后一步修改加密标记</li>
</ul>
<p>MachOView 打开 SogouInput</p>
<p>在 Load Command - LC_ENCRYPTION_INFO_64 可以看到 Crypt ID 值为 1</p>
<p>修改 Crypt ID 的 Data 0000001 改为 0000000，保存再次查看是否加密</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">otool -l SogouInput.app&#x2F;SogouInput | grep crypt</span><br><span class="line">     cryptoff 6299648</span><br><span class="line">    cryptsize 4096</span><br><span class="line">      cryptid 0</span><br></pre></td></tr></table></figure>

<p>利用 class-dump 导出头文件测试下能不能导出</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class-dump -H &#x2F;Users&#x2F;midland_whk&#x2F;Desktop&#x2F;SogouInput.app&#x2F;SogouInput -o &#x2F;Users&#x2F;midland_whk&#x2F;Desktop&#x2F;header&#x2F;</span><br></pre></td></tr></table></figure>





































]]></content>
      <categories>
        <category>逆向</category>
      </categories>
  </entry>
  <entry>
    <title>逆向工具-Dobby</title>
    <url>/2022/06/09/%E9%80%86%E5%90%91%E5%B7%A5%E5%85%B7-Dobby/</url>
    <content><![CDATA[<h4 id="Inline-Hook"><a href="#Inline-Hook" class="headerlink" title="Inline Hook"></a>Inline Hook</h4><p>修改函数的前 N 字节内存，使其跳转到自己编写的函数，这样原函数的逻辑就被新函数接管了，同时还应该保存原函数的前 N 个字节，以便在需要时能正确恢复原来的汇编代码从而执行原始逻辑</p>
<h4 id="Dobby"><a href="#Dobby" class="headerlink" title="Dobby"></a>Dobby</h4><p>Dobby（原名 HookZz）<a href="https://github.com/jmpews/Dobby">https://github.com/jmpews/Dobby</a></p>
<h5 id="编译-Xcode-工程"><a href="#编译-Xcode-工程" class="headerlink" title="编译 Xcode 工程"></a>编译 Xcode 工程</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;jmpews&#x2F;Dobby.git --depth&#x3D;1</span><br></pre></td></tr></table></figure>

<p>这是个跨平台的，需要将 cmake 将工程编译成为 Xcode 工程</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd Dobby &amp;&amp; mkdir build_for_ios_arm64 &amp;&amp; cd build_for_ios_arm64</span><br><span class="line">cmake .. -G Xcode \</span><br><span class="line">-DCMAKE_TOOLCHAIN_FILE&#x3D;cmake&#x2F;ios.toolchain.cmake \</span><br><span class="line">-DPLATFORM&#x3D;OS64 -DARCHS&#x3D;&quot;arm64&quot; -DCMAKE_SYSTEM_PROCESSOR&#x3D;arm64 \</span><br><span class="line">-DENABLE_BITCODE&#x3D;0 -DENABLE_ARC&#x3D;0 -DENABLE_VISIBILITY&#x3D;1 -DDEPLOYMENT_TARGET&#x3D;9.3 \</span><br><span class="line">-DDynamicBinaryInstrument&#x3D;ON -DNearBranch&#x3D;ON -DPlugin.SymbolResolver&#x3D;ON -DPlugin.Darwin.HideLibrary&#x3D;ON -DPlugin.Darwin.ObjectiveC&#x3D;ON</span><br><span class="line"></span><br><span class="line">#github 上是下面的</span><br><span class="line">cd Dobby &amp;&amp; mkdir build_for_ios &amp;&amp; cd build_for_ios</span><br><span class="line">cmake .. -G Xcode -DCMAKE_SYSTEM_NAME&#x3D;iOS -DCMAKE_OSX_ARCHITECTURES&#x3D;arm64 -DCMAKE_SYSTEM_PROCESSOR&#x3D;arm64 -DCMAKE_OSX_DEPLOYMENT_TARGET&#x3D;9.3</span><br></pre></td></tr></table></figure>

<p>cmake 编译后生成一个 Xcode 工程</p>
<img src="逆向工具-Dobby/WeChat646a5d4c48c7a119b2d324b20ff968a3.png" alt="WeChat646a5d4c48c7a119b2d324b20ff968a3" style="zoom:80%;" />

<p>编译 DobbyX.framework</p>
<p><img src="/%E9%80%86%E5%90%91%E5%B7%A5%E5%85%B7-Dobby/WeChatc1fcfbfb83d8dd9daed4ac78a60cadbd.png" alt="WeChatc1fcfbfb83d8dd9daed4ac78a60cadbd"></p>
<h5 id="导入-Framework"><a href="#导入-Framework" class="headerlink" title="导入 Framework"></a>导入 Framework</h5><p>创建测试工程 testDobby，将 DobbyX.framework 拖入工程</p>
<p>运行后报错</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dyld: Library not loaded: @rpath&#x2F;DobbyX.framework&#x2F;DobbyX</span><br><span class="line">  Referenced from: &#x2F;private&#x2F;var&#x2F;containers&#x2F;Bundle&#x2F;Application&#x2F;B6A97E11-656E-461B-93B0-A1D72E9313AB&#x2F;testDobby.app&#x2F;testDobby</span><br><span class="line">  Reason: image not found</span><br><span class="line">dyld: launch, loading dependent libraries</span><br><span class="line">DYLD_LIBRARY_PATH&#x3D;&#x2F;usr&#x2F;lib&#x2F;system&#x2F;introspection</span><br><span class="line">DYLD_INSERT_LIBRARIES&#x3D;&#x2F;Developer&#x2F;usr&#x2F;lib&#x2F;libBacktraceRecording.dylib:&#x2F;Developer&#x2F;usr&#x2F;lib&#x2F;libMainThreadChecker.dylib:&#x2F;Developer&#x2F;Library&#x2F;PrivateFrameworks&#x2F;DTDDISupport.framework&#x2F;libViewDebuggerSupport.dylib</span><br></pre></td></tr></table></figure>

<p>将 Framework 首次拖入工程，Xcode 不会自动帮你拷贝，运行时会发现 Framework 没有打包进入 APP 包，造成 DYLD 加载时找不到库报错 </p>
<p>TARGETS testDobby - Build Phases，点击 + 选择 New Copy Files Phase</p>
<p>Copy Files 中，Destination 选择 Frameworks</p>
<img src="逆向工具-Dobby/WeChat511e8790f7c557a95e07f4c3227c5f93.png" alt="WeChat511e8790f7c557a95e07f4c3227c5f93" style="zoom:80%;" />

<p>运行后提示 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[*] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[*] Dobby</span><br><span class="line">[*] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[*] dobby in debug log mode, disable with cmake flag &quot;-DDOBBY_DEBUG&#x3D;OFF&quot;</span><br></pre></td></tr></table></figure>

<h5 id="Dobby-核心函数"><a href="#Dobby-核心函数" class="headerlink" title="Dobby 核心函数"></a>Dobby 核心函数</h5><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">DobbyHook</span><span class="params">(<span class="keyword">void</span> *address, <span class="keyword">void</span> *replace_call, <span class="keyword">void</span> **origin_call)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#address：需要 Hook 的函数地址</span></span><br><span class="line">#replace_all：新函数地址</span><br><span class="line">#origin_call：保留原始函数的指针的地址</span><br></pre></td></tr></table></figure>

<h5 id="Dobby-使用"><a href="#Dobby-使用" class="headerlink" title="Dobby 使用"></a>Dobby 使用</h5><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;DobbyX/dobby.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//2.定义函数指针，用于保存被替换函数的地址</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> (*sum_p)(<span class="keyword">int</span> a, <span class="keyword">int</span> b);</span><br><span class="line"></span><br><span class="line"><span class="comment">//1.定义将要被 HOOK 的函数</span></span><br><span class="line"><span class="keyword">int</span> sum(<span class="keyword">int</span> a, <span class="keyword">int</span> b) &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//3.定义新函数，用此函数替换将要HOOK的函数</span></span><br><span class="line"><span class="keyword">int</span> mySum(<span class="keyword">int</span> a, <span class="keyword">int</span> b) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;Sum: %d, 🍺🍺&quot;</span>, sum_p(a, b)); <span class="comment">//调用原函数</span></span><br><span class="line">    <span class="keyword">return</span> a - b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">  	<span class="comment">//4.调用DobbyHook进行函数的HOOK</span></span><br><span class="line">    DobbyHook(sum, mySum, (<span class="keyword">void</span> *)&amp;sum_p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;Sum: %d&quot;</span>, sum(<span class="number">10</span>, <span class="number">20</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#sum函数HOOK成功，先输出原始函数的执行结果，再输出替换函数的执行结果</span><br><span class="line">Sum: 30, 🍺🍺</span><br><span class="line">Sum: -10</span><br></pre></td></tr></table></figure>

<h5 id="HOOK函数地址"><a href="#HOOK函数地址" class="headerlink" title="HOOK函数地址"></a>HOOK函数地址</h5><p>逆向开发中，应用会剥离符号表，我们无法获得符号名称，所有 HOOK 的一定是地址</p>
<p>应用每次启动时，ASLR 偏移地址都不一样，所以不能直接 HOOK 地址</p>
<p>先找到函数在 MachO 中的偏移地址，加上 PAGEZERO 的 0x100000000，再加上本次启动的 ASLR 偏移地址</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&quot;Inject.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;DobbyX/dobby.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;mach-o/dyld.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Inject</span></span></span><br><span class="line"><span class="comment">//0x5F04 MachO上函数偏移地址</span></span><br><span class="line"><span class="keyword">static</span> uintptr_t sumP = <span class="number">0x5F04</span> + <span class="number">0x100000000</span>;</span><br><span class="line"></span><br><span class="line">+(<span class="keyword">void</span>)load&#123;</span><br><span class="line">   sumP += _dyld_get_image_vmaddr_slide(<span class="number">0</span>); <span class="comment">//+ASLR偏移地址</span></span><br><span class="line">   DobbyHook((<span class="keyword">void</span> *)sumP, mySum, (<span class="keyword">void</span> *)&amp;sum_p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> (*sum_p)(<span class="keyword">int</span> a,<span class="keyword">int</span> b);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> mySum(<span class="keyword">int</span> a,<span class="keyword">int</span> b) &#123;</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@&quot;Sum：%d，🍺🍺🍺🍺🍺&quot;</span>,sum_p(a,b));</span><br><span class="line">   <span class="keyword">return</span> a - b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>































]]></content>
      <categories>
        <category>逆向工具</category>
      </categories>
  </entry>
  <entry>
    <title>ReactiveObjC使用</title>
    <url>/2022/05/21/ReactiveObjC%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<ul>
<li>MVVM </li>
</ul>
<p>MVVM 中，view 和 view controller 联系在一起，我们把它们视为一个组件，view 和 view controller ，都不能直接引用 model，而是直接引用视图模型（viewModel）viewModel 是一个放置用户输入验证逻辑，视图显示逻辑，发起网络请求和其他代码的地方</p>
<p>view 引用 viewModel，但反过来不行，即不要在viewModel 中引入 #import UIKit.h，任何视图的引用都不应该放在 viewModel 中。viewModel 引用 model，但反过来不行</p>
<h4 id="1-MVVM登录"><a href="#1-MVVM登录" class="headerlink" title="1.MVVM登录"></a>1.MVVM登录</h4><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">需求：1.监听两个文本框的内容，有内容才允许按钮点击</span></span><br><span class="line"><span class="comment">     2.默认登录请求.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">用MVVM：实现，之前界面的所有业务逻辑</span></span><br><span class="line"><span class="comment">分析：1.之前界面的所有业务逻辑都交给控制器做处理</span></span><br><span class="line"><span class="comment">     2.在MVVM架构中把控制器的业务全部搬去VM模型，也就是每个控制器对应一个VM模型.</span></span><br><span class="line"><span class="comment">步骤：</span></span><br><span class="line"><span class="comment">    1.创建LoginViewModel类，处理登录界面业务逻辑.</span></span><br><span class="line"><span class="comment">    2.这个类里面应该保存着账号的信息，创建一个账号Account模型</span></span><br><span class="line"><span class="comment">    3.LoginViewModel应该保存着账号信息Account模型。</span></span><br><span class="line"><span class="comment">    4.需要时刻监听Account模型中的账号和密码的改变，怎么监听？</span></span><br><span class="line"><span class="comment">    5.在非RAC开发中，都是习惯赋值，在RAC开发中，需要改变开发思维，由赋值转变为绑定，可以在一开始初始化的时候，就给Account模型中的属性绑定，并不需要重写set方法。</span></span><br><span class="line"><span class="comment">    6.每次Account模型的值改变，就需要判断按钮能否点击，在VM模型中做处理，给外界提供一个能否点击按钮的信号.</span></span><br><span class="line"><span class="comment">    7.这个登录信号需要判断Account中账号和密码是否有值，用KVO监听这两个值的改变，把他们聚合成登录信号.</span></span><br><span class="line"><span class="comment">    8.监听按钮的点击，由VM处理，应该给VM声明一个RACCommand，专门处理登录业务逻辑.</span></span><br><span class="line"><span class="comment">    9.执行命令，把数据包装成信号传递出去</span></span><br><span class="line"><span class="comment">    10.监听命令中信号的数据传递</span></span><br><span class="line"><span class="comment">    11.监听命令的执行时刻</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">rac_textSignal只有用户输入才有效，如果只是直接赋值 </span><br><span class="line">eg:<span class="keyword">self</span>.inputView.phoneTextField.text = <span class="string">@&quot;xxxx&quot;</span>  <span class="keyword">self</span>.inputView.phoneTextField.rac_textSignal 就不会触发的</span><br><span class="line">RAC(<span class="keyword">self</span>.viewModel , mobilePhone) = </span><br><span class="line">[RACSignal merge: @[RACObserve(<span class="keyword">self</span>.inputView.phoneTextField,text),</span><br><span class="line">     								<span class="keyword">self</span>.inputView.phoneTextField.rac_textSignal]];</span><br></pre></td></tr></table></figure>

<h5 id="控制器代码"><a href="#控制器代码" class="headerlink" title="控制器代码"></a>控制器代码</h5><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) LoginViewModel *loginViewModel;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) <span class="keyword">IBOutlet</span> <span class="built_in">UITextField</span> *accountField;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) <span class="keyword">IBOutlet</span> <span class="built_in">UITextField</span> *pwdField;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) <span class="keyword">IBOutlet</span> <span class="built_in">UIButton</span> *loginBtn;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">- (LoginViewModel *)loginViewModel &#123;</span><br><span class="line">    <span class="keyword">if</span> (_loginViewModel == <span class="literal">nil</span>) &#123;</span><br><span class="line">        _loginViewModel = [[LoginViewModel alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _loginViewModel;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 视图模型绑定</span></span><br><span class="line">- (<span class="keyword">void</span>)bindModel &#123;</span><br><span class="line">    <span class="comment">// 给模型的属性绑定信号</span></span><br><span class="line">    <span class="comment">// 只要账号文本框一改变，就会给account赋值</span></span><br><span class="line">    RAC(<span class="keyword">self</span>.loginViewModel.account, account) = _accountField.rac_textSignal;</span><br><span class="line">    RAC(<span class="keyword">self</span>.loginViewModel.account, pwd) = _pwdField.rac_textSignal;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 绑定登录按钮</span></span><br><span class="line">    RAC(<span class="keyword">self</span>.loginBtn,enabled) = <span class="keyword">self</span>.loginViewModel.enableLoginSignal;</span><br><span class="line">    </span><br><span class="line">   <span class="comment">// 监听登录按钮点击</span></span><br><span class="line">    [[_loginBtn rac_signalForControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">        <span class="comment">// 执行登录事件</span></span><br><span class="line">        [<span class="keyword">self</span>.loginViewModel.LoginCommand execute:<span class="literal">nil</span>];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="VM代码"><a href="#VM代码" class="headerlink" title="VM代码"></a>VM代码</h5><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">LoginViewModel</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) Account *account;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否允许登录的信号</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) RACSignal *enableLoginSignal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) RACCommand *LoginCommand;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">LoginViewModel</span></span></span><br><span class="line">- (Account *)account</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (_account == <span class="literal">nil</span>) &#123;</span><br><span class="line">        _account = [[Account alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _account;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">instancetype</span>)init</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> initialBind];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化绑定</span></span><br><span class="line">- (<span class="keyword">void</span>)initialBind &#123;</span><br><span class="line">    <span class="comment">// 监听账号的属性值改变，把他们聚合成一个信号。</span></span><br><span class="line">    _enableLoginSignal = [RACSignal combineLatest:@[RACObserve(<span class="keyword">self</span>.account, account),RACObserve(<span class="keyword">self</span>.account, pwd)] reduce:^<span class="keyword">id</span>(<span class="built_in">NSString</span> *account,<span class="built_in">NSString</span> *pwd)&#123;</span><br><span class="line">        <span class="keyword">return</span> @(account.length &amp;&amp; pwd.length);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 处理登录业务逻辑</span></span><br><span class="line">    _LoginCommand = [[RACCommand alloc] initWithSignalBlock:^RACSignal *(<span class="keyword">id</span> input) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;点击了登录&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">            <span class="comment">// 模仿网络延迟</span></span><br><span class="line">            dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">0.5</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                [subscriber sendNext:<span class="string">@&quot;登录成功&quot;</span>];</span><br><span class="line">                <span class="comment">// 数据传送完毕，必须调用完成，否则命令永远处于执行状态</span></span><br><span class="line">                [subscriber sendCompleted];</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 监听登录产生的数据</span></span><br><span class="line">    [_LoginCommand.executionSignals.switchToLatest subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([x isEqualToString:<span class="string">@&quot;登录成功&quot;</span>]) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;登录成功&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 监听登录状态</span></span><br><span class="line">    [[_LoginCommand.executing skip:<span class="number">1</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([x isEqualToNumber:@(<span class="literal">YES</span>)]) &#123;</span><br><span class="line">            <span class="comment">// 正在登录ing... 用蒙版提示</span></span><br><span class="line">            [MBProgressHUD showMessage:<span class="string">@&quot;正在登录...&quot;</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="comment">// 登录成功 隐藏蒙版</span></span><br><span class="line">            [MBProgressHUD hideHUD];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-登录"><a href="#2-登录" class="headerlink" title="2.登录"></a>2.登录</h4><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//将信号输出应用到对象属性上</span></span><br><span class="line">RAC(<span class="keyword">self</span>.passwordTextField, backgroundColor) =</span><br><span class="line">[validPasswordSignal</span><br><span class="line">    map:^<span class="keyword">id</span>(<span class="built_in">NSNumber</span> *passwordValid)&#123;</span><br><span class="line">      <span class="keyword">return</span>[passwordValid boolValue] ? [<span class="built_in">UIColor</span> clearColor]:[<span class="built_in">UIColor</span> yellowColor];</span><br><span class="line">&#125;];</span><br><span class="line"> </span><br><span class="line">RAC(<span class="keyword">self</span>.usernameTextField, backgroundColor) =</span><br><span class="line">[validUsernameSignal</span><br><span class="line">    map:^<span class="keyword">id</span>(<span class="built_in">NSNumber</span> *passwordValid)&#123;</span><br><span class="line">     <span class="keyword">return</span>[passwordValid boolValue] ? [<span class="built_in">UIColor</span> clearColor]:[<span class="built_in">UIColor</span> yellowColor];</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">//聚合信号决定登录按钮是否可用</span></span><br><span class="line">RACSignal *signUpActiveSignal =</span><br><span class="line">  [RACSignal combineLatest:@[validUsernameSignal, validPasswordSignal]</span><br><span class="line">                    reduce:^<span class="keyword">id</span>(<span class="built_in">NSNumber</span>*usernameValid, <span class="built_in">NSNumber</span> *passwordValid)&#123;</span><br><span class="line">                      <span class="keyword">return</span> @([usernameValid boolValue]&amp;&amp;[passwordValid boolValue]);</span><br><span class="line">                    &#125;];</span><br><span class="line">[signUpActiveSignal subscribeNext:^(<span class="built_in">NSNumber</span>*signupActive)&#123;</span><br><span class="line">   <span class="keyword">self</span>.signInButton.enabled =[signupActive boolValue];</span><br><span class="line"> &#125;];</span><br><span class="line"></span><br><span class="line">[[[[<span class="keyword">self</span>.signInButton</span><br><span class="line">   rac_signalForControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>]</span><br><span class="line">   doNext:^(<span class="keyword">id</span> x)&#123; <span class="comment">//附加操作</span></span><br><span class="line">     <span class="keyword">self</span>.signInButton.enabled =<span class="literal">NO</span>;</span><br><span class="line">     <span class="keyword">self</span>.signInFailureText.hidden =<span class="literal">YES</span>;</span><br><span class="line">   &#125;]</span><br><span class="line">   flattenMap:^<span class="keyword">id</span>(<span class="keyword">id</span> x)&#123;</span><br><span class="line">     <span class="keyword">return</span>[<span class="keyword">self</span> signInSignal];</span><br><span class="line">   &#125;]</span><br><span class="line">   subscribeNext:^(<span class="built_in">NSNumber</span>*signedIn)&#123;</span><br><span class="line">     <span class="keyword">self</span>.signInButton.enabled =<span class="literal">YES</span>;</span><br><span class="line">     <span class="built_in">BOOL</span> success =[signedIn boolValue];</span><br><span class="line">     <span class="keyword">self</span>.signInFailureText.hidden = success;</span><br><span class="line">     <span class="keyword">if</span>(success)&#123;</span><br><span class="line">       [<span class="keyword">self</span> performSegueWithIdentifier:<span class="string">@&quot;signInSuccess&quot;</span> sender:<span class="keyword">self</span>];</span><br><span class="line">     &#125;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">- (RACSignal *)signInSignal &#123;</span><br><span class="line"><span class="keyword">return</span> [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber)&#123;</span><br><span class="line">   [<span class="keyword">self</span>.signInService </span><br><span class="line">     signInWithUsername:<span class="keyword">self</span>.usernameTextField.text</span><br><span class="line">               password:<span class="keyword">self</span>.passwordTextField.text</span><br><span class="line">               complete:^(<span class="built_in">BOOL</span> success)&#123;</span><br><span class="line">                    [subscriber sendNext:@(success)];</span><br><span class="line">                    [subscriber sendCompleted];</span><br><span class="line">     &#125;];</span><br><span class="line">   	 <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">  &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-MVVM网络请求"><a href="#3-MVVM网络请求" class="headerlink" title="3.MVVM网络请求"></a>3.MVVM网络请求</h4><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">需求：请求豆瓣图书信息，url:https://api.douban.com/v2/book/search?q=基础</span></span><br><span class="line"><span class="comment">分析：请求一样，交给VM模型管理</span></span><br><span class="line"><span class="comment">步骤:</span></span><br><span class="line"><span class="comment">    1.控制器提供一个视图模型（requesViewModel），处理界面的业务逻辑</span></span><br><span class="line"><span class="comment">    2.VM提供一个命令，处理请求业务逻辑</span></span><br><span class="line"><span class="comment">    3.在创建命令的block中，会把请求包装成一个信号，等请求成功的时候，就会把数据传递出去。</span></span><br><span class="line"><span class="comment">    4.请求数据成功，应该把字典转换成模型，保存到视图模型中，控制器想用就直接从视图模型中获取。</span></span><br><span class="line"><span class="comment">    5.假设控制器想展示内容到tableView，直接让视图模型成为tableView的数据源，把所有的业务逻辑交给视图模型去做，这样控制器的代码就非常少了。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h5 id="控制器代码-1"><a href="#控制器代码-1" class="headerlink" title="控制器代码"></a>控制器代码</h5><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="built_in">UITableView</span> *tableView;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) RequestViewModel *requesViewModel;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line">- (RequestViewModel *)requesViewModel &#123;</span><br><span class="line">    <span class="keyword">if</span> (_requesViewModel == <span class="literal">nil</span>) &#123;</span><br><span class="line">        _requesViewModel = [[RequestViewModel alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _requesViewModel;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">  [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建tableView</span></span><br><span class="line">  <span class="built_in">UITableView</span> *tableView = [[<span class="built_in">UITableView</span> alloc] initWithFrame:<span class="keyword">self</span>.view.bounds];</span><br><span class="line">  tableView.dataSource = <span class="keyword">self</span>.requesViewModel;</span><br><span class="line"></span><br><span class="line">  [<span class="keyword">self</span>.view addSubview:tableView];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 执行请求</span></span><br><span class="line">  RACSignal *requesSiganl = [<span class="keyword">self</span>.requesViewModel.reuqesCommand execute:<span class="literal">nil</span>];</span><br><span class="line">   <span class="comment">// 获取请求的数据</span></span><br><span class="line">    [requesSiganl subscribeNext:^(<span class="built_in">NSArray</span> *x) &#123;</span><br><span class="line">        <span class="keyword">self</span>.requesViewModel.models = x;</span><br><span class="line">        [<span class="keyword">self</span>.tableView reloadData]; </span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h5 id="VM代码-1"><a href="#VM代码-1" class="headerlink" title="VM代码"></a>VM代码</h5><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">RequestViewModel</span> : <span class="title">NSObject</span>&lt;<span class="title">UITableViewDataSource</span>&gt;</span></span><br><span class="line"><span class="comment">// 请求命令</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) RACCommand *reuqesCommand;</span><br><span class="line"><span class="comment">//模型数组</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSArray</span> *models;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">RequestViewModel</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> initialBind];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)initialBind &#123;</span><br><span class="line">    _reuqesCommand = [[RACCommand alloc] initWithSignalBlock:^RACSignal *(<span class="keyword">id</span> input) &#123;</span><br><span class="line">        </span><br><span class="line">        RACSignal *requestSignal = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">  </span><br><span class="line">            <span class="built_in">NSMutableDictionary</span> *parameters = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">            parameters[<span class="string">@&quot;q&quot;</span>] = <span class="string">@&quot;基础&quot;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 发送请求</span></span><br><span class="line">            [[AFHTTPRequestOperationManager manager] GET:<span class="string">@&quot;https://api.douban.com/v2/book/search&quot;</span> parameters:parameters success:^(AFHTTPRequestOperation *operation, <span class="keyword">id</span> responseObject) &#123;</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,responseObject);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 请求成功调用</span></span><br><span class="line">                <span class="comment">// 把数据用信号传递出去</span></span><br><span class="line">                [subscriber sendNext:responseObject];</span><br><span class="line">                [subscriber sendCompleted];</span><br><span class="line"></span><br><span class="line">            &#125; failure:^(AFHTTPRequestOperation *operation, <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">                <span class="comment">// 请求失败调用</span></span><br><span class="line">            &#125;];</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">        &#125;];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在返回数据信号时，把数据中的字典映射成模型信号，传递出去</span></span><br><span class="line">        <span class="keyword">return</span> [requestSignal map:^<span class="keyword">id</span>(<span class="built_in">NSDictionary</span> *value) &#123;</span><br><span class="line">            <span class="built_in">NSMutableArray</span> *dictArr = value[<span class="string">@&quot;books&quot;</span>];</span><br><span class="line">            <span class="comment">// 字典转模型，遍历字典中的所有元素，全部映射成模型，并且生成数组</span></span><br><span class="line">            <span class="built_in">NSArray</span> *modelArr = [[dictArr.rac_sequence map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">                <span class="keyword">return</span> [Book bookWithDict:value];</span><br><span class="line">            &#125;] array];</span><br><span class="line">            <span class="keyword">return</span> modelArr;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;];</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark - UITableViewDataSource</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSInteger</span>)tableView:(<span class="built_in">UITableView</span> *)tableView numberOfRowsInSection:(<span class="built_in">NSInteger</span>)section</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.models.count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UITableViewCell</span> *)tableView:(<span class="built_in">UITableView</span> *)tableView cellForRowAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSString</span> *ID = <span class="string">@&quot;cell&quot;</span>;</span><br><span class="line">    <span class="built_in">UITableViewCell</span> *cell = [tableView dequeueReusableCellWithIdentifier:ID];</span><br><span class="line">    <span class="keyword">if</span> (cell == <span class="literal">nil</span>) &#123;</span><br><span class="line">        cell = [[<span class="built_in">UITableViewCell</span> alloc] initWithStyle:<span class="built_in">UITableViewCellStyleSubtitle</span> reuseIdentifier:ID];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Book *book = <span class="keyword">self</span>.models[indexPath.row];</span><br><span class="line">    cell.detailTextLabel.text = book.subtitle;</span><br><span class="line">    cell.textLabel.text = book.title;</span><br><span class="line">    <span class="keyword">return</span> cell;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h4 id="4-Cell复用问题"><a href="#4-Cell复用问题" class="headerlink" title="4.Cell复用问题"></a>4.Cell复用问题</h4><p> Cell复用时清理数据绑定或者事件监听的问题</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">SUGoodsCell</span></span></span><br><span class="line">- (<span class="keyword">void</span>) awakeFromNib &#123;</span><br><span class="line">    [<span class="keyword">super</span> awakeFromNib];</span><br><span class="line">    RAC(<span class="keyword">self</span>.usernameLabel,  text) = RACObserve(<span class="keyword">self</span>,  viewModel.username);</span><br><span class="line">    RAC(<span class="keyword">self</span>.userIdLabel,  text) = RACObserve(<span class="keyword">self</span>,  viewModel.userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 注意viewModel出现在RACObserve宏中逗号右边。 这些 cell 终将被重用，新的viewModels将会被赋值，如果我们不将 viewModel放在逗号右边，那就会监听viewModel属性的变化然后每次都要重新设置绑定；如果放在逗号右边， RACObserve将会为我们负责这些事儿， 因此我们只需要设定一次绑定并让Reactive Cocoa做剩余的部分</p>
<p> 当然，RAC给UITableViewCell提供了一个方法：rac_prepareForReuseSignal，它的作用是当Cell即将要被重用时，告诉Cell。想象Cell上有多个button，Cell在初始化时给每个button都addTarget:action:forControlEvents，被重用时需要先移除这些target，下面这段代码就可以很方便地解决这个问题</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[[[<span class="keyword">self</span>.cancelButton</span><br><span class="line">    rac_signalForControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>]</span><br><span class="line">    takeUntil:<span class="keyword">self</span>.rac_prepareForReuseSignal]</span><br><span class="line">    subscribeNext:^(<span class="built_in">UIButton</span> *x) &#123;</span><br><span class="line">    <span class="comment">// do other things</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<ul>
<li>cell 复用</li>
</ul>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 外界订阅处理 </span></span><br><span class="line">cell.button.rx.tap .subscribe(onNext: &#123; () <span class="keyword">in</span> </span><br><span class="line">print(</span><br><span class="line">  <span class="string">&quot;点击了 \(indexPath)&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">.disposed(by: cell.disposeBag)</span><br><span class="line"> </span><br><span class="line"><span class="comment">// cell内部处理 </span></span><br><span class="line">override func prepareForReuse() &#123;</span><br><span class="line">    <span class="keyword">super</span>.prepareForReuse() </span><br><span class="line">    <span class="comment">// 销毁垃圾袋重置</span></span><br><span class="line">    disposeBag = DisposeBag()</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<h4 id="5-UITableView-MVVM-RAC"><a href="#5-UITableView-MVVM-RAC" class="headerlink" title="5.UITableView MVVM+RAC"></a>5.UITableView MVVM+RAC</h4><p><a href="https://www.jianshu.com/p/119559ac0961">https://www.jianshu.com/p/119559ac0961</a></p>
<p>viewModel 绑定整个视图，通过 viewModel 获得列表 model后，创建 cellModel（celll的viewModel），每个 cell 绑定 cellModel，cell 根据cellModel变化而变化</p>
<img src="ReactiveObjC使用/图片2.png" alt="图片2" style="zoom:67%;" />

<p>cell单独配置对应的cellviewmodel rac网络请求回来后，把实体model用cellviewmodel进行组装，</p>
<p>主viewmodel请求数据 解析成 [model]</p>
<p>转换成 [cellViewModel]</p>
<p>!(cell加了一层viewmodel 项目变得复杂了)</p>
<p>cell中有个cellVM来管理cell中要显示的数据，cellVM来自于VC中datasource数组</p>
<p>网络请求完成后将字典-》模型 再通过模型初始化cellVM 再将cellVM放入datasource</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">RAC(_defaultLab, hidden) = [RACObserve(cellModel, idDefault) not];</span><br></pre></td></tr></table></figure>

<h4 id="6-网络下图图片完成按钮可点击"><a href="#6-网络下图图片完成按钮可点击" class="headerlink" title="6.网络下图图片完成按钮可点击"></a>6.网络下图图片完成按钮可点击</h4><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">-(<span class="keyword">void</span>)btnAvliableWhenImgOK&#123;</span><br><span class="line">    <span class="comment">//  观察img 是否修改，如果修改就会触发</span></span><br><span class="line">    RACSignal * imagAvaibaleSignal = [RACObserve(<span class="keyword">self</span>, <span class="keyword">self</span>.imageView.image) map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">        <span class="keyword">return</span>  value ? @YES : @NO;</span><br><span class="line">    &#125;];    </span><br><span class="line">    [imagAvaibaleSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;xx =%@&quot;</span>,x);</span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="keyword">self</span>.shareBtn.rac_command = [[RACCommand alloc] initWithEnabled:imagAvaibaleSignal signalBlock:^RACSignal *(<span class="keyword">id</span> input) &#123;</span><br><span class="line">        <span class="comment">// do share logic</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;input =%@&quot;</span>,input);</span><br><span class="line">        <span class="keyword">return</span> [RACSignal empty];<span class="comment">// 必须返回一个信号，不能返回nil</span></span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="comment">// 一个command 需要execute 才能触发执行 但是和btn绑定的command不需要</span></span><br><span class="line">    <span class="comment">//  [self.shareBtn.rac_command execute:@&quot;100&quot;];</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="7-token失效"><a href="#7-token失效" class="headerlink" title="7.token失效"></a>7.token失效</h4><p>token 失效后捕获 error，重新请求 token，concat 拼接继续上一次请求</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">RACSignal *requestSignal = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    <span class="comment">// suppose first time send request, access token is expired or invalid</span></span><br><span class="line">    <span class="comment">// and next time it is correct.</span></span><br><span class="line">    <span class="comment">// the block will be triggered twice.</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">BOOL</span> isFirstTime = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">NSString</span> *url = <span class="string">@&quot;http://httpbin.org/ip&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (!isFirstTime) &#123;</span><br><span class="line">        url = <span class="string">@&quot;http://nonexists.com/error&quot;</span>;</span><br><span class="line">        isFirstTime = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;url:%@&quot;</span>, url);</span><br><span class="line">    [[AFHTTPRequestOperationManager manager] GET:url parameters:<span class="literal">nil</span> success:^(AFHTTPRequestOperation *operation, <span class="keyword">id</span> responseObject) &#123;</span><br><span class="line">        [subscriber sendNext:responseObject];</span><br><span class="line">        [subscriber sendCompleted];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;subscriber sendcompleted&quot;</span>);</span><br><span class="line">    &#125; failure:^(AFHTTPRequestOperation *operation, <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;subscriber send error&quot;</span>);</span><br><span class="line">        [subscriber sendError:error];</span><br><span class="line"></span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="keyword">self</span>.labelForName.text = <span class="string">@&quot;sending request...&quot;</span>;</span><br><span class="line"><span class="comment">//Subscribes to the returned signal when an error occurs.</span></span><br><span class="line"></span><br><span class="line">[[requestSignal catch:^RACSignal *(<span class="built_in">NSError</span> *error) &#123;<span class="comment">// requestSignal 发送error 触发 catch&#123;&#125;  catch 中返回的signal 发送next 在subcribeNext接收后，再追加一次requestSignal</span></span><br><span class="line">    <span class="keyword">self</span>.labelForName.text = <span class="string">@&quot;oops, invalid access token&quot;</span>;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;catch ....&quot;</span>);</span><br><span class="line">    <span class="comment">// 模拟获取token的请求，然后concat requestSignal，再次发送之前的请求</span></span><br><span class="line">    <span class="keyword">return</span> [[RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        <span class="keyword">double</span> delayInSeconds = <span class="number">1.0</span>;</span><br><span class="line">        dispatch_time_t popTime = dispatch_time(DISPATCH_TIME_NOW, (int64_t)(delayInSeconds * <span class="built_in">NSEC_PER_SEC</span>));</span><br><span class="line">        dispatch_after(popTime, dispatch_get_main_queue(), ^(<span class="keyword">void</span>)&#123;</span><br><span class="line">            [subscriber sendNext:@YES];</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;subscriber sendNext...&quot;</span>);</span><br><span class="line">            [subscriber sendCompleted];</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;]concat:requestSignal];</span><br><span class="line">&#125;] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;next =%@&quot;</span>,x);</span><br><span class="line">    <span class="keyword">if</span> ([x isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">self</span>.labelForName.text = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;result:%@&quot;</span>, x[<span class="string">@&quot;origin&quot;</span>]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125; completed:^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;completed&quot;</span>);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h4 id="8-Command-登录"><a href="#8-Command-登录" class="headerlink" title="8.Command 登录"></a>8.Command 登录</h4><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">self</span>.loginCommand = [[RACCommand alloc] initWithSignalBlock:^RACSignal *(<span class="keyword">id</span> input) &#123;</span><br><span class="line">    <span class="comment">//模拟login signal</span></span><br><span class="line">    <span class="keyword">return</span> [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        [subscriber sendNext:<span class="string">@&quot;1000&quot;</span>];</span><br><span class="line">        [subscriber sendCompleted];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// -executionSignals returns a signal that includes the signals returned from</span></span><br><span class="line"><span class="comment">// the above block, one for each time the command is executed.</span></span><br><span class="line">[<span class="keyword">self</span>.loginCommand.executionSignals subscribeNext:^(RACSignal *loginSignal) &#123;</span><br><span class="line">    <span class="comment">// Log a message whenever we log in successfully.</span></span><br><span class="line">    [loginSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;xxx  %@&quot;</span>,x);</span><br><span class="line">    &#125;];</span><br><span class="line">    [loginSignal subscribeCompleted:^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;Logged in successfully!&quot;</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Executes the login command when the button is pressed. 按钮点击触发</span></span><br><span class="line"><span class="keyword">self</span>.shareBtn.rac_command = <span class="keyword">self</span>.loginCommand;</span><br></pre></td></tr></table></figure>

<h4 id="9-搜索框搜索"><a href="#9-搜索框搜索" class="headerlink" title="9.搜索框搜索"></a>9.搜索框搜索</h4><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[[[[[[<span class="keyword">self</span>.textField.rac_textSignal throttle:<span class="number">1</span>]distinctUntilChanged]ignore:<span class="string">@&quot;&quot;</span>] map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;value =%@&quot;</span>,value);</span><br><span class="line">    <span class="keyword">return</span> [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        <span class="comment">//  network request</span></span><br><span class="line">        [subscriber sendNext:value];</span><br><span class="line">        [subscriber sendCompleted];</span><br><span class="line">        <span class="keyword">return</span> [RACDisposable disposableWithBlock:^&#123;</span><br><span class="line">            <span class="comment">//  cancel request</span></span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;] switchToLatest] subscribeNext:^(<span class="keyword">id</span> x) &#123;<span class="comment">// 如果不switchToLastest 则返回一个signal</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;x = %@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h4 id="10-MVVM-RAC"><a href="#10-MVVM-RAC" class="headerlink" title="10.MVVM+RAC"></a>10.MVVM+RAC</h4><p>获取列表数据</p>
<p>在 MVVM 里，网络通信相关的操作都是由 viewModel 来处理的，所以在 ViewModel 里定义一个 RACCommand</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*  获取数据Command</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) RACCommand *fetchProductCommand;</span><br><span class="line"></span><br><span class="line"><span class="comment">//在ViewModel 的 init 方法对它进行初始化</span></span><br><span class="line">_fetchProductCommand = [[RACCommand alloc]initWithSignalBlock:^RACSignal *(<span class="keyword">id</span> input) &#123;</span><br><span class="line">     <span class="keyword">return</span> [[[APIClient sharedClient]</span><br><span class="line">              fetchProductWithPageIndex:@(<span class="number">1</span>)]</span><br><span class="line">              takeUntil:<span class="keyword">self</span>.cancelCommand.executionSignals];</span><br><span class="line"> &#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">//订阅Command，获取数据后赋值给 items</span></span><br><span class="line">@weakify(<span class="keyword">self</span>);</span><br><span class="line">[[_fetchProductCommand.executionSignals switchToLatest] subscribeNext:^(ResponseData *response) &#123;</span><br><span class="line">    @strongify(<span class="keyword">self</span>);</span><br><span class="line">    <span class="keyword">if</span> (!response.success) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.errors sendNext:response.error];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.items = [ProductListModel objectArrayWithKeyValuesArray:response.data];</span><br><span class="line">        <span class="keyword">self</span>.page = response.page;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<p>在 ViewController 里，订阅 ViewModel 的 items，有变化时 reload tableview</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[RACObserve(<span class="keyword">self</span>.viewModel, items) subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">     @strongify(<span class="keyword">self</span>);</span><br><span class="line">     [<span class="keyword">self</span>.table reloadData];</span><br><span class="line"> &#125;];</span><br></pre></td></tr></table></figure>

<p>tableView 的 dataSource</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark - UITableViewDataSource</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSInteger</span>)numberOfSectionsInTableView:(<span class="built_in">UITableView</span> *)tableView &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSInteger</span>)tableView:(<span class="built_in">UITableView</span> *)tableView numberOfRowsInSection:(<span class="built_in">NSInteger</span>)section &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.viewModel.items.count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UITableViewCell</span> *)tableView:(<span class="built_in">UITableView</span> *)tableView cellForRowAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</span><br><span class="line">    ProductListCell *cell = [tableView dequeueReusableCellWithIdentifier:<span class="string">@&quot;ProductListCell&quot;</span> forIndexPath:indexPath];</span><br><span class="line">    cell.viewModel = [<span class="keyword">self</span>.viewModel itemViewModelForIndex:indexPath.row];</span><br><span class="line">    <span class="keyword">return</span> cell;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UITableViewCell 中</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)initWithCoder:(<span class="built_in">NSCoder</span> *)aDecoder &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> initWithCoder:aDecoder];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        @weakify(<span class="keyword">self</span>);</span><br><span class="line">        [RACObserve(<span class="keyword">self</span>, viewModel) subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">            @strongify(<span class="keyword">self</span>);</span><br><span class="line">            <span class="keyword">self</span>.productNameLabel.text = <span class="keyword">self</span>.viewModel.ProductName;</span><br><span class="line">            <span class="keyword">self</span>.bankNameLabel.text = <span class="keyword">self</span>.viewModel.ProductBank;</span><br><span class="line">            <span class="keyword">self</span>.profitLabel.text = <span class="keyword">self</span>.viewModel.ProductProfit;</span><br><span class="line">            <span class="keyword">self</span>.saleStatusLabel.text = <span class="keyword">self</span>.viewModel.SaleStatusCn;</span><br><span class="line">            <span class="keyword">self</span>.productTermLabel.text = <span class="keyword">self</span>.viewModel.ProductTerm;</span><br><span class="line">            <span class="keyword">self</span>.productAmtLabel.text = <span class="keyword">self</span>.viewModel.ProductAmt;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="11-Error"><a href="#11-Error" class="headerlink" title="11.Error"></a>11.Error</h4><p>BaseViewModel</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">BaseViewModel</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) RACSubject *errors;</span><br></pre></td></tr></table></figure>

<p>ViewModel 对 RACCommand 的 errors 进行合并</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[[RACSignal merge:@[_fetchProductCommand.errors, <span class="keyword">self</span>.fetchMoreProductCommand.errors]] subscribe:<span class="keyword">self</span>.errors];</span><br></pre></td></tr></table></figure>

<p>RACCommannd 判断是否出现 error</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">@weakify(<span class="keyword">self</span>);</span><br><span class="line">[[_fetchProductCommand.executionSignals switchToLatest] subscribeNext:^(ResponseData *response) &#123;</span><br><span class="line">   @strongify(<span class="keyword">self</span>);</span><br><span class="line">   <span class="keyword">if</span> (!response.success) &#123;</span><br><span class="line">       [<span class="keyword">self</span>.errors sendNext:response.error];</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="keyword">self</span>.items = [ProductListModel objectArrayWithKeyValuesArray:response.data];</span><br><span class="line">       <span class="keyword">self</span>.page = response.page;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<p>ViewController 中对 errors 进行订阅 </p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[_viewModel.errors subscribeNext:^(<span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">   ResponseData *data = [ResponseData objectWithKeyValues:error.userInfo];</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@&quot;something error:%@&quot;</span>, data.keyValues);</span><br><span class="line">   <span class="comment">//<span class="doctag">TODO:</span> 这里可以选择一种合适的方式将错误信息展示出来</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h4 id="12-http-请求-cancel"><a href="#12-http-请求-cancel" class="headerlink" title="12.http 请求 cancel"></a>12.http 请求 cancel</h4><p>ViewModel 中定义一个表示取消HTTP请求的 RACCommand</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) RACCommand *cancelCommand;</span><br><span class="line"></span><br><span class="line"> _fetchProductCommand = [[RACCommand alloc]initWithSignalBlock:^RACSignal *(<span class="keyword">id</span> input) &#123;</span><br><span class="line">   <span class="keyword">return</span> [[[APIClient sharedClient]</span><br><span class="line">            fetchProductWithPageIndex:@(<span class="number">1</span>)]</span><br><span class="line">            takeUntil:<span class="keyword">self</span>.cancelCommand.executionSignals];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

































<p><a href="https://www.cnblogs.com/manji/p/4846591.html">一次 MVVM+RAC实践</a></p>
<p><a href="https://www.jianshu.com/p/e10e5ca413b7">ReactiveCocoa进阶篇</a></p>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
  </entry>
  <entry>
    <title>逆向-Theos</title>
    <url>/2022/07/04/%E9%80%86%E5%90%91-Theos/</url>
    <content><![CDATA[<p><a href="https://www.cnblogs.com/ludashi/p/5714095.html">逆向工程之Theos</a></p>
<p><a href="https://theos.dev/docs/logos">Tweak Logos</a></p>
<p>Theos 一个跨平台的越狱开发工具包</p>
<p>Theos 相当于对 Cydia Substrate 的封装，因而能实现对 Object-C 运行时的 Hook，也能实现对 C 语言函数的 Hook</p>
<h4 id="Theos-安装"><a href="#Theos-安装" class="headerlink" title="Theos 安装"></a>Theos 安装</h4><h5 id="安装-ldid"><a href="#安装-ldid" class="headerlink" title="安装 ldid"></a>安装 ldid</h5><p>Theos 开发中，iOS 文件的签名由 ldid 工具来完成，ldid 取代了 Xcode 自带的 codesign</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ brew instll ldid</span><br></pre></td></tr></table></figure>

<p>或者下载 <a href="http://joedj.net/ldid">http://joedj.net/ldid</a> 放到 /opt/theos/bin 目录下，添加执行权限</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo chmod 777 &#x2F;opt&#x2F;theos&#x2F;bin&#x2F;ldid</span><br></pre></td></tr></table></figure>

<ul>
<li>安装 xz、lzma（没装）</li>
</ul>
<p>两种压缩模块，为了后面 <code>make package</code> 能顺利通过</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ brew install xz</span><br><span class="line">$ sudo cpan IO::Compress::Lzma</span><br></pre></td></tr></table></figure>

<h5 id="安装-dpkg，dpkg-deb"><a href="#安装-dpkg，dpkg-deb" class="headerlink" title="安装 dpkg，dpkg-deb"></a>安装 dpkg，dpkg-deb</h5><p>可以使用 dpkg 制作 deb，Theos开发的插件都会以deb的格式进行发布</p>
<p>有了 dpkg-deb，Theos才能正确把工程打包成 deb 文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">brew install dpkg</span><br><span class="line">brew install dpkg-deb</span><br></pre></td></tr></table></figure>

<ul>
<li>添加环境变量</li>
</ul>
<p>.bash_profile</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">export THEOS&#x3D;&#x2F;opt&#x2F;theos</span><br><span class="line">export PATH&#x3D;$PATH:$THEOS&#x2F;bin</span><br></pre></td></tr></table></figure>

<h5 id="安装-theos"><a href="#安装-theos" class="headerlink" title="安装 theos"></a>安装 theos</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ sudo git clone --recursive https:&#x2F;&#x2F;github.com&#x2F;theos&#x2F;theos.git $THEOS</span><br></pre></td></tr></table></figure>

<ul>
<li>设置 $THEOS 用户组权限</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ sudo chown -R $(id -u):$(id -g) $THEOS</span><br></pre></td></tr></table></figure>

<p>最后 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ source ~&#x2F;.bash_profile</span><br></pre></td></tr></table></figure>

<h4 id="常用模块"><a href="#常用模块" class="headerlink" title="常用模块"></a>常用模块</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$THEOS&#x2F;bin&#x2F;nic.pl</span><br><span class="line">NIC 2.0 - New Instance Creator</span><br><span class="line">------------------------------</span><br><span class="line">  [1.] iphone&#x2F;activator_event</span><br><span class="line">  [2.] iphone&#x2F;application_modern</span><br><span class="line">  [3.] iphone&#x2F;application_swift</span><br><span class="line">  [4.] iphone&#x2F;flipswitch_switch</span><br><span class="line">  [5.] iphone&#x2F;framework</span><br><span class="line">  [6.] iphone&#x2F;library</span><br><span class="line">  [7.] iphone&#x2F;preference_bundle_modern</span><br><span class="line">  [8.] iphone&#x2F;tool</span><br><span class="line">  [9.] iphone&#x2F;tool_swift</span><br><span class="line">  [10.] iphone&#x2F;tweak</span><br><span class="line">  [11.] iphone&#x2F;xpc_service</span><br><span class="line">Choose a Template (required):</span><br></pre></td></tr></table></figure>

<p>tweak：插件模板</p>
<p>tool：命令行工具模板</p>
<p>application：系统级应用模板</p>
<p>xpc_service：XPC 服务模板</p>
<h4 id="Tweak插件开发"><a href="#Tweak插件开发" class="headerlink" title="Tweak插件开发"></a>Tweak插件开发</h4><p>iOS 越狱平台下的插件称为 tweak。实质就是 iOS 平台的动态库 dylib，利用 Cydia Substrate 提供的组件进行加载，完成特定功能</p>
<p>所有 Tweak 都保存在 /Library/MobileSubstrate/DynamicLibraries 目录，Tweak 后缀名为 .dylib</p>
<p>终端输入 nic.pl，工程模板选择 [10.] iphone/tweak，创建一个 tweak 工程</p>
<ul>
<li>配置参数</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Project Name (required): 项目名称</span><br><span class="line">Package Name [com.yourcompany.langjitweak]: 包名</span><br><span class="line">Author&#x2F;Maintainer Name 作者名字，默认当前登录用户名</span><br><span class="line">[iphone&#x2F;tweak] MobileSubstrate Bundle filter: 注入应用的BundleID</span><br><span class="line">[iphone&#x2F;tweak] List of applications to terminate upon installation (space-separated, &#39;-&#39; for none) [SpringBoard]: 安装成功后需结束的进程，默认SpringBoard，不需要结束任务进程输入 -</span><br></pre></td></tr></table></figure>

<p>为了方便修改，可以在生成的文件夹新建 Xcode 项目，将文件拖入 Xcode 项目编辑</p>
<ul>
<li>目录结构</li>
</ul>
<p>![图片 1](逆向-Theos/图片 1.png)</p>
<h5 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h5><p>指定工程用到源文件、框架、库等信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#引入Makefile的公共文件</span><br><span class="line">include $(THEOS)&#x2F;makefiles&#x2F;common.mk  </span><br><span class="line">#指定处理器架构 多个架构空格分开 最新的A12处理器设备还需要arm64e</span><br><span class="line">ARCHS&#x3D;arm64 arm64e</span><br><span class="line"></span><br><span class="line">#指定目标规范 A12处理器设备指定SDK版本必须大于10.1</span><br><span class="line">#指定目标平台为iOS，编译器为clang，使用10.2版本SDK编译该tweak，编译后的程序只能在8.0及以上系统运行</span><br><span class="line"></span><br><span class="line">TARGET &#x3D; iphone:clang:10.2:8.0</span><br><span class="line">#可以省略编译类型 SDK设置为latest 指定Tweak支持的系统版本</span><br><span class="line">TARGET &#x3D; iphone:latest:8.0</span><br><span class="line"></span><br><span class="line">#指定的项目名称</span><br><span class="line">TWEAK_NAME &#x3D; iThunderHelper		</span><br><span class="line">iThunderHelper_CFLAGS &#x3D; -fobjc-arc</span><br><span class="line"></span><br><span class="line">#tweak包含的源文件(头文件除外)多个文件空格分开</span><br><span class="line">#如 iThunderHelper_FILES &#x3D; Tweak.xm ANYMethodLog.m PYG.m</span><br><span class="line">iThunderHelper_FILES &#x3D; Tweak.xm				</span><br><span class="line"></span><br><span class="line">#根据不同工程类型指定.mk文件，tweak工程是tweak.mk 还可以填入 application.mk及tool.mk</span><br><span class="line">include $(THEOS_MAKE_PATH)&#x2F;tweak.mk</span><br><span class="line"></span><br><span class="line">#导入Framework</span><br><span class="line">iThunderHelper_FRAMEWORKS &#x3D; UIKit</span><br><span class="line"></span><br><span class="line">#导入私有Framework</span><br><span class="line">iThunderHelper_PRIVATE_FRAMEWORKS &#x3D; ChatKit</span><br><span class="line"></span><br><span class="line">#链接动态库 libz.dylib和libsqlite.dylib</span><br><span class="line">iThunderHelper_LDFLAGS &#x3D; -lz -lsqlite</span><br><span class="line"></span><br><span class="line">iThunderHelper_LIBRARIES &#x3D; rocketbootstrap</span><br><span class="line"></span><br><span class="line">#这里做了端口映射 需要iproxy 2222 22</span><br><span class="line">THEOS_DEVICE_IP &#x3D; localhost</span><br><span class="line">THEOS_DEVICE_PORT &#x3D; 2222  </span><br><span class="line">或者</span><br><span class="line">THEOS_DEVICE_IP &#x3D; IP地址 </span><br><span class="line"></span><br><span class="line">#安装后执行的命令</span><br><span class="line">after-install::  </span><br><span class="line">	install.exec &quot;kill -9 MobileSMS&quot;</span><br></pre></td></tr></table></figure>

<h5 id="Tweak-xm"><a href="#Tweak-xm" class="headerlink" title="Tweak.xm"></a>Tweak.xm</h5><p> 生成的默认源文件，后缀 .xm 表示支持 Logos 和 C/C++语法，如果后缀为 .x ，说明源文件支持 Logos和C语法</p>
<h5 id="control"><a href="#control" class="headerlink" title="control"></a>control</h5><p>deb 包的必备文件，记录 deb 包管理系统所需的基本信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Package: com.ithunderhelper #deb包的唯一ID</span><br><span class="line">Name: ithunderhelper #描述tweak名字</span><br><span class="line"></span><br><span class="line">#deb包的依赖项，多个依赖逗号隔开，指定版本号则在后面用括号标注</span><br><span class="line"># Depends: mobilesubstrate, com.rpetrich.rocketbootstrap(&gt;&#x3D;1.0.2)</span><br><span class="line">Depends: mobilesubstrate </span><br><span class="line"></span><br><span class="line">Version: 0.0.1	#deb包当前版本</span><br><span class="line">Architecture: iphoneos-arm #描述deb包的架构，不可修改</span><br><span class="line">Description: An awesome MobileSubstrate tweak!  #对tweak的简要描述</span><br><span class="line">Maintainer: cao #deb包维护人员</span><br><span class="line">Author: cao  #描述tweak的开发者</span><br><span class="line">Section: Tweaks #deb包所属类别</span><br></pre></td></tr></table></figure>

<h5 id="iThunderHelper-plist"><a href="#iThunderHelper-plist" class="headerlink" title="iThunderHelper.plist"></a>iThunderHelper.plist</h5><p> tweak的作用对象</p>
<h5 id="编译打包安装"><a href="#编译打包安装" class="headerlink" title="编译打包安装"></a>编译打包安装</h5><ul>
<li>编译</li>
</ul>
<p>编译 make，从日志看到 Theos 完成了预处理、编译、链接、签名一系列动作</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ make</span><br></pre></td></tr></table></figure>

<p>编译生成 dylib 文件保存在 .theos/obj/debug/ 文件夹下</p>
<p>arm64和armv7分别有相应架构的 dylib 文件，外层的dylib 则是所有架构合并后的</p>
<ul>
<li>指定编译模式</li>
</ul>
<p>tweak 默认编译模式是 debug，如果想改为 release，只需要指定 DEBUG=0</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ DEBUG&#x3D;0 make</span><br></pre></td></tr></table></figure>

<ul>
<li>打包</li>
</ul>
<p>make package 会先执行 make 命令，然后执行 dpkg-deb 命令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ make package</span><br></pre></td></tr></table></figure>

<p>在 ./packages 目录生成一个 deb 包</p>
<ul>
<li>安装</li>
</ul>
<p>图形安装：</p>
<p>可以把 deb 通过爱思助手或者 scp 拷贝到设备指定目录，iFile 找到 deb 包，进入文件详情，点击安装</p>
<p>命令行安装：</p>
<p>scp 拷贝到设备，再利用 dpkg 命令安装</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ dpkg -i xxx.deb</span><br></pre></td></tr></table></figure>

<p>通过Theos安装</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ make package install</span><br></pre></td></tr></table></figure>

<h4 id="Logos语法"><a href="#Logos语法" class="headerlink" title="Logos语法"></a>Logos语法</h4><h5 id="hook"><a href="#hook" class="headerlink" title="%hook"></a>%hook</h5><p>指定需要hook的Class 以%end结尾</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">%hook MainViewController</span><br><span class="line"><span class="comment">//hook的方法</span></span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<h5 id="log"><a href="#log" class="headerlink" title="%log"></a>%log</h5><p>打印类名、函数、参数等信息</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">%log((<span class="built_in">NSString</span> *)<span class="string">@&quot;tutuTest&quot;</span>, (<span class="built_in">NSString</span> *)<span class="string">@&quot;Debug&quot;</span>);</span><br></pre></td></tr></table></figure>

<h5 id="orig"><a href="#orig" class="headerlink" title="%orig"></a>%orig</h5><p>执行原始代码</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//可以有返回值 </span></span><br><span class="line"><span class="keyword">id</span> value = %orig;</span><br><span class="line"><span class="comment">//调用原来方法 </span></span><br><span class="line"><span class="keyword">id</span> value = %orig(arg1);</span><br><span class="line"></span><br><span class="line"><span class="comment">//%orig还可以更改原始函数的参数  %orig(参数)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//将arg的参数修改为change arg2</span></span><br><span class="line">%orig(<span class="string">@&quot;change arg2&quot;</span>, arg2); </span><br></pre></td></tr></table></figure>

<h5 id="group"><a href="#group" class="headerlink" title="%group"></a>%group</h5><p>将hook分组，便于代码管理及按条件初始化，以%end结尾</p>
<p>一个 %group 可以包含多个%hook，不属于某个自定义group的%hook会被归类到%group _ungrouped中</p>
<p>如果定义了group 那么一定要写%init(group)</p>
<p>%init初始化某个%group 必须在%hook或%ctor内调用</p>
<p>调用了%init，%group才能起作用</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">%group group1</span><br><span class="line">%hook ViewController</span><br><span class="line">-(<span class="keyword">void</span>)loginBtnCloick:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;111&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">%end</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%group group2</span><br><span class="line">%hook ViewController</span><br><span class="line">-(<span class="keyword">void</span>)loginBtnCloick:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;222&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">%end</span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<p>group需要初始化</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">%ctor &#123;</span><br><span class="line"> <span class="built_in">NSString</span> *v = [[<span class="built_in">UIDevice</span> currentDevice] systemVersion];</span><br><span class="line"> <span class="keyword">if</span>(v.doubleValue &gt; <span class="number">11.0</span>) &#123;</span><br><span class="line">    %init(group1)；</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    %init(group2)；</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%hook TargetClass</span><br><span class="line">- (<span class="keyword">void</span>)targetMethod &#123;</span><br><span class="line">  <span class="built_in">NSString</span> *v = [[<span class="built_in">UIDevice</span> currentDevice] systemVersion];</span><br><span class="line"> <span class="keyword">if</span>(v.doubleValue &gt; <span class="number">11.0</span>) &#123;</span><br><span class="line">    %init(group1)；</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    %init(group2)；</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<h5 id="ctor"><a href="#ctor" class="headerlink" title="%ctor"></a>%ctor</h5><p>完成初始化工作 没定义会隐式生成 构造函数，构造函数</p>
<p>一般可以用来初始化%group 不需要%end结尾</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">%hook SpringBoard</span><br><span class="line"><span class="comment">//hook方法</span></span><br><span class="line">%end</span><br><span class="line">%ctor &#123;</span><br><span class="line">    %init(_ungrouped); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="dtor"><a href="#dtor" class="headerlink" title="%dtor"></a>%dtor</h5><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">%dtor &#123;</span><br><span class="line">    <span class="comment">//析构</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="new"><a href="#new" class="headerlink" title="%new"></a>%new</h5><p>给现有class添加新函数</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">%hook XLMemberManager</span><br><span class="line"><span class="comment">//hook方法</span></span><br><span class="line"><span class="comment">//%new 不用%end  写在%hook类内部</span></span><br><span class="line">%new</span><br><span class="line">- (<span class="keyword">void</span>)newmethod &#123;</span><br><span class="line">&#125;</span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<p>添加了新方法，使用 [self newmethod] 调用会报错。</p>
<p>只需要加个定义，骗过编译器</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">XLMemberManager</span></span></span><br><span class="line">- (<span class="keyword">void</span>)newmethod;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h5 id="c"><a href="#c" class="headerlink" title="%c"></a>%c</h5><p>动态获取一个类的定义 相当于objc_getClass 或 NSClassFroming</p>
<p>获取某个类 %c(ViewController)</p>
<p>然后可以调用类方法</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">XLMemberConfigure</span></span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line">...</span><br><span class="line">XLMemberConfigure *configure = [[%c(XLMemberConfigure) alloc] init];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;memberConfigure=%@&quot;</span>, configure);</span><br></pre></td></tr></table></figure>

<h5 id="property"><a href="#property" class="headerlink" title="%property"></a>%property</h5><p>添加属性</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">%subclass MyObject: <span class="built_in">NSObject</span></span><br><span class="line">%property (<span class="keyword">nonatomic</span>, <span class="keyword">retain</span>) <span class="built_in">NSString</span> *someValue;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h5 id="subclass"><a href="#subclass" class="headerlink" title="%subclass"></a>%subclass</h5><p>运行时创建子类</p>
<p>父类中不存在的方法用%new说明符，要实例化新类的一个对象用%c运算符</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">%subclass MyObject : <span class="built_in">NSObject</span></span><br><span class="line">- (<span class="keyword">id</span>)init &#123;</span><br><span class="line">	<span class="keyword">self</span> = %orig;</span><br><span class="line">	[<span class="keyword">self</span> setSomeValue:<span class="string">@&quot;value&quot;</span>];</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//the following two new methods act as `@property (nonatomic, retain) id someValue;`</span></span><br><span class="line">%new</span><br><span class="line">- (<span class="keyword">id</span>)someValue &#123;</span><br><span class="line">	<span class="keyword">return</span> objc_getAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(someValue));</span><br><span class="line">&#125;</span><br><span class="line">%new</span><br><span class="line">- (<span class="keyword">void</span>)setSomeValue:(<span class="keyword">id</span>)value &#123;</span><br><span class="line">	objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(someValue), value, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">&#125;</span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<h5 id="hookf"><a href="#hookf" class="headerlink" title="%hookf"></a>%hookf</h5><p>给指定函数生成Hook，是对 MSHookFunction() 函数的包装格式</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//rtype：返回值</span></span><br><span class="line"><span class="comment">//symbolName：原函数地址</span></span><br><span class="line">%hookf(rtype, symbolName, args...)&#123;...&#125;</span><br></pre></td></tr></table></figure>

<p>symbolName 可以传入函数地址或者函数符号</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//传入地址</span></span><br><span class="line">FILE *fopen(<span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">const</span> <span class="keyword">char</span> *mode);</span><br><span class="line">%hookf(File *, fopen, <span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">const</span> <span class="keyword">char</span> *mode) &#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;fopen hooked&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(path[<span class="number">0</span>] !=<span class="string">&#x27;/&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> %orig;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果将 symbolName 作为字符串传入，那么函数将被动态查找</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">FILE *fopen(<span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">const</span> <span class="keyword">char</span> *mode);</span><br><span class="line">%hookf(File *, <span class="string">&quot;_open&quot;</span>, <span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">const</span> <span class="keyword">char</span> *mode) &#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;fopen hooked&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(path[<span class="number">0</span>] !=<span class="string">&#x27;/&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> %orig;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Logos-Tip"><a href="#Logos-Tip" class="headerlink" title="Logos Tip"></a>Logos Tip</h4><h5 id="获取类成员变量"><a href="#获取类成员变量" class="headerlink" title="获取类成员变量"></a>获取类成员变量</h5><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//使用substitute提供的MSHookIvar</span></span><br><span class="line"><span class="built_in">UIView</span> *_anyView = MSHookIvar&lt;<span class="built_in">UIView</span>*&gt;(<span class="keyword">self</span>,<span class="string">&quot;_view&quot;</span>);</span><br><span class="line">_anyView.backgroundColor = [<span class="built_in">UIColor</span> redColor];</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用原生valueForKey</span></span><br><span class="line">XLMemberConfigure *config = [<span class="keyword">self</span> valueForKey:<span class="string">@&quot;_config&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用ZKSwizzle提供的ZKHookIvar</span></span><br><span class="line"><span class="meta">#import ZKSwizzle<span class="meta-string">&quot;&quot;</span></span></span><br><span class="line"><span class="built_in">NSString</span> *deviceMode = ZKHookIvar(config, <span class="built_in">NSString</span> *, <span class="string">&quot;_deviceModel&quot;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>打印参数Class</li>
</ul>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+ (<span class="keyword">void</span>)showLuckyMoneyWithPickingStatus:(<span class="built_in">NSObject</span> *)arg1 withController:(<span class="keyword">id</span>)arg2 delegate:(<span class="keyword">id</span>)arg3</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">NSLog</span>(<span class="string">@&quot;status = %@, className = %@&quot;</span>,arg1,<span class="built_in">NSStringFromClass</span>(arg1.class));</span><br><span class="line">	%log; %orig;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>方法声明</li>
</ul>
<p>需要在注入的类里面调用某个方法 添加方法的声明就可以了 </p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">P1HomeNearbyViewController</span> : <span class="title">UIViewController</span></span></span><br><span class="line">- (<span class="keyword">void</span>)takeAction:(<span class="keyword">id</span>)arg1 withEvent:(<span class="keyword">id</span>)arg2;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>也可以不用写父类 </p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">P1HomeNearbyViewController</span></span></span><br><span class="line">- (<span class="keyword">void</span>)takeAction:(<span class="keyword">id</span>)arg1 withEvent:(<span class="keyword">id</span>)arg2;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>再 hook P1HomeNearbyViewController的 takeAction 方法里就可以直接用self 否则会self报错</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)takeAction:(<span class="keyword">id</span>)arg1 withEvent:(<span class="keyword">id</span>)arg2 &#123;</span><br><span class="line">  dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">1.0</span> * <span class="built_in">NSEC_PER_SEC</span>)),      dispatch_get_main_queue(), ^&#123;</span><br><span class="line">      [<span class="keyword">self</span> takeAction:arg1 withEvent:arg2];</span><br><span class="line">  &#125;);</span><br><span class="line">  %log;</span><br><span class="line">  %or&#125;ig;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>类声明</li>
</ul>
<p>为了通过编译，有些类需要声明，可以创建 .h 头文件，内容都是从 class-dump 出来的文件拷贝</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">PSSpecifier</span>:<span class="title">NSObject</span> </span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">retain</span>) <span class="keyword">id</span> target;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">PSSpecifier</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>Tweak.xm </p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&quot;PSSpecifier.h&quot;</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>修改返回值</li>
</ul>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//能否预览 直接1可以预览</span></span><br><span class="line">- (_Bool )canPreview &#123;</span><br><span class="line">  %log;</span><br><span class="line">  _Bool r = %orig;</span><br><span class="line">  r = <span class="number">1</span>;<span class="comment">//返回1</span></span><br><span class="line">  HBLogDebug(<span class="string">@&quot; = %d&quot;</span>, r);</span><br><span class="line">  <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>注释方法</li>
</ul>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)timerAction:(<span class="keyword">id</span>)arg1 &#123;</span><br><span class="line">  %log;</span><br><span class="line">  <span class="comment">//%orig;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>阻止alertcontroller弹窗</li>
</ul>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//添加方法声明 重写presentViewController方法 阻止alertController显示</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">LivePlayBackVC</span> : <span class="title">UIViewController</span></span></span><br><span class="line">- (<span class="keyword">void</span>)presentViewController:(<span class="built_in">UIViewController</span> *)present animated:(<span class="built_in">BOOL</span>)animated completion:(<span class="keyword">void</span> (^ _Nullable)(<span class="keyword">void</span>))completion;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line">  </span><br><span class="line">%hook LivePlayBackVC</span><br><span class="line">- (<span class="keyword">void</span>)presentViewController:(<span class="built_in">UIViewController</span> *)present animated:(<span class="built_in">BOOL</span>)animated completion:(<span class="keyword">void</span> (^ _Nullable)(<span class="keyword">void</span>))completion&#123;</span><br><span class="line">    HBLogDebug(<span class="string">@&quot;presentViewController&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<ul>
<li>控制器跳转 </li>
</ul>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">TBBuyStandardViewController *vc = [[%c(TBBuyStandardViewController) alloc] initWithNavigatorURL:arg1 query: arg2];</span><br></pre></td></tr></table></figure>

<h4 id="命令行工具开发"><a href="#命令行工具开发" class="headerlink" title="命令行工具开发"></a>命令行工具开发</h4><p>Theos 提供的 tool 模板用来编写命令行工具，Cydia Substrate 自带的 cynject 工具就是例子</p>
<p>编写小工具，根据输入进程名查找 PID （等同于ps -ax | grep xxx）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$THEOS&#x2F;bin&#x2F;nic.pl</span><br><span class="line">NIC 2.0 - New Instance Creator</span><br><span class="line">------------------------------</span><br><span class="line">[8.] iphone&#x2F;tool</span><br><span class="line">Choose a Template (required): 8</span><br><span class="line">Project Name (required): FindProcess</span><br><span class="line">Package Name [com.yourcompany.findprocess]:com.FindProcess</span><br><span class="line">Author&#x2F;Maintainer Name [midland]:</span><br><span class="line">Instantiating iphone&#x2F;tool in findprocess&#x2F;...</span><br><span class="line">Done.</span><br></pre></td></tr></table></figure>

<p>创建 tool 工程，接下来步骤和 tweak 类似，打开 main.mm 修改代码…</p>
<p>由于使用了纯 C 代码，输入 make 命令直接编译会出现错误，需将 main.mm 修改为 main.c</p>
<p>同时修改 Makefile 中的 findprocess_FILES 一行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">findprocess_FILES &#x3D; main.c</span><br></pre></td></tr></table></figure>

<p>DEBUG=0 make package install 将命令行工具安装到设备</p>
<p>如果提示 THEOS_DEVICE_IP 问题，添加环境变量</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">export THEOS_DEVICE_IP&#x3D;192.168.0.101</span><br></pre></td></tr></table></figure>



<ul>
<li>兼容 iOS11-iOS13</li>
</ul>
<p>编译好的包在 iOS11-iOS13 可能出现 <code>killed:9</code> 错误</p>
<p>新建 ent.xml</p>
<img src="逆向-Theos/图片 2.png" alt="图片 2" style="zoom:80%;" />

<p>修改 Makefile，配置 CODESIGN_FLAGS 参数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">findprocess_CODESIGN_FLAGS &#x3D; -S.&#x2F;ent.xml</span><br></pre></td></tr></table></figure>

<p>修改安装路径（不是必须的）命令行工具默认安装到 /usr/bin 目录，该路径可以修改配置 INSTALL_PATH 参数即可</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">findprocess_INSERT_PATH&#x3D; &#x2F;bin</span><br></pre></td></tr></table></figure>

<p>重新编译安装后 Cydia 里路径被改为 /bin 了</p>
<img src="逆向-Theos/图片 3.png" alt="图片 3" style="zoom:50%;" />

<p>测试</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">~root# findprocess WeChat</span><br></pre></td></tr></table></figure>

<h4 id="系统应用开发"><a href="#系统应用开发" class="headerlink" title="系统应用开发"></a>系统应用开发</h4><p>Theos 提供的 application 模板用来开发系统级应用比如 Filza，权限更高无法通过常规方式删除</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$THEOS&#x2F;bin&#x2F;nic.pl</span><br><span class="line">NIC 2.0 - New Instance Creator</span><br><span class="line">------------------------------</span><br><span class="line">[2.] iphone&#x2F;application_modern</span><br><span class="line">Choose a Template (required): 2</span><br><span class="line">Project Name (required): bookApp</span><br><span class="line">Package Name [com.yourcompany.bookapp]: com.bookApp</span><br><span class="line">Author&#x2F;Maintainer Name [midland]:</span><br><span class="line">[iphone&#x2F;application_modern] Class name prefix (two or more characters) [XX]:CD</span><br></pre></td></tr></table></figure>

<p>生成文件</p>
<img src="逆向-Theos/图片 4.png" alt="图片 4" style="zoom:90%;" />

<p>修改文件 CDRootViewController.m 内容</p>
<img src="逆向-Theos/图片 5.png" alt="图片 5" style="zoom:80%;" />

<p>代码在视图中间添加 Test 按钮，单机按钮，获取进程权限，然后打开keychain数据库，由于使用了 sqlite3，所以需要修改 Makefile，增加 xxx_LDFLAGS参数将其链接进来</p>
<img src="逆向-Theos/图片 6.png" alt="图片 6" style="zoom:70%;" />

<p>after-install 是 deb 文件安装后执行的命令。第二条命令是结束进程</p>
<p>DEBUG=0 make package install 编译安装到设备</p>
<p>运行日志 getuid 和 geteuid 都返回了501（mobile权限）代码执行失败</p>
<ul>
<li>以root权限运行（iOS11以下）</li>
</ul>
<p>Linux下可以使用 setuid(0)及setgid(0)提升权限，打开 main.m 修改如下</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[]) &#123;</span><br><span class="line">	<span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        setuid(<span class="number">0</span>);</span><br><span class="line">        setgid(<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, <span class="built_in">NSStringFromClass</span>(CDAppDelegate.class));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译安装后闪退了，这是因为backboardd以mobile权限运行不能加载要求root权限的程序</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">~root# ps aux | grep backboardd</span><br><span class="line">mobile 2438 0.6 1.0 .....</span><br></pre></td></tr></table></figure>

<p>换句话说，崩溃是好事，说明提升成功了，对 iOS11 以下的系统处理方法比较复杂</p>
<p>。。。</p>
<ul>
<li>以root权限运行（iOS11、iOS12）</li>
<li>以root权限运行（iOS13）</li>
</ul>
<h4 id="守护进程开发"><a href="#守护进程开发" class="headerlink" title="守护进程开发"></a>守护进程开发</h4><p>守护进程是一个运行在系统后台、不受前台用户交互影响的进程，通常，守护进程以字母 d 结尾</p>
<p>其实就是一个命令行程序和一个 plist 文件构成</p>
<p>syslogd 是处理系统日志的后台，afc2d是文件服务的后台进程等</p>
<p>编写一个简单 pygioserbookd 守护进程，启动时打印一行日志，并往 tmp 目录写入 pp.log 文件后常驻后台</p>
<p>选择 tool 模板创建工程</p>
<p>修改 main.mm</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp) &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *str = <span class="string">@&quot;[PYGiOSBook] 守护进程启动成功&quot;</span>;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, str);</span><br><span class="line">    [str writeToFile:<span class="string">@&quot;/tmp/pp.log&quot;</span> atomically:<span class="literal">YES</span> encoding:<span class="built_in">NSUTF8StringEncoding</span> error:<span class="literal">nil</span>];</span><br><span class="line">    <span class="comment">//保持运行</span></span><br><span class="line">    <span class="built_in">CFRunLoopRun</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>安装到设备，测试</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root# pygioserbookd</span><br></pre></td></tr></table></figure>

<h5 id="守护进程配置"><a href="#守护进程配置" class="headerlink" title="守护进程配置"></a>守护进程配置</h5><p>新建 com.pygioserbookd.plist </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE plist PUBLIC &quot;-&#x2F;&#x2F;Apple&#x2F;&#x2F;DTD PLIST 1.0&#x2F;&#x2F;EN&quot; &quot;http:&#x2F;&#x2F;www.apple.com&#x2F;DTDs&#x2F;PropertyList-1.0.dtd&quot;&gt;</span><br><span class="line">&lt;plist version&#x3D;&quot;1.0&quot;&gt;</span><br><span class="line">&lt;dict&gt;</span><br><span class="line">	&lt;key&gt;RunAtLoad&lt;&#x2F;key&gt;</span><br><span class="line">	&lt;string&gt;true&lt;&#x2F;string&gt;</span><br><span class="line">	&lt;key&gt;Program&lt;&#x2F;key&gt;</span><br><span class="line">	&lt;string&gt;&#x2F;usr&#x2F;bin&#x2F;pygioserbookd&lt;&#x2F;string&gt;</span><br><span class="line">	&lt;key&gt;Label&lt;&#x2F;key&gt;</span><br><span class="line">	&lt;string&gt;com.pygioserbookd&lt;&#x2F;string&gt;</span><br><span class="line">&lt;&#x2F;dict&gt;</span><br><span class="line">&lt;&#x2F;plist&gt;</span><br></pre></td></tr></table></figure>

<p>Label：守护进程唯一标识</p>
<p>Program：对应的可执行文件</p>
<p>RunAtLoad：加载的同时启动</p>
<p>如果后台进程需要其它的参数，只需要在文件中增加类似下面的键值对即可</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;key&gt;ProgramArguments&lt;&#x2F;key&gt;</span><br><span class="line">&lt;array&gt;</span><br><span class="line">	&lt;string&gt;-m&lt;&#x2F;string&gt;</span><br><span class="line">	&lt;string&gt;-i&lt;&#x2F;string&gt;</span><br><span class="line">	&lt;string&gt;其它参数&lt;&#x2F;string&gt;</span><br><span class="line">&lt;&#x2F;array&gt;</span><br></pre></td></tr></table></figure>

<p>iOS 的根进程是 launchd，它会在开机时检查 /System/Library/LaunchDaemons 和 /Library/LaunchDaemons 目录下所有符合条件的 plist 文件。</p>
<p>所以把 com.pygioserbookd.plist 文件放到上面任意目录下，输入 reboot 重启设备（又要重新越狱），查看发现 pygioserbookd 已随系统启动</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root# ps aux | grep pygioserbookd</span><br></pre></td></tr></table></figure>

<p>也可以不重启，iOS 提供了 launchctl 命令行工具。用于显示、加载、卸载、启动和关闭守护进程</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;获取信息</span><br><span class="line">&#x2F;&#x2F;第一列进程ID，如果显示 - 说明已加载，但没运行</span><br><span class="line">&#x2F;&#x2F;第二列上次退出的状态码，0成功，正数错误退出，负数收到信号后退出</span><br><span class="line">&#x2F;&#x2F;第三列守护进程唯一标识</span><br><span class="line">root# launchctl list  </span><br><span class="line">-   78 com.apple.networkd_priv</span><br><span class="line">258 0  com.apple.apsd</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;加载&#x2F;卸载（load&#x2F;unload）</span><br><span class="line">root# launchctl load &#x2F;Library&#x2F;LaunchDaemons&#x2F;com.pygioserbookd.plist</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;启动&#x2F;停止（start&#x2F;stop）</span><br><span class="line">root# launchctl start com.pygioserbookd</span><br></pre></td></tr></table></figure>

<h5 id="自动部署"><a href="#自动部署" class="headerlink" title="自动部署"></a>自动部署</h5><p>编写好守护进程，处理那些 plist 文件需要人工干预来处理，这里利用 Theos 的 layout 功能来完成自动部署</p>
<p>工程目录下创建 layout 文件夹，theos 在打包时会将其中的内容按照路径添加到 deb 包中</p>
<p>1、先将 com.pygioserbookd.plist 文件放到 layout/Library/LaunchDaemons 文件夹内</p>
<p>2、新建 DEBIAN 文件夹并将 control 移进来</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ mkdir .&#x2F;layout&#x2F;DEBIAN</span><br><span class="line">$ mv control .&#x2F;layout&#x2F;DEBIAN</span><br></pre></td></tr></table></figure>

<p>3、在 DEBIAN 文件夹中分别新建 postinst、preinst、prerm 文件，各自内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#postinst deb包安装完成后所需的配置工作</span><br><span class="line">#!bin&#x2F;sh</span><br><span class="line">launchctl load &#x2F;Library&#x2F;LaunchDaemons&#x2F;com.pygioserbookd.plist</span><br><span class="line"></span><br><span class="line">#preinst 解压前执行的脚本</span><br><span class="line">#!bin&#x2F;sh</span><br><span class="line">launchctl unload &#x2F;Library&#x2F;LaunchDaemons&#x2F;com.pygioserbookd.plist 2&gt;&amp;1 &gt; &#x2F;dev&#x2F;null</span><br><span class="line"></span><br><span class="line">#prerm 卸载deb包前执行</span><br><span class="line">#!bin&#x2F;sh</span><br><span class="line">launchctl unload &#x2F;Library&#x2F;LaunchDaemons&#x2F;com.pygioserbookd.plist</span><br></pre></td></tr></table></figure>

<p>这几个脚本分别用于 deb 包安装前后的一些处理，其实是吧人工执行 launchctl 命令的过程用脚本代替</p>
<p>make package 打包后，所有文件已经按照 layout 的结构打包进去了。</p>
<p>利用 layout 能方便地将所有需要集成的文件统一进行处理</p>
<p>make package install 安装完后通过 launchctl list 查看 pygioserbookd 是还未启动的</p>
<ul>
<li>报错问题</li>
</ul>
<p>make package 之后提示 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ERROR: maintainer script &#39;preinst&#39; has bad permissions 644 (must be &gt;&#x3D;0555 and &lt;&#x3D;0775)</span><br><span class="line"></span><br><span class="line">#添加权限</span><br><span class="line">chmod 755 preinst</span><br><span class="line">chmod 755 postinst</span><br><span class="line">chmod 755 prerm</span><br></pre></td></tr></table></figure>





<h4 id="增加系统设置项"><a href="#增加系统设置项" class="headerlink" title="增加系统设置项"></a>增加系统设置项</h4><p>PreferenceLoader 是一个开源的基础依赖包，越狱插件的系统设置菜单就是由它提供，Cydia 搜索安装 PreferenceLoader</p>
<p>进入系统设置时 PreferenceLoader 会从 /Library/PreferenceLoader/Preferences/ 目录下解析符合规则的 plist 文件，并生成响应的控件动态添加到系统设置</p>
<p><a href="http://iphonedevwiki.net/index.php/PreferenceBundles">http://iphonedevwiki.net/index.php/PreferenceBundles</a></p>
<p><a href="https://iphonedev.wiki/index.php/Preferences_specifier_plist">https://iphonedev.wiki/index.php/Preferences_specifier_plist</a></p>
<p>theos 选择 iphone/preference_bundle_modern 模板</p>
<blockquote>
<p>需要引用私有库 Preferences，编译提示找不到路径</p>
</blockquote>
<h4 id="进程间通信"><a href="#进程间通信" class="headerlink" title="进程间通信"></a>进程间通信</h4><p>进程间通信（IPC）就是在不同进程之间传播或交换信息，正向开发中只能使用苹果公司提供 URLScheme，应用之间互相调用并且传送简单字符的一种机制</p>
<h5 id="Notification通信"><a href="#Notification通信" class="headerlink" title="Notification通信"></a>Notification通信</h5><p>CFNotificationCenterGetDarwinNotifyCenter() 有一个 userinfo 参数，但实际上无法传递，总是为 nil，不适合传递参数</p>
<h5 id="XPC通信"><a href="#XPC通信" class="headerlink" title="XPC通信"></a>XPC通信</h5><p>仅限于系统级别应用，如果用普通应用是不可达的</p>
<h5 id="RocketBootstrap通信"><a href="#RocketBootstrap通信" class="headerlink" title="RocketBootstrap通信"></a>RocketBootstrap通信</h5><p><a href="https://iphonedev.wiki/index.php/RocketBootstrap#CPDistributedMessagingCenter_Example">RocketBootstrap</a></p>
<p>私有框架 APPSupport 中存在一个 CPDistributedMessagingCenter（分布式消息传递中心）使用简单的消息和字典来提供不同进程之间的通信</p>
<p>RocketBootstrap 就是在其上进行封装，越过沙盒限制，给越狱环境提供稳定的进程通信服务，cydia 中搜索安装即可</p>
<p>RocketBootstrap 要求在权限比较高的进程中启动一个服务，再通过发送通知的方式越过沙盒，因此创建一个 tweak 并注入 SpringBoard进程</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;rocketbootstrap/rocketbootstrap.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;AppSupport/CPDistributedMessagingCenter.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">%group HookSpringBoard</span><br><span class="line"></span><br><span class="line">%hook SpringBoard</span><br><span class="line">- (<span class="keyword">void</span>)applicationDidFinishLaunching:(<span class="keyword">id</span>)application &#123;</span><br><span class="line">    %orig;</span><br><span class="line">    CPDistributedMessagingCenter *c = [%c(CPDistributedMessagingCenter) centerNamed:<span class="string">@&quot;MyCPCenter&quot;</span>];</span><br><span class="line">    rocketbootstrap_distributedmessagingcenter_apply(c);</span><br><span class="line">    [c runServerOnCurrentThread];</span><br><span class="line">    [c registerForMessageName:<span class="string">@&quot;MyCPCenterNoti&quot;</span> target: <span class="keyword">self</span> selector:<span class="keyword">@selector</span>(handleMessage:withUserInfo:)];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;注册监听&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//收到沙盒内发的消息时弹出对话框</span></span><br><span class="line">%new</span><br><span class="line">- (<span class="keyword">void</span>)handleMessage:(<span class="built_in">NSString</span> *)name withUserInfo:(<span class="built_in">NSDictionary</span> *)userInfo &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;handleMessage withUserInfo&quot;</span>);</span><br><span class="line">    <span class="built_in">NSString</span> *action = userInfo[<span class="string">@&quot;action&quot;</span>];</span><br><span class="line">    <span class="keyword">if</span> ([action isEqualToString:<span class="string">@&quot;AlertView&quot;</span>]) &#123;</span><br><span class="line">        <span class="built_in">NSString</span> *nsInfo = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;book=%@, author=%@&quot;</span>, userInfo[<span class="string">@&quot;book&quot;</span>], userInfo[<span class="string">@&quot;author&quot;</span>]];</span><br><span class="line">        <span class="built_in">UIAlertView</span> *alert = [[<span class="built_in">UIAlertView</span> alloc] initWithTitle:<span class="string">@&quot;来自应用沙盒的消息&quot;</span> message:nsInfo delegate:<span class="literal">nil</span> cancelButtonTitle:<span class="string">@&quot;确定&quot;</span> otherButtonTitles: <span class="literal">nil</span>, <span class="literal">nil</span>];</span><br><span class="line">        [alert show];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%ctor &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;__[PYGiOSReBook] inject success__&quot;</span>);</span><br><span class="line">    <span class="built_in">NSString</span> *bundleIdentifier = [[<span class="built_in">NSBundle</span> mainBundle] bundleIdentifier];</span><br><span class="line">    <span class="keyword">if</span> ([bundleIdentifier isEqualToString:<span class="string">@&quot;com.apple.springboard&quot;</span>]) &#123;</span><br><span class="line">        %init(HookSpringBoard);</span><br><span class="line">    &#125;</span><br><span class="line">    %init;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改 Makefile</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">include $(THEOS)&#x2F;makefiles&#x2F;common.mk</span><br><span class="line"></span><br><span class="line">TWEAK_NAME &#x3D; RocketBootstrapTest</span><br><span class="line"></span><br><span class="line">RocketBootstrapTest_FILES &#x3D; Tweak.xm</span><br><span class="line">RocketBootstrapTest_CFLAGS &#x3D; -fobjc-arc</span><br><span class="line"></span><br><span class="line">include $(THEOS_MAKE_PATH)&#x2F;tweak.mk</span><br><span class="line"></span><br><span class="line">ARCHS &#x3D; arm64</span><br><span class="line">RocketBootstrapTest_LIBRARIES &#x3D; rocketbootstrap</span><br><span class="line">RocketBootstrapTest_PRIVATE_FRAMEWORKS &#x3D; AppSupport</span><br></pre></td></tr></table></figure>

<p>还需要添加 AppSupport 框架，可以在 <a href="https://github.com/theos/sdks">https://github.com/theos/sdks</a>  找到SDK 版本，选择和自己 SDK 接近的版本就可以了</p>
<p>下载的 SDK 两种使用方法：</p>
<p>1、如选择 iPhoneOS14.5，将整个 iPhoneOS14.5.sdk 文件夹复制到 $THEOS/sdks 目录下</p>
<p>修改 Makefile 的 TARGET 字段，强制指定 SDK 为下载版本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">TARGET &#x3D; iphone:14.5:8.0</span><br></pre></td></tr></table></figure>

<p>2、将 iPhoneOS14.5.sdk/System/Library/PrivateFrameworks 目录下找到所需要的私有库（也可以全部选择）复制到目录</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;Applications&#x2F;Xcode.app&#x2F;Contents&#x2F;Developer&#x2F;Platforms&#x2F;iPhoneOS.platform&#x2F;Developer&#x2F;SDKs&#x2F;iPhoneOS.sdk&#x2F;System&#x2F;Library&#x2F;PrivateFr-ameworks</span><br><span class="line">（书上写的是PrivateFr-ameworks 不知道是不是写错了是 PrivateFrameworks）</span><br></pre></td></tr></table></figure>

<blockquote>
<p>两种方式都没成功，make 编译找不到库 ld: framework not found AppSupport</p>
</blockquote>
<ul>
<li>发送消息</li>
</ul>
<p>Xcode 新建项目，</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;rocketbootstrap/rocketbootstrap.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;AppSupport/CPDistributedMessagingCenter.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSMutableDictionary</span> *userInfo = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">userInfo[<span class="string">@&quot;action&quot;</span>] = <span class="string">@&quot;AlertView&quot;</span>;</span><br><span class="line">userInfo[<span class="string">@&quot;book&quot;</span>] = <span class="string">@&quot;book1&quot;</span>;</span><br><span class="line">userInfo[<span class="string">@&quot;author&quot;</span>] = <span class="string">@&quot;author1&quot;</span>;</span><br><span class="line">CPDistributedMessagingCenter *c = [CPDistributedMessagingCenter centerNamed:<span class="string">@&quot;MyCPCenter&quot;</span>];</span><br><span class="line">rocketbootstrap_distributedmessagingcenter_apply(c);</span><br><span class="line">[c sendMessageName:<span class="string">@&quot;MyCPCenterNoti&quot;</span> userInfo:userInfo];</span><br></pre></td></tr></table></figure>

<p>还要配置头文件路径。Build Setting - Header Search Paths 添加 /opt/theos/vendor/include</p>
<p>接着将 /opt/theos/vendor/lib/librocketbootstrap.tbd 动态库添加到项目</p>
<blockquote>
<p>#import &lt;AppSupport/CPDistributedMessagingCenter.h&gt; 找不到文件，只能把 AppSupport.framework 拖入项目，新建了两个项目一个注册监听，一个发送消息，测试结果两个app间没收到消息，有空再试</p>
</blockquote>
<h4 id="deb重打包"><a href="#deb重打包" class="headerlink" title="deb重打包"></a>deb重打包</h4><p>有时候需要对别人 deb 包进行修改破解限制，就需要 deb 重打包</p>
<p>新建必要目录，存放解包后的文件及打包后的文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ mkdir extract</span><br><span class="line">$ mkdir extract&#x2F;DEBIAN</span><br><span class="line">$ mkdir build</span><br></pre></td></tr></table></figure>

<h5 id="安装-dpkg"><a href="#安装-dpkg" class="headerlink" title="安装 dpkg"></a>安装 dpkg</h5><p>安装 <a href="https://www.macports.org/install.php">MacPorts</a> 软件包管理软件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ sudo port install dpkg</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ brew install dpkg</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ dpkg-deb -c deb文件 &#x2F;&#x2F;显示文件列表</span><br><span class="line">$ dpkg-deb -X deb文件 输出路径 &#x2F;&#x2F;解压获取到Library中文件，里面有dylib</span><br><span class="line">$ dpkg-deb -e deb文件 输出路径 &#x2F;&#x2F;解压获取到Control文件</span><br><span class="line">$ dpkg-deb -R deb文件 输出路径 &#x2F;&#x2F;获取到 dylib和control文件</span><br><span class="line">$ dpkg-deb -b 通过-解压出来的文件 xxx.deb &#x2F;&#x2F;打包生成deb</span><br></pre></td></tr></table></figure>

<h5 id="解包"><a href="#解包" class="headerlink" title="解包"></a>解包</h5><p>-X参数可以提取deb包中的所有文件到 extract，-e 参数可以提取deb包中的控制信息到extract/DEBIAN</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ dpkg -X .&#x2F;xxx.deb extract</span><br><span class="line">$ dpkg -e .&#x2F;xxx.deb extract&#x2F;DEBIAN</span><br></pre></td></tr></table></figure>

<ul>
<li>重新打包成deb</li>
</ul>
<p>检查目录是否存在 .DS_Store 文件删除，再设置用户组权限打包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ sudo chown -R root:wheel .&#x2F;extract</span><br><span class="line">$ dpkg-deb -b extract&#x2F; build&#x2F; </span><br><span class="line">#如果安装报错将打包命令修改成如下 </span><br><span class="line">$ dpkg-deb -Z gzip -b extract&#x2F; build&#x2F;</span><br></pre></td></tr></table></figure>



<p>dpkg 可以在 iOS 设备上安装 deb 包，SSH 到设备</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dpkg -i &#x2F;var&#x2F;mobile&#x2F;Cydown&#x2F;test.deb</span><br></pre></td></tr></table></figure>





<h4 id="报错修改"><a href="#报错修改" class="headerlink" title="报错修改"></a>报错修改</h4><p>make package install</p>
<ol>
<li>提示 <code>obsolete compression type &#39;lzma&#39;; use xz instead</code></li>
</ol>
<p>解决：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">到theos目录 HTEOS&#x2F;makefiles&#x2F;package&#x2F;deb.mk</span><br><span class="line">第六行的THEOSPLATFORM_DPKG_DEB_COMPRESSION?&#x3D;lzma 把lzma改成xz就可以了</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>提示 <code>dpkg: error processing /tmp/_theos_install.deb (--install):</code></li>
</ol>
<p>解决：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">到目录 THEOS&#x2F;makefiles&#x2F;package&#x2F;deb.mk</span><br><span class="line">vim 进入 注释这一行</span><br><span class="line">#$(ECHO_NOTHING)COPYFILE_DISABLE&#x3D;1 $(FAKEROOT) -r $(_THEOS_PLATFORM_DPKG_DEB) -Z$(_THEOS_PLATFORM_DPKG_DEB_COMPRESSION) -b &quot;$(THEOS_STAGING_DIR)&quot; &quot;$(_THEOS_DEB_PACKAGE_FILENAME)&quot;$(ECHO_END)</span><br><span class="line">添加 </span><br><span class="line">$(ECHO_NOTHING)COPYFILE_DISABLE&#x3D;1 $(FAKEROOT) -r dpkg-deb -Zgzip -b &quot;$(THEOS_STAGING_DIR)&quot; &quot;$(_THEOS_DEB_PACKAGE_FILENAME)&quot; $(STDERR_NULL_REDIRECT)$(ECHO_END)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>Showing Recent Messages</p>
<p>An empty identity is not valid when signing a binary for the product type ‘Dynamic Library’.</p>
</li>
</ol>
<p>解决：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">BuildSettings-User-Defined 添加 key CODE_SIGNING_ALLOWED NO</span><br></pre></td></tr></table></figure>









]]></content>
  </entry>
  <entry>
    <title>Python3网络爬虫开发实战-Scrapy框架使用</title>
    <url>/2022/04/19/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-Scrapy%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>Scrapy 功能非常强大，爬取效率高，相关扩展组件多，可配置和可扩展程度非常高，几乎可以应对所有反爬网站，是目前Python中使用最广泛的爬虫框架</p>
<p>官方文档 <a href="https://doc.scrapy.org/en/latest/index.html">https://doc.scrapy.org/en/latest/index.html</a></p>
<h4 id="Scrapy"><a href="#Scrapy" class="headerlink" title="Scrapy"></a>Scrapy</h4><h5 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scrapy startproject tutorial</span><br></pre></td></tr></table></figure>

<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-Scrapy%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/WeChatf2beb120c54835739c5d7653fc0fc630.png" alt="WeChatf2beb120c54835739c5d7653fc0fc630"></p>
<p>scrapy.cfg：Scrapy 项目的配置文件，定义了项目配置文件路径、部署相关信息等内容，Scrapy 部署时的配置文件</p>
<p>items.py：定义 Item 数据结构，所有的 Item 的定义都可以放这里，定义爬取的数据结构</p>
<p>pipelines.py：定义 Item Pipeline 的实现，所有 Item Pipeline 的实现都可以放这里，定义数据管道</p>
<p>settings.py：定义项目的全局配置，配置文件</p>
<p>middlewares.py：定义 Spider Middlewares 和 Downloader Middlewares 的实现，爬取时的中间件</p>
<p>spiders：其内包含一个个 Spider 的实现，每个 Spider 都有一个文件，放置 Spiders 的文件夹</p>
<h5 id="创建-Spider"><a href="#创建-Spider" class="headerlink" title="创建 Spider"></a>创建 Spider</h5><p>Spider 是自己定义的类，Scrapy 用它来从网页抓取内容，并解析抓取的结果，不过这个类必须继承 Scrapy 提供的 Spider 类 scrapy.Spider，还要定义 Spider 的名称和起始请求，以及怎样处理爬取后的结果的方法</p>
<p>命令行创建一个 Spider，生成 Quotes 这个 Spider</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd tutorial</span><br><span class="line">scrapy genspider quotes quotes.toscrape.com</span><br></pre></td></tr></table></figure>

<p>执行 genspider 命令，第一个参数是 Spider 名称，第二个参数是网站域名</p>
<p>执行完毕后，spiders 文件夹中多了一个 quotes.py</p>
<p>内容：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QuotesSpider</span>(<span class="params">scrapy.Spider</span>):</span></span><br><span class="line">    name = <span class="string">&#x27;quotes&#x27;</span></span><br><span class="line">    allowed_domains = [<span class="string">&#x27;quotes.toscrape.com&#x27;</span>]</span><br><span class="line">    start_urls = [<span class="string">&#x27;http://quotes.toscrape.com/&#x27;</span>]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>name 每个项目唯一的名字，区分不同的Spider</p>
<p>allowed_domains 允许爬取的域名，如果初始或后续的请求链接不在这个域名下的，则请求链接会被过滤</p>
<p>start_urls，包含了Spider在启动时爬取的url列表，初始请求是由它来定义的</p>
<p>parse 是 Spider 的一个方法，默认情况下，被调用时 start_urls 里面的链接构成的请求完成下载执行后，返回的响应会作为唯一的参数传递给这个函数，该方法解析返回的响应、提取数据或者进一步生成要处理的请求</p>
<h5 id="创建-Item"><a href="#创建-Item" class="headerlink" title="创建 Item"></a>创建 Item</h5><p>Item 是保存爬取数据的容器，使用方法和字典类似</p>
<p>创建 Item 需要继承 scrapy.Item 类，并且定义类型为 scrapy.Field 的字段</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QuoteItem</span>(<span class="params">scrapy.Item</span>):</span></span><br><span class="line">    <span class="comment"># define the fields for your item here like:</span></span><br><span class="line">    text = scrapy.Field()</span><br><span class="line">    author = scrapy.Field()</span><br><span class="line">    tags = scrapy.Field()</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h5 id="解析-Response"><a href="#解析-Response" class="headerlink" title="解析 Response"></a>解析 Response</h5><p>parse() 方法的参数 response 是 start_urls 里面的链接爬取后的结果，所以在 parse() 方法中，我们可以直接对 response 变量包含的内容进行解析</p>
<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-Scrapy%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/WeChatb6f074004233d523d5e359e02e4ffb4e.png" alt="WeChatb6f074004233d523d5e359e02e4ffb4e"></p>
<p>网页结构中每一页都有多个 class 为 quote 的区块，每个区块都包含 text、author、tags，需要先找出所有的 quote，然后提取每一个 quote 中的内容</p>
<p>提取方式可以是 CSS 选择器或XPath 选择器</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;quote&quot;</span> <span class="attr">itemscope</span>=<span class="string">&quot;&quot;</span> <span class="attr">itemtype</span>=<span class="string">&quot;http://schema.org/CreativeWork&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;text&quot;</span> <span class="attr">itemprop</span>=<span class="string">&quot;text&quot;</span>&gt;</span>“The world as we have ....”<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>by <span class="tag">&lt;<span class="name">small</span> <span class="attr">class</span>=<span class="string">&quot;author&quot;</span> <span class="attr">itemprop</span>=<span class="string">&quot;author&quot;</span>&gt;</span>Albert Einstein<span class="tag">&lt;/<span class="name">small</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/author/Albert-Einstein&quot;</span>&gt;</span>(about)<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;tags&quot;</span>&gt;</span></span><br><span class="line">        Tags:</span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">class</span>=<span class="string">&quot;keywords&quot;</span> <span class="attr">itemprop</span>=<span class="string">&quot;keywords&quot;</span> <span class="attr">content</span>=<span class="string">&quot;change,deep-thoughts,thinking,world&quot;</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;tag&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/tag/change/page/1/&quot;</span>&gt;</span>change<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;tag&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/tag/deep-thoughts/page/1/&quot;</span>&gt;</span>deep-thoughts<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;tag&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/tag/thinking/page/1/&quot;</span>&gt;</span>thinking<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;tag&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/tag/world/page/1/&quot;</span>&gt;</span>world<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">    quotes = response.css(<span class="string">&#x27;.quote&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> quote <span class="keyword">in</span> quotes:</span><br><span class="line">        text = quote.css(<span class="string">&#x27;.text::text&#x27;</span>).extract_first()</span><br><span class="line">        autnor = quote.css(<span class="string">&#x27;.author::text&#x27;</span>).extract_first()</span><br><span class="line">        tags = quote.css(<span class="string">&#x27;.tags .tag::text&#x27;</span>).extract()</span><br></pre></td></tr></table></figure>

<p>先利用选择器选取所有的 quote，并将其赋值为 quotes 变量，然后利用 for 循环对每个 quote 遍历，解析每个 quote 内容</p>
<p>对 text 来说，它的 class 为 text，所以用 .text 选择器来选取，这个结果实际上是整个带有标签的节点，要获取正文内容，可以加 ::text 来获取，这时的结果是长度为 1 的列表，所以要用 extract_first() 方法来获取第一个元素；对 tags 来说，由于我们要获取所有的标签，所以用 extract() 方法获取整个列表即可</p>
<h5 id="使用-Item"><a href="#使用-Item" class="headerlink" title="使用 Item"></a>使用 Item</h5><p>解析结果赋值 Item 的每一个字段</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tutorial.items <span class="keyword">import</span> QuoteItem</span><br><span class="line">...</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">      quotes = response.css(<span class="string">&#x27;.quote&#x27;</span>)</span><br><span class="line">      <span class="keyword">for</span> quote <span class="keyword">in</span> quotes:</span><br><span class="line">          item = QuoteItem()</span><br><span class="line">          item[<span class="string">&#x27;text&#x27;</span>] = quote.css(<span class="string">&#x27;.text::text&#x27;</span>).extract_first()</span><br><span class="line">          item[<span class="string">&#x27;autnor&#x27;</span>] = quote.css(<span class="string">&#x27;.author::text&#x27;</span>).extract_first()</span><br><span class="line">          item[<span class="string">&#x27;tags&#x27;</span>] = quote.css(<span class="string">&#x27;.tags .tag::text&#x27;</span>).extract()</span><br><span class="line">          <span class="keyword">yield</span> item</span><br></pre></td></tr></table></figure>

<h5 id="后续-Request"><a href="#后续-Request" class="headerlink" title="后续 Request"></a>后续 Request</h5><p>上面操作实现了从初始页面抓取内容，下一页的内容需要从当前页面中找到信息来生成下一个请求</p>
<p>拉取页面到底部有个 Next 按钮，查看源码，它的链接是 /page/2/ 全链接是 <a href="http://quotes.toscrape.com/page/2">http://quotes.toscrape.com/page/2</a> ，通过这个链接可以构造下一个请求</p>
<p>构造请求时需要用到 scrapy.Request，传递两个参数 url 和 callback</p>
<p>url：请求链接</p>
<p>callback：回调函数，会将请求的响应作为参数传递给这个回调函数，回调函数进行解析或生成下一个请求</p>
<p>修改后完整 Spider 类</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">from</span> tutorial.items <span class="keyword">import</span> QuoteItem</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QuotesSpider</span>(<span class="params">scrapy.Spider</span>):</span></span><br><span class="line">  name = <span class="string">&#x27;quotes&#x27;</span></span><br><span class="line">  allowed_domains = [<span class="string">&#x27;quotes.toscrape.com&#x27;</span>]</span><br><span class="line">  start_urls = [<span class="string">&#x27;http://quotes.toscrape.com/&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">      quotes = response.css(<span class="string">&#x27;.quote&#x27;</span>)</span><br><span class="line">      <span class="keyword">for</span> quote <span class="keyword">in</span> quotes:</span><br><span class="line">          item = QuoteItem()</span><br><span class="line">          item[<span class="string">&#x27;text&#x27;</span>] = quote.css(<span class="string">&#x27;.text::text&#x27;</span>).extract_first()</span><br><span class="line">          item[<span class="string">&#x27;autnor&#x27;</span>] = quote.css(<span class="string">&#x27;.author::text&#x27;</span>).extract_first()</span><br><span class="line">          item[<span class="string">&#x27;tags&#x27;</span>] = quote.css(<span class="string">&#x27;.tags .tag::text&#x27;</span>).extract()</span><br><span class="line">          <span class="keyword">yield</span> item</span><br><span class="line">      <span class="comment">#利用选择器生成下一页的请求</span></span><br><span class="line">      <span class="built_in">next</span> = response.css(<span class="string">&#x27;.pager .next a::attr(&quot;href&quot;)&#x27;</span>).extract_first()</span><br><span class="line">      <span class="comment">#urljoin()方法可以将相对URL构造成一个绝对的URL</span></span><br><span class="line">      url = response.urljoin(<span class="built_in">next</span>)</span><br><span class="line">      <span class="comment">#返回下一页请求</span></span><br><span class="line">      <span class="keyword">yield</span>  scrapy.Request(url=url, callback=self.parse)</span><br></pre></td></tr></table></figure>

<h5 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h5><p>进入目录运行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scrapy crawl quotes</span><br></pre></td></tr></table></figure>

<p>运行后 Scrapy 输出当前的版本号及正在启动项目名称、settings.py  中一些重写后的配置、Middlewares、Pipelines</p>
<p>接下来就输出各个页面的抓取结果了</p>
<p>最后输出整个抓取过程的统计信息，请求字节数、请求次数、响应次数、完成原因等</p>
<h5 id="保存到文件"><a href="#保存到文件" class="headerlink" title="保存到文件"></a>保存到文件</h5><p>Scrapy 提供的 Feed Exports 可以将结果输出，如想将上面结果保存成 JSON 文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scrapy crawl quotes -o quotes.json</span><br></pre></td></tr></table></figure>

<p>还可以每一个 Item 输出一行 JSON，输出后缀为 jl，为 jsonline 的缩写</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scrapy crawl quotes -o quotes.jl</span><br><span class="line">或者 </span><br><span class="line">scrapy crawl quotes -o quotes.jsonline</span><br></pre></td></tr></table></figure>

<p>输出格式还支持很多种，如 csv、xml、pickle、marshal 等，还支持 ftp、s3等远程输出，还可以通过自定义 ItemExporter 来实现其他的输出</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scrapy crawl quotes -o quotes.csv</span><br><span class="line">scrapy crawl quotes -o quotes.xml</span><br><span class="line">scrapy crawl quotes -o quotes.pickle</span><br><span class="line">scrapy crawl quotes -o quotes.marshal</span><br><span class="line">scrapy crawl quotes -o ftp:&#x2F;&#x2F;user:pass@ftp.example.com&#x2F;path&#x2F;to&#x2F;quotes.csv</span><br></pre></td></tr></table></figure>

<p>通过 Scrapy 提供的 FeedExports，可以轻松的输出抓取结果到文件，想要更复杂的输出，如输出到数据库，可以使用 ItemPileline 来完成</p>
<h5 id="使用-Item-Pipeline"><a href="#使用-Item-Pipeline" class="headerlink" title="使用 Item Pipeline"></a>使用 Item Pipeline</h5><p>Item Pipeline 为项目管道，Item 生成后，它会自动被送到 Item Pipeline 进行处理，常用 Item Pipeline 来做如下操作</p>
<p>清理 HTML 数据、验证爬取数据，检查爬取字段、查重并丢弃重复内容、将爬取结果保存到数据库</p>
<p>要实现 Item Pipeline，只需要定义一个类并实现 process_item() 方法，启用 Item Pipeline 后，Item Pipeline 会自动调用这个方法，process_item() 方法必须返回包含数据的字典或 Item 对象或者抛出 DropItem 异常</p>
<p>process_item() 有两个参数，一个参数是 item，每次 Spider 生成的 Item 都会作为参数传递过来，第二个参数是 Spider，就是 Spider 的实例</p>
<p>实现 Item Pipeline，筛掉 text 长度大于 50 的Item，并将结果保存到 MongoDB</p>
<p>修改项目里的 pipelines.py 文件</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.exceptions <span class="keyword">import</span> DropItem</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextPipeline</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">      self.limit = <span class="number">50</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">process_item</span>(<span class="params">self, item, spider</span>):</span></span><br><span class="line">      <span class="keyword">if</span> item[<span class="string">&#x27;text&#x27;</span>]:</span><br><span class="line">          <span class="keyword">if</span> <span class="built_in">len</span>(item[<span class="string">&#x27;text&#x27;</span>] &gt; self.limit):</span><br><span class="line">              <span class="comment">#截断后拼省略号返回</span></span><br><span class="line">              item[<span class="string">&#x27;text&#x27;</span>] = item[<span class="string">&#x27;text&#x27;</span>][<span class="number">0</span>:self.limit].rstrip() + <span class="string">&#x27;...&#x27;</span></span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">          <span class="keyword">return</span> DropItem(<span class="string">&#x27;Missing Text&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>接下来将处理后的 item 存入 MongoDB，定义另外一个 Pipeline，MongoPipeline</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pymongo</span><br><span class="line"><span class="keyword">from</span> scrapy.exceptions <span class="keyword">import</span> DropItem</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MongoPipeline</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, mongo_uri, mongo_db</span>):</span></span><br><span class="line">      self.mongo_uri = mongo_uri</span><br><span class="line">      self.mongo_db = mongo_db</span><br><span class="line"><span class="meta">  @classmethod</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">from_crawler</span>(<span class="params">cls, crawler</span>):</span></span><br><span class="line">      <span class="keyword">return</span> cls(</span><br><span class="line">          mongo_uri=crawler.settings.get(<span class="string">&#x27;MONGO_URI&#x27;</span>),</span><br><span class="line">          mongo_db=crawler.settings.get(<span class="string">&#x27;MONGODB_DATABASE&#x27;</span>)</span><br><span class="line">      )</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">open_spider</span>(<span class="params">self, spider</span>):</span></span><br><span class="line">      self.cline = pymongo.MongoClient(self.mongo_uri)</span><br><span class="line">      self.db = self.cline[self.mongo_db]</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">process_item</span>(<span class="params">self, item, spider</span>):</span></span><br><span class="line">      name = item.__class__.__name__</span><br><span class="line">      self.db[name].insert(<span class="built_in">dict</span>(item))</span><br><span class="line">      <span class="keyword">return</span> item</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">close_spider</span>(<span class="params">self, spider</span>):</span></span><br><span class="line">      self.cline.close()</span><br></pre></td></tr></table></figure>

<p>MongoPipeline 实现了另外几个方法</p>
<p>from_crawler：是一个类方法，用 @classmethod 标识，是一种依赖注入的方式，参数是 crawler，通过 crawler 可以拿到全局配置的每个配置信息，全局配置 settings.py 定义了 MongoDB 连接需要的地址和数据库名称，拿到配置信息返回类对象即可，这方法主要用来获取 setting.py 中的配置</p>
<p>open_spider：当 Spider 开启时，这个方法被调用，上面程序中主要进行了一些初始化操作</p>
<p>close_spider：当 Spider 关闭时，这个方法被调用，上面程序中将数据库连接关闭</p>
<p>process_item() 方法则执行了数据库插入操作</p>
<p>定义好了 TextPipeline 和 MongoPipeline 两个类后，需要在 settings.py 中使用他们，MongoDB 的连接信息还需要定义</p>
<p>settings.py 中加入</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">TIME_PIPELINES = &#123;</span><br><span class="line">	<span class="string">&#x27;tutorial.pipelines.TextPipeline&#x27;</span>: <span class="number">300</span>,</span><br><span class="line">	<span class="string">&#x27;tutorial.pipelines.MongoPipeline&#x27;</span>: <span class="number">400</span></span><br><span class="line">&#125;</span><br><span class="line">MONGO_URI = <span class="string">&#x27;localhost&#x27;</span></span><br><span class="line">MONGO_DB = <span class="string">&#x27;tutorial&#x27;</span></span><br></pre></td></tr></table></figure>

<p>赋值 TIME_PIPELINES 字典，键名是 Pipeline 的类名称，键值是调用优先级，是一个数字，数字越小则对应 Pipeline 越先被调用</p>
<p>重新执行爬取</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scrapy crawl quotes</span><br></pre></td></tr></table></figure>

<h4 id="13-3-Selecotr-用法"><a href="#13-3-Selecotr-用法" class="headerlink" title="13.3 Selecotr 用法"></a>13.3 Selecotr 用法</h4><p>Scrapy 还提供了自己的数据提取方法，即 Selector，Selector 是基于 lxml 来构建的，支持 XPath 选择器、CSS 选择器以及正则表达式</p>
<h5 id="直接使用"><a href="#直接使用" class="headerlink" title="直接使用"></a>直接使用</h5><p>Selector 是一个可以独立使用的模块，可以利用 Selector 来构建一个选择器对象，然后调用它的相关方法 如</p>
<p>xpath()、css() 等来提取数据</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy <span class="keyword">import</span> Selector</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  body = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  &lt;html&gt;</span></span><br><span class="line"><span class="string">      &lt;head&gt;</span></span><br><span class="line"><span class="string">          &lt;title&gt;Hello World&lt;/title&gt;</span></span><br><span class="line"><span class="string">      &lt;/head&gt;</span></span><br><span class="line"><span class="string">  &lt;/html&gt;</span></span><br><span class="line"><span class="string">  &#x27;&#x27;&#x27;</span></span><br><span class="line">  selector = Selector(text=body)</span><br><span class="line">  title = selector.xpath(<span class="string">&#x27;//title/text()&#x27;</span>).extract_first()</span><br><span class="line">  title1 = selector.xpath(<span class="string">&#x27;//title/text()&#x27;</span>).extract()</span><br><span class="line">  title2 = selector.xpath(<span class="string">&#x27;//title/text()&#x27;</span>)</span><br><span class="line">  print(title)</span><br><span class="line">  print(title1)</span><br><span class="line">  print(title2)</span><br><span class="line"><span class="comment">#Hello World</span></span><br><span class="line"><span class="comment">#[&#x27;Hello World&#x27;]</span></span><br><span class="line"><span class="comment">#[&lt;Selector xpath=&#x27;//title/text()&#x27; data=&#x27;Hello World&#x27;&gt;]</span></span><br></pre></td></tr></table></figure>

<h5 id="Scrapy-shell"><a href="#Scrapy-shell" class="headerlink" title="Scrapy shell"></a>Scrapy shell</h5><p>借助 Scrapy shell 来模拟 Scrapy 请求的过程 ，讲解相关的提取方法</p>
<p>官方文档的样例来做演示 <a href="https://docs.scrapy.org/en/latest/_static/selectors-sample1.html">https://docs.scrapy.org/en/latest/_static/selectors-sample1.html</a></p>
<p>开启 Scrapy shell</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scrapy shell https:&#x2F;&#x2F;docs.scrapy.org&#x2F;en&#x2F;latest&#x2F;_static&#x2F;selectors-sample1.html</span><br></pre></td></tr></table></figure>

<p>就进入 Scrapy shell 模式，这过程其实是 Scrapy 发起了一次请求，请求的URL就是命令行下输入的 URL，然后把一些可操作的变量传递给我们，如request、response 等</p>
<img src="Python3网络爬虫开发实战-Scrapy框架使用/WeChatae25474d863d90da3fe12abbc4a54da0.png" alt="WeChatae25474d863d90da3fe12abbc4a54da0" style="zoom:80%;" />

<p>可以在命令模式下输入命令调用对象的一些操作方法，回车之后实时显示结果</p>
<p>查看页面源码</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">&#x27;http://example.com/&#x27;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Example website<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&#x27;images&#x27;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;image1.html&#x27;</span>&gt;</span>Name: My image 1 <span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;image1_thumb.jpg&#x27;</span> /&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;image2.html&#x27;</span>&gt;</span>Name: My image 2 <span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;image2_thumb.jpg&#x27;</span> /&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;image3.html&#x27;</span>&gt;</span>Name: My image 3 <span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;image3_thumb.jpg&#x27;</span> /&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;image4.html&#x27;</span>&gt;</span>Name: My image 4 <span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;image4_thumb.jpg&#x27;</span> /&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;image5.html&#x27;</span>&gt;</span>Name: My image 5 <span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;image5_thumb.jpg&#x27;</span> /&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="XPath-选择器"><a href="#XPath-选择器" class="headerlink" title="XPath 选择器"></a>XPath 选择器</h5><p>进入 Scrapy shell 之后，操作 response 这个变量来进行分析</p>
<p>response 有一个属性 selector，调用 response.selector 返回的内容就相当于用 response 的body 构造了一个 Selector 对象，通过这个 Selector 对象可以调用解析方法如 xpath()、css() 等</p>
<ul>
<li>查询嵌套查询</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#从html提取a节点</span><br><span class="line">&gt;&gt;&gt; result &#x3D; response.selector.xpath(&#39;&#x2F;&#x2F;a&#39;)</span><br><span class="line">&gt;&gt;&gt; result</span><br><span class="line">[&lt;Selector xpath&#x3D;&#39;&#x2F;&#x2F;a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image1.html&quot;&gt;Name: My image ...&#39;&gt;, </span><br><span class="line">&lt;Selector xpath&#x3D;&#39;&#x2F;&#x2F;a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image2.html&quot;&gt;Name: My image ...&#39;&gt;, </span><br><span class="line">&lt;Selector xpath&#x3D;&#39;&#x2F;&#x2F;a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image3.html&quot;&gt;Name: My image ...&#39;&gt;, </span><br><span class="line">&lt;Selector xpath&#x3D;&#39;&#x2F;&#x2F;a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image4.html&quot;&gt;Name: My image ...&#39;&gt;, </span><br><span class="line">&lt;Selector xpath&#x3D;&#39;&#x2F;&#x2F;a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image5.html&quot;&gt;Name: My image ...&#39;&gt;]</span><br><span class="line">#从a节点提取img节点</span><br><span class="line">&gt;&gt;&gt; result.xpath(&#39;.&#x2F;img&#39;)</span><br></pre></td></tr></table></figure>

<p>选择器前面加 . (点)，代表提取元素内部的数据，没有加点则代表从根节点开始提取</p>
<ul>
<li>提取内容</li>
</ul>
<p>Scrapy 提供了两个使用的快捷方法 </p>
<p>response.xpath() 和 response.css() 功能等同于 response.selector.xpath() 和 response.selector.css()</p>
<p>现在得到的是 SelectorList 类型的变量，该变量是由 Selector 对象组成的列表，可以用索引单独提取其中某个 Selector 元素</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; result[0]</span><br><span class="line">&lt;Selector xpath&#x3D;&#39;&#x2F;&#x2F;a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image1.html&quot;&gt;Name: My image ...&#39;&gt;</span><br></pre></td></tr></table></figure>

<p>提取内容 extract() 方法</p>
<p>加一层 /text() 就可以获取节点的内部文本，或者加一层 /@href 就可获取节点的 href 属性，@符号后面就是要获取的属性名称</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; result.extract()</span><br><span class="line">&gt;&gt;&gt; response.xpath(&#39;&#x2F;&#x2F;a&#x2F;text()&#39;).extract()</span><br></pre></td></tr></table></figure>

<ul>
<li>提取单个元素 extract_first() 不用担心数组越界问题</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#将第一个匹配结果取出来 extract_first()</span><br><span class="line">&gt;&gt;&gt; result.xpath(&#39;&#x2F;&#x2F;a[@href&#x3D;&quot;image1.html&quot;]&#x2F;text()&#39;).extract_first()</span><br></pre></td></tr></table></figure>

<ul>
<li>提取不到使用默认值</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; result.xpath(&#39;&#x2F;&#x2F;a[@href&#x3D;&quot;image1.html&quot;]&#x2F;text()&#39;).extract_first(&#39;Default Image&#39;)</span><br><span class="line">#默认值 Default Image</span><br></pre></td></tr></table></figure>

<h5 id="CSS-选择器"><a href="#CSS-选择器" class="headerlink" title="CSS 选择器"></a>CSS 选择器</h5><p>选取 a 节点</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; response.css(&#39;a&#39;)</span><br><span class="line">[&lt;Selector xpath&#x3D;&#39;descendant-or-self::a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image1.html&quot;&gt;Name: My image ...&#39;&gt;, &lt;Selector xpath&#x3D;&#39;descendant-or-self::a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image2.html&quot;&gt;Name: My image ...&#39;&gt;, &lt;Selector xpath&#x3D;&#39;descendant-or-self::a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image3.html&quot;&gt;Name: My image ...&#39;&gt;, &lt;Selector xpath&#x3D;&#39;descendant-or-self::a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image4.html&quot;&gt;Name: My image ...&#39;&gt;, &lt;Selector xpath&#x3D;&#39;descendant-or-self::a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image5.html&quot;&gt;Name: My image ...&#39;&gt;]</span><br><span class="line">&gt;&gt;&gt; response.css(&#39;a&#39;).extract()</span><br><span class="line">&gt;&gt;&gt; response.css(&#39;a&#39;).extract_first()</span><br></pre></td></tr></table></figure>

<ul>
<li>属性选择和嵌套选择</li>
</ul>
<p>查找 a 节点内部 img 节点，只需要加一个空格和img 即可</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; response.css(&#39;a[href&#x3D;&quot;image1.html&quot;]&#39;).extract()</span><br><span class="line">[&#39;&lt;a href&#x3D;&quot;image1.html&quot;&gt;Name: My image 1 &lt;br&gt;&lt;img src&#x3D;&quot;image1_thumb.jpg&quot;&gt;&lt;&#x2F;a&gt;&#39;]</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; response.css(&#39;a[href&#x3D;&quot;image1.html&quot;] img&#39;).extract()</span><br><span class="line">[&#39;&lt;img src&#x3D;&quot;image1_thumb.jpg&quot;&gt;&#39;]</span><br></pre></td></tr></table></figure>

<ul>
<li>节点内部文本和属性获取</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; response.css(&#39;a[href&#x3D;&quot;image1.html&quot;]::text&#39;).extract_first()</span><br><span class="line">&#39;Name: My image 1 &#39;</span><br><span class="line">&gt;&gt;&gt; response.css(&#39;a[href&#x3D;&quot;image1.html&quot;] img::attr(src)&#39;).extract_first()</span><br><span class="line">&#39;image1_thumb.jpg&#39;</span><br></pre></td></tr></table></figure>

<p>获取文本和属性要用 ::text 和 ::attr() 的写法</p>
<ul>
<li>CSS 选择器 XPath 选择器嵌套使用</li>
</ul>
<p>获取所有 img 节点的 src 属性</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; response.xpath(&#39;&#x2F;&#x2F;a&#39;).css(&#39;img&#39;).xpath(&#39;@src&#39;).extract()</span><br><span class="line">[&#39;image1_thumb.jpg&#39;, &#39;image2_thumb.jpg&#39;, &#39;image3_thumb.jpg&#39;, &#39;image4_thumb.jpg&#39;, &#39;image5_thumb.jpg&#39;]</span><br></pre></td></tr></table></figure>

<h5 id="正则匹配"><a href="#正则匹配" class="headerlink" title="正则匹配"></a>正则匹配</h5><p>Scrapy 还支持正则匹配</p>
<p>a 节点中文本类似于 Name: My image 1，现在提取 Name: 后面内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; response.xpath(&#39;&#x2F;&#x2F;a&#x2F;text()&#39;).re(&#39;Name:\s(.*)&#39;)</span><br><span class="line">[&#39;My image 1 &#39;, &#39;My image 2 &#39;, &#39;My image 3 &#39;, &#39;My image 4 &#39;, &#39;My image 5 &#39;]</span><br></pre></td></tr></table></figure>

<p>给 re() 方法传一个正则表达式，(.*) 就是要匹配的内容</p>
<p>同时存在两个分组，结果会按序输出</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; response.xpath(&#39;&#x2F;&#x2F;a&#x2F;text()&#39;).re(&#39;(.*?)\s(.*)&#39;)</span><br><span class="line">[&#39;Name:&#39;, &#39;My image 1 &#39;, &#39;Name:&#39;, &#39;My image 2 &#39;, &#39;Name:&#39;, &#39;My image 3 &#39;, &#39;Name:&#39;, &#39;My image 4 &#39;, &#39;Name:&#39;, &#39;My image 5 &#39;]</span><br></pre></td></tr></table></figure>

<p>类似 extract_first() 方法 re_first() 方法可以选择列表第一个元素</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; response.xpath(&#39;&#x2F;&#x2F;a&#x2F;text()&#39;).re_first(&#39;Name:\s(.*)&#39;)</span><br><span class="line">&#39;My image 1 &#39;</span><br></pre></td></tr></table></figure>

<p>response 对象不能直接调用 re() 和 re_first() ，如果想要对全文进行正则匹配，可以先调用 xpath() 方法再正则匹配</p>
<h4 id="13-4-Spider-用法"><a href="#13-4-Spider-用法" class="headerlink" title="13.4 Spider 用法"></a>13.4 Spider 用法</h4><h5 id="Spider-类"><a href="#Spider-类" class="headerlink" title="Spider 类"></a>Spider 类</h5><p>定义的 Spider 是继承自 scrapy.spiders.Spider</p>
<p>scrapy.spiders.Spider 类提供了 start_requests() 方法的默认实现，读取并请求 start_urls 属性，并根据返回的结果调用 parse() 方法解析结果。</p>
<p>name：爬虫名称，一般以网站域名名称来命名，Spider 爬取 mywebsite.com，命名为 mywebsite</p>
<p>allow_domains：允许爬取的域名，是可选配置，不在此范围的链接不会被跟进爬取</p>
<p>start_urls：起始 URL 列表，没有实现 start_requests() 方法时，默认会从这个列表开始抓取</p>
<p>custom_settings：一个字典，专属本 Spider 的配置，会覆盖全局的设置，此设置必须在初始化前被更新，必须定义成类变量</p>
<p>crawler：是由 from_crawler() 方法设置的，代表本 Spider 类对应的 Crawler 对象，Crawler 对象包含了很多项目组件，利用它可以获取项目一些配置信息，最常见的获取项目的设置信息，即 settings</p>
<p>settings：一个Settings 对象，利用它可以直接获取项目全局设置变量</p>
<ul>
<li>start_requests()</li>
</ul>
<p>此方法用于生成初始请求，必须返回一个可迭代对象。此方法会默认使用 start_urls 里面的URL 来构造 Request，而且 Request 是 GET请求方式，如果想在启动时以 POST 方式访问某个站点，可以直接重写这个方法，发送 POST 请求时使用 FormRequest</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImagesSpider</span>(<span class="params">Spider</span>):</span></span><br><span class="line">  name = <span class="string">&#x27;images&#x27;</span></span><br><span class="line">  allowed_domains = [<span class="string">&#x27;images.so.com&#x27;</span>]</span><br><span class="line">  start_urls = [<span class="string">&#x27;http://images.so.com/&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">start_requests</span>(<span class="params">self</span>):</span></span><br><span class="line">      data = &#123;<span class="string">&#x27;ch&#x27;</span>: <span class="string">&#x27;photography&#x27;</span>, <span class="string">&#x27;listtype&#x27;</span>: <span class="string">&#x27;new&#x27;</span>&#125;</span><br><span class="line">      base_url = <span class="string">&#x27;https://image.so.com/zjl?&#x27;</span></span><br><span class="line">      <span class="keyword">for</span> page <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, self.settings.get(<span class="string">&#x27;MAX_PAGE&#x27;</span>) + <span class="number">1</span>):</span><br><span class="line">          data[<span class="string">&#x27;sn&#x27;</span>] = page * <span class="number">30</span></span><br><span class="line">          <span class="comment">#利用urlencode()方法将字典转化为URL的GET参数</span></span><br><span class="line">          params = urlencode(data)</span><br><span class="line">          url = base_url + params</span><br><span class="line">          <span class="keyword">yield</span> Request(url, self.parse)</span><br></pre></td></tr></table></figure>

<ul>
<li>parse()</li>
</ul>
<p>当 Response 没指定回调函数时，该方法被调用，负责处理 Response，处理返回结果，并从中提取想要的数据和下一步请求。需要返回一个包含 Request 或 Item 的可迭代对象</p>
<p>close()：当 Spider 关闭时，该方法被调用，这里一般会定义释放资源的一些操作</p>
<h4 id="13-5-Downloader-Middleware"><a href="#13-5-Downloader-Middleware" class="headerlink" title="13.5 Downloader Middleware"></a>13.5 Downloader Middleware</h4><p>下载中间件，处于 Scrapy 的 Request 和 Response 之间的处理模块</p>
<p>Scheduler 从队列中拿出一个 Request 发送给 Downloader 执行下载，这过程会经过 Downloader Middlewares 的处理</p>
<p>当 Downloader 将 Request 下载完成得到的 Response 返回给 Spider 时会再次经过  Downloader Middlewares 处理</p>
<p>修改 User-Agent、处理重定向、设置代理、失败重试、设置Cookies等功能都需要借助  Downloader Middlewares 实现</p>
<p>Scrapy 已经提供了许多  Downloader Middlewares，比如失败重试、自动重定向等功能的 Middleware，被 DOWNLOADER_MIDDLEWARES_BASE 变量定义，是一个字典格式</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&#39;scrapy.downloadermiddlewares.robotstxt.RobotsTxtMiddleware&#39;: 100</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>键值是 优先级，数字越小会被优先调用</p>
<p>Scrapy 提供了一个设置变量 DOWNLOADER_MIDDLEWARES，直接修改这个变量就可以添加自己定义的  Downloader Middlewares</p>
<h5 id="核心方法"><a href="#核心方法" class="headerlink" title="核心方法"></a>核心方法</h5><p>每个  Downloader Middlewares 都定义了一个或多个方法的类，核心方法三个</p>
<p>process_request(request, spider)</p>
<p>process_response(request, response, spider)</p>
<p>process_exception(request, exception, spider)</p>
<p>只需要实现一个方法，就可以定义一个 Downloader Middlewares </p>
<ul>
<li>process_request(request, spider)</li>
</ul>
<p>Request 被 Scrapy 引擎调度给Downloader之前，会被调用</p>
<p>可以用 process_request 对 Request 方法进行处理。返回值必须为 None、Response对象、Request 对象之一，或者抛出 IgnoreRequest 异常</p>
<ul>
<li>process_response(request, response, spider)</li>
</ul>
<p>Downloader 执行 Request 下载之后，会得到对应的 Response，Scrapy 引擎便会将 Response 发送给 Spider 进行解析。发送之前，可以用 process_response 方法对 Response 进行处理。返回值必须为 None、Response对象、Request 对象之一，或者抛出 IgnoreRequest 异常</p>
<ul>
<li>process_exception(request, exception, spider)</li>
</ul>
<p>Downloader 或 process_rqeuest() 方法抛出异常时被调用</p>
<h5 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h5><p>新建项目</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scrapy startproject scrapydownloadertest</span><br></pre></td></tr></table></figure>

<p>进入项目新建 Spider， 名为 httpbin</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd scrapydownloadertest</span><br><span class="line">scrapy genspider httpbin httpbin.org</span><br></pre></td></tr></table></figure>

<p>修改内容</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpbinSpider</span>(<span class="params">scrapy.Spider</span>):</span></span><br><span class="line">  name = <span class="string">&#x27;httpbin&#x27;</span></span><br><span class="line">  allowed_domains = [<span class="string">&#x27;httpbin.org&#x27;</span>]</span><br><span class="line">  start_urls = [<span class="string">&#x27;http://httpbin.org/get&#x27;</span>]</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">      self.logger.debug(response.text)</span><br></pre></td></tr></table></figure>

<p>运行  <code>scrapy crawl httpbin</code></p>
<p>运行结果包含 Scrapy 发送的 Request 信息 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> DEBUG: &#123;</span><br><span class="line">  &quot;args&quot;: &#123;&#125;,</span><br><span class="line">  &quot;headers&quot;: &#123;</span><br><span class="line">    &quot;Accept&quot;: &quot;text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8&quot;,</span><br><span class="line">    &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;,</span><br><span class="line">    &quot;Accept-Language&quot;: &quot;en&quot;,</span><br><span class="line">    &quot;Host&quot;: &quot;httpbin.org&quot;,</span><br><span class="line">    &quot;User-Agent&quot;: &quot;Scrapy&#x2F;2.4.1 (+https:&#x2F;&#x2F;scrapy.org)&quot;,</span><br><span class="line">    &quot;X-Amzn-Trace-Id&quot;: &quot;Root&#x3D;1-625fa44b-7de6f90f1696c8d44ba334ab&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;origin&quot;: &quot;14.155.91.98&quot;,</span><br><span class="line">  &quot;url&quot;: &quot;http:&#x2F;&#x2F;httpbin.org&#x2F;get&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>修改 User-Agent 两种方式</li>
</ul>
<p>第一种修改 settings 里的 USER_AGENT 变量</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">USERAGENT &#x3D; &#39;xxxx&#39;</span><br></pre></td></tr></table></figure>

<p>如果想设置更灵活，比如随机 User-Agent，需要借助 Downloader Middleware</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomUserAgentMiddleware</span>():</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">      self.user_agents = [</span><br><span class="line">          <span class="string">&#x27;xxx1&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;xxx2&#x27;</span>,</span><br><span class="line">      ]</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">process_request</span>(<span class="params">self, request, spider</span>):</span></span><br><span class="line">      request.headers[<span class="string">&#x27;User-Agent&#x27;</span>] = random.choice(self.user_agents)</span><br></pre></td></tr></table></figure>

<p>要使这个 Downloader Middleware 生效还要去调用它，在 settings.py 中，将 DOWNLOADER_MIDDLEWARES 取消注释</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">DOWNLOADER_MIDDLEWARES = &#123;</span><br><span class="line"><span class="string">&#x27;scrapydownloadertest.middlewares.RandomUserAgentMiddleware&#x27;</span>: <span class="number">543</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次运行发现 User-Agent 被修改了 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DEBUG: &#123;</span><br><span class="line">  &quot;args&quot;: &#123;&#125;,</span><br><span class="line">  &quot;headers&quot;: &#123;</span><br><span class="line">    &quot;Accept&quot;: &quot;text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8&quot;,</span><br><span class="line">    &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;,</span><br><span class="line">    &quot;Accept-Language&quot;: &quot;en&quot;,</span><br><span class="line">    &quot;Host&quot;: &quot;httpbin.org&quot;,</span><br><span class="line">    &quot;User-Agent&quot;: &quot;xxx2&quot;,</span><br><span class="line">    &quot;X-Amzn-Trace-Id&quot;: &quot;Root&#x3D;1-625fa838-4f44d9361feb25107824c407&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;origin&quot;: &quot;14.155.91.98&quot;,</span><br><span class="line">  &quot;url&quot;: &quot;http:&#x2F;&#x2F;httpbin.org&#x2F;get&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>修改响应</li>
</ul>
<p>RandomUserAgentMiddleware 中添加 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_response</span>(<span class="params">self, response, spider</span>):</span></span><br><span class="line">    response.status = <span class="number">201</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>

<p>再 Spider 的 parse() 方法添加输出</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">self.logger.debug(&#39;Status code:&#39; + str(response.status))</span><br></pre></td></tr></table></figure>

<h4 id="13-6-Spider-Middleware"><a href="#13-6-Spider-Middleware" class="headerlink" title="13.6 Spider Middleware"></a>13.6 Spider Middleware</h4><p>Spider Middleware 三个作用</p>
<p>Response 发送给 Spider 之前对 Response 进行处理</p>
<p>Request 发送给 Scheduler 之前对 Request 进行处理</p>
<p>Item 发送给 Item Pipeline 之前对 Item 进行处理</p>
<p>Scrapy 已经提供了许多 Spider Middleware，被 SPIDER_MIDDLEWARES_BASE 变量定义</p>
<p>Spider Middleware 4个核心方法，只需要实现其中一个方法就可以定义一个 Spider Middleware</p>
<ul>
<li>process_spider_input(response, spider)</li>
</ul>
<p>Response 被 Spider Middleware 处理时被调用</p>
<p>返回 None 或者抛出异常</p>
<ul>
<li>process_spider_output(response, result, spider)</li>
</ul>
<p>当 Spider 处理 Response 返回结果时被调用</p>
<p>必须返回包含 Request 或 Item 对象的可迭代对象</p>
<ul>
<li>process_spider_exception(response, exception, spider)</li>
</ul>
<p>Spider 或 process_spider_input 方法抛出异常时调用</p>
<ul>
<li>process_start_requests(start_requests, spider)</li>
</ul>
<h4 id="13-6-Item-Pipeline"><a href="#13-6-Item-Pipeline" class="headerlink" title="13.6 Item Pipeline"></a>13.6 Item Pipeline</h4><p>参考使用 Item Pipeline</p>
<h4 id="爬取-360摄影美图"><a href="#爬取-360摄影美图" class="headerlink" title="爬取 360摄影美图"></a>爬取 360摄影美图</h4><h5 id="构造请求"><a href="#构造请求" class="headerlink" title="构造请求"></a>构造请求</h5><h5 id="MongoDB存储"><a href="#MongoDB存储" class="headerlink" title="MongoDB存储"></a>MongoDB存储</h5><h5 id="MySQL-存储"><a href="#MySQL-存储" class="headerlink" title="MySQL 存储"></a>MySQL 存储</h5><h5 id="Image-Pipeline"><a href="#Image-Pipeline" class="headerlink" title="Image Pipeline"></a>Image Pipeline</h5><p>Scrapy 提供了专门处理下载的 Pipeline，包括下载文件和图片，下载过程支持异步和多线程</p>
<p>官方文档地址 <a href="https://doc.scrapy.org/en/latest/topics/media-pipeline.html">https://doc.scrapy.org/en/latest/topics/media-pipeline.html</a></p>
<p>首先定义文件存储的路径，需要定义一个 IMAGES_STORE 变量，在settings.py 添加代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">IMAGES_STORE &#x3D; &#39;.&#x2F;images&#39;</span><br></pre></td></tr></table></figure>

<p>下载的图片都会保存到当前路径的 images 子文件夹下</p>
<p>内置的 ImagesPipeline 会默认读取 Item 的 image_urls 字段，并认为字段是一个列表形式，它会遍历 Item 的 image_urls 字段，然后取出每个 URL 进行图片下载</p>
<p>现在生成的 Item 的图片链接字段并不是 image_urls 字段表示的，也不是列表形式，而是单个 URL</p>
<p>所以为了实现下载，需要重新定义下载部分逻辑，即要自定义 ImagePipeline，继承自内置的 ImagesPipeline</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImagePipeline</span>(<span class="params">ImagesPipeline</span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">file_path</span>(<span class="params">self, request, response=<span class="literal">None</span>, info=<span class="literal">None</span></span>):</span></span><br><span class="line">      url = request.url</span><br><span class="line">      file_name = url.split(<span class="string">&#x27;/&#x27;</span>)[<span class="number">-1</span>]</span><br><span class="line">      <span class="keyword">return</span> file_name</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">item_completed</span>(<span class="params">self, results, item, info</span>):</span></span><br><span class="line">      image_paths = [x[<span class="string">&#x27;path&#x27;</span>] <span class="keyword">for</span> ok, x <span class="keyword">in</span> results <span class="keyword">if</span> ok]</span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">not</span> image_paths:</span><br><span class="line">          <span class="keyword">raise</span> DropItem(<span class="string">&#x27;Image Downloaded Failed&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> item</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">get_media_requests</span>(<span class="params">self, item, info</span>):</span></span><br><span class="line">      <span class="keyword">yield</span> Request(item[<span class="string">&#x27;url&#x27;</span>])</span><br></pre></td></tr></table></figure>

<ul>
<li>get_media_requests</li>
</ul>
<p>第一个参数 item 是爬取生成的 Item 对象，将它的 url 字段取出来，然后直接生成 Request对象，将此 Request 加入到调度队列，等待被调度，执行下载</p>
<ul>
<li>file_path</li>
</ul>
<p>这个方法用来返回保存的文件名，直接将图片链接最后一部分当作文件名即可，用 split 函数分割拼接并提取最后一部分</p>
<ul>
<li>item_completed</li>
</ul>
<p>它是单个 Item 完成下载时的处理方法，并不是每张图都会下载成功，需要分析下载结果剔除下载失败的图片，没下载成功就不需要保存 Item 到数据库</p>
<p>方法第一个参数 results 就是该 Item 对应下载结果，是一个列表形式，列表每一个元素是一个元组，其中包含了下载成功或失败的信息</p>
<p>这里遍历下载结果找出所有成功的下载列表。</p>
<h4 id="13-8-Scrapy-对接-Selenium"><a href="#13-8-Scrapy-对接-Selenium" class="headerlink" title="13.8 Scrapy 对接 Selenium"></a>13.8 Scrapy 对接 Selenium</h4><p>Scrapy 抓取页面的方式和 requests 库类似，都是直接模拟 HTTP 请求</p>
<p>前面抓取 JavaScript 渲染的页面有两种方式。一种是分析 Ajax 请求，找到对应的接口抓取，Scrapy 同样也可以用这种方法抓取。另一种是用 Selenium 或 Splash 模拟浏览器进行抓取，不需要关心页面后台发生的请求，也不需要分析渲染过程，只需要关心页面最终结果，即可见即可爬</p>
<h5 id="对接-Selenium"><a href="#对接-Selenium" class="headerlink" title="对接 Selenium"></a>对接 Selenium</h5><p>对接 Selenium 进行抓取，采用 Downloader Middleware 来实现，在 Middleware 里面的 process_request() 方法里对每个抓取请求进行处理，启动浏览器进行页面渲染，再将渲染后的结果构造一个 HtmlResponse 对象返回</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.common.exceptions <span class="keyword">import</span> TimeoutException</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"><span class="keyword">from</span> scrapy.http <span class="keyword">import</span> HtmlResponse</span><br><span class="line"><span class="keyword">from</span> logging <span class="keyword">import</span> getLogger</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SeleniumMiddleware</span>():</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, timeout=<span class="literal">None</span>, service_args=[]</span>):</span></span><br><span class="line">      self.logger = getLogger(__name__)</span><br><span class="line">      self.timeout = timeout</span><br><span class="line">      self.browser = webdriver.PhantomJS(service_args=service_args)</span><br><span class="line">      self.browser.set_window_size(<span class="number">1400</span>, <span class="number">700</span>)</span><br><span class="line">      self.browser.set_page_load_timeout(self.timeout)</span><br><span class="line">      self.wait = WebDriverWait(self.browser, self.timeout)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__del__</span>(<span class="params">self</span>):</span></span><br><span class="line">      self.browser.close()</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">process_request</span>(<span class="params">self, request, spider</span>):</span></span><br><span class="line">      <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">      用PhantomJS抓取页面</span></span><br><span class="line"><span class="string">      :param request: Request对象</span></span><br><span class="line"><span class="string">      :param spider: Spider对象</span></span><br><span class="line"><span class="string">      :return: HtmlResponse</span></span><br><span class="line"><span class="string">      &quot;&quot;&quot;</span></span><br><span class="line">      self.logger.debug(<span class="string">&#x27;PhantomJS is Starting&#x27;</span>)</span><br><span class="line">      page = request.meta.get(<span class="string">&#x27;page&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">      <span class="keyword">try</span>:</span><br><span class="line">          self.browser.get(request.url)</span><br><span class="line">          <span class="keyword">if</span> page &gt; <span class="number">1</span>:</span><br><span class="line">              <span class="built_in">input</span> = self.wait.until(</span><br><span class="line">                  EC.presence_of_element_located((By.CSS_SELECTOR, <span class="string">&#x27;#mainsrp-pager div.form &gt; input&#x27;</span>)))</span><br><span class="line">              submit = self.wait.until(</span><br><span class="line">                  EC.element_to_be_clickable((By.CSS_SELECTOR, <span class="string">&#x27;#mainsrp-pager div.form &gt; span.btn.J_Submit&#x27;</span>)))</span><br><span class="line">              <span class="built_in">input</span>.clear()</span><br><span class="line">              <span class="built_in">input</span>.send_keys(page)</span><br><span class="line">              submit.click()</span><br><span class="line">          self.wait.until(</span><br><span class="line">              EC.text_to_be_present_in_element((By.CSS_SELECTOR, <span class="string">&#x27;#mainsrp-pager li.item.active &gt; span&#x27;</span>), <span class="built_in">str</span>(page)))</span><br><span class="line">          self.wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, <span class="string">&#x27;.m-itemlist .items .item&#x27;</span>)))</span><br><span class="line">          <span class="keyword">return</span> HtmlResponse(url=request.url, body=self.browser.page_source, request=request, encoding=<span class="string">&#x27;utf-8&#x27;</span>,</span><br><span class="line">                              status=<span class="number">200</span>)</span><br><span class="line">      <span class="keyword">except</span> TimeoutException:</span><br><span class="line">          <span class="keyword">return</span> HtmlResponse(url=request.url, status=<span class="number">500</span>, request=request)</span><br><span class="line"></span><br><span class="line"><span class="meta">  @classmethod</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">from_crawler</span>(<span class="params">cls, crawler</span>):</span></span><br><span class="line">      <span class="keyword">return</span> cls(timeout=crawler.settings.get(<span class="string">&#x27;SELENIUM_TIMEOUT&#x27;</span>),</span><br><span class="line">                 service_args=crawler.settings.get(<span class="string">&#x27;PHANTOMJS_SERVICE_ARGS&#x27;</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>process_request() 方法中，通过 Request 的 meta 属性获取当前需要爬取的页码，调用 PhantomJS 对象的 get() 方法访问 Request 对应的 URL，相当于从 Request 对象里获取请求链接，然后再用 PhantomJS 加载，而不再用 Scrapy 里的 Downloader</p>
<h5 id="解析页面"><a href="#解析页面" class="headerlink" title="解析页面"></a>解析页面</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">	products = response.xpath(..)</span><br><span class="line">	...</span><br></pre></td></tr></table></figure>

<p>使用 XPath 进行解析，调用 response 变量的 xpath() 方法</p>
<h4 id="13-9-Scrapy-对接-Splash"><a href="#13-9-Scrapy-对接-Splash" class="headerlink" title="13.9 Scrapy 对接 Splash"></a>13.9 Scrapy 对接 Splash</h4><p>Splash 和 Scrapy 都支持异步处理</p>
<p>在 Selenium 的对接过程中，每个页面的渲染下载是在 Downloader Middleware 里完成的，所以整个过程是阻塞式的。Scrapy 会等待这个过程完成后再继续处理和调度其它请求，影响了爬取效率，因此使用 Splash 的爬取效率币 Selenium 高很多</p>
<h4 id="13-10-通用爬虫"><a href="#13-10-通用爬虫" class="headerlink" title="13.10 通用爬虫"></a>13.10 通用爬虫</h4><h5 id="CrawSpider"><a href="#CrawSpider" class="headerlink" title="CrawSpider"></a>CrawSpider</h5><p>官方文档 <a href="https://docs.scrapy.org/en/latest/topics/spiders.html#crawlspider">https://docs.scrapy.org/en/latest/topics/spiders.html#crawlspider</a></p>
<p>Scrapy 提供的一个通用爬虫，在 Spider 里，可以指定一些爬取规则来实现页面的提取，这些爬取规则由一个专门 的数据结构 Rule 表示，Rule 里包含提取和跟进页面的配置，Spider 会根据 Rule 来确定当前页面中的哪些链接需要继续爬取、哪些页面的爬取结果需要用哪个方法解析</p>
<p>CrawlSpider 类继承自 Spider 类</p>
<p>rules：爬取规则属性，是包含一个或多个 Rule 对象的列表。每个 Rule 对爬取网站的动作都做了定义，CrawlSpider 会读取 rules 的每一个 Rule 并进行解析</p>
<p>parse_start_url()：是一个可重写的方法，当 start_urls 里对应的 Request 得到 Response 时，该方法被调用，会解析 Response 并必须返回 Item 对象或者 Request 对象</p>
<h6 id="Rule"><a href="#Rule" class="headerlink" title="Rule"></a>Rule</h6><p>定义页面的爬取逻辑</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">scrapy</span>.<span class="title">contrib</span>.<span class="title">spiders</span>.<span class="title">Rule</span>(<span class="params">link_extractor, callback=<span class="literal">None</span>, cb_kwargs=<span class="literal">None</span>, follow=<span class="literal">None</span>, process_links=<span class="literal">None</span>, process_request=<span class="literal">None</span></span>)</span></span><br></pre></td></tr></table></figure>

<p>link_extractor：LinkExtractor 对象，通过它，Spider 可以知道从爬取的页面中提取哪些链接，提取的链接会自动生成 Request，一般常用 LxmlLinkExtractor 对象作为参数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LxmlLinkExtractor</span>(<span class="params">FilteringLinkExtractor</span>):</span></span><br><span class="line">  	<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  	allow 正则表达式或正则表达式列表，定义从当前页面提取出的链接哪些是符合要求的，只有符合要求的链接才会被跟进；deny 则相反</span></span><br><span class="line"><span class="string">  	allow_domains 定义了符合要求的域名，在此域名的链接才会被跟进生成新的Request；deny_domains相反</span></span><br><span class="line"><span class="string">  	restrict_xpaths 从当前页面中XPath匹配的区域提取链接，值是XPath表达式或XPath表达式列表</span></span><br><span class="line"><span class="string">  	restrict_css 从当前页面中CSS选择器匹配的区域提取链接，值是CSS选择器或CSS选择器列表</span></span><br><span class="line"><span class="string">  	&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        self,</span></span></span><br><span class="line"><span class="function"><span class="params">        allow=(<span class="params"></span>),</span></span></span><br><span class="line"><span class="function"><span class="params">        deny=(<span class="params"></span>),</span></span></span><br><span class="line"><span class="function"><span class="params">        allow_domains=(<span class="params"></span>),</span></span></span><br><span class="line"><span class="function"><span class="params">        deny_domains=(<span class="params"></span>),</span></span></span><br><span class="line"><span class="function"><span class="params">        restrict_xpaths=(<span class="params"></span>),</span></span></span><br><span class="line"><span class="function"><span class="params">        tags=(<span class="params"><span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;area&#x27;</span></span>),</span></span></span><br><span class="line"><span class="function"><span class="params">        attrs=(<span class="params"><span class="string">&#x27;href&#x27;</span>,</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">        canonicalize=<span class="literal">False</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        unique=<span class="literal">True</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        process_value=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        deny_extensions=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        restrict_css=(<span class="params"></span>),</span></span></span><br><span class="line"><span class="function"><span class="params">        strip=<span class="literal">True</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        restrict_text=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    </span>):</span></span><br></pre></td></tr></table></figure>

<p>callback：回调函数，每次从 link_extractor 中获取到链接时，该函数会被调用</p>
<p>避免使用 parse() 作为回调函数，由于 CrawlSpider 使用 parse() 方法来实现逻辑，如果 parse() 方法被覆盖了，CrawlSpider 将会运行失败</p>
<p>cb_kwargs：字典，它包含传递给回调函数的参数</p>
<p>follow：True 或 False，指定跟进规则从 Response 提取的链接是否需要跟进，如果 callback 为 None，follow 默认设置为 True，否则默认为 False</p>
<p>True，下一页的页面如果请求成功了就需要继续像上一个一样分析，代表继续跟进匹配分析</p>
<p>。。。</p>
<h6 id="Item-Loader"><a href="#Item-Loader" class="headerlink" title="Item Loader"></a>Item Loader</h6><p>提供一种便捷的机制帮助我们方便地提取 Item</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">scrapy</span>.<span class="title">loader</span>.<span class="title">ItemLoader</span>(<span class="params">[item, selector, response,] **kwargs</span>)</span></span><br><span class="line"><span class="class">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="class"><span class="title">item</span>:</span> Item对象，可以调用add_xpath()、add_css()、add_value()等方法来填充 Item对象</span><br><span class="line">selector: 是Selector对象，用来提取填充数据的选择器</span><br><span class="line">response: 是Response对象，用来使用构造选择器的Response</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>一个比较典型的Item Loader</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.loader <span class="keyword">import</span> ItemLoader</span><br><span class="line"><span class="keyword">from</span> project.items <span class="keyword">import</span> Product</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">loader = ItemLoader(item=Product(), response=response)</span><br><span class="line">loader.add_xpath(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;//div[@class=&quot;procuct_name&quot;]&#x27;</span>)</span><br><span class="line">loader.add_css(<span class="string">&#x27;stock&#x27;</span>, <span class="string">&#x27;p#stock&#x27;</span>)</span><br><span class="line">loader.add_value(<span class="string">&#x27;last_update&#x27;</span>, <span class="string">&#x27;today&#x27;</span>)</span><br><span class="line"><span class="keyword">return</span> loader.load_item()</span><br></pre></td></tr></table></figure>

<p>Item Loader 每个字段中都包含了一个 Input Processor(输入处理器) 和 一个 Output Processor(输出处理器)</p>
<p>InputProcessor 收到数据时立刻提取数据，保存到 ItemLoader 内，但不会分配给Item load_item 调用来生成 Item 对象。调用时会先调用  Output Processor 来处理之前收集到的数据，然后在存入 Item 中</p>
<p>一些内置 Processor</p>
<ul>
<li>Identity</li>
</ul>
<p>最简单的 Processor，不进行任何处理，直接返回原来的数据</p>
<ul>
<li>TakeFirst</li>
</ul>
<p>返回列表的第一个非空值，类似 extract_firs() 的功能，常用作 Output Processor</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.loader.processor <span class="keyword">import</span> TakeFirst</span><br><span class="line">processor = TakeFirst()</span><br><span class="line">print([<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>]) </span><br><span class="line"><span class="comment">#结果：输出 1</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Join</li>
</ul>
<p>相当于字符串的 join()方法，可以把列表拼合成字符串，字符串默认使用空格分隔</p>
<p>也可以通过参数更改默认分隔符</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.loader.processor <span class="keyword">import</span> Join</span><br><span class="line">processor = Join()</span><br><span class="line">print(processor([<span class="string">&#x27;one&#x27;</span>, <span class="string">&#x27;two&#x27;</span>, <span class="string">&#x27;three&#x27;</span>]))</span><br><span class="line"><span class="comment">#结果： one two three</span></span><br><span class="line">processor = Join(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line"><span class="comment">#结果： one,two,three</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Compose</li>
</ul>
<p>是用给定的多个函数的组合而构造的 Processor，每个输入值被传递到第一个函数，其输出再传递到第二个函数，依次类推，知道最后一个函数返回整个处理器的输出</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.loader.processor <span class="keyword">import</span> Compose</span><br><span class="line">processor = Compose(<span class="built_in">str</span>.upper, <span class="keyword">lambda</span> s: s.strip())</span><br><span class="line">print(processor(<span class="string">&#x27; hello world&#x27;</span>))</span><br><span class="line"><span class="comment">#结果：HELLO WORLD</span></span><br></pre></td></tr></table></figure>

<p>第一个参数 str.upper，第二个是一个匿名函数，strip() 方法去除头尾空白字符，Compose 会顺次调用两个参数</p>
<ul>
<li>MapCompose</li>
</ul>
<p>与 Compose 类似，MapCompose可以迭代处理一个列表输入值</p>
<p>被处理对象是一个可迭代对象</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.loader.processor <span class="keyword">import</span> MapCompose</span><br><span class="line">processor = MapCompose(<span class="built_in">str</span>.upper, <span class="keyword">lambda</span> s: s.strip())</span><br><span class="line">print(processor([<span class="string">&#x27;Hello&#x27;</span>, <span class="string">&#x27;world&#x27;</span>, <span class="string">&#x27;Python&#x27;</span>]))</span><br><span class="line"><span class="comment">#结果：[&#x27;HELLO&#x27;, &#x27;WORLD&#x27;, &#x27;PYTHON&#x27;]</span></span><br></pre></td></tr></table></figure>

<ul>
<li>SelectJmes</li>
</ul>
<p>SelectJmes 可以查询 JSON，传入 Key，返回查询所得到的 Value，要安装 jmespath 库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install jmespath</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.loader.processor <span class="keyword">import</span> SelectJmes</span><br><span class="line">processor = SeleJme(<span class="string">&#x27;foo&#x27;</span>)</span><br><span class="line">print(processor(&#123;<span class="string">&#x27;foo&#x27;</span>: <span class="string">&#x27;bar&#x27;</span>&#125;))</span><br><span class="line"><span class="comment">#结果：bar</span></span><br></pre></td></tr></table></figure>





<h5 id="爬取中华网科技类新闻"><a href="#爬取中华网科技类新闻" class="headerlink" title="爬取中华网科技类新闻"></a>爬取中华网科技类新闻</h5><p><a href="https://tech.china.com/articles/">https://tech.china.com/articles/</a> 爬取新闻列表中所有分页的新闻详情，包括标题、正文、时间、来源</p>
<h6 id="新建项目"><a href="#新建项目" class="headerlink" title="新建项目"></a>新建项目</h6><p>新建 Scrapy 项目，名为 scrapyuniversal</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scrapy startproject scrapyuniversal</span><br></pre></td></tr></table></figure>

<p>创建一个 CrawlSpider，需要先指定一个模板，看看哪些模板可用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scrapy genspider -l</span><br><span class="line">#运行结果</span><br><span class="line">Available templates:</span><br><span class="line">  basic</span><br><span class="line">  crawl</span><br><span class="line">  csvfeed</span><br><span class="line">  xmlfeed</span><br></pre></td></tr></table></figure>

<p>创建 Spider 的时候默认使用了第一个模板 basic，要创建 CrawlSpider 选择 crawl 模板</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scrapy genspider -t crawl china tech.china.com</span><br></pre></td></tr></table></figure>

<p>生成的 Spider 内容多了一个 rules，回调函数不再是 parse，而是 parse_item</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">rules = (</span><br><span class="line">    Rule(LinkExtractor(allow=<span class="string">r&#x27;Items/&#x27;</span>), callback=<span class="string">&#x27;parse_item&#x27;</span>, follow=<span class="literal">True</span>),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h6 id="定义-Rule"><a href="#定义-Rule" class="headerlink" title="定义 Rule"></a>定义 Rule</h6><p>要实现新闻的爬取，需要做的就是定义好 Rule，然后实现解析函数</p>
<p>修改 start_urls </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">start_urls = [<span class="string">&#x27;http://tech.china.com/articles/&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>Spider 爬取 start_urls 里的每一个链接，得到 Response 之后，Spider 就会根据 Rule 里来提取这个页面内的超链接，去生成进一步的 Request，接下来定义 Rule 来指定提取哪些链接</p>
<p>将新闻列表中每条新闻的详情链接提取出来</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;wntjItem item_defaultView clearfix&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;item_con&quot;</span> <span class="attr">style</span>=<span class="string">&quot;margin-left: 0px;&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;item-con-inner&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">&quot;tit&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://tech.china.com/article/20220224/202202241016344.html&quot;</span> <span class="attr">target</span>=<span class="string">&quot;_blank&quot;</span>&gt;</span>世界首台量子重力仪“走出实验室”，对学界、业界和国家安全等将具有深远影响<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;item_foot&quot;</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;time&quot;</span>&gt;</span>2022-02-24 05:59<span class="tag">&lt;/<span class="name">span</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;tag&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;item_num&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;s-nub&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以用 LinkExtractor 的 restrict_xpaths 属性来指定，之后 Spider 就会从这个区域提取所有超链接生成 Request。</p>
<p>但是每篇文章的导航中可能还有一些其它超链接标签，我们只需要新闻的超链接，真正新闻超链接路径都是以article开头的，用一个正则表达式将其匹配出来再赋值给 allow 即可，还需要指定一个回调函数 callback</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">rules = (</span><br><span class="line">  Rule(LinkExtractor(allow=<span class="string">&#x27;article\/.*\.html&#x27;</span>, restrict_xpaths=<span class="string">&#x27;//[@id=&quot;rank-defList&quot;]//[@class=&quot;tit&quot;]&#x27;</span>), callback=<span class="string">&#x27;parse_item&#x27;</span>, follow=<span class="literal">True</span>),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>还要让当前页面实现分页功能，所以还需要提取下一页的链接</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;pages&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;a1&quot;</span>&gt;</span>12219条<span class="tag">&lt;/<span class="name">a</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://tech.china.com/articles/index.html&quot;</span> <span class="attr">class</span>=<span class="string">&quot;a1&quot;</span>&gt;</span>上一页<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span>&gt;</span>1<span class="tag">&lt;/<span class="name">span</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://tech.china.com/articles/index_2.html&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">a</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://tech.china.com/articles/index_9.html&quot;</span>&gt;</span>9<span class="tag">&lt;/<span class="name">a</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://tech.china.com/articles/index_10.html&quot;</span>&gt;</span>10<span class="tag">&lt;/<span class="name">a</span>&gt;</span> ..</span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://tech.china.com/articles/index_489.html&quot;</span>&gt;</span>489<span class="tag">&lt;/<span class="name">a</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://tech.china.com/articles/index_2.html&quot;</span> <span class="attr">class</span>=<span class="string">&quot;a1&quot;</span>&gt;</span>下一页<span class="tag">&lt;/<span class="name">a</span>&gt;</span>	</span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>再加一个 Rule</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Rule(LinkExtractor(restrict_xpaths=<span class="string">&#x27;//div[@class=&quot;pages&quot;]//a[contains(., &quot;下一页&quot;)]&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>不需要像新闻详情页一样去提取页面详细信息，也就是不需要生成 Item，所以不需要加 callback 参数</p>
<p>接着运行代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scrapy crawl china</span><br></pre></td></tr></table></figure>

<p>查看输出，实现了翻页和详情页的抓取了</p>
<h6 id="解析页面-1"><a href="#解析页面-1" class="headerlink" title="解析页面"></a>解析页面</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_item</span>(<span class="params">self, response</span>):</span></span><br><span class="line">    loader = ChinaLoader(item=NewsItem(), response=response)</span><br><span class="line">    loader.add_xpath(<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;//h1[@id=&quot;chan_newsTitle&quot;]/text()&#x27;</span>)</span><br><span class="line">    loader.add_value(<span class="string">&#x27;url&#x27;</span>, response.url)</span><br><span class="line">    loader.add_xpath(<span class="string">&#x27;text&#x27;</span>, <span class="string">&#x27;//div[@id=&quot;chan_newsDetail&quot;]/text()&#x27;</span>)</span><br><span class="line">    loader.add_xpath(<span class="string">&#x27;datetime&#x27;</span>, <span class="string">&#x27;//div[@id=&quot;chan_newsInfo&quot;]//*[@class=&quot;time&quot;]/text()&#x27;</span>,re=<span class="string">&#x27;(\d+-\d+-\d+\s\d+:\d+:\d+)&#x27;</span>)</span><br><span class="line">    loader.add_xpath(<span class="string">&#x27;source&#x27;</span>, <span class="string">&#x27;//div[@id=&quot;chan_newsInfo&quot;]//*[@class=&quot;source&quot;]/text()&#x27;</span>, re=<span class="string">&#x27;来源：(.*)&#x27;</span>)</span><br><span class="line">    loader.add_value(<span class="string">&#x27;website&#x27;</span>, <span class="string">&#x27;中华网&#x27;</span>)</span><br><span class="line">    <span class="keyword">yield</span> loader.load_item()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.loader <span class="keyword">import</span> ItemLoader</span><br><span class="line"><span class="keyword">from</span> scrapy.loader.processors <span class="keyword">import</span> TakeFirst, Join, Compose</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NewsLoader</span>(<span class="params">ItemLoader</span>):</span></span><br><span class="line">  default_output_processor = TakeFirst()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChinaLoader</span>(<span class="params">NewsLoader</span>):</span></span><br><span class="line">  text_out = Compose(Join(), <span class="keyword">lambda</span> s: s.strip()) <span class="comment">#把列表拼合成一个字符串</span></span><br><span class="line">  source_out = Compose(Join(), <span class="keyword">lambda</span> s: s.strip())</span><br></pre></td></tr></table></figure>

<h6 id="通用配置抽取"><a href="#通用配置抽取" class="headerlink" title="通用配置抽取"></a>通用配置抽取</h6><h4 id="13-11-Scrapyt"><a href="#13-11-Scrapyt" class="headerlink" title="13.11 Scrapyt"></a>13.11 Scrapyt</h4><p>Scrapyt 为 Scrapy 提供了一个调度的 HTTP 接口，有了它就不需要再执行 Scrapy 命令，而是通过请求一个 HTTP 接口即可调度 Scrapy 任务，如果项目是在远程服务器运行，可以利用它来启动项目</p>
<h5 id="GET-请求"><a href="#GET-请求" class="headerlink" title="GET 请求"></a>GET 请求</h5><p>支持如下参数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">spider_name：Spider 名称</span></span><br><span class="line"><span class="string">url：爬取链接，如果传递了该参数，Scrapy会直接使用该URL生成Request，而直接忽略start_requests()方法和start_urls属性的定义</span></span><br><span class="line"><span class="string">callback：回调函数名称</span></span><br><span class="line"><span class="string">max_requests：最大请求数量，可选，如定义5，表示最多执行5次Request请求，其余会被忽略</span></span><br><span class="line"><span class="string">start_requests：是否要执行start_requests方法，布尔类型，可选，Scrapy项目中如果定义了start_requests方法，项目启动时会默认调用该方法，Scrapyrt中就不一样，默认不执行start_requests方法，如果要执行start_requests，设置为true</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>在项目目录下运行 Scrapyrt，默认服务运行在 9080 端口上</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:9080&#x2F;crawl.json\?spider_name\&#x3D;china\&amp;url\&#x3D;http:&#x2F;&#x2F;tech.china.com&#x2F;articles&#x2F;</span><br></pre></td></tr></table></figure>

<p>会返回一个 JSON 格式，status 显示了爬取状态，items 部分是项目的爬取结果，stats 是爬取的统计情况，items_dropped 是被忽略的 Item 列表</p>
<h5 id="POST-请求"><a href="#POST-请求" class="headerlink" title="POST 请求"></a>POST 请求</h5><p>Request Body 必须是一个合法的JSON配置，JSON里面可以配置响应的参数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">spider_name</span></span><br><span class="line"><span class="string">max_requests</span></span><br><span class="line"><span class="string">request: Request配置，JSON对象，必传参数，通过该参数可以定义Request的各个参数，必须指定url字段指定爬取链接,其它参数可选</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>JSON配置实例</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;request&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;http://quotes.toscrape.com/&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;callback&quot;</span>: <span class="string">&quot;parse&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dont_filter&quot;</span>: <span class="string">&quot;True&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;cookies&quot;</span>:&#123;</span><br><span class="line">      <span class="attr">&quot;foo&quot;</span>: <span class="string">&quot;bar&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;max_requests&quot;</span>:<span class="number">2</span>,</span><br><span class="line">  <span class="attr">&quot;spider_name&quot;</span>:quotes</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行下面命令传递该JSON配置并发起POST请求</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:9080&#x2F;crawl.json -d &#39;&#123;&quot;requests&quot;...JSON字符串&#125;&#39;</span><br></pre></td></tr></table></figure>

<h4 id="Scrapy对接Docker"><a href="#Scrapy对接Docker" class="headerlink" title="Scrapy对接Docker"></a>Scrapy对接Docker</h4><p>把 Scrapy 项目制作成一个 Docker 镜像，只要其它主机安装了 Docker，那么只要将镜像下载并运行即可，而不必担心环境问题或版本问题</p>
<h5 id="创建Dockerfile"><a href="#创建Dockerfile" class="headerlink" title="创建Dockerfile"></a>创建Dockerfile</h5><p>项目根目录下新建 requirements.txt，将整个项目依赖的 Python 环境包都列出来，如</p>
<p>如果库需要特定的版本，还可以指定版本号</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scrapy</span><br><span class="line">pymongo</span><br><span class="line">scrapy&gt;&#x3D;1.4.0</span><br><span class="line">pymongo&gt;&#x3D;3.4.0</span><br></pre></td></tr></table></figure>

<p>根目录下新建 Dockerfile 没有后缀，修改内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">FROM python:3.8 </span><br><span class="line">ENV PATH &#x2F;usr&#x2F;local&#x2F;bin:$PATH</span><br><span class="line">ADD . &#x2F;code</span><br><span class="line">WORKDIR &#x2F;code</span><br><span class="line">RUN pip3.8 install -r requirements.txt</span><br><span class="line">CMD scrapy crawl china</span><br><span class="line">#第一行From代表使用 Docker 基础镜像，这里直接使用 python:3.8的镜像，在此基础上运行项目</span><br><span class="line">#第二行ENV是环境变量设置，增加&#x2F;usr&#x2F;local&#x2F;bin这个环境变量路径</span><br><span class="line">#第三行ADD是将本地的代码放置到虚拟容器中 .本地当前路径 &#x2F;code代表虚拟容器中的路径</span><br><span class="line">#第四行WORKDIR是指定工作目录，这里将刚添加的代码路径设置成工作路径</span><br><span class="line">#第五行RUN是执行某些命令来做一些环境准备工作</span><br><span class="line">#第六行CMD是容器启动命令，容器运行时，此命令会被执行</span><br></pre></td></tr></table></figure>

<h5 id="构建镜像"><a href="#构建镜像" class="headerlink" title="构建镜像"></a>构建镜像</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker build -t china:latest .</span><br></pre></td></tr></table></figure>

<p>构建成功后，查看镜像</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker images</span><br><span class="line">#china latest 41c797934ce 2 minutes ago 768M</span><br></pre></td></tr></table></figure>

<h5 id="运行-1"><a href="#运行-1" class="headerlink" title="运行"></a>运行</h5><p>镜像可以本地测试运行，这样就利用此镜像新建并运行了一个 Docker 容器，运行效果完全一致</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker run china</span><br></pre></td></tr></table></figure>

<h5 id="推送至-Docker-Hub"><a href="#推送至-Docker-Hub" class="headerlink" title="推送至 Docker Hub"></a>推送至 Docker Hub</h5><p>构建完成后，可以将镜像 Push 到 Docker 镜像托管平台，Docker Hub 或者私有的 Docker Registry 等，这样就可以从远程服务器下载镜像并运行了</p>
<p><a href="https://hub.docker.com/">https://hub.docker.com</a> 注册账号，新建一个 Reponsitory，名为 quotes，比如用户名为 germey，那么此 Reponsitory 的地址就可以用 germey/quotes 来表示</p>
<p>打标签，推送镜像到 Docker Hub</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker tag quotes:latest germey&#x2F;quotes:latest</span><br><span class="line">docker push germey&#x2F;quotes</span><br></pre></td></tr></table></figure>

<p>如果我们想在其他的主机上运行这个镜像，主机上装好 Docker 后，运行命令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker run germey&#x2F;quotes</span><br></pre></td></tr></table></figure>

<p>会自动下载镜像，启动容器运行，不需要配置 Python 环境，不需要关系版本冲突的问题</p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>ReactiveObjC</title>
    <url>/2022/05/20/ReactiveObjC/</url>
    <content><![CDATA[<h4 id="RACSignal"><a href="#RACSignal" class="headerlink" title="RACSignal"></a>RACSignal</h4><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 使用步骤</span></span><br><span class="line"><span class="comment">// 1.创建信号 + (RACSignal *)createSignal:(RACDisposable * (^)(id&lt;RACSubscriber&gt; subscriber))didSubscribe</span></span><br><span class="line"><span class="comment">// 2.订阅信号,才会激活信号. - (RACDisposable *)subscribeNext:(void (^)(id x))nextBlock</span></span><br><span class="line"><span class="comment">// 3.发送信号 - (void)sendNext:(id)value</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// RACSignal底层实现：</span></span><br><span class="line"><span class="comment">// 1.创建信号，首先把didSubscribe保存到信号中，还不会触发。</span></span><br><span class="line"><span class="comment">// 2.当信号被订阅，也就是调用signal的subscribeNext:nextBlock</span></span><br><span class="line"><span class="comment">// 2.2 subscribeNext内部会创建订阅者subscriber，并且把nextBlock保存到subscriber中。</span></span><br><span class="line"><span class="comment">// 2.1 subscribeNext内部会调用siganl的didSubscribe</span></span><br><span class="line"><span class="comment">// 3.siganl的didSubscribe中调用[subscriber sendNext:@1];</span></span><br><span class="line"><span class="comment">// 3.1 sendNext底层其实就是执行subscriber的nextBlock</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//1.创建信号</span></span><br><span class="line">RACSignal *signal = [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    <span class="comment">// block调用时刻：每当有订阅者订阅信号，就会调用block</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.发送信号</span></span><br><span class="line">    [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果不再发送数据，最好发送信号完成，内部会自动调用[RACDisposable disposable]取消订阅信号</span></span><br><span class="line">    [subscriber sendCompleted];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [RACDisposable disposableWithBlock:^&#123;</span><br><span class="line">        <span class="comment">// block调用时刻：当信号发送完成或者发送错误，就会自动执行这个block,取消订阅信号</span></span><br><span class="line">        <span class="comment">// 执行完Block后，当前信号就不在被订阅了</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;信号被销毁&quot;</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">//3.订阅信号，才会激活信号</span></span><br><span class="line">[signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="comment">//block调用时刻：每当有信号发出数据，就会调用block</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;接收到数据：%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">接收到数据：1</span></span><br><span class="line"><span class="comment">信号被销毁</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h4 id="RacSubscribe"><a href="#RacSubscribe" class="headerlink" title="RacSubscribe"></a>RacSubscribe</h4><p>表示订阅者的意思，用于发送信号，这是一个协议，不是一个类，只要遵守了这个协议，并且实现方法才能成为订阅者。通过 create 创建的信号，都有一个订阅者，帮助发送数据</p>
<h4 id="RACDisposable"><a href="#RACDisposable" class="headerlink" title="RACDisposable"></a>RACDisposable</h4><p>用于取消订阅或者清理资源，当信号发送完成或者发送错误的时候，就会自动触发它</p>
<p>不想监听某个信号时，可以通过它主动取消订阅信号</p>
<h4 id="RACSubject"><a href="#RACSubject" class="headerlink" title="RACSubject"></a>RACSubject</h4><p>信号提供者，自己可以充当信号，又能发送信号</p>
<p>通常用来代替代理，有了它，就不必要定义代理了</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 使用步骤</span></span><br><span class="line"><span class="comment">// 1.创建信号 [RACSubject subject]，跟RACSiganl不一样，创建信号时没有block。</span></span><br><span class="line"><span class="comment">// 2.订阅信号 - (RACDisposable *)subscribeNext:(void (^)(id x))nextBlock</span></span><br><span class="line"><span class="comment">// 3.发送信号 sendNext:(id)value</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 底层实现</span></span><br><span class="line"><span class="comment">// RACSubject:底层实现和RACSignal不一样。</span></span><br><span class="line"><span class="comment">// 1.调用subscribeNext订阅信号，只是把订阅者保存起来，并且订阅者的nextBlock已经赋值了。</span></span><br><span class="line"><span class="comment">// 2.调用sendNext发送信号，遍历刚刚保存的所有订阅者，一个一个调用订阅者的nextBlock</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 简单使用</span></span><br><span class="line"><span class="comment">//1.创建信号</span></span><br><span class="line">RACSubject *subject = [RACSubject subject];</span><br><span class="line"><span class="comment">//2.订阅信号</span></span><br><span class="line">[subject subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;第一个订阅者%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line">[subject subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;第二个订阅者%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">//3.发送信号</span></span><br><span class="line">[subject sendNext:<span class="string">@&quot;1&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果</span></span><br><span class="line"><span class="comment">第一个订阅者1</span></span><br><span class="line"><span class="comment">第二个订阅者1</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h5 id="RACSubject-替换代理"><a href="#RACSubject-替换代理" class="headerlink" title="RACSubject 替换代理"></a>RACSubject 替换代理</h5><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"> <span class="comment">// 需求:</span></span><br><span class="line"><span class="comment">// 1.给当前控制器添加一个按钮，modal到另一个控制器界面</span></span><br><span class="line"><span class="comment">// 2.另一个控制器view中有个按钮，点击按钮，通知当前控制器</span></span><br><span class="line"></span><br><span class="line">步骤一：在第二个控制器.h，添加一个RACSubject代替代理。</span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TwoViewController</span> : <span class="title">UIViewController</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) RACSubject *delegateSignal;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">步骤二：监听第二个控制器按钮点击</span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TwoViewController</span></span></span><br><span class="line">- (<span class="keyword">IBAction</span>)notice:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">   <span class="comment">// 通知第一个控制器，告诉它，按钮被点了</span></span><br><span class="line">   <span class="comment">// 通知代理</span></span><br><span class="line">   <span class="comment">// 判断代理信号是否有值</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">self</span>.delegateSignal) &#123;</span><br><span class="line">      <span class="comment">// 有值，才需要通知</span></span><br><span class="line">      [<span class="keyword">self</span>.delegateSignal sendNext:<span class="literal">nil</span>];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">步骤三：在第一个控制器中，监听跳转按钮，给第二个控制器的代理信号赋值，并且监听.</span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">OneViewController</span> </span></span><br><span class="line">- (<span class="keyword">IBAction</span>)btnClick:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">  <span class="comment">// 创建第二个控制器</span></span><br><span class="line">  TwoViewController *twoVc = [[TwoViewController alloc] init];</span><br><span class="line">  <span class="comment">// 设置代理信号</span></span><br><span class="line">  twoVc.delegateSignal = [RACSubject subject];</span><br><span class="line">  <span class="comment">// 订阅代理信号</span></span><br><span class="line">  [twoVc.delegateSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">      <span class="built_in">NSLog</span>(<span class="string">@&quot;点击了通知按钮&quot;</span>);</span><br><span class="line">  &#125;];</span><br><span class="line">  <span class="comment">// 跳转到第二个控制器</span></span><br><span class="line">  [<span class="keyword">self</span> presentViewController:twoVc animated:<span class="literal">YES</span> completion:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h4 id="RACReplaySubject"><a href="#RACReplaySubject" class="headerlink" title="RACReplaySubject"></a>RACReplaySubject</h4><p>重复提供信号类，RACSubject 的子类</p>
<p>区别：</p>
<p>RACReplaySubject 可以先发送信号，再订阅信号。RACSubject 就不可以</p>
<p>使用场景：</p>
<p>如果一个信号每被订阅一次，就需要把之前的值重复发送一遍，使用重复提供信号类</p>
<p>可以设置 capacity 数量来限制缓存的 value 的数量，即缓存最新的几个值</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// RACReplaySubject使用步骤:</span></span><br><span class="line"><span class="comment">// 1.创建信号 [RACSubject subject]，跟RACSiganl不一样，创建信号时没有block。</span></span><br><span class="line"><span class="comment">// 2.可以先订阅信号，也可以先发送信号。</span></span><br><span class="line"><span class="comment">// 2.1 订阅信号 - (RACDisposable *)subscribeNext:(void (^)(id x))nextBlock</span></span><br><span class="line"><span class="comment">// 2.2 发送信号 sendNext:(id)value</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// RACReplaySubject:底层实现和RACSubject不一样。</span></span><br><span class="line"><span class="comment">// 1.调用sendNext发送信号，把值保存起来，然后遍历刚刚保存的所有订阅者，一个一个调用订阅者的nextBlock。</span></span><br><span class="line"><span class="comment">// 2.调用subscribeNext订阅信号，遍历保存的所有值，一个一个调用订阅者的nextBlock</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 如果想当一个信号被订阅，就重复播放之前所有值，需要先发送信号，在订阅信号。</span></span><br><span class="line"><span class="comment">// 也就是先保存值，在订阅值</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.创建信号</span></span><br><span class="line">RACReplaySubject *replaySubject = [RACReplaySubject subject];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.发送信号</span></span><br><span class="line">[replaySubject sendNext:@<span class="number">1</span>];</span><br><span class="line">[replaySubject sendNext:@<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.订阅信号</span></span><br><span class="line">[replaySubject subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@&quot;第一个订阅者接收到的数据%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 订阅信号</span></span><br><span class="line">[replaySubject subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@&quot;第二个订阅者接收到的数据%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果</span></span><br><span class="line"><span class="comment">第一个订阅者接收到的数据1</span></span><br><span class="line"><span class="comment">第一个订阅者接收到的数据2</span></span><br><span class="line"><span class="comment">第二个订阅者接收到的数据1</span></span><br><span class="line"><span class="comment">第二个订阅者接收到的数据2</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h4 id="RACTuple"><a href="#RACTuple" class="headerlink" title="RACTuple"></a>RACTuple</h4><p>元组类，类似 NSArray，用来包装值</p>
<h4 id="RACSequence"><a href="#RACSequence" class="headerlink" title="RACSequence"></a>RACSequence</h4><p>RAC 中的集合类，用于代替 NSArray，NSDictionary 可以使用它来快速遍历数组和字典</p>
<h5 id="遍历数组"><a href="#遍历数组" class="headerlink" title="遍历数组"></a>遍历数组</h5><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1.遍历数组</span></span><br><span class="line"><span class="built_in">NSArray</span> *numbers = @[@<span class="number">1</span>, @<span class="number">2</span>, @<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里其实是三步</span></span><br><span class="line"><span class="comment">// 第一步: 把数组转换成集合RACSequence numbers.rac_sequence</span></span><br><span class="line"><span class="comment">// 第二步: 把集合RACSequence转换RACSignal信号类,numbers.rac_sequence.signal</span></span><br><span class="line"><span class="comment">// 第三步: 订阅信号，激活信号，会自动把集合中的所有值，遍历出来。</span></span><br><span class="line">[numbers.rac_sequence.signal subscribeNext:^(<span class="keyword">id</span>  _Nullable x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果</span></span><br><span class="line"><span class="comment">1</span></span><br><span class="line"><span class="comment">2</span></span><br><span class="line"><span class="comment">3</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h5 id="遍历字典"><a href="#遍历字典" class="headerlink" title="遍历字典"></a>遍历字典</h5><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 2.遍历字典,遍历出来的键值对会包装成RACTuple(元组对象)</span></span><br><span class="line"><span class="built_in">NSDictionary</span> *dict = @&#123;<span class="string">@&quot;name&quot;</span>: <span class="string">@&quot;jack&quot;</span>, <span class="string">@&quot;age&quot;</span>: @<span class="number">18</span>&#125;;</span><br><span class="line">[dict.rac_sequence.signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">  <span class="comment">// 解包元组，会把元组的值，按顺序给参数里面的变量赋值</span></span><br><span class="line">  RACTupleUnpack(<span class="built_in">NSString</span> *key, <span class="built_in">NSString</span> *value) = x;</span><br><span class="line">  <span class="comment">// 相当于以下写法</span></span><br><span class="line">  <span class="comment">//NSString *key = x[0];</span></span><br><span class="line">  <span class="comment">//NSString *value = x[1];</span></span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ %@&quot;</span>, key, value);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="拼接数组"><a href="#拼接数组" class="headerlink" title="拼接数组"></a>拼接数组</h5><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="built_in">NSArray</span> *arr1 = @[<span class="string">@&quot;1&quot;</span>, <span class="string">@&quot;2”];</span></span><br><span class="line"><span class="string">NSArray *arr2 = @[@&quot;</span><span class="number">3</span><span class="string">&quot;, @&quot;</span><span class="number">4</span><span class="string">&quot;];</span></span><br><span class="line"><span class="string">NSArray *arr3 = @[arr1.rac_sequence, arr2.rac_sequence].rac_sequence.flatten.array;</span></span><br><span class="line"><span class="string">//arr3 两个数组相加 1 2 3 4</span></span><br></pre></td></tr></table></figure>

<h5 id="字典转模型"><a href="#字典转模型" class="headerlink" title="字典转模型"></a>字典转模型</h5><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 3.1 OC写法</span></span><br><span class="line"><span class="built_in">NSString</span> *filePath = [[<span class="built_in">NSBundle</span> mainBundle] pathForResource:<span class="string">@&quot;flags.plist&quot;</span> ofType:<span class="literal">nil</span>];</span><br><span class="line"><span class="built_in">NSArray</span> *dictArr = [<span class="built_in">NSArray</span> arrayWithContentsOfFile:filePath];</span><br><span class="line"><span class="built_in">NSMutableArray</span> *items = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSDictionary</span> *dict <span class="keyword">in</span> dictArr) &#123;</span><br><span class="line">    FlagItem *item = [FlagItem flagWithDict:dict];</span><br><span class="line">    [items addObject:item];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.2 RAC写法</span></span><br><span class="line"><span class="built_in">NSString</span> *filePath = [[<span class="built_in">NSBundle</span> mainBundle] pathForResource:<span class="string">@&quot;flags.plist&quot;</span> ofType:<span class="literal">nil</span>];</span><br><span class="line"><span class="built_in">NSArray</span> *dictArr = [<span class="built_in">NSArray</span> arrayWithContentsOfFile:filePath];</span><br><span class="line"><span class="built_in">NSMutableArray</span> *flags = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">_flags = flags;</span><br><span class="line"><span class="comment">// rac_sequence注意点：调用subscribeNext，并不会马上执行nextBlock，而是会等一会。</span></span><br><span class="line">[dictArr.rac_sequence.signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="comment">// 运用RAC遍历字典，x：字典</span></span><br><span class="line">    FlagItem *item = [FlagItem flagWithDict:x];</span><br><span class="line">    [flags addObject:item];</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 3.3 RAC高级写法:</span></span><br><span class="line"><span class="built_in">NSString</span> *filePath = [[<span class="built_in">NSBundle</span> mainBundle] pathForResource:<span class="string">@&quot;flags.plist&quot;</span> ofType:<span class="literal">nil</span>];</span><br><span class="line"><span class="built_in">NSArray</span> *dictArr = [<span class="built_in">NSArray</span> arrayWithContentsOfFile:filePath];</span><br><span class="line"><span class="comment">// map:映射的意思，目的：把原始值value映射成一个新值</span></span><br><span class="line"><span class="comment">// array: 把集合转换成数组</span></span><br><span class="line"><span class="comment">// 底层实现：当信号被订阅，会遍历集合中的原始值，映射成新值，并且保存到新的数组里。</span></span><br><span class="line"><span class="built_in">NSArray</span> *flags = [[dictArr.rac_sequence map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">    <span class="keyword">return</span> [FlagItem flagWithDict:value];</span><br><span class="line">&#125;] array];</span><br></pre></td></tr></table></figure>

<h4 id="RACCommand"><a href="#RACCommand" class="headerlink" title="RACCommand"></a>RACCommand</h4><p>RAC 中用于处理事件的类，可以把事件如何处理，事件中的数据如何传递，包装到这个类中，可以方便的监控事件的整个过程</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 一、RACCommand使用步骤:</span></span><br><span class="line"><span class="comment">// 1.创建命令 initWithSignalBlock:(RACSignal * (^)(id input))signalBlock</span></span><br><span class="line"><span class="comment">// 2.在signalBlock中，创建RACSignal，并且作为signalBlock的返回值</span></span><br><span class="line"><span class="comment">// 3.执行命令 - (RACSignal *)execute:(id)input</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 二、RACCommand使用注意:</span></span><br><span class="line"><span class="comment">// 1.signalBlock必须要返回一个信号，不能传nil.</span></span><br><span class="line"><span class="comment">// 2.如果不想要传递信号，直接创建空的信号[RACSignal empty];</span></span><br><span class="line"><span class="comment">// 3.RACCommand中信号如果数据传递完，必须调用[subscriber sendCompleted]，这时命令才会执行完毕，否则永远处于执行中。</span></span><br><span class="line"><span class="comment">// 4.RACCommand需要被强引用，否则接收不到RACCommand中的信号，因此RACCommand中的信号是延迟发送的</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 三、RACCommand设计思想：内部signalBlock为什么要返回一个信号，这个信号有什么用。</span></span><br><span class="line"><span class="comment">// 1.在RAC开发中，通常会把网络请求封装到RACCommand，直接执行某个RACCommand就能发送请求。</span></span><br><span class="line"><span class="comment">// 2.当RACCommand内部请求到数据的时候，需要把请求的数据传递给外界，这时候就需要通过signalBlock返回的信号传递了</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 四、如何拿到RACCommand中返回信号发出的数据。</span></span><br><span class="line"><span class="comment">// 1.RACCommand有个执行信号源executionSignals，这个是signal of signals(信号的信号),意思是信号发出的数据是信号，不是普通的类型。</span></span><br><span class="line"><span class="comment">// 2.订阅executionSignals就能拿到RACCommand中返回的信号，然后订阅signalBlock返回的信号，就能获取发出的值。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 五、监听当前命令是否正在执行executing</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 六、使用场景,监听按钮点击，网络请求</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1.创建命令</span></span><br><span class="line">RACCommand *command = [[RACCommand alloc] initWithSignalBlock:^RACSignal * (<span class="keyword">id</span> input) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;执行命令&quot;</span>);</span><br><span class="line">    <span class="comment">// 2.创建信号,用来传递数据</span></span><br><span class="line">    <span class="keyword">return</span> [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        [subscriber sendNext:<span class="string">@&quot;请求数据&quot;</span>];</span><br><span class="line">        <span class="comment">// 注意：数据传递完，最好调用sendCompleted，这时命令才执行完毕</span></span><br><span class="line">        [subscriber sendCompleted];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// 强引用命令，不要被销毁，否则接收不到数据</span></span><br><span class="line">_command = command;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.订阅RACCommand中的信号</span></span><br><span class="line">[command.executionSignals subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    [x subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, x);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// RAC高级用法</span></span><br><span class="line"><span class="comment">// switchToLatest:用于signal of signals，获取signal of signals发出的最新信号,也就是可以直接拿到RACCommand中的信号</span></span><br><span class="line">[command.executionSignals.switchToLatest subscribeNext:^(<span class="keyword">id</span>  _Nullable x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">[[command.executing skip:<span class="number">1</span>] subscribeNext:^(<span class="built_in">NSNumber</span> * x) &#123;</span><br><span class="line">    <span class="keyword">if</span> ([x boolValue] == <span class="literal">YES</span>) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;正在执行&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;执行完成&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.执行命令</span></span><br><span class="line">[command execute:@<span class="number">1</span>];</span><br></pre></td></tr></table></figure>

<h4 id="RACMulticastConnection"><a href="#RACMulticastConnection" class="headerlink" title="RACMulticastConnection"></a>RACMulticastConnection</h4><p>用于当一个信号，被多次订阅时，为了保证创建信号时，避免多次调用创建信号中的 block，造成副作用，可以使用这个类型处理</p>
<p>解决重复请求的问题</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"> <span class="comment">// RACMulticastConnection使用步骤:</span></span><br><span class="line"><span class="comment">// 1.创建信号 + (RACSignal *)createSignal:(RACDisposable * (^)(id&lt;RACSubscriber&gt; subscriber))didSubscribe</span></span><br><span class="line"><span class="comment">// 2.创建连接 RACMulticastConnection *connect = [signal publish];</span></span><br><span class="line"><span class="comment">// 3.订阅信号,注意：订阅的不再是之前的信号，而是连接的信号。 [connect.signal subscribeNext:nextBlock]</span></span><br><span class="line"><span class="comment">// 4.连接 [connect connect]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"> <span class="comment">// RACMulticastConnection底层原理:</span></span><br><span class="line"><span class="comment">// 1.创建connect，connect.sourceSignal -&gt; RACSignal(原始信号)  connect.signal -&gt; RACSubject</span></span><br><span class="line"><span class="comment">// 2.订阅connect.signal，会调用RACSubject的subscribeNext，创建订阅者，而且把订阅者保存起来，不会执行block。</span></span><br><span class="line"><span class="comment">// 3.[connect connect]内部会订阅RACSignal(原始信号)，并且订阅者是RACSubject</span></span><br><span class="line"><span class="comment">// 3.1.订阅原始信号，就会调用原始信号中的didSubscribe</span></span><br><span class="line"><span class="comment">// 3.2 didSubscribe，拿到订阅者调用sendNext，其实是调用RACSubject的sendNext</span></span><br><span class="line"><span class="comment">// 4.RACSubject的sendNext,会遍历RACSubject所有订阅者发送信号。</span></span><br><span class="line"><span class="comment">// 4.1 因为刚刚第二步，都是在订阅RACSubject，因此会拿到第二步所有的订阅者，调用他们的nextBlock</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 需求：假设在一个信号中发送请求，每次订阅一次都会发送请求，这样就会导致多次请求。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.创建请求信号</span></span><br><span class="line">RACSignal *signal1 = [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;发送请求&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// 2.订阅信号</span></span><br><span class="line">[signal1 subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;接收数据&quot;</span>);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// 2.订阅信号</span></span><br><span class="line">[signal1 subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;接收数据&quot;</span>);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">运行结果，会执行两遍发送请求，也就是每次订阅都会发送一次请求</span></span><br><span class="line"><span class="comment">发送请求</span></span><br><span class="line"><span class="comment">发送请求</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 解决：使用RACMulticastConnection就能解决.</span></span><br><span class="line"><span class="comment">// 1.创建请求信号</span></span><br><span class="line">RACSignal *signal = [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;发送请求&quot;</span>);</span><br><span class="line">    [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">RACMulticastConnection *connect = [signal publish];</span><br><span class="line"><span class="comment">// 2.订阅信号</span></span><br><span class="line">[connect.signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;订阅者一信号%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// 2.订阅信号</span></span><br><span class="line">[connect.signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;订阅者二信号%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line">[connect connect];</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">发送请求</span></span><br><span class="line"><span class="comment">订阅者一信号1</span></span><br><span class="line"><span class="comment">订阅者二信号1</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h4 id="RACScheduler"><a href="#RACScheduler" class="headerlink" title="RACScheduler"></a>RACScheduler</h4><p>RAC 中的队列，用 GCD 封装的</p>
<h4 id="RACUnit"><a href="#RACUnit" class="headerlink" title="RACUnit"></a>RACUnit</h4><p>表示 stream 不包含有意义的值，可以理解为 nil</p>
<h4 id="RACEvent"><a href="#RACEvent" class="headerlink" title="RACEvent"></a>RACEvent</h4><p>把数据包装成信号事件（signal event）</p>
<h4 id="常见用法"><a href="#常见用法" class="headerlink" title="常见用法"></a>常见用法</h4><h5 id="代替代理"><a href="#代替代理" class="headerlink" title="代替代理"></a>代替代理</h5><p>rac_signalForSelector：用于代替代理</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 需求：自定义redView,监听红色view中按钮点击</span></span><br><span class="line"><span class="comment">// 之前都是需要通过代理监听，给红色View添加一个代理属性，点击按钮的时候，通知代理做事情</span></span><br><span class="line"><span class="comment">// rac_signalForSelector:把调用某个对象的方法的信息转换成信号，就要调用这个方法，就会发送信号。</span></span><br><span class="line"><span class="comment">// 这里表示只要redV调用btnClick:,就会发出信号，订阅就好了。</span></span><br><span class="line"></span><br><span class="line">[[redView rac_signalForSelector:<span class="keyword">@selector</span>(btnAction:)] subscribeNext:^(RACTuple *x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;红色按钮点击&quot;</span>);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[[<span class="keyword">self</span> rac_signalForSelector:<span class="keyword">@selector</span>(scrollViewDidScroll:) fromProtocol:<span class="class"><span class="keyword">@protocol</span>(<span class="title">UIScrollViewDelegate</span>)] <span class="title">subscribeNext</span>:^(<span class="title">RACTuple</span> *<span class="title">tuple</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>



<h5 id="代替KVO"><a href="#代替KVO" class="headerlink" title="代替KVO"></a>代替KVO</h5><p>rac_valuesAndChangesForKeyPath：用于监听某个对象的属性改变</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 把监听redV的center属性改变转换成信号，只要值改变就会发送信号</span></span><br><span class="line"><span class="comment">// observer:可以传入nil</span></span><br><span class="line">[[redView rac_valuesAndChangesForKeyPath:<span class="string">@&quot;center&quot;</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> observer:<span class="literal">nil</span>] subscribeNext:^(RACTwoTuple&lt;<span class="keyword">id</span>,<span class="built_in">NSDictionary</span> *&gt; *x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="监听事件"><a href="#监听事件" class="headerlink" title="监听事件"></a>监听事件</h5><p>rac_signalForControlEvents：用于监听某个事件</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 把按钮点击事件转换为信号，点击按钮，就会发送信号</span></span><br><span class="line">[[<span class="keyword">self</span>.btn rac_signalForControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>] subscribeNext:^(<span class="built_in">UIControl</span> *x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;按钮被点击&quot;</span>);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="代替通知"><a href="#代替通知" class="headerlink" title="代替通知"></a>代替通知</h5><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 把监听到的通知转换信号</span></span><br><span class="line">[[[<span class="built_in">NSNotificationCenter</span> defaultCenter] rac_addObserverForName:<span class="built_in">UIKeyboardWillShowNotification</span> object:<span class="literal">nil</span>] subscribeNext:^(<span class="built_in">NSNotification</span> *x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;键盘弹出&quot;</span>);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="监听文本框文字改变"><a href="#监听文本框文字改变" class="headerlink" title="监听文本框文字改变"></a>监听文本框文字改变</h5><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 5.监听文本框的文字改变</span></span><br><span class="line">[_textField.rac_textSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@&quot;文字改变了%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="多次请求，都获取到数据才展示界面"><a href="#多次请求，都获取到数据才展示界面" class="headerlink" title="多次请求，都获取到数据才展示界面"></a>多次请求，都获取到数据才展示界面</h5><p><code>rac_liftSelector:withSignalsFromArray:Signals</code> ：当传入的Signals(信号数组)，每一个signal都至少sendNext过一次，就会去触发第一个selector参数的方法</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 6.处理多个请求，都返回结果的时候，统一做处理.</span></span><br><span class="line">RACSignal *request1 = [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:<span class="string">@&quot;发送请求1&quot;</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line">RACSignal *request2 = [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:<span class="string">@&quot;发送请求2&quot;</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// 使用注意：几个信号，参数一的方法就几个参数，每个参数对应信号发出的数据。</span></span><br><span class="line">[<span class="keyword">self</span> rac_liftSelector:<span class="keyword">@selector</span>(updateUIWithR1:r2:) withSignalsFromArray:@[request1, request2]];</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)updateUIWithR1:(<span class="keyword">id</span>)data1 r2:(<span class="keyword">id</span>)data2 &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;更新UI %@ %@&quot;</span>, data1, data2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="常见宏"><a href="#常见宏" class="headerlink" title="常见宏"></a>常见宏</h4><ul>
<li>RAC(TARGET, …)</li>
</ul>
<p>给某个对象绑定属性</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 只要文本框文字改变，就会修改label的文字</span></span><br><span class="line">RAC(<span class="keyword">self</span>.labelView,text) = _textField.rac_textSignal;</span><br></pre></td></tr></table></figure>

<ul>
<li>RACObserve(TARGET, KEYPATH)</li>
</ul>
<p>监听某个对象的某个属性，返回的是信号</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[RACObserve(<span class="keyword">self</span>.view, center) subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<ul>
<li>@weakify(Obj)和@strongify(Obj)</li>
</ul>
<p>需要自己手动导入 RACEXTScope.h 才可使用</p>
<ul>
<li>RACTuplePack</li>
</ul>
<p>把数据包装成 RACTuple（元组类）</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">RACTuple *tuple = RACTuplePack(@<span class="number">1</span>, @<span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>RACTupleUnpack</li>
</ul>
<p>把 RACTuple（元组类）解包成对应数据</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">RACTuple *tuple = RACTuplePack(<span class="string">@&quot;jack&quot;</span>, @<span class="number">20</span>);</span><br><span class="line">RACTupleUnpack(<span class="built_in">NSString</span> *name, <span class="built_in">NSNumber</span> *age) = tuple;</span><br></pre></td></tr></table></figure>

<h4 id="常见操作方法"><a href="#常见操作方法" class="headerlink" title="常见操作方法"></a>常见操作方法</h4><p>RAC开发，应该把重心放在绑定，也就是可以在创建一个对象的时候，就绑定好以后想要做的事情，而不是等赋值之后在去做事情</p>
<p>列如：把数据展示到控件上，之前都是重写控件的setModel方法，用RAC就可以在一开始创建控件的时候，就绑定好数据</p>
<h5 id="映射-flattenMap-Map"><a href="#映射-flattenMap-Map" class="headerlink" title="映射 flattenMap Map"></a>映射 flattenMap Map</h5><p>用于把源信号内容映射成新的内容</p>
<ul>
<li>flattenMap</li>
</ul>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// flattenMap作用:把源信号的内容映射成一个新的信号，信号可以是任意类型</span></span><br><span class="line"></span><br><span class="line">[[_textField.rac_textSignal flattenMap:^__kindof RACSignal * (<span class="built_in">NSString</span> *value) &#123;</span><br><span class="line">    <span class="comment">// 返回值：绑定信号的内容.</span></span><br><span class="line">    <span class="keyword">return</span> [RACReturnSignal <span class="keyword">return</span>:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;输出:%@&quot;</span>, value]];</span><br><span class="line">&#125;] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<ul>
<li>Map</li>
</ul>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 监听文本框的内容改变，把结构重新映射成一个新值</span></span><br><span class="line"></span><br><span class="line">[[_textField.rac_textSignal map:^<span class="keyword">id</span> (<span class="built_in">NSString</span> * value) &#123;</span><br><span class="line">  	<span class="comment">// 返回值：就是处理完源信号的内容。</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;输出:%@&quot;</span>, value];</span><br><span class="line">&#125;] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<ul>
<li>区别</li>
</ul>
<p>flattenMap 中的 block 返回信号</p>
<p>Map 中的 block 返回对象</p>
<p>signal of signal 用 flattenMap</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">RACSubject *signalOfSignals = [RACSubject subject];</span><br><span class="line">RACSubject *signal = [RACSubject subject];</span><br><span class="line"></span><br><span class="line">[[signalOfSignals flattenMap:^__kindof RACSignal * (<span class="keyword">id</span> value) &#123;</span><br><span class="line">    <span class="comment">// 当signalOfsignals的signals发出信号才会调用</span></span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="comment">// 只有signalOfsignals的signal发出信号才会调用，</span></span><br><span class="line">    <span class="comment">// 因为内部订阅了bindBlock中返回的信号，也就是flattenMap返回的信号。</span></span><br><span class="line">    <span class="comment">// 也就是flattenMap返回的信号发出内容，才会调用。</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@aaa&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// 信号的信号发送信号</span></span><br><span class="line">[signalOfSignals sendNext:signal];</span><br><span class="line"><span class="comment">// 信号发送内容</span></span><br><span class="line">[signal sendNext:@<span class="number">1</span>];</span><br></pre></td></tr></table></figure>

<h5 id="组合-concat"><a href="#组合-concat" class="headerlink" title="组合 concat"></a>组合 concat</h5><p>按一定顺序拼接信号，当多个信号发出的时候，有顺序的接收信号</p>
<p>前面信号发送完成，后面信号才被激活</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">RACSignal *signalA = [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">    [subscriber sendCompleted];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line">RACSignal *signalB = [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt;  subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:@<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// 把signalA拼接到signalB后，signalA发送完成，signalB才会被激活</span></span><br><span class="line">RACSignal *concatSignal = [signalA concat:signalB];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以后只需要面对拼接信号开发。</span></span><br><span class="line"><span class="comment">// 订阅拼接的信号，不需要单独订阅signalA，signalB</span></span><br><span class="line"><span class="comment">// 内部会自动订阅。</span></span><br><span class="line"><span class="comment">// 注意：第一个信号必须发送完成，第二个信号才会被激活</span></span><br><span class="line">[concatSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">1</span></span><br><span class="line"><span class="comment">2</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">RACSignal *concatSignal =  [[signalA concat:signalC] concat:signalB]; </span><br><span class="line"><span class="comment">//或者</span></span><br><span class="line">RACSignal *concatSignal =  [RACSignal concat:@[signalA,signalC,signalB] ];</span><br></pre></td></tr></table></figure>

<h5 id="then"><a href="#then" class="headerlink" title="then"></a>then</h5><p>用于连接两个信号，当第一个信号完成，才会连接 then 返回的信号</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 注意使用then，之前信号的值会被忽略掉.</span></span><br><span class="line"><span class="comment">// 底层实现：1、先过滤掉之前的信号发出的值。2.使用concat连接then返回的信号</span></span><br><span class="line">[[[RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">    [subscriber sendCompleted];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;] then:^RACSignal *&#123;</span><br><span class="line">    <span class="keyword">return</span> [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        [subscriber sendNext:@<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="comment">// 只能接收到第二个信号的值，也就是then返回信号的值 2</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="merge"><a href="#merge" class="headerlink" title="merge"></a>merge</h5><p>把多个信号合并为一个信号，任何一个信号有新值的时候就会调用</p>
<p> 一个页面n个请求 拿到哪个数据就显示哪个数据 可以没有顺序</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 底层实现：</span></span><br><span class="line"><span class="comment">// 1.合并信号被订阅的时候，就会遍历所有信号，并且发出这些信号。</span></span><br><span class="line"><span class="comment">// 2.每发出一个信号，这个信号就会被订阅</span></span><br><span class="line"><span class="comment">// 3.也就是合并信号一被订阅，就会订阅里面所有的信号。</span></span><br><span class="line"><span class="comment">// 4.只要有一个信号被发出就会被监听</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">RACSignal *signalA = [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line">RACSignal *signalB = [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt;  subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:@<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// 合并信号,任何一个信号发送数据，都能监听到</span></span><br><span class="line">RACSignal *mergeSignal = [signalA merge:signalB];</span><br><span class="line"></span><br><span class="line">[mergeSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="zipWith"><a href="#zipWith" class="headerlink" title="zipWith"></a>zipWith</h5><p>把两个信号压缩成一个信号，只有当两个信号同时发出信号内容时，并且把两个信号的内容合并成一个元组，才会触发压缩流的 next 事件</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 底层实现:</span></span><br><span class="line"><span class="comment">// 1.定义压缩信号，内部就会自动订阅signalA，signalB</span></span><br><span class="line"><span class="comment">// 2.每当signalA或者signalB发出信号，就会判断signalA，signalB有没有发出个信号，有就会把最近发出的信号都包装成元组发出</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">RACSignal *signalA = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">   [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">RACSignal *signalB = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">   [subscriber sendNext:@<span class="number">2</span>];</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 压缩信号A，信号B</span></span><br><span class="line">RACSignal *zipSignal = [signalA zipWith:signalB];</span><br><span class="line">[zipSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">&lt;RACTwoTuple:0xxx&gt;(1,2)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h5 id="combineLatest"><a href="#combineLatest" class="headerlink" title="combineLatest"></a>combineLatest</h5><p>将多个信号合并起来，并且拿到各个信号的最新值，必须每个合并的 signal 至少都有过一次 sendNext，才会触发合并的信号</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 底层实现：</span></span><br><span class="line"><span class="comment">// 1.当组合信号被订阅，内部会自动订阅signalA，signalB,必须两个信号都发出内容，才会被触发。</span></span><br><span class="line"><span class="comment">// 2.并且把两个信号组合成元组发出。</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">RACSignal *signalA = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">   [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">RACSignal *signalB = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">   [subscriber sendNext:@<span class="number">2</span>];</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 把两个信号组合成一个信号,跟zip一样，没什么区别</span></span><br><span class="line">RACSignal *combineSignal = [signalA combineLatest:signalB];</span><br><span class="line">[combineSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">&lt;RACTwoTuple:0xxx&gt;(1,2)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h5 id="reduce"><a href="#reduce" class="headerlink" title="reduce"></a>reduce</h5><p>用于信号发出的内容是元组，把信号发出元组的值聚合成一个值</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">RACSignal *signalA = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">   [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line">RACSignal *signalB = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">   [subscriber sendNext:@<span class="number">2</span>];</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 聚合</span></span><br><span class="line"><span class="comment">// 常见的用法，（先组合在聚合）。combineLatest:(id&lt;NSFastEnumeration&gt;)signals reduce:(id (^)())reduceBlock</span></span><br><span class="line"><span class="comment">// reduce中的block简介:</span></span><br><span class="line"><span class="comment">// reduceblcok中的参数，有多少信号组合，reduceblcok就有多少参数，每个参数就是之前信号发出的内容</span></span><br><span class="line"><span class="comment">// reduceblcok的返回值：聚合信号之后的内容</span></span><br><span class="line">RACSignal *reduceSignal = [RACSignal combineLatest:@[signalA, signalB] reduce:^<span class="keyword">id</span>(<span class="built_in">NSNumber</span> *num1 ,<span class="built_in">NSNumber</span> *num2)&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;%@ %@&quot;</span>,num1,num2];</span><br><span class="line">&#125;];</span><br><span class="line">[reduceSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="过滤-filter"><a href="#过滤-filter" class="headerlink" title="过滤 filter"></a>过滤 filter</h5><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 每次信号发出，会先执行过滤条件判断.</span></span><br><span class="line">[_textField.rac_textSignal filter:^<span class="built_in">BOOL</span>(<span class="built_in">NSString</span> *value) &#123;</span><br><span class="line">    <span class="keyword">return</span> value.length &gt; <span class="number">3</span>;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="ignore"><a href="#ignore" class="headerlink" title="ignore"></a>ignore</h5><p>忽略完某些值的信号</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 内部调用filter过滤，忽略掉ignore的值</span></span><br><span class="line">[[_textField.rac_textSignal ignore:<span class="string">@&quot;1&quot;</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="startWith"><a href="#startWith" class="headerlink" title="startWith"></a>startWith</h5><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//在开始前添加数据 打印 hello world 1 2 3 4</span></span><br><span class="line">RACSignal *signal = @[@<span class="number">1</span>,@<span class="number">2</span>,@<span class="number">3</span>,@<span class="number">4</span>].rac_sequence.signal;</span><br><span class="line">RACSignal *signal2 = [signal startWith:<span class="string">@&quot;hello world&quot;</span>];</span><br><span class="line">[signal2 subscribeNext:^(<span class="keyword">id</span>  _Nullable x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="distinctUntilChanged"><a href="#distinctUntilChanged" class="headerlink" title="distinctUntilChanged"></a>distinctUntilChanged</h5><p>当上一次的值和当前的值有明显变化就会发出信号，否则被忽略掉</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 过滤，当上一次和当前的值不一样，就会发出内容。</span></span><br><span class="line"><span class="comment">// 在开发中，刷新UI经常使用，只有两次数据不一样才需要刷新</span></span><br><span class="line">[[_textField.rac_textSignal distinctUntilChanged] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="take"><a href="#take" class="headerlink" title="take"></a>take</h5><p>从开始一共取 N 次的信号</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1、创建信号</span></span><br><span class="line">RACSubject *signal = [RACSubject subject];</span><br><span class="line"><span class="comment">// 2、处理信号，订阅信号</span></span><br><span class="line">[[signal take:<span class="number">1</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.发送信号</span></span><br><span class="line">[signal sendNext:@<span class="number">1</span>];</span><br><span class="line">[signal sendNext:@<span class="number">2</span>];</span><br></pre></td></tr></table></figure>

<h5 id="takeLast"><a href="#takeLast" class="headerlink" title="takeLast"></a>takeLast</h5><p>取最后 N 次的信号，前提条件，订阅者必须调用完成</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1、创建信号</span></span><br><span class="line">RACSubject *signal = [RACSubject subject];</span><br><span class="line"><span class="comment">// 2、处理信号，订阅信号</span></span><br><span class="line">[[signal takeLast:<span class="number">1</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.发送信号</span></span><br><span class="line">[signal sendNext:@<span class="number">1</span>];</span><br><span class="line">[signal sendNext:@<span class="number">2</span>];</span><br><span class="line">[signal sendCompleted];</span><br></pre></td></tr></table></figure>

<h5 id="takeUntil"><a href="#takeUntil" class="headerlink" title="takeUntil"></a>takeUntil</h5><p>获取信号值直到某个信号执行完成</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 监听文本框的改变直到当前对象被销毁</span></span><br><span class="line">[_textField.rac_textSignal takeUntil:<span class="keyword">self</span>.rac_willDeallocSignal];</span><br></pre></td></tr></table></figure>

<h5 id="skip"><a href="#skip" class="headerlink" title="skip"></a>skip</h5><p>跳过几个信号</p>
<figure class="highlight objectivec"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 表示输入第一次，不会被监听到，跳过第一次发出的信号</span></span><br><span class="line">[[_textField.rac_textSignal skip:<span class="number">1</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="switchToLatest"><a href="#switchToLatest" class="headerlink" title="switchToLatest"></a>switchToLatest</h5><p>用于 signalOfSignals（信号的信号），有时候信号也会发出信号，获取 signalOfSignals 发送的最新信号</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">RACSubject *signalOfSignals = [RACSubject subject];</span><br><span class="line">RACSubject *signal = [RACSubject subject];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取信号中信号最近发出信号，订阅最近发出的信号。</span></span><br><span class="line"><span class="comment">// 注意switchToLatest：只能用于信号中的信号</span></span><br><span class="line">[signalOfSignals.switchToLatest subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line">[signalOfSignals sendNext:signal];</span><br><span class="line">[signal sendNext:@<span class="number">1</span>];</span><br></pre></td></tr></table></figure>

<h5 id="ifThenElse"><a href="#ifThenElse" class="headerlink" title="ifThenElse"></a>ifThenElse</h5><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">RACSignal *signalA = @[@<span class="number">1</span>, @<span class="number">2</span>, @<span class="number">3</span>].rac_sequence.signal;</span><br><span class="line">RACSignal *signalB = @[<span class="string">@&quot;a&quot;</span>, <span class="string">@&quot;b&quot;</span>, <span class="string">@&quot;c&quot;</span>].rac_sequence.signal;</span><br><span class="line">RACSubject *subject = [RACSubject subject];</span><br><span class="line">[[RACSignal <span class="keyword">if</span>:subject then:signalA <span class="keyword">else</span>:signalB] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line">[subject sendNext:@<span class="number">1</span>];</span><br><span class="line">dispatch_after(dispatch_time(DISPATCH_TIME_NOW, <span class="number">2</span>), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">    [subject sendNext:@<span class="number">0</span>];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h5 id="doNext，doCompleted"><a href="#doNext，doCompleted" class="headerlink" title="doNext，doCompleted"></a>doNext，doCompleted</h5><p>doNext 执行 Next 之前，会先执行这个 block</p>
<p>doCompleted 执行 sendCompleted 之前，会先执行这个 block</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"> [[[[RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">    [subscriber sendCompleted];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;] doNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;doNext&quot;</span>);</span><br><span class="line">&#125;] doCompleted:^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;doCompleted&quot;</span>);</span><br><span class="line">&#125;] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">doNext</span></span><br><span class="line"><span class="comment">1</span></span><br><span class="line"><span class="comment">doCompleted</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h5 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h5><p>deliverOn：内容传递切换到指定线程中，副作用在原来线程中，把在创建信号时 block 中的代码称之为副作用</p>
<p>subscribeOn：内容传递和副作用都会切换到指定线程中</p>
<h5 id="timeout"><a href="#timeout" class="headerlink" title="timeout"></a>timeout</h5><p>超时，让一个信号在一定时间后自动报错</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">RACSignal *signal = [[RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;] timeout:<span class="number">1</span> onScheduler:[RACScheduler currentScheduler]];</span><br><span class="line"></span><br><span class="line">[signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125; error:^(<span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">    <span class="comment">// 1秒后会自动调用</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,error);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="interval"><a href="#interval" class="headerlink" title="interval"></a>interval</h5><p>定时，每隔一段时间发出信号</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">[[RACSignal interval:<span class="number">1</span> onScheduler:[RACScheduler currentScheduler]] subscribeNext:^(<span class="keyword">id</span> x) &#123;   </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="delay"><a href="#delay" class="headerlink" title="delay"></a>delay</h5><p>延迟发送 next</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">RACSignal *signal = [[[RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;] delay:<span class="number">2</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="retry"><a href="#retry" class="headerlink" title="retry"></a>retry</h5><p>重试，只要失败，就会重新执行创建信号中的 block，直到成功</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">__block <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">[[[RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">  <span class="keyword">if</span> (i == <span class="number">10</span>) &#123;</span><br><span class="line">      [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="built_in">NSLog</span>(<span class="string">@&quot;接收到错误&quot;</span>);</span><br><span class="line">      [subscriber sendError:<span class="literal">nil</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  i++;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;] retry] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125; error:^(<span class="built_in">NSError</span> *error) &#123;</span><br><span class="line"></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="replay"><a href="#replay" class="headerlink" title="replay"></a>replay</h5><p><a href="https://www.cnblogs.com/zz-vv/p/4834042.html">replay、replayLast、replayLazily</a></p>
<p>对于普通的信号，每次订阅都会导致信号中的代码被执行一遍（block中的代码）</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">__block <span class="keyword">int</span> num = <span class="number">0</span>;</span><br><span class="line">RACSignal *signal = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    num ++;</span><br><span class="line">    [subscriber sendNext:@(num)];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line">[signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;s1:%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line">[signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;s2:%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line">[signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;s3:%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">s1:1</span></span><br><span class="line"><span class="comment">s2:2</span></span><br><span class="line"><span class="comment">s3:3</span></span><br><span class="line"><span class="comment">block 中的代码被执行了3次</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>replay 返回一个新的信号，源信号被订阅时，会立即发送订阅者全部历史的值，不会重复执行源信号中的订阅代码，订阅者还将接收未来发送过去的值</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">//演示：每个新添加的订阅者接收到信号中全部的值（不管之前还是将来发出的值）</span></span><br><span class="line">RACSubject *letters = [RACSubject subject];</span><br><span class="line">RACSignal *signal = [letters replay]; </span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;Subscribe S1&quot;</span>);</span><br><span class="line">[signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;S1: %@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;Send A&quot;</span>);</span><br><span class="line">[letters sendNext:<span class="string">@&quot;A&quot;</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;Send B&quot;</span>);</span><br><span class="line">[letters sendNext:<span class="string">@&quot;B&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;Subscribe S2&quot;</span>);</span><br><span class="line">[signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;S2: %@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;Send C&quot;</span>);</span><br><span class="line">[letters sendNext:<span class="string">@&quot;C&quot;</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;Send D&quot;</span>);</span><br><span class="line">[letters sendNext:<span class="string">@&quot;D&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;Subscribe S3&quot;</span>);</span><br><span class="line">[signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;S3: %@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Subscribe S1   </span></span><br><span class="line"><span class="comment">Send A   </span></span><br><span class="line"><span class="comment">S1: A</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">Send B</span></span><br><span class="line"><span class="comment">S1: B</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">Subscribe S2</span></span><br><span class="line"><span class="comment">S2: A</span></span><br><span class="line"><span class="comment">S2: B //发送历史值</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">Send C</span></span><br><span class="line"><span class="comment">S1: C</span></span><br><span class="line"><span class="comment">S2: C</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">Send D</span></span><br><span class="line"><span class="comment">S1: D</span></span><br><span class="line"><span class="comment">S2: D</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">Subscribe S3</span></span><br><span class="line"><span class="comment">S3: A</span></span><br><span class="line"><span class="comment">S3: B</span></span><br><span class="line"><span class="comment">S3: C</span></span><br><span class="line"><span class="comment">S3: D //发送历史值</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h5 id="replayLast"><a href="#replayLast" class="headerlink" title="replayLast"></a>replayLast</h5><p>返回一个新的信号，源信号被订阅时，会立即发送给订阅者最新的值，不会重复执行源信号中的订阅代码，订阅者还将接收未来发送过去的值</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">Subscribe S1</span><br><span class="line">Send A</span><br><span class="line">S1: A</span><br><span class="line"> </span><br><span class="line">Send B</span><br><span class="line">S1: B</span><br><span class="line"> </span><br><span class="line">Subscribe S2</span><br><span class="line">S2: B <span class="comment">//接收最新值</span></span><br><span class="line"> </span><br><span class="line">Send C</span><br><span class="line">S1: C</span><br><span class="line">S2: C</span><br><span class="line"> </span><br><span class="line">Send D</span><br><span class="line">S1: D</span><br><span class="line">S2: D</span><br><span class="line"> </span><br><span class="line">Subscribe S3</span><br><span class="line">S3: D</span><br></pre></td></tr></table></figure>





<h5 id="throttle"><a href="#throttle" class="headerlink" title="throttle"></a>throttle</h5><p>当某个信号发送比较频繁时，可以使用节流，在某一段时间不发送信号内容，过了一段时间获取信号的最新内容发出</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">RACSubject *signal = [RACSubject subject];</span><br><span class="line">_signal = signal;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 节流，在一定时间（1秒）内，不接收任何信号内容，过了这个时间（1秒）获取最后发送的信号内容发出。</span></span><br><span class="line">[[signal throttle:<span class="number">1</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>





<p> <a href="https://www.jianshu.com/p/ceebb496c226">RAC资源帖</a></p>
<p><a href="https://www.jianshu.com/p/87ef6720a096">ReactiveCocoa基础篇</a></p>
<p><a href="https://www.jianshu.com/p/e10e5ca413b7">ReactiveCocoa进阶篇</a></p>
]]></content>
      <categories>
        <category>iOS</category>
      </categories>
  </entry>
  <entry>
    <title>逆向-Frida</title>
    <url>/2022/06/13/%E9%80%86%E5%90%91-Frida/</url>
    <content><![CDATA[<p><a href="https://frida.re/docs/home/">https://frida.re/docs/home/</a></p>
<p><a href="https://www.frida.re/docs/javascript-api">https://www.frida.re/docs/javascript-api</a></p>
<p><a href="https://zhuanlan.kanxue.com/article-342.htm">JavaScript API 一</a></p>
<p><a href="https://zhuanlan.kanxue.com/article-414.htm">JavaScript API 二</a></p>
<p><a href="https://www.dazhuanlan.com/workant/topics/1230751">非越狱环境使用Frida</a>   </p>
<p><a href="https://www.jianshu.com/p/86c1ca71e73a">Frida集成到iOS项目</a></p>
<p><a href="https://codeshare.frida.re/">https://codeshare.frida.re/</a> 中其它共享的脚本， <code>$ frida --codeshare 脚本路径 -f YOUR_BINARY </code> 将其加载进来</p>
<p>Frida 跨平台的轻量级 Hook 框架，基于Python和JavaScript</p>
<p>使用 Frida 可以获取进程详细信息、拦截和调用指定函数、注入代码、修改参数、从iOS应用程序中dump类和类方法信息等</p>
<h4 id="Frida-安装"><a href="#Frida-安装" class="headerlink" title="Frida 安装"></a>Frida 安装</h4><ul>
<li>iOS 端</li>
</ul>
<p>Cydia 添加源 <a href="https://build.frida.re/">https://build.frida.re/</a> 安装 Frida for A12+ devices，最新版本 14.2.13</p>
<ul>
<li>macOS 端</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ sudo pip3 install frida</span><br><span class="line">$ sudo pip3 install frida-tools</span><br><span class="line">$ frida --version</span><br><span class="line">#升级</span><br><span class="line">$ sudo pip3 install frida --upgrade</span><br><span class="line">$ sudo pip3 install frida-tools --upgrade</span><br><span class="line"></span><br><span class="line">frida                 15.1.3</span><br><span class="line">frida-tools           10.6.2</span><br></pre></td></tr></table></figure>

<h4 id="Frida"><a href="#Frida" class="headerlink" title="Frida"></a>Frida</h4><p>frada-tools 里面还提供了五个使用工具：frida-discover、frida-kill、friaa-ls-devices、frida-ps 以及 frida-trace</p>
<p><code>.bash_profile</code> 添加环境变量</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">export frida-discover&#x3D;&#39;&#x2F;Library&#x2F;Frameworks&#x2F;Python.framework&#x2F;Versions&#x2F;3.8&#x2F;bin&#x2F;frida-discover&#39;</span><br><span class="line">export frida-kill&#x3D;&#39;&#x2F;Library&#x2F;Frameworks&#x2F;Python.framework&#x2F;Versions&#x2F;3.8&#x2F;bin&#x2F;frida-kill&#39;</span><br><span class="line">export frida-trace&#x3D;&#39;&#x2F;Library&#x2F;Frameworks&#x2F;Python.framework&#x2F;Versions&#x2F;3.8&#x2F;bin&#x2F;frida-trace&#39;</span><br><span class="line">export frida-ps&#x3D;&#39;&#x2F;Library&#x2F;Frameworks&#x2F;Python.framework&#x2F;Versions&#x2F;3.8&#x2F;bin&#x2F;frida-ps&#39;</span><br><span class="line">export frida-ls-devices&#x3D;&#39;&#x2F;Library&#x2F;Frameworks&#x2F;Python.framework&#x2F;Versions&#x2F;3.8&#x2F;bin&#x2F;frida-ls-devices&#39;</span><br></pre></td></tr></table></figure>



<p>这些工具都是基于 Frida 的 Python 接口实现的</p>
<p>使用帮助 <a href="https://frida.re/docs/home/">https://frida.re/docs/home/</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ which frida</span><br><span class="line">&#x2F;Library&#x2F;Frameworks&#x2F;Python.framework&#x2F;Versions&#x2F;3.8&#x2F;bin&#x2F;frida</span><br></pre></td></tr></table></figure>

<h5 id="获取可用设备列表"><a href="#获取可用设备列表" class="headerlink" title="获取可用设备列表"></a>获取可用设备列表</h5><p>frida-ls-devices 获取到 id 之后就可以在 frida-ps 等工具中使用了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># &#x2F;Library&#x2F;Frameworks&#x2F;Python.framework&#x2F;Versions&#x2F;3.8&#x2F;bin 目录</span><br><span class="line">$ frida-ls-devices</span><br><span class="line">Id                                        Type    Name</span><br><span class="line">----------------------------------------  ------  ------------</span><br><span class="line">local                                     local   Local System</span><br><span class="line">4ce52917e9a0932f3c821e2418a03d2a993c5650  usb     iPhone</span><br><span class="line">socket                                    remote  Local Socket</span><br></pre></td></tr></table></figure>

<h5 id="获取设备进程列表"><a href="#获取设备进程列表" class="headerlink" title="获取设备进程列表"></a>获取设备进程列表</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ frida-ps --help</span><br><span class="line">-U	连接到USB设备</span><br><span class="line">-D  如果有多个USB设备，可以用该选项指定设备UDID</span><br><span class="line">-R&#x2F;-H 连接到远程frida-server,主要用于远程调试</span><br><span class="line">-a  仅显示正在运行的应用</span><br><span class="line">-i  显示所有已安装的应用</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#连接到设备查看进程列表</span><br><span class="line">$ frida-ps -U </span><br><span class="line"> 845      ASPCarryLog</span><br><span class="line">1032      AppNotification</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">#连接到设备查看正在运行的应用</span><br><span class="line">$ frida-ps -U -a</span><br><span class="line">或者</span><br><span class="line">$ frida-ps -Ua</span><br><span class="line"></span><br><span class="line">#指定查看某个设备</span><br><span class="line">$ frida-ps -D 00008030-001C19C12281802E</span><br></pre></td></tr></table></figure>

<h5 id="结束设备上某个进程"><a href="#结束设备上某个进程" class="headerlink" title="结束设备上某个进程"></a>结束设备上某个进程</h5><p>frida-kill</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ frida-kill -U &lt;PID&gt;&#x2F;&lt;Name&gt;</span><br><span class="line">$ frida-kill -D &lt;DEVICE-ID&gt; &lt;PID&gt;&#x2F;&lt;Name&gt;</span><br><span class="line"></span><br><span class="line">$ frida-kill -U 2441</span><br><span class="line">$ frida-kill -U 微信</span><br></pre></td></tr></table></figure>

<h4 id="跟踪函数-方法调用-frida-trace"><a href="#跟踪函数-方法调用-frida-trace" class="headerlink" title="跟踪函数/方法调用 frida-trace"></a>跟踪函数/方法调用 frida-trace</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ frida-trace -h</span><br></pre></td></tr></table></figure>

<h5 id="跟踪函数调用"><a href="#跟踪函数调用" class="headerlink" title="跟踪函数调用"></a>跟踪函数调用</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ frida-trace -U -i compress -i &quot;recv*&quot; -x &quot;recvmsg*&quot; -x recvfrom 微信</span><br><span class="line"></span><br><span class="line">跟踪名为compress的函数和recv开头的函数</span><br><span class="line">排除recvmsg开头的函数和名为recvfrom的函数，模糊匹配内容要用双引号</span><br><span class="line"></span><br><span class="line">-i 表示包含某个函数</span><br><span class="line">-x 表示排查某个函数，都支持模糊匹配，可以组合使用</span><br><span class="line">命令执行后会生成基本JS文件，仅输出一些日志，开发者可以根据需要修改它们</span><br></pre></td></tr></table></figure>

<p>上面是附加到目标进程再操作，如果要强制启动进程进行跟踪，可以使用 -f 选项加上 BundleID</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ frida-trace -U -f com.tencent.xin -i compress -i &quot;recv*&quot; -x &quot;recvmsg*&quot; -x recvfrom</span><br></pre></td></tr></table></figure>

<p>跟踪后，在当前目录会生成一个<code> __handlers__</code> 文件夹，里面就是 frida-trace 自动生成的 js 脚本文件</p>
<img src="逆向-Frida/frida-trace.png" alt="frida-trace" style="zoom:80%;" />

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//跟踪函数调用后会生成对应跟踪函数的 js 文件</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="title">onEnter</span>(<span class="params">log, args, state</span>)</span> &#123;</span><br><span class="line">    log(<span class="string">`+[LCdes encryptUseDES:<span class="subst">$&#123;args[<span class="number">2</span>]&#125;</span> key:<span class="subst">$&#123;args[<span class="number">3</span>]&#125;</span>]`</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">onLeave</span>(<span class="params">log, retval, state</span>)</span> &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>frida-trace 启动时不会覆盖已有脚本文件，所以可以随时修改这些 JS 文件来添加自己的功能</p>
<h5 id="跟踪OC方法调用"><a href="#跟踪OC方法调用" class="headerlink" title="跟踪OC方法调用"></a>跟踪OC方法调用</h5><p>-m 表示包含某个方法</p>
<p>-M 表示排除某个方法，支持模糊匹配，可以组合使用</p>
<img src="逆向-Frida/图片 2.png" alt="图片 2" style="zoom:80%;" />

<h5 id="跟踪导出函数"><a href="#跟踪导出函数" class="headerlink" title="跟踪导出函数"></a>跟踪导出函数</h5><p>-I 表示包含某个模块</p>
<p>-X 表示排除某个模块，支持模糊匹配，可以混合使用</p>
<p>![图片 3](逆向-Frida/图片 3.png)</p>
<h5 id="跟踪导入函数"><a href="#跟踪导入函数" class="headerlink" title="跟踪导入函数"></a>跟踪导入函数</h5><p>-t 表示包含某个模块</p>
<p>-T 表示包含主程序</p>
<p>![图片 4](逆向-Frida/图片 4.png)</p>
<h5 id="跟踪偏移地址"><a href="#跟踪偏移地址" class="headerlink" title="跟踪偏移地址"></a>跟踪偏移地址</h5><p>-a 添加模块内偏移地址的监控，”MODULE!OFFSET“</p>
<p>由于 macOS 终端会把 ！转义，所以需要输入 <code>\!</code> 才能正常使用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#对Aweme模块中偏移地址为0x2A65CCC的函数进行追踪</span><br><span class="line">$ frida-trace -U -f com.ss.iphone.ugc.Aweme -a Aweme\!2A65CCC</span><br></pre></td></tr></table></figure>

<h5 id="跟踪调用栈"><a href="#跟踪调用栈" class="headerlink" title="跟踪调用栈"></a>跟踪调用栈</h5><p>利用 Frida 可以非常方便跟踪某个方法的调用栈，只需要在 JS 里面添加下面代码</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">log(<span class="string">&#x27;\tBacktrace:\n\t&#x27;</span> + Thread.backtrace(<span class="built_in">this</span>.context, Backtracer.ACCURATE).map(DebugSymbol.fromAddress).join(<span class="string">&#x27;\n\t&#x27;</span>));</span><br></pre></td></tr></table></figure>

<h4 id="进入交互模式"><a href="#进入交互模式" class="headerlink" title="进入交互模式"></a>进入交互模式</h4><p>进入交互模式两种方法</p>
<ul>
<li>通过应用名或PID附加</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ frida -U 微信</span><br><span class="line">$ frida -U -p PID</span><br></pre></td></tr></table></figure>

<ul>
<li>直接启动进程</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ frida -U -f com.tencent.xin</span><br><span class="line">#或者不中断应用程序启动</span><br><span class="line">$ frida -U -f com.tencent.xin --no-pause</span><br></pre></td></tr></table></figure>

<p>进入交互模式后就可以访问目标进程的所有属性、方法</p>
<h4 id="Frida使用"><a href="#Frida使用" class="headerlink" title="Frida使用"></a>Frida使用</h4><h5 id="加载脚本"><a href="#加载脚本" class="headerlink" title="加载脚本"></a>加载脚本</h5><p>越狱英文名 JailBroke 或 JailBreak，使用关键词 jail 对当前进程的所有类及方法进行检索。</p>
<p>Frida 提供的 JavaScript API 里面，由 <code>ObjC.classes</code> 能得到当前应用中所有已经注册的类，对它进行遍历就可以得到符合要求的类名</p>
<p>写一段JS代码</p>
<p><code>ObjC.classes.XXXClass.$methods</code> 就可以得到 XXXClass 类的所有方法。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//筛选符合要求的类及方法</span></span><br><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">var</span> className <span class="keyword">in</span> ObjC.classes) &#123;</span><br><span class="line">		<span class="keyword">if</span> (className.toLowerCase().indexOf(<span class="string">&#x27;jail&#x27;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;[#]ClassName--------&gt;&#x27;</span> + className)</span><br><span class="line"></span><br><span class="line">			<span class="keyword">var</span> methods = <span class="built_in">eval</span>(<span class="string">&#x27;ObjC.classes.&#x27;</span> + className + <span class="string">&#x27;.$methods&#x27;</span>) <span class="comment">//类中所有方法</span></span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; methods.length; i++) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="keyword">if</span> (methods[i].toLowerCase().indexOf(<span class="string">&#x27;jail&#x27;</span>) != -<span class="number">1</span>) &#123;</span><br><span class="line">						<span class="built_in">console</span>.log(<span class="string">&#x27;[-]&#x27;</span> + methods[i])</span><br><span class="line">					&#125;</span><br><span class="line">				&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">					<span class="built_in">console</span>.log(<span class="string">&#x27;[!] Exception:&#x27;</span> + err.message)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>两种方法加载。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#-l 选项加载脚本</span><br><span class="line">$ frida -U -l WeChat.js 微信</span><br><span class="line"></span><br><span class="line">#或者</span><br><span class="line">#进入交互界面后使用%load 手动加载脚本</span><br><span class="line">[iPhone::微信]-&gt; %load path&#x2F;to&#x2F;WeChat.js</span><br><span class="line"></span><br><span class="line">#结果</span><br><span class="line">Attaching...</span><br><span class="line">[#]ClassName--------&gt;JailBreakHelper</span><br><span class="line">[-]+ getJailbreakRootDir</span><br><span class="line">[-]+ getJailbreakPath</span><br><span class="line">[-]+ JailBroken</span><br><span class="line">[-]- IsJailBreak</span><br><span class="line">[-]- HasInstallJailbreakPlugin:</span><br></pre></td></tr></table></figure>

<p>从输出信息可以看到一个 JailBreakHelper 类</p>
<h5 id="拦截函数参数返回值"><a href="#拦截函数参数返回值" class="headerlink" title="拦截函数参数返回值"></a>拦截函数参数返回值</h5><p>Frida 提供的 JavaScript API 里面有一个 <code>Interceptor</code> 拦截器，将它附加到某个函数后，可以在调用前和调用后分别进行拦截，以获取函数的参数和返回值</p>
<p>编写脚本</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjC.available) &#123; <span class="comment">//判断Object-C类方法是否已经加载进来</span></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">var</span> className = <span class="string">&#x27;JailBreakHelper&#x27;</span>;</span><br><span class="line">		<span class="keyword">var</span> methodNames = [<span class="string">&#x27;+ JailBroken&#x27;</span>, <span class="string">&#x27;- IsJailBreak&#x27;</span>];</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">var</span> index <span class="keyword">in</span> methodNames) &#123;</span><br><span class="line">			<span class="keyword">var</span> methodName = methodNames[index];</span><br><span class="line">			<span class="keyword">var</span> hook = <span class="built_in">eval</span>(<span class="string">&#x27;ObjC.classes.&#x27;</span> + className + <span class="string">&#x27;[&quot;&#x27;</span> + methodName + <span class="string">&#x27;&quot;]&#x27;</span>);</span><br><span class="line">			<span class="comment">//或者 var hook = ObjC.classes[class_name][method_name] 比较清楚</span></span><br><span class="line">      </span><br><span class="line">			Interceptor.attach(hook.implementation,&#123;</span><br><span class="line">				onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">					<span class="built_in">console</span>.log(<span class="string">&#x27;===onEnter===&#x27;</span>);</span><br><span class="line">					<span class="built_in">console</span>.log(<span class="string">&#x27;className:&#x27;</span> + className);</span><br><span class="line">					<span class="built_in">console</span>.log(<span class="string">&#x27;Method Name:&#x27;</span> + methodName);</span><br><span class="line">					<span class="built_in">console</span>.log(<span class="string">&#x27;======&#x27;</span>);</span><br><span class="line">				&#125;,</span><br><span class="line">				onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>) </span>&#123;</span><br><span class="line">					<span class="built_in">console</span>.log(<span class="string">&#x27;===onLeave===&#x27;</span>);</span><br><span class="line">					<span class="built_in">console</span>.log(<span class="string">&#x27;className:&#x27;</span> + className);</span><br><span class="line">					<span class="built_in">console</span>.log(<span class="string">&#x27;Method Name:&#x27;</span> + methodName);</span><br><span class="line">					<span class="built_in">console</span>.log(<span class="string">&#x27;\t[-] Return Value:&#x27;</span> + retval);</span><br><span class="line">					<span class="built_in">console</span>.log(<span class="string">&#x27;======&#x27;</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;[!] Exception:&#x27;</span> + err.message);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击微信的支付处方方法，打印结果</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x3D;&#x3D;&#x3D;onEnter&#x3D;&#x3D;&#x3D;</span><br><span class="line">className:JailBreakHelper</span><br><span class="line">Method Name:- IsJailBreak</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">&#x3D;&#x3D;&#x3D;onLeave&#x3D;&#x3D;&#x3D;</span><br><span class="line">className:JailBreakHelper</span><br><span class="line">Method Name:- IsJailBreak</span><br><span class="line">        [-] Return Value:0x1</span><br></pre></td></tr></table></figure>

<p>onEnter 和 onLeave 是两个回调函数，分别处理原始方法调用前和后的逻辑。</p>
<p>Frida 支持脚本热更新，当 JS 文件被修改并保存后，能够实时生效</p>
<p>修改脚本将返回值改成NO</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		Interceptor.attach(ObjC.classes.JailBreakHelper[<span class="string">&#x27;- IsJailBreak&#x27;</span>].implementation, &#123;</span><br><span class="line">			onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>) </span>&#123;</span><br><span class="line">				<span class="built_in">console</span>.log(<span class="string">&#x27;return = NO&#x27;</span>);</span><br><span class="line">				retval.replace(ptr(<span class="number">0x0</span>));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;[!] Exception:&#x27;</span> + err.message);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="JS脚本"><a href="#JS脚本" class="headerlink" title="JS脚本"></a>JS脚本</h4><h5 id="打印参数"><a href="#打印参数" class="headerlink" title="打印参数"></a>打印参数</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;0--: &#x27;</span> + ObjC.Object(args[<span class="number">0</span>]).toString())</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;arg[2] -&gt;&quot;</span> + <span class="keyword">new</span> ObjC.Object(args[<span class="number">2</span>]))</span><br></pre></td></tr></table></figure>

<p>如果变量类型不确定，可以使用如下代码确定类型</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">&quot;Type of args[2] -&gt; &quot;</span> + <span class="keyword">new</span> ObjC.Object(args[<span class="number">2</span>]).$className)</span><br></pre></td></tr></table></figure>

<h5 id="常用数据类型转换"><a href="#常用数据类型转换" class="headerlink" title="常用数据类型转换"></a>常用数据类型转换</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//NSData转String</span></span><br><span class="line"><span class="keyword">var</span> data = <span class="keyword">new</span> ObjC.Object(args[<span class="number">2</span>]);</span><br><span class="line">Memory.readUtf8String(data.bytes(), data.length());</span><br><span class="line"></span><br><span class="line"><span class="comment">//NSData转二进制数据</span></span><br><span class="line"><span class="keyword">var</span> data = <span class="keyword">new</span> ObjC.Object(args[<span class="number">2</span>]);</span><br><span class="line">Memory.readByteArray(data.bytes(), data.length());</span><br><span class="line"></span><br><span class="line"><span class="comment">//遍历NSArray</span></span><br><span class="line"><span class="keyword">var</span> array = <span class="keyword">new</span> ObjC.Object(args[<span class="number">2</span>]);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Be sure to use valueOf() as NSUInteger is a Number in</span></span><br><span class="line"><span class="comment"> * 32-bit processes, and UInt64 in 64-bit processes. This</span></span><br><span class="line"><span class="comment"> * coerces it into a Number in the latter case.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> count = array.count().valueOf();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i !== count; i++) &#123;</span><br><span class="line">  <span class="keyword">var</span> element = array.objectAtIndex_(i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//遍历NSDictionary</span></span><br><span class="line"><span class="keyword">var</span> dict = <span class="keyword">new</span> ObjC.Object(args[<span class="number">2</span>]);</span><br><span class="line"><span class="keyword">var</span> enumerator = dict.keyEnumerator();</span><br><span class="line"><span class="keyword">var</span> key;</span><br><span class="line"><span class="keyword">while</span> ((key = enumerator.nextObject()) !== <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> value = dict.objectForKey_(key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> param_dict = ObjC.classes.NSMutableDictionary.alloc().init();</span><br><span class="line">param_dict.setObject_forKey_(body,<span class="string">&quot;body&quot;</span>);</span><br><span class="line"></span><br><span class="line">NSArray *arr3 = [NSArray arrayWithObjects:@<span class="string">&quot;one&quot;</span>,@<span class="string">&quot;two&quot;</span>,@<span class="number">1</span>, nil];</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> param_Key_Array = ObjC.classes.NSMutableArray.arrayWithObject_(sBody);</span><br><span class="line">param_Key_Array.addObject_(sClient);</span><br><span class="line">param_Key_Array.addObject_(sClientVersion);</span><br><span class="line">param_Key_Array.addObject_(sFunctionId);</span><br><span class="line">param_Key_Array.addObject_(sOpenudid);</span><br><span class="line"></span><br><span class="line"><span class="comment">//读一个结构体</span></span><br><span class="line">Memory.readU32(args[<span class="number">0</span>].add(<span class="number">4</span>));</span><br></pre></td></tr></table></figure>

<h5 id="常用脚本"><a href="#常用脚本" class="headerlink" title="常用脚本"></a>常用脚本</h5><ul>
<li>枚举所有类</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> className <span class="keyword">in</span> ObjC.classes) &#123;</span><br><span class="line">  <span class="keyword">if</span> (ObjC.classes.hasOwnProperty(className)) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(className);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>枚举一个类的所有method</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> className = <span class="string">&quot;NSURL&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> methods = <span class="built_in">eval</span>(<span class="string">&#x27;ObjC.classes.&#x27;</span> + className + <span class="string">&#x27;.$methods&#x27;</span>); <span class="comment">//一个类的所有方法</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; methods.length; i++) &#123;</span><br><span class="line">            <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (methods[i].indexOf(<span class="string">&quot;fileURLWithPath&quot;</span>) &gt; -<span class="number">1</span>)</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;[-] &quot;</span>+methods[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="function"><span class="title">catch</span>(<span class="params">err</span>)</span> &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;[!] Exception1: &quot;</span> + err.message);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">catch</span>(<span class="params">err</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;[!] Exception2: &quot;</span> + err.message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>打印调用栈</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">log, args, state</span>) </span>&#123;</span><br><span class="line">    log(<span class="string">&#x27;\tBacktrace:\n\t&#x27;</span> + Thread.backtrace(<span class="built_in">this</span>.context,Backtracer.ACCURATE).map(DebugSymbol.fromAddress).join(<span class="string">&#x27;\n\t&#x27;</span>));</span><br><span class="line">  &#125;,</span><br><span class="line">  onLeave: <span class="function"><span class="keyword">function</span> (<span class="params">log, retval, state</span>) </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li>hook 一个method</li>
</ul>
<blockquote>
<p>打印参数注意</p>
<p>args[0]：self</p>
<p>args[1]：The selector (openURL:)</p>
<p>args[2]：The first param</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjC.available)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> className = <span class="string">&quot;JailbreakDetectionVC&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> funcName = <span class="string">&quot;- isJailbroken&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> hook = <span class="built_in">eval</span>(<span class="string">&#x27;ObjC.classes.&#x27;</span> + className + <span class="string">&#x27;[&quot;&#x27;</span> + funcName + <span class="string">&#x27;&quot;]&#x27;</span>);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;[*] Class Name: &quot;</span> + className);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;[*] Method Name: &quot;</span> + funcName);</span><br><span class="line">        Interceptor.attach(hook.implementation, &#123;</span><br><span class="line">          onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;aaaa&quot;</span>);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;param:&quot;</span>+args[<span class="number">2</span>]+<span class="string">&quot; type:&quot;</span>+<span class="keyword">typeof</span> args[<span class="number">2</span>]);</span><br><span class="line">          &#125;,</span><br><span class="line">          onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;Return value-&gt; (type:&quot;</span>+<span class="keyword">typeof</span> retval+<span class="string">&quot;,value:&quot;</span>+retval+<span class="string">&quot;)&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//修改返回值</span></span><br><span class="line">            newretval = ptr(<span class="string">&quot;0x0&quot;</span>)</span><br><span class="line">            retval.replace(newretval)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span>(err)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;[!] Exception2: &quot;</span> + err.message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="调用函数"><a href="#调用函数" class="headerlink" title="调用函数"></a>调用函数</h5><ul>
<li>函数名以”+”开头的，如：“+ URLWithString:”，可以直接通过类名调用方法，相当于java中的static函数</li>
</ul>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">ObjC.classes.NSString.stringWithString_(<span class="string">&quot;MacOS&quot;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>函数名以“-”开头的需要找到一个实例化的对象，然后再调用方法</li>
</ul>
<p>1、如果内存中没有这样的对象<br>这种情况需要手动生成一个实例,用法为ObjC.classes.类名.alloc()</p>
<p>2、如果内存中存在实例化后的对象<br>这种情况需要先找出一个类的实例,使用var tmp=ObjC.chooseSync(ObjC.classes.类名),例如：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">ObjC.chooseSync(ObjC.classes.PARSHealthPedometer10thHomeViewController)[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>

<p>其中[0]表示取找到的实例中的第一个实例,可根据实际情况换成其他的实例。<br>调用函数时，以my_obj <code>- requestUploadWithSure</code> 的函数，如果有参数直接附在括号中</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//var my_obj=ObjC.chooseSync(ObjC.classes.PARSHealthPedometer10thHomeViewController)[0]</span></span><br><span class="line">        <span class="keyword">var</span> my_obj=ObjC.classes.PARSHealthPedometer10thHomeViewController.alloc()</span><br><span class="line">        my_obj[<span class="string">&quot;- requestUploadWithSure:&quot;</span>](<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="title">catch</span>(<span class="params">err</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;[!] Exception2: &quot;</span> + err.message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;Objective-C Runtime is not available!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">console.log(<span class="string">&quot;init success&quot;</span>);</span><br><span class="line">function SendTextMessage(wxid, msg) &#123;</span><br><span class="line">    var message = ObjC.chooseSync(ObjC.classes.MessageService)[<span class="number">0</span>]</span><br><span class="line">    var username = ObjC.classes.CUtility.GetCurrentUserName();</span><br><span class="line">    console.log(username)</span><br><span class="line">    console.log(<span class="string">&quot;Type of arg[0] -&gt; &quot;</span> + message)</span><br><span class="line">    var toUsrName = ObjC.classes.NSString.stringWithString_(wxid);</span><br><span class="line">    var msgText = ObjC.classes.NSString.stringWithString_(msg);</span><br><span class="line">    message[<span class="string">&quot;- SendTextMessage:toUsrName:msgText:atUserList:&quot;</span>](username, toUsrName, msgText, null);</span><br><span class="line">&#125;</span><br><span class="line">SendTextMessage(<span class="string">&quot;filehelper&quot;</span>,<span class="string">&quot;主动调用发送信息！&quot;</span>)</span><br></pre></td></tr></table></figure>







<h4 id="Python-交互"><a href="#Python-交互" class="headerlink" title="Python 交互"></a>Python 交互</h4><p>Frida 提供了 Python 和 JS 脚本的交互</p>
<h5 id="获取设备"><a href="#获取设备" class="headerlink" title="获取设备"></a>获取设备</h5><p>DeviceManager 类获取设备信息</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 获取设备管理器</span></span><br><span class="line">    deviceManager = frida.get_device_manager()</span><br><span class="line">    <span class="comment"># 枚举所有连接的设备</span></span><br><span class="line">    print(deviceManager.enumerate_devices())</span><br><span class="line">    <span class="comment"># 根据UDID获取设备</span></span><br><span class="line">    print(deviceManager.get_device(<span class="string">&#x27;00008030-001C19C12281802E&#x27;</span>))</span><br><span class="line">    <span class="comment"># 获取当前连接设备</span></span><br><span class="line">    print(deviceManager.get_usb_device())</span><br><span class="line"></span><br><span class="line"><span class="comment">#输出 </span></span><br><span class="line"><span class="comment">#[Device(id=&quot;local&quot;, name=&quot;Local System&quot;, type=&#x27;local&#x27;), Device(id=&quot;socket&quot;, name=&quot;Local Socket&quot;, type=&#x27;remote&#x27;), Device(id=&quot;00008030-001C19C12281802E&quot;, name=&quot;iPhone&quot;, type=&#x27;usb&#x27;)]</span></span><br><span class="line"><span class="comment">#Device(id=&quot;00008030-001C19C12281802E&quot;, name=&quot;iPhone&quot;, type=&#x27;usb&#x27;)</span></span><br><span class="line"><span class="comment">#Device(id=&quot;00008030-001C19C12281802E&quot;, name=&quot;iPhone&quot;, type=&#x27;usb&#x27;)</span></span><br></pre></td></tr></table></figure>

<h5 id="附加进程"><a href="#附加进程" class="headerlink" title="附加进程"></a>附加进程</h5><p>attach() 附加目标进程，返回一个 Session 实例，参数支持进程名和PID</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">from</span> frida.core <span class="keyword">import</span> Device</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    device = frida.get_usb_device() <span class="comment"># type: Device</span></span><br><span class="line">    session = device.attach(<span class="string">u&#x27;微信&#x27;</span>)</span><br><span class="line">    print(session)</span><br><span class="line">    </span><br><span class="line"><span class="comment">#Session(pid=3608)</span></span><br></pre></td></tr></table></figure>

<h5 id="启动进程"><a href="#启动进程" class="headerlink" title="启动进程"></a>启动进程</h5><p>spawn() 启动进程，此时进程处于挂起状态，需要配合 resume() 才能唤醒，这时还可以使用 attach() 附加上去</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">from</span> frida.core <span class="keyword">import</span> Device</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    device = frida.get_usb_device() <span class="comment"># type: Device</span></span><br><span class="line">    pid = device.spawn(<span class="string">&#x27;com.tencent.xin&#x27;</span>)</span><br><span class="line">    <span class="comment">#session = device.attach(pid)</span></span><br><span class="line">    device.resume(pid)</span><br></pre></td></tr></table></figure>

<p>device.spawn()  允许带参数执行，下面代码传入 url 参数后会启动 Safari 并打开网站</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pid &#x3D; device.spawn(&#39;com.apple.mobilesafari&#39;, url&#x3D;&quot;https:&#x2F;&#x2F;www.chinapyg.com&quot;)</span><br></pre></td></tr></table></figure>

<h5 id="脱离进程"><a href="#脱离进程" class="headerlink" title="脱离进程"></a>脱离进程</h5><p>得到 Session 并操作完毕后，需要使用 detach() 脱离进程</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">session.detach()</span><br></pre></td></tr></table></figure>

<h5 id="注入JS脚本"><a href="#注入JS脚本" class="headerlink" title="注入JS脚本"></a>注入JS脚本</h5><p>得到Session就可以使用 create_script() 创建一个脚本对象，然后调用 load() 方法将脚本载入。此时 python 的任务完成，主要工作就交给 JS 了</p>
<ul>
<li>枚举指定进程的所有模块信息</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">from</span> frida.core <span class="keyword">import</span> Device</span><br><span class="line"><span class="keyword">from</span> frida.core <span class="keyword">import</span> Session</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">enumerateModules</span>(<span class="params">target_process</span>):</span></span><br><span class="line">    session = frida.get_usb_device().attach(target_process) <span class="comment"># type: Session</span></span><br><span class="line">    script = session.create_script(</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Process.enumerateModules(&#123;</span></span><br><span class="line"><span class="string">        onMatch: function(module) &#123;</span></span><br><span class="line"><span class="string">            console.log(&#x27;Module name:&#x27; + module.name + &#x27;-&#x27; + &#x27;Base Address:&#x27; + module.base);</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        onComplete: function() &#123;&#125;</span></span><br><span class="line"><span class="string">    &#125;)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    )</span><br><span class="line">    script.load()</span><br><span class="line">    session.detach()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    enumerateModules(<span class="string">&#x27;微信&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>可以将JS脚本嵌套在Python源文件中，也可以将JS保存到专门文件中再读取</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> codecs  </span><br><span class="line">...</span><br><span class="line"><span class="keyword">with</span> codecs.<span class="built_in">open</span>(<span class="string">&#x27;./WeChat.js&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">   source = f.read()</span><br><span class="line">script = session.create_script(source)</span><br></pre></td></tr></table></figure>

<ul>
<li>获取应用沙河路径</li>
</ul>
<img src="逆向-Frida/图片 6.png" alt="图片 6" style="zoom:80%;" />

<h6 id="Python与JS交互传值"><a href="#Python与JS交互传值" class="headerlink" title="Python与JS交互传值"></a>Python与JS交互传值</h6><ul>
<li>获取指定进程的指定模块信息</li>
</ul>
<p>上面JS脚本都是不需要传递参数，需要参数时，Python与JS如何交互</p>
<p>Script 类可以设置回调函数，用来处理JS端传来的消息；JS端设置 recv() 的回调来接收Python端的消息</p>
<img src="逆向-Frida/图片 7.png" alt="图片 7" style="zoom:40%;" />

<img src="逆向-Frida/图片 8.png" alt="图片 8" style="zoom:90%;" />

<img src="逆向-Frida/图片 9.png" alt="图片 9" style="zoom:80%;" />

<p>g_event是保证同步的，Python端使用script.post()将参数发送出去之后就调用g_event.wait()进入等待状态，当JS处理完成后，会将status设为“success”，再使用send()发送给Python端设置的on_message()回调，最终在payload_message()函数中完成逻辑处理，当识别到status为“success”后，调用g_event.set()使主线程继续执行</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//通用hook</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hookClassMethod</span>(<span class="params">classname, methodname, infotip</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">var</span> hooking = ObjC.classes[classname][methodname]</span><br><span class="line">			Interceptor.attach(hooking.implementation,&#123;</span><br><span class="line">			onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">				<span class="comment">//args[0]:self</span></span><br><span class="line">				<span class="comment">//args[1]:The selector</span></span><br><span class="line">				<span class="comment">//args[2]:方法的第一个参数开始</span></span><br><span class="line">				<span class="built_in">console</span>.log(<span class="string">&#x27;\n&#x27;</span> + infotip + <span class="string">&#x27; Hook Success&#x27;</span>)</span><br><span class="line">				<span class="built_in">this</span>.class_name  = ObjC.Object(args[<span class="number">0</span>]).toString()</span><br><span class="line">				<span class="built_in">this</span>.method_name = ObjC.selectorAsString(args[<span class="number">1</span>])</span><br><span class="line">				<span class="built_in">console</span>.log(<span class="string">&#x27;\t[-] &#x27;</span> + <span class="string">&#x27;onEnter args[0] class_name: &#x27;</span> + <span class="built_in">this</span>.class_name)</span><br><span class="line">				<span class="built_in">console</span>.log(<span class="string">&#x27;\t[-] &#x27;</span> + <span class="string">&#x27;onEnter args[1] method_name: &#x27;</span> + <span class="built_in">this</span>.method_name)</span><br><span class="line">			&#125;,</span><br><span class="line">			onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;</span><br><span class="line">				<span class="built_in">console</span>.log(<span class="string">&#x27;\t[-]Return value: &#x27;</span>)</span><br><span class="line">				<span class="comment">//返回值类型</span></span><br><span class="line">				<span class="keyword">var</span> typeValue = <span class="built_in">Object</span>.prototype.toString.call(retval)</span><br><span class="line">				<span class="built_in">console</span>.log(<span class="string">&#x27;\t[-] Type of return value: &#x27;</span> + typeValue)</span><br><span class="line">				<span class="built_in">console</span>.log(<span class="string">&#x27;\t[-] Return value: &#x27;</span>, retval)</span><br><span class="line">				<span class="built_in">console</span>.log(<span class="string">&#x27;\t[-] &#x27;</span> + <span class="string">&#x27;返回值: &#x27;</span> + ObjC.Object(retval).toString())</span><br><span class="line"></span><br><span class="line">                send(&#123;<span class="attr">msg</span>: ObjC.Object(retval).toString()&#125;)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;<span class="function"><span class="title">catch</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&quot;\t[!] &quot;</span> + infotip + <span class="string">&quot; Exception: &quot;</span> + err.message);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handle_py_message</span>(<span class="params">message</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;接收到python发送的消息&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> (message[<span class="string">&#x27;cmd&#x27;</span>] == <span class="string">&#x27;cmd111&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">//根据cmd调用js方法</span></span><br><span class="line">        <span class="built_in">console</span>.log(message[<span class="string">&#x27;cmd&#x27;</span>])</span><br><span class="line">    &#125;</span><br><span class="line">    send(&#123;<span class="attr">status</span>: <span class="string">&#x27;success&#x27;</span>&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ObjC.available) &#123; <span class="comment">//OC类加载完成</span></span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;\n[*] Starting Hooking&#x27;</span>)</span><br><span class="line">	hookClassMethod(<span class="string">&#x27;SGSCorpusPageView&#x27;</span>, <span class="string">&#x27;- pageDataList&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>)</span><br><span class="line">	recv(handle_py_message)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">bundle = <span class="string">&#x27;com.sogou.sogouinput&#x27;</span></span><br><span class="line"></span><br><span class="line">g_event = threading.Event()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">payload_message</span>(<span class="params">payload</span>):</span></span><br><span class="line">	<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">	处理消息逻辑</span></span><br><span class="line"><span class="string">	:param payload:</span></span><br><span class="line"><span class="string">	:return:</span></span><br><span class="line"><span class="string">	&#x27;&#x27;&#x27;</span></span><br><span class="line">	<span class="keyword">if</span> <span class="string">&#x27;msg&#x27;</span> <span class="keyword">in</span> payload:</span><br><span class="line">		print(payload[<span class="string">&#x27;msg&#x27;</span>])</span><br><span class="line">	<span class="keyword">if</span> <span class="string">&#x27;status&#x27;</span> <span class="keyword">in</span> payload:</span><br><span class="line">		<span class="keyword">if</span> payload[<span class="string">&#x27;status&#x27;</span>] == <span class="string">&#x27;success&#x27;</span>:</span><br><span class="line">			<span class="comment">#调用g_event.set()使主线程继续执行</span></span><br><span class="line">			g_event.<span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_js_message</span>(<span class="params">message, data</span>):</span></span><br><span class="line">	<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">	接收到JS消息</span></span><br><span class="line"><span class="string">	&#123;&#x27;type&#x27;: &#x27;send&#x27;, &#x27;payload&#x27;: &#123;&#x27;status&#x27;: &#x27;success&#x27;&#125;&#125;</span></span><br><span class="line"><span class="string">	:param message:</span></span><br><span class="line"><span class="string">	:return:</span></span><br><span class="line"><span class="string">	&#x27;&#x27;&#x27;</span></span><br><span class="line">	<span class="comment"># print(message)</span></span><br><span class="line">	<span class="comment"># print(data)</span></span><br><span class="line">	<span class="keyword">if</span> message[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;send&#x27;</span>:</span><br><span class="line">		payload_message(message[<span class="string">&#x27;payload&#x27;</span>])</span><br><span class="line">	<span class="keyword">elif</span> message[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;error&#x27;</span>:</span><br><span class="line">		print(message[<span class="string">&#x27;stack&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> codecs.<span class="built_in">open</span>(<span class="string">&#x27;sougou.js&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    source = f.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	device = frida.get_usb_device(<span class="number">1000</span>) <span class="comment">#连接usb设备 1000表示超时</span></span><br><span class="line">	pid = device.spawn(bundle) <span class="comment">#启动指定bundleId的app</span></span><br><span class="line">	session = device.attach(pid)  <span class="comment">#附加到app</span></span><br><span class="line">	<span class="comment"># 创建frida javaScript脚本</span></span><br><span class="line">	script = session.create_script(source) <span class="comment"># type: frida.core.Script</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">#参数：信号single 回调callback， single固定message</span></span><br><span class="line">	script.on(<span class="string">&#x27;message&#x27;</span>, handle_js_message)</span><br><span class="line">	script.load() <span class="comment">#load脚本到app进程中 这样即注入成功</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">#发送消息</span></span><br><span class="line">	script.post(&#123;<span class="string">&#x27;cmd&#x27;</span>: <span class="string">&#x27;cmd111&#x27;</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;nameValue&#x27;</span>&#125;)</span><br><span class="line">	<span class="comment">#消息发送给JS后，调用g_event.wait进入等待 当JS处理完成后，会将status设为“success”</span></span><br><span class="line">	g_event.wait()</span><br><span class="line"></span><br><span class="line">	device.resume(pid) <span class="comment">#恢复app运行</span></span><br><span class="line">	sys.stdin.read()<span class="comment">#读取打印日志</span></span><br></pre></td></tr></table></figure>





<h6 id="JS脚本-1"><a href="#JS脚本-1" class="headerlink" title="JS脚本"></a>JS脚本</h6><p>hook.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;hello world&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>hook.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"></span><br><span class="line">bundle = <span class="string">&#x27;com.CMake&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    device = frida.get_usb_device()</span><br><span class="line">    pid = device.spawn(bundle) <span class="comment">#启动指定bundleid进程</span></span><br><span class="line">    session = device.attach(pid) <span class="comment">#附加app</span></span><br><span class="line">    <span class="keyword">with</span> codecs.<span class="built_in">open</span>(<span class="string">&#x27;./hook.js&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        source = f.read() <span class="comment">#读取脚本文件</span></span><br><span class="line">    script = session.create_script(source) <span class="comment">#创建 frida JavaScript脚本</span></span><br><span class="line">    script.load() <span class="comment">#加载脚本</span></span><br><span class="line">    device.resume(pid) <span class="comment">#唤醒回复app运行</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">#云行后打印 hello world</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>可以用来代替 vmmap 来获取加载基地址</p>
</blockquote>
<h6 id="拦截某个类的所有方法"><a href="#拦截某个类的所有方法" class="headerlink" title="拦截某个类的所有方法"></a>拦截某个类的所有方法</h6><p>API里提供了ApiResolver接口，能够根据正则表达式获取符合条件的所有方法</p>
<p>获取微信红包相关的 WCRedEnvelopesLogicMgr 类的所有方法，JS代码</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> resolver = <span class="keyword">new</span> ApiResolver(<span class="string">&#x27;objc&#x27;</span>);<span class="comment">//创建已加载OC类方法的API查找器</span></span><br><span class="line"><span class="keyword">var</span> matches = resolver.enumerateMatches(<span class="string">&#x27;*[WCRedEnvelopesLogicMgr *]&#x27;</span>, &#123;</span><br><span class="line">  onMatch: <span class="function"><span class="keyword">function</span>(<span class="params">match</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(match[<span class="string">&#x27;name&#x27;</span>] + <span class="string">&#x27;:&#x27;</span> + match[<span class="string">&#x27;address&#x27;</span>]);</span><br><span class="line">  &#125;,</span><br><span class="line">  onComplete: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//再attach</span></span><br><span class="line">Interceptor.attach(ptr(matches[<span class="number">0</span>][<span class="string">&#x27;address&#x27;</span>]), &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>eg: 绕过AFNetworking证书校验</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> resolver = <span class="keyword">new</span> ApiResolver(<span class="string">&#x27;objc&#x27;</span>);<span class="comment">//创建已加载Object-C类方法的API查找器</span></span><br><span class="line">	<span class="keyword">var</span> matches = resolver.enumerateMatchesSync(<span class="string">&quot;-[AFSecurityPolicy evaluateServerTrust:forDomain:]&quot;</span>);<span class="comment">//查找evaluateServerTrust:forDomain函数，返回数组类型</span></span><br><span class="line">	<span class="keyword">if</span> (matches.lenght == <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&quot;\n[E] -[AFSecurityPolicy evaluateServerTrust:forDomain:] is not found!\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	Interceptor.attach(ptr(matches[<span class="number">0</span>][<span class="string">&quot;address&quot;</span>]),&#123;</span><br><span class="line">			onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>) </span>&#123;</span><br><span class="line">				<span class="built_in">console</span>.log(<span class="string">&quot;[I] -[AFSecurityPolicy evaluateServerTrust:forDomain:] hits!&quot;</span>);</span><br><span class="line">				retval.replace(<span class="number">1</span>);<span class="comment">//将返回值修改为1</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	);</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&quot;[I] -[AFSecurityPolicy evaluateServerTrust:forDomain:] is hooked!\n&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main();</span><br></pre></td></tr></table></figure>



<p>脚本执行后，将 WCRedEnvelopesLogicMgr 类的所有方法和内存地址都打印出来了</p>
<p>获取所有方法后，可以使用 Interceptor.attach() 对每个方法进行拦截，然后打印参数和返回值</p>
<img src="逆向-Frida/图片 10.png" alt="图片 10" style="zoom:80%;" />

<img src="逆向-Frida/图片 11.png" alt="图片 11" style="zoom:40%;" />

<p>将拦截器中将调用的方法、传入参数及返回值都打印出来，就可以分析调用顺序了</p>
<h6 id="拦截C函数"><a href="#拦截C函数" class="headerlink" title="拦截C函数"></a>拦截C函数</h6><p>逆向分析时会遇到 sub_xxx 的C函数，如果要获取参数除了动态调试，还可以用 Frida 来操作</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_rva</span>(<span class="params"><span class="built_in">module</span>, offset</span>) </span>&#123;</span><br><span class="line">	<span class="comment">//获取基地址</span></span><br><span class="line">	<span class="keyword">var</span> base_addr = Module.findBaseAddress(<span class="built_in">module</span>)</span><br><span class="line">	<span class="comment">//函数地址 = 基地址+偏移地址</span></span><br><span class="line">	<span class="keyword">var</span> target_addr = base_addr.add(offset) </span><br><span class="line">	<span class="keyword">if</span> (Process.arch == <span class="string">&#x27;arm&#x27;</span>) &#123; <span class="comment">//如果是32位地址+1</span></span><br><span class="line">		<span class="keyword">return</span> target_addr.add(<span class="number">1</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> target_addr</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//函数偏移地址 可以通过 IDA 查看</span></span><br><span class="line"><span class="keyword">var</span> target_addr = get_rva(<span class="string">&#x27;mars&#x27;</span>, <span class="number">0x23adf6</span>);</span><br><span class="line">Interceptor.attach(ptr(target_addr), &#123;</span><br><span class="line">  onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;mars::stn::MMTLsCtrlInfo::IsMMTLSEnabled=&#x27;</span> + Memory.readU8(args[<span class="number">0</span>].add(<span class="number">8</span>)));</span><br><span class="line">  &#125;,</span><br><span class="line">  onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>) </span>&#123;</span><br><span class="line">    retval.replace(ptr(<span class="number">0</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>0x23adf6 是C函数的偏移地址，args[0].add(8) 相当于ARM指令的 LDRB W0, [X0,#8] 也就是访问第一个成员变量</p>
<p>。。</p>
<h6 id="替换原方法"><a href="#替换原方法" class="headerlink" title="替换原方法"></a>替换原方法</h6><p>Interceptor.attach() 拦截目标后，可以打印参数、修改返回值，但无法阻止方法的执行</p>
<p>例如，某个类存在一个 update 方法</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)update:(<span class="keyword">id</span>)args;</span><br></pre></td></tr></table></figure>

<p>当需要准确知道是否因为这个方法的执行而导致页面发生了变化时，可以将原方法替换掉进行测试</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">update.implementation = ObjC.implement(update, <span class="function"><span class="keyword">function</span>(<span class="params">handle,selector,args</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> self = ObjC.Object(handle);</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;self:&#x27;</span> + self);</span><br><span class="line">	<span class="comment">//这样原始方法就不会被执行，也就达到了屏蔽的效果</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>如果要在某个时刻调回原方法</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//先获取原方法</span></span><br><span class="line"><span class="keyword">var</span> oldImp = update.implementation;</span><br><span class="line"><span class="comment">//需要的时候调用</span></span><br><span class="line">oldImp(handle,selector,args);</span><br></pre></td></tr></table></figure>

<p>对于C函数，操作稍微复杂些，需要使用NativeFunction定义原函数与新函数，然后使用 Interceptor.replace() 进行替换</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> dlopenPtr = Module.findExportByName(<span class="literal">null</span>, <span class="string">&#x27;dlopen&#x27;</span>)</span><br><span class="line"><span class="keyword">var</span> dlopen = <span class="keyword">new</span> NativeFunction(dlopenPtr, <span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>])</span><br><span class="line">Interceptor.replace(dlopenPtr, <span class="keyword">new</span> NativeCallBack(<span class="function"><span class="keyword">function</span>(<span class="params">path, mode</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//新函数逻辑</span></span><br><span class="line">  <span class="keyword">var</span> name = Memory.readUtf8String(path)</span><br><span class="line">  <span class="keyword">if</span> (name != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;name:&#x27;</span> + name)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//调用原函数</span></span><br><span class="line">  <span class="keyword">return</span> dlopen(path, mode)</span><br><span class="line">&#125;,<span class="string">&#x27;pointer&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]))</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h6 id="替换原方法-replace"><a href="#替换原方法-replace" class="headerlink" title="替换原方法 replace"></a>替换原方法 replace</h6><p>Interceptor.replace(target, replacement)</p>
<p>replacement 是 NativeCallback 类型</p>
<p>new NativeCallback(func, returnType, argTypes[,abi]) //函数 返回值 参数</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> target_addr = get_rva(<span class="string">&#x27;XinHuaShe&#x27;</span>, <span class="number">0xBF9A0</span>)</span><br><span class="line">	<span class="comment">//NativeCallback(func, returnType, argTypes[,abi])</span></span><br><span class="line">	<span class="comment">//或者不用参数</span></span><br><span class="line">	Interceptor.replace(ptr(target_addr), <span class="keyword">new</span> NativeCallback(<span class="function"><span class="keyword">function</span>(<span class="params">argc, argv</span>)</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;hook sub_ptrace bypass&#x27;</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">	&#125;, int, [int, int]))</span><br></pre></td></tr></table></figure>

<h6 id="替换原方法-1"><a href="#替换原方法-1" class="headerlink" title="替换原方法"></a>替换原方法</h6><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//didTap 需要传递两个参数 ObjC.implement回调中也需要两个参数</span></span><br><span class="line"><span class="keyword">var</span> didTap = ObjC.classes.T1TranslateButton[<span class="string">&#x27;- _didTap:forEvent:&#x27;</span>]</span><br><span class="line"><span class="keyword">var</span> didTapOldImp = didTap.implementation</span><br><span class="line"></span><br><span class="line"><span class="comment">// 覆盖实现</span></span><br><span class="line">didTap.implementation = ObjC.implement(setTitle, <span class="function"><span class="keyword">function</span>(<span class="params">handle, selector, arg1, arg2</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> self = ObjC.Object(handle)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;self -- &quot;</span>, self) </span><br><span class="line"></span><br><span class="line">  <span class="comment">// 调用旧实现</span></span><br><span class="line">  <span class="comment">// didTapOldImp(handle, selector, arg1, arg2)</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>





<h5 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Module模块</span><br><span class="line">Module.findExportByName(moduleName|null, exportName)</span><br><span class="line">	moduleName：lib名字</span><br><span class="line">	exportName：函数名字</span><br><span class="line">	返回exportName的地址</span><br><span class="line">Module.findBaseAddress(moduleName)</span><br><span class="line">	moduleName：lib名字</span><br><span class="line">	返回lib的基地址</span><br><span class="line"></span><br><span class="line">Process模块</span><br><span class="line">Process.findModuleByAddress(address)</span><br><span class="line">	address：lib的指针地址</span><br><span class="line">	返回一个Module对象</span><br><span class="line"></span><br><span class="line">Momery模块</span><br><span class="line">Memory.readCString(pointer)</span><br><span class="line">	pointer:指针地址</span><br><span class="line">	把pointer还原成字符串</span><br><span class="line">Memory.readUtf8String(pointer);</span><br><span class="line">Memory.readAnsiString(pointer)</span><br><span class="line"></span><br><span class="line">Interceptor模块：监听</span><br><span class="line">.attach(target, callbacks)</span><br><span class="line">	target:指针地址</span><br><span class="line">	callbacks:回调函数</span><br><span class="line">		onEnter</span><br><span class="line">		onLeave</span><br><span class="line"></span><br><span class="line">使用objection</span><br><span class="line">ios hooking watchmethod“+[RSAencryptString:privateKey:]”–dump-args</span><br><span class="line">ios hooking watchmethod“+[RSAencryptString:privateKey:]”–dump-return</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><h5 id="加密参数打印"><a href="#加密参数打印" class="headerlink" title="加密参数打印"></a>加密参数打印</h5><p>下载工程 <a href="https://github.com/GuanlinORZ/friDemo">https://github.com/GuanlinORZ/friDemo</a> 或加代理下载 <a href="https://gh.fakev.cn/GuanlinORZ/friDemo">https://gh.fakev.cn/GuanlinORZ/friDemo</a></p>
<p>跟踪函数</p>
<p>分析 CCCrypt 函数的加密</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">CCCryptorStatus CCCrypt( </span><br><span class="line">  CCOperation op, <span class="comment">//kCCEncrypt为加密，kCCDecrypt为解密 </span></span><br><span class="line">  CCAlgorithm alg, <span class="comment">//加密方式 kCCAlgorithmAES128为AES加密</span></span><br><span class="line">  CCOptions options, <span class="comment">//增充方式</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">void</span> *key,   <span class="comment">//密钥</span></span><br><span class="line">  size_t keyLength,  <span class="comment">//密钥长度</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">void</span> *iv,    <span class="comment">// IV</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">void</span> *dataIn, <span class="comment">//待加密的原文</span></span><br><span class="line">  size_t dataInLength, <span class="comment">//原文长度</span></span><br><span class="line">  <span class="keyword">void</span> *dataOut,       <span class="comment">//加密后输出的数据</span></span><br><span class="line">  size_t dataOutAvailable,  </span><br><span class="line">  size_t *dataOutMoved)</span><br></pre></td></tr></table></figure>

<p>运行项目，跟踪函数调用</p>
<p>点击项目按钮，调用加密方法，可以看到跟踪函数调用的参数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#-i 跟踪函数</span><br><span class="line">$ frida-trace -U -i CCCrypt DesDemo </span><br><span class="line">Instrumenting...</span><br><span class="line">CCCrypt: Auto-generated handler at &quot;&#x2F;Users&#x2F;xxx&#x2F;Desktop&#x2F;WeChat&#x2F;__handlers__&#x2F;libcommonCrypto.dylib&#x2F;CCCrypt.js&quot;</span><br><span class="line">Started tracing 1 function. Press Ctrl+C to stop.</span><br><span class="line">           &#x2F;* TID 0x103 *&#x2F;</span><br><span class="line">  9217 ms  CCCrypt(op&#x3D;0x0, alg&#x3D;0x1, options&#x3D;0x1, key&#x3D;0x102363d50, keyLength&#x3D;0x8, iv&#x3D;0x16daa4e20, dataIn&#x3D;0x280a01531, dataInLength&#x3D;0xa, dataOut&#x3D;0x16daa4e28, dataOutAvailable&#x3D;0x400, dataOutMoved&#x3D;0x16daa4de0)</span><br></pre></td></tr></table></figure>

<p>并且生成了 handlers/CCCrypt.js 文件</p>
<p>有两个函数，onEnter 是进入函数时会执行的代码，onLeave是函数执行完离开时会执行的代码</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="title">onEnter</span>(<span class="params">log, args, state</span>)</span> &#123;</span><br><span class="line">    log(<span class="string">`CCCrypt(op=<span class="subst">$&#123;args[<span class="number">0</span>]&#125;</span>, alg=<span class="subst">$&#123;args[<span class="number">1</span>]&#125;</span>, options=<span class="subst">$&#123;args[<span class="number">2</span>]&#125;</span>, key=<span class="subst">$&#123;args[<span class="number">3</span>]&#125;</span>, keyLength=<span class="subst">$&#123;args[<span class="number">4</span>]&#125;</span>, iv=<span class="subst">$&#123;args[<span class="number">5</span>]&#125;</span>, dataIn=<span class="subst">$&#123;args[<span class="number">6</span>]&#125;</span>, dataInLength=<span class="subst">$&#123;args[<span class="number">7</span>]&#125;</span>, dataOut=<span class="subst">$&#123;args[<span class="number">8</span>]&#125;</span>, dataOutAvailable=<span class="subst">$&#123;args[<span class="number">9</span>]&#125;</span>, dataOutMoved=<span class="subst">$&#123;args[<span class="number">10</span>]&#125;</span>)`</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">onLeave</span>(<span class="params">log, retval, state</span>)</span> &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改内容 </p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">log, args, state</span>) </span>&#123;</span><br><span class="line">    log(<span class="string">&#x27;CCCrypt(&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;op=&#x27;</span> + args[<span class="number">0</span>] +</span><br><span class="line">      <span class="string">&#x27;, alg=&#x27;</span> + args[<span class="number">1</span>] +</span><br><span class="line">      <span class="string">&#x27;, options=&#x27;</span> + args[<span class="number">2</span>] +</span><br><span class="line">      <span class="string">&#x27;, key=&#x27;</span> + args[<span class="number">3</span>] +</span><br><span class="line">      <span class="string">&#x27;, keyLength=&#x27;</span> + args[<span class="number">4</span>] +</span><br><span class="line">      <span class="string">&#x27;, iv=&#x27;</span> + args[<span class="number">5</span>] +</span><br><span class="line">      <span class="string">&#x27;, dataIn=&#x27;</span> + args[<span class="number">6</span>] +</span><br><span class="line">      <span class="string">&#x27;, dataInLength=&#x27;</span> + args[<span class="number">7</span>] +</span><br><span class="line">      <span class="string">&#x27;, dataOut=&#x27;</span> + args[<span class="number">8</span>] +</span><br><span class="line">      <span class="string">&#x27;, dataOutAvailable=&#x27;</span> + args[<span class="number">9</span>] +</span><br><span class="line">      <span class="string">&#x27;, dataOutMoved=&#x27;</span> + args[<span class="number">10</span>] +</span><br><span class="line">    <span class="string">&#x27;)&#x27;</span>);</span><br><span class="line">    <span class="comment">//保存参数</span></span><br><span class="line">    <span class="built_in">this</span>.operation   = args[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">this</span>.CCAlgorithm = args[<span class="number">1</span>]</span><br><span class="line">    <span class="built_in">this</span>.CCOptions   = args[<span class="number">2</span>]</span><br><span class="line">    <span class="built_in">this</span>.keyBytes    = args[<span class="number">3</span>]</span><br><span class="line">    <span class="built_in">this</span>.keyLength   = args[<span class="number">4</span>]</span><br><span class="line">    <span class="built_in">this</span>.ivBuffer    = args[<span class="number">5</span>]</span><br><span class="line">    <span class="built_in">this</span>.inBuffer    = args[<span class="number">6</span>]</span><br><span class="line">    <span class="built_in">this</span>.inLength    = args[<span class="number">7</span>]</span><br><span class="line">    <span class="built_in">this</span>.outBuffer   = args[<span class="number">8</span>]</span><br><span class="line">    <span class="built_in">this</span>.outLength   = args[<span class="number">9</span>]</span><br><span class="line">    <span class="built_in">this</span>.outCountPtr = args[<span class="number">10</span>]</span><br><span class="line">    <span class="comment">//this.operation == 0 代表是加密</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.operation == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">//打印加密前的原文</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;In buffer:&quot;</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(hexdump(ptr(<span class="built_in">this</span>.inBuffer), &#123;</span><br><span class="line">            length: <span class="built_in">this</span>.inLength.toInt32(),</span><br><span class="line">            header: <span class="literal">true</span>,</span><br><span class="line">            ansi: <span class="literal">true</span></span><br><span class="line">        &#125;))</span><br><span class="line">        <span class="comment">//打印密钥</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;Key: &quot;</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(hexdump(ptr(<span class="built_in">this</span>.keyBytes), &#123;</span><br><span class="line">            length: <span class="built_in">this</span>.keyLength.toInt32(),</span><br><span class="line">            header: <span class="literal">true</span>,</span><br><span class="line">            ansi: <span class="literal">true</span></span><br><span class="line">        &#125;))</span><br><span class="line">        <span class="comment">//打印 IV</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;IV: &quot;</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(hexdump(ptr(<span class="built_in">this</span>.ivBuffer), &#123;</span><br><span class="line">            length: <span class="built_in">this</span>.keyLength.toInt32(),</span><br><span class="line">            header: <span class="literal">true</span>,</span><br><span class="line">            ansi: <span class="literal">true</span></span><br><span class="line">        &#125;))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  onLeave: <span class="function"><span class="keyword">function</span> (<span class="params">log, retval, state</span>) </span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">ptr(s) 定义一个指针 指针地址为s </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">operation: 0x0代表加密，0x1代表解密</span></span><br><span class="line"><span class="comment">enum &#123;</span></span><br><span class="line"><span class="comment">	kCCEncrypt = 0,	</span></span><br><span class="line"><span class="comment">	kCCDecrypt = 1	</span></span><br><span class="line"><span class="comment">&#125;;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">CCAlgorithm: 0x0指加密方式是AES加密，0x1指DES加密，0x2指3DES加密</span></span><br><span class="line"><span class="comment">enum &#123;</span></span><br><span class="line"><span class="comment">	kCCAlgorithmAES128 = 0,</span></span><br><span class="line"><span class="comment">	kCCAlgorithmAES    = 0,</span></span><br><span class="line"><span class="comment">	kCCAlgorithmDES    = 1,</span></span><br><span class="line"><span class="comment">	kCCAlgorithm3DES   = 2,		</span></span><br><span class="line"><span class="comment">	kCCAlgorithmCAST   = 3,		</span></span><br><span class="line"><span class="comment">	kCCAlgorithmRC4    = 4,</span></span><br><span class="line"><span class="comment">	kCCAlgorithmRC2	   = 5	</span></span><br><span class="line"><span class="comment">&#125;;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">CCOptions: 0x1指模式是CBC，通常0x3指ECB</span></span><br><span class="line"><span class="comment">enum &#123;</span></span><br><span class="line"><span class="comment">	kCCOptionPKCS7Padding	= 0x0001,</span></span><br><span class="line"><span class="comment">	kCCOptionECBMode	= 0x0002</span></span><br><span class="line"><span class="comment">&#125;;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//或者使用 Interceptor.attach</span></span><br><span class="line">Interceptor.attach(Module.findExportByName(<span class="string">&#x27;libcommonCrypto.dylib&#x27;</span>, <span class="string">&#x27;CCCrypt&#x27;</span>), &#123;</span><br><span class="line">    onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// Save the arguments</span></span><br><span class="line">        <span class="built_in">this</span>.operation   = args[<span class="number">0</span>]</span><br><span class="line">        <span class="built_in">this</span>.CCAlgorithm = args[<span class="number">1</span>]</span><br><span class="line">        <span class="built_in">this</span>.CCOptions   = args[<span class="number">2</span>]</span><br><span class="line">        <span class="built_in">this</span>.keyBytes    = args[<span class="number">3</span>]</span><br><span class="line">        <span class="built_in">this</span>.keyLength   = args[<span class="number">4</span>]</span><br><span class="line">        <span class="built_in">this</span>.ivBuffer    = args[<span class="number">5</span>]</span><br><span class="line">        <span class="built_in">this</span>.inBuffer    = args[<span class="number">6</span>]</span><br><span class="line">        <span class="built_in">this</span>.inLength    = args[<span class="number">7</span>]</span><br><span class="line">        <span class="built_in">this</span>.outBuffer   = args[<span class="number">8</span>]</span><br><span class="line">        <span class="built_in">this</span>.outLength   = args[<span class="number">9</span>]</span><br><span class="line">        <span class="built_in">this</span>.outCountPtr = args[<span class="number">10</span>]</span><br><span class="line"></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&#x27;CCCrypt(&#x27;</span> + </span><br><span class="line">            <span class="string">&#x27;operation: &#x27;</span>   + <span class="built_in">this</span>.operation    +<span class="string">&#x27;, &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;CCAlgorithm: &#x27;</span> + <span class="built_in">this</span>.CCAlgorithm  +<span class="string">&#x27;, &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;CCOptions: &#x27;</span>   + <span class="built_in">this</span>.CCOptions    +<span class="string">&#x27;, &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;keyBytes: &#x27;</span>    + <span class="built_in">this</span>.keyBytes     +<span class="string">&#x27;, &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;keyLength: &#x27;</span>   + <span class="built_in">this</span>.keyLength    +<span class="string">&#x27;, &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;ivBuffer: &#x27;</span>    + <span class="built_in">this</span>.ivBuffer     +<span class="string">&#x27;, &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;inBuffer: &#x27;</span>    + <span class="built_in">this</span>.inBuffer     +<span class="string">&#x27;, &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;inLength: &#x27;</span>    + <span class="built_in">this</span>.inLength     +<span class="string">&#x27;, &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;outBuffer: &#x27;</span>   + <span class="built_in">this</span>.outBuffer    +<span class="string">&#x27;, &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;outLength: &#x27;</span>   + <span class="built_in">this</span>.outLength    +<span class="string">&#x27;, &#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;outCountPtr: &#x27;</span> + <span class="built_in">this</span>.outCountPtr  +<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.operation == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Show the buffers here if this an encryption operation</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;In buffer:&quot;</span>)</span><br><span class="line">            <span class="built_in">console</span>.log(hexdump(ptr(<span class="built_in">this</span>.inBuffer), &#123;</span><br><span class="line">                length: <span class="built_in">this</span>.inLength.toInt32(),</span><br><span class="line">                header: <span class="literal">true</span>,</span><br><span class="line">                ansi: <span class="literal">true</span></span><br><span class="line">            &#125;))</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;Key: &quot;</span>)</span><br><span class="line">            <span class="built_in">console</span>.log(hexdump(ptr(<span class="built_in">this</span>.keyBytes), &#123;</span><br><span class="line">                length: <span class="built_in">this</span>.keyLength.toInt32(),</span><br><span class="line">                header: <span class="literal">true</span>,</span><br><span class="line">                ansi: <span class="literal">true</span></span><br><span class="line">            &#125;))</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;IV: &quot;</span>)</span><br><span class="line">            <span class="built_in">console</span>.log(hexdump(ptr(<span class="built_in">this</span>.ivBuffer), &#123;</span><br><span class="line">                length: <span class="built_in">this</span>.keyLength.toInt32(),</span><br><span class="line">                header: <span class="literal">true</span>,</span><br><span class="line">                ansi: <span class="literal">true</span></span><br><span class="line">            &#125;))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    onLeave: <span class="function"><span class="keyword">function</span> (<span class="params">retVal</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.operation == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// Show the buffers here if this a decryption operation</span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;Out buffer:&quot;</span>)</span><br><span class="line">            <span class="built_in">console</span>.log(hexdump(ptr(<span class="built_in">this</span>.outBuffer), &#123;</span><br><span class="line">                length: Memory.readUInt(<span class="built_in">this</span>.outCountPtr),</span><br><span class="line">                header: <span class="literal">true</span>,</span><br><span class="line">                ansi: <span class="literal">true</span></span><br><span class="line">            &#125;))</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;Key: &quot;</span>)</span><br><span class="line">            <span class="built_in">console</span>.log(hexdump(ptr(<span class="built_in">this</span>.keyBytes), &#123;</span><br><span class="line">                length: <span class="built_in">this</span>.keyLength.toInt32(),</span><br><span class="line">                header: <span class="literal">true</span>,</span><br><span class="line">                ansi: <span class="literal">true</span></span><br><span class="line">            &#125;))</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;IV: &quot;</span>)</span><br><span class="line">            <span class="built_in">console</span>.log(hexdump(ptr(<span class="built_in">this</span>.ivBuffer), &#123;</span><br><span class="line">                length: <span class="built_in">this</span>.keyLength.toInt32(),</span><br><span class="line">                header: <span class="literal">true</span>,</span><br><span class="line">                ansi: <span class="literal">true</span></span><br><span class="line">            &#125;))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//hexdump 打印内存中的地址</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">var libc = Module.findBaseAddress(&#x27;libc.so&#x27;);</span></span><br><span class="line"><span class="comment">console.log(hexdump(libc, &#123;</span></span><br><span class="line"><span class="comment">  offset: 0,</span></span><br><span class="line"><span class="comment">  length: 64,</span></span><br><span class="line"><span class="comment">  header: true,</span></span><br><span class="line"><span class="comment">  ansi: true</span></span><br><span class="line"><span class="comment">&#125;));</span></span><br><span class="line"><span class="comment">           0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F  0123456789ABCDEF</span></span><br><span class="line"><span class="comment">00000000  7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00  .ELF............</span></span><br><span class="line"><span class="comment">00000010  03 00 28 00 01 00 00 00 00 00 00 00 34 00 00 00  ..(.........4...</span></span><br><span class="line"><span class="comment">00000020  34 a8 04 00 00 00 00 05 34 00 20 00 08 00 28 00  4.......4. ...(.</span></span><br><span class="line"><span class="comment">00000030  1e 00 1d 00 06 00 00 00 34 00 00 00 34 00 00 00  ........4...4...</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>再次执行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ frida-trace -U -i CCCrypt DesDemo</span><br><span class="line"></span><br><span class="line">Started tracing 1 function. Press Ctrl+C to stop.</span><br><span class="line">In buffer:</span><br><span class="line">            0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F  0123456789ABCDEF</span><br><span class="line">280a14451  72 32 34 33 34 33 34 33 34 33                    r243434343</span><br><span class="line">Key:</span><br><span class="line">            0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F  0123456789ABCDEF</span><br><span class="line">102363d50  78 78 78 78 00 21 2a 27                          xxxx.!*&#39;</span><br><span class="line">IV:</span><br><span class="line">            0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F  0123456789ABCDEF</span><br><span class="line">16daa4e20  12 34 56 78 90 ab cd ef                          .4Vx....</span><br><span class="line">           &#x2F;* TID 0x103 *&#x2F;</span><br><span class="line">  1813 ms  CCCrypt(op&#x3D;0x0, alg&#x3D;0x1, options&#x3D;0x1, key&#x3D;0x102363d50, keyLength&#x3D;0x8, iv&#x3D;0x16daa4e20, dataIn&#x3D;0x280a14451, dataInLength&#x3D;0xa, dataOut&#x3D;0x16daa4e28, dataOutAvailable&#x3D;0x400, dataOutMoved&#x3D;0x16daa4de0)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;可以看到加密前字符串 r243434343</span><br></pre></td></tr></table></figure>

<p>CC_MD5 </p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">CC_MD5(fooData, (CC_LONG)strlen(fooData), result);</span><br><span class="line"></span><br><span class="line"><span class="comment">//参数1:要加密的字符串</span></span><br><span class="line"><span class="comment">//参数2: 获取要加密字符串的长度</span></span><br><span class="line"><span class="comment">//参数3: 接收结果的数组</span></span><br><span class="line"><span class="comment">//返回一个32位长度的加密后的字符串</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//js</span></span><br><span class="line">&#123;</span><br><span class="line">  onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">log, args, state</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//将md5参数转成字符串并打印</span></span><br><span class="line">    <span class="keyword">var</span> md5_data = args[<span class="number">0</span>].readUtf8String();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;MD5-参数值:&#x27;</span>);</span><br><span class="line">    <span class="built_in">console</span>.error(md5_data);</span><br><span class="line">  &#125;, </span><br><span class="line">  onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">log, retval, state</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//将md5返回值转码为32位字符串并打印</span></span><br><span class="line">    <span class="keyword">var</span> md5_digest = hexdump(retval, &#123;<span class="attr">length</span>: <span class="number">16</span>&#125;);</span><br><span class="line">    <span class="keyword">var</span> hexified = <span class="string">&quot; &quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> raw_array = md5_digest.split(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> a=<span class="number">0</span>;a&lt; raw_array.length,a++)&#123;</span><br><span class="line">      <span class="keyword">var</span> line_array = raw_array[a].split(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> b=<span class="number">1</span>;b&lt;line_array.length-<span class="number">1</span>;b++)&#123;</span><br><span class="line">        <span class="function"><span class="title">if</span>(<span class="params">line_array[b].length==<span class="number">2</span></span>)</span>&#123;</span><br><span class="line">          hexified+=line_array[b];</span><br><span class="line">          hexified=hexified.trim()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;MD5-返回值:&#x27;</span>);</span><br><span class="line">    <span class="built_in">console</span>.error(hexified+<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="修改入参-返回值"><a href="#修改入参-返回值" class="headerlink" title="修改入参/返回值"></a>修改入参/返回值</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line">onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;\t[-] &#x27;</span> + <span class="string">&#x27;onEnter args[0] class_name: &#x27;</span> + ObjC.Object(args[<span class="number">0</span>]).toString())</span><br><span class="line">	<span class="keyword">var</span> newval = ObjC.classes.NSString.stringWithString_(<span class="string">&quot;root/0;debug/0;proxy/0;inject/0&quot;</span>)</span><br><span class="line">  args[<span class="number">0</span>] = newval</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;\t[-] &#x27;</span> + <span class="string">&#x27;onEnter args[0] class_name: &#x27;</span> + ObjC.Object(args[<span class="number">0</span>]).toString())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> newuuid = ObjC.classes.NSString.stringWithString_(<span class="string">&quot;32427210-7773-7679-3993-A3F7-E85D212D7D91&quot;</span>)</span><br><span class="line">  retval.replace(newuuid)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="打印"><a href="#打印" class="headerlink" title="打印"></a>打印</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">var str &#x3D; new ObjC.Object(ptr(args[2])).toString();</span><br><span class="line">console.log(&#39;[*] str:] -&gt;&#39; , str);</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>













<p><a href="https://la0s.github.io/2018/12/07/iOS_Crypto/">破解iOS加密数据</a></p>
<p><a href="https://github.com/la0s/Frida-scripts">Frida-scripts  (base64|MD5|SHA1)</a></p>
<p><a href="https://github.com/dpnishant/appmon/tree/master/scripts/iOS/Crypto">appmon project 提供的 scripts</a></p>
<p><a href="https://github.com/theart42/hack.lu/blob/master/IOS/Notes/05-Crypt/00-crypto-hooks.md">hack.lu 的 scripts</a></p>
]]></content>
  </entry>
  <entry>
    <title>JavaScript（一）</title>
    <url>/2022/09/18/JavaScript%EF%BC%88%E4%B8%80%EF%BC%89/</url>
    <content><![CDATA[<p><a href="https://www.liaoxuefeng.com/wiki/1022910821149312/1023020895584256">廖雪峰JavaScript</a></p>
<h4 id="1-入门"><a href="#1-入门" class="headerlink" title="1 入门"></a>1 入门</h4><p>JavaScript可以嵌套在网页的任何地方，通常把 JavaScript 代码放到 <code>&lt;head&gt;</code> 中</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;script&gt;</span><br><span class="line">    alert(<span class="string">&#x27;Hello, world&#x27;</span>);</span><br><span class="line">  &lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  ...</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>可以把 JavaScript 代码放到单独的 .js 文件，HTML 中通过 <code>&lt;script src=&quot;...&quot;&gt;&lt;/script&gt;</code> 引入这个文件</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">  &lt;script src=<span class="string">&quot;/static/js/abc.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  ...</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>可以同个页面中引入多个 .js 文件，还可在页面中多次编写 <code>&lt;script&gt; js代码... &lt;/script&gt;</code> , 浏览器按照顺序依次执行</p>
<p>有时候会看到 <code>&lt;script&gt;</code> 标签还设置了一个 type 属性</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">  ...</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>这个没必要，默认就是 JavaScript 类型的</p>
<h5 id="1-1-基本语法"><a href="#1-1-基本语法" class="headerlink" title="1.1 基本语法"></a>1.1 基本语法</h5><p>JavaScript 语法和 Java 语法类似，每个语句以 ；结束，JavaScript 不强制要求在每个语句结尾加；</p>
<h5 id="1-2-数据类型和变量"><a href="#1-2-数据类型和变量" class="headerlink" title="1.2 数据类型和变量"></a>1.2 数据类型和变量</h5><h6 id="Number"><a href="#Number" class="headerlink" title="Number"></a>Number</h6><p>JavaScript 不区分整数和浮点数，统一用 Number 表示</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="number">123</span>;  <span class="comment">//整数</span></span><br><span class="line"><span class="number">0.456</span>;<span class="comment">//浮点数</span></span><br><span class="line"><span class="literal">NaN</span>;  <span class="comment">//Not a Number，当无法计算结果时用 NaN 表示</span></span><br><span class="line"><span class="literal">Infinity</span>；<span class="comment">//表示无限大</span></span><br></pre></td></tr></table></figure>

<h6 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h6><p>单引号或双引号括起来的任意文本</p>
<h6 id="布尔值"><a href="#布尔值" class="headerlink" title="布尔值"></a>布尔值</h6><p>true、false 两种值</p>
<h6 id="比较运算符"><a href="#比较运算符" class="headerlink" title="比较运算符"></a>比较运算符</h6><p>==，会自动转换数据类型再比较，很多时候，会得到非常诡异的结果</p>
<p>===，不会自动转换数据类型，如果数据类型不一致，会返回 false，如果一致，再比较</p>
<p>由于JavaScript这个设计缺陷，不要使用 == 比较，坚持使用 === 比较</p>
<p>NaN 这个特殊的 Number 与所有其他值都不相等，唯一能判断 NaN 的方法是通过 isNaN() 函数</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="literal">NaN</span> === <span class="literal">NaN</span>; <span class="comment">//false</span></span><br><span class="line"><span class="built_in">isNaN</span>(<span class="literal">NaN</span>);  <span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<p>浮点数比较</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>/<span class="number">3</span> === (<span class="number">1</span>-<span class="number">2</span>/<span class="number">3</span>); <span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>浮点数在运算过程中会产生误差，要比较两个浮点数是否相等，只能计算它们之差的绝对值，看是否小于某个阈值</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Math</span>.abs(<span class="number">1</span>/<span class="number">3</span> - (<span class="number">1</span>-<span class="number">2</span>/<span class="number">3</span>)) &lt; <span class="number">0.0000001</span>; <span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<h6 id="null-和-undefined"><a href="#null-和-undefined" class="headerlink" title="null 和 undefined"></a>null 和 undefined</h6><p>null 表示一个空的值，Java 中也用null，Swift 用 nil，Python用None表示</p>
<p>undefined 表示值未定义。仅仅在判断函数参数是否传递的情况下有用</p>
<h6 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h6><p>JavaScript 的数组可以包括任意数据类型</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3.14</span>, <span class="string">&#x27;hello&#x27;</span>, <span class="literal">null</span>, <span class="literal">true</span>];</span><br><span class="line">arr[<span class="number">0</span>]; <span class="comment">//1</span></span><br></pre></td></tr></table></figure>

<p>另一种创建数组的方式通过 Array() 函数实现</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="built_in">Array</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>); <span class="comment">//创建了数组 [1,2,3]</span></span><br></pre></td></tr></table></figure>

<h6 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h6><p>JavaScript 的对象是一组由键-值组成的无序集合</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">  name: <span class="string">&#x27;Bob&#x27;</span>,</span><br><span class="line">  age: <span class="number">20</span>,</span><br><span class="line">  tags: [<span class="string">&#x27;js&#x27;</span>, <span class="string">&#x27;web&#x27;</span>],</span><br><span class="line">  hasCar: <span class="literal">true</span>,</span><br><span class="line">  zipcode: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>键都是字符串类型，值可以是任意数据类型。</p>
<p>每个键又称为对象的属性</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">person.name; <span class="comment">// &#x27;Bob&#x27;</span></span><br><span class="line">person.zipcode; <span class="comment">// null</span></span><br></pre></td></tr></table></figure>

<h6 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h6><p>声明一个变量用 var 语句，同一个变量可以反复赋值，而且可以是不同类型的变量</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a;<span class="comment">//声明了变量a，此时 a 的值为 undefined</span></span><br><span class="line"><span class="keyword">var</span> t = <span class="literal">null</span>;<span class="comment">//t的值是null</span></span><br><span class="line"><span class="keyword">var</span> b = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> c = <span class="number">123</span>;</span><br><span class="line">c = <span class="string">&#x27;abc&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这种变量本身类型不固定的语言称之为动态语言。静态语言在定义变量时必须指定变量类型，Java 是静态语言。</p>
<h6 id="strict-模式"><a href="#strict-模式" class="headerlink" title="strict 模式"></a>strict 模式</h6><p>如果一个变量没有通过 var 声明就被使用，那么该变量就自动被声明为全局变量</p>
<p>ECMA 在后续规范中推出了 strict 模式，strict 模式下运行的 JavaScript，强制通过 var 声明变量，未使用 var 声明的变量就使用的，将导致运行错误</p>
<p>启用 strict 模式的方法是在 JavaScript 代码的第一行写上</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h5 id="1-3-字符串"><a href="#1-3-字符串" class="headerlink" title="1.3 字符串"></a>1.3 字符串</h5><h6 id="多行字符串"><a href="#多行字符串" class="headerlink" title="多行字符串"></a>多行字符串</h6><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">`这是一个</span></span><br><span class="line"><span class="string">多行</span></span><br><span class="line"><span class="string">字符串`</span>;</span><br></pre></td></tr></table></figure>

<h6 id="模板字符串"><a href="#模板字符串" class="headerlink" title="模板字符串"></a>模板字符串</h6><p>多个字符串连接起来，可以用 + 号连接</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">&#x27;小明&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> age = <span class="number">20</span>;</span><br><span class="line"><span class="keyword">var</span> message = <span class="string">&#x27;你好,&#x27;</span> + name + <span class="string">&#x27;，你今年&#x27;</span> + age + <span class="string">&#x27;岁了&#x27;</span></span><br></pre></td></tr></table></figure>

<p>如果多个变量需要连接，用 + 号比较麻烦，ES6 新增了一种模板字符串</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> message = <span class="string">`你好，<span class="subst">$&#123;name&#125;</span>，你今年<span class="subst">$&#123;age&#125;</span>岁了`</span></span><br></pre></td></tr></table></figure>

<p>操作字符串</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> s = <span class="string">&#x27;Hello, world&#x27;</span>;</span><br><span class="line">s[<span class="number">0</span>]; <span class="comment">//H</span></span><br><span class="line">s[<span class="number">13</span>]; <span class="comment">//undefined 超出范围的索引不会报错，返回 undefined</span></span><br></pre></td></tr></table></figure>

<p>字符串是不可变的，如果对字符串的某个索引赋值，不会报错，但也没有效果</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> s = <span class="string">&#x27;Test&#x27;</span></span><br><span class="line">s[<span class="number">0</span>] = <span class="string">&#x27;X&#x27;</span></span><br><span class="line">alert(s);<span class="comment">//s任然为Test</span></span><br></pre></td></tr></table></figure>

<h6 id="常用方法"><a href="#常用方法" class="headerlink" title="常用方法"></a>常用方法</h6><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> s = <span class="string">&#x27;Hello, world&#x27;</span>;</span><br><span class="line">s.toUpperCase();<span class="comment">//HELLO, WORLD</span></span><br><span class="line">s.toLowerCase();<span class="comment">//hello, world</span></span><br><span class="line">s.indexOf(<span class="string">&#x27;world&#x27;</span>); <span class="comment">//7</span></span><br><span class="line">s.indexOf(<span class="string">&#x27;World&#x27;</span>); <span class="comment">//没有找到指定字符串，返回-1</span></span><br><span class="line">s.substring(<span class="number">0</span>,<span class="number">5</span>); <span class="comment">//hello ，返回索引区间子串，从索引0开始到5，不包括5</span></span><br><span class="line">s.substring(<span class="number">7</span>); <span class="comment">//world，从索引7开始到结束</span></span><br></pre></td></tr></table></figure>

<h5 id="1-4-数组"><a href="#1-4-数组" class="headerlink" title="1.4 数组"></a>1.4 数组</h5><p>JavaScript 的 Array 可以包含任意数据类型</p>
<p>获取长度 length 属性</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3.14</span>, <span class="string">&#x27;Hello&#x27;</span>, <span class="literal">null</span>, <span class="literal">true</span>];</span><br><span class="line">arr.length; <span class="comment">//6</span></span><br></pre></td></tr></table></figure>

<p>给 Array 的 length 赋一个新值会导致 Array 大小的变化</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line">arr.length;<span class="comment">//3</span></span><br><span class="line">arr.length = <span class="number">4</span>;</span><br><span class="line">arr;<span class="comment">//[1,2,3,undefined]</span></span><br><span class="line">arr.length = <span class="number">2</span>;</span><br><span class="line">arr;<span class="comment">//[1,2]</span></span><br></pre></td></tr></table></figure>

<p>修改值</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>];</span><br><span class="line">arr[<span class="number">1</span>] = <span class="number">99</span>; <span class="comment">//[&#x27;A&#x27;,99,&#x27;C&#x27;]</span></span><br></pre></td></tr></table></figure>

<p>索引赋值时，索引超过了范围，同样会引起 Array 大小的变化</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line">arr[<span class="number">5</span>] = <span class="string">&#x27;x&#x27;</span></span><br><span class="line">arr;<span class="comment">//[1,2,3,undefined,undefined,&#x27;x&#x27;]</span></span><br></pre></td></tr></table></figure>

<p>编写代码时不建议直接修改 Array 的大小，访问索引时确保索引不会越界</p>
<h6 id="indexOf"><a href="#indexOf" class="headerlink" title="indexOf"></a>indexOf</h6><p>搜索指定元素的位置</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">10</span>,<span class="number">20</span>,<span class="string">&#x27;30&#x27;</span>,<span class="string">&#x27;xyz&#x27;</span>];</span><br><span class="line">arr.indexOf(<span class="number">10</span>);<span class="comment">//元素10的索引为0</span></span><br><span class="line">arr.indexOf(<span class="number">30</span>);<span class="comment">//元素30没有找到返回-1</span></span><br></pre></td></tr></table></figure>

<h6 id="slice"><a href="#slice" class="headerlink" title="slice"></a>slice</h6><p>slice() 就是对应 String 的 substring() 版本，截取 Array 的部分元素，返回一个新的 Array</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>,<span class="string">&#x27;D&#x27;</span>,<span class="string">&#x27;E&#x27;</span>,<span class="string">&#x27;F&#x27;</span>,<span class="string">&#x27;G&#x27;</span>];</span><br><span class="line">arr.slice(<span class="number">0</span>,<span class="number">3</span>);<span class="comment">//从索引0开始，到索引3结束，不包括3 [&#x27;A&#x27;,&#x27;B&#x27;,&#x27;C&#x27;]</span></span><br><span class="line">arr.slice(<span class="number">3</span>);<span class="comment">//从索引3开始到结束 [&#x27;E&#x27;,&#x27;F&#x27;,&#x27;G&#x27;]</span></span><br></pre></td></tr></table></figure>

<p>如果不给 slice() 传递任何参数，就会从头到尾截取所有元素，利用这一点可以很容易复制一个 Array</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> aCopy = arr.slice();</span><br></pre></td></tr></table></figure>

<h6 id="push-和-pop"><a href="#push-和-pop" class="headerlink" title="push 和 pop"></a>push 和 pop</h6><p>push() 向 Array 末尾添加若干元素，pop() 把 Array 最后一个元素删掉</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>,<span class="number">2</span>];</span><br><span class="line">arr.push(<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>);<span class="comment">//[1,2,&#x27;A&#x27;,&#x27;B&#x27;]</span></span><br><span class="line">arr.pop();<span class="comment">//pop()返回&#x27;B&#x27;</span></span><br><span class="line">arr;<span class="comment">//[1,2,&#x27;A&#x27;]</span></span><br><span class="line">arr.pop();arr.pop(),arr.pop();</span><br><span class="line">arr.pop();<span class="comment">//空数组pop不会报错，返回undefined</span></span><br></pre></td></tr></table></figure>

<h6 id="unshift-和-shift"><a href="#unshift-和-shift" class="headerlink" title="unshift 和 shift"></a>unshift 和 shift</h6><p>往 Array 的头部添加若干元素，使用 unshift()，shift() 把 Array 第一个元素删掉</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>,<span class="number">2</span>];</span><br><span class="line">arr.unshift(<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>);<span class="comment">//[&#x27;A&#x27;,&#x27;B&#x27;,1,2]</span></span><br><span class="line">arr.shift();<span class="comment">//返回 ‘A’</span></span><br><span class="line">arr;<span class="comment">//[&#x27;B&#x27;,1,2]</span></span><br><span class="line">arr.shift();arr.shift();arr.shift();</span><br><span class="line">arr.shift();<span class="comment">//空数组shift不会报错，返回undefined</span></span><br></pre></td></tr></table></figure>

<h6 id="sort"><a href="#sort" class="headerlink" title="sort"></a>sort</h6><p>sort() 对当前 Array 进行排序，会直接修改当前 Array 的元素位置，直接调用时，按照默认顺序排序</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>,<span class="string">&#x27;A&#x27;</span>];</span><br><span class="line">arr.sort();</span><br><span class="line">arr;<span class="comment">//[&#x27;A&#x27;,&#x27;B&#x27;,&#x27;C&#x27;]</span></span><br></pre></td></tr></table></figure>

<h6 id="reverse"><a href="#reverse" class="headerlink" title="reverse"></a>reverse</h6><p>reverse() 把整个 Array 的元素反转</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;one&#x27;</span>,<span class="string">&#x27;two&#x27;</span>,<span class="string">&#x27;three&#x27;</span>];</span><br><span class="line">arr.reverse();</span><br><span class="line">arr;<span class="comment">//[&#x27;three&#x27;,&#x27;two&#x27;,&#x27;one&#x27;]</span></span><br></pre></td></tr></table></figure>

<h6 id="slice-1"><a href="#slice-1" class="headerlink" title="slice"></a>slice</h6><p>slice() 是修改 Array 的万能方法，可以从指定的索引开始删除若干个元素，然后再从该位置添加若干个元素</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;Microsoft&#x27;</span>,<span class="string">&#x27;Apple&#x27;</span>,<span class="string">&#x27;Yahoo&#x27;</span>,<span class="string">&#x27;AOL&#x27;</span>,<span class="string">&#x27;Excite&#x27;</span>,<span class="string">&#x27;Oracle&#x27;</span>];</span><br><span class="line">arr.slice(<span class="number">2</span>,<span class="number">3</span>,<span class="string">&#x27;Google&#x27;</span>,<span class="string">&#x27;Facebook&#x27;</span>);<span class="comment">//从索引2开始删除3个元素，再添加两个元素</span></span><br><span class="line"><span class="comment">//[&#x27;Microsoft&#x27;,&#x27;Apple&#x27;,&#x27;Google&#x27;,&#x27;Facebook&#x27;,&#x27;Oracle&#x27;]</span></span><br><span class="line">arr.slice(<span class="number">2</span>,<span class="number">2</span>);<span class="comment">//只删除不添加</span></span><br><span class="line"><span class="comment">//[&#x27;Microsoft&#x27;,&#x27;Apple&#x27;,&#x27;Oracle&#x27;]</span></span><br><span class="line">arr.slice(<span class="number">2</span>,<span class="number">0</span>,<span class="string">&#x27;Google&#x27;</span>,<span class="string">&#x27;Facebook&#x27;</span>);<span class="comment">//只添加不shanc</span></span><br><span class="line"><span class="comment">//[&#x27;Microsoft&#x27;,&#x27;Apple&#x27;,&#x27;Google&#x27;,&#x27;Facebook&#x27;,&#x27;Oracle&#x27;]</span></span><br></pre></td></tr></table></figure>

<h6 id="concat"><a href="#concat" class="headerlink" title="concat"></a>concat</h6><p>concat() 方法把当前的 Array 和 另一个 Array 连接起来，并返回新的 Array</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>];</span><br><span class="line"><span class="keyword">var</span> added = arr.concat([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]);</span><br><span class="line">added;<span class="comment">//返回新的 Array [&#x27;A&#x27;,&#x27;B&#x27;,&#x27;C&#x27;,1,2,3] </span></span><br></pre></td></tr></table></figure>

<p>concat() 方法可以接收任意个元素和 Array，并且自动把 Array 拆开</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">arr.concat(<span class="number">1</span>,<span class="number">2</span>,[<span class="number">3</span>,<span class="number">4</span>]);</span><br></pre></td></tr></table></figure>

<h6 id="join"><a href="#join" class="headerlink" title="join"></a>join</h6><p>join() 把当前 Array 的每个元素都用指定的字符串连接起来，然后返回连接后的字符串</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">arr.join(<span class="string">&#x27;-&#x27;</span>);<span class="comment">//&#x27;A-B-C-1-2-3&#x27;</span></span><br></pre></td></tr></table></figure>

<p>如果 Array 的元素不是字符串，将自动转换为字符串后连接</p>
<h6 id="多维数组"><a href="#多维数组" class="headerlink" title="多维数组"></a>多维数组</h6><p>数组的某个元素又是一个数组</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>],[<span class="number">400</span>,<span class="number">500</span>,<span class="number">600</span>],<span class="string">&#x27;-&#x27;</span>];</span><br></pre></td></tr></table></figure>

<h5 id="1-5-对象"><a href="#1-5-对象" class="headerlink" title="1.5 对象"></a>1.5 对象</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">  name: <span class="string">&#x27;Bob&#x27;</span>,</span><br><span class="line">  age: <span class="number">20</span>,</span><br><span class="line">  tags: [<span class="string">&#x27;js&#x27;</span>, <span class="string">&#x27;web&#x27;</span>],</span><br><span class="line">  hasCar: <span class="literal">true</span>,</span><br><span class="line">  zipcode: <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="访问属性"><a href="#访问属性" class="headerlink" title="访问属性"></a>访问属性</h6><p>访问属性通过 . 操作符完成，属性名必须是一个有效的变量名，如果属性名包含特殊字符，就必须用 <code>‘ ’</code> 括起来</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> xiaohong = &#123;</span><br><span class="line">    name: <span class="string">&#x27;小红&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;middle-school&#x27;</span>: <span class="string">&#x27;No.1 Middle School&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line">xiaohong[<span class="string">&#x27;middle-school&#x27;</span>]; <span class="comment">// &#x27;No.1 Middle School&#x27;</span></span><br><span class="line">xiaohong[<span class="string">&#x27;name&#x27;</span>]; <span class="comment">// &#x27;小红&#x27;</span></span><br><span class="line">xiaohong.name; <span class="comment">// &#x27;小红&#x27; 更简洁</span></span><br></pre></td></tr></table></figure>

<p>访问不存在的属性不报错，返回 undefined。</p>
<h6 id="添加删除属性"><a href="#添加删除属性" class="headerlink" title="添加删除属性"></a>添加删除属性</h6><p>JavaScript 对象是动态类型，可以自动地给一个对象添加或删除属性</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">xiaohong.age;<span class="comment">//undefined</span></span><br><span class="line">xiaohong.age = <span class="number">18</span>;<span class="comment">//新增age属性</span></span><br><span class="line"><span class="keyword">delete</span> xiaohong.age;<span class="comment">//删除age属性</span></span><br><span class="line"><span class="keyword">delete</span> xiaohong.school;<span class="comment">//删除不存在的属性也不会报错</span></span><br></pre></td></tr></table></figure>

<p>检测是否拥有某一个属性，使用 in 操作符</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;name&#x27;</span> <span class="keyword">in</span> xiaohong; <span class="comment">//true</span></span><br><span class="line"><span class="string">&#x27;grade&#x27;</span> <span class="keyword">in</span> xiaohong; <span class="comment">//false</span></span><br></pre></td></tr></table></figure>

<p>in 判断一个属性存在，这个属性不一定是 xiaohong 的，可能是 xiaohong 继承得到的</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;toString&#x27;</span> <span class="keyword">in</span> xiaohong;<span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<p>toString 定义在 object 对象中，所有对象最终都会在原型链上指向 object，所以 xiaohong 也拥有 toString 属性。</p>
<p>要判断一个属性是否是 xiaohong 自身拥有的，而不是继承得到的，使用 hasOwnProperty() 方法</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">xiaohong.hasOwnProperty(<span class="string">&#x27;name&#x27;</span>); <span class="comment">//true</span></span><br></pre></td></tr></table></figure>

<h5 id="1-6-条件判断"><a href="#1-6-条件判断" class="headerlink" title="1.6 条件判断"></a>1.6 条件判断</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> age = <span class="number">20</span>;</span><br><span class="line"><span class="keyword">if</span> (age &gt;= <span class="number">18</span>) &#123;</span><br><span class="line">	alert(<span class="string">&#x27;adult&#x27;</span>); <span class="comment">//只包含一条语句 &#123;&#125; 也可以省略，建议写上</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	alert(<span class="string">&#x27;teenager&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>JavaScript 把 null、undefined、0、NaN 和空字符串 ‘’ 视为 false，其它一概视为 true</p>
<h5 id="1-7-循环"><a href="#1-7-循环" class="headerlink" title="1.7 循环"></a>1.7 循环</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> i;</span><br><span class="line"><span class="function"><span class="title">for</span>(<span class="params">i=<span class="number">1</span>;i&lt;<span class="number">100</span>;i++</span>)</span>&#123;</span><br><span class="line">  x = x + i;</span><br><span class="line">&#125;</span><br><span class="line">x;</span><br><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;Apple&#x27;</span>,<span class="string">&#x27;Google&#x27;</span>,<span class="string">&#x27;Microsoft&#x27;</span>]</span><br><span class="line"><span class="keyword">var</span> i, x;</span><br><span class="line"><span class="function"><span class="title">for</span>(<span class="params">i=<span class="number">0</span>;i&lt;arr.length;i++</span>)</span>&#123;</span><br><span class="line">  x = arr[i];</span><br><span class="line">  <span class="built_in">console</span>.log(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>for 循环的3个条件都是可以省略的，如果没有退出循环条件，就必须用break语句退出循环</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="title">for</span>(<span class="params">;;</span>)</span>&#123;</span><br><span class="line">  <span class="function"><span class="title">if</span>(<span class="params">x&gt;<span class="number">100</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  x++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="for-…-in"><a href="#for-…-in" class="headerlink" title="for … in"></a>for … in</h6><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> o = &#123;</span><br><span class="line">  name: <span class="string">&#x27;jack&#x27;</span>,</span><br><span class="line">  age: <span class="number">20</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">for</span>(<span class="params"><span class="keyword">var</span> key <span class="keyword">in</span> o</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(key); <span class="comment">//&#x27;name&#x27;, &#x27;age&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">for</span>(<span class="params"><span class="keyword">var</span> key <span class="keyword">in</span> o</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (o.hasOwnProperty(key))&#123;<span class="comment">//过滤掉对象继承的属性</span></span><br><span class="line">    <span class="built_in">console</span>.log(key);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>for … in 对 Array 的循环得到的是 String 而不是 Number</p>
<h6 id="while"><a href="#while" class="headerlink" title="while"></a>while</h6><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> n = <span class="number">99</span>;</span><br><span class="line"><span class="function"><span class="title">while</span>(<span class="params">n&gt;<span class="number">0</span></span>)</span>&#123;</span><br><span class="line">  x = x + n;</span><br><span class="line">  n = n - <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line">x;</span><br></pre></td></tr></table></figure>

<h6 id="do-…-while"><a href="#do-…-while" class="headerlink" title="do … while"></a>do … while</h6><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> n = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">  n = n + <span class="number">1</span>;</span><br><span class="line">&#125; <span class="keyword">while</span> (n &lt; <span class="number">100</span>);</span><br><span class="line">n;</span><br></pre></td></tr></table></figure>

<h5 id="1-8-Map-和-Set"><a href="#1-8-Map-和-Set" class="headerlink" title="1.8 Map 和 Set"></a>1.8 Map 和 Set</h5><p>最新的 ES6 规范引入了新的数据类型 Map</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span></span><br><span class="line"><span class="keyword">var</span> m = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line"><span class="keyword">var</span> s = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br></pre></td></tr></table></figure>

<h6 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h6><p>是一组键值对的数据结构，具有极快的查找速度</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> m = <span class="keyword">new</span> <span class="built_in">Map</span>([[<span class="string">&#x27;Michale&#x27;</span>,<span class="number">95</span>],[<span class="string">&#x27;Bob&#x27;</span>,<span class="number">75</span>],[<span class="string">&#x27;Tracy&#x27;</span>, <span class="number">85</span>]]);</span><br><span class="line">m.get(<span class="string">&#x27;Michale&#x27;</span>);<span class="comment">//95</span></span><br></pre></td></tr></table></figure>

<p>初始化 Map 需要一个二维数组，或者直接初始化一个空 Map</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> m = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line">m.set(<span class="string">&#x27;Adam&#x27;</span>,<span class="number">67</span>);<span class="comment">//添加新的key-value</span></span><br><span class="line">m.has(<span class="string">&#x27;Adam&#x27;</span>);<span class="comment">//是否存在key ‘Adam’ true</span></span><br><span class="line">m.get(<span class="string">&#x27;Adam&#x27;</span>);<span class="comment">//67</span></span><br><span class="line">m.delete(<span class="string">&#x27;Adam&#x27;</span>);<span class="comment">//删除key</span></span><br><span class="line">m.get(<span class="string">&#x27;Adam&#x27;</span>);<span class="comment">//undefined</span></span><br></pre></td></tr></table></figure>

<h6 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h6><p>Set 和 Map 类似，也是一组 key 的集合，但不存储 value，key 不能重复</p>
<p>创建 Set，需要提供一个 Array 作为输入，或者直接创建一个空 Set</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> s1 = <span class="keyword">new</span> <span class="built_in">Set</span>();</span><br><span class="line"><span class="keyword">var</span> s2 = <span class="keyword">new</span> <span class="built_in">Set</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]);<span class="comment">//含1,2,3</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> s = <span class="keyword">new</span> <span class="built_in">Set</span>([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="string">&#x27;3&#x27;</span>]);</span><br><span class="line">s;<span class="comment">//Set&#123;1,2,3,&#x27;3&#x27;&#125;</span></span><br><span class="line">s.add(<span class="number">4</span>);<span class="comment">//添加</span></span><br><span class="line">s.delete(<span class="number">3</span>);<span class="comment">//删除</span></span><br></pre></td></tr></table></figure>

<h5 id="1-9-iterable"><a href="#1-9-iterable" class="headerlink" title="1.9 iterable"></a>1.9 iterable</h5><p>遍历 Array 可以采用下标循环，遍历 Map 和 Set 就无法使用下标循环。</p>
<p>ES6 标准引入了新的 iterable 类型，Array、Map 和 Set 都属于 iterable 类型</p>
<p>具有iterable 类型的集合可以通过 for .. of 循环来遍历</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line"><span class="keyword">var</span> b = <span class="keyword">new</span> <span class="built_in">Set</span>([<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>]);</span><br><span class="line"><span class="keyword">var</span> c = <span class="keyword">new</span> <span class="built_in">Map</span>([[<span class="number">1</span>,<span class="string">&#x27;x&#x27;</span>],[<span class="number">2</span>,<span class="string">&#x27;y&#x27;</span>]]);</span><br><span class="line"><span class="function"><span class="title">for</span>(<span class="params"><span class="keyword">var</span> x <span class="keyword">of</span> a</span>)</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">for</span>(<span class="params"><span class="keyword">var</span> x <span class="keyword">of</span> b</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">for</span>(<span class="params"><span class="keyword">var</span> x <span class="keyword">of</span> c</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(x[<span class="number">0</span>]+<span class="string">&#x27;=&#x27;</span>+x[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="forEach"><a href="#forEach" class="headerlink" title="forEach"></a>forEach</h6><p>iterable 内置的 forEach 方法，接收一个函数，每次迭代就自动回调该函数</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>];</span><br><span class="line">a.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">element, index, array</span>)</span>&#123;</span><br><span class="line">  <span class="comment">//element 当前元素的值</span></span><br><span class="line">  <span class="comment">//index 指向当前索引</span></span><br><span class="line">  <span class="comment">//array 指向Array对象本身</span></span><br><span class="line">  <span class="built_in">console</span>.log(element + <span class="string">&#x27;,index = &#x27;</span> + index);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Set 与 Array 类似，但 Set 没有索引</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> s = <span class="keyword">new</span> <span class="built_in">Set</span>([<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>]);</span><br><span class="line">s.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">element, sameElement, set</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(element);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Map 的回调函数参数依次为 value、key 和 map 本身</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> m = <span class="keyword">new</span> <span class="built_in">Map</span>([[<span class="number">1</span>,<span class="string">&#x27;x&#x27;</span>],[<span class="number">2</span>,<span class="string">&#x27;y&#x27;</span>]]);</span><br><span class="line">m.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">value, key, map</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(value);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>如果对某些参数不感兴趣，JavaScript 的函数调用不要求参数必须一致，可以忽略它们，例如只需要获得 Array 的 element</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>];</span><br><span class="line">a.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">element</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(element);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

















]]></content>
  </entry>
  <entry>
    <title></title>
    <url>/2022/10/21/LLDB-debugserver/</url>
    <content><![CDATA[<h4 id="debugserver"><a href="#debugserver" class="headerlink" title="debugserver"></a>debugserver</h4><p>LLDB 只能运行在 macOS 上，若要调试 iOS 应用，需要在设备上运行 debugserver </p>
<p>远程调试中，LLDB 可以看作客户端，安装在 macOS 上；debugserver 可以看作服务端，在 iOS 上运行，用于接受 LLDB 命令并执行，再把执行结果返回 LLDB</p>
<p>iOS 设备上没有安装debugserver，设备连接xcode后，debugserver才会被 Xcode 安装到设备的 /Develope/usr/bin 目录下</p>
<p>因为缺少task_for_pid 权限 通过 Xcode 安装的 debugserver 只能调试我们自己的App</p>
<h5 id="debugserver-配置"><a href="#debugserver-配置" class="headerlink" title="debugserver 配置"></a>debugserver 配置</h5><h6 id="配置方式1"><a href="#配置方式1" class="headerlink" title="配置方式1"></a>配置方式1</h6><p>获取 debugserver，将设备上的 debugserver 拷贝到电脑上添加权限</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ iproxy 2222 22 #进行端口转发</span><br><span class="line">$ scp -P 2222 root@localhost:&#x2F;Developer&#x2F;usr&#x2F;bin&#x2F;debugserver ~&#x2F;Desktop</span><br></pre></td></tr></table></figure>

<p>瘦身，只保留 arm64 平台</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">lipo -info debugserver</span><br><span class="line">lipo -thin arm64 debugserver -output debugserver</span><br><span class="line">file debugserver</span><br></pre></td></tr></table></figure>

<p>添加权限 task_for_pid 权限，才能调试其它APP，ldid 在 theos/bin 目录下，或者 brew install ldid</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ldid -e debugserver &#x2F;&#x2F; 查看 debugserver</span><br><span class="line">ldid -e debugserver &gt; entitlement.plist &#x2F;&#x2F;输出 entitlement.plist</span><br></pre></td></tr></table></figure>

<p>打开 entitlement.plist 文件 添加</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">task_for_pid-allow  Boolean 1</span><br><span class="line">get-task-allow      Boolean 1</span><br></pre></td></tr></table></figure>

<p>重签名 debugserver</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ldid -Sentitlement.plist debugserver &#x2F;&#x2F;重签名</span><br><span class="line">ldid -e debugserver &#x2F;&#x2F;再次查看 debugserver 内容</span><br></pre></td></tr></table></figure>

<p>/Developer/usr/bin目录下的debugserver是只读的 所以将处理好的debugserver拷贝到/usr/bin目录下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scp -P 2222 debugserver root@localhost:&#x2F;usr&#x2F;bin&#x2F;</span><br></pre></td></tr></table></figure>

<h6 id="配置方式2"><a href="#配置方式2" class="headerlink" title="配置方式2"></a>配置方式2</h6><p>新建 ent.xml</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ touch ent.xml</span><br></pre></td></tr></table></figure>

<p>拷贝内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE plist PUBLIC &quot;-&#x2F;&#x2F;Apple&#x2F;&#x2F;DTD PLIST 1.0&#x2F;&#x2F;EN&quot; &quot;http:&#x2F;&#x2F;www.apple.com&#x2F;DTDs&#x2F;PropertyList-1.0.dtd&quot;&gt;</span><br><span class="line">&lt;plist version&#x3D;&quot;1.0&quot;&gt;</span><br><span class="line">&lt;dict&gt;</span><br><span class="line">        &lt;key&gt;com.apple.springboard.debugapplications&lt;&#x2F;key&gt;</span><br><span class="line">        &lt;true&#x2F;&gt;</span><br><span class="line">        &lt;key&gt;get-task-allow&lt;&#x2F;key&gt;</span><br><span class="line">        &lt;true&#x2F;&gt;</span><br><span class="line">        &lt;key&gt;task_for_pid-allow&lt;&#x2F;key&gt;</span><br><span class="line">        &lt;true&#x2F;&gt;</span><br><span class="line">        &lt;key&gt;run-unsigned-code&lt;&#x2F;key&gt;</span><br><span class="line">        &lt;true&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;dict&gt;</span><br><span class="line">&lt;&#x2F;plist&gt;</span><br></pre></td></tr></table></figure>

<p>再用 ent.xml 重签名 debugserver</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ldid -Sent.xml debugserver</span><br></pre></td></tr></table></figure>

<ul>
<li>或者用 codesign 来签名</li>
</ul>
<p>新建 ent.plist ，内容是 ent.xml 的内容，再执行 codesign 命令签名</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">codesign -s - --entitlements ent.plist -f debugserver</span><br></pre></td></tr></table></figure>



<h5 id="debugserver-启动"><a href="#debugserver-启动" class="headerlink" title="debugserver 启动"></a>debugserver 启动</h5><p>ssh 连接上设备</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ iproxy 2222 22</span><br><span class="line">$ ssh -p 2222 root@localhost</span><br></pre></td></tr></table></figure>

<p>iOS设备上，查找应用进程名称</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root# ps -e</span><br></pre></td></tr></table></figure>

<p>debugserver 可以直接启动和附加进程 </p>
<h6 id="启动进程"><a href="#启动进程" class="headerlink" title="启动进程"></a>启动进程</h6><p>启动WeChat进程，并开启1234端口号，等待所有IP地址的LLDB连接</p>
<p>这里如果是iOS12以上系统IP地址只能设置成127.0.0.1，然后使用USB连接</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root# debugserver -x backboard *:1234 -a WeChat</span><br></pre></td></tr></table></figure>

<h6 id="附加进程"><a href="#附加进程" class="headerlink" title="附加进程"></a>附加进程</h6><p>附加到WeChat进程，并开启1234端口号，等待所有IP地址的LLDB连接</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">root# debugserver *:1234 -a WeChat</span><br></pre></td></tr></table></figure>

<p>启动或附加进程后，iOS 设备就会等待 macOS 终端 LLDB 的接入</p>
<h5 id="LLDB-连接-debugserver"><a href="#LLDB-连接-debugserver" class="headerlink" title="LLDB 连接 debugserver"></a>LLDB 连接 debugserver</h5><p>端口转发</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ iproxy 1234 1234</span><br></pre></td></tr></table></figure>

<p>LLDB 连接</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$lldb</span><br><span class="line">(lldb)process connect connect:127.0.0.1:1234</span><br><span class="line">或者</span><br><span class="line">(lldb)process connect connect:localhost:1234</span><br></pre></td></tr></table></figure>

<p>就连接上 LLDB 调试了，APP 自动处于断点状态，c 继续</p>
<h4 id="LLDB"><a href="#LLDB" class="headerlink" title="LLDB"></a>LLDB</h4><h5 id="ASLR"><a href="#ASLR" class="headerlink" title="ASLR"></a>ASLR</h5><p>获取 ASLR（地址空间布局随机化）偏移值，也叫模块基地址</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ image list -o -f</span><br></pre></td></tr></table></figure>

<p>由于 ASLR 的存在，实际加载地址每次都会不同，这是 iOS 的一种保护机制</p>
<p>函数实际内存地址 = ASLR 偏移量 + IDA 中显示的文件偏移</p>
<h5 id="断点"><a href="#断点" class="headerlink" title="断点"></a>断点</h5><p>breakpoint 可以简写为 br，设置断点</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(lldb) breakpoint set -a 0x10021d084</span><br><span class="line">(lldb) br s -a 0x10021d084  &#x2F;&#x2F;简写 br s</span><br><span class="line">(lldb) continue 					  &#x2F;&#x2F;继续执行，简写 c</span><br><span class="line">(lldb) br list						  &#x2F;&#x2F;列出所有断点</span><br></pre></td></tr></table></figure>

<ul>
<li>禁用/启用/删除断点</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(lldb) br disable 1 &#x2F;&#x2F;后面是断点序号</span><br><span class="line">(lldb) br enable  1</span><br><span class="line">(lldb) br delete  1</span><br><span class="line">(lldb) br delete    &#x2F;&#x2F;清空断点</span><br></pre></td></tr></table></figure>

<ul>
<li>断点上加命令</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(lldb) breakpoint command add 2(断点组号)</span><br><span class="line">&gt; po self</span><br><span class="line">&gt; p self.view</span><br><span class="line">&gt; DONE</span><br></pre></td></tr></table></figure>



<h5 id="给方法添加断点"><a href="#给方法添加断点" class="headerlink" title="给方法添加断点"></a>给方法添加断点</h5><p>-n 是 name 的缩写</p>
<p>p 命令：p 是打印非对象的值，expression 的缩写，打印对象的话会打印对象的地址；如果打印非对象，会打印出基本变量类型的值；也可声明一个变量：p int $a = 10</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(lldb) br [ViewController viewDidLoad]   &#x2F;&#x2F;给类方法添加断点</span><br><span class="line">(lldb) b -[ViewController hankTest1:]</span><br><span class="line">(lldb) br NSLog													 &#x2F;&#x2F;给NSLog方法添加断点</span><br><span class="line">(lldb) br set -n &quot;[ViewController save:]&quot; -n &quot;[ViewCont roller pauseGame:]&quot;</span><br><span class="line">(lldb) br set --selector touchBegan:withEvent: &#x2F;&#x2F;方法断点</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;当前文件方法添加断点</span><br><span class="line">(lldb) set --file ViewController.m --selector touchBegan:withEvent:</span><br><span class="line">&#x2F;&#x2F;遍历查找带Game字段的方法打断点</span><br><span class="line">(lldb) br set -r Game:</span><br></pre></td></tr></table></figure>

<h5 id="单步执行"><a href="#单步执行" class="headerlink" title="单步执行"></a>单步执行</h5><p>si 和 ni 是汇编级别的，s（进入子函数）和 n（单步往下走）是源码级别的</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(lldb) nexti 		&#x2F;&#x2F;单步执行，简写 ni</span><br><span class="line">(lldb) setpi	  &#x2F;&#x2F;单步执行，遇到子函数进入，简写 si</span><br><span class="line">(lldb) finish   &#x2F;&#x2F;完成功能并退出子函数，</span><br><span class="line">(lldb) return   &#x2F;&#x2F;直接退出子函数，原始代码不会调用（如反-反调试中跳过检测函数）</span><br></pre></td></tr></table></figure>

<h5 id="寄存器读取修改"><a href="#寄存器读取修改" class="headerlink" title="寄存器读取修改"></a>寄存器读取修改</h5><p>LLDB 中操作寄存器的命令 register</p>
<p>读取寄存器</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(lldb) register read $x0</span><br></pre></td></tr></table></figure>

<p>修改寄存器</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(lldb) register write $x4 1</span><br></pre></td></tr></table></figure>

<h5 id="打印操作"><a href="#打印操作" class="headerlink" title="打印操作"></a>打印操作</h5><p>po 命令用于打印 Objective-C 对象，以对象格式打印结果</p>
<p>p 命令输出原生类型（boolean、integer、float）等，可以指定输出格式</p>
<p>expression、expr、e 后面可以执行一段代码</p>
<p>print、prin、pri、p 是 expression –的缩写，</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(lldb) po $x0</span><br><span class="line">&lt;XLMemberManager:0x14f6a9f30&gt;</span><br><span class="line">(lldb) po [$0 config]  &#x2F;&#x2F;打印XLMemberManager类的config属性</span><br><span class="line">(lldb) x&#x2F;s $x1			   &#x2F;&#x2F;以字符串读取x1寄存器（打印方法名可以用这个） </span><br><span class="line">(lldb) p(char *)$x1</span><br><span class="line"></span><br><span class="line">(lldb) p self.models.lastObject &#x2F;&#x2F;拿到某个对象</span><br><span class="line">(Person*)$2&#x3D;0x324234</span><br><span class="line">(lldb) p (Person *)self.models.lastObject</span><br><span class="line">(lldb) p $2.name&#x3D;@&quot;hank&quot;			  &#x2F;&#x2F;赋值</span><br><span class="line"></span><br><span class="line">(lldb) p&#x2F;c $5					 &#x2F;&#x2F;字符打印</span><br><span class="line">(lldb) p&#x2F;x $x2				 &#x2F;&#x2F;16进制打印 </span><br><span class="line">(lldb) p&#x2F;d $x3				 &#x2F;&#x2F;十进制打印</span><br><span class="line">(lldb) p&#x2F;t $x4				 &#x2F;&#x2F;二进制打印</span><br></pre></td></tr></table></figure>

<p>LLDB 上可以添加多行代码 alt + 回车</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(lldb) p Person *p3 &#x3D; [[Person alloc] init];</span><br><span class="line">p3.age &#x3D; 10;</span><br><span class="line">p3.name &#x3D; @&quot;hank&quot;;</span><br></pre></td></tr></table></figure>



<h5 id="内存读写"><a href="#内存读写" class="headerlink" title="内存读写"></a>内存读写</h5><p>LLDB 操作内存命令 memory</p>
<ul>
<li>读取内存</li>
</ul>
<p>-c 指定要读取的字节</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(lldb) memory read $x0</span><br><span class="line">(lldb) memory read 0x0004f7c</span><br><span class="line">(lldb) memory read 0x0004f7c -c 100 </span><br><span class="line">(lldb) memory read 0x0004f7c 0x00004fcc &#x2F;&#x2F;按区间读取</span><br></pre></td></tr></table></figure>

<p>如果被读取的数据超过 1024 字节，就会出现错误，加入 –force 参数即可解决</p>
<ul>
<li>保存数据</li>
</ul>
<p>读取的内存数据可以使用 -outfile 参数保存到文件；如果只需要保存原始字节，加入 –binary</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(lldb) memory read 0x0004f7c -c 1025 --force -outfile &#x2F;tmp&#x2F;1.txt</span><br><span class="line"></span><br><span class="line">(lldb) memory read 0x0004f7c -c 1025 --force --binary -outfile &#x2F;tmp&#x2F;1.bin</span><br></pre></td></tr></table></figure>

<ul>
<li>修改内存</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(lldb) memory write 0x0004f7c 0x24</span><br></pre></td></tr></table></figure>

<ul>
<li>内存监视</li>
</ul>
<p>包括访问（read）、写入（write）、读写（read_write）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(lldb) watchpoint set expression -w read -- 0x0004f7c</span><br><span class="line">(lldb) watchpoint set expression -w write -- 0x0004f7c</span><br><span class="line">(lldb) watchpoint set expression -w read_write -- 0x0004f7c</span><br><span class="line">(lldb) watchpoint modify -c &#39;*(char*)0x0004f7c &#x3D;&#x3D; 20&#39;  &#x2F;&#x2F;指定条件监视</span><br></pre></td></tr></table></figure>

<p>和 br 断点一样，watchpoint 也有 disable/enable/delete 参数</p>
<h5 id="反汇编"><a href="#反汇编" class="headerlink" title="反汇编"></a>反汇编</h5><p>disassemble 简写 dis，反汇编指定地址</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(lldb) dis -a 0x0004f7c   &#x2F;&#x2F;-a 是地址</span><br><span class="line">(lldb) dis -n NSLog			  &#x2F;&#x2F;-n 需要反汇编的函数名称</span><br><span class="line">(lldb) dis -c 10 			    &#x2F;&#x2F;需要显示的指令数，10条</span><br><span class="line">(lldb) dis -s 0x1000066f4 -e 0x100006718 &#x2F;&#x2F;-s起始地址，-e结束地址</span><br></pre></td></tr></table></figure>

<h5 id="调用栈"><a href="#调用栈" class="headerlink" title="调用栈"></a>调用栈</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(lldb) bt</span><br><span class="line">(lldb) bt 2   &#x2F;&#x2F;打印2层调用栈</span><br><span class="line">frame #1 0x000001003a2260 ........</span><br></pre></td></tr></table></figure>

<p>看到 frame，1 对应地址 0x000001003a2260，用这地址减去 ASLR 的偏移量即得到文件的偏移地址</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(lldb) p&#x2F;x 0x000001003a2260 - ASLR偏移量</span><br></pre></td></tr></table></figure>

<p>将得到的地址到 IDA 查看验证调用栈的正确性</p>
<h5 id="查找-C-函数"><a href="#查找-C-函数" class="headerlink" title="查找 C 函数"></a>查找 C 函数</h5><p>利用 lookup 查找 C 函数地址</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(lldb) image lookup -r -n ptrace</span><br></pre></td></tr></table></figure>

<p>有时候闪退的时候调用栈可以看到一些地址，用 lookup 查看</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(lldb) image lookup --address 0x0000000100000de0</span><br></pre></td></tr></table></figure>



<h4 id="Chisel"><a href="#Chisel" class="headerlink" title="Chisel"></a>Chisel</h4><p>LLDB 命令插件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">brew install chisel</span><br><span class="line">安装完成提示</span><br><span class="line">&#x3D;&#x3D;&gt; Caveats</span><br><span class="line">Add the following line to ~&#x2F;.lldbinit to load chisel when Xcode launches:</span><br><span class="line">command script import &#x2F;usr&#x2F;local&#x2F;opt&#x2F;chisel&#x2F;libexec&#x2F;fblldb.py</span><br></pre></td></tr></table></figure>

<p>还需要将 LLDB 和 chisel 关联起来，给 lldbinit 注入脚本，终端执行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">echo command script import &#x2F;usr&#x2F;local&#x2F;opt&#x2F;chisel&#x2F;libexec&#x2F;fblldb.py &gt;&gt; ~&#x2F;.lldbinit</span><br></pre></td></tr></table></figure>

<h5 id="pviews"><a href="#pviews" class="headerlink" title="pviews"></a>pviews</h5><p>查看 view 层级</p>
<h5 id="pvc"><a href="#pvc" class="headerlink" title="pvc"></a>pvc</h5><p>打印 ViewController 层级</p>
<h5 id="fv-amp-fvc"><a href="#fv-amp-fvc" class="headerlink" title="fv&amp;fvc"></a>fv&amp;fvc</h5><p>通过类名搜索当前内存中存在的 view 和 viewController 实例的命令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(lldb) fv bar</span><br><span class="line">0x7fed1f413e50 CYLTabBar</span><br><span class="line">0x7fed1f4140a0 _UIBarBackground</span><br><span class="line"></span><br><span class="line">(lldb) fvc bar</span><br><span class="line">0x7fed1f880c00 CYLTabBarController</span><br></pre></td></tr></table></figure>

<h5 id="border-amp-unborder"><a href="#border-amp-unborder" class="headerlink" title="border&amp;unborder"></a>border&amp;unborder</h5><p>添加/去除边框</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(lldb) border 0x79ec3140 -c green -w 2</span><br><span class="line">(lldb) unborder 0x148d0e180</span><br></pre></td></tr></table></figure>

<h5 id="pinternals"><a href="#pinternals" class="headerlink" title="pinternals"></a>pinternals</h5><p>这个命令就是打印出来的一个控件（id）类型的内部结构</p>
<h5 id="presponder"><a href="#presponder" class="headerlink" title="presponder"></a>presponder</h5><p>打印出一个集成于UIResponder控件的消息传递链</p>
<h5 id="visualize"><a href="#visualize" class="headerlink" title="visualize"></a>visualize</h5><p>可以使用mac下的预览app打开我们的图片UIImage, CGImageRef格式的图片，甚至view和layer的图片 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(lldb) visualize 0x79ec3140&#x2F;&#x2F;或者变量名，此地址是id类型的</span><br></pre></td></tr></table></figure>

<h5 id="pclass"><a href="#pclass" class="headerlink" title="pclass"></a>pclass</h5><p>打印出一个对象的继承关系</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">UIImageView</span><br><span class="line">	| UIView</span><br><span class="line">	|    | UIResponder</span><br><span class="line">	|    |    | NSObject</span><br></pre></td></tr></table></figure>

<h5 id="hide-amp-show"><a href="#hide-amp-show" class="headerlink" title="hide&amp;show"></a>hide&amp;show</h5><p>显示隐藏对象</p>
<h5 id="pactions"><a href="#pactions" class="headerlink" title="pactions"></a>pactions</h5><p>打印控件响应事件</p>
<h5 id="methods"><a href="#methods" class="headerlink" title="methods"></a>methods</h5><p>临时查看某个类的所有方法和内存地址</p>
<h5 id="search"><a href="#search" class="headerlink" title="search"></a>search</h5><p>类似 Cycript 中的 choose 功能，搜索某个实例对象</p>
<h5 id="bmessage"><a href="#bmessage" class="headerlink" title="bmessage"></a>bmessage</h5><p>对方法名设置断点。</p>
<h5 id="pdata"><a href="#pdata" class="headerlink" title="pdata"></a>pdata</h5><p>打印 NSData 数据</p>
]]></content>
  </entry>
  <entry>
    <title>Python3网络爬虫开发实战-2.3正则表达式</title>
    <url>/2022/04/11/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-2.3%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/</url>
    <content><![CDATA[<p>正则表达式测试工具 <a href="http://tool.oschina.net/regex/">http://tool.oschina.net/regex/</a></p>
<p>常用匹配规则</p>
<table>
<thead>
<tr>
<th align="left">\w</th>
<th align="left">匹配字母、数字、下划线,等价于[a-zA-Z0-9_]</th>
</tr>
</thead>
<tbody><tr>
<td align="left">\W</td>
<td align="left">匹配不是字母、数字、下划线的其他字符</td>
</tr>
<tr>
<td align="left">\s</td>
<td align="left">匹配任意空白字符,等价于(\t\n\r\f)</td>
</tr>
<tr>
<td align="left">\S</td>
<td align="left">匹配任意非空字符</td>
</tr>
<tr>
<td align="left">\d</td>
<td align="left">匹配数字,等价于[0-9]</td>
</tr>
<tr>
<td align="left">\D</td>
<td align="left">匹配不是数字的字符</td>
</tr>
<tr>
<td align="left">\A</td>
<td align="left">匹配字符串开头</td>
</tr>
<tr>
<td align="left">\Z</td>
<td align="left">匹配字符串结尾的,如果存在换行,只匹配到换行前的结束字符串</td>
</tr>
<tr>
<td align="left">\z</td>
<td align="left">匹配字符串结尾的,如果存在换行,匹配到换行符\n</td>
</tr>
<tr>
<td align="left">\G</td>
<td align="left">最好完成匹配的位置</td>
</tr>
<tr>
<td align="left">\n</td>
<td align="left">匹配一个换行符</td>
</tr>
<tr>
<td align="left">\t</td>
<td align="left">匹配一个制表符(tab)</td>
</tr>
<tr>
<td align="left">^</td>
<td align="left">匹配一行字符串的开头</td>
</tr>
<tr>
<td align="left">$</td>
<td align="left">匹配一行字符串的结尾</td>
</tr>
<tr>
<td align="left">.</td>
<td align="left">匹配任意字符,除了换行符.当re.DOTALL标记被指定时,这可以匹配包括换行符在内的任字符</td>
</tr>
<tr>
<td align="left">[…]</td>
<td align="left">用来表示一组字符,比如[abc]表示匹配a或b或c,[a-z],[0-9]</td>
</tr>
<tr>
<td align="left">[^…]</td>
<td align="left">匹配不在[]里面的字符,比如[^abc]匹配除a,b,c以外的字符</td>
</tr>
<tr>
<td align="left">*</td>
<td align="left">匹配0个或多个字符</td>
</tr>
<tr>
<td align="left">+</td>
<td align="left">匹配1个或多个字符</td>
</tr>
<tr>
<td align="left">?</td>
<td align="left">匹配0个或1个前面的正则表达式片段,(.*?)表示尽可能少地匹配字符</td>
</tr>
<tr>
<td align="left">{n}</td>
<td align="left">匹配前面表达式n次, 如\d{5}表示匹配5个数字</td>
</tr>
<tr>
<td align="left">{n,m}</td>
<td align="left">匹配前面的表达式n到m次,贪婪模式</td>
</tr>
<tr>
<td align="left">a|b</td>
<td align="left">匹配a或者b</td>
</tr>
<tr>
<td align="left">(…)</td>
<td align="left">匹配括号里的表达式,也可以表示一个组</td>
</tr>
</tbody></table>
<h5 id="match-从开头匹配"><a href="#match-从开头匹配" class="headerlink" title="match 从开头匹配"></a>match 从开头匹配</h5><p>match() 方法可以得到匹配到的字符串内容</p>
<p>传入匹配字符串及正则表达式，match 会从字符串起始位置开始匹配正则表达式，如果匹配返回匹配成功的结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">content = <span class="string">&#x27;Hello 123 4567 World_This is a Regex Demo&#x27;</span></span><br><span class="line">print(<span class="built_in">len</span>(content))</span><br><span class="line">result = re.match(<span class="string">&#x27;^Hello\s\d\d\d\s\d&#123;4&#125;\s\w&#123;10&#125;&#x27;</span>, content)</span><br><span class="line">print(result)</span><br><span class="line">print(result.group())</span><br><span class="line">print(result.span())</span><br><span class="line"><span class="comment"># 结果</span></span><br><span class="line"><span class="comment">#41</span></span><br><span class="line"><span class="comment">#&lt;re.Match object; span=(0, 25), match=&#x27;Hello 123 4567 World_This&#x27;&gt;</span></span><br><span class="line"><span class="comment">#Hello 123 4567 World_This</span></span><br><span class="line"><span class="comment">#(0, 25)</span></span><br></pre></td></tr></table></figure>

<p>^ 匹配字符串开头；\s 匹配空白字符串；\d 匹配数字，3个\d 匹配123；\d{4}，{4}代表匹配前面规则4次，4个数字；\w{10} 匹配 10 个字母数字及下划线</p>
<p>group() 方法输出匹配内容，span() 方法输出匹配的范围</p>
<h5 id="匹配目标-group-x"><a href="#匹配目标-group-x" class="headerlink" title="匹配目标 group(x)"></a>匹配目标 group(x)</h5><p>用 match() 方法可以得到匹配到的字符串内容，如果要从字符串中提取一部分内容。</p>
<p>使用 （） 括号将想提取的字符串括起来，调用 group() 方法提取结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">content = <span class="string">&#x27;Hello 1234567 World This is a Regex Demo&#x27;</span></span><br><span class="line">result = re.match(<span class="string">&#x27;^Hello\s(\d+)\sWorld&#x27;</span>, content)</span><br><span class="line">print(result)</span><br><span class="line">print(result.group(<span class="number">1</span>))</span><br><span class="line">print(result.span())</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&lt;re.Match <span class="built_in">object</span>; span=(<span class="number">0</span>, <span class="number">19</span>), match=<span class="string">&#x27;Hello 1234567 World&#x27;</span>&gt;</span><br><span class="line"><span class="number">1234567</span></span><br><span class="line">(<span class="number">0</span>, <span class="number">19</span>)</span><br></pre></td></tr></table></figure>

<p>想将字符串中的 1234567 提取出来，可以将数字部分的正则表达式用括号 （\d+）括起来，然后调用 group(1) 获取匹配结果，如果后面还有（）内容，依次用 group(2) 获取</p>
<p>span 输出匹配范围</p>
<h5 id="通用匹配"><a href="#通用匹配" class="headerlink" title="通用匹配 .*"></a>通用匹配 .*</h5><p>点可以匹配任意字符（除换行符），星代表匹配前面的字符无限次，组合在一起</p>
<p>.* 匹配任意字符</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result = re.match(<span class="string">&#x27;^Hello.*Demo$&#x27;</span>, content)</span><br><span class="line">print(result.group())</span><br></pre></td></tr></table></figure>

<p>中间部分省略，最后加一个结尾字符串</p>
<p>group() 输出匹配的全部字符串</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Hello <span class="number">123</span> <span class="number">4567</span> World This <span class="keyword">is</span> a Regex Demo</span><br></pre></td></tr></table></figure>

<h5 id="贪婪与非贪婪"><a href="#贪婪与非贪婪" class="headerlink" title=".* 贪婪与非贪婪"></a>.* 贪婪与非贪婪</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">content = <span class="string">&#x27;Hello 1234567 World This is a Regex Demo&#x27;</span></span><br><span class="line">result = re.match(<span class="string">&#x27;^He.*(\d+).*Demo$&#x27;</span>, content)</span><br><span class="line">print(result.group(<span class="number">1</span>))</span><br><span class="line"><span class="comment">#结果 7</span></span><br></pre></td></tr></table></figure>

<p>依然想匹配中间数字，数字两边比较乱，省略都写成 <code> .*</code>，结果打印只有 7</p>
<p>贪婪匹配下 .* 会匹配尽可能多的字符，.*  后面\d+至少一个数字，没有指明具体多少个数字，.*  会尽可能匹配多的字符，123456 也被前面匹配了，给 \d+ 就留下一个数字7匹配，得到的内容就是 7 </p>
<p>非贪婪匹配，尽可能匹配少的字符，<code>.*?</code> 来代替 <code>.*</code> ，最后得到结果 1234567</p>
<p>所以做匹配的时候，字符串中间尽可能使用非贪婪匹配</p>
<h5 id="修饰符-例如-re-S"><a href="#修饰符-例如-re-S" class="headerlink" title="修饰符 例如 re.S"></a>修饰符 例如 re.S</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">content = <span class="string">&#x27;&#x27;&#x27;Hello 1234567 World_This</span></span><br><span class="line"><span class="string">is a Regex Demo</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">result = re.match(<span class="string">&#x27;^He.*?(\d+).*?Demo$&#x27;</span>, content)</span><br><span class="line">print(result.group(<span class="number">1</span>))</span><br><span class="line"><span class="comment">#结果 报错了</span></span><br></pre></td></tr></table></figure>

<p>在字符串中加了换行符，没有匹配到结果，又调用了 group 会报错</p>
<p>因为点（.）匹配的是除换行符之外的任意字符，遇到换行符时，.*? 就不能匹配了，导致匹配失败，只需要加一个修饰符 re.S 修正</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result = re.match(<span class="string">&#x27;^He.*?(\d+).*?Demo$&#x27;</span>, content, re.S)</span><br></pre></td></tr></table></figure>

<p>re.S 使点（.）匹配包括换行在内的所有字符</p>
<p>re.I 使匹配对大小写不敏感</p>
<p>re.M 多行匹配，影响 ^ 和 $</p>
<h5 id="转义匹配"><a href="#转义匹配" class="headerlink" title="转义匹配"></a>转义匹配</h5><p>正则匹配遇到特殊字符时，使用转义 \</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">content = <span class="string">&#x27;(百度)www.baidu.com&#x27;</span></span><br><span class="line">result = re.match(<span class="string">&#x27;\(百度\)www\.baidu\.com&#x27;</span>, content)</span><br></pre></td></tr></table></figure>

<h5 id="Search-扫描整个字符串匹配"><a href="#Search-扫描整个字符串匹配" class="headerlink" title="Search 扫描整个字符串匹配"></a>Search 扫描整个字符串匹配</h5><p>match() 是从字符串开头开始匹配的，开头不匹配，那整个匹配就失败</p>
<p>所以 match 适合用来检测某个字符串是否符合某个正则表达式的规则。</p>
<p>Search() 匹配时会扫描整个字符串，返回一个成功匹配结果</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">html = &#x27;&#x27;&#x27;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;songs-list&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">&quot;title&quot;</span>&gt;</span>经典老歌<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;introduction&quot;</span>&gt;</span>经典老歌列表<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;list&quot;</span> <span class="attr">class</span>=<span class="string">&quot;list-group&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">data-view</span>=<span class="string">&quot;2&quot;</span>&gt;</span>一路上有你<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">data-view</span>=<span class="string">&quot;7”&gt;</span></span></span><br><span class="line"><span class="tag"><span class="string">    &lt;a href=&quot;</span>/<span class="attr">2.mp3</span>&quot; <span class="attr">singer</span>=<span class="string">&quot;任贤齐&quot;</span>&gt;</span>沧海一卢笑<span class="tag">&lt;/<span class="name">a</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">data-view</span>=<span class="string">&quot;4&quot;</span> <span class="attr">class</span>=<span class="string">&quot;active&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/3.mp3&quot;</span> <span class="attr">singer</span>=<span class="string">&quot;齐秦&quot;</span>&gt;</span>往事随风<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">data-view</span>=<span class="string">&quot;6&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/4.mp3&quot;</span> <span class="attr">singer</span>=<span class="string">&quot;beyond&quot;</span>&gt;</span>尤辉岁月<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">data-view</span>=<span class="string">&quot;5&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/S.mp3&quot;</span> <span class="attr">singer</span>=<span class="string">&quot;陈慧琳&quot;</span>&gt;</span>记事本<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">data-view</span>=<span class="string">&quot;5&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/6.mp3&quot;</span> <span class="attr">singer</span>=<span class="string">&quot;邓丽君&quot;</span>&gt;</span>但愿人长久<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span>&#x27;&#x27;&#x27;</span><br></pre></td></tr></table></figure>

<p>尝试获取 class 为 active 的 li 节点内部超链接包含的歌手名（齐秦）和歌名（往事随风）</p>
<p>此时需要提取第三个 li 节点下 a 节点的 singer 属性和文本</p>
<p>正则表达式可以以 li 开头，寻找下一个标识符 active，中间部分用 .*<em>? 来匹配，接下来取 singer 属性值</em></p>
<p> <code>singer=&quot;(.*?)&quot;</code>  需要提取部分用小括号括起来，用 group 提取，两侧的边界是双引号</p>
<p>接下来匹配 a 节点文本，左边界是  <code>&gt;</code>  右边界是 <code>&lt;/a&gt;</code> 目标内容用 <code>.*?</code> 匹配</p>
<p>正则表达式：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;li.*?active.*?singer=&quot;(.*?)&quot;&gt;(.*?)&lt;/a&gt;</span><br></pre></td></tr></table></figure>

<p>然后再调用 search() 方法，就会搜索整个 html 文本找到符合正则表达式的第一个内容返回，由于代码有换行，需要加入 re.S 参数，匹配包括换行在内的所有参数，由于绝大多数 HTML 文本都带有换行符，所以尽量加上 re.S 参数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result = re.search(<span class="string">&#x27;&lt;li.*?active.*?singer=&quot;(.*?)&quot;&gt;(.*?)&lt;/a&gt;&#x27;</span>, html, re.S)</span><br><span class="line"><span class="keyword">if</span> result:</span><br><span class="line">	print(result.group(<span class="number">1</span>), result.group(<span class="number">2</span>))</span><br></pre></td></tr></table></figure>

<h5 id="findall-匹配返回所有"><a href="#findall-匹配返回所有" class="headerlink" title="findall 匹配返回所有"></a>findall 匹配返回所有</h5><p>search 返回匹配正则表达式第一个内容，想要匹配所有内容使用 findall() ，会搜索整个字符串，然后返回匹配正则表达式的所有内容</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">results = re.findall(<span class="string">&#x27;&lt;li.*?href=&quot;(.*?)&quot;.*?singer=&quot;(.*?)&quot;&gt;(.*?)&lt;/a&gt;&#x27;</span>, html, re.S)</span><br><span class="line">print(<span class="built_in">type</span>(results))</span><br><span class="line"><span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">	print(result[<span class="number">0</span>], result[<span class="number">1</span>], result[<span class="number">2</span>])</span><br></pre></td></tr></table></figure>

<p>返回的每个元素都是元组类型，用对应索引依次取出</p>
<h5 id="sub-修改文本"><a href="#sub-修改文本" class="headerlink" title="sub 修改文本"></a>sub 修改文本</h5><p>修改文本，把一串字符串中的数字去掉</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">content = <span class="string">&#x27;54aKS4yrsoiRS4ix5L2g&#x27;</span></span><br><span class="line">content = re.sub(<span class="string">&#x27;\d+&#x27;</span>,<span class="string">&#x27;&#x27;</span>, content)</span><br></pre></td></tr></table></figure>

<p>第一个参数\d+匹配所有的数字，第二个参数为替换成的字符串，第三个参数是原字符串</p>
<p>上面 html 中需要获取歌名，直接正则表达式提取比较麻烦</p>
<p>借助 sub 方法将 a 节点去掉只留下文本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">html = re.sub(<span class="string">&#x27;&lt;a.*?&gt;|&lt;/a&gt;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, html)</span><br><span class="line">print(html)</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;songs-list&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span> <span class="attr">class</span>=<span class="string">&quot;title&quot;</span>&gt;</span>经典老歌<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;introduction&quot;</span>&gt;</span>经典老歌列表<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">&quot;list&quot;</span> <span class="attr">class</span>=<span class="string">&quot;list-group&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">li</span> <span class="attr">data-view</span>=<span class="string">&quot;2&quot;</span>&gt;</span>一路上有你<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">li</span> <span class="attr">data-view</span>=<span class="string">&quot;7”&gt;</span></span></span><br><span class="line"><span class="tag"><span class="string">		沧海一卢笑 </span></span></span><br><span class="line"><span class="tag"><span class="string">	&lt;/li&gt;</span></span></span><br><span class="line"><span class="tag"><span class="string">	&lt;li data-view=&quot;</span><span class="attr">4</span>&quot; <span class="attr">class</span>=<span class="string">&quot;active&quot;</span>&gt;</span></span><br><span class="line">		往事随风</span><br><span class="line">	<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">li</span> <span class="attr">data-view</span>=<span class="string">&quot;6&quot;</span>&gt;</span>尤辉岁月<span class="tag">&lt;/<span class="name">li</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;<span class="name">li</span> <span class="attr">data-view</span>=<span class="string">&quot;5&quot;</span>&gt;</span>记事本<span class="tag">&lt;/<span class="name">li</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;<span class="name">li</span> <span class="attr">data-view</span>=<span class="string">&quot;5&quot;</span>&gt;</span></span><br><span class="line">		但愿人长久</span><br><span class="line">	<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>再利用 findall 提取</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">results = re.findall(<span class="string">&#x27;&lt;li.*?&gt;(.*?)&lt;/li&gt;&#x27;</span>, html, re.S)</span><br><span class="line"><span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">	print(result.strip())</span><br></pre></td></tr></table></figure>

<p>strip 移除字符串首尾指定字符 strip() 去除首尾空格，strip(‘0’) 去除首尾字符 0</p>
<h5 id="compile"><a href="#compile" class="headerlink" title="compile"></a>compile</h5><p>将正则字符串编译成正则表达式对象，以便在后面的匹配中复用</p>
<p>想把3个日期中的时间去掉，没必要重复写3个同样的正则表达式</p>
<p>通过 compile 编译成正则表达式对象，后面就不用重复写正则表达式，直接复用正则表达式对象</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">content1 = <span class="string">&#x27;2016-12-15 12:00&#x27;</span></span><br><span class="line">content2 = <span class="string">&#x27;2016-12-17 12:55&#x27;</span></span><br><span class="line">content3 = <span class="string">&#x27;2016-12-22 13:21&#x27;</span></span><br><span class="line">pattern = re.<span class="built_in">compile</span>(<span class="string">&#x27;\d&#123;2&#125;:\d&#123;2&#125;&#x27;</span>)</span><br><span class="line">result1 = re.sub(pattern, <span class="string">&#x27;&#x27;</span>, content1)</span><br><span class="line">result2 = re.sub(pattern, <span class="string">&#x27;&#x27;</span>, content2)</span><br><span class="line">result3 = re.sub(pattern, <span class="string">&#x27;&#x27;</span>, content3)</span><br><span class="line">print(result1, result2, result3)</span><br></pre></td></tr></table></figure>







]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Python3网络爬虫开发实战-5Ajax数据爬取</title>
    <url>/2022/04/13/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-5Ajax%E6%95%B0%E6%8D%AE%E7%88%AC%E5%8F%96/</url>
    <content><![CDATA[<h4 id="5-Ajax-数据爬取"><a href="#5-Ajax-数据爬取" class="headerlink" title="5. Ajax 数据爬取"></a>5. Ajax 数据爬取</h4><p>有些网页原始的 HTML 文档不会包含任何数据，数据都是通过 Ajax 统一加载后再呈现出来。</p>
<p>遇到这种页面，直接利用 requests 等库来抓取原始页面，是无法获取到有效数据的</p>
<p>Ajax 是利用 JavaScript 在保证页面不被刷新、页面链接不改变的情况下与服务器交换数据并更新部分网页的技术</p>
<p>例子：如微博页面，分页加载微博内容，这个过程就是 Ajax 加载的过程，页面并没有刷新，网页却多了新的内容</p>
<h5 id="5-2-Ajax-分析方法"><a href="#5-2-Ajax-分析方法" class="headerlink" title="5.2 Ajax 分析方法"></a>5.2 Ajax 分析方法</h5><ol>
<li>查看请求</li>
</ol>
<p>Chrome 打开微博链接 <a href="https://m.weibo.cn/u/2830678474">https://m.weibo.cn/u/2830678474</a></p>
<p>页面中鼠标右键选择检查选项，弹出开发者工具</p>
<p>切换到 Network 选项卡，重新刷新页面，出现非常多的条目</p>
<p>Ajax 其实是特殊的请求类型，叫作 xhr</p>
<p>找到 Type 为 xhr 的就是 Ajax 请求，点击请求查看详细信息，Request Headers 中有一个信息为 X-Requested-With:XMLHttpRequest，这就标记了此请求是 Ajax 请求</p>
<ol start="2">
<li>过滤请求</li>
</ol>
<p>Chrome 开发者工具筛选点击 XHR 筛选出所有 Ajax 请求</p>
<h5 id="5-3-Ajax-结果提取"><a href="#5-3-Ajax-结果提取" class="headerlink" title="5.3 Ajax 结果提取"></a>5.3 Ajax 结果提取</h5><p>模拟 Ajax 请求，将前10页微博爬取下来</p>
<p>代码地址 <a href="https://github.com/Python3WebSpider/WeiboList">https://github.com/Python3WebSpider/WeiboList</a></p>
<p>查看请求链接</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">第一页</span><br><span class="line">https://m.weibo.cn/api/container/getIndex?type=uid&amp;value=2830678474&amp;containerid=1076032830678474</span><br><span class="line">第一页返回数据</span><br><span class="line">...</span><br><span class="line"><span class="string">&quot;cardlistInfo&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;containerid&quot;</span>: <span class="string">&quot;1076032830678474&quot;</span>,</span><br><span class="line">    <span class="string">&quot;v_p&quot;</span>: <span class="number">42</span>,</span><br><span class="line">    <span class="string">&quot;show_style&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;total&quot;</span>: <span class="number">2488</span>,</span><br><span class="line">    <span class="string">&quot;since_id&quot;</span>: <span class="number">4751617833832728</span></span><br><span class="line">&#125;</span><br><span class="line">第二页</span><br><span class="line"> https://m.weibo.cn/api/container/getIndex?type=uid&amp;value=2830678474&amp;containerid=1076032830678474&amp;since_id=4755918556758808</span><br></pre></td></tr></table></figure>

<p>第二页的 since_id 请求参数是第一页返回的</p>
<p>需要把第一页返回数据中的 since_id 保存，在请求第二页的时候使用</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pyquery <span class="keyword">import</span> PyQuery <span class="keyword">as</span> pq</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> pymongo <span class="keyword">import</span> MongoClient</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">since_id = <span class="string">&#x27;&#x27;</span></span><br><span class="line">client = MongoClient()</span><br><span class="line">db = client[<span class="string">&#x27;weibo&#x27;</span>]</span><br><span class="line">collection = db[<span class="string">&#x27;weibo&#x27;</span>]</span><br><span class="line">max_page = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_to_mongo</span>(<span class="params"><span class="built_in">dict</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> collection.insert_one(<span class="built_in">dict</span>):</span><br><span class="line">        print(<span class="string">&#x27;Save to Mongo&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_to_local</span>(<span class="params"><span class="built_in">dict</span></span>):</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;weibo.json&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        file.write(json.dumps(<span class="built_in">dict</span>, indent=<span class="number">2</span>, ensure_ascii=<span class="literal">False</span>))</span><br><span class="line">        file.write(<span class="string">&#x27;\n&#x27;</span> + <span class="string">&#x27;=&#x27;</span> * <span class="number">50</span> + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_page</span>(<span class="params">json</span>):</span></span><br><span class="line">    <span class="keyword">if</span> json:</span><br><span class="line">        items = json.get(<span class="string">&#x27;data&#x27;</span>).get(<span class="string">&#x27;cards&#x27;</span>)</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">            item = item.get(<span class="string">&#x27;mblog&#x27;</span>)</span><br><span class="line">            weibo = &#123;&#125;</span><br><span class="line">            weibo[<span class="string">&#x27;id&#x27;</span>] = item.get(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">            weibo[<span class="string">&#x27;text&#x27;</span>] = pq(item.get(<span class="string">&#x27;text&#x27;</span>)).text()<span class="comment">#去除HTML标签</span></span><br><span class="line">            weibo[<span class="string">&#x27;attitudes&#x27;</span>] = item.get(<span class="string">&#x27;attitudes_count&#x27;</span>)</span><br><span class="line">            weibo[<span class="string">&#x27;comments&#x27;</span>] = item.get(<span class="string">&#x27;comments_count&#x27;</span>)</span><br><span class="line">            weibo[<span class="string">&#x27;reposts&#x27;</span>] = item.get(<span class="string">&#x27;reposts_count&#x27;</span>)</span><br><span class="line">            <span class="keyword">yield</span> weibo <span class="comment">#将weibo以generator返回</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_page</span>():</span></span><br><span class="line">    <span class="keyword">global</span> since_id <span class="comment"># 声明全局变量</span></span><br><span class="line">    base_url = <span class="string">&#x27;https://m.weibo.cn/api/container/getIndex?type=uid&amp;value=2830678474&amp;containerid=1076032830678474&#x27;</span></span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;uid&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;value&#x27;</span>: <span class="string">&#x27;2830678474&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;containerid&#x27;</span>: <span class="string">&#x27;1076032830678474&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> since_id != <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        params[<span class="string">&#x27;since_id&#x27;</span>] = since_id</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.75 Safari/537.36&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    result = requests.get(base_url, params=params, headers=headers)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> result.status_code == <span class="number">200</span>:</span><br><span class="line">            jsonRes = result.json()</span><br><span class="line">            info = jsonRes.get(<span class="string">&#x27;data&#x27;</span>).get(<span class="string">&#x27;cardlistInfo&#x27;</span>)</span><br><span class="line">            since_id = info[<span class="string">&#x27;since_id&#x27;</span>]</span><br><span class="line">            <span class="keyword">return</span> jsonRes</span><br><span class="line">    <span class="keyword">except</span> requests.ConnectionError <span class="keyword">as</span> e:</span><br><span class="line">        print(e.args)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(max_page):</span><br><span class="line">        data = get_page()</span><br><span class="line">        results = parse_page(data)</span><br><span class="line">        <span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">            save_to_mongo(result)</span><br><span class="line">            <span class="comment"># print(type(result),result)</span></span><br><span class="line">            <span class="comment"># save_to_local(result) #保存到本地文件</span></span><br></pre></td></tr></table></figure>

<p>保存数据到本地</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_to_local</span>(<span class="params"><span class="built_in">dict</span></span>):</span></span><br><span class="line">  <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;weibo.json&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">      file.write(json.dumps(<span class="built_in">dict</span>, indent=<span class="number">2</span>, ensure_ascii=<span class="literal">False</span>))</span><br><span class="line">      file.write(<span class="string">&#x27;\n&#x27;</span> + <span class="string">&#x27;=&#x27;</span> * <span class="number">50</span> + <span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>保存数据到MongoDB</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_to_mongo</span>(<span class="params"><span class="built_in">dict</span></span>):</span></span><br><span class="line">  <span class="keyword">if</span> collection.insert_one(<span class="built_in">dict</span>):</span><br><span class="line">      print(<span class="string">&#x27;Save to Mongo&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h5 id="5-4-分析-Ajax-爬取今日头条街拍美图"><a href="#5-4-分析-Ajax-爬取今日头条街拍美图" class="headerlink" title="5.4 分析 Ajax 爬取今日头条街拍美图"></a>5.4 分析 Ajax 爬取今日头条街拍美图</h5><p>链接有变动，查看最新代码 <a href="https://github.com/Python3WebSpider/Jiepai">https://github.com/Python3WebSpider/Jiepai</a></p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Python3网络爬虫开发实战-9代理的使用</title>
    <url>/2022/04/21/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-9%E4%BB%A3%E7%90%86%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>如果本机有相关代理软件的话，软件一般会在本机创建 HTTP 或 SOCKS 代理服务</p>
<p>只要设置了代理，就可以成功将本机 IP 切换到代理软件连接的服务器的 IP 了</p>
<p>设置代理后测试网址 <a href="http://httpbin.org/get">http://httpbin.org/get</a></p>
<h4 id="9-1-代理设置"><a href="#9-1-代理设置" class="headerlink" title="9.1 代理设置"></a>9.1 代理设置</h4><h5 id="urllib"><a href="#urllib" class="headerlink" title="urllib"></a>urllib</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.error <span class="keyword">import</span> URLError</span><br><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> ProxyHandler, build_opener</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  proxy = <span class="string">&#x27;183.172.236.158:10080&#x27;</span></span><br><span class="line">  proxy_handler = ProxyHandler(&#123;</span><br><span class="line">      <span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;http://&#x27;</span> + proxy,</span><br><span class="line">      <span class="string">&#x27;https&#x27;</span>: <span class="string">&#x27;https://&#x27;</span> + proxy</span><br><span class="line">  &#125;)</span><br><span class="line">  opener = build_opener(proxy_handler)</span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">      response = opener.<span class="built_in">open</span>(<span class="string">&#x27;http://httpbin.org/get&#x27;</span>)</span><br><span class="line">      print(response.read().decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">  <span class="keyword">except</span> URLError <span class="keyword">as</span> e:</span><br><span class="line">      print(e.reason)</span><br></pre></td></tr></table></figure>

<p>使用 ProxyHandler 设置代理</p>
<p>结果，origin 字段标明了客户端的 IP</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;args&quot;: &#123;&#125;, </span><br><span class="line">  &quot;headers&quot;: &#123;</span><br><span class="line">    &quot;Accept-Encoding&quot;: &quot;identity&quot;, </span><br><span class="line">    &quot;Host&quot;: &quot;httpbin.org&quot;, </span><br><span class="line">    &quot;User-Agent&quot;: &quot;Python-urllib&#x2F;3.8&quot;, </span><br><span class="line">    &quot;X-Amzn-Trace-Id&quot;: &quot;Root&#x3D;1-6260b354-5d0a11da29ddab260babe279&quot;</span><br><span class="line">  &#125;, </span><br><span class="line">  &quot;origin&quot;: &quot;183.172.236.158&quot;, </span><br><span class="line">  &quot;url&quot;: &quot;http:&#x2F;&#x2F;httpbin.org&#x2F;get&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果是需要认证的代理，只需要在代理前面加入代理认证的用户名和密码即可，将上面的 proxy 变量改成</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">proxy &#x3D; &#39;username:password@183.172.236.158:10080&#39;</span><br></pre></td></tr></table></figure>

<p>如果代理是 SOCKS5 类型</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.error <span class="keyword">import</span> URLError</span><br><span class="line"><span class="keyword">import</span> socks</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line">socks.set_default_proxy(socks.SOCKS5, <span class="string">&#x27;183.172.236.158&#x27;</span>, <span class="string">&#x27;10080&#x27;</span>)</span><br><span class="line">socket.socket = socks.socksocket</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = request.urlopen(<span class="string">&#x27;http://httpbin.org/get&#x27;</span>)</span><br><span class="line">    print(response.read().decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"><span class="keyword">except</span> URLError <span class="keyword">as</span> e:</span><br><span class="line">    print(e.reason)</span><br></pre></td></tr></table></figure>

<p>此处需要一个 socks 模块</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install PySocks</span><br></pre></td></tr></table></figure>

<p>如果本地有一个 SOCKS5代理，运行在 10080 端口，运行成功和上面是一样的</p>
<h5 id="requests"><a href="#requests" class="headerlink" title="requests"></a>requests</h5><p>只需要传入 proxies 即可</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">proxy = <span class="string">&#x27;183.172.236.158:10080&#x27;</span></span><br><span class="line"><span class="comment">#如果需要认证，改成 proxy = &#x27;username:password@183.172.236.158:10080&#x27;</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;http://&#x27;</span> + proxy,</span><br><span class="line">    <span class="string">&#x27;https&#x27;</span>: <span class="string">&#x27;https://&#x27;</span> + proxy</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = requests.get(<span class="string">&#x27;http://httpbin.org/get&#x27;</span>, proxies=proxies)</span><br><span class="line">    print(response.text)</span><br><span class="line"><span class="keyword">except</span> requests.exceptions.ConnectionError <span class="keyword">as</span> e:</span><br><span class="line">    print(<span class="string">&#x27;Error&#x27;</span>, e.args)</span><br></pre></td></tr></table></figure>

<p>如果需要使用 SOCKS5代理，将 proxies 改成</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">proxy = <span class="string">&#x27;183.172.236.158:10080&#x27;</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;socks5&#x27;</span> + proxy,</span><br><span class="line">    <span class="string">&#x27;https&#x27;</span>: <span class="string">&#x27;socks5&#x27;</span> + proxy</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要额外安装一个模块，叫作 requests[socks]</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install &#39;requests[socks]&#39;</span><br></pre></td></tr></table></figure>

<p>还有一种设置方式，和 urllib 中的方法相同，相比第一种方法，此方法是全局设置的</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> socks</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">socks.set_default_proxy(socks.SOCKS5, <span class="string">&#x27;183.172.236.158&#x27;</span>, <span class="string">&#x27;10080&#x27;</span>)</span><br><span class="line">socket.socket = socks.socksocket</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = requests.get(<span class="string">&#x27;http://httpbin.org/get&#x27;</span>)</span><br><span class="line">    print(response.read().decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"><span class="keyword">except</span> URLError <span class="keyword">as</span> e:</span><br><span class="line">    print(e.reason)</span><br></pre></td></tr></table></figure>

<h5 id="httpx"><a href="#httpx" class="headerlink" title="httpx"></a>httpx</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> httpx</span><br><span class="line">proxy = <span class="string">&#x27;127.0.0.1:7890&#x27;</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">&#x27;http://&#x27;</span>: <span class="string">&#x27;http://&#x27;</span> + proxy,</span><br><span class="line">    <span class="string">&#x27;https://&#x27;</span>: <span class="string">&#x27;https://&#x27;</span> + proxy</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">with</span> httpx.Client(proxies=proxies) <span class="keyword">as</span> client:</span><br><span class="line">  response = client.get(<span class="string">&#x27;https://www.httpbin.org/get&#x27;</span>)</span><br><span class="line">  print(response.text)</span><br></pre></td></tr></table></figure>



<h5 id="Selenium"><a href="#Selenium" class="headerlink" title="Selenium"></a>Selenium</h5><p>Chrome、PhantomJS</p>
<h6 id="Chrome"><a href="#Chrome" class="headerlink" title="Chrome"></a>Chrome</h6><p>通过 ChromeOptions 来设置代理，创建 Chrome 对象使用 options 参数传递即可</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">proxy = <span class="string">&#x27;101.132.189.87:9090&#x27;</span></span><br><span class="line">chrome_options = webdriver.ChromeOptions()</span><br><span class="line">chrome_options.add_argument(<span class="string">&#x27;--proxy-server=http://&#x27;</span> + proxy)</span><br><span class="line">browser = webdriver.Chrome(options=options)</span><br><span class="line">browser.get(<span class="string">&#x27;http://httpbin.org/get&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>如果是认证代理，设置会比较麻烦</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.chrome.options <span class="keyword">import</span> Options</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"></span><br><span class="line">ip = <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">port = <span class="number">9743</span></span><br><span class="line">username = <span class="string">&#x27;foo&#x27;</span></span><br><span class="line">password = <span class="string">&#x27;bar&#x27;</span></span><br><span class="line"></span><br><span class="line">manifest_json = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;version&quot;: &quot;1.0.0&quot;,</span></span><br><span class="line"><span class="string">    &quot;manifest_version&quot;: 2,</span></span><br><span class="line"><span class="string">    &quot;name&quot;: &quot;Chrome Proxy&quot;,</span></span><br><span class="line"><span class="string">    &quot;permissions&quot;: [</span></span><br><span class="line"><span class="string">        &quot;proxy&quot;,</span></span><br><span class="line"><span class="string">        &quot;tabs&quot;,</span></span><br><span class="line"><span class="string">        &quot;unlimitedStorage&quot;,</span></span><br><span class="line"><span class="string">        &quot;storage&quot;,</span></span><br><span class="line"><span class="string">        &quot;&lt;all_urls&gt;&quot;,</span></span><br><span class="line"><span class="string">        &quot;webRequest&quot;,</span></span><br><span class="line"><span class="string">        &quot;webRequestBlocking&quot;</span></span><br><span class="line"><span class="string">    ],</span></span><br><span class="line"><span class="string">    &quot;background&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;scripts&quot;: [&quot;background.js&quot;]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">background_js = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">var config = &#123;</span></span><br><span class="line"><span class="string">        mode: &quot;fixed_servers&quot;,</span></span><br><span class="line"><span class="string">        rules: &#123;</span></span><br><span class="line"><span class="string">          singleProxy: &#123;</span></span><br><span class="line"><span class="string">            scheme: &quot;http&quot;,</span></span><br><span class="line"><span class="string">            host: &quot;%(ip)s&quot;,</span></span><br><span class="line"><span class="string">            port: %(port)s</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">chrome.proxy.settings.set(&#123;value: config, scope: &quot;regular&quot;&#125;, function() &#123;&#125;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">function callbackFn(details) &#123;</span></span><br><span class="line"><span class="string">    return &#123;</span></span><br><span class="line"><span class="string">        authCredentials: &#123;</span></span><br><span class="line"><span class="string">            username: &quot;%(username)s&quot;,</span></span><br><span class="line"><span class="string">            password: &quot;%(password)s&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">chrome.webRequest.onAuthRequired.addListener(</span></span><br><span class="line"><span class="string">            callbackFn,</span></span><br><span class="line"><span class="string">            &#123;urls: [&quot;&lt;all_urls&gt;&quot;]&#125;,</span></span><br><span class="line"><span class="string">            [&#x27;blocking&#x27;]</span></span><br><span class="line"><span class="string">)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span> % &#123;<span class="string">&#x27;ip&#x27;</span>: ip, <span class="string">&#x27;port&#x27;</span>: port, <span class="string">&#x27;username&#x27;</span>: username, <span class="string">&#x27;password&#x27;</span>: password&#125;</span><br><span class="line"></span><br><span class="line">plugin_file = <span class="string">&#x27;proxy_auth_plugin.zip&#x27;</span></span><br><span class="line"><span class="keyword">with</span> zipfile.ZipFile(plugin_file, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> zp:</span><br><span class="line">    zp.writestr(<span class="string">&quot;manifest.json&quot;</span>, manifest_json)</span><br><span class="line">    zp.writestr(<span class="string">&quot;background.js&quot;</span>, background_js)</span><br><span class="line">chrome_options = Options()</span><br><span class="line">chrome_options.add_argument(<span class="string">&quot;--start-maximized&quot;</span>)</span><br><span class="line">chrome_options.add_extension(plugin_file)</span><br><span class="line">browser = webdriver.Chrome(chrome_options=chrome_options)</span><br><span class="line">browser.get(<span class="string">&#x27;http://httpbin.org/get&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>需要创建 manifest.json 配置文件和 background.js 脚本来设置代理，运行代码后会生成一个 proxy_auth_plugin.zip 文件来保存当前配置</p>
<h6 id="PhantomJS"><a href="#PhantomJS" class="headerlink" title="PhantomJS"></a>PhantomJS</h6><p><del>设置代理可以借助 service_args 参数，也就是命令行参数</del></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">module &#39;selenium.webdriver&#39; has no attribute &#39;PhantomJS&#39;</span><br></pre></td></tr></table></figure>

<p>不支持了</p>
<h5 id="aiohttp-代理设置"><a href="#aiohttp-代理设置" class="headerlink" title="aiohttp 代理设置"></a>aiohttp 代理设置</h5><h5 id="Pyppeteer代理设置"><a href="#Pyppeteer代理设置" class="headerlink" title="Pyppeteer代理设置"></a>Pyppeteer代理设置</h5><h5 id="Playwright代理设置"><a href="#Playwright代理设置" class="headerlink" title="Playwright代理设置"></a>Playwright代理设置</h5><h4 id="9-2-代理池的维护"><a href="#9-2-代理池的维护" class="headerlink" title="9.2 代理池的维护"></a>9.2 代理池的维护</h4><h5 id="存储模块"><a href="#存储模块" class="headerlink" title="存储模块"></a>存储模块</h5><p>存储抓取下来的代理，这里用 Redis 的有序集合，集合中每一个元素都是不重复的</p>
<h5 id="获取模块"><a href="#获取模块" class="headerlink" title="获取模块"></a>获取模块</h5><p>需要定时在各大代理网站抓取代理</p>
<h5 id="检测模块"><a href="#检测模块" class="headerlink" title="检测模块"></a>检测模块</h5><p>需要定时检测数据库中的代理</p>
<p>使用异步请求库 aiohttp 来进行检测</p>
<h5 id="接口模块"><a href="#接口模块" class="headerlink" title="接口模块"></a>接口模块</h5><p>用 API 来提供对外服务的接口</p>
<p>为了使代理池可以作为一个独立服务运行，最好增加一个接口模块，并以 WebAPI的形式暴露可用代理</p>
<h5 id="调度模块"><a href="#调度模块" class="headerlink" title="调度模块"></a>调度模块</h5><p>调用上面定义的模块，将上面模块通过多进程的形式运行起来</p>
<h4 id="9-3-付费代理"><a href="#9-3-付费代理" class="headerlink" title="9.3 付费代理"></a>9.3 付费代理</h4><p>讯代理 <a href="http://www.xdaili.cn/">http://www.xdaili.cn</a></p>
<p>阿布云代理 <a href="https://www.abuyun.com/">https://www.abuyun.com</a></p>
<h4 id="9-4-ADSL拨号代理"><a href="#9-4-ADSL拨号代理" class="headerlink" title="9.4 ADSL拨号代理"></a>9.4 ADSL拨号代理</h4><p>ADSL 通过拨号的方式上网，需要输入 ADSL 账号和密码，每次拨号就更换一个 IP，如果将 ADSL 主机作为代理，每隔一段时间主机拨号就换一个 IP，这样可以有效防止 IP 被封，主机稳定性好，代理响应速度很快</p>
<h5 id="购买主机"><a href="#购买主机" class="headerlink" title="购买主机"></a>购买主机</h5><p>购买动态拨号 VPS 主机</p>
<p>阿斯云 <a href="https://asiyun.cn/">https://asiyun.cn</a></p>
<p>云立方 <a href="http://www.yunlifang.cn/dynamicvps.asp">http://www.yunlifang.cn/dynamicvps.asp</a></p>
<p>建议选择电信线路，可以自行选择主机配置</p>
<p>推荐安装 CentOS 7 Linux 系统</p>
<p>找到远程管理面板-远程连接用户名和密码，也就是 SSH 远程连接服务器</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ssh root@xxx.xx.xx.xx -p xxx</span><br></pre></td></tr></table></figure>

<p>输入管理密码，就可以连接上远程服务器了</p>
<p>进入后有个可用的脚本文件 ppp.sh，这是拨号初始化的脚本</p>
<p>运行 ppp.sh 脚本，输入用户名、密码等待它的配置完成</p>
<p>输入拨号命令 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adsl-start</span><br></pre></td></tr></table></figure>

<p>运行成功后就可以去试 ping 外网了</p>
<p>停止拨号</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">adsl-stop</span><br></pre></td></tr></table></figure>

<p>阿斯云拨号命令 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pppoe-start</span><br><span class="line">pppoe-stor</span><br></pre></td></tr></table></figure>



<p>断线重播的命令就是两个命令组合起来，每次拨号，ifconfig 查看主机 IP，发现主机 IP 一直在变化</p>
<h5 id="设置代理服务器"><a href="#设置代理服务器" class="headerlink" title="设置代理服务器"></a>设置代理服务器</h5><p>Linux 下搭建 HTTP 代理服务器，推荐 TinyProxy 和 Squid</p>
<h6 id="TinyProxy"><a href="#TinyProxy" class="headerlink" title="TinyProxy"></a>TinyProxy</h6><p>这里以 TinyProxy 为例</p>
<ul>
<li>安装 TinyProxy</li>
</ul>
<p>CentOS 系统使用 yum 来安装，其它系统如 Ubuntu，可以选择 apt-get 等命令安装</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install -y epel-release</span><br><span class="line">yum update -y</span><br><span class="line">yum install -y tinyproxy</span><br></pre></td></tr></table></figure>

<ul>
<li>配置 TinyProxy</li>
</ul>
<p>TinyProxy 安装完成后还要配置一下才可以用作代理服务器，需要编辑配置文件</p>
<p>/etc/tinyproxy/tinyproxy.conf</p>
<p><code>Port 8888</code>  这里可以设置代理的端口，默认 8888</p>
<p>继续找到代码  <code>Allow 127.0.0.1</code> 这行代码表示被允许连接的主机 IP，如果希望连接任何主机，这行代码注释即可，这里选择注释，也就是任何主机都可以使用这台主机作为代理服务器</p>
<p>设置完成后重启 TinyProxy 即可</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl enable tinyproxy.service</span><br><span class="line">systemctl restart tinyproxy.service</span><br></pre></td></tr></table></figure>

<p>防火墙开放该端口</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">iptables -I INPUT -p tcp --dport 8888 -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>如果想直接关闭防火墙也可以</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl stop firewalld.service</span><br></pre></td></tr></table></figure>

<ul>
<li>验证 TinyProxy</li>
</ul>
<p>先用 ifconfig 查看当前主机的 IP，比如这主机拨号 IP 为 112.88.118.212</p>
<p>其它主机运行测试下</p>
<p>用 curl 命令设置代理请求，检测代理是否生效</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl -x 112.88.118.212:8888 httpbin.org&#x2F;get</span><br></pre></td></tr></table></figure>

<p>如果有正常的结果输出，并且 origin 的值为代理 IP 就证明 TinyProxy 设置成功了</p>
<h6 id="Squid"><a href="#Squid" class="headerlink" title="Squid"></a>Squid</h6><p>安装 Squid</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo yum -y update</span><br><span class="line">yum -y install squid</span><br><span class="line"></span><br><span class="line">systemctl start squid  #启动Squid</span><br><span class="line">systemctl enable squid #开机自动启动</span><br><span class="line">systemctl status squid #查看运行状态</span><br></pre></td></tr></table></figure>

<p>默认 Squid 运行在 3128 端口</p>
<ul>
<li>开启允许外网访问</li>
</ul>
<p>修改  <code>/etc/squid/squid.conf</code></p>
<p>允许公网访问，将 <code>http_access deny all</code> 修改为 <code>http_access allow all</code></p>
<p>还需要在配置文件的开头 acl 配置的部分添加该行内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">acl all src 0.0.0.0&#x2F;0</span><br></pre></td></tr></table></figure>

<p>还可以将 Squid 配置成高度匿名代理，这样目标网站就无法从通过一些参数如 X-Forward-For 来得知爬虫机本身的 IP 了，配置文件添加</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">request_header_access Via deny all</span><br><span class="line">request_header_access X-Forwarded-For deny all</span><br></pre></td></tr></table></figure>

<p>云主机厂商可能默认封禁了 Squid 的 3128 端口，更换端口</p>
<p><code>http_port 3128</code> 修改为 <code>http_port 3328</code></p>
<p>修改完配置后保存，重启 Squid </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl restart squid</span><br></pre></td></tr></table></figure>

<p>还需要宝塔面板或者命令开放3328防火墙端口</p>
<p>云主机上运行 curl 命令测试 Squid 的代理效果</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl -x http:&#x2F;&#x2F;127.0.0.1:3328 https:&#x2F;&#x2F;httpbin.org&#x2F;get</span><br><span class="line">ifconfig</span><br></pre></td></tr></table></figure>

<p>返回 origin 字段 IP 106.45.104.166 和 ifconfig 返回的云主机 IP 一致</p>
<p>本机运行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl -x http:&#x2F;&#x2F;106.45.104.166:3328 https:&#x2F;&#x2F;httpbin.org&#x2F;get</span><br></pre></td></tr></table></figure>

<p>返回结果看到 origin 字段返回地址就是云主机 IP地址了</p>
<h5 id="存储模块-1"><a href="#存储模块-1" class="headerlink" title="存储模块"></a>存储模块</h5><p>配置一个可以公网访问的 Redis 数据库，云主机可以将自己的代理存储到对应的 Redis 数据库中</p>
<p>云主机要进行 Redis 数据库的操作，可以使用 Python 实现，先在云主机上装 Python</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum -y install python3</span><br></pre></td></tr></table></figure>

<p>自动拨号、连接 Redis 数据库、获取本机代理、设置 Redis 数据库的操作</p>
<p>使用 adslproxy 包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install adslproxy</span><br></pre></td></tr></table></figure>

<p>安装完成后使用 export 设置环境变量</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">export REDIS_HOST&#x3D;&lt;Redis数据库的地址&gt;</span><br><span class="line">export REDIS_PORT&#x3D;&lt;Redis数据库的端口&gt;</span><br><span class="line">export REDIS_PASSWORD&#x3D;&lt;Redis数据库的密码&gt;</span><br><span class="line">export PROXY_PORT&#x3D;&lt;拨号云主机配置的代理端口&gt;</span><br><span class="line">export DIAL_BASH&#x3D;&lt;拨号脚本&gt; #pppoe-stop;pppoe-start</span><br><span class="line">export DIAL_IFNAME&#x3D;&lt;网卡名称&gt; #ppp0</span><br><span class="line">export CLIENT_NAME&#x3D;&lt;云主机的唯一标识&gt;</span><br><span class="line">export DIAL_CYCLE&#x3D;&lt;拨号间隔&gt;</span><br></pre></td></tr></table></figure>

<p>运行 <code>adslproxy send</code> 拨号</p>
<h5 id="拨号模块"><a href="#拨号模块" class="headerlink" title="拨号模块"></a>拨号模块</h5><p>定时拨号</p>
<p>只需要在拨号主机上运行定时脚本，每隔一段时间拨号一次，更新 IP，然后将 IP 在 Redis  散列表中更新即可</p>
<p>接下来就是获取IP，获取拨号后的 IP，只需要 ifconfig 命令，解析出对应网卡的 IP</p>
<p>获取 IP 之后，还需要进行有效性检测。拨号主机可以自己检测，比如可以利用 requests 设置自身的代理请求外网，如果成功，那么证明代理可用，然后再修改 Redis 散列表，更新代理</p>
<p>拨号后主机是离线状态，Redis 散列表中还存留上次的代理，这代理是无法使用的，每台主机在拨号之前还需要将自身的代理从 Redis 散列表中移除</p>
<h5 id="接口模块-1"><a href="#接口模块-1" class="headerlink" title="接口模块"></a>接口模块</h5><p>利用 Tornado 的Server模块搭建 Web 接口服务</p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>iOS黑客攻防</title>
    <url>/2022/10/18/iOS%E9%BB%91%E5%AE%A2%E6%94%BB%E9%98%B2/</url>
    <content><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">
  <div class="hbe-input-container">
  <input type="password" id="hbePass" placeholder="" />
    <label for="hbePass">输入密码</label>
    <div class="bottom-line"></div>
  </div>
  <script id="hbeData" type="hbeData" data-hmacdigest="7f58432d58b7e9015cefe30d5f5a67bd795d2a081f15218638d8516d5ef07610">9bc01fc3a05077b2a02f7223ce11089be63e0850b884d2b7f2e8cd9c1ed8943f0220316878cb6d93cab29bd6bf3aac36bf5128954575073cb11ab7fd0e907b492ff3d4584caee475ec796ff3bbed520f34edb55ffb4ff775724a13f9887497e30c680f319a9594bfd62fa16aa79346824b0e61045979f71329ae51f8b770761f7974b18c1906a226fecc4c9a03fea8cfa551f64b133df31660945a7e752a686e0f78a697a248bc1229952a9f03eed8b0f7b337bbd7d446dca0dabcb04764ab62644573567b437fc8ed58fcac0b11311c2574c2f9c46b966ec1dbeae419915a8dc2785d6f674fcb4c972b2462837daeab71c278837e95b4028d07845b532dd6201ce086dde68774b11c439ad0ccac0a26d3d84a69123da85a9bce4525e85e63909add9c4e2402dd0eb6afc041fd48d35e46b482838263925666305f40460af022bfcc8d7852c049b09a6be25df3357642587423a336b8f1ebdcaaf773e50fa5d127edbd5ee19b4bff067a79d0346a0278</script>
</div>
<script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
  </entry>
  <entry>
    <title>微信小程序反编译</title>
    <url>/2022/05/30/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%8F%8D%E7%BC%96%E8%AF%91/</url>
    <content><![CDATA[<p><a href="https://juejin.cn/post/6844903603484753927">微信小程序反编译实战（一）解包</a></p>
<h4 id="frida"><a href="#frida" class="headerlink" title="frida"></a>frida</h4><p>利用 frida-trace 跟踪类的所有方法</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">frida-trace -U -f com.ss.iphone.ugc.Aweme -m &quot;-[AWEAwemeShareViewController *]&quot;</span><br></pre></td></tr></table></figure>

<h4 id="node-js安装"><a href="#node-js安装" class="headerlink" title="node.js安装"></a>node.js安装</h4><p><a href="https://nodejs.org/en/">https://nodejs.org/en/</a> 或者</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ brew install node</span><br><span class="line"></span><br><span class="line">#依赖安装</span><br><span class="line">npm install uglify-es --save</span><br><span class="line">npm install esprima  --save</span><br><span class="line">npm install css-tree  --save</span><br><span class="line">npm install cssbeautify --save</span><br><span class="line">npm install vm2  --save</span><br><span class="line">npm install uglify-es  --save</span><br><span class="line">npm install js-beautify  --save</span><br><span class="line">npm install escodegen  --save</span><br><span class="line">npm install cheerio --save</span><br></pre></td></tr></table></figure>

<h4 id="wxapkg"><a href="#wxapkg" class="headerlink" title="wxapkg"></a>wxapkg</h4><p>小程序是以 wxapkg 拓展名的文件，在微信沙盒目录下搜索 wxapkg</p>
<p>iPhone 设备微信打开小程序，打开微信沙盒目录，搜索 wxapkg 找到最新时间的 wxapkg 文件</p>
<p>导出拷贝到电脑</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;var&#x2F;mobile&#x2F;Containers&#x2F;Data&#x2F;Application&#x2F;3A176EEE-76AD-4424-8966-961834916101&#x2F;Library&#x2F;WechatPrivate&#x2F;0461325054f5668774d3cf52bc6ead7b&#x2F;WeApp&#x2F;LocalCache&#x2F;release&#x2F;wx48e51a643b3b85db</span><br></pre></td></tr></table></figure>

<ul>
<li>也可以通过安卓模拟器获取</li>
</ul>
<p>网易MuMu，开启Root权限，进入设置中心，基本设置，勾选开启Root权限</p>
<p>安装RE文件管理器和微信，打开微信进入小程序</p>
<p>RE文件管理器进入 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;data&#x2F;data&#x2F;com.tencent.mm&#x2F;MicroMsg&#x2F;&#123;一串32位16进制字符串&#125;&#x2F;appbrand&#x2F;pkg</span><br></pre></td></tr></table></figure>

<p>长按-压缩所选文件-发送</p>
<h4 id="wxapkg-解包"><a href="#wxapkg-解包" class="headerlink" title="wxapkg 解包"></a>wxapkg 解包</h4><p>node.js 脚本还原小程序源码</p>
<p>解包脚本  <a href="https://github.com/larack8/wxappUnpacker">https://github.com/larack8/wxappUnpacker</a>  </p>
<p>加个代理访问快些  <a href="https://gh.fakev.cn/larack8/wxappUnpacker">https://gh.fakev.cn/larack8/wxappUnpacker</a>  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#一键解包还原</span><br><span class="line">#自动将 wxapkg 文件解包，并将包中相关的已被编译&#x2F;混淆的文件自动恢复原状（包括目录结构）</span><br><span class="line">node .&#x2F;wuWxapkg.js &#x2F;Users&#x2F;xxx&#x2F;Desktop&#x2F;unpack&#x2F;10.wxapkg</span><br></pre></td></tr></table></figure>

<p>最后在微信开发者工具中，新建空白小程序工程，将还原后的相关目录文件导入工程，即可编译运行起来</p>
]]></content>
  </entry>
  <entry>
    <title>逆向-HOOK&amp;注入</title>
    <url>/2022/10/23/%E9%80%86%E5%90%91-HOOK&amp;%E6%B3%A8%E5%85%A5/</url>
    <content><![CDATA[<p>改变代码的执行流程，执行自己的代码</p>
<h4 id="Hook"><a href="#Hook" class="headerlink" title="Hook"></a>Hook</h4><h5 id="Method-Swizzling"><a href="#Method-Swizzling" class="headerlink" title="Method Swizzling"></a>Method Swizzling</h5><p>Objective-C 中调用一个方法，实则是向一个对象发送消息，查找消息的唯一依据是 selector 名字</p>
<p>每个类都有一个方法列表，存放着 selector 和 IMP 的映射关系。IMP 有点类似函数指针，指向具体的 Method 实现</p>
<p>利用 OC runtime 特性，动态改变 SEL 和 IMP 对应关系，达到 OC 方法调用流程改变的目的</p>
<p>method_exchangeImplementation</p>
<blockquote>
<p>ZKSwizzle 库</p>
</blockquote>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">InjectCode</span></span></span><br><span class="line">+(<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="comment">//WCAccountMainLoginViewController onNext</span></span><br><span class="line">    Method onNext = class_getInstanceMethod(objc_getClass(<span class="string">&quot;WCAccountMainLoginViewController&quot;</span>), <span class="keyword">@selector</span>(onNext));</span><br><span class="line">    Method my_next = class_getInstanceMethod(<span class="keyword">self</span>, <span class="keyword">@selector</span>(my_next));</span><br><span class="line">    method_exchangeImplementations(onNext, my_next);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//id self , SEL _cmd</span></span><br><span class="line">-(<span class="keyword">void</span>)my_next&#123;</span><br><span class="line">    <span class="built_in">NSString</span> * pwd = [[[<span class="keyword">self</span> valueForKey:<span class="string">@&quot;_textFieldUserPwdItem&quot;</span>]valueForKey:<span class="string">@&quot;m_textField&quot;</span>] performSelector:<span class="keyword">@selector</span>(text)];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;密码是！%@&quot;</span>,pwd);<span class="comment">//破坏！</span></span><br><span class="line">    <span class="comment">//self:当前方法的调用者！</span></span><br><span class="line">    [<span class="keyword">self</span> my_next];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">+(<span class="keyword">void</span>)load</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//GET &amp; SET</span></span><br><span class="line">    Method onNext = class_getInstanceMethod(objc_getClass(<span class="string">&quot;WCAccountMainLoginViewController&quot;</span>), sel_registerName(<span class="string">&quot;onNext&quot;</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//1.保存原始的IMP</span></span><br><span class="line">    old_onNext = method_getImplementation(onNext);</span><br><span class="line">    <span class="comment">//2.SET</span></span><br><span class="line">    method_setImplementation(onNext, (IMP)my_next);</span><br><span class="line">&#125;</span><br><span class="line">IMP (*old_onNext)(<span class="keyword">id</span> <span class="keyword">self</span>,SEL _cmd);</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> my_next(<span class="keyword">id</span> <span class="keyword">self</span>,SEL _cmd)&#123;</span><br><span class="line">    <span class="built_in">NSString</span> * pwd = [[[<span class="keyword">self</span> valueForKey:<span class="string">@&quot;_textFieldUserPwdItem&quot;</span>]valueForKey:<span class="string">@&quot;m_textField&quot;</span>] performSelector:<span class="keyword">@selector</span>(text)];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;密码是！%@&quot;</span>,pwd);<span class="comment">//破坏！</span></span><br><span class="line">    <span class="comment">//调用原来的方法</span></span><br><span class="line">    old_onNext(<span class="keyword">self</span>,_cmd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="MSHookMessageEx"><a href="#MSHookMessageEx" class="headerlink" title="MSHookMessageEx"></a>MSHookMessageEx</h5><p>Cydia Substrate 框架提供了 MSHookMessageEx 函数，利用运行时机制对 Objective-C 方法进行替换</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">_class：要Hook的OC方法的类名</span></span><br><span class="line"><span class="comment">message：要Hook的OC方法</span></span><br><span class="line"><span class="comment">hook：替换后的实现方法地址</span></span><br><span class="line"><span class="comment">old：原方法的地址，若无须调用原方法，可以设为NULL</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">void</span> MSHookMessageEx(Class _<span class="keyword">class</span>, SEL message, IMP hook, IMP *old)</span><br><span class="line">  </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> (*oldViewDidLoad)(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd);</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> newViewDidLoad(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd)&#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;call %s&quot;</span>, __FUNCTION__);</span><br><span class="line">  (*oldViewDidLoad)(<span class="keyword">self</span>, _cmd);</span><br><span class="line">&#125;</span><br><span class="line">MSHookMessageEx(objc_getClass(<span class="string">&quot;ViewController&quot;</span>),<span class="keyword">@selector</span>(viewDidLoad),</span><br><span class="line">               (IMP)&amp;newViewDidLoad, (IMP*)&amp;oldViewDidLoad);</span><br></pre></td></tr></table></figure>

<p>实际使用中通常不会直接使用 MSHookMessageEx Theos 的 Logos 语法已经对 MSHookMessageEx 进行了封装</p>
<h5 id="Inline-Hook"><a href="#Inline-Hook" class="headerlink" title="Inline Hook"></a>Inline Hook</h5><p>因为 C/C++ 没有运行时机制提供这些高级 API 来直接替换方法实现，所以 Method Swizzling 对它是无效的，需要使用 Inline Hook 才能达到目的。</p>
<p>修改函数的前 N 字节内存，使其跳转到自己编写的函数，这样原函数的逻辑就被新函数接管了，同时还应保存原函数的前 N 字节，以便在需要时能正确恢复原来的汇编代码从而执行原始逻辑</p>
<p>Cydia Substrate 框架提供了 MSHookFunction 函数来完成 InlineHook</p>
<h5 id="MSHookFunction"><a href="#MSHookFunction" class="headerlink" title="MSHookFunction"></a>MSHookFunction</h5><figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">symbol：需要hook的地址，该地址不局限于函数头，也可以是函数内部的任意地址</span></span><br><span class="line"><span class="comment">hook：替换后的函数地址</span></span><br><span class="line"><span class="comment">old：保存被Hook函数的原始代码，若不需要调用原函数，可以设为NULL</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">void</span> MSHookFunction(<span class="keyword">void</span> *symbol, <span class="keyword">void</span> *hook, <span class="keyword">void</span> **old)</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *(pfn_getenv)(<span class="keyword">char</span> *key);</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *my_getenv(<span class="keyword">char</span> *key)&#123;</span><br><span class="line">  <span class="keyword">return</span> pfn_getenv(key);</span><br><span class="line">&#125;</span><br><span class="line">%ctor &#123;</span><br><span class="line">  MSHookFunction((<span class="keyword">void</span> *)getenv,(<span class="keyword">void</span> *)&amp;my_getenv, (<span class="keyword">void</span>**)&amp;pfn_getenv);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="fishhook"><a href="#fishhook" class="headerlink" title="fishhook"></a>fishhook</h5><p>动态修改链接 MachO 文件的工具，利用 MachO 文件加载原理，通过修改懒加载和非懒加载两个表的指针达到C函数hook的目的</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> rebinding(</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *name;  <span class="comment">//字符串名称</span></span><br><span class="line">  <span class="keyword">void</span> *replacement; <span class="comment">//替换后的函数</span></span><br><span class="line">  <span class="keyword">void</span> **replaced;	 <span class="comment">//原始函数</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">&quot;fishhook&quot;</span></span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *(*orig_getenv)(<span class="keyword">const</span> <span class="keyword">char</span> *name);</span><br><span class="line"><span class="keyword">char</span> *my_getenv(<span class="keyword">const</span> <span class="keyword">char</span> *name)&#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;++++ name=%s&quot;</span>, name);</span><br><span class="line">  <span class="keyword">return</span> orig_getenv(name);</span><br><span class="line">&#125;</span><br><span class="line">__attribute__((constructor) <span class="keyword">static</span> <span class="keyword">void</span> PiaoYun(<span class="keyword">void</span>)) &#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;inject success&quot;</span>);</span><br><span class="line">  rebind_symbols(<span class="keyword">struct</span> rebinding[<span class="number">1</span>]&#123;</span><br><span class="line">    &#123;<span class="string">&quot;getenv&quot;</span>, (<span class="keyword">void</span>*)my_getenv,(<span class="keyword">void</span>**)&amp;orig_getenv&#125;</span><br><span class="line">  &#125;, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#import fishhook</span></span><br><span class="line"><span class="comment">//NSLog的定义是 void NSLog(NSString *format, ...)</span></span><br><span class="line"><span class="comment">//原始方法 函数指针 保存原来方法地址</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span>(*sys_nslog)(<span class="built_in">NSString</span> *format, ...);</span><br><span class="line"><span class="comment">//定义一个新的函数</span></span><br><span class="line"><span class="keyword">void</span> myNSLog(<span class="built_in">NSString</span> *format, ...) &#123;</span><br><span class="line">	format = [format stringByAppendingString: <span class="string">@&quot;勾上了 \n&quot;</span>];</span><br><span class="line">	<span class="comment">//调用原始的</span></span><br><span class="line">	sys_nslog(format);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> rebinding &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *name; <span class="comment">//需要hook的函数名称，c字符串</span></span><br><span class="line">  <span class="keyword">void</span> *replacement; <span class="comment">//新函数地址</span></span><br><span class="line">  <span class="keyword">void</span> **replaced; <span class="comment">//原函数地址的指针</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// arg1:存放 rebinding 结构体的数组</span></span><br><span class="line"><span class="comment">// arg2:数组长度</span></span><br><span class="line"><span class="keyword">int</span> rebind_symbols(<span class="keyword">struct</span> rebinding rebindings[], size_t rebindings_nel);</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> rebinding nslog;</span><br><span class="line">nslog.name = <span class="string">&quot;NSLog&quot;</span>;</span><br><span class="line">nslog.replacement = myNSLog;</span><br><span class="line">nslog.replaced = (<span class="keyword">void</span> **)&amp;sys_nslog;<span class="comment">//(void **)是为了不报错</span></span><br><span class="line"><span class="comment">//定义数组</span></span><br><span class="line"><span class="keyword">struct</span> rebinding rebs[<span class="number">1</span>] = &#123;nslog&#125;;</span><br><span class="line">rebind_symbols(rebs, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>



<h5 id="HookZz"><a href="#HookZz" class="headerlink" title="HookZz"></a>HookZz</h5><p>由 jmpews 开发的一套 Hook 框架，支持 iOS、Android 平台下的 ARM、ARM64 架构</p>
<p><a href="https://github.com/jmpews/HookZz">https://github.com/jmpews/HookZz</a></p>
<p>下载后编译成静态库或动态库即可，可以放到 /opt/theos/vendor 目录下，利用 Theos 的 tweak 模板进行编译、安装</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;hookzz.h&gt;</span></span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *(*orig_getenv)(<span class="keyword">const</span> <span class="keyword">char</span> *name);</span><br><span class="line"><span class="keyword">char</span> *my_getenv(<span class="keyword">const</span> <span class="keyword">char</span> *name)&#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;++++ name=%s&quot;</span>, name);</span><br><span class="line">  <span class="keyword">return</span> orig_getenv(name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> hook_getenv()&#123;</span><br><span class="line">  ZzReplace((<span class="keyword">void</span> *)getenv, (<span class="keyword">void</span>*)my_getenv, (<span class="keyword">void</span>**)&amp;orig_getenv);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__attribute__((constructor) <span class="keyword">static</span> <span class="keyword">void</span> PiaoYun(<span class="keyword">void</span>)) &#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;inject success&quot;</span>);</span><br><span class="line">  hook_getenv();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改 Makefile 文件，链接 HookZz 静态库及去掉 CydiaSubstrate 依赖</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">HookZzTest_LDFLAGS &#x3D; -lhookzz #链接HookZz</span><br><span class="line">HookZzTest_LOGOS_DEFAULT_GENERATOR &#x3D; internal #不使用CydiaSubstrate</span><br></pre></td></tr></table></figure>

<h4 id="注入"><a href="#注入" class="headerlink" title="注入"></a>注入</h4><h5 id="准备-dylib"><a href="#准备-dylib" class="headerlink" title="准备 dylib"></a>准备 dylib</h5><p>使用 Theos 编译一个 test.dylib 的动态库</p>
<figure class="highlight objc"><table><tr><td class="code"><pre><span class="line">__attribute__((constructor)) <span class="keyword">static</span> <span class="keyword">void</span> entry() &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;__inject success__&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将生成的 test.dylib 拖入 MachOView，可以看到 LC_LOAD_DYLIB（CydiaSubstrate），即直接编译生成的 dylib 会依赖 CydiaSubstrate，对非越狱系统会因找不到依赖库而闪退</p>
<p>也可以用 otool 查看动态库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ otool -L test.dylib</span><br></pre></td></tr></table></figure>

<p>可以看到依赖 /Library/Frameworks/CydiaSubstrate.framework/CydiaSubstrate </p>
<h6 id="去掉-CydiaSubstrate-依赖"><a href="#去掉-CydiaSubstrate-依赖" class="headerlink" title="去掉 CydiaSubstrate 依赖"></a>去掉 CydiaSubstrate 依赖</h6><p>修改 Makefile</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 去掉 CydiaSubstrate 依赖</span><br><span class="line">test_USE_SUBSTRATE &#x3D; NO</span><br><span class="line"></span><br><span class="line"># 添加版本号，用于解决签名后闪退问题</span><br><span class="line">_THEOS_TARGET_LDFLAGS +&#x3D; -current_version 1.0</span><br><span class="line">_THEOS_TARGET_LDFLAGS +&#x3D; -compatibility_version 1.0</span><br></pre></td></tr></table></figure>

<p>再次编译后 test.dylib 文件已经没有了 CydiaSubstrate 依赖了</p>
<h5 id="yololib"><a href="#yololib" class="headerlink" title="yololib"></a>yololib</h5><p>下载地址  <a href="https://github.com/KJCracks/yololib">https://github.com/KJCracks/yololib</a>   编译后放到 /usr/local/bin 目录下</p>
<p>将 test.dylib 复制到 AVPlayer.app 目录下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ yololib .&#x2F;Payload&#x2F;AVPlayer.app&#x2F;AVPlayer test.dylib</span><br></pre></td></tr></table></figure>

<p>执行完，可以用 MachOView 确认下，找到 LC_LOAD_DYLIB（test.dylib），路径值是@executable_path/test.dylib</p>
<h5 id="optool"><a href="#optool" class="headerlink" title="optool"></a>optool</h5><p>optool 功能比 yololib 强大的多，不但能添加动态库，还能将已存在的动态库删除</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ git clone https:&#x2F;&#x2F;github.com&#x2F;alexzielenski&#x2F;optool.git</span><br><span class="line">$ cd optool</span><br><span class="line">$ git submodule update --init --recursive #使用 --recursive将子模块全部clone下来</span><br></pre></td></tr></table></figure>

<p>编译后得到可执行文件放到 /usr/local/bin 目录下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#添加dylib依赖</span><br><span class="line">$ optool install -c load -p &quot;@executable_path&#x2F;test.dylib&quot; -t .&#x2F;Payload&#x2F;AVPlayer.app&#x2F;AVPlayer</span><br><span class="line"></span><br><span class="line">#删除依赖</span><br><span class="line">$ optool uninstall -p &quot;@executable_path&#x2F;test.dylib&quot; -t .&#x2F;Payload&#x2F;AVPlayer.app&#x2F;AVPlayer</span><br></pre></td></tr></table></figure>



































]]></content>
  </entry>
  <entry>
    <title>逆向-工具</title>
    <url>/2022/10/20/%E9%80%86%E5%90%91-%E5%B7%A5%E5%85%B7/</url>
    <content><![CDATA[]]></content>
  </entry>
  <entry>
    <title>JavaScript（三）</title>
    <url>/2022/09/20/JavaScript%EF%BC%88%E4%B8%89%EF%BC%89/</url>
    <content><![CDATA[<h4 id="4-面向对象编程"><a href="#4-面向对象编程" class="headerlink" title="4 面向对象编程"></a>4 面向对象编程</h4><p>JavaScript 不区分类和实例的概念，而是通过原型（prototype）来实现面向对象编程</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> Student = &#123;</span><br><span class="line">    name: <span class="string">&#x27;Robot&#x27;</span>,</span><br><span class="line">    height: <span class="number">1.2</span>,</span><br><span class="line">    run: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="built_in">this</span>.name + <span class="string">&#x27; is running...&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> xiaoming = &#123;</span><br><span class="line">    name: <span class="string">&#x27;小明&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">xiaoming.__proto__ = Student;</span><br></pre></td></tr></table></figure>

<p>最后一行代码把 xiaoming 的原型指向了对象 Student，看上去 xiaoming 仿佛是从 Student 继承下来的</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">xiaoming.name;<span class="comment">//‘小明’</span></span><br><span class="line">xiaoming.run();<span class="comment">//小明 is running...</span></span><br></pre></td></tr></table></figure>

<p>xiaoming 有自己的 name 属性，但并没有 run() 方法，run() 是从 Student 继承而来</p>
<p>所谓继承关系不过是把一个对象的原型指向另一个对象</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> Bird = &#123;</span><br><span class="line">    fly: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="built_in">this</span>.name + <span class="string">&#x27; is flying...&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">xiaoming.__proto__ = Bird;</span><br></pre></td></tr></table></figure>

<p>在 JavaScript 代码运行时期，可以把 xiaoming 从 Student 变成 Bird，或者变成任何对象</p>
<p>编写 JavaScript 代码时，不要直接用 <code>obj.__proto__</code> 去改变一个对象的原型。<code>Object.create()</code> 方法可以传入一个原型对象，并创建一个基于该原型的新对象，但是新对象什么属性都没有</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 原型对象:</span></span><br><span class="line"><span class="keyword">var</span> Student = &#123;</span><br><span class="line">    name: <span class="string">&#x27;Robot&#x27;</span>,</span><br><span class="line">    height: <span class="number">1.2</span>,</span><br><span class="line">    run: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="built_in">this</span>.name + <span class="string">&#x27; is running...&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createStudent</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 基于Student原型创建一个新对象:</span></span><br><span class="line">    <span class="keyword">var</span> s = <span class="built_in">Object</span>.create(Student);</span><br><span class="line">    <span class="comment">// 初始化新对象:</span></span><br><span class="line">    s.name = name;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> xiaoming = createStudent(<span class="string">&#x27;小明&#x27;</span>);</span><br><span class="line">xiaoming.run(); <span class="comment">// 小明 is running...</span></span><br><span class="line">xiaoming.__proto__ === Student; <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>这是创建原型继承的一种方法</p>
<h5 id="4-1-创建对象"><a href="#4-1-创建对象" class="headerlink" title="4.1 创建对象"></a>4.1 创建对象</h5><p>JavaScript 对每个创建的对象都会设置一个原型，指向它的原型对象</p>
<p>当我们用 object.xxx 访问一个对象的属性时，JavaScript 引擎先在当前对象上查找该属性，如果没有找到，就到其原型对象上找，如果还没有找到，就一直上溯到 Object.prototype 对象，最后如果还没有找到，就只能返回 undefined</p>
<p>例如，创建一个 Array 对象</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br></pre></td></tr></table></figure>

<p>其原型链是</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">arr ----&gt; <span class="built_in">Array</span>.prototype ----&gt; <span class="built_in">Object</span>.prototype ----&gt; <span class="literal">null</span></span><br></pre></td></tr></table></figure>

<h6 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h6><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Student</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">    <span class="built_in">this</span>.hello = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        alert(<span class="string">&#x27;Hello, &#x27;</span> + <span class="built_in">this</span>.name + <span class="string">&#x27;!&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> xiaoming = <span class="keyword">new</span> Student(<span class="string">&#x27;小明&#x27;</span>);</span><br><span class="line">xiaoming.name; <span class="comment">// &#x27;小明&#x27;</span></span><br><span class="line">xiaoming.hello(); <span class="comment">// Hello, 小明!</span></span><br></pre></td></tr></table></figure>

<p>如果不写 new，这就是一个普通函数，它返回 undefined，如果写了 new，就变成了一个构造函数，它绑定的 this 指向新创建的对象，并默认返回 this，最后不用写 return this</p>
<p>new Student() 创建的对象还从原型上获得了一个 constructor 属性，它指向 Student 本身</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">xiaoming.constructor === Student.prototype.constructor; <span class="comment">// true</span></span><br><span class="line">Student.prototype.constructor === Student; <span class="comment">// true</span></span><br><span class="line"><span class="built_in">Object</span>.getPrototypeOf(xiaoming) === Student.prototype; <span class="comment">// true</span></span><br><span class="line">xiaoming <span class="keyword">instanceof</span> Student; <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>如果又创建了 xiaohong，对象的原型与 xiaoming 是一样的</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">xiaoming.name; <span class="comment">// &#x27;小明&#x27;</span></span><br><span class="line">xiaohong.name; <span class="comment">// &#x27;小红&#x27;</span></span><br><span class="line">xiaoming.hello; <span class="comment">// function: Student.hello()</span></span><br><span class="line">xiaohong.hello; <span class="comment">// function: Student.hello()</span></span><br><span class="line">xiaoming.hello === xiaohong.hello; <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>xiaoming 与 xiaohong 各自的 hell 是一个函数，但他们是两个不同的函数。如果我们通过 new Student() 创建了很多对象，这些对象的 hell 函数实际上只需要共享同一个函数就可以了，这样可以节省内存</p>
<p>要让创建的对象共享一个 hello 函数，只要把 hello 函数移动到 xiaoming、xiaohong 这些对象共同的原型上九可以了</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Student</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Student.prototype.hello = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    alert(<span class="string">&#x27;Hello, &#x27;</span> + <span class="built_in">this</span>.name + <span class="string">&#x27;!&#x27;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>构造函数不要忘记写 new，为了区分普通函数和构造函数，按照约定，构造函数首字母应当大写，普通函数首字母应当小写</p>
<p>我们还可以编写一个 createStudent() 函数，在内部封装所有的 new 操作，一个常用的编程模式像这样</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Student</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.name = props.name || <span class="string">&#x27;匿名&#x27;</span>; <span class="comment">// 默认值为&#x27;匿名&#x27;</span></span><br><span class="line">    <span class="built_in">this</span>.grade = props.grade || <span class="number">1</span>; <span class="comment">// 默认值为1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Student.prototype.hello = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    alert(<span class="string">&#x27;Hello, &#x27;</span> + <span class="built_in">this</span>.name + <span class="string">&#x27;!&#x27;</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createStudent</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Student(props || &#123;&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个 createStudent 参数灵活，可以不传，也可以这么传</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> xiaoming = createStudent(&#123;</span><br><span class="line">    name: <span class="string">&#x27;小明&#x27;</span></span><br><span class="line">&#125;);</span><br><span class="line">xiaoming.grade; <span class="comment">// 1</span></span><br></pre></td></tr></table></figure>

<p>如果创建的对象有很多属性，只需要传递需要的某些属性，剩下的属性可以用默认值</p>
<h6 id="原型继承"><a href="#原型继承" class="headerlink" title="原型继承"></a>原型继承</h6><p>JavaScript 的原型继承实现方式是</p>
<p>1、定义新的构造函数，并在内部用 call() 调用希望继承的构造函数，并绑定 this</p>
<p>2、借助中间函数 F 实现原型链继承，最好通过封装的 inherits 函数完成</p>
<p>3、继续在新的构造函数的原型上定义新方法</p>
<h5 id="4-2-class-继承"><a href="#4-2-class-继承" class="headerlink" title="4.2 class 继承"></a>4.2 class 继承</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">name</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">hello</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    alert(<span class="string">&#x27;hello,&#x27;</span>+<span class="built_in">this</span>.name+<span class="string">&#x27;!&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>class 的定义包含了构造函数 constructor 和定义在原型对象上的函数 hello()（注意没有function关键字）这就避免了 Student.prototype.hello = function(){…} 这样分散的代码</p>
<p>创建一个 Student 对象</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> xiaoming = <span class="keyword">new</span> Student(<span class="string">&#x27;xiaoming&#x27;</span>);</span><br><span class="line">xiaoming.hello();</span><br></pre></td></tr></table></figure>

<h6 id="class-继承"><a href="#class-继承" class="headerlink" title="class 继承"></a>class 继承</h6><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrimaryStudent</span> <span class="keyword">extends</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params">name, grade</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">super</span>(name);<span class="comment">//super调用父类构造方法</span></span><br><span class="line">    <span class="built_in">this</span>.grade = grade;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">myGrade</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    alert(<span class="string">&#x27;I am at grade&#x27;</span>+<span class="built_in">this</span>.grade);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-浏览器"><a href="#5-浏览器" class="headerlink" title="5 浏览器"></a>5 浏览器</h4><h5 id="5-1-浏览器对象"><a href="#5-1-浏览器对象" class="headerlink" title="5.1 浏览器对象"></a>5.1 浏览器对象</h5><p>JavaScript 可以获取浏览器提供的很多对象，并进行操作</p>
<h6 id="window"><a href="#window" class="headerlink" title="window"></a>window</h6><p>window 对象不但充当全局作用域，而且表示浏览器窗口</p>
<p>window 有 innerWidth、innerHeight 属性，可以获取浏览器窗口的内部宽度和高度，内部宽高指除去菜单栏、工具栏、边框等占位元素后，用于显示网页的净宽高</p>
<p>对应的还有 outerWidth、outerHeight 获取浏览器窗口的整个宽高</p>
<h6 id="navigator"><a href="#navigator" class="headerlink" title="navigator"></a>navigator</h6><p>navigator 对象表示浏览器的信息</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">navigator.appName;<span class="comment">//浏览器名称</span></span><br><span class="line">navigator.appVersion;<span class="comment">//浏览器版本</span></span><br><span class="line">navigator.language;<span class="comment">//浏览器设置的语言</span></span><br><span class="line">navigator.platform;<span class="comment">//操作系统类型</span></span><br><span class="line">navigator.uaerAgent;<span class="comment">//浏览器设定的User-Agent字符串</span></span><br></pre></td></tr></table></figure>

<p>navigator 的信息可以很容易被用户修改，所以 JavaScript 读取的值不一定是正确的</p>
<p>针对不同浏览器编写不同的代码，用if判断浏览器版本，例如</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> width;</span><br><span class="line"><span class="keyword">if</span> (getIEVersion(navigator.userAgent)&lt;<span class="number">9</span>)&#123;</span><br><span class="line">  width = <span class="built_in">document</span>.body.clientWidth;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  width = <span class="built_in">window</span>.innerWidth;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样可能判断不准确，也很难维护，正确方法是充分利用 JavaScript 对不存在属性返回 undefined 的特性</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> width = <span class="built_in">window</span>.innerWidth || <span class="built_in">document</span>.body.clientWidth;</span><br></pre></td></tr></table></figure>

<h6 id="screen"><a href="#screen" class="headerlink" title="screen"></a>screen</h6><p>screen 对象表示屏幕信息</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">screen.width;<span class="comment">//屏幕宽度，以像素为单位</span></span><br><span class="line">screen.colorDepth;<span class="comment">//返回颜色位数，如 8、16、24</span></span><br></pre></td></tr></table></figure>

<h6 id="location"><a href="#location" class="headerlink" title="location"></a>location</h6><p>location 对象表示当前页面的 URL 信息</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">http:<span class="comment">//www.example.com:8080/path/index.html?a=1&amp;b=2#TOP</span></span><br><span class="line"></span><br><span class="line">location.protocol;<span class="comment">//http</span></span><br><span class="line">location.host;<span class="comment">//www.example.com</span></span><br><span class="line">location.port;<span class="comment">//8080</span></span><br><span class="line">location.pathname;<span class="comment">// /path/index.html</span></span><br><span class="line">location.search;<span class="comment">// ?a=1&amp;b=2</span></span><br><span class="line">location.hash;<span class="comment">//TOP</span></span><br><span class="line"></span><br><span class="line">location.assign(); <span class="comment">//加载一个新页面</span></span><br><span class="line">location.reload(); <span class="comment">//重新加载当前页面</span></span><br></pre></td></tr></table></figure>

<h6 id="document"><a href="#document" class="headerlink" title="document"></a>document</h6><p>document 对象表示当前页面，由于 HTML 在浏览器中以 DOM 形式表示为树形结构，document 对象就是整个 DOM 树的根节点</p>
<p>document 的 title 属性是从 HTML 文档中的 <code>&lt;title&gt;xxx&lt;/title&gt;</code> 读取的</p>
<p>要查找 DOM 树的某个节点，需要从 document 对象开始查找，最常用的查找是根据 ID 和 Tag Name</p>
<p>document 对象提供 <code>getElementById()</code> 和 <code>getElementByTagName()</code> 可以按 ID 获得一个 DOM 节点 和 按 Tag 名称获得一组 DOM 节点</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> menu = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;drink-menu&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> drinks = <span class="built_in">document</span>.getElementsByTagName(<span class="string">&#x27;dt&#x27;</span>);</span><br><span class="line"><span class="built_in">document</span>.cookie; <span class="comment">//读取当前页面 cookie</span></span><br></pre></td></tr></table></figure>

<p>由于 JavaScript 能读取到页面的 Cookie，在 HTML 页面中可以引入第三方的 JavaScript 代码</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;!-- 当前页面在wwwexample.com --&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;script src=<span class="string">&quot;http://www.foo.com/jquery.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">    ...</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>如果引入的第三方 JavaScript 中存在恶意代码， <code>www.foo.com</code> 网站将直接获取到 <code>www.example.com</code> 网站的用户登录信息</p>
<p>为了解决这个问题，服务器在设置 Cookie 时可以使用 httpOnly，设定了httpOnly 的 Cookie 将不能被 JavaScript 读取</p>
<h6 id="history"><a href="#history" class="headerlink" title="history"></a>history</h6><p>history 对象保存了浏览器的历史记录，JavaScript 可以调用 history 对象的 back()、forward() </p>
<h5 id="5-2-操作-DOM"><a href="#5-2-操作-DOM" class="headerlink" title="5.2  操作 DOM"></a>5.2  操作 DOM</h5><p>操作一个 DOM 节点前，先拿到 DOM 节点，<code>document.getElementById()</code> 、<code>document.getElementsByTagName()</code> 以及 CSS 选择器 <code>document.getElementsByClassName()</code></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 返回ID为&#x27;test&#x27;的节点：</span></span><br><span class="line"><span class="keyword">var</span> test = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;test&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 先定位ID为&#x27;test-table&#x27;的节点，再返回其内部所有tr节点：</span></span><br><span class="line"><span class="keyword">var</span> trs = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;test-table&#x27;</span>).getElementsByTagName(<span class="string">&#x27;tr&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 先定位ID为&#x27;test-div&#x27;的节点，再返回其内部所有class包含red的节点：</span></span><br><span class="line"><span class="keyword">var</span> reds = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;test-div&#x27;</span>).getElementsByClassName(<span class="string">&#x27;red&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取节点test下的所有直属子节点:</span></span><br><span class="line"><span class="keyword">var</span> cs = test.children;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取节点test下第一个、最后一个子节点：</span></span><br><span class="line"><span class="keyword">var</span> first = test.firstElementChild;</span><br><span class="line"><span class="keyword">var</span> last = test.lastElementChild;</span><br></pre></td></tr></table></figure>

<p>第二种方法是使用 <code>querySelector()</code> 和 <code>querySelectorAll()</code> ，需要了解 selector 语法，然后使用条件来获取节点，更加方便</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 通过querySelector获取ID为q1的节点：</span></span><br><span class="line"><span class="keyword">var</span> q1 = <span class="built_in">document</span>.querySelector(<span class="string">&#x27;#q1&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过querySelectorAll获取q1节点内的符合条件的所有节点：</span></span><br><span class="line"><span class="keyword">var</span> ps = q1.querySelectorAll(<span class="string">&#x27;div.highlighted &gt; p&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>低版本 IE&lt;8 不支持  <code>querySelector()</code> 和 <code>querySelectorAll()</code>  IE8仅有限支持</p>
<h6 id="更新-DOM"><a href="#更新-DOM" class="headerlink" title="更新 DOM"></a>更新 DOM</h6><p>一种是修改 inn二HTML 属性，不但可以修改一个 DOM 节点的文本内容，还可以直接通过 HTML片段修改DOM结点内部的子树</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获取&lt;p id=&quot;p-id&quot;&gt;...&lt;/p&gt;</span></span><br><span class="line"><span class="keyword">var</span> p = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;p-id&#x27;</span>);</span><br><span class="line"><span class="comment">// 设置文本为abc:</span></span><br><span class="line">p.innerHTML = <span class="string">&#x27;ABC&#x27;</span>; <span class="comment">// &lt;p id=&quot;p-id&quot;&gt;ABC&lt;/p&gt;</span></span><br><span class="line"><span class="comment">// 设置HTML:</span></span><br><span class="line">p.innerHTML = <span class="string">&#x27;ABC &lt;span style=&quot;color:red&quot;&gt;RED&lt;/span&gt; XYZ&#x27;</span>;</span><br><span class="line"><span class="comment">// &lt;p&gt;...&lt;/p&gt;的内部结构已修改</span></span><br></pre></td></tr></table></figure>

<p>第二种是修改 innerText 或 textContent 属性，这样可以自动对字符串进行 HTML 编码，保证无法设置任何 HTML 标签</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获取&lt;p id=&quot;p-id&quot;&gt;...&lt;/p&gt;</span></span><br><span class="line"><span class="keyword">var</span> p = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;p-id&#x27;</span>);</span><br><span class="line"><span class="comment">// 设置文本:</span></span><br><span class="line">p.innerText = <span class="string">&#x27;&lt;script&gt;alert(&quot;Hi&quot;)&lt;/script&gt;&#x27;</span>;</span><br><span class="line"><span class="comment">// HTML被自动编码，无法设置一个&lt;script&gt;节点:</span></span><br><span class="line"><span class="comment">// &lt;p id=&quot;p-id&quot;&gt;&amp;lt;script&amp;gt;alert(&quot;Hi&quot;)&amp;lt;/script&amp;gt;&lt;/p&gt;</span></span><br></pre></td></tr></table></figure>

<p>DOM节点的 style 属性对应所有的 CSS，可以直接获取或设置，因为 CSS 允许 font-size 这样的名称，但它并非 JavaScript有效的属性名，所以要在 JavaScript 中改写为驼峰式命名 fontSize</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获取&lt;p id=&quot;p-id&quot;&gt;...&lt;/p&gt;</span></span><br><span class="line"><span class="keyword">var</span> p = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;p-id&#x27;</span>);</span><br><span class="line"><span class="comment">// 设置CSS:</span></span><br><span class="line">p.style.color = <span class="string">&#x27;#ff0000&#x27;</span>;</span><br><span class="line">p.style.fontSize = <span class="string">&#x27;20px&#x27;</span>;</span><br><span class="line">p.style.paddingTop = <span class="string">&#x27;2em&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h6 id="插入-DOM"><a href="#插入-DOM" class="headerlink" title="插入 DOM"></a>插入 DOM</h6><p>如果这个DOM节点是空的，例如 <code>&lt;div&gt;&lt;/div&gt;</code>  那么，直接用 <code>innerHTML=&#39;&lt;span&gt;child&lt;/span&gt;&#39;</code> 就可以修改 DOM 节点的内容，相当于插入了新的 DOM节点</p>
<p>如果这个DOM节点不是空的，可以使用 <code>appendChild</code> ，把一子节点添加到父节点的最后一个子节点</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;p id=<span class="string">&quot;js&quot;</span>&gt;JavaScript&lt;/p&gt;</span><br><span class="line">&lt;div id=<span class="string">&quot;list&quot;</span>&gt;</span><br><span class="line">    &lt;p id=<span class="string">&quot;java&quot;</span>&gt;Java&lt;/p&gt;</span><br><span class="line">    &lt;p id=<span class="string">&quot;python&quot;</span>&gt;Python&lt;/p&gt;</span><br><span class="line">    &lt;p id=<span class="string">&quot;scheme&quot;</span>&gt;Scheme&lt;/p&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">    js = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;js&#x27;</span>),</span><br><span class="line">    list = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;list&#x27;</span>);</span><br><span class="line">list.appendChild(js);</span><br><span class="line"><span class="comment">//HTML 结构变成了这样</span></span><br><span class="line">&lt;div id=<span class="string">&quot;list&quot;</span>&gt;</span><br><span class="line">    &lt;p id=<span class="string">&quot;java&quot;</span>&gt;Java&lt;/p&gt;</span><br><span class="line">    &lt;p id=<span class="string">&quot;python&quot;</span>&gt;Python&lt;/p&gt;</span><br><span class="line">    &lt;p id=<span class="string">&quot;scheme&quot;</span>&gt;Scheme&lt;/p&gt;</span><br><span class="line">    &lt;p id=<span class="string">&quot;js&quot;</span>&gt;JavaScript&lt;/p&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>从零创建一个新节点，然后插入到指定位置</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span></span><br><span class="line">    list = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;list&#x27;</span>),</span><br><span class="line">    haskell = <span class="built_in">document</span>.createElement(<span class="string">&#x27;p&#x27;</span>);</span><br><span class="line">haskell.id = <span class="string">&#x27;haskell&#x27;</span>;</span><br><span class="line">haskell.innerText = <span class="string">&#x27;Haskell&#x27;</span>;</span><br><span class="line">list.appendChild(haskell);</span><br><span class="line"></span><br><span class="line">&lt;div id=<span class="string">&quot;list&quot;</span>&gt;</span><br><span class="line">    &lt;p id=<span class="string">&quot;java&quot;</span>&gt;Java&lt;/p&gt;</span><br><span class="line">    &lt;p id=<span class="string">&quot;python&quot;</span>&gt;Python&lt;/p&gt;</span><br><span class="line">    &lt;p id=<span class="string">&quot;scheme&quot;</span>&gt;Scheme&lt;/p&gt;</span><br><span class="line">    &lt;p id=<span class="string">&quot;haskell&quot;</span>&gt;Haskell&lt;/p&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>动态创建一个节点然后添加到DOM树中，例如</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> d = <span class="built_in">document</span>.createElement(<span class="string">&#x27;style&#x27;</span>);</span><br><span class="line">d.setAttribute(<span class="string">&#x27;type&#x27;</span>, <span class="string">&#x27;text/css&#x27;</span>);</span><br><span class="line">d.innerHTML = <span class="string">&#x27;p &#123; color: red &#125;&#x27;</span>;</span><br><span class="line"><span class="built_in">document</span>.getElementsByTagName(<span class="string">&#x27;head&#x27;</span>)[<span class="number">0</span>].appendChild(d);</span><br></pre></td></tr></table></figure>

<ul>
<li>insertBefore</li>
</ul>
<p><code>parentElement.insertBefore(newElement, referenceElement);</code> 子节点会插入到 referenceElement 之前</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;div id=<span class="string">&quot;list&quot;</span>&gt;</span><br><span class="line">    &lt;p id=<span class="string">&quot;java&quot;</span>&gt;Java&lt;/p&gt;</span><br><span class="line">    &lt;p id=<span class="string">&quot;python&quot;</span>&gt;Python&lt;/p&gt;</span><br><span class="line">    &lt;p id=<span class="string">&quot;scheme&quot;</span>&gt;Scheme&lt;/p&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"><span class="comment">//haskell插入到python之前</span></span><br><span class="line"><span class="keyword">var</span></span><br><span class="line">    list = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;list&#x27;</span>),</span><br><span class="line">    ref = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;python&#x27;</span>),</span><br><span class="line">    haskell = <span class="built_in">document</span>.createElement(<span class="string">&#x27;p&#x27;</span>);</span><br><span class="line">haskell.id = <span class="string">&#x27;haskell&#x27;</span>;</span><br><span class="line">haskell.innerText = <span class="string">&#x27;Haskell&#x27;</span>;</span><br><span class="line">list.insertBefore(haskell, ref);</span><br></pre></td></tr></table></figure>

<h6 id="删除-DOM"><a href="#删除-DOM" class="headerlink" title="删除 DOM"></a>删除 DOM</h6><p>删除一个节点，首先获得该节点本身以及它的父节点，然后调用父节点的 removeChild </p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 拿到待删除节点:</span></span><br><span class="line"><span class="keyword">var</span> self = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;to-be-removed&#x27;</span>);</span><br><span class="line"><span class="comment">// 拿到父节点:</span></span><br><span class="line"><span class="keyword">var</span> parent = self.parentElement;</span><br><span class="line"><span class="comment">// 删除:</span></span><br><span class="line"><span class="keyword">var</span> removed = parent.removeChild(self);</span><br><span class="line">removed === self; <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> parent = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;parent&#x27;</span>);</span><br><span class="line">parent.removeChild(parent.children[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure>

<h5 id="5-3-操作表单"><a href="#5-3-操作表单" class="headerlink" title="5.3 操作表单"></a>5.3 操作表单</h5><p>JavaScript 操作表单和操作DOM类似，因为表单本身也是DOM树</p>
<p>HTML表单的输入控件主要有几种</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;input type=<span class="string">&quot;text&quot;</span>&gt; <span class="comment">//文本框，用于输入文本</span></span><br><span class="line">&lt;input type=<span class="string">&quot;password&quot;</span>&gt; <span class="comment">//输入口令</span></span><br><span class="line">&lt;input type=<span class="string">&quot;radio&quot;</span>&gt; <span class="comment">//选择一项</span></span><br><span class="line">&lt;input type=<span class="string">&quot;checkbox&quot;</span>&gt; <span class="comment">//选择多项</span></span><br><span class="line">&lt;input type=<span class="string">&quot;hidden&quot;</span>&gt; <span class="comment">//隐藏文本，用户不可见，但表单提交时会把隐藏文本发送到服务器</span></span><br><span class="line">&lt;select&gt; <span class="comment">//下拉框 用于选择一项</span></span><br></pre></td></tr></table></figure>

<h6 id="获取值"><a href="#获取值" class="headerlink" title="获取值"></a>获取值</h6><p>如果获取了 <code>&lt;input&gt;</code> 节点的引用，可以直接调用 value 获得对应的用户输入值</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// &lt;input type=&quot;text&quot; id=&quot;email&quot;&gt;</span></span><br><span class="line"><span class="keyword">var</span> input = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;email&#x27;</span>);</span><br><span class="line">input.value; <span class="comment">// &#x27;用户输入的值&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这种方式可以应用于 text、password、hidden 及 select，但对于单选框和复选框，value 属性返回的永远是 HTML 预设的值。应该用 checked 判断</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// &lt;label&gt;&lt;input type=&quot;radio&quot; name=&quot;weekday&quot; id=&quot;monday&quot; value=&quot;1&quot;&gt; Monday&lt;/label&gt;</span></span><br><span class="line"><span class="comment">// &lt;label&gt;&lt;input type=&quot;radio&quot; name=&quot;weekday&quot; id=&quot;tuesday&quot; value=&quot;2&quot;&gt; Tuesday&lt;/label&gt;</span></span><br><span class="line"><span class="keyword">var</span> mon = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;monday&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> tue = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;tuesday&#x27;</span>);</span><br><span class="line">mon.value; <span class="comment">// &#x27;1&#x27;</span></span><br><span class="line">tue.value; <span class="comment">// &#x27;2&#x27;</span></span><br><span class="line">mon.checked; <span class="comment">// true或者false</span></span><br><span class="line">tue.checked; <span class="comment">// true或者false</span></span><br></pre></td></tr></table></figure>

<h6 id="设置值"><a href="#设置值" class="headerlink" title="设置值"></a>设置值</h6><p> text、password、hidden 及 select 直接设置 value 就可以</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// &lt;input type=&quot;text&quot; id=&quot;email&quot;&gt;</span></span><br><span class="line"><span class="keyword">var</span> input = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;email&#x27;</span>);</span><br><span class="line">input.value = <span class="string">&#x27;test@example.com&#x27;</span>; <span class="comment">// 文本框的内容已更新</span></span><br></pre></td></tr></table></figure>

<p>单选框和复选框，设置 checked 为 true 或 false 即可</p>
<h6 id="HTML5"><a href="#HTML5" class="headerlink" title="HTML5"></a>HTML5</h6><p>HTML5新增了大量标准控件，常用的包括 date、datetime、datetime-local、color 等，它们都使用 <code>&lt;input&gt;</code> 标签</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;input type=<span class="string">&quot;date&quot;</span> value=<span class="string">&quot;2021-12-02&quot;</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">&quot;datetime-local&quot;</span> value=<span class="string">&quot;2021-12-02T20:21:12&quot;</span>&gt;</span><br><span class="line">&lt;input type=<span class="string">&quot;color&quot;</span> value=<span class="string">&quot;#ff0000&quot;</span>&gt;</span><br></pre></td></tr></table></figure>

<h6 id="提交表单"><a href="#提交表单" class="headerlink" title="提交表单"></a>提交表单</h6><p>方式一通过 <code>&lt;form&gt;</code> 元素的 <code>submit()</code> 方法提交表单，响应一个 <code>&lt;button&gt;</code> 的 click 事件</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;!-- HTML --&gt;</span><br><span class="line">&lt;form id=<span class="string">&quot;test-form&quot;</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;test&quot;</span>&gt;</span><br><span class="line">    &lt;button type=<span class="string">&quot;button&quot;</span> onclick=<span class="string">&quot;doSubmitForm()&quot;</span>&gt;Submit&lt;/button&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doSubmitForm</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> form = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;test-form&#x27;</span>);</span><br><span class="line">    <span class="comment">// 可以在此修改form的input...</span></span><br><span class="line">    <span class="comment">// 提交form:</span></span><br><span class="line">    form.submit();</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>第二种方式，浏览器默认点击 <code>&lt;button type=&quot;submit&quot;&gt;</code> 时提交表单，或者用户在最后输入框按回车键，响应 <code>&lt;form&gt;</code> 本身的 onsubmit 事件</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;!-- HTML --&gt;</span><br><span class="line">&lt;form id=<span class="string">&quot;test-form&quot;</span> onsubmit=<span class="string">&quot;return checkForm()&quot;</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;text&quot;</span> name=<span class="string">&quot;test&quot;</span>&gt;</span><br><span class="line">    &lt;button type=<span class="string">&quot;submit&quot;</span>&gt;Submit&lt;/button&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkForm</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> form = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;test-form&#x27;</span>);</span><br><span class="line">    <span class="comment">// 可以在此修改form的input...</span></span><br><span class="line">    <span class="comment">// 继续下一步:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>return true 来告诉浏览器继续提交，如果 return false 浏览器不会继续提交 form，这种情况通常对应用户输入有误，提示用户错误信息然后终止提交 form</p>
<p>在检查和修改 <code>&lt;input&gt;</code> 时，要充分利用 <code>&lt;input type=&quot;hidden&quot;&gt;</code> 来传递数据</p>
<p>例如：登录表单输入用户名和口令，提交表单时不传输明文口令，而是口令的MD5</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;!-- HTML --&gt;</span><br><span class="line">&lt;form id=<span class="string">&quot;login-form&quot;</span> method=<span class="string">&quot;post&quot;</span> onsubmit=<span class="string">&quot;return checkForm()&quot;</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;text&quot;</span> id=<span class="string">&quot;username&quot;</span> name=<span class="string">&quot;username&quot;</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;password&quot;</span> id=<span class="string">&quot;input-password&quot;</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;hidden&quot;</span> id=<span class="string">&quot;md5-password&quot;</span> name=<span class="string">&quot;password&quot;</span>&gt;</span><br><span class="line">    &lt;button type=<span class="string">&quot;submit&quot;</span>&gt;Submit&lt;/button&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkForm</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> input_pwd = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;input-password&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> md5_pwd = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;md5-password&#x27;</span>);</span><br><span class="line">    <span class="comment">// 把用户输入的明文变为MD5:</span></span><br><span class="line">    md5_pwd.value = toMD5(input_pwd.value);</span><br><span class="line">    <span class="comment">// 继续下一步:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>注意 id 为 md5-password 的 <code>&lt;input&gt;</code> 标记了 name=”password”。而用户输入的 id 为</p>
<p>input-password 的 <code>&lt;input&gt;</code>  没有 name 属性。没有 name 属性的 <code>&lt;input&gt;</code> 的数据不会被提交</p>
<h6 id="操作文件"><a href="#操作文件" class="headerlink" title="操作文件"></a>操作文件</h6><p>HTML表单中，可以上传文件的唯一控件是 <code>&lt;input type=&quot;file&quot;&gt;</code></p>
<p>当一个表单包含  <code>&lt;input type=&quot;file&quot;&gt;</code> 时，表单的 enctype 必须指定为 multipart/form-data，method 必须指定为 post，浏览器才能正确编码并以 multipart/form-data 格式发送表单的数据</p>
<p>出于安全考虑，浏览器只允许用户点击 <code>&lt;input type=&quot;file&quot;&gt;</code> 来选择本地文件，用JavaScript 对 <code>&lt;input type=&quot;file&quot;&gt;</code> 的 value 值赋值没有效果</p>
<p>JavaScript 可以在提交表单时对文件扩展名做检查</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> f = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;test-file-upload&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> filename = f.value; <span class="comment">// &#x27;C:\fakepath\test.png&#x27;</span></span><br><span class="line"><span class="keyword">if</span> (!filename || !(filename.endsWith(<span class="string">&#x27;.jpg&#x27;</span>) || filename.endsWith(<span class="string">&#x27;.png&#x27;</span>) || filename.endsWith(<span class="string">&#x27;.gif&#x27;</span>))) &#123;</span><br><span class="line">    alert(<span class="string">&#x27;Can only upload image file.&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>File API</li>
</ul>
<p>HTML5 的 File API 提供了 File 和 FileReader 两个主要对象，可以获得文件信息并读取文件</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span></span><br><span class="line">    fileInput = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;test-image-file&#x27;</span>),</span><br><span class="line">    info = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;test-file-info&#x27;</span>),</span><br><span class="line">    preview = <span class="built_in">document</span>.getElementById(<span class="string">&#x27;test-image-preview&#x27;</span>);</span><br><span class="line"><span class="comment">// 监听change事件:</span></span><br><span class="line">fileInput.addEventListener(<span class="string">&#x27;change&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 清除背景图片:</span></span><br><span class="line">    preview.style.backgroundImage = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="comment">// 检查文件是否选择:</span></span><br><span class="line">    <span class="keyword">if</span> (!fileInput.value) &#123;</span><br><span class="line">        info.innerHTML = <span class="string">&#x27;没有选择文件&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取File引用:</span></span><br><span class="line">    <span class="keyword">var</span> file = fileInput.files[<span class="number">0</span>];</span><br><span class="line">    <span class="comment">// 获取File信息:</span></span><br><span class="line">    info.innerHTML = <span class="string">&#x27;文件: &#x27;</span> + file.name + <span class="string">&#x27;&lt;br&gt;&#x27;</span> +</span><br><span class="line">                     <span class="string">&#x27;大小: &#x27;</span> + file.size + <span class="string">&#x27;&lt;br&gt;&#x27;</span> +</span><br><span class="line">                     <span class="string">&#x27;修改: &#x27;</span> + file.lastModified;</span><br><span class="line">    <span class="keyword">if</span> (file.type !== <span class="string">&#x27;image/jpeg&#x27;</span> &amp;&amp; file.type !== <span class="string">&#x27;image/png&#x27;</span> &amp;&amp; file.type !== <span class="string">&#x27;image/gif&#x27;</span>) &#123;</span><br><span class="line">        alert(<span class="string">&#x27;不是有效的图片文件!&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 读取文件:</span></span><br><span class="line">    <span class="keyword">var</span> reader = <span class="keyword">new</span> FileReader();</span><br><span class="line">    reader.onload = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">      <span class="comment">//文件读取完成后自动调用此函数</span></span><br><span class="line">        <span class="keyword">var</span></span><br><span class="line">            data = e.target.result; <span class="comment">// &#x27;data:image/jpeg;base64,/9j/4AAQSk...(base64编码)...&#x27;            </span></span><br><span class="line">        preview.style.backgroundImage = <span class="string">&#x27;url(&#x27;</span> + data + <span class="string">&#x27;)&#x27;</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 以DataURL的形式读取文件:</span></span><br><span class="line">    reader.readAsDataURL(file);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h5 id="5-4-AJAX"><a href="#5-4-AJAX" class="headerlink" title="5.4 AJAX"></a>5.4 AJAX</h5><p>用 JavaScript 执行异步网络请求</p>
<h5 id="5-5-Promise"><a href="#5-5-Promise" class="headerlink" title="5.5 Promise"></a>5.5 Promise</h5><h5 id="5-6-Canvas"><a href="#5-6-Canvas" class="headerlink" title="5.6 Canvas"></a>5.6 Canvas</h5>]]></content>
  </entry>
  <entry>
    <title>JavaScript（二）</title>
    <url>/2022/09/19/JavaScript%EF%BC%88%E4%BA%8C%EF%BC%89/</url>
    <content><![CDATA[<h4 id="2-函数"><a href="#2-函数" class="headerlink" title="2 函数"></a>2 函数</h4><h5 id="2-1-定义和调用"><a href="#2-1-定义和调用" class="headerlink" title="2.1 定义和调用"></a>2.1 定义和调用</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">abs</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> -x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二种定义函数的方式</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> abs = <span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> -x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">abs(<span class="number">10</span>);</span><br><span class="line">abs(<span class="number">10</span>,<span class="string">&#x27;blabla&#x27;</span>);</span><br><span class="line">abs();<span class="comment">//返回 NaN，x收到undefined，计算结果NaN</span></span><br></pre></td></tr></table></figure>

<p>function(x){…} 是一个匿名函数，没有函数名，匿名函数赋值给了变量 abs，通过变量 abs 就可以调用该函数</p>
<p>JavaScript 允许传入任意个参数不影响调用，传入参数比定义多也没问题</p>
<p>传入的参数比定义少也没有问题</p>
<p>为避免收到 undefined，可以对参数进行检查</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">abs</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> x !== <span class="string">&#x27;number&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="string">&#x27;Not a number&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="arguments"><a href="#arguments" class="headerlink" title="arguments"></a>arguments</h6><p>函数内部起作用，指向传入的所有参数</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">x</span>)</span>&#123;</span><br><span class="line">  <span class="function"><span class="title">for</span>(<span class="params"><span class="keyword">var</span> i=<span class="number">0</span>; i&lt;<span class="built_in">arguments</span>.length; i++</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;arg &#x27;</span> + i + <span class="string">&#x27;=&#x27;</span> + <span class="built_in">arguments</span>[i]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">abs</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">arguments</span>.length === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> x = <span class="built_in">arguments</span>[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">return</span> x &gt;= <span class="number">0</span> ? x : -x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="rest参数"><a href="#rest参数" class="headerlink" title="rest参数"></a>rest参数</h6><p>获取已定义参数之外的参数</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params">a,b, ...rest</span>)</span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(rest);</span><br><span class="line">&#125;</span><br><span class="line">foo(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>);<span class="comment">//[3,4,5]</span></span><br><span class="line">foo(<span class="number">1</span>);<span class="comment">//[]</span></span><br></pre></td></tr></table></figure>

<h5 id="2-2-作用域"><a href="#2-2-作用域" class="headerlink" title="2.2 作用域"></a>2.2 作用域</h5><p>不在任何函数内定义的变量具有全局作用域，JavaScript 默认有一个全局对象 window，全局作用域的变量实际上被绑定到 window 的一个属性</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> course = <span class="string">&#x27;Learn JavaScript&#x27;</span></span><br><span class="line">alert(course);</span><br><span class="line">alert(<span class="built_in">window</span>.course);</span><br></pre></td></tr></table></figure>

<p>以变量方式 var foo = function(){} 定义的函数实际上也是一个全局变量，因此顶层函数的定义也被视为一个全局变量，并绑定到 window 对象</p>
<h6 id="名字空间"><a href="#名字空间" class="headerlink" title="名字空间"></a>名字空间</h6><p>全局变量会绑定到 window 上，不同的 JavaScript 文件如果使用了相同的全局变量，或者定义了相同名字的顶层函数，都会造成命名冲突</p>
<p>减少冲突的一个方法是把自己所有变量和函数全部绑定到一个全局变量中，把自己代码全部放入唯一的名字空间 MYAPP 中，减少全局变量冲突的可能</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> MYAPP = &#123;&#125;;<span class="comment">//唯一的全局变量MYAPP</span></span><br><span class="line"><span class="comment">//其它变量</span></span><br><span class="line">MYAPP.name = <span class="string">&#x27;myapp&#x27;</span>;</span><br><span class="line"><span class="comment">//其它函数</span></span><br><span class="line">MYAPP.foo = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;...&#125;;</span><br></pre></td></tr></table></figure>

<h6 id="局部作用域"><a href="#局部作用域" class="headerlink" title="局部作用域"></a>局部作用域</h6><p>JavaScript的变量作用域实际上是函数内部</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;<span class="number">100</span>; i++) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">    i += <span class="number">100</span>; <span class="comment">// 仍然可以引用变量i</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了解决块级作用域，ES6引入了新的关键字 let，用 let 代替 var 可以申明一个块级作用域的变量</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;<span class="number">100</span>; i++) &#123;</span><br><span class="line">        sum += i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// SyntaxError:</span></span><br><span class="line">    i += <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h6><p>通常用全部大写表示这是一个常量 </p>
<p>ES6 标准引入新关键字 const 来定义常量</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> PI = <span class="number">3.14</span></span><br><span class="line"><span class="keyword">const</span> PI1 = <span class="number">3.14</span></span><br><span class="line">PI1 = <span class="number">3</span>;<span class="comment">//某些浏览器不报错，但是无效果</span></span><br></pre></td></tr></table></figure>

<h5 id="2-3-解构赋值"><a href="#2-3-解构赋值" class="headerlink" title="2.3 解构赋值"></a>2.3 解构赋值</h5><p>ES6开始，JavaScript引入了解构赋值，可以同时对一组变量进行赋值，多个变量 [] 括起来</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> [x, y, z] = [<span class="string">&#x27;hello&#x27;</span>, <span class="string">&#x27;JavaScript&#x27;</span>, <span class="string">&#x27;ES6&#x27;</span>];</span><br><span class="line"><span class="keyword">let</span> [x, [y, z]] = [<span class="string">&#x27;hello&#x27;</span>, [<span class="string">&#x27;JavaScript&#x27;</span>, <span class="string">&#x27;ES6&#x27;</span>]];</span><br><span class="line"><span class="comment">//还可忽略某些元素</span></span><br><span class="line"><span class="keyword">let</span> [, , z] = [<span class="string">&#x27;hello&#x27;</span>, <span class="string">&#x27;JavaScript&#x27;</span>, <span class="string">&#x27;ES6&#x27;</span>]; <span class="comment">// 忽略前两个元素，只对z赋值第三个元素</span></span><br></pre></td></tr></table></figure>

<p>如果要从一个对象中取出若干属性，也可以使用解构赋值，便于快速获取对象的指定属性</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">  name: <span class="string">&#x27;小明&#x27;</span>,</span><br><span class="line">  age: <span class="number">20</span>,</span><br><span class="line">  gender: <span class="string">&#x27;male&#x27;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> &#123;name, age&#125; = person;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;name=&#x27;</span> + name + <span class="string">&#x27;, age=&#x27;</span> + age);</span><br></pre></td></tr></table></figure>

<p>对一个对象进行解构赋值时，同样可以直接对嵌套的对象属性进行赋值</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">  name: <span class="string">&#x27;小明&#x27;</span>,</span><br><span class="line">  age: <span class="number">20</span>,</span><br><span class="line">  gender: <span class="string">&#x27;male&#x27;</span>,</span><br><span class="line">  address: &#123;</span><br><span class="line">    city: <span class="string">&#x27;Beijing&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> &#123;name, <span class="attr">address</span>: &#123;city&#125;&#125; = person;</span><br></pre></td></tr></table></figure>

<p>使用解构赋值对对象属性进行赋值时，如果对应的属性不存在，变量被赋值为 undefined</p>
<p>如果要使用的变量名和属性名不一致，可以用下面语法获取</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> &#123;name, <span class="attr">age</span>:ageValue&#125; = persion <span class="comment">//把age属性赋值给变量ageValue</span></span><br><span class="line">name;</span><br><span class="line">ageValue;<span class="comment">//20</span></span><br><span class="line">age;<span class="comment">//Uncaught ReferenceError: age is not defined</span></span><br></pre></td></tr></table></figure>

<p>解构赋值还可以使用默认值，避免不存在的属性返回 undefined</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> &#123;name, age=<span class="number">20</span>&#125; = person <span class="comment">//如果person对象没有age属性，默认赋值为20</span></span><br></pre></td></tr></table></figure>

<p>有些时候已经声明了变量，再次赋值的时候报错</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 声明变量:</span></span><br><span class="line"><span class="keyword">var</span> x, y;</span><br><span class="line"><span class="comment">// 解构赋值:</span></span><br><span class="line">&#123;x, y&#125; = &#123; <span class="attr">name</span>: <span class="string">&#x27;小明&#x27;</span>, <span class="attr">x</span>: <span class="number">100</span>, <span class="attr">y</span>: <span class="number">200</span>&#125;;</span><br><span class="line"><span class="comment">// 语法错误: Uncaught SyntaxError: Unexpected token =</span></span><br></pre></td></tr></table></figure>

<p>JavaScript把 { 开头的语句当作了块处理，于是 = 不再合法，解决用小括号括起来</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(&#123;x, y&#125; = &#123; <span class="attr">name</span>: <span class="string">&#x27;小明&#x27;</span>, <span class="attr">x</span>: <span class="number">100</span>, <span class="attr">y</span>: <span class="number">200</span>&#125;);</span><br></pre></td></tr></table></figure>

<p>如果一个函数接收一个对象作为参数，可以使用解构直接把对象的属性绑定到变量中</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">buildDate</span>(<span class="params">&#123;year, month, day, hour=<span class="number">0</span>, minute=<span class="number">0</span>, second=<span class="number">0</span>&#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Date</span>(year + <span class="string">&#x27;-&#x27;</span> + month + <span class="string">&#x27;-&#x27;</span> + day + <span class="string">&#x27; &#x27;</span> + hour + <span class="string">&#x27;:&#x27;</span> + minute + <span class="string">&#x27;:&#x27;</span> + second);</span><br><span class="line">&#125;</span><br><span class="line">buildDate(&#123; <span class="attr">year</span>: <span class="number">2017</span>, <span class="attr">month</span>: <span class="number">1</span>, <span class="attr">day</span>: <span class="number">1</span> &#125;);</span><br><span class="line"><span class="comment">//也可传入其它参数</span></span><br><span class="line">buildDate(&#123; <span class="attr">year</span>: <span class="number">2017</span>, <span class="attr">month</span>: <span class="number">1</span>, <span class="attr">day</span>: <span class="number">1</span>, <span class="attr">hour</span>: <span class="number">20</span>, <span class="attr">minute</span>: <span class="number">15</span> &#125;);</span><br></pre></td></tr></table></figure>

<h5 id="2-4-方法"><a href="#2-4-方法" class="headerlink" title="2.4 方法"></a>2.4 方法</h5><p>绑定到对象上的函数称为方法</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> xiaoming = &#123;</span><br><span class="line">    name: <span class="string">&#x27;小明&#x27;</span>,</span><br><span class="line">    birth: <span class="number">1990</span>,</span><br><span class="line">    age: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> y = <span class="keyword">new</span> <span class="built_in">Date</span>().getFullYear();</span><br><span class="line">        <span class="keyword">return</span> y - <span class="built_in">this</span>.birth;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>方法的内部，this 是一个特殊变量，指向当前对象 xiaoming</p>
<h6 id="apply"><a href="#apply" class="headerlink" title="apply"></a>apply</h6><p>在一个独立的函数调用中，根据是否是strict模式，this 指向 undefined 或 window，还是可以控制 this 的指向的</p>
<p>要指定函数的 this 指向哪个对象，可以用函数本身的 apply 方法。接收两个参数，第一个参数就是需要绑定的 this 变量，第二个参数 Array，表示函数本身的参数</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAge</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> y = <span class="keyword">new</span> <span class="built_in">Date</span>().getFullYear();</span><br><span class="line">    <span class="keyword">return</span> y - <span class="built_in">this</span>.birth;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> xiaoming = &#123;</span><br><span class="line">    name: <span class="string">&#x27;小明&#x27;</span>,</span><br><span class="line">    birth: <span class="number">1990</span>,</span><br><span class="line">    age: getAge</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">xiaoming.age(); <span class="comment">// 25</span></span><br><span class="line">getAge(); <span class="comment">// NaN</span></span><br><span class="line">getAge.apply(xiaoming, []); <span class="comment">// 25, this指向xiaoming, 参数为空</span></span><br></pre></td></tr></table></figure>

<p>以对象的方法形式调用 xiaoming.age()，this 指向被调用的对象 xiaoming</p>
<p>如果单独调用 getAge()，此时函数的 this 指向全局对象，也就是 window</p>
<h6 id="call"><a href="#call" class="headerlink" title="call"></a>call</h6><p>和 apply 方法类似，区别是，apply() 把参数打包成 Array 传入，call() 把参数按顺序传入</p>
<p>比如调用 Math.max(3, 5, 4)</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Math</span>.max.apply(<span class="literal">null</span>, [<span class="number">3</span>, <span class="number">5</span>, <span class="number">4</span>]); <span class="comment">// 5</span></span><br><span class="line"><span class="built_in">Math</span>.max.call(<span class="literal">null</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">4</span>); <span class="comment">// 5</span></span><br></pre></td></tr></table></figure>

<p>对普通函数调用，通常把 this 绑定为 null</p>
<h6 id="装饰器"><a href="#装饰器" class="headerlink" title="装饰器"></a>装饰器</h6><p>JavaScript的所有对象都是动态的，即使内置的函数，也可以重新指向新的函数</p>
<p>如果要统计代码调用了多少次 parseInt()，可以用自己的函数替换掉默认的 parseInt()</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> oldParseInt = <span class="built_in">parseInt</span>; <span class="comment">// 保存原函数</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.parseInt = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    count += <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> oldParseInt.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>); <span class="comment">// 调用原函数</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="2-5-高阶函数"><a href="#2-5-高阶函数" class="headerlink" title="2.5 高阶函数"></a>2.5 高阶函数</h5><p>一个函数可以接收另一个函数作为参数，称为高阶函数</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">x, y, f</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> f(x) + f(y);</span><br><span class="line">&#125;</span><br><span class="line">add(-<span class="number">5</span>, <span class="number">6</span>, <span class="built_in">Math</span>.abs);</span><br></pre></td></tr></table></figure>

<h6 id="map"><a href="#map" class="headerlink" title="map"></a>map</h6><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pow</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x * x;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>];</span><br><span class="line"><span class="keyword">var</span> results = arr.map(pow); <span class="comment">// [1, 4, 9, 16, 25, 36, 49, 64, 81]</span></span><br><span class="line">arr.map(<span class="built_in">String</span>);<span class="comment">//转成字符串[&#x27;1&#x27;, &#x27;2&#x27;, &#x27;3&#x27;, &#x27;4&#x27;, &#x27;5&#x27;, &#x27;6&#x27;, &#x27;7&#x27;, &#x27;8&#x27;, &#x27;9&#x27;]</span></span><br></pre></td></tr></table></figure>

<h6 id="reduce"><a href="#reduce" class="headerlink" title="reduce"></a>reduce</h6><p>Array  的 reduce() 把一个函数作用在这个 Array 上。函数接收两个参数，reduce() 把结果继续和序列的下一个元素做累积计算</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">[x1, x2, x3, x4].reduce(f) = f(f(f(x1, x2), x3), x4)</span><br></pre></td></tr></table></figure>

<p>对一个 Array 求和</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>];</span><br><span class="line">arr.reduce(<span class="function"><span class="keyword">function</span> (<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x + y;</span><br><span class="line">&#125;); <span class="comment">// 25</span></span><br></pre></td></tr></table></figure>

<h6 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h6><p>Array 的 filter 也接收一个函数</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">15</span>];</span><br><span class="line"><span class="keyword">var</span> r = arr.filter(<span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x % <span class="number">2</span> !== <span class="number">0</span>;</span><br><span class="line">&#125;);</span><br><span class="line">r; <span class="comment">// [1, 5, 9, 15]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="literal">null</span>, <span class="literal">undefined</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;  &#x27;</span>];</span><br><span class="line"><span class="keyword">var</span> r = arr.filter(<span class="function"><span class="keyword">function</span> (<span class="params">s</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> s &amp;&amp; s.trim(); <span class="comment">// 注意：IE9以下的版本没有trim()方法</span></span><br><span class="line">&#125;);</span><br><span class="line">r; <span class="comment">// [&#x27;A&#x27;, &#x27;B&#x27;, &#x27;C&#x27;]</span></span><br></pre></td></tr></table></figure>

<p>回调函数</p>
<p>filter() 接收的回调函数，可以有多个参数，通常仅使用第一个参数，表示 Array 的某个元素。还可以接收另外两个参数，元素位置和数组本身</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>];</span><br><span class="line"><span class="keyword">var</span> r = arr.filter(<span class="function"><span class="keyword">function</span> (<span class="params">element, index, self</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(element); <span class="comment">// 依次打印&#x27;A&#x27;, &#x27;B&#x27;, &#x27;C&#x27;</span></span><br><span class="line">    <span class="built_in">console</span>.log(index); <span class="comment">// 依次打印0, 1, 2</span></span><br><span class="line">    <span class="built_in">console</span>.log(self); <span class="comment">// self就是变量arr</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//去除重复元素</span></span><br><span class="line">r = arr.filter(<span class="function"><span class="keyword">function</span> (<span class="params">element, index, self</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> self.indexOf(element) === index;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h6 id="sort"><a href="#sort" class="headerlink" title="sort"></a>sort</h6><p>Array 的 sort() 方法默认把所有元素转换为 String 再排序</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">10</span>, <span class="number">20</span>, <span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line">arr.sort(<span class="function"><span class="keyword">function</span> (<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (x &lt; y) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (x &gt; y) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;Google&#x27;</span>, <span class="string">&#x27;apple&#x27;</span>, <span class="string">&#x27;Microsoft&#x27;</span>];</span><br><span class="line">arr.sort(<span class="function"><span class="keyword">function</span> (<span class="params">s1, s2</span>) </span>&#123; <span class="comment">//忽略大小写来比较两个字符串</span></span><br><span class="line">    x1 = s1.toUpperCase();</span><br><span class="line">    x2 = s2.toUpperCase();</span><br><span class="line">    <span class="keyword">if</span> (x1 &lt; x2) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (x1 &gt; x2) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;); <span class="comment">// [&#x27;apple&#x27;, &#x27;Google&#x27;, &#x27;Microsoft&#x27;]</span></span><br></pre></td></tr></table></figure>

<h6 id="every"><a href="#every" class="headerlink" title="every"></a>every</h6><p>判断数组的所有元素是否满足测试条件</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;Apple&#x27;</span>, <span class="string">&#x27;pear&#x27;</span>, <span class="string">&#x27;orange&#x27;</span>];</span><br><span class="line"><span class="built_in">console</span>.log(arr.every(<span class="function"><span class="keyword">function</span> (<span class="params">s</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> s.length &gt; <span class="number">0</span>;</span><br><span class="line">&#125;)); <span class="comment">// true, 因为每个元素都满足s.length&gt;0</span></span><br></pre></td></tr></table></figure>

<h6 id="find"><a href="#find" class="headerlink" title="find"></a>find</h6><p>查找符合条件的第一个元素，找到返回元素，否则返回 undefined</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;Apple&#x27;</span>, <span class="string">&#x27;pear&#x27;</span>, <span class="string">&#x27;orange&#x27;</span>];</span><br><span class="line"><span class="built_in">console</span>.log(arr.find(<span class="function"><span class="keyword">function</span> (<span class="params">s</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> s.toLowerCase() === s;</span><br><span class="line">&#125;)); <span class="comment">// &#x27;pear&#x27;, 因为pear全部是小写</span></span><br></pre></td></tr></table></figure>

<h6 id="findIndex"><a href="#findIndex" class="headerlink" title="findIndex"></a>findIndex</h6><p>返回符合条件第一个元素的索引，没有找到返回-1</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;Apple&#x27;</span>, <span class="string">&#x27;pear&#x27;</span>, <span class="string">&#x27;orange&#x27;</span>];</span><br><span class="line"><span class="built_in">console</span>.log(arr.findIndex(<span class="function"><span class="keyword">function</span> (<span class="params">s</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> s.toLowerCase() === s;</span><br><span class="line">&#125;)); <span class="comment">// 1, 因为&#x27;pear&#x27;的索引是1</span></span><br></pre></td></tr></table></figure>

<h6 id="forEach"><a href="#forEach" class="headerlink" title="forEach"></a>forEach</h6><p>把每个元素依次作用于传入函数</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;Apple&#x27;</span>, <span class="string">&#x27;pear&#x27;</span>, <span class="string">&#x27;orange&#x27;</span>];</span><br><span class="line">arr.forEach(<span class="built_in">console</span>.log); <span class="comment">// 依次打印每个元素</span></span><br></pre></td></tr></table></figure>

<h5 id="2-6-闭包"><a href="#2-6-闭包" class="headerlink" title="2.6 闭包"></a>2.6 闭包</h5><p>函数作为返回值</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> arr.reduce(<span class="function"><span class="keyword">function</span> (<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> x + y;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">sum([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]); <span class="comment">// 15</span></span><br></pre></td></tr></table></figure>

<p>如果不需要立即求和，可以不返回求和结果，而是返回求和的函数</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">lazy_sum</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> sum = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> arr.reduce(<span class="function"><span class="keyword">function</span> (<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> x + y;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用 lazy_sum 时返回的不是求和结果，而是求和函数</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> f = lazy_sum([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]); <span class="comment">// function sum()</span></span><br><span class="line">f();<span class="comment">//15</span></span><br></pre></td></tr></table></figure>

<p>函数 lazy_sum 中又定义了函数 sum，内部函数 sum 可以引用外部函数 lazy_sum 的参数和局部变量，lazy_sum 返回函数 sum 时，相关参数和变量都保存在返回的函数中，这种称为闭包</p>
<p>立即执行的匿名函数</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x * x;</span><br><span class="line">&#125;)(<span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<h5 id="2-7-箭头函数"><a href="#2-7-箭头函数" class="headerlink" title="2.7 箭头函数"></a>2.7 箭头函数</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">x =&gt; x * x</span><br><span class="line"><span class="comment">//相当于</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x * x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>相当于匿名函数，上面只包含一个表达式，{…} 和 return 都省略掉了。</p>
<p>包含多条语句不能省略</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">x =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (x &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> x * x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> - x * x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果不是一个参数，需要用括号括起来</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 两个参数:</span></span><br><span class="line">(x, y) =&gt; x * x + y * y</span><br><span class="line"></span><br><span class="line"><span class="comment">// 无参数:</span></span><br><span class="line">() =&gt; <span class="number">3.14</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 可变参数:</span></span><br><span class="line">(x, y, ...rest) =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> i, sum = x + y;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;rest.length; i++) &#123;</span><br><span class="line">        sum += rest[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果要返回对象</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">x =&gt; (&#123; <span class="attr">foo</span>: x &#125;)</span><br></pre></td></tr></table></figure>

<h5 id="2-8-generator"><a href="#2-8-generator" class="headerlink" title="2.8 generator"></a>2.8 generator</h5><p>生成器</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">foo</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">yield</span> x + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">yield</span> x + <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">return</span> x + <span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>generator 由 function* 定义，除了 return 语句，还可以用 yield 返回多次</p>
<h4 id="3-标准对象"><a href="#3-标准对象" class="headerlink" title="3 标准对象"></a>3 标准对象</h4><p>typeof 获取对象类型，总是返回一个字符串</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typeof</span> <span class="number">123</span>；<span class="comment">//&#x27;number&#x27;</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="literal">NaN</span>; <span class="comment">// &#x27;number&#x27;</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="literal">null</span>; <span class="comment">//&#x27;object&#x27;</span></span><br><span class="line"><span class="keyword">typeof</span> []; <span class="comment">// &#x27;object&#x27;</span></span><br><span class="line"><span class="keyword">typeof</span> &#123;&#125;; <span class="comment">// &#x27;object&#x27;</span></span><br></pre></td></tr></table></figure>

<h5 id="3-1-包装对象"><a href="#3-1-包装对象" class="headerlink" title="3.1 包装对象"></a>3.1 包装对象</h5><p>number、boolean、string 都有包装对象</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> n = <span class="keyword">new</span> <span class="built_in">Number</span>(<span class="number">123</span>); <span class="comment">// 123,生成了新的包装类型</span></span><br><span class="line"><span class="keyword">var</span> b = <span class="keyword">new</span> <span class="built_in">Boolean</span>(<span class="literal">true</span>); <span class="comment">// true,生成了新的包装类型</span></span><br><span class="line"><span class="keyword">var</span> s = <span class="keyword">new</span> <span class="built_in">String</span>(<span class="string">&#x27;str&#x27;</span>); <span class="comment">// &#x27;str&#x27;,生成了新的包装类型</span></span><br></pre></td></tr></table></figure>

<p>包装对象看上去和原来的值一模一样，显示出来也一样，不过类型已经变为 object 了</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typeof</span> <span class="keyword">new</span> <span class="built_in">Number</span>(<span class="number">123</span>); <span class="comment">// &#x27;object&#x27;</span></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Number</span>(<span class="number">123</span>) === <span class="number">123</span>; <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>少使用包装对象</p>
<p>如果没有写 new，Number()、Boolean()、String() 被当做普通函数，把任何类型的数据转换为 number、boolean、string 类型</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> n = <span class="built_in">Number</span>(<span class="string">&#x27;123&#x27;</span>); <span class="comment">// 123，相当于parseInt()或parseFloat()</span></span><br><span class="line"><span class="keyword">typeof</span> n; <span class="comment">// &#x27;number&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b = <span class="built_in">Boolean</span>(<span class="string">&#x27;true&#x27;</span>); <span class="comment">// true</span></span><br><span class="line"><span class="keyword">typeof</span> b; <span class="comment">// &#x27;boolean&#x27;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>用parseInt()或parseFloat()转换任意类型到number</p>
<p>用String()来转换任意类型到string，或者直接调用某个对象的toString()方法</p>
<p>typeof操作符可以判断出number、boolean、string、function和undefined</p>
<p>判断Array要使用Array.isArray(arr)</p>
<p>判断null请使用myVar === null</p>
<p>判断某个全局变量是否存在用 typeof window.myVar === ‘undefined’</p>
<p>函数内部判断某个变量是否存在用 typeof myVar === ‘undefined’</p>
</blockquote>
<p>null 和 undefined 没有 toString() 方法</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="number">123.</span>toString(); <span class="comment">// SyntaxError</span></span><br><span class="line"><span class="number">123.</span>.toString(); <span class="comment">// &#x27;123&#x27;, 注意是两个点！</span></span><br><span class="line">(<span class="number">123</span>).toString(); <span class="comment">// &#x27;123&#x27;</span></span><br></pre></td></tr></table></figure>

<h5 id="3-2-Date"><a href="#3-2-Date" class="headerlink" title="3.2 Date"></a>3.2 Date</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> now = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">now; <span class="comment">// Wed Jun 24 2015 19:49:22 GMT+0800 (CST)</span></span><br><span class="line">now.getFullYear(); <span class="comment">// 2015, 年份</span></span><br><span class="line">now.getMonth(); <span class="comment">// 5, 月份，注意月份范围是0~11，5表示六月</span></span><br><span class="line">now.getDate(); <span class="comment">// 24, 表示24号</span></span><br><span class="line">now.getDay(); <span class="comment">// 3, 表示星期三</span></span><br><span class="line">now.getHours(); <span class="comment">// 19, 24小时制</span></span><br><span class="line">now.getMinutes(); <span class="comment">// 49, 分钟</span></span><br><span class="line">now.getSeconds(); <span class="comment">// 22, 秒</span></span><br><span class="line">now.getMilliseconds(); <span class="comment">// 875, 毫秒数</span></span><br><span class="line">now.getTime(); <span class="comment">// 1435146562875, 以number形式表示的时间戳</span></span><br></pre></td></tr></table></figure>

<p>创建指定日期和时间的 Date 对象</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> d = <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="number">2015</span>, <span class="number">5</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">15</span>, <span class="number">30</span>, <span class="number">123</span>);</span><br><span class="line">d; <span class="comment">// Fri Jun 19 2015 20:15:30 GMT+0800 (CST)</span></span><br></pre></td></tr></table></figure>

<p>JavaScript 的月份是 0-11，要表示 6 月，传入的值是 5</p>
<p>第二种创建，解析一个符合 ISO 8601 格式的字符串，返回时间戳</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> d = <span class="built_in">Date</span>.parse(<span class="string">&#x27;2015-06-24T19:49:22.875+08:00&#x27;</span>);</span><br><span class="line">d; <span class="comment">// 1435146562875</span></span><br><span class="line"><span class="comment">//时间戳转 Date</span></span><br><span class="line"><span class="keyword">var</span> d = <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="number">1435146562875</span>);</span><br><span class="line">d; <span class="comment">// Wed Jun 24 2015 19:49:22 GMT+0800 (CST)</span></span><br><span class="line">d.getMonth(); <span class="comment">// 5</span></span><br></pre></td></tr></table></figure>

<ul>
<li>时区</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> d = <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="number">1435146562875</span>);</span><br><span class="line">d.toLocaleString(); <span class="comment">// &#x27;2015/6/24 下午7:49:22&#x27;，本地时间（北京时区+8:00），显示的字符串与操作系统设定的格式有关</span></span><br><span class="line">d.toUTCString(); <span class="comment">// &#x27;Wed, 24 Jun 2015 11:49:22 GMT&#x27;，UTC时间，与本地时间相差8小时</span></span><br></pre></td></tr></table></figure>

<h5 id="3-3-RegExp"><a href="#3-3-RegExp" class="headerlink" title="3.3 RegExp"></a>3.3 RegExp</h5><p>\d 可以匹配一个数字，\w 可以匹配一个字母或数字</p>
<p><code>.</code> 可以匹配任意字符</p>
<p><code>*</code> 表示任意个字符（包括0个），用 <code>+</code> 表示至少一个字符，用 <code>?</code> 表示0个或1个字符，用 <code>&#123;n&#125;</code> 表示n个字符</p>
<p><code>&#123;n,m&#125;</code> 表示n-m个字符，<code>\s+</code> 至少一个空格</p>
<p>例如： <code>\d&#123;3&#125;\s+\d&#123;3,8&#125;</code> </p>
<p>\d{3} 表示匹配3个数字，例如 010</p>
<p>\s+ 表示至少一个空格，\d{3,8} 表示3-8个数字。即可以匹配任意个空格隔开带区号的电话号码</p>
<ul>
<li>精确匹配可以用[]表示范围</li>
</ul>
<p><code>[0-9a-zA-Z\_]</code> 匹配一个数字、字母或者下划线</p>
<p><code>[a-zA-Z\_\$][0-9a-zA-Z\_\$]*</code>  可以匹配由字母或下划线、$开头，后接任意个由一个数字、字母或者下划线、$组成的字符串</p>
<p><code>A|B </code> 可以匹配A或B，所以 <code>(J|j)ava(S|s)cript</code> 可以匹配 JavaScript、’Javascript</p>
<p><code>^</code> 表示行的开头，<code>^\d</code> 表示必须以数字开头</p>
<p><code>$</code> 表示行的结束，<code>\d$</code> 表示必须以数字结束</p>
<h6 id="RegExp"><a href="#RegExp" class="headerlink" title="RegExp"></a>RegExp</h6><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> re1 = <span class="regexp">/ABC\-001/</span>;</span><br><span class="line"><span class="keyword">var</span> re2 = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">&#x27;ABC\\-001&#x27;</span>); <span class="comment">//需要转义</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> re = <span class="regexp">/^\d&#123;3&#125;\-\d&#123;3,8&#125;$/</span>;</span><br><span class="line">re.test(<span class="string">&#x27;010-12345&#x27;</span>); <span class="comment">// true</span></span><br><span class="line">re.test(<span class="string">&#x27;010-1234x&#x27;</span>); <span class="comment">// false</span></span><br><span class="line">re.test(<span class="string">&#x27;010 12345&#x27;</span>); <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>RegExp 对象的 test() 方法用于测试给定的字符串是否符合条件</p>
<h6 id="切分字符串"><a href="#切分字符串" class="headerlink" title="切分字符串"></a>切分字符串</h6><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;a b   c&#x27;</span>.split(<span class="string">&#x27; &#x27;</span>); <span class="comment">// [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;&#x27;, &#x27;&#x27;, &#x27;c&#x27;] 无法识别连续空格</span></span><br><span class="line"><span class="string">&#x27;a b   c&#x27;</span>.split(<span class="regexp">/\s+/</span>); <span class="comment">// [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;]</span></span><br><span class="line"><span class="string">&#x27;a,b, c  d&#x27;</span>.split(<span class="regexp">/[\s\,]+/</span>); <span class="comment">// [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;d&#x27;]</span></span><br><span class="line"><span class="string">&#x27;a,b;; c  d&#x27;</span>.split(<span class="regexp">/[\s\,\;]+/</span>); <span class="comment">// [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;d&#x27;]</span></span><br></pre></td></tr></table></figure>

<h6 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h6><p>正则表达式还有提取子串的功能，用()表示的是要提取的分组</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> re = <span class="regexp">/^(\d&#123;3&#125;)-(\d&#123;3,8&#125;)$/</span>;</span><br><span class="line">re.exec(<span class="string">&#x27;010-12345&#x27;</span>); <span class="comment">// [&#x27;010-12345&#x27;, &#x27;010&#x27;, &#x27;12345&#x27;]</span></span><br><span class="line">re.exec(<span class="string">&#x27;010 12345&#x27;</span>); <span class="comment">// null</span></span><br></pre></td></tr></table></figure>

<p>定义了两个组，可以直接从匹配的字符串中提取出区号和本地号码，exec() 方法提取出子串</p>
<h6 id="贪婪匹配"><a href="#贪婪匹配" class="headerlink" title="贪婪匹配"></a>贪婪匹配</h6><p>正则表达式默认是贪婪匹配，匹配尽可能多的字符</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> re = <span class="regexp">/^(\d+)(0*)$/</span>;</span><br><span class="line">re.exec(<span class="string">&#x27;102300&#x27;</span>); <span class="comment">// [&#x27;102300&#x27;, &#x27;102300&#x27;, &#x27;&#x27;]</span></span><br></pre></td></tr></table></figure>

<p>\d+采用贪婪匹配，直接把后面的 0 全部匹配了，<code>0*</code> 只能匹配空字符串了</p>
<p>加个 <code>?</code> 就让 \d+采用非贪婪匹配（尽可能少匹配）</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> re = <span class="regexp">/^(\d+?)(0*)$/</span>;</span><br><span class="line">re.exec(<span class="string">&#x27;102300&#x27;</span>); <span class="comment">// [&#x27;102300&#x27;, &#x27;1023&#x27;, &#x27;00&#x27;]</span></span><br></pre></td></tr></table></figure>

<h6 id="全局搜索"><a href="#全局搜索" class="headerlink" title="全局搜索"></a>全局搜索</h6><p>JavaScript 的正则表达式还有几个特殊的标志，最常用的是 g，表示全局匹配</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> r1 = <span class="regexp">/test/g</span>;</span><br><span class="line"><span class="comment">// 等价于:</span></span><br><span class="line"><span class="keyword">var</span> r2 = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">&#x27;test&#x27;</span>, <span class="string">&#x27;g&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>全局匹配可以多次执行 exec() 方法来搜索一个匹配的字符串，指定 g 标志后，每次运行 exec()，正则表达式本身会更新 lastIndex 属性，表示上次匹配到的最后索引</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> s = <span class="string">&#x27;JavaScript, VBScript, JScript and ECMAScript&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> re=<span class="regexp">/[a-zA-Z]+Script/g</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用全局匹配:</span></span><br><span class="line">re.exec(s); <span class="comment">// [&#x27;JavaScript&#x27;]</span></span><br><span class="line">re.lastIndex; <span class="comment">// 10</span></span><br><span class="line">re.exec(s); <span class="comment">// [&#x27;VBScript&#x27;]</span></span><br><span class="line">re.lastIndex; <span class="comment">// 20</span></span><br><span class="line">re.exec(s); <span class="comment">// [&#x27;JScript&#x27;]</span></span><br><span class="line">re.lastIndex; <span class="comment">// 29</span></span><br><span class="line">re.exec(s); <span class="comment">// [&#x27;ECMAScript&#x27;]</span></span><br><span class="line">re.lastIndex; <span class="comment">// 44</span></span><br><span class="line">re.exec(s); <span class="comment">// null，直到结束仍没有匹配到</span></span><br></pre></td></tr></table></figure>

<p>正则表达式还可以指定 i 标志，表示忽略大小写，m 标志，表示执行多行匹配</p>
<h5 id="3-4-JSON"><a href="#3-4-JSON" class="headerlink" title="3.4 JSON"></a>3.4 JSON</h5><h6 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h6><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> xiaoming = &#123;</span><br><span class="line">    name: <span class="string">&#x27;小明&#x27;</span>,</span><br><span class="line">    age: <span class="number">14</span>,</span><br><span class="line">    gender: <span class="literal">true</span>,</span><br><span class="line">    height: <span class="number">1.65</span>,</span><br><span class="line">    grade: <span class="literal">null</span>,</span><br><span class="line">    <span class="string">&#x27;middle-school&#x27;</span>: <span class="string">&#x27;\&quot;W3C\&quot; Middle School&#x27;</span>,</span><br><span class="line">    skills: [<span class="string">&#x27;JavaScript&#x27;</span>, <span class="string">&#x27;Java&#x27;</span>, <span class="string">&#x27;Python&#x27;</span>, <span class="string">&#x27;Lisp&#x27;</span>]</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> s = <span class="built_in">JSON</span>.stringify(xiaoming);</span><br><span class="line"><span class="built_in">console</span>.log(s);</span><br></pre></td></tr></table></figure>

<p>要输出好看些，可以加上参数，按缩进输出</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">JSON</span>.stringify(xiaoming, <span class="literal">null</span>, <span class="string">&#x27;  &#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>第二个参数用于控制如何筛选对象的键值，如果想输出指定的属性，可以传入 Array</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">JSON</span>.stringify(xiaoming, [<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;skills&#x27;</span>], <span class="string">&#x27;  &#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>还可以传入一个函数，这样对象的每个键值对都会被函数先处理</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">convert</span>(<span class="params">key, value</span>) </span>&#123; </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> value.toUpperCase();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">JSON</span>.stringify(xiaoming, convert, <span class="string">&#x27;  &#x27;</span>);<span class="comment">//把属性值都变成大写</span></span><br></pre></td></tr></table></figure>

<p>如果还想要精确控制如何序列化小明，可以给xiaoming 定义一个 toJSON() 的方法，直接返回 JSON 应该序列化的数据</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> xiaoming = &#123;</span><br><span class="line">    name: <span class="string">&#x27;小明&#x27;</span>,</span><br><span class="line">    age: <span class="number">14</span>,</span><br><span class="line">    gender: <span class="literal">true</span>,</span><br><span class="line">    toJSON: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;Name&#x27;</span>: <span class="built_in">this</span>.name,</span><br><span class="line">        <span class="string">&#x27;Age&#x27;</span>: <span class="built_in">this</span>.age</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">JSON</span>.stringfy(xiaoming);</span><br></pre></td></tr></table></figure>

<h6 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h6><p>JSON.parse() 把 JSON 格式的字符串变成一个 JavaScript 对象</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">JSON</span>.parse(<span class="string">&#x27;[1,2,3,true]&#x27;</span>);<span class="comment">//[1,2,3,true]</span></span><br><span class="line"><span class="built_in">JSON</span>.parse(<span class="string">&#x27;123.45&#x27;</span>);<span class="comment">//123.45</span></span><br></pre></td></tr></table></figure>

<p>JSON.parse() 还可以接收一个函数，用来转换解析出的属性</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = <span class="built_in">JSON</span>.parse(<span class="string">&#x27;&#123;&quot;name&quot;:&quot;小明&quot;,&quot;age&quot;:14&#125;&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">key, value</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (key === <span class="string">&#x27;name&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> value + <span class="string">&#x27;同学&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(obj)); <span class="comment">// &#123;name: &#x27;小明同学&#x27;, age: 14&#125;</span></span><br></pre></td></tr></table></figure>























]]></content>
  </entry>
  <entry>
    <title>Python3网络爬虫开发实战-11JavaScript逆向</title>
    <url>/2022/10/02/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-11JavaScript%E9%80%86%E5%90%911/</url>
    <content><![CDATA[<h4 id="JavaScript-压缩"><a href="#JavaScript-压缩" class="headerlink" title="JavaScript 压缩"></a>JavaScript 压缩</h4><p>去除 JavaScript 代码中不必要的空格、换行等内容，使代码都压缩为几行内容，降低代码可读性，同时提高网站加载速度</p>
<p>目前主流的前端开发技术大多都会利用 webpack、Rolllup 等工具进行打包，webpack、Rollup 会对源代码进行编译和压缩，输出几个打包好的 JavaScript 文件</p>
<p>JavaScript 压缩技术只能在很小程度上起到防护作用</p>
<h4 id="JavaScript-混淆"><a href="#JavaScript-混淆" class="headerlink" title="JavaScript 混淆"></a>JavaScript 混淆</h4><p>使用变量替换、字符串阵列化、控制流平坦化、多态变异、僵尸函数、调试保护等手段，使代码变得难以阅读和分析</p>
<h4 id="JavaScript-加密"><a href="#JavaScript-加密" class="headerlink" title="JavaScript 加密"></a>JavaScript 加密</h4><p>将 JavaScript 代码进行加密，转成人无法阅读或者解析的代码，如借用 WebAssembly 技术，可以直接讲JavaScript代码用C/C++实现，JavaScript调用其变异后形成的文件来执行相应的功能</p>
<p>前端开发中，JavaScript 混淆的主要实现是 javascript-obfuscator 和 terser 这两个库，都能提供一些代码混淆功能，也都有对应的 webpack 和 Rollup 打包工具的插件</p>
<h5 id="javascript-obfuscator"><a href="#javascript-obfuscator" class="headerlink" title="javascript-obfuscator"></a>javascript-obfuscator</h5><p>需要安装 Node.js 12.x 及以上版本</p>
<p>新建文件夹 js-obfuscator，进入文件夹，初始化工作空间</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm init</span><br></pre></td></tr></table></figure>

<p>会提示输入一些信息，输入信息，然后创建 package.json 文件，这就完成项目初始化了。</p>
<p>接下来安装 javascript-obfuscator 库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm i -D javascript-obfuscator</span><br></pre></td></tr></table></figure>

<p>完成后看到本地 js-obfuscator 文件夹下生成了一个 node_modules 文件夹，里面就包含了 javascript-obfuscator 这个库</p>
<img src="/Users/caodaxun/hexo/source/_posts/Python3网络爬虫开发实战-11JavaScript逆向1/1.png" alt="1" style="zoom:90%;" />

<p>实现混淆样例：</p>
<p>创建 main.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> code = <span class="string">`</span></span><br><span class="line"><span class="string">	let x = &#x27;1&#x27; + 1</span></span><br><span class="line"><span class="string">	console.log(&#x27;x&#x27;, x)</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="keyword">const</span> options = &#123;</span><br><span class="line">	compact: <span class="literal">false</span>,</span><br><span class="line">	controlFlowFlattening: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obfuscator = <span class="built_in">require</span>(<span class="string">&#x27;javascript-obfuscator&#x27;</span>)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">obfuscate</span>(<span class="params">code, options</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> obfuscator.obfuscate(code, options).getObfuscatedCode()</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(obfuscate(code, options))</span><br></pre></td></tr></table></figure>

<p>这里定义了两个变量：code，需要被混淆的代码；options，混淆选项</p>
<p>接下来引入 javascript-obfuscator 库，定义一个方法传入 code 和 options 获取混淆后的代码，控制台输出混淆后的代码</p>
<p><img src="/Users/caodaxun/hexo/source/_posts/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-11JavaScript%E9%80%86%E5%90%911/2.png" alt="2"></p>
<h6 id="代码压缩"><a href="#代码压缩" class="headerlink" title="代码压缩"></a>代码压缩</h6><p>参数 compact。压缩后变量名变成了十六进制形式字符串</p>
<h6 id="变量名混淆"><a href="#变量名混淆" class="headerlink" title="变量名混淆"></a>变量名混淆</h6><p>参数 <strong>identifierNamesGenerator</strong>。</p>
<p>通过这个参数可以控制变量名混淆的方式，如设置为 hexadecimal：则会将变量名替换为十六进制形式字符串，如0xabc123；设置为 mangled：将变量名替换为普通简写字符串，如 a、b、c</p>
<p>参数默认值 hexadecimal</p>
<p>参数  <strong>identifiersPrefix</strong> 。</p>
<p>还可以通过设置 <strong>identifiersPrefix</strong> 参数控制混淆后变量前缀</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">identifiersPrefix: &#39;germey&#39;</span><br></pre></td></tr></table></figure>

<p>混淆后的变量前缀加上了自定义的字符串 germey</p>
<p>参数 <strong>renameGlobals</strong> </p>
<p>这个参数可以指定是否混淆全局变量和函数名称，默认值为 false</p>
<h6 id="字符串混淆"><a href="#字符串混淆" class="headerlink" title="字符串混淆"></a>字符串混淆</h6><p>字符串混淆，即将一个字符串声明放到一个数组里，使之无法被直接搜到，可以通过 stringArray 参数来控制，默认为 true</p>
<p>还可以通过 rotateStringArray 参数来控制数组化后结果的元素顺序，默认 true；stringArrayEncoding 参数控制数组的编码形式，默认不开启编码；如果设置为 true 或者 base64，则会使用 base64 编码，如果设置为 rc4，则使用 RC4编码；stringArrayThreshold 控制启用编码的概率，返回0-1 默认值 0.8</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> options = &#123;</span><br><span class="line">	stringArray: <span class="literal">true</span>,</span><br><span class="line">  rotateStringArray: <span class="literal">true</span>,</span><br><span class="line">  stringArrayEncoding: <span class="literal">true</span>,</span><br><span class="line">  stringArrayThreshold: <span class="number">1</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>unicodeEscapeSequence 参数对字符串进行 Unicode 转码</p>
<h6 id="代码自我保护"><a href="#代码自我保护" class="headerlink" title="代码自我保护"></a>代码自我保护</h6><p>设置 selfDefending 参数开启代码自我保护功能，开启后，混淆后的 JavaScript 会强制以一行形式显示。如果将混淆后的代码进行格式化或者重命名，该段代码将无法执行</p>
<h6 id="控制流平坦化"><a href="#控制流平坦化" class="headerlink" title="控制流平坦化"></a>控制流平坦化</h6><p>控制流平坦化就是将代码的执行逻辑混淆，通过 controlFlowFlattening: true 参数</p>
<p>启用后，代码的执行时间会变长，最长达 1.5 倍之多</p>
<p>controlFlowFlatteningThreshold 参数控制比例，范围0-1</p>
<h6 id="无用代码注入"><a href="#无用代码注入" class="headerlink" title="无用代码注入"></a>无用代码注入</h6><p>参数 deadCodeInjection：true 开启。deadCodeInjectionThreshold 参数控制比例，0-1，默认0.4</p>
<h6 id="对象键名替换"><a href="#对象键名替换" class="headerlink" title="对象键名替换"></a>对象键名替换</h6><p>参数 transformObjectKeys：true 开启</p>
<h6 id="禁用控制台输出"><a href="#禁用控制台输出" class="headerlink" title="禁用控制台输出"></a>禁用控制台输出</h6><p>参数 disableConsoleOutput：true 来禁用掉 console.log 输出功能</p>
<h6 id="调试保护"><a href="#调试保护" class="headerlink" title="调试保护"></a>调试保护</h6><p>如果在JavaScript代码中加入 debugger 关键字，那么执行到该位置的时候，就会进入调试模式。如果在代码多个位置都加入 debugger 关键字，或者定义某个逻辑来反复执行 debugger，就会不断进入调试模式，原本的代码就无法顺畅执行了，这个过程可以称为调试保护。</p>
<p>参数 debugProtection：true 开启调试保护机制。debugProtectionInterval 启用无限调试</p>
<h6 id="域名锁定"><a href="#域名锁定" class="headerlink" title="域名锁定"></a>域名锁定</h6><p>domainLock：[‘cuiqingcai.com’] 控制JavaScript代码只能在特定的域名下运行，不能在其它网站运行</p>
<h6 id="特殊编码"><a href="#特殊编码" class="headerlink" title="特殊编码"></a>特殊编码</h6><p>还有些特殊的工具包，如 aaencode、jjencode、jsfuck 等，它们可以对代码进行混淆和编码</p>
<h5 id="WebAssembly"><a href="#WebAssembly" class="headerlink" title="WebAssembly"></a>WebAssembly</h5><p>将一些和兴逻辑使用其他语言（如C/C++语言）来编写，并编译成类似字节码的文件，并通过JavaScript调用执行，从而起到二进制级别的防护作用</p>
<h4 id="浏览器调试"><a href="#浏览器调试" class="headerlink" title="浏览器调试"></a>浏览器调试</h4><p><a href="https://spa2.scrape.center/">https://spa2.scrape.center</a> 演示</p>
<h5 id="Chrome"><a href="#Chrome" class="headerlink" title="Chrome"></a>Chrome</h5><h6 id="查看节点事件"><a href="#查看节点事件" class="headerlink" title="查看节点事件"></a>查看节点事件</h6><p>打开开发者工具，通过 Elements 面板可以审查页面的节点信息。</p>
<p>右侧的 Styles 选项卡，可以看到节点对应的CSS样式，这里可以自行增删样式，实时预览效果。</p>
<p>Computed 选项卡，可以看到节点的盒子模型，比如内边距、外边距等</p>
<p>Event Listeners 选项卡，可以查看节点已绑定的事件。change：HTML元素改变时会触发；load：浏览器完成页面加载时会触发；click：用户点击HTML元素时会触发</p>
<p>选中切换到第2页的节点，查看绑定事件</p>
<img src="/Users/caodaxun/hexo/source/_posts/Python3网络爬虫开发实战-11JavaScript逆向1/3.png" alt="3" style="zoom:100%;" />

<p>这里有对应事件的代码位置。内容文件名为 chunk-vendors.77daf991.js，后面一个冒号紧跟数字 7，所以对应事件处理函数定义在 chunk-vendors.77daf991.js 文件的第 7 行。点击会跳转到对应的位置。</p>
<h6 id="代码美化"><a href="#代码美化" class="headerlink" title="代码美化"></a>代码美化</h6><p>通过 Event Listeners 找到绑定事件，跳转到代码所在位置。点击代码面板左下角的格式化按钮 <code>&#123;&#125;</code>，格式化代码</p>
<p>会出现一个 chunk-vendors.77daf991.js:formatted 选项卡。</p>
<p><img src="/Users/caodaxun/hexo/source/_posts/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-11JavaScript%E9%80%86%E5%90%911/4.png" alt="4"></p>
<h6 id="断点调试"><a href="#断点调试" class="headerlink" title="断点调试"></a>断点调试</h6><p>添加断点只需点击对应行号，点击第2页的按钮触发断点，看到断点触发，页面中显示 Paused in debugger 提示。</p>
<p><img src="/Users/caodaxun/hexo/source/_posts/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-11JavaScript%E9%80%86%E5%90%911/5.png" alt="5"></p>
<p>Watch面板</p>
<p>这里可以自行添加想要查看的变量和方法，点击右上角+，可以添加任意想要监听的对象</p>
<p>如这里比较关注o.apply 方法，点击添加 o.apply，这里就会把对应的方法定义呈现出来，展开后再点击 FunctionLocation 定位其源码位置。</p>
<p>Console 面板</p>
<p>这里可以输入任意JavaScript代码执行输出对应结果</p>
<h6 id="观察调用栈"><a href="#观察调用栈" class="headerlink" title="观察调用栈"></a>观察调用栈</h6><p>debugger 调试过程中单步执行后，Call Stack 可以查看调用栈</p>
<h6 id="Ajax-断点"><a href="#Ajax-断点" class="headerlink" title="Ajax 断点"></a>Ajax 断点</h6><p>在 Sources 面板下面，找到 XHR/fetch Breakpoints，这里就可以设置 Ajax 断点</p>
<p><img src="/Users/caodaxun/hexo/source/_posts/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-11JavaScript%E9%80%86%E5%90%911/6.png" alt="6"></p>
<p>要设置断点，先要观察 Ajax 请求，点击第2页，在Network面板观察 Ajax 请求是怎样的。</p>
<p>看到请求的URL中包含 <code>/api/movie</code> 这样的内容。所以可以在 XHR/fetch Breakpoints 添加拦截规则，点+号，添加  <code>/api/movie</code></p>
<p>再点击第3页，触发第3页的 Ajax 请求。</p>
<p><img src="/Users/caodaxun/hexo/source/_posts/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-11JavaScript%E9%80%86%E5%90%911/7.png" alt="7"></p>
<p>发现它停到了Ajax最后发送的那个时候。再通过 Call Stack 顺着找到前序调用逻辑，最后找到一个 onFetchData 的方法</p>
<p><img src="/Users/caodaxun/hexo/source/_posts/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-11JavaScript%E9%80%86%E5%90%911/8.png" alt="8"></p>
<p>这里使用 axios 库发起了一个 Ajax 请求，还有 limit、offset、token 这3个参数</p>
<h6 id="改写-JavaScript-文件"><a href="#改写-JavaScript-文件" class="headerlink" title="改写 JavaScript 文件"></a>改写 JavaScript 文件</h6><p>浏览器的 overrides 功能，在 Sources 面板左侧，可以在 Overrides 面板上选定一个本地的文件夹，用于保存需要更改的 JavaScript 文件</p>
<p>在定位到 onFetchData 方法，查看格式化后的代码。</p>
<p>因为格式化后的代码是无法在浏览器中直接修改的，可以将格式化后的代码复制到文本编辑器中，添加一行代码</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">&#125;).then((<span class="function"><span class="keyword">function</span>(<span class="params">a</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;response&#x27;</span>, a);<span class="comment">//添加一行代码</span></span><br><span class="line">  <span class="keyword">var</span> e = a.data, </span><br><span class="line">  ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>接着将修改后的内容替换到原来的JavaScript文件（未格式化的代码）直接替换 JavaScript 的所有内容，保存后 Overrides 选项文件夹里面看到新生成文件。刷新页面看到控制台打印了请求结果</p>
<p>这里还可以增加一些 JavaScript 逻辑，比如直接将变量 a 的结果通过 API 发送到远程服务器，并通过服务器将数据保存下来，这就完成了拦截 Ajax 请求并保存了。</p>
<h4 id="JavaScript-Hook-的使用"><a href="#JavaScript-Hook-的使用" class="headerlink" title="JavaScript Hook 的使用"></a>JavaScript Hook 的使用</h4><p>Tampermonkey 插件也叫油猴，利用它我们几乎可以在网页中执行任何 JavaScript 代码，实现想要的功能</p>
<p><a href="https://greasyfork.org/zh-CN/scripts">https://greasyfork.org/zh-CN/scripts</a> 可以找到一些实用脚本</p>
<p>API：<a href="https://www.tampermonkey.net/documentation.php">https://www.tampermonkey.net/documentation.php</a></p>
<p>Hook JavaScript 里的base64编码</p>
<p>btoa 方法，在JavaScript中该方法用于将字符串编码成 base64 字符串。</p>
<h5 id="Tampermonkey-注入"><a href="#Tampermonkey-注入" class="headerlink" title="Tampermonkey 注入"></a>Tampermonkey 注入</h5><p>新建 Tampermonkey 脚本</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//@name HookBase64</span></span><br><span class="line"><span class="comment">//@namespace https://login1.scrape.center/ </span></span><br><span class="line"><span class="comment">//@match https://login1.scrape.center/ //脚本生效网址</span></span><br><span class="line"><span class="comment">//@grant none</span></span><br><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="meta">	&#x27;use strict&#x27;</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">hook</span>(<span class="params">object, attr</span>)</span>&#123; <span class="comment">//hook object对象的attr参数</span></span><br><span class="line">    <span class="keyword">var</span> func = object[attr]</span><br><span class="line">    object[attr] = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; </span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">&#x27;hooked&#x27;</span>, object, attr)</span><br><span class="line">      <span class="keyword">var</span> ret = func.apply(object, <span class="built_in">arguments</span>)</span><br><span class="line">      <span class="keyword">debugger</span></span><br><span class="line">      <span class="keyword">return</span> ret</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  hook(<span class="built_in">window</span>, btoa)</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>

<p>先把原方法赋值为一个变量 var func = object[attr]，即调用 func 就可以实现和原来相同的功能，接着改写方法的定义，将 object[attr] = function() 改写成一个新的方法，新方法中 func.apply 方法重新调用原来方法，保证前后执行方法不受影响。</p>
<p>自定义方法之后，我们在方法前后加入了自己的代码</p>
<h5 id="控制台注入"><a href="#控制台注入" class="headerlink" title="控制台注入"></a>控制台注入</h5><p>可以将代码复制输入到 控制台，执行完后相当于把 window 的 btoa 方法改写了</p>
<p>控制台测试 btoa(‘germey’)</p>
<h5 id="重写-JavaScript"><a href="#重写-JavaScript" class="headerlink" title="重写 JavaScript"></a>重写 JavaScript</h5><p>Hook 代码在控制台输入的，一旦页面刷新就不生效了</p>
<p>借助 Chrome 的 Overrides 功能，Overrides会在本地生成一个 JavaScript 文件副本，以后每次刷新都会使用副本内容</p>
<p>随便选个 JavaScript 脚本，添加上 Hook 代码，保存</p>
<h4 id="使用Python模拟执行JavaScript"><a href="#使用Python模拟执行JavaScript" class="headerlink" title="使用Python模拟执行JavaScript"></a>使用Python模拟执行JavaScript</h4><p>使用库 PyExecJS</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install pyexecjs</span><br></pre></td></tr></table></figure>

<p>PyExecJS 是用于执行 JavaScript 的，但执行JavaScript的功能还需要依赖JavaScript运行环境，安装好这个库之外，还需要安装一个JavaScript运行环境，Node.js</p>
<p>案例：<a href="https://spa7.scrape.center/">https://spa7.scrape.center</a></p>
<p>一个NBA球星网站，展示一些球星的基本信息，每张卡片都有个加密字符串</p>
<p>打开开发者工具很容易找到加密字符串的生成逻辑，可以通过断点查看</p>
<p><img src="/Users/caodaxun/hexo/source/_posts/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-11JavaScript%E9%80%86%E5%90%911/9.png" alt="9"></p>
<p>getToken 方法的输入就是单个球员的信息，整个加密逻辑就是提取球员的名字、生日、身高、体重接着进行base64，然后进行DES加密</p>
<p>加密算法依赖 crypto-js 库，使用 CryptoJS 对象来实现加密算法。</p>
<p>执行 crypto-js 库对应的这个 JavaScript 文件（crypto-js.main.js）之后，CryptoJS 就被注入浏览器全局环境下了</p>
<h5 id="模拟调用"><a href="#模拟调用" class="headerlink" title="模拟调用"></a>模拟调用</h5><p>将 getToken 方法改写下，this.key 固定</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getToken</span>(<span class="params">player</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">let</span> key = CryptoJS.enc.Utf8.parse(<span class="string">&#x27;fip...&#x27;</span>)</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为这个方法的模拟执行需要 CryptoJS 这个对象，如果直接调用这个方法，会报 CryptoJS 未定义错误，还需要模拟执行 crypto-js.main.js </p>
<p>所以模拟执行分两步：</p>
<p>模拟执行 crypto-js.main.js 里面的JavaScript，用于声明 CryptoJS 对象</p>
<p>模拟运行 getToken 方法的定义，用于声明 getToken 方法</p>
<p>使用 PyExecJS 模拟执行：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> execjs</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">item = &#123;</span><br><span class="line">  <span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;xx&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;image&#x27;</span>: <span class="string">&#x27;xx.png&#x27;</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line">file = <span class="string">&#x27;crypto.js&#x27;</span></span><br><span class="line"><span class="comment">//使用execjs的get方法获取JavaScript执行环境，赋值为node</span></span><br><span class="line">node = execjs.get()</span><br><span class="line">ctx = node.complie(open(file).read)</span><br><span class="line">js = f<span class="string">&quot;getToken(&#123;json.dumps(item,ensure_ascii=False)&#125;)&quot;</span></span><br><span class="line">print(js)</span><br><span class="line">result = ctx.eval(js)</span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>

<p>调用node的complie方法，传入crypto.js 文件的文本内容，complie 方法会返回一个 JavaScript 的上下文对象，赋值给 ctx。这里可以理解为 ctx 对象里面执行过了 crypto-js.main.js，CryptoJS 就声明好了，然后紧接着 getToken 方法的声明也被执行，所以 getToken 方法也定义好了</p>
<p>定义 js变量，传入球员信息，执行js，返回最终加密字符串</p>
<h4 id="使用Node-js模拟执行JavaScript"><a href="#使用Node-js模拟执行JavaScript" class="headerlink" title="使用Node.js模拟执行JavaScript"></a>使用Node.js模拟执行JavaScript</h4><p>想要计算出每位球星所对应的加密字符串，是要加载 Crypto 库并执行 getToken 方法，这里直接用 Node.js 来实现</p>
<p>把 crypto-js.main.js 文件中的内容复制下来，新建 crypto.js 文件把内容粘贴进去</p>
<p>新建 main.js</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> CryptoJS = <span class="built_in">require</span>(<span class="string">&quot;./crypto&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getToken</span>(<span class="params">player</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">let</span> key = CryptoJS.enc.Utf8.parse(<span class="string">&#x27;fip...&#x27;</span>)</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> player = &#123;</span><br><span class="line">  <span class="string">&#x27;xx&#x27;</span>: <span class="string">&#x27;xx&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(getToken(player))</span><br></pre></td></tr></table></figure>

<p>直接使用 Node.js 中的 require 方法导入 crypto.js 这个文件，然后将其赋值为 CryptoJS 对象，这样就完成了 CryptoJS 对象的初始化</p>
<p>运行 main.js</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">node main.js</span><br></pre></td></tr></table></figure>

<p>如果想用 Python 来编写整个爬虫，怎么和 Node.js 来对接呢</p>
<p>可以使用 Node.js 把上面算法暴露成一个 HTTP服务就好，这样 Python 直接调用 Node.js 暴露的HTTP 服务，通过 Request Body 传入球员信息，加密字符串通过 HTTP 的 Response 返回</p>
<p>Node.js 中最流行的 HTTP 服务框架 - express</p>
<p>安装 express</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm i express</span><br></pre></td></tr></table></figure>

<h4 id="浏览器环境下JavaScript的模拟执行"><a href="#浏览器环境下JavaScript的模拟执行" class="headerlink" title="浏览器环境下JavaScript的模拟执行"></a>浏览器环境下JavaScript的模拟执行</h4><p>使用 playwright 来实现浏览器辅助逆向</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install playwright</span><br><span class="line">playwright install</span><br></pre></td></tr></table></figure>

<p>运行两条命令后，会安装 playwright 库，并安装 Chromium、Firefox、WebKit 三个内核的浏览器供 playwright 直接使用</p>
<p>浏览器中已经把上下文环境和依赖都加载成功了，只需要把局部方法挂在到全局window对象上</p>
<p>利用 playwright 的 Request Interception 机制将想要替换的任意文件进行替换</p>
<p>站点 <a href="https://spa2.scrape.center/">https://spa2.scrape.center</a> 的 Ajax 请求参数带有一个token</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> token = (<span class="built_in">this</span>.page-<span class="number">1</span>)*<span class="built_in">this</span>.limit,e=<span class="built_in">Object</span>(i[<span class="string">&quot;a&quot;</span>])(<span class="built_in">this</span>.$store.state.url.index,a)</span><br></pre></td></tr></table></figure>

<p>实现 Object(i[“a”]) 的全局挂载，只需要将其赋值给 window 对象的一个属性即可，添加</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">window</span>.encrypt = <span class="built_in">Object</span>(i[<span class="string">&quot;a&quot;</span>])</span><br></pre></td></tr></table></figure>

<p>接着将修改后的 JavaScript 代码文件保存到本地，命名为 chunk.js</p>
<p>接下来利用 playwright 启动一个浏览器，并使用 Request Interception 将 JavaScript 文件替换</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> playwright.sync_api <span class="keyword">import</span> sync_playwright</span><br><span class="line">BASE_URL = <span class="string">&#x27;https://spa2.scrape.center&#x27;</span></span><br><span class="line">context = sync_playwright().start()</span><br><span class="line">browser = context.chromium.launch()</span><br><span class="line">page = browser.new_page()</span><br><span class="line">page.route(</span><br><span class="line">	<span class="string">&quot;/js/chunk-10192a00.243cb8b7.js&quot;</span>,</span><br><span class="line">  <span class="keyword">lambda</span> route: route.fulfill(path=<span class="string">&quot;./chunk.js&quot;</span>)</span><br><span class="line">)</span><br><span class="line">page.goto(BASE_URL)</span><br></pre></td></tr></table></figure>

<p>首先用 playwright 创建无头浏览器，利用 new_page 创建一个新的页面，并定义了一个关键的路由。</p>
<p>路由第一个参数：原本加载的文件路径。通过请求的Headers 中可以看到 Request URL</p>
<p> <a href="https://spa2.scrape.center/js/chunk-10192a00.243cb8b7.js">https://spa2.scrape.center/js/chunk-10192a00.243cb8b7.js</a></p>
<p>路由第二个参数：利用 route 的 fulfill 方法指定本地的文件</p>
<p>这样 playwright 加载 /js/chunk-10192a00.243cb8b7.js 文件的时候，其内容就会被替换为我们本地保存的 chunk.js 文件</p>
<ul>
<li>模拟调用</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_token</span>(<span class="params">offset</span>):</span></span><br><span class="line">  result = page.evaluate(<span class="string">&#x27;&#x27;&#x27;()=&gt;&#123;</span></span><br><span class="line"><span class="string">  	return window.encrypt(&quot;%s&quot;, &quot;%s&quot;)</span></span><br><span class="line"><span class="string">  &#125;&#x27;&#x27;&#x27;</span> % (<span class="string">&#x27;/api/movie&#x27;</span>, offset))</span><br><span class="line">  <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>















]]></content>
  </entry>
  <entry>
    <title>Python3网络爬虫开发实战-11JavaScript逆向2</title>
    <url>/2022/10/02/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-11JavaScript%E9%80%86%E5%90%912/</url>
    <content><![CDATA[<p>JavaScript Beautifier：<a href="https://beautifier.io/">https://beautifier.io/</a>  格式化工具</p>
<h4 id="AST"><a href="#AST" class="headerlink" title="AST"></a>AST</h4><p>AST 是源代码的抽象语法结构的树状表示，树上的每个节点都表示源代码中的一种结构</p>
<p>AST 在线解析网站 <a href="https://astexplorer.net/">https://astexplorer.net/</a></p>
<h4 id="Babel"><a href="#Babel" class="headerlink" title="Babel"></a>Babel</h4><p>JavaScript 语法编译器，内置了很多分析 JavaScript 代码的方法，可以实现 JavaScript 代码到 AST 的转换</p>
<p>安装 Babel 命令行工具 @babel/node</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install -g @babel&#x2F;node</span><br></pre></td></tr></table></figure>

<p>初始化 Node.js 项目 learn-ast，在 learn-ast 目录下运行初始化命令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm init</span><br><span class="line">npm install -D @babel&#x2F;core @babel&#x2F;cli @babel&#x2F;preset-env</span><br></pre></td></tr></table></figure>

<p>运行完毕后，就会生成一个 package.json 文件并在 devDependencies 中列出了刚安装的几个 Node.js 包</p>
<p>接着需要在 learn-ast 目录下创建 .babelrc 文件，内容</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;presets&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;@babel/preset-env&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这就完成了初始化操作</p>
<h5 id="节点类型"><a href="#节点类型" class="headerlink" title="节点类型"></a>节点类型</h5><p>Babel 中所支持的一些类型：</p>
<ul>
<li>Literal</li>
</ul>
<p>字面量，即简单的文字表示，3、”abc”、true 这些都是基本的字面量，又可以进一步分为</p>
<p>RegExpLiteral、NullLiteral、StringLiteral、BooleanLiteral、NumericLiteral、BigIntLiteral 等类型，更确却地代表某一种字面量</p>
<ul>
<li>Identifier</li>
</ul>
<p>标识符，指代一些变量的名称，const name = ‘Germy’，name 就是一个标识符</p>
<ul>
<li>Expressions表达式</li>
</ul>
<p>还有其他类型 Declarations声明、Statements语句、Classes类、Functions方法声明、Modules模块、Program程序</p>
<h5 id="babel-parser"><a href="#babel-parser" class="headerlink" title="@babel/parser"></a>@babel/parser</h5><p>Babel 中的 JavaScript 解析器，也是一个 Node.js 包</p>
<p>parse 方法，支持解析一段 JavaScript 代码，输入一段 JavaScript 代码，输出 JavaScript 代码对应的抽象语法树，即 AST</p>
<p>parseExpression方法，尝试解析单个 JavaScript 表达式并考虑了性能问题，一般直接使用 parse 就够了</p>
<ul>
<li>测试</li>
</ul>
<p>新建 JavaScript 文件，codes/code1.js </p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="number">3</span></span><br><span class="line"><span class="keyword">let</span> string = <span class="string">&#x27;hello&#x27;</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; a; i++)&#123;</span><br><span class="line">	string += <span class="string">&#x27;world&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;string&#x27;</span>, string)</span><br></pre></td></tr></table></figure>

<p>新建 basic1.js </p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">&quot;@babel/parser&quot;</span></span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&quot;fs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = fs.readFileSync(<span class="string">&#x27;code/code1.js&#x27;</span>,<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> ast = parse(code)</span><br><span class="line"><span class="built_in">console</span>.log(ast)</span><br></pre></td></tr></table></figure>

<p>使用 babel-node 运行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">babel-node basic1.js</span><br></pre></td></tr></table></figure>

<p>报错</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">internal&#x2F;modules&#x2F;cjs&#x2F;loader.js:1032</span><br><span class="line">    throw err;</span><br><span class="line">    ^</span><br><span class="line">Error: Cannot find module &#39;@babel&#x2F;core&#39;</span><br></pre></td></tr></table></figure>

<ul>
<li>解决办法：全局安装core</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install -g @babel&#x2F;core</span><br></pre></td></tr></table></figure>

<p>转换为 AST 之后，怎样再把 AST 转回 JavaScript 代码？可以借助 generate 方法</p>
<h5 id="babel-generate"><a href="#babel-generate" class="headerlink" title="@babel/generate"></a>@babel/generate</h5><p>提供了 generate 方法将 AST 还原成 JavaScript 代码</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">&quot;@babel/parser&quot;</span></span><br><span class="line"><span class="keyword">import</span> generate <span class="keyword">from</span> <span class="string">&quot;@babel/generator&quot;</span></span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&quot;fs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = fs.readFileSync(<span class="string">&#x27;code/code1.js&#x27;</span>,<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> ast = parse(code)</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="attr">code</span>: output &#125; = generate(ast)</span><br><span class="line"><span class="built_in">console</span>.log(output)</span><br></pre></td></tr></table></figure>

<p>generate 方法还可以在第二个参数接收一些配置选项，第三个参数可以接收原代码作为输出参考</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> output = generate(ast, &#123;<span class="comment">/*options*/</span>&#125;, code)</span><br></pre></td></tr></table></figure>

<p>比如，想要和原代码维持相同的代码行</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="attr">code</span>:output &#125; = generate(ast, &#123;</span><br><span class="line">	retainLines: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(output)</span><br></pre></td></tr></table></figure>

<p>这时生成的代码中间没有出现空行了，和原来的代码保持一致</p>
<h5 id="babel-traverse"><a href="#babel-traverse" class="headerlink" title="@babel/traverse"></a>@babel/traverse</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install -D @babel&#x2F;traverse</span><br></pre></td></tr></table></figure>

<h6 id="遍历"><a href="#遍历" class="headerlink" title="遍历"></a>遍历</h6><p>AST 的遍历使用 @babel/traverse，接收一个 AST，利用 traverse 方法就可以遍历其中的所有节点，遍历方法中，我们便可以对每个节点进行操作了</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">&quot;@babel/parser&quot;</span></span><br><span class="line"><span class="keyword">import</span> generate <span class="keyword">from</span> <span class="string">&quot;@babel/generator&quot;</span></span><br><span class="line"><span class="keyword">import</span> traverse <span class="keyword">from</span> <span class="string">&quot;@babel/traverse&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&quot;fs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = fs.readFileSync(<span class="string">&#x27;code/code1.js&#x27;</span>,<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> ast = parse(code)</span><br><span class="line">traverse(ast,&#123;</span><br><span class="line">	<span class="function"><span class="title">enter</span>(<span class="params">path</span>)</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(path)</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>traverse 第二个参数定义了相关处理逻辑，声明了一个 enter 方法，接收 path 参数，这个 enter 方法在每个节点被遍历到时都会被调用，其中 path 里面就包含了当前被遍历到的节点的相关信息，运行查看输出</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">babel-node basic1.js</span><br></pre></td></tr></table></figure>

<p>输出内容比较复杂，它的类型是 NodePath，拥有 parent、container、node、scope、type 等多个属性</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">NodePath &#123;</span><br><span class="line">  contexts: [</span><br><span class="line">    TraversalContext &#123;</span><br><span class="line">      queue: [<span class="built_in">Array</span>],</span><br><span class="line">      priorityQueue: [],</span><br><span class="line">      parentPath: [NodePath],</span><br><span class="line">      scope: [Scope],</span><br><span class="line">      state: <span class="literal">undefined</span>,</span><br><span class="line">      opts: [<span class="built_in">Object</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  state: <span class="literal">undefined</span>,</span><br><span class="line">  opts: &#123; <span class="attr">enter</span>: [ [<span class="built_in">Function</span>: enter] ], <span class="attr">_exploded</span>: <span class="literal">true</span>, <span class="attr">_verified</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">  _traverseFlags: <span class="number">0</span>,</span><br><span class="line">  skipKeys: <span class="literal">null</span>,</span><br><span class="line">  parentPath: NodePath &#123;</span><br></pre></td></tr></table></figure>

<p>比如 node 属性是一个 Node 类型的对象，代表正在遍历的节点，利用 parent 也能获得一个 Node 类型对象，代表该节点的父节点</p>
<h6 id="修改值"><a href="#修改值" class="headerlink" title="修改值"></a>修改值</h6><p>所以可以利用 path.node 拿到当前对应的 Node 对象，利用 path.parent 拿到当前 Node 对象的父节点。我们可以利用它来对 Node 进行一些处理</p>
<p>比如：可以把值变化下，原代码</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="number">3</span></span><br><span class="line"><span class="keyword">let</span> string = <span class="string">&#x27;hello&#x27;</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; a; i++)&#123;</span><br><span class="line">	string += <span class="string">&#x27;world&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;string&#x27;</span>, string)</span><br></pre></td></tr></table></figure>

<p>想要利用修改 AST 的方式对上面代码修改，变成下面代码</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="number">5</span></span><br><span class="line"><span class="keyword">let</span> string = <span class="string">&#x27;hi&#x27;</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; a; i++)&#123;</span><br><span class="line">	string += <span class="string">&#x27;world&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">&#x27;string&#x27;</span>, string)</span><br></pre></td></tr></table></figure>

<p>可以实现这样的逻辑</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">&quot;@babel/parser&quot;</span></span><br><span class="line"><span class="keyword">import</span> generate <span class="keyword">from</span> <span class="string">&quot;@babel/generator&quot;</span></span><br><span class="line"><span class="keyword">import</span> traverse <span class="keyword">from</span> <span class="string">&quot;@babel/traverse&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&quot;fs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = fs.readFileSync(<span class="string">&#x27;code/code1.js&#x27;</span>,<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> ast = parse(code)</span><br><span class="line">traverse(ast,&#123;</span><br><span class="line">	<span class="function"><span class="title">enter</span>(<span class="params">path</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">let</span> node = path.node</span><br><span class="line">		<span class="keyword">if</span> (node.type == <span class="string">&quot;NumericLiteral&quot;</span> &amp;&amp; node.value == <span class="number">3</span>) &#123;</span><br><span class="line">			node.value = <span class="number">5</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (node.type == <span class="string">&quot;StringLiteral&quot;</span> &amp;&amp; node.value == <span class="string">&quot;hello&quot;</span>) &#123;</span><br><span class="line">			node.value = <span class="string">&quot;hi&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="attr">code</span>: output &#125; = generate(ast)</span><br><span class="line"><span class="built_in">console</span>.log(output)</span><br></pre></td></tr></table></figure>

<p>除了定义 enter 方法之外，我们还可以定义对应特定类型的解析方法，这样遇到此类型的节点时，该方法就会被自动调用，单独定义特定类型的解析方法会显得更有条理</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">traverse(ast,&#123;</span><br><span class="line">	<span class="function"><span class="title">NumericLiteral</span>(<span class="params">path</span>)</span>&#123;</span><br><span class="line">		<span class="function"><span class="title">if</span>(<span class="params">path.node.value==<span class="number">3</span></span>)</span>&#123;</span><br><span class="line">			path.node.value = <span class="number">6</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="function"><span class="title">StringLiteral</span>(<span class="params">path</span>)</span>&#123;</span><br><span class="line">		<span class="function"><span class="title">if</span>(<span class="params">path.node.value==<span class="string">&quot;hello&quot;</span></span>)</span>&#123;</span><br><span class="line">			path.node.value = <span class="string">&quot;he&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h6 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h6><p>删除直接调用 remove 即可</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">&quot;@babel/parser&quot;</span></span><br><span class="line"><span class="keyword">import</span> generate <span class="keyword">from</span> <span class="string">&quot;@babel/generator&quot;</span></span><br><span class="line"><span class="keyword">import</span> traverse <span class="keyword">from</span> <span class="string">&quot;@babel/traverse&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&quot;fs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = fs.readFileSync(<span class="string">&#x27;code/code1.js&#x27;</span>,<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> ast = parse(code)</span><br><span class="line">traverse(ast,&#123;</span><br><span class="line">	<span class="function"><span class="title">CallExpression</span>(<span class="params">path</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">let</span> node = path.node</span><br><span class="line">		<span class="keyword">if</span> (</span><br><span class="line">			node.callee.object.name == <span class="string">&quot;console&quot;</span> &amp;&amp;</span><br><span class="line">			node.callee.property.name == <span class="string">&quot;log&quot;</span></span><br><span class="line">		) &#123;</span><br><span class="line">			path.remove()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="attr">code</span>: output &#125; = generate(ast,&#123;</span><br><span class="line">	retainLines: <span class="literal">true</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(output)</span><br></pre></td></tr></table></figure>

<p>这样就删除了所有的 console.log 语句</p>
<p>如果要插入节点，需要先声明一个节点</p>
<h5 id="babel-types"><a href="#babel-types" class="headerlink" title="@babel/types"></a>@babel/types</h5><p>可以使用 types 声明一个新节点</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>想变成</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="number">1</span></span><br><span class="line"><span class="keyword">const</span> b = a + <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>将最终想变成的代码用 AST 解析</p>
<p><img src="/Users/caodaxun/hexo/source/_posts/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-11JavaScript%E9%80%86%E5%90%912/1.png" alt="1"></p>
<p>可以看到第二行的节点结构了，现在需要做的就是构造这个节点，需要从内而外依次构造</p>
<p>整行代码对应的节点是 VariableDeclarator，生成 VariableDeclarator 可以借助 types 的 variableDeclaration 方法</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//kind: 必须，可以是var let const</span></span><br><span class="line"><span class="comment">//declarations: 必须，是Array&lt;VariableDeclarator&gt; 即 VariableDeclarator </span></span><br><span class="line">t.variableDeclaration(kind, declarations)</span><br></pre></td></tr></table></figure>

<p>kind 可以确定，declarations 的构造借助 types 的 variableDeclarator 方法</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//id 必须，即 Identifier对象</span></span><br><span class="line"><span class="comment">//init Expression对象，默认空</span></span><br><span class="line">t.variableDeclarrator(id, init)</span><br></pre></td></tr></table></figure>

<p>因此还需要构造 id 和 init。这里 id 就是 b 了，借助 types 的 identifier 方法来构造</p>
<p>对 init，它是 expression，AST中可以看到它是 BinaryExpression 类型，可以借助 type 的 binaryExpression 来构造</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//operator 必须 +|-|*|%|&amp;|&gt; ...</span></span><br><span class="line"><span class="comment">//left、right Expression operator左侧/右侧表达式</span></span><br><span class="line">t.binaryExpression(operator, left, right)</span><br></pre></td></tr></table></figure>

<p>根据 AST 这里的 Expression 可以直接声明为 Identifier 和 NumericLiteral，分别用 types 的 identifier和numbeicLiteral创建。</p>
<p>梳理清楚后，从里到外将代码实现出来，一层层构造，最后就声明了一个 VariableDeclaration 类型的节点</p>
<p>最后调用 path 的 insertAfter 方法便可以成功将节点插入到path对应的节点</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">&quot;@babel/parser&quot;</span></span><br><span class="line"><span class="keyword">import</span> generate <span class="keyword">from</span> <span class="string">&quot;@babel/generator&quot;</span></span><br><span class="line"><span class="keyword">import</span> traverse <span class="keyword">from</span> <span class="string">&quot;@babel/traverse&quot;</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> types <span class="keyword">from</span> <span class="string">&quot;@babel/types&quot;</span></span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&quot;fs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = <span class="string">&#x27;const a = 1;&#x27;</span></span><br><span class="line"><span class="keyword">let</span> ast = parse(code)</span><br><span class="line">traverse(ast,&#123;</span><br><span class="line">	<span class="function"><span class="title">VariableDeclaration</span>(<span class="params">path</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">let</span> init = types.binaryExpression(</span><br><span class="line">			<span class="string">&#x27;+&#x27;</span>,</span><br><span class="line">			types.identifier(<span class="string">&#x27;a&#x27;</span>),</span><br><span class="line">			types.numberLiteral(<span class="number">1</span>)</span><br><span class="line">		)</span><br><span class="line">		<span class="keyword">let</span> declarator = types.variableDeclarator(types.identifier(<span class="string">&#x27;b&#x27;</span>), init)</span><br><span class="line">		<span class="keyword">let</span> declaration = types.variableDeclaration(<span class="string">&#x27;const&#x27;</span>, [declarator])</span><br><span class="line">		path.insertAfter(declaration)</span><br><span class="line">		path.stop()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> output = generate(ast,&#123;</span><br><span class="line">	retainLines: <span class="literal">true</span>,</span><br><span class="line">&#125;).code</span><br><span class="line"><span class="built_in">console</span>.log(output) <span class="comment">//const a = 1;const b = a + 1;</span></span><br></pre></td></tr></table></figure>

<p>更多 types 方法参考 <a href="https://babeljs.io/docs/en/babel-types#binaryexpression">https://babeljs.io/docs/en/babel-types#binaryexpression</a></p>
<p>很多方法和节点都是对应的，利用方法便可以创建一个节点。</p>
<h4 id="利用AST还原混淆代码"><a href="#利用AST还原混淆代码" class="headerlink" title="利用AST还原混淆代码"></a>利用AST还原混淆代码</h4><h5 id="表达式还原"><a href="#表达式还原" class="headerlink" title="表达式还原"></a>表达式还原</h5><p>混淆的 JavaScript 代码就是把简单的东西复杂化了，比如一个布尔常量 true，被写成 !![]；一个数字，被转化为 parseInt 加一些字符串的拼接</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> a = !![]</span><br><span class="line"><span class="keyword">const</span> b = <span class="string">&quot;abc&quot;</span> == <span class="string">&quot;bcd&quot;</span></span><br><span class="line"><span class="keyword">const</span> c = (<span class="number">1</span>&lt;&lt;<span class="number">3</span>)|<span class="number">2</span></span><br><span class="line"><span class="keyword">const</span> d = <span class="built_in">parseInt</span>(<span class="string">&quot;5&quot;</span>+<span class="string">&quot;0&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>= 号的右边，其实都是一些表达式的类型，”abc” == “bcd” 就是一个 BinaryExpression，代表布尔类型的结果</p>
<p>将上述代码保存为 code1.js，编写还原代码</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">&quot;@babel/parser&quot;</span></span><br><span class="line"><span class="keyword">import</span> generate <span class="keyword">from</span> <span class="string">&quot;@babel/generator&quot;</span></span><br><span class="line"><span class="keyword">import</span> traverse <span class="keyword">from</span> <span class="string">&quot;@babel/traverse&quot;</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> types <span class="keyword">from</span> <span class="string">&quot;@babel/types&quot;</span></span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&quot;fs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = fs.readFileSync(<span class="string">&#x27;code/code1.js&#x27;</span>,<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> ast = parse(code)</span><br><span class="line">traverse(ast,&#123;</span><br><span class="line">	<span class="string">&quot;UnaryExpression|BinaryExpression|ConditionalExpression|CallExpression&quot;</span>:(</span><br><span class="line">		path</span><br><span class="line">	) =&gt; &#123;</span><br><span class="line">		<span class="keyword">const</span> &#123; confident, value &#125; = path.evaluate()</span><br><span class="line">		<span class="keyword">if</span> (value == <span class="literal">Infinity</span>||value==-<span class="literal">Infinity</span>) <span class="keyword">return</span></span><br><span class="line">		confident &amp;&amp; path.replaceWith(types.valueToNode(value))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="attr">code</span>: output &#125; = generate(ast)</span><br><span class="line"><span class="built_in">console</span>.log(output)</span><br></pre></td></tr></table></figure>

<p>结果 </p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">onst a = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">const</span> b = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">const</span> c = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">const</span> d = <span class="built_in">parseInt</span>(<span class="string">&quot;50&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>利用 traverse 方法对 AST 对象进行遍历，是用 UnaryExpression|BinaryExpression|ConditionalExpression|CallExpression 作为对象的键名，分别用于处理一元表达式、布尔表达式、条件表达式、调用表达式，如果 AST 对应的 path 符合这几种表达式，就会执行定义的回调方法</p>
<p>回调方法中调用 path 的 evaluate 方法，该方法会对 path 对象进行执行，计算所得到的结果，内部实现返回 confident 和 value 字段表示置信度，如果认定结果可信，confident 就是 true</p>
<p>我们可以调用 types 的 replaceWith 方法把执行的结果 value 进行替换，否则不替换</p>
<h5 id="字符串还原"><a href="#字符串还原" class="headerlink" title="字符串还原"></a>字符串还原</h5><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> strings = [<span class="string">&quot;\x68\x65\x6c\x6c\x6f&quot;</span>,<span class="string">&quot;\x77\x6f\x72\x6c\x64&quot;</span>]</span><br></pre></td></tr></table></figure>

<p><img src="/Users/caodaxun/hexo/source/_posts/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-11JavaScript%E9%80%86%E5%90%912/2.png" alt="2"></p>
<p><a href="https://astexplorer.net/">https://astexplorer.net</a> 转换成 AST，看到两个字符串都被识别为 Literal 类型，都有一个 extra 属性，extra 属性里面有一个 raw 和 rawValue，rawValue 里面值已经被解析出来了</p>
<p>所以只需要将 StringLiteral 中的 raw 替换为 rawValue 即可</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">&quot;@babel/parser&quot;</span></span><br><span class="line"><span class="keyword">import</span> generate <span class="keyword">from</span> <span class="string">&quot;@babel/generator&quot;</span></span><br><span class="line"><span class="keyword">import</span> traverse <span class="keyword">from</span> <span class="string">&quot;@babel/traverse&quot;</span></span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&quot;fs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = fs.readFileSync(<span class="string">&#x27;code/code1.js&#x27;</span>,<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> ast = parse(code)</span><br><span class="line">traverse(ast,&#123;</span><br><span class="line">	<span class="function"><span class="title">StringLiteral</span>(<span class="params">&#123;node&#125;</span>)</span>&#123;</span><br><span class="line">		<span class="function"><span class="title">if</span>(<span class="params">node.extra &amp;&amp; <span class="regexp">/\\[ux]/gi</span>.test(node.extra.raw)</span>)</span>&#123; <span class="comment">//??</span></span><br><span class="line">			node.extra.raw = node.extra.rawValue</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="attr">code</span>: output &#125; = generate(ast)</span><br><span class="line"><span class="built_in">console</span>.log(output)</span><br></pre></td></tr></table></figure>

<h5 id="无用代码删除"><a href="#无用代码删除" class="headerlink" title="无用代码删除"></a>无用代码删除</h5><p>不会被执行的代码其实就是冗余的，加大分析难度</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> _0x16c18d = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!![[]]) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;this&quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;is&quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;dead&quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;code&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> _0x1f7292 = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="string">&quot;xmv2nOdfy2N&quot;</span>.charAt(<span class="number">4</span>) !== <span class="built_in">String</span>.fromCharCode(<span class="number">110</span>)) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;this&quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;is&quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;dead&quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;code&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;nice to meet you&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">_0x16c18d();</span><br><span class="line">_0x1f7292();</span><br></pre></td></tr></table></figure>

<p>代码粘贴到 <a href="https://astexplorer.net/">https://astexplorer.net</a> 分析</p>
<p><img src="/Users/caodaxun/hexo/source/_posts/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-11JavaScript%E9%80%86%E5%90%912/3.png" alt="3"></p>
<p>选中第一个 if 语句，看到对应的就是一个 IfStatement 节点，有 type、start、end、loc、test、consequent、alternate 这几个属性。</p>
<p>test 就是 if 判定语句 就是 !![[]] ；consequent 就是 if 对应的代码区块，alternate 就是 else 对应代码区块</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; parse &#125; <span class="keyword">from</span> <span class="string">&quot;@babel/parser&quot;</span></span><br><span class="line"><span class="keyword">import</span> generate <span class="keyword">from</span> <span class="string">&quot;@babel/generator&quot;</span></span><br><span class="line"><span class="keyword">import</span> traverse <span class="keyword">from</span> <span class="string">&quot;@babel/traverse&quot;</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> types <span class="keyword">from</span> <span class="string">&quot;@babel/types&quot;</span></span><br><span class="line"><span class="keyword">import</span> fs <span class="keyword">from</span> <span class="string">&quot;fs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> code = fs.readFileSync(<span class="string">&#x27;code/code1.js&#x27;</span>,<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> ast = parse(code)</span><br><span class="line">traverse(ast,&#123;</span><br><span class="line">	<span class="function"><span class="title">IfStatement</span>(<span class="params">path</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">let</span> &#123;consequent, alternate&#125; = path.node</span><br><span class="line">		<span class="keyword">let</span> testPath = path.get(<span class="string">&#x27;test&#x27;</span>)</span><br><span class="line">		<span class="keyword">const</span> evaluateTest = testPath.evaluateTruthy()</span><br><span class="line">		<span class="keyword">if</span> (evaluateTest == <span class="literal">true</span>)&#123;</span><br><span class="line">			<span class="keyword">if</span> (types.isBlockStatement(consequent))&#123;</span><br><span class="line">				consequent = consequent.body</span><br><span class="line">			&#125;</span><br><span class="line">			path.replaceWithMultiple(consequent)</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (evaluateTest == <span class="literal">false</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> (alternate != <span class="literal">null</span>)&#123;</span><br><span class="line">				<span class="keyword">if</span> (types.isBlockStatement(alternate))&#123;</span><br><span class="line">					alternate = alternate.body</span><br><span class="line">				&#125;</span><br><span class="line">				path.replaceWithMultiple(alternate)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        path.remove();</span><br><span class="line">      &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="attr">code</span>: output &#125; = generate(ast)</span><br><span class="line"><span class="built_in">console</span>.log(output)</span><br></pre></td></tr></table></figure>

<p>定义 IfStatement 处理方法，首先获取 path 对应节点 consequent 和 alternate 属性</p>
<p>然后拿到 test 属性对应 path 赋值为 testPath，调用 testPath 的 evaluateTruthy 方法，返回对应 path 的真值。如果为 true 的话，直接将整个 path 替换成 consequent 对应节点</p>
<h5 id="反控制流平坦化"><a href="#反控制流平坦化" class="headerlink" title="反控制流平坦化"></a>反控制流平坦化</h5><p>把原本正常执行的逻辑顺序进行了混淆，通过一些 if else 或者 switch 语句进行拆分，导致不能直观的看到各个区块执行的顺序</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> s = <span class="string">&quot;3|1|2&quot;</span>.split(<span class="string">&quot;|&quot;</span>);</span><br><span class="line"><span class="keyword">let</span> x = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="keyword">switch</span> (s[x++]) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;1&quot;</span>:</span><br><span class="line">      <span class="keyword">const</span> a = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;2&quot;</span>:</span><br><span class="line">      <span class="keyword">const</span> b = <span class="number">3</span>;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;3&quot;</span>:</span><br><span class="line">      <span class="keyword">const</span> c = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>AST 分析</p>
<p><img src="/Users/caodaxun/hexo/source/_posts/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-11JavaScript%E9%80%86%E5%90%912/4.png" alt="4"></p>
<p>查看Switch的结构，是一个 SwitchStatement 节点，带有 discriminant 和 cases 两个属性。</p>
<p>discriminant 是判定条件，就是 s[x++]；cases 就是 3 哥 case 语句，对应 3 个 SwitchCase 节点 。。。</p>
<h4 id="特殊混淆案例还原"><a href="#特殊混淆案例还原" class="headerlink" title="特殊混淆案例还原"></a>特殊混淆案例还原</h4><h5 id="AAEncode的还原"><a href="#AAEncode的还原" class="headerlink" title="AAEncode的还原"></a>AAEncode的还原</h5><p>AAEncode 是一种 JavaScript 代码混淆算法，利用它，可以将 JavaScript 代码转换成颜文字表示的 JavaScript</p>
<h5 id="JJEncode的还原"><a href="#JJEncode的还原" class="headerlink" title="JJEncode的还原"></a>JJEncode的还原</h5><p>JJEncode 原理和 AAEncode 大同小异，将 JavaScript 代码转换成颜文字表示的 JavaScript</p>
<h4 id="WebAssembly"><a href="#WebAssembly" class="headerlink" title="WebAssembly"></a>WebAssembly</h4><p>借助 Emscripten 编译工具，能将 C/C++ 文件转成 wasm 格式的文件，JavaScript 可以直接调用该文件执行其中的方法</p>
<p>一些网站会加载一些 wasm 后缀的文件，即原生代码被编译成了 wasm 后缀的文件，JavaScript 通过调用 wasm 文件得到对应的计算结果，然后配合其他 JavaScript 代码实现页面数据的加载和页面渲染</p>
<p>案例：<a href="https://spa14.scrape.center/">https://spa14.scrape.center</a></p>
<p>加载首页，通过 Network面板分析 Ajax 请求，找到第一页的 Ajax 请求。参数 limit、offset 参数控制分页，sign 参数用来做校验。接下来分析 sign 的生成逻辑</p>
<p>设置一个 Ajax 断点，Source 面板 XHR/fetch Breakpoints 添加一个断点，内容为 /api/movie，刷新会进入断点，再通过 Call Stack 调用栈判断逻辑的入口在 onFetchData 方法里面</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">onFetchData: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> t = <span class="built_in">this</span>;</span><br><span class="line">  <span class="built_in">this</span>.loading = !<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> n = (<span class="built_in">this</span>.page - <span class="number">1</span>) * <span class="built_in">this</span>.limit</span><br><span class="line">    , e = <span class="built_in">this</span>.$wasm.asm.encrypt(n, <span class="built_in">parseInt</span>(<span class="built_in">Math</span>.round((<span class="keyword">new</span> <span class="built_in">Date</span>).getTime() / <span class="number">1e3</span>).toString()));</span><br><span class="line">  <span class="built_in">this</span>.$axios.get(<span class="built_in">this</span>.$store.state.url.index, &#123;</span><br><span class="line">      params: &#123;</span><br><span class="line">          limit: <span class="built_in">this</span>.limit,</span><br><span class="line">          offset: n,</span><br><span class="line">          sign: e</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>sign 值即 e，通过调用 this.$wasm.asm 对象的 encrypt 方法传入 n 和一个时间戳构造出来。</p>
<p>在这个位置断点，重新刷新，查看 this.$wasm.asm 对象，其中它的 [FunctionLocation] 指向了一个位置，Wasm.wasm，跳转进入看到都是一些其他语言写的代码</p>
<h6 id="模拟执行"><a href="#模拟执行" class="headerlink" title="模拟执行"></a>模拟执行</h6><p>Source 面板 js 目录下下载 wasm 文件 Wasm.wasm</p>
<p>下载地址 <a href="https://spa7.scrape.center/js/Wasm.wasm">https://spa7.scrape.center/js/Wasm.wasm</a></p>
<p>使用 Python 模拟执行 wasm</p>
<h6 id="pywasm"><a href="#pywasm" class="headerlink" title="pywasm"></a>pywasm</h6><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install pywasm</span><br></pre></td></tr></table></figure>

<p>加载Wasm</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pywasm</span><br><span class="line">runtime = pywasm.load(<span class="string">&#x27;./Wasm.wasm&#x27;</span>)</span><br><span class="line">print(runtime)</span><br><span class="line">//&lt;pywasm.Runtime <span class="built_in">object</span> at <span class="number">0x7ff12b199250</span>&gt;</span><br></pre></td></tr></table></figure>

<p>返回结果是一个 pywasm.Runtime 类型的对象</p>
<p>有了这个 Runtime 对象之后，就可以调用它的 exec 方法来模拟执行 Wasm 里面的方法，传入对应的方法名和参数即可。第二个参数是一个列表，代表 encrypt 方法所接收的参数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result = runtime.exec(<span class="string">&#x27;encrypt&#x27;</span>, [<span class="number">1</span>,<span class="number">2</span>])</span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>

<h6 id="wasmer-python"><a href="#wasmer-python" class="headerlink" title="wasmer-python"></a>wasmer-python</h6><p>还可用 wasmer-python 完成同样的操作，功能更强大，提供了更为底层的 API，遇到更复杂的 wasm 可以用这个</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install wasmer</span><br><span class="line">pip3 install wasmer wasmer_compiler_cranelift</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> wasmer <span class="keyword">import</span> engine, Store, Module, Instance</span><br><span class="line"><span class="keyword">from</span> wasmer_compiler_cranelift <span class="keyword">import</span> Compiler</span><br><span class="line"></span><br><span class="line">store = Store(engine.JIT(Compiler))</span><br><span class="line">module = Module(store, <span class="built_in">open</span>(<span class="string">&#x27;Wasm.wasm&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>).read())</span><br><span class="line">instance = Instance(module)</span><br><span class="line">result = instance.exports.encrypt(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>

<p>要读取 wasm 文件，需要先声明一个 Store 对象，然后将 wasm 对象转化为 Module 对象，再将其转化为 Instance 对象</p>
<p>API 用法参考 <a href="https://wasmerio.github.io/wasmer-python/api/wasmer.html">https://wasmerio.github.io/wasmer-python/api/wasmer.html</a></p>
]]></content>
  </entry>
  <entry>
    <title>Python3网络爬虫开发实战-1环境配置</title>
    <url>/2022/04/11/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-1%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<p><a href="https://setup.scrape.center/">https://setup.scrape.center</a></p>
<h4 id="Python-IDE"><a href="#Python-IDE" class="headerlink" title="Python IDE"></a>Python IDE</h4><h5 id="PyCharm"><a href="#PyCharm" class="headerlink" title="PyCharm"></a>PyCharm</h5><p>配置</p>
<p>终端 which python3 查看 python3 路径</p>
<p>Preference-Project:pythonProject-PythonInterpreter</p>
<p>Show All 添加 上面 python 路径</p>
<h4 id="Python-版本"><a href="#Python-版本" class="headerlink" title="Python 版本"></a>Python 版本</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python 3.7.9</span><br></pre></td></tr></table></figure>





<h4 id="1-开发环境配置"><a href="#1-开发环境配置" class="headerlink" title="1.开发环境配置"></a>1.开发环境配置</h4><h5 id="1-1-Python3的安装"><a href="#1-1-Python3的安装" class="headerlink" title="1.1 Python3的安装"></a>1.1 Python3的安装</h5><ol>
<li>Homebrew 安装</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">brew install python3</span><br></pre></td></tr></table></figure>

<p>命令执行完后，Python3 和 pip3 均已成功安装</p>
<ol start="2">
<li>安装包安装</li>
</ol>
<p><a href="https://www.python.org/downloads/">官网 </a>下载安装包安装</p>
<ol start="3">
<li>Anaconda 安装</li>
</ol>
<p><a href="https://mirrors.tuna.tsinghua.edu.cn/anaconda/archive/">镜像地址</a></p>
<ul>
<li>测试验证</li>
</ul>
<p>终端输入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Python3</span><br><span class="line">pip3 -V</span><br></pre></td></tr></table></figure>



<h5 id="1-2请求库安装"><a href="#1-2请求库安装" class="headerlink" title="1.2请求库安装"></a>1.2请求库安装</h5><h6 id="1-2-1-requests"><a href="#1-2-1-requests" class="headerlink" title="1.2.1 requests"></a>1.2.1 requests</h6><p>阻塞式 HTTP 请求，发出请求后，会一直等待服务器响应，响应后才会进行下一步处理</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install requests</span><br></pre></td></tr></table></figure>

<p>验证安装</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ python3</span><br><span class="line">&gt;&gt;&gt; import requests</span><br></pre></td></tr></table></figure>

<h6 id="1-2-2-Selenium"><a href="#1-2-2-Selenium" class="headerlink" title="1.2.2 Selenium"></a>1.2.2 Selenium</h6><p>自动化测试工具，可以驱动浏览器执行特定的动作，如点击、下拉</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install selenium</span><br></pre></td></tr></table></figure>

<p>验证安装</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ python3</span><br><span class="line">&gt;&gt;&gt; import selenium</span><br></pre></td></tr></table></figure>

<h6 id="1-2-3-ChromeDriver"><a href="#1-2-3-ChromeDriver" class="headerlink" title="1.2.3 ChromeDriver"></a>1.2.3 ChromeDriver</h6><p>Selenium 是一个自动化测试工具，需要配合浏览器使用</p>
<p>安装 ChromeDriver 才能驱动 Chrome 浏览器完成相应操作</p>
<p>查看 Chrome 版本号：帮助-关于 Google Chrome 版本 100.0.4896.75（正式版本） (x86_64)</p>
<p>ChromeDriver <a href="http://npm.taobao.org/mirrors/chromedriver/">下载地址</a> 选择 100.0.4896.60/chromedriver_mac64.zip  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo mv chromedriver &#x2F;usr&#x2F;local&#x2F;bin</span><br></pre></td></tr></table></figure>

<p>验证安装： 终端输入 chromedriver 开启</p>
<p>再程序中测试</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ python3</span><br><span class="line">&gt;&gt;&gt; from selenium import webdriver</span><br><span class="line">&gt;&gt;&gt; browser &#x3D; webdriver.Chrome()</span><br></pre></td></tr></table></figure>

<p>运行后，弹出一个空白 Chrome 浏览器，证明配置没问题</p>
<h6 id="1-2-4-GeckoDriver"><a href="#1-2-4-GeckoDriver" class="headerlink" title="1.2.4 GeckoDriver"></a>1.2.4 GeckoDriver</h6><p> <a href="https://github.com/mozilla/geckodriver/releases">下载地址</a>  geckodriver-v0.30.0-macos.tar.gz</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo mv geckodriver &#x2F;usr&#x2F;local&#x2F;bin</span><br></pre></td></tr></table></figure>

<p>验证安装： 终端输入 geckodriver 开启</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ python3</span><br><span class="line">&gt;&gt;&gt; from selenium import webdriver</span><br><span class="line">&gt;&gt;&gt; browser &#x3D; webdriver.Firefox()</span><br></pre></td></tr></table></figure>

<h6 id="1-2-5-PhantomJS"><a href="#1-2-5-PhantomJS" class="headerlink" title="1.2.5 PhantomJS"></a>1.2.5 PhantomJS</h6><p><del>无界面的、可脚本编程的 WebKit 浏览器引擎</del></p>
<p><del>Selenium 支持 PhantomJS，这样运行的时候就不会再弹出一个浏览器了</del></p>
<p><a href="https://phantomjs.org/download.html">下载地址</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo mv phantomjs &#x2F;usr&#x2F;local&#x2F;bin</span><br></pre></td></tr></table></figure>

<p><del>验证安装： 终端输入 phantomjs</del></p>
<p><del>Selenium中使用，只需要将 Chrome 切换为 PhantomJS</del></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from selenium import webdriver </span><br><span class="line">browser &#x3D; webdriver.PhantomJS() </span><br><span class="line">browser.get(&#39;https:&#x2F;&#x2F;www.baidu.com’) </span><br><span class="line">print(browser.current_url)</span><br></pre></td></tr></table></figure>

<p>报错不支持了：<code>Selenium support for PhantomJS has been deprecated </code> </p>
<p>使用无界面版本 <code>use headless versions of Chrome or Firefox instead</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from selenium import webdriver</span><br><span class="line"># 创建chrome参数对象</span><br><span class="line">opt &#x3D; webdriver.ChromeOptions()</span><br><span class="line"># 把chrome设置成无界面模式，不论windows还是linux都可以，自动适配对应参数</span><br><span class="line">opt.set_headless()</span><br><span class="line"># 创建chrome无界面对象</span><br><span class="line">driver &#x3D; webdriver.Chrome(options&#x3D;opt)</span><br><span class="line"># 访问百度</span><br><span class="line">driver.get(&#39;https:&#x2F;&#x2F;baidu.com&#x2F;&#39;)</span><br><span class="line">#打印内容</span><br><span class="line">print(driver.page_source)</span><br></pre></td></tr></table></figure>

<h6 id="1-2-6-aiohttp"><a href="#1-2-6-aiohttp" class="headerlink" title="1.2.6 aiohttp"></a>1.2.6 aiohttp</h6><p>异步 Web 服务的库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install aiohttp</span><br></pre></td></tr></table></figure>

<p>字符编码检测库 cchardet , 加速 DNS 的解析库  aiodns</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install cchardet aiodns</span><br></pre></td></tr></table></figure>

<h5 id="1-3-解析库安装"><a href="#1-3-解析库安装" class="headerlink" title="1.3 解析库安装"></a>1.3 解析库安装</h5><h6 id="1-3-1-lxml"><a href="#1-3-1-lxml" class="headerlink" title="1.3.1 lxml"></a>1.3.1 lxml</h6><p>Python 的一个解析库，支持 HTML 和 XML 的解析，支持 XPath 解析方式</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install lxml</span><br></pre></td></tr></table></figure>

<h6 id="1-3-2-Beautiful-Soup"><a href="#1-3-2-Beautiful-Soup" class="headerlink" title="1.3.2 Beautiful Soup"></a>1.3.2 Beautiful Soup</h6><p>Python 的一个 HTML 或 XML 的解析库</p>
<p>Beautiful Soup 的 HTML 和 XML 解析器是依赖于 lxml 库的</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install beautifulsoup4</span><br></pre></td></tr></table></figure>

<p>验证安装：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ python3</span><br><span class="line">&gt;&gt;&gt; from bs4 import BeautifulSoup</span><br><span class="line">&gt;&gt;&gt; soup &#x3D; BeautifulSoup(&#39;&lt;p&gt;Hello&lt;&#x2F;p&gt;&#39;, &#39;lxml&#39;)</span><br><span class="line">&gt;&gt;&gt; print(soup.p.string)</span><br></pre></td></tr></table></figure>

<h6 id="1-3-3-pyquery"><a href="#1-3-3-pyquery" class="headerlink" title="1.3.3 pyquery"></a>1.3.3 pyquery</h6><p>网页解析工具，提供和 jQuery类型语法来解析 HTML 文档，支持 CSS 选择器</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install pyquery</span><br></pre></td></tr></table></figure>

<h5 id="1-3-4-parsel"><a href="#1-3-4-parsel" class="headerlink" title="1.3.4 parsel"></a>1.3.4 parsel</h5><p>支持使用 XPath 和 CSS 选择器对内容进行修改和提取，同时还融合了正则表达式的提取功能</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pip3 install parsel</span><br></pre></td></tr></table></figure>

<h5 id="1-3-5-tesserocr"><a href="#1-3-5-tesserocr" class="headerlink" title="1.3.5 tesserocr"></a>1.3.5 tesserocr</h5><p>OCR 识别</p>
<p>使用 Homebrew 安装 ImageMagick 和 tesseract 库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">brew install imagemagick</span><br><span class="line">brew install tesseract-lang</span><br><span class="line">pip3 install tesserocr pillow</span><br></pre></td></tr></table></figure>

<p><a href="http://my.cnki.net/elibregister/CheckCode.aspx">验证码测试连接</a></p>
<p>使用命令行测试</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tesseract image.png result -1 eng &amp;&amp; cat result.txt</span><br></pre></td></tr></table></figure>

<p>Python 代码测试</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ python3</span><br><span class="line">&gt;&gt;&gt; import tesserocr</span><br><span class="line">&gt;&gt;&gt; from PIL import Image</span><br><span class="line">&gt;&gt;&gt; image &#x3D; Image.open(&#39;&#x2F;Users&#x2F;midland_whk&#x2F;Downloads&#x2F;CheckCode.aspx.jpeg&#39;)</span><br><span class="line">&gt;&gt;&gt; print(tesserocr.image_to_text(image))</span><br><span class="line">或者</span><br><span class="line">&gt;&gt;&gt; print(tesserocr.file_to_text(&#39;image.png&#39;))</span><br></pre></td></tr></table></figure>

<p>利用 Image 读取图片，再调用 tesserocr 的 image_to_text 将识别结果输出</p>
<h5 id="1-4-数据库安装"><a href="#1-4-数据库安装" class="headerlink" title="1.4 数据库安装"></a>1.4 数据库安装</h5><h6 id="1-4-1-MySQL"><a href="#1-4-1-MySQL" class="headerlink" title="1.4.1 MySQL"></a>1.4.1 MySQL</h6><p>轻量级关系型数据库</p>
<p><a href="https://downloads.mysql.com/archives/community/">下载地址</a></p>
<p>MySQL安装后 <code>open ~/.bash_profile</code><br>添加 <code>PATH=$PATH:/usr/local/mysql/bin</code><br>生效 <code>source ~/.bash_profile</code><br>终端登录mysql <code>mysql -uroot -p</code></p>
<p>或者 Homebrew 方式安装 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">brew install mysql</span><br></pre></td></tr></table></figure>

<p>启动、停止、重启</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo mysql.server start </span><br><span class="line">sudo mysql.server stop </span><br><span class="line">sudo mysql.server restart</span><br><span class="line">sudo &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;support-files&#x2F;mysql.server stop</span><br><span class="line">sudo &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;support-files&#x2F;mysql.server restart</span><br></pre></td></tr></table></figure>

<p>打开系统偏好设置-MySQL</p>
<p>initialize Database 可以设置密码 8 位</p>
<ul>
<li>Navicat Premium </li>
</ul>
<p>数据库的可视化工具</p>
<ul>
<li>Navicat Premium 连接 MySQL 报错 2059</li>
</ul>
<p>原因：mysql8之前版本中加密规则为mysql_native_password，mysql8之后加密规则为caching_sha2_password，将mysql用户登录加密规则改为 mysql_native_password</p>
<p>解决：</p>
<p>1 登录数据库 mysql -uroot -p</p>
<p>2 输入数据库密码登录</p>
<p>3 输入 use mysql; 出现 Database changed</p>
<p>4 输入 select host,user,plugin from user; 目的为了查看user的root 对应host是什么</p>
<p>5 修改加密规则 ALTER USER ‘root’@’localhost’ IDENTIFIED WITH mysql_native_password BY ‘12345678’;</p>
<p>6 查看修改结果 select host,user,plugin from user;</p>
<h6 id="1-4-2-MongoDB"><a href="#1-4-2-MongoDB" class="headerlink" title="1.4.2 MongoDB"></a>1.4.2 MongoDB</h6><p>C++编写的非关系型数据库，内容存储形式类似 JSON 对象，字段值可以包含其它文档、数组及文档数组</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">brew install mongodb <span class="comment">#失效了</span></span><br></pre></td></tr></table></figure>

<p>直接下载社区版 <a href="https://www.mongodb.com/try/download">https://www.mongodb.com/try/download</a></p>
<p>下载完 mongodb-macos-x86_64-5.0.7 解压命名为 mongodb 放到 /usr/local/ 目录</p>
<p>再把 MongoDB 的二进制命令文件目录添加到PATH</p>
<p>export PATH=/usr/local/mongodb/bin:$PATH</p>
<p>创建数据库存放路径</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo mkdir -p &#x2F;usr&#x2F;local&#x2F;var&#x2F;mongodb</span><br></pre></td></tr></table></figure>

<p>日志文件路径</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo mkdir -p &#x2F;usr&#x2F;local&#x2F;var&#x2F;log&#x2F;mongodb</span><br></pre></td></tr></table></figure>

<p>确保当前用户对上面目录读写权限</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo chown 用户 &#x2F;usr&#x2F;local&#x2F;var&#x2F;mongodb</span><br><span class="line">sudo chown 用户 &#x2F;usr&#x2F;local&#x2F;var&#x2F;log&#x2F;mongodb</span><br></pre></td></tr></table></figure>

<p>后台启动mongodb</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#--dbpath 设置数据存放目录</span></span><br><span class="line"><span class="comment">#--logpath 设置日志存放目录</span></span><br><span class="line"><span class="comment">#--fork 在后台运行</span></span><br><span class="line">mongod --dbpath /usr/<span class="built_in">local</span>/var/mongodb --logpath /usr/<span class="built_in">local</span>/var/<span class="built_in">log</span>/mongodb/mongo.log --fork</span><br></pre></td></tr></table></figure>

<p>如果不想后台运行，而是在控制台上查看运行过程可以直接设置配置文件启动</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mongod --config &#x2F;usr&#x2F;local&#x2F;etc&#x2F;mongod.conf</span><br></pre></td></tr></table></figure>

<p>查看是否启动</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ps aux | grep -v grep | grep mongod</span><br></pre></td></tr></table></figure>

<p>启动后可以用mongodb命令打开一个终端</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd &#x2F;usr&#x2F;local&#x2F;mongodb&#x2F;bin </span><br><span class="line">.&#x2F;mongo</span><br></pre></td></tr></table></figure>





<p>启动、停止和重启 MongoDB</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">brew services start mongodb </span><br><span class="line">sudo mongod</span><br><span class="line">brew services stop mongodb </span><br><span class="line">brew services restart mongodb</span><br></pre></td></tr></table></figure>

<p>可视化工具 RoboMongo/Robo 2T <a href="https://robomongo.org/download">https://robomongo.org/download</a></p>
<p>Studio 3T <a href="https://studio3t.com/download">https://studio3t.com/download</a></p>
<h6 id="1-4-3-Redis"><a href="#1-4-3-Redis" class="headerlink" title="1.4.3 Redis"></a>1.4.3 Redis</h6><p>基于内存的高效的非关系型数据库</p>
<ul>
<li><p>Linux 下的安装</p>
</li>
<li><ul>
<li>Ubuntu、Debian、Deepin 系统下，使用 apt-get 命令安装 Redis</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo apt-get -y install redis-server</span><br></pre></td></tr></table></figure>

<p>然后 redis-cli 进入 Redis 命令行模式</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ redis-cli</span><br><span class="line">127.0.0.1:6379&gt; set &#39;name&#39; &#39;Germey&#39;</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get &#39;name&#39;</span><br><span class="line">&#39;Germey&#39;</span><br><span class="line">#如果设置了密码需要先 auth xxx密码</span><br></pre></td></tr></table></figure>

<p>配置远程连接，修改配置文件 /etc/redis/redis.conf</p>
<p>注释 <code>bind 127.0.0.1</code></p>
<p>推荐给 Redis 设置密码，取消注释 <code>requirepass foobared</code> foobared 就是当前密码，可修改</p>
<p>重启 Redis 服务，就可以使用密码远程连接 Redis 了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo &#x2F;etc&#x2F;init.d&#x2F;redis-server restart</span><br></pre></td></tr></table></figure>

<p>停止和启动 Redis 服务</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo &#x2F;etc&#x2F;init.d&#x2F;redis-server stop</span><br><span class="line">sudo &#x2F;etc&#x2F;init.d&#x2F;redis-server start</span><br></pre></td></tr></table></figure>

<ul>
<li><ul>
<li>CentOS 和 Red Hat 系统中，首先添加 EPEL 仓库，然后更新 yum 源</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo yum install epel-release</span><br><span class="line">sudo yum update</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>安装 Redis 数据库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo yum -y install redis</span><br><span class="line">#安装好后启动</span><br><span class="line">sudo systemctl start redis</span><br></pre></td></tr></table></figure>

<p>同样可以使用 redis-cli 进入 Redis 命令行模式</p>
<p>为了使 Redis 能被远程连接，修改配置文件 /etc/redis.conf</p>
<p>修改完之后保存重启</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo systemctl restart redis</span><br></pre></td></tr></table></figure>

<p>还需要关闭linux的防火墙开放6379端口，宝塔面板安全设置或者防火墙关闭命令</p>
<p>云主机安全主添加入方向6379端口</p>
<ul>
<li>Mac 安装</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">brew install redis</span><br></pre></td></tr></table></figure>

<blockquote>
<p>brew 会报错提示redis下载失败</p>
</blockquote>
<p>redis 官网下载 <a href="https://redis.io/download/">https://redis.io/download/</a> redis-6.2.6.tar.gz</p>
<p>解压重命名为 redis，放入到 /usr/local/ 目录</p>
<p>进入目录编译，成功会提示 It’s a good idea to run make test</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo make</span><br><span class="line">sudo make test</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<p>安装成功后使用命令 redis-server 启动服务</p>
<p>连接redis：新打开终端输入 redis-cli</p>
<p>启动 Redis 服务</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">brew services start redis</span><br><span class="line">redis-service &#x2F;usr&#x2F;local&#x2F;etc&#x2F;redis.conf</span><br></pre></td></tr></table></figure>

<p>Mac 下 Redis 配置文件路径 /usr/local/tec/redis.conf 可以通过修改它来配置访问密码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">brew services stop redis</span><br><span class="line">brew services restart redis</span><br></pre></td></tr></table></figure>

<p>可以安装 Redis Destop Manager 可视化管理工具来管理 Redis</p>
<h6 id="1-4-4-RabbitMQ"><a href="#1-4-4-RabbitMQ" class="headerlink" title="1.4.4 RabbitMQ"></a>1.4.4 RabbitMQ</h6><p>RabbitMQ 就是一个消息队列，我们要实现进程间通信</p>
<ul>
<li>Linux 上安装 </li>
</ul>
<p>Debian 和 Ubuntu <a href="https://rabbitmq.com/install-debian.html">https://rabbitmq.com/install-debian.html</a> 查看</p>
<p>RedHat Enterprise Linux, CentOS, Fedora, openSUSE <a href="https://rabbitmq.com/install-rpm.html">https://rabbitmq.com/install-rpm.html</a> 查看。</p>
<ul>
<li>Mac 上安装</li>
</ul>
<p><a href="https://rabbitmq.com/install-homebrew.html">https://rabbitmq.com/install-homebrew.html</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">brew install rabbitmq</span><br></pre></td></tr></table></figure>





<h5 id="1-5-Python-存储库安装"><a href="#1-5-Python-存储库安装" class="headerlink" title="1.5 Python 存储库安装"></a>1.5 Python 存储库安装</h5><p>安装了存储数据的数据库，如果想要和 Python 交互的话，还需要安装一些 Python 存储库</p>
<p>MySQL 需要安装 PyMySQL</p>
<p>MongoDB 需要安装 PyMongo</p>
<h6 id="1-5-1-PyMySQL"><a href="#1-5-1-PyMySQL" class="headerlink" title="1.5.1 PyMySQL"></a>1.5.1 PyMySQL</h6><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install pymysql</span><br></pre></td></tr></table></figure>

<p>验证</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; import pymysql</span><br><span class="line">&gt;&gt;&gt; pymysql.VERSION</span><br><span class="line">(1, 0, 2, None)</span><br></pre></td></tr></table></figure>

<h6 id="1-5-2-PyMongo"><a href="#1-5-2-PyMongo" class="headerlink" title="1.5.2 PyMongo"></a>1.5.2 PyMongo</h6><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install pymongo</span><br></pre></td></tr></table></figure>

<p>验证</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; import pymongo </span><br><span class="line">&gt;&gt;&gt; pymongo.version</span><br></pre></td></tr></table></figure>

<h6 id="1-5-3-redis-py"><a href="#1-5-3-redis-py" class="headerlink" title="1.5.3 redis-py"></a>1.5.3 redis-py</h6><p>Redis 使用 redis-py 库来与其交互</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install redis</span><br><span class="line">#运行完毕后即可完成 redis-py 的安装</span><br></pre></td></tr></table></figure>

<h6 id="1-5-4-RedisDump"><a href="#1-5-4-RedisDump" class="headerlink" title="1.5.4 RedisDump"></a>1.5.4 RedisDump</h6><p>RedisDump 一个用于 Redis 数据导入/导出的工具，基于 Ruby 实现</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">gem install redis-dump</span><br></pre></td></tr></table></figure>

<p>验证：安装成功后执行下面命令，成功调用则安装成功</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">redis dump </span><br><span class="line">redis-load</span><br></pre></td></tr></table></figure>

<h5 id="1-6-Web-库安装"><a href="#1-6-Web-库安装" class="headerlink" title="1.6 Web 库安装"></a>1.6 Web 库安装</h5><h6 id="1-6-1-Flask"><a href="#1-6-1-Flask" class="headerlink" title="1.6.1 Flask"></a>1.6.1 Flask</h6><p>轻量级的 Web 服务程序，主要用来做一些 API 服务</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install flask</span><br></pre></td></tr></table></figure>

<p>验证</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line">app &#x3D; Flask(__name__)</span><br><span class="line">@app.route(&quot;&#x2F;&quot;)</span><br><span class="line">def hello():</span><br><span class="line">    return &quot;hello world&quot;</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

<p>运行后，系统会在 5000 端口开启 Web 服务</p>
<p>直接访问 <a href="http://127.0.0.1:5000/">http://127.0.0.1:5000/</a> 可以看到网页中显示 Hello World，一个最简单的 Flask 程序就运行成功了</p>
<h6 id="1-6-2-Tornado"><a href="#1-6-2-Tornado" class="headerlink" title="1.6.2 Tornado"></a>1.6.2 Tornado</h6><p>支持异步的 Web 框架，通过使用非阻塞 I/O 流，可以支撑成千上万的开放连接</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install tornado</span><br></pre></td></tr></table></figure>

<p>验证 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">import tornado.ioloop</span><br><span class="line">import tornado.web</span><br><span class="line"></span><br><span class="line">class MainHandler(tornado.web.RequestHandler):</span><br><span class="line">    def get(self):</span><br><span class="line">        self.write(&quot;hello world&quot;)</span><br><span class="line">def make_app():</span><br><span class="line">    return  tornado.web.Application([</span><br><span class="line">        (r&quot;&#x2F;&quot;, MainHandler)</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    app &#x3D; make_app()</span><br><span class="line">    app.listen(8888)</span><br><span class="line">    tornado.ioloop.IOLoop.current().start()</span><br></pre></td></tr></table></figure>

<p>运行后，系统在 8888 端口运行了 Web 服务， 访问 <a href="http://127.0.0.8888/">http://127.0.0.8888/</a> 网页呈现 helloworld</p>
<h5 id="1-7-APP-爬取相关库安装"><a href="#1-7-APP-爬取相关库安装" class="headerlink" title="1.7 APP 爬取相关库安装"></a>1.7 APP 爬取相关库安装</h5><h6 id="1-7-1-Charles"><a href="#1-7-1-Charles" class="headerlink" title="1.7.1 Charles"></a>1.7.1 Charles</h6><h6 id="1-7-2-mitmproxy"><a href="#1-7-2-mitmproxy" class="headerlink" title="1.7.2 mitmproxy"></a>1.7.2 mitmproxy</h6><p>支持 HTTP 和 HTTPS 的抓包程序，通过控制台的形式操作</p>
<p>有两个关联组件</p>
<p>mitmdump：是 mitmproxy 命令行接口，利用它对接 Python 脚本，实现监听后的处理</p>
<p>mitmweb：一个 Web 程序，通过它以清楚观察到 mitmproxy 捕获请求</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install mitmproxy</span><br></pre></td></tr></table></figure>

<p>完成安装，还附带安装了 mitmdump mitmweb 两个组件</p>
<p>要捕获 https 请求需要证书配置</p>
<p>mitmproxy 安装后会提供一套 CA 证书，运行 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mitmdump</span><br></pre></td></tr></table></figure>

<p>在用户目录 .mitmproxy 目录里面找到 CA 证书</p>
<p>配置：</p>
<p>双击 mitmproxy-ca-cert.pem 弹出钥匙串管理，找到 mitmproxy 证书，打开设置，选始终信任</p>
<p>将 mitmproxy-ca-cert.pem 隔空投送到手机设备，安装</p>
<h6 id="Linux下安装-mitmproxy"><a href="#Linux下安装-mitmproxy" class="headerlink" title="Linux下安装 mitmproxy"></a>Linux下安装 mitmproxy</h6><p>操作系统 CentOS 8.5</p>
<p>可以下载编译好的二进制包 <a href="https://github.com/mitmproxy/mitmproxy/releases">https://github.com/mitmproxy/mitmproxy/releases</a></p>
<p>看到 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">You can find the latest release packages at https:&#x2F;&#x2F;mitmproxy.org&#x2F;downloads&#x2F;.</span><br></pre></td></tr></table></figure>

<p>进入下载最新linux包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;snapshots.mitmproxy.org&#x2F;8.0.0&#x2F;mitmproxy-8.0.0-linux.tar.gz</span><br><span class="line">tar -zxvf mitmproxy-8.0.0-linux.tar.gz</span><br><span class="line">sudo mv mitmproxy mitmdump mitmweb &#x2F;usr&#x2F;bin</span><br></pre></td></tr></table></figure>

<p>配置证书</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">su root #切换到root用户</span><br><span class="line">cd &#x2F;root</span><br><span class="line">mitmdump #运行命令产生CA证书</span><br></pre></td></tr></table></figure>

<p>默认8080端口，如果占用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">lsof -i:8080</span><br><span class="line">kill -9 进程id</span><br></pre></td></tr></table></figure>

<p>或者修改指定端口号</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mitmdump -p 3328</span><br></pre></td></tr></table></figure>



<h6 id="CentOS证书配置"><a href="#CentOS证书配置" class="headerlink" title="CentOS证书配置"></a>CentOS证书配置</h6><p><a href="https://zhuanlan.zhihu.com/p/43581988">https://zhuanlan.zhihu.com/p/43581988</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#查看mitmproxy版本和系统信息</span><br><span class="line">$ mitmproxy --version</span><br><span class="line">#安装 ca-certificates</span><br><span class="line">$ yum install ca-certificates</span><br><span class="line">#转换证书，pem → crt linux上.pem文件先转化为.crt文件</span><br><span class="line">$ cd ~&#x2F;.mitmproxy&#x2F;</span><br><span class="line">$ openssl x509 -in mitmproxy-ca-cert.pem -inform PEM -out mitmproxy-ca-cert.crt</span><br><span class="line">$ ll</span><br><span class="line">total 28</span><br><span class="line">#打开根证书动态配置开关</span><br><span class="line">update-ca-trust force-enable</span><br><span class="line">#将证书复制到</span><br><span class="line">cp mitmproxy-ca-cert.crt &#x2F;etc&#x2F;pki&#x2F;ca-trust&#x2F;source&#x2F;anchors&#x2F;</span><br><span class="line">#安装根证书</span><br><span class="line">update-ca-trust extract</span><br><span class="line">外部证书存放目录</span><br><span class="line">$ ll &#x2F;etc&#x2F;pki&#x2F;ca-trust&#x2F;source&#x2F;anchors&#x2F;</span><br><span class="line">total 4</span><br><span class="line"></span><br></pre></td></tr></table></figure>

















<h6 id="1-7-3-Appium-安装"><a href="#1-7-3-Appium-安装" class="headerlink" title="1.7.3 Appium 安装"></a>1.7.3 Appium 安装</h6><p>移动端的自动化测试工具</p>
<p><a href="http://appium.io/">下载链接</a> 直接安装</p>
<p>或者</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">npm install -g appium</span><br></pre></td></tr></table></figure>

<p>利用 WebDriver 来实现 APP 的自动化测试</p>
<p>Appium 相当于一个服务器，可以向 Appium 发送一些操作指令，Appium 就会跟进不同指令对设备进行驱动</p>
<p>点击 Start Server 按钮即可启动 Appium 的服务，相当于开启了一个 Appium 服务器。</p>
<p>可以通过 Appium 内置驱动或 Python 代码向 Appium 的服务器发送一系列操作指令</p>
<p>默认 Appium 运行后正在监听 4723 端口</p>
<p>安装1.22.3 报错了</p>
<p>下载 appium-desktop-1.22.3.dmg 双击将.app拖入应用程序执行下面命令就可以了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">xattr -cr &quot;&#x2F;Applications&#x2F;Appium Server GUI.app&quot;</span><br><span class="line">codesign --deep --sign - &#x2F;Applications&#x2F;Appium\ Server\ GUI.app</span><br></pre></td></tr></table></figure>

<p>Pycharm 安装 appium-pyhton-client 包</p>
<h6 id="appium-inspector"><a href="#appium-inspector" class="headerlink" title="appium-inspector"></a>appium-inspector</h6><p>从Appium分离出来的</p>
<p><a href="https://github.com/appium/appium-inspector/releases/tag/v2022.2.1">https://github.com/appium/appium-inspector/releases/tag/v2022.2.1</a></p>
<h6 id="WebDriverAgent"><a href="#WebDriverAgent" class="headerlink" title="WebDriverAgent"></a>WebDriverAgent</h6><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;appium&#x2F;WebDriverAgent</span><br><span class="line">brew install Carthage</span><br><span class="line">.&#x2F;scripts&#x2F;bootstrap.sh</span><br></pre></td></tr></table></figure>

<h6 id="libimobiledevice"><a href="#libimobiledevice" class="headerlink" title="libimobiledevice"></a>libimobiledevice</h6><p>使用原生协议与评估 iOS 设备进行通信的库，通过这个库 MacOS 能够获取到 iOS 设备信息</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">brew install --HEAD libimobiledevice</span><br></pre></td></tr></table></figure>









<h5 id="1-8-爬虫框架安装"><a href="#1-8-爬虫框架安装" class="headerlink" title="1.8 爬虫框架安装"></a>1.8 爬虫框架安装</h5><h6 id="1-8-1-pyspider"><a href="#1-8-1-pyspider" class="headerlink" title="1.8.1 pyspider"></a>1.8.1 pyspider</h6><p>pyspider 是支持 JavaScript 渲染的，而这过程依赖 PhantomJS，所以还需要安装 PhantomJS</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install pyspider</span><br></pre></td></tr></table></figure>

<p>验证：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pyspider all</span><br></pre></td></tr></table></figure>

<p>这时 pyspider 的 Web 服务器会在本地 5000 端口运行，直接打开浏览器 <a href="http://localhost:5000/">http://localhost:5000/</a> 即可进入 pyspider 的 WebUI 管理页面</p>
<p>报错 ：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">File &quot;&#x2F;Library&#x2F;Frameworks&#x2F;Python.framework&#x2F;Versions&#x2F;3.8&#x2F;lib&#x2F;python3.8&#x2F;site-packages&#x2F;pyspider&#x2F;run.py&quot;, line 231</span><br><span class="line">    async&#x3D;True, get_object&#x3D;False, no_input&#x3D;False):</span><br></pre></td></tr></table></figure>

<p>修改文件 <code>/Library/Frameworks/Python.framework/Versions/3.8/lib/python3.8/site-packages/pyspider/run.py</code> </p>
<p><code>pyspider/fetcher/tornado_fetcher.py</code></p>
<p><code>pyspider/webui/app.py</code></p>
<p>async 改成 async_mode</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 uninstall wsgidav</span><br><span class="line">pip3 install wsgidav&#x3D;&#x3D;2.4.1</span><br></pre></td></tr></table></figure>

<p>报错： <code>ImportError: cannot import name DispatcherMiddleware</code></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 uninstall werkzeug</span><br><span class="line">pip3 install werkzeug&#x3D;&#x3D;0.16.0</span><br></pre></td></tr></table></figure>

<ul>
<li>报错端口号被占用</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Error: Could not create web server listening on port 25555</span><br><span class="line">...</span><br><span class="line">File &quot;/Library/Frameworks/Python.framework/Versions/3.7/lib/python3.7/site-packages/tornado/netutil.py&quot;, line 198, in bind_sockets</span><br><span class="line">    sock.bind(sockaddr)</span><br><span class="line">OSError: [Errno 48] Address already in use</span><br></pre></td></tr></table></figure>

<p>根据报错提示，找到 tornado/netutil.py sock.bind(sockaddr) 方法，上面添加一个打印方法</p>
<p>print(‘====’, sockaddr)</p>
<p>重新执行 pyspider all</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">==== (&#x27;127.0.0.1&#x27;, 23333)</span><br><span class="line">==== (&#x27;0.0.0.0&#x27;, 5000)</span><br></pre></td></tr></table></figure>

<p>查看端口使用情况，kill 掉 PID</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">lsof -i:25555</span><br><span class="line">COMMAND     PID  USER   FD   TYPE             DEVICE SIZE/OFF NODE NAME</span><br><span class="line">phantomjs 51059  xxx    7u  IPv4 0x644470676405ed1d      0t0  TCP *:25555 (LISTEN)</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="built_in">kill</span> 掉PID 51059</span></span><br><span class="line">kill 51059</span><br><span class="line">COMMAND    PID   USER   FD   TYPE             DEVICE SIZE/OFF NODE NAME</span><br><span class="line">com.apple  910 	 xxx   22u  IPv4 0x13685d2d3155f357      0t0  TCP commplex-main </span><br></pre></td></tr></table></figure>

<p>5000端口kill掉再查看端口还是一直被 commplex-main  使用，这个需要关掉 共享-隔空投送接收器才行，再kill</p>
<p><code>pyspider all</code> 在python3.8 3.9 3.10 环境执行都报错提示，放弃了还是使用python3.7版本</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">_pickle.PicklingError: Can&#x27;t pickle &lt;function cli at 0x7fbbf73674c0&gt;: it&#x27;s not the same object as pyspider.run.cli</span><br></pre></td></tr></table></figure>



<h6 id="1-8-2-Scrapy"><a href="#1-8-2-Scrapy" class="headerlink" title="1.8.2 Scrapy"></a>1.8.2 Scrapy</h6><p>十分强大的爬虫框架</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install scrapy</span><br></pre></td></tr></table></figure>

<p>验证： 命令行输入 scrapy</p>
<h6 id="1-8-3-Scrapy-Splash"><a href="#1-8-3-Scrapy-Splash" class="headerlink" title="1.8.3 Scrapy-Splash"></a>1.8.3 Scrapy-Splash</h6><p>Scrapy-Splash 是一个 Scrapy 中支持 JavaScript 渲染的工具</p>
<p>安装分两部分：</p>
<ul>
<li>Splash 服务安装</li>
</ul>
<p>通过 Docker安装，安装后会启动一个 Splash 服务，可以通过它的接口来实现 JavaScript 页面的加载</p>
<p>安装 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker run -p 8050:8050 scrapinghub&#x2F;splash</span><br></pre></td></tr></table></figure>

<p>Scrapy-Splash 会使用 Splash 的 HTTP API 进行页面渲染，安装 Splash 来提供渲染服务</p>
<p>安装完成后 Splash 已经在 8050 上运行了， 打开 <a href="http://localhost:8050/">http://localhost:8050</a> 即可看到 Splash 的主页</p>
<p>也可以直接安装在远程服务器上，在服务器上以守护态运行 Splash 即可</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker run -d -p 8050:8050 scrapinghub&#x2F;splash</span><br></pre></td></tr></table></figure>

<p>-d 参数代表将 Docker 容器以守护态运行，这样终端远程服务器连接后，不会终止 Splash 服务的运行</p>
<ul>
<li>Scrapy-Splash 的 Python 库安装</li>
</ul>
<p>安装之后即可在 Scrapy 中使用 Splash 服务</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install scrapy-splash</span><br></pre></td></tr></table></figure>

<h6 id="1-8-4-Scrapy-Redis"><a href="#1-8-4-Scrapy-Redis" class="headerlink" title="1.8.4 Scrapy-Redis"></a>1.8.4 Scrapy-Redis</h6><p>Scrapy 的分布式扩展模块，有了它，可以方便实现 Scrapy 分布式爬虫的搭建</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install scrapy-redis</span><br></pre></td></tr></table></figure>



<h5 id="1-9-部署相关库安装"><a href="#1-9-部署相关库安装" class="headerlink" title="1.9 部署相关库安装"></a>1.9 部署相关库安装</h5><p>如果想要大规模抓取数据，就会用到分布式爬虫，</p>
<h6 id="1-9-1-Docker"><a href="#1-9-1-Docker" class="headerlink" title="1.9.1 Docker"></a>1.9.1 Docker</h6><p>Docker 是一种容器技术，可以将应用和环境等进行打包，形成一个独立的，类似 iOS APP 形式的应用</p>
<p>这个应用可以被分发到任意一个支持 Docker 的环境中，通过简单的命令即可运行</p>
<p>安装 Docker for Mac，如果系统不满足要求可以安装 Docker Toolbox</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">brew install --cask --appdir&#x3D;&#x2F;Applications docker</span><br></pre></td></tr></table></figure>

<p>运行 Docker 后，菜单栏出现一个小鲸鱼图标，展开菜单点击 Start 即可启动，随后就可以在命令行下使用 Docker 命令了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo docker run hello-world</span><br></pre></td></tr></table></figure>

<ul>
<li>镜像加速</li>
</ul>
<p>运行测试命令时，会发现它首先会下载一个 Hello World 的镜像，然后将其运行</p>
<p>下载镜像有时候会非常慢，因为默认是从国外 Docker Hub 下载的，为了提高下载速度，可以使用国内镜像来加速</p>
<p>推荐的 Docker 加速器有 <a href="https://daocloud.io/mirror">DaoCloud</a> 和 <a href="https://cr.console.aliyun.com/#/accelerator">阿里云</a> </p>
<h6 id="1-9-2-Scrapyd"><a href="#1-9-2-Scrapyd" class="headerlink" title="1.9.2 Scrapyd"></a>1.9.2 Scrapyd</h6><p>用于部署和运行 Scrapy 项目的工具，有了它，可以将写好的 Scrapy 项目上传到云主机并通过 API 来控制它</p>
<p>Scrapy 项目部署，基本上都使用 Linux 主机</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install scrapyd</span><br></pre></td></tr></table></figure>



<h6 id="1-9-3-Scrapyd-Client"><a href="#1-9-3-Scrapyd-Client" class="headerlink" title="1.9.3 Scrapyd-Client"></a>1.9.3 Scrapyd-Client</h6><p>将 Scrapy 代码部署到远程 Scrapyd 的时候，第一步就是要将代码打包为 EGG 文件，再将 EGG 文件上传到远程主机。</p>
<p>Scrapyd-Client 实现了这些功能</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install scrapyd-client</span><br></pre></td></tr></table></figure>

<p>安装成功后会有一个可用命令，scrapyd-deploy 即部署命令</p>
<h6 id="1-9-4-Scrapyd-API-安装"><a href="#1-9-4-Scrapyd-API-安装" class="headerlink" title="1.9.4 Scrapyd API 安装"></a>1.9.4 Scrapyd API 安装</h6><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip install python-scrapyd-api</span><br></pre></td></tr></table></figure>

<p>安装好了 Scrapyd 之后，我们可以直接请求它提供的 API 来获取当前主机的 Scrapy 任务运行状况</p>
<p>比如 主机 IP 192.168.1.1 ，可以运行如下命令获取当前主机所有 Scrapy 项目</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:6800&#x2F;listproject.json</span><br></pre></td></tr></table></figure>

<p>返回结果是字符串，通过解析字符串就可以得到当前主机的所有项目</p>
<p>不过这种方式来获取任务状态还是繁琐，所以 Scrapyd API 为它做了一层封装</p>
<ul>
<li>验证安装</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapyd_api <span class="keyword">import</span> ScrapydAPI</span><br><span class="line">scrapyd = ScrapydAPI(<span class="string">&#x27;http://localhost:6800&#x27;</span>)</span><br><span class="line">print(scrapyd.list_project())</span><br></pre></td></tr></table></figure>

<p>这样可以用Python 直接来获取各个主机上 Scrapy 任务的运行状态了</p>
<h6 id="1-9-5-Scrapyrt"><a href="#1-9-5-Scrapyrt" class="headerlink" title="1.9.5 Scrapyrt"></a>1.9.5 Scrapyrt</h6><p>Scrapyrt 为 Scrapy 提供了一个调度的 HTTP接口，有了它，就不需要执行 Scrapy 命令，而是通过请求一个 HTTP 接口来调度 Scrapy 任务了</p>
<p>Scrapyrt 比 Scrapyd 更轻量，如果不需要分布式多任务的话，可以简单使用 Scrapyrt 实现远程 Scrapy 任务的调度</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install scrapyrt</span><br></pre></td></tr></table></figure>

<p>在任意一个 Scrapy 项目中运行 <code>scrapyrt</code>  命令来启动 HTTP 服务</p>
<p>运行之后会默认会在 9080 端口上启动服务</p>
<p>更换端口</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">scrapyrt -p 9081</span><br></pre></td></tr></table></figure>

<h6 id="1-9-6-Gerapy"><a href="#1-9-6-Gerapy" class="headerlink" title="1.9.6 Gerapy"></a>1.9.6 Gerapy</h6><p>Scrapy 分布式管理模块</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install gerapy</span><br></pre></td></tr></table></figure>























]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Python3网络爬虫开发实战-12App爬取</title>
    <url>/2022/04/18/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-12App%E7%88%AC%E5%8F%96/</url>
    <content><![CDATA[<h4 id="11-2-mitmproxy-的使用"><a href="#11-2-mitmproxy-的使用" class="headerlink" title="11.2 mitmproxy 的使用"></a>11.2 mitmproxy 的使用</h4><p>官方文档 <a href="https://docs.mitmproxy.org/stable/">https://docs.mitmproxy.org/stable/</a></p>
<p>中文文档及配置 <a href="https://ptorch.com/news/269.html">https://ptorch.com/news/269.html</a></p>
<p>mitmproxy 是一个支持 HTTP 和 HTTPS 的抓包程序，是一个控制台形式的操作</p>
<p>有两个关联组件</p>
<p>mitmdump：是 mitmproxy 命令行接口，利用它对接 Python 脚本，实现监听后的处理</p>
<p>mitmweb：一个 Web 程序，通过它以清楚观察到 mitmproxy 捕获请求</p>
<p>mitmproxy 运行在 PC 上， mitmproxy 会在 PC 上的 8080 端口运行，然后开启一个代理服务，这个服务实际上是一个 HTTP/HTTPS 的代理</p>
<p>手机和PC在同一局域网内，设置代理为 mitmproxy 的代理地址，这样手机访问互联网时，流量包就会流经 mitmproxy，mitmproxy 再去转发这些数据包到真实的服务器，服务器返回数据包时再由 mitmproxy 转发回手机，这样 mitmproxy 就相当于起了中间人的作用。这个过程还可以对接 mitmdump，抓取到的 request  和 response 的内容都可以用 Python 处理</p>
<h5 id="设置代理"><a href="#设置代理" class="headerlink" title="设置代理"></a>设置代理</h5><p>启动 mitmproxy，之后会在 8080 端口上运行一个代理服务，右下角显示当前正在监听的端口</p>
<p>或者启动 mitmdump，也会监听 8080 端口</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mitmproxy</span><br></pre></td></tr></table></figure>

<img src="Python3网络爬虫开发实战-12App爬取/WeChatbc9c4fbc9a77005d02a7b76380f4d96d.png" alt="WeChatbc9c4fbc9a77005d02a7b76380f4d96d" style="zoom:100%;" />



<h5 id="mitmproxy-使用"><a href="#mitmproxy-使用" class="headerlink" title="mitmproxy 使用"></a>mitmproxy 使用</h5><p>手机设置代理 端口号设置 8080</p>
<p>设置好之后，手机浏览请求，mitmproxy 页面便会呈现手机上的请求</p>
<img src="Python3网络爬虫开发实战-App爬取/WeChat3176183fed7aabb817d5cca64b557fea.png" alt="WeChat3176183fed7aabb817d5cca64b557fea" style="zoom:80%;" />

<p>键盘上下移动光标选择请求，敲击回车可以查看详情</p>
<img src="Python3网络爬虫开发实战-12App爬取/WeChatbdf3664c9d6af574beb50d4ba5ecbda0.png" alt="WeChatbdf3664c9d6af574beb50d4ba5ecbda0" style="zoom:80%;" />

<p>可以看到 3 个分栏，Request、Response、Detail，通过鼠标点击分栏或者 Tab 切换</p>
<h6 id="命令行编辑功能"><a href="#命令行编辑功能" class="headerlink" title="命令行编辑功能"></a>命令行编辑功能</h6><p>点击 e 进入编辑功能，跳出一个列表可以选择需要编辑选项</p>
<p>esc 关闭列表选项</p>
<p>如进入编辑请求参数界面，光标移动到需要修改地方，回车可编辑</p>
<p>敲击 a 可以增加一行，输入 Key、Value</p>
<p>再敲击 esc，q 键，返回之前的界面，可以看到请求的参数已修改</p>
<img src="Python3网络爬虫开发实战-12App爬取/WeChat4316a20d612a7c046a3338faa2f20b37.png" alt="WeChat4316a20d612a7c046a3338faa2f20b37" style="zoom:80%;" />

<p>敲击 r 发起修改后的请求</p>
<h5 id="mitmweb"><a href="#mitmweb" class="headerlink" title="mitmweb"></a>mitmweb</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mitmweb</span><br><span class="line">#提示</span><br><span class="line">Web server listening at http:&#x2F;&#x2F;127.0.0.1:8081&#x2F;</span><br><span class="line">Proxy server listening at http:&#x2F;&#x2F;*:8080</span><br></pre></td></tr></table></figure>

<p>打开链接 <a href="http://127.0.0.1:8081/">http://127.0.0.1:8081/</a> 可以看到请求</p>
<h5 id="mitmdump"><a href="#mitmdump" class="headerlink" title="mitmdump"></a>mitmdump</h5><p>mitmdump 是 mitmproxy 的命令行接口，同时可以对接 Python 对请求进行处理</p>
<p>可以命令行启动 mitmproxy，并把截获的数据保存到文件中</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mitmdump -w outfile #打开乱码</span><br></pre></td></tr></table></figure>

<p>如果设置设置代理报错<code> killed by block_global</code>， 添加参数</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mitmdump -w outfile --set block_global&#x3D;false</span><br></pre></td></tr></table></figure>





<p>还可以指定一个脚本来处理截获的数据，使用 -s 参数，脚本需要放在当前命令执行的目录下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mitmdump -s script.py</span><br></pre></td></tr></table></figure>

<p>脚本写入如下代码：定义了一个 request() 方法，参数为 flow，其实是一个 HTTPFlow 对象，通过 request 属性即可获取当前请求对象，然后打印输出请求头，将请求头修改成了 MitmProxy</p>
<p>手机端访问 <a href="http://httpbin.org/get">http://httpbin.org/get</a> 测试，查看请求的相关数据</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request</span>(<span class="params">flow</span>):</span></span><br><span class="line">	flow.request.headers[<span class="string">&#x27;User-Agent&#x27;</span>] = <span class="string">&#x27;MitmProxy&#x27;</span></span><br><span class="line">	print(flow.request.headers)</span><br></pre></td></tr></table></figure>

<ul>
<li>静默模式</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mitmdump -q -s index.py</span><br></pre></td></tr></table></figure>





<h6 id="日志输出"><a href="#日志输出" class="headerlink" title="日志输出"></a>日志输出</h6><p>可以设定不同级别以不同颜色输出结果，显示到中断控制台上</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> ctx</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request</span>(<span class="params">flow</span>):</span></span><br><span class="line">	flow.request.headers[<span class="string">&#x27;User-Agent&#x27;</span>] = <span class="string">&#x27;MitmProxy&#x27;</span></span><br><span class="line">	ctx.log.info(<span class="built_in">str</span>(flow.request.headers))</span><br><span class="line">	ctx.log.warn(<span class="built_in">str</span>(flow.request.headers))</span><br><span class="line">	ctx.log.error(<span class="built_in">str</span>(flow.request.headers))</span><br><span class="line">	print(flow.request.headers)</span><br></pre></td></tr></table></figure>

<p>这里调用了 ctx 模块，它有一个 log 功能</p>
<h6 id="Request-请求"><a href="#Request-请求" class="headerlink" title="Request 请求"></a>Request 请求</h6><p>还可输出其它内容 headers、cookies 等</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> ctx</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request</span>(<span class="params">flow</span>):</span></span><br><span class="line">	request = flow.request</span><br><span class="line">	info = ctx.log.info</span><br><span class="line">	print(info(<span class="built_in">str</span>(request.headers)))</span><br><span class="line">	print(info(<span class="built_in">str</span>(request.cookies)))</span><br><span class="line">	print(info(<span class="built_in">str</span>(request.host)))</span><br><span class="line">	print(info(<span class="built_in">str</span>(request.method)))</span><br><span class="line">	print(info(<span class="built_in">str</span>(request.port)))</span><br><span class="line">	print(info(<span class="built_in">str</span>(request.scheme)))</span><br></pre></td></tr></table></figure>

<p>可以对属性修改 ，修改脚本如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request</span>(<span class="params">flow</span>):</span></span><br><span class="line">	url = <span class="string">&#x27;https://httpbin.org/get&#x27;</span></span><br><span class="line">	flow.request.url = url</span><br></pre></td></tr></table></figure>

<p>访问 <a href="https://baidu.com/">https://baidu.com</a> 直接跳转到这里了 <a href="https://httpbin.org/get">https://httpbin.org/get</a></p>
<p>Request 还有很多属性 参考 <a href="http://docs.mitmproxy.org/en/latest/scripting/api.html">http://docs.mitmproxy.org/en/latest/scripting/api.html</a></p>
<h6 id="Response-响应"><a href="#Response-响应" class="headerlink" title="Response 响应"></a>Response 响应</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> ctx</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">response</span>(<span class="params">flow</span>):</span></span><br><span class="line">	response = flow.response</span><br><span class="line">	info = ctx.log.info</span><br><span class="line">	info(<span class="built_in">str</span>(response.status_code))</span><br><span class="line">	info(<span class="built_in">str</span>(response.headers))</span><br><span class="line">	info(<span class="built_in">str</span>(response.cookies))</span><br><span class="line">	info(<span class="built_in">str</span>(response.text))</span><br></pre></td></tr></table></figure>

<p>再访问 httpbin </p>
<ul>
<li>修改响应消息体-直接修改响应字段</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> ctx, http</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modify</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">response</span>(<span class="params">self, flow</span>):</span></span><br><span class="line">        <span class="keyword">if</span> flow.request.url.startswith(<span class="string">&quot;https://xxx.x.xxx.com.cn/activityInfo/getPrizeInfo==&quot;</span>):</span><br><span class="line">       		 //获取响应的json字符串，转成python对象进行解析和修改</span><br><span class="line">            response = json.loads(flow.response.get_text())</span><br><span class="line">            response[<span class="string">&#x27;limitCount&#x27;</span>] = <span class="number">1</span></span><br><span class="line">            //修改完成后，奖python对象转成json字符串，<span class="built_in">set</span>进请求的响应体重发送给客户端</span><br><span class="line">            flow.response.set_text(json.dumps(response))</span><br><span class="line">            ctx.log.info(<span class="string">&#x27;modify limitCount&#x27;</span>)</span><br><span class="line"> </span><br><span class="line"> addons = [</span><br><span class="line">	Modify()</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<ul>
<li>修改响应消息体-通过读取json文件的字符串返给客户端</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> ctx, http</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modify</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">response</span>(<span class="params">self, flow</span>):</span></span><br><span class="line">        <span class="keyword">if</span> flow.request.url.startswith(<span class="string">&quot;https://xxx.x.xxx.com.cn/activityInfo/getPrizeInfo==&quot;</span>):</span><br><span class="line">        	//读取文件，在当前文件路径下执行脚本，否则需要写文件的绝对路径；不然会找不到该json文件</span><br><span class="line">       		 <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;getStatus.json&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">       		 	//从json文件中读取数据成python对象</span><br><span class="line">                res = json.load(f)</span><br><span class="line">            //将读取的python对象转成json字符串发送给客户端</span><br><span class="line">            flow.response.set_text(json.dumps(res))</span><br><span class="line">            ctx.log.info(<span class="string">&quot;modify order status&quot;</span>)</span><br><span class="line"> </span><br><span class="line"> addons = [</span><br><span class="line">	Modify()</span><br><span class="line">]</span><br></pre></td></tr></table></figure>







<h6 id="拦截请求"><a href="#拦截请求" class="headerlink" title="拦截请求"></a>拦截请求</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> http, ctx</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Lock</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Filter</span>:</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, filter_info</span>):</span></span><br><span class="line">    self.log_info = <span class="string">&quot;&quot;</span></span><br><span class="line">    self.mutex = Lock()</span><br><span class="line">    self.filter_info = filter_info</span><br><span class="line">    self.response_file = <span class="literal">None</span></span><br><span class="line">    self.switch_on = <span class="literal">False</span></span><br><span class="line">    self.log_file = <span class="string">&quot;log.txt&quot;</span></span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">log</span>(<span class="params">self, info</span>) -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    self.log_info += <span class="string">f&quot;<span class="subst">&#123;info&#125;</span>\n\n&quot;</span></span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">write_log</span>(<span class="params">self, mode=<span class="string">&quot;w+&quot;</span></span>) -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    self.mutex.acquire()</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(self.log_file, mode) <span class="keyword">as</span> f:</span><br><span class="line">      f.write(self.log_info)</span><br><span class="line">    self.mutex.release()</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_target_flow</span>(<span class="params">self, flow: http.HTTPFlow</span>) -&gt; bool:</span></span><br><span class="line">    <span class="keyword">for</span> info <span class="keyword">in</span> self.filter_info:</span><br><span class="line">      <span class="keyword">if</span> info[<span class="string">&quot;str_in_url&quot;</span>] <span class="keyword">in</span> flow.request.url:</span><br><span class="line">        self.log_file = info[<span class="string">&quot;log_file&quot;</span>]</span><br><span class="line">        self.switch_on = info[<span class="string">&quot;switch_on&quot;</span>]</span><br><span class="line">        <span class="keyword">if</span> info[<span class="string">&quot;response_file&quot;</span>] != <span class="literal">None</span>:</span><br><span class="line">          self.response_file = info[<span class="string">&quot;response_file&quot;</span>]</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">modify_response</span>(<span class="params">self, flow: http.HTTPFlow</span>) -&gt; http.HTTPFlow:</span></span><br><span class="line">    <span class="keyword">if</span> self.switch_on <span class="keyword">and</span> self.response_file:</span><br><span class="line">      <span class="keyword">with</span> <span class="built_in">open</span>(self.response_file, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        flow.response.content = f.read().encode()</span><br><span class="line">    <span class="keyword">return</span> flow</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">request</span>(<span class="params">self, flow: http.HTTPFlow</span>) -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    <span class="keyword">if</span> self.is_target_flow(flow):</span><br><span class="line">      self.log_info = <span class="string">&quot;&quot;</span></span><br><span class="line">      self.log(<span class="string">f&quot;——METHOD——\n<span class="subst">&#123;flow.request.method&#125;</span>&quot;</span>)</span><br><span class="line">      self.log(<span class="string">f&quot;——HOST——\n<span class="subst">&#123;flow.request.pretty_host&#125;</span>&quot;</span>)</span><br><span class="line">      self.log(<span class="string">f&quot;——URL——\n<span class="subst">&#123;flow.request.pretty_url&#125;</span>&quot;</span>)</span><br><span class="line">      query = [i + <span class="string">&quot;:&quot;</span> + flow.request.query[i] + <span class="string">&quot;\n&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> flow.request.query]</span><br><span class="line">      self.log(<span class="string">f&quot;——QUERY STRING——\n<span class="subst">&#123;<span class="string">&#x27;&#x27;</span>.join(query)&#125;</span>&quot;</span>)</span><br><span class="line">      <span class="keyword">if</span> flow.request.urlencoded_form:</span><br><span class="line">        form = [i + <span class="string">&quot;:&quot;</span> + flow.request.urlencoded_form[i] + <span class="string">&quot;\n&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> flow.request.urlencoded_form]</span><br><span class="line">        self.log(<span class="string">f&quot;——FORM——\n<span class="subst">&#123;<span class="string">&#x27;&#x27;</span>.join(form)&#125;</span>&quot;</span>)</span><br><span class="line">      self.write_log()</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">response</span>(<span class="params">self, flow: http.HTTPFlow</span>) -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    <span class="keyword">if</span> self.is_target_flow(flow):</span><br><span class="line">      self.log_info = <span class="string">&quot;&quot;</span></span><br><span class="line">      self.log(<span class="string">f&quot;——RESPONSE before modified——\n<span class="subst">&#123;flow.response.content.decode()&#125;</span>&quot;</span>)</span><br><span class="line">      flow = self.modify_response(flow)</span><br><span class="line">      self.log(<span class="string">f&quot;——RESPONSE after modified——\n<span class="subst">&#123;flow.response.content.decode()&#125;</span>&quot;</span>)</span><br><span class="line">      self.write_log(mode=<span class="string">&quot;a&quot;</span>)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">filter_info = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;str_in_url&quot;</span>: <span class="string">&quot;getSimpleNews&quot;</span>,</span><br><span class="line">    <span class="string">&quot;log_file&quot;</span>: <span class="string">&quot;getSimpleNews_log.txt&quot;</span>,</span><br><span class="line">    <span class="string">&quot;switch_on&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">    <span class="string">&quot;response_file&quot;</span>: <span class="string">&quot;getSimpleNews_response.txt&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;str_in_url&quot;</span>: <span class="string">&quot;getQQNewsComment&quot;</span>,</span><br><span class="line">    <span class="string">&quot;log_file&quot;</span>: <span class="string">&quot;getQQNewsComment_log.txt&quot;</span>,</span><br><span class="line">    <span class="string">&quot;switch_on&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">    <span class="string">&quot;response_file&quot;</span>: <span class="literal">None</span>,</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line">addons = [</span><br><span class="line">  Filter(filter_info)</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="Script"><a href="#Script" class="headerlink" title="Script"></a>Script</h6><ol>
<li>可以定义 py 文件供 mitmproxy 加载，定义若干函数，这些函数实现 mitmproxy 提供的事件</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> http</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request</span>(<span class="params">self, flow:http.HTTPFlow</span>):</span></span><br><span class="line">	...</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>编写 py 文件供 mitmproxy 加载，文件定义 addons 数组，数组元素是一个类实例，这些类里面有若干函数，这些函数实现 mitmproxy 提供的事件</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> mitmproxy.http</span><br><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> ctx</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span>:</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">    self.num = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request</span>(<span class="params">self, flow: mitmproxy.http.HTTPFlow</span>):</span></span><br><span class="line">    self.num = self.num + <span class="number">1</span></span><br><span class="line">    ctx.log.info(<span class="string">&quot;We&#x27;ve seen %d flows&quot;</span> % self.num)</span><br><span class="line"></span><br><span class="line">addons = [</span><br><span class="line">    Counter()</span><br><span class="line">]</span><br></pre></td></tr></table></figure>







<p>sniffer.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> http</span><br><span class="line"> </span><br><span class="line">password_key = [<span class="string">&quot;password&quot;</span>, <span class="string">&quot;pwd&quot;</span>, <span class="string">&quot;pass&quot;</span>, <span class="string">&quot;passwd&quot;</span>, <span class="string">&quot;mm&quot;</span>, <span class="string">&quot;passport&quot;</span>, <span class="string">&quot;auth&quot;</span>, <span class="string">&quot;key&quot;</span>, <span class="string">&quot;mima&quot;</span>]</span><br><span class="line">form_login_key = [<span class="string">&quot;check&quot;</span>, <span class="string">&quot;login&quot;</span>, <span class="string">&quot;verify&quot;</span>, <span class="string">&quot;account&quot;</span>, <span class="string">&quot;logon&quot;</span>, <span class="string">&quot;signin&quot;</span>, <span class="string">&quot;denglu&quot;</span>]</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sniffer</span>:</span></span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">request</span>(<span class="params">self, flow: http.HTTPFlow</span>):</span></span><br><span class="line">		request = flow.request</span><br><span class="line">		url = request.pretty_url</span><br><span class="line">		form_url = <span class="built_in">str</span>(request.urlencoded_form)</span><br><span class="line">		<span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">			<span class="keyword">if</span> self.any_match(form_login_key, url) <span class="keyword">or</span> self.any_match(password_key, form_url):</span><br><span class="line">				self.resolve(flow)</span><br><span class="line">                </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">any_match</span>(<span class="params">self, <span class="built_in">list</span>, <span class="built_in">str</span>: <span class="built_in">str</span></span>):</span></span><br><span class="line">		lower_str = <span class="built_in">str</span>.lower()</span><br><span class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">list</span>:</span><br><span class="line">			<span class="keyword">if</span> i <span class="keyword">in</span> lower_str:</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">resolve</span>(<span class="params">self, flow: http.HTTPFlow</span>):</span></span><br><span class="line">		request = flow.request</span><br><span class="line">		url = request.url</span><br><span class="line">		_from = <span class="built_in">str</span>(flow.client_conn.ip_address)</span><br><span class="line">		url_form = <span class="built_in">str</span>(request.urlencoded_form)</span><br><span class="line">		header = <span class="built_in">str</span>(request.headers)</span><br><span class="line"> </span><br><span class="line">		logging.info(<span class="string">&quot;url: %s \nheader: %s \nform: %s \nip_from: %s&quot;</span>, url, header, url_form, _from)</span><br></pre></td></tr></table></figure>

<p>addos.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sniffer <span class="keyword">import</span> Sniffer</span><br><span class="line"> </span><br><span class="line">addons = [</span><br><span class="line">	Sniffer()</span><br><span class="line">    <span class="comment"># YourSniffer()</span></span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>









<h4 id="远程主机抓包"><a href="#远程主机抓包" class="headerlink" title="远程主机抓包"></a>远程主机抓包</h4><p>linux 主机 CentOS8系统，安装好 mitmproxy </p>
<p>云主机安全组入方向添加8080端口，宝塔面板防火墙开放8080端口</p>
<p>启动 mitmdump</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mitmdump -w outfile --set block_global&#x3D;false</span><br></pre></td></tr></table></figure>

<p>可以看到抓取到的链接</p>
<p>指定脚本处理数据，如获取京东的 pt_key</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mitmdump -s main.py --set block_global&#x3D;false</span><br><span class="line">#</span><br><span class="line">mitmweb -s script1.py --set block_global&#x3D;false</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> mitmproxy.net.http.request <span class="keyword">import</span> Request</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request</span>(<span class="params">flow</span>):</span></span><br><span class="line">    url = <span class="string">&#x27;https://mars.jd.com/log/sdk&#x27;</span></span><br><span class="line">    request = flow.request <span class="comment">#type: Request</span></span><br><span class="line">    <span class="keyword">if</span> request.url.startswith(url):</span><br><span class="line">        pt_key = request.cookies.get(<span class="string">&#x27;pt_key&#x27;</span>)</span><br><span class="line">        pt_pin = request.cookies.get(<span class="string">&#x27;pt_pin&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> pt_key <span class="keyword">and</span> pt_pin:</span><br><span class="line">            print(<span class="string">&#x27;接收到：pt_key=&#123;&#125;;pt_pin=&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(pt_key, pt_pin))</span><br></pre></td></tr></table></figure>





<h4 id="11-3-mitmdump-爬取“得到”APP电子书信息"><a href="#11-3-mitmdump-爬取“得到”APP电子书信息" class="headerlink" title="11.3 mitmdump 爬取“得到”APP电子书信息"></a>11.3 mitmdump 爬取“得到”APP电子书信息</h4><p>爬取得到APP电子书板块，新书上架电子书信息，保存到 MongoDB</p>
<p>运行 mitmdump</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mitmdup -s script.py</span><br></pre></td></tr></table></figure>

<p>script.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">response</span>(<span class="params">flow</span>):</span></span><br><span class="line">	print(<span class="string">&#x27;url:&#x27;</span>, flow.request.url)</span><br><span class="line">	print(<span class="string">&#x27;response:&#x27;</span>, flow.response.text)</span><br></pre></td></tr></table></figure>

<p>打印太多接口，不方便分析，改用 Charles 抓取数据</p>
<p>可以看到列表接口 <a href="https://entree.igetget.com/ebook2/v1/ebook/list">https://entree.igetget.com/ebook2/v1/ebook/list</a></p>
<h5 id="数据抓取"><a href="#数据抓取" class="headerlink" title="数据抓取"></a>数据抓取</h5><p>对接口做过滤限制，抓取接口数据，提取结果中对应的字段</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> ctx</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">response</span>(<span class="params">flow</span>):</span></span><br><span class="line">	url = <span class="string">&#x27;https://entree.igetget.com/ebook2/v1/ebook/list&#x27;</span></span><br><span class="line">	requestUrl = flow.request.url <span class="comment">#type: str</span></span><br><span class="line">	<span class="keyword">if</span> requestUrl.startswith(url):</span><br><span class="line">		text = flow.response.text</span><br><span class="line">		data = json.loads(text)</span><br><span class="line">		books = data.get(<span class="string">&#x27;c&#x27;</span>).get(<span class="string">&#x27;list&#x27;</span>)</span><br><span class="line">		<span class="keyword">for</span> book <span class="keyword">in</span> books:</span><br><span class="line">			ctx.log.info(<span class="built_in">str</span>(book))</span><br></pre></td></tr></table></figure>

<p>可以看到控制台上输出电子书信息</p>
<h5 id="提取保存"><a href="#提取保存" class="headerlink" title="提取保存"></a>提取保存</h5><p>声明 MongoDB 数据库连接，提取信息插入数据库</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> ctx</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> pymongo</span><br><span class="line"></span><br><span class="line">client = pymongo.MongoClient()</span><br><span class="line">db = client[<span class="string">&#x27;igetget&#x27;</span>] <span class="comment">#相当于哪个数据库</span></span><br><span class="line">collection = db[<span class="string">&#x27;books&#x27;</span>] <span class="comment">#相当于哪个表</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">response</span>(<span class="params">flow</span>):</span></span><br><span class="line">	url = <span class="string">&#x27;https://entree.igetget.com/ebook2/v1/ebook/list&#x27;</span></span><br><span class="line">	requestUrl = flow.request.url <span class="comment">#type: str</span></span><br><span class="line">	<span class="keyword">if</span> requestUrl.startswith(url):</span><br><span class="line">		text = flow.response.text</span><br><span class="line">		data = json.loads(text)</span><br><span class="line">		books = data.get(<span class="string">&#x27;c&#x27;</span>).get(<span class="string">&#x27;list&#x27;</span>)</span><br><span class="line">		<span class="keyword">for</span> book <span class="keyword">in</span> books:</span><br><span class="line">			data = &#123;</span><br><span class="line">				<span class="string">&#x27;title&#x27;</span>: book.get(<span class="string">&#x27;operating_title&#x27;</span>),</span><br><span class="line">				<span class="string">&#x27;cover&#x27;</span>: book.get(<span class="string">&#x27;cover&#x27;</span>),</span><br><span class="line">				<span class="string">&#x27;summary&#x27;</span>: book.get(<span class="string">&#x27;other_share_summary&#x27;</span>),</span><br><span class="line">				<span class="string">&#x27;price&#x27;</span>: book.get(<span class="string">&#x27;price&#x27;</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			ctx.log.info(<span class="built_in">str</span>(book))</span><br><span class="line">			collection.insert(data)</span><br></pre></td></tr></table></figure>

<h4 id="11-4-Appium-使用"><a href="#11-4-Appium-使用" class="headerlink" title="11.4 Appium 使用"></a>11.4 Appium 使用</h4><p>Appium 是一个跨平台移动端自动化测试工具，可以模拟 APP 内部的各种操作，如点击、滑动、文本输入等，对 iOS 设备 Appium 使用 UIAutomation 来实现驱动，对 Android 来说，使用 UIAutomator 和 Selendroid 来实现驱动</p>
<p>Appium 相当于一个服务器，我们可以向 Appium 发送一些操作指令，Appium 就会根据不同的指令对移动设备进行驱动，完成不同的动作</p>
<img src="Python3网络爬虫开发实战-12App爬取/WeChatca0e02e38eb8e8ab9bcfa7bd8d363752.png" alt="WeChatca0e02e38eb8e8ab9bcfa7bd8d363752" style="zoom:50%;" />

<p>点击 Start Server 即可启动 Appium 的服务，相当于开启了一个 Appium 服务，可以通过 Appium 内置驱动或 Python 代码向 Appium 的服务发送一系列操作指令，Appium 就会根据不同的指令对移动设备进行驱动，完成不同的动作</p>
<h6 id="Appium内置驱动打开APP"><a href="#Appium内置驱动打开APP" class="headerlink" title="Appium内置驱动打开APP"></a>Appium内置驱动打开APP</h6><p>Appium 运行之后正在监听 4723 端口，我们可以向此端口对应的服务接口发送操作指令</p>
<p>Host设置127.0.0.1</p>
<p>打开 Appium Inspector</p>
<p>配置参数</p>
<p>Remote Path: /wd/hub</p>
<p>platformName: 品台名称 iOS 或 Android</p>
<p>deviceName：设备名称</p>
<p>bundleId：APP包名(下面截图改成 bundleId)</p>
<p>其它配置参数 <a href="https://github.com/appium/appium/blob/master/docs/en/writing-running-appium/caps.md">https://github.com/appium/appium/blob/master/docs/en/writing-running-appium/caps.md</a></p>
<img src="Python3网络爬虫开发实战-12App爬取/3641650270925_.pic.jpg" alt="3641650270925_.pic" style="zoom: 67%;" />

<p>Start Session报错</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Failed to create session. An unknown server-side error occurred while processing the command. Original error: Unable to launch WebDriverAgent because of xcodebuild failure: xcodebuild failed with code 70 xcodebuild error message: . Make sure you follow the tutorial at https:&#x2F;&#x2F;github.com&#x2F;appium&#x2F;appium-xcuitest-driver&#x2F;blob&#x2F;master&#x2F;docs&#x2F;real-device-config.md. Try to remove the WebDriverAgentRunner application from the device if it is installed and reboot the device.</span><br></pre></td></tr></table></figure>

<p>进入 Appium 路径 </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;Applications&#x2F;Appium Server GUI.app&#x2F;Contents&#x2F;Resources&#x2F;app&#x2F;node_modules&#x2F;appium&#x2F;node_modules&#x2F;appium-webdriveragent</span><br></pre></td></tr></table></figure>

<p>打开 WebDriverAgent 项目，选择 Targets-WebDriverAgentRunner 配置好证书 </p>
<p>Product - Test ，如果连接手机，会安装一个 WebDriverAgent app，启动后又回到桌面，控制台可以看到设备的IP地址 <a href="http://10.1.253.120:8100/">http://10.1.253.120:8100</a> 加上/status 即 <a href="http://10.1.253.120:8100/status%EF%BC%8C%E6%89%93%E5%BC%80%E6%B5%8F%E8%A7%88%E5%99%A8%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%87%BA%E7%8E%B0%E4%B8%80%E4%B8%B2">http://10.1.253.120:8100/status，打开浏览器，如果出现一串</a> JSON，说明 WDA 安装成功了，打开<a href="http://10.1.253.120:8100/inspector">http://10.1.253.120:8100/inspector</a> 可以查看界面和元素信息</p>
<p>再次点击 StartSession</p>
<img src="Python3网络爬虫开发实战-12App爬取/3651650273841_.pic.jpg" alt="3651650273841_.pic" style="zoom:70%;" />

<p>左边显示APP界面，选中某个元素，中间就显示元素对应源代码，右栏显示元素的基本信息，如元素 id、class、text 等，以及可以执行的操作，如 Tap、Send Keys、Clear</p>
<p>还可以录制操作动作，窗口中操作的 APP行为都会被记录下来，Recorder 处可以自动生成对应语言的代码</p>
<img src="Python3网络爬虫开发实战-12App爬取/3661650274120_.pic.jpg" alt="3661650274120_.pic" style="zoom:80%;" />

<h6 id="Python代码驱动APP"><a href="#Python代码驱动APP" class="headerlink" title="Python代码驱动APP"></a>Python代码驱动APP</h6><p>代码中指定 Appium Server</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">server = <span class="string">&#x27;http://localhost:4723/wd/hub&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这个 Server 在刚打开 Appium 的时候就已经开启了，是在 4723 端口上运行的</p>
<p>新建一个 Session，这类似点击 Appium 内置驱动的 Start Session 按钮相同的功能</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> appium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> WebDriverWait</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">	server = <span class="string">&#x27;http://localhost:4723/wd/hub&#x27;</span></span><br><span class="line">	desired_caps = &#123;</span><br><span class="line">		<span class="string">&#x27;platformName&#x27;</span>: <span class="string">&quot;iOS&quot;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:deviceName&#x27;</span>: <span class="string">&#x27;iPhoneq&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:bundleId&#x27;</span>: <span class="string">&#x27;com.SwiftDemo&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:udid&#x27;</span>: <span class="string">&#x27;4ce52917e9a0932f3c821e2418a03d2a993c5650&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:platformVersion&#x27;</span>: <span class="string">&#x27;14.5&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:xcodeSigningId&#x27;</span>: <span class="string">&#x27;iPhone Developer&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:xcodeOrgId&#x27;</span>: <span class="string">&#x27;C28X7H9ZW6&#x27;</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	driver = webdriver.Remote(server, desired_caps)</span><br></pre></td></tr></table></figure>

<p>运行后就启动 APP了 </p>
<p>查看刚才录制生成的Python代码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">el1 = driver.find_element(by=AppiumBy.ACCESSIBILITY_ID, value=<span class="string">&quot;DelegateProxy&quot;</span>) el1.click() </span><br><span class="line">el2 = driver.find_element(by=AppiumBy.ACCESSIBILITY_ID, value=<span class="string">&quot;ImagePicker照片选择&quot;</span>) el2.click()</span><br></pre></td></tr></table></figure>

<p>修改</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> appium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">	server = <span class="string">&#x27;http://localhost:4723/wd/hub&#x27;</span></span><br><span class="line">	desired_caps = &#123;</span><br><span class="line">		<span class="string">&#x27;platformName&#x27;</span>: <span class="string">&quot;iOS&quot;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:deviceName&#x27;</span>: <span class="string">&#x27;iPhoneq&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:bundleId&#x27;</span>: <span class="string">&#x27;com.SwiftDemo&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:udid&#x27;</span>: <span class="string">&#x27;4ce52917e9a0932f3c821e2418a03d2a993c5650&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:platformVersion&#x27;</span>: <span class="string">&#x27;14.5&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:xcodeSigningId&#x27;</span>: <span class="string">&#x27;iPhone Developer&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:xcodeOrgId&#x27;</span>: <span class="string">&#x27;C28X7H9ZW6&#x27;</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	driver = webdriver.Remote(server, desired_caps)</span><br><span class="line">  <span class="comment">#获取元素时设置等待</span></span><br><span class="line">	wait = WebDriverWait(driver, <span class="number">30</span>)</span><br><span class="line">	ele1 = wait.until(EC.presence_of_element_located((By.ID, <span class="string">&#x27;DelegateProxy&#x27;</span>)))</span><br><span class="line">	ele1.click()</span><br><span class="line">	ele2 = wait.until(EC.presence_of_element_located((By.ID, <span class="string">&#x27;ImagePicker照片选择&#x27;</span>)))</span><br><span class="line">	ele2.click()</span><br></pre></td></tr></table></figure>

<h6 id="API"><a href="#API" class="headerlink" title="API"></a>API</h6><p>使用的Python库为 AppiumPythonClint <a href="https://github.com/appium/python-client">https://github.com/appium/python-client</a> 此库继承自 Selenium</p>
<ul>
<li>初始化</li>
</ul>
<p>代码参数上面的</p>
<p>如果要打开的app没有先安装到手机上，也可以直接指定app的包路径</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">app &#x3D; os.path.abspath(&#39;&#x2F;Users&#x2F;xx&#x2F;xx&#x2F;build&#x2F;Debug-iphoneos&#x2F;xx.app&#39;)</span><br></pre></td></tr></table></figure>

<ul>
<li>查找元素</li>
</ul>
<p>可以使用 Selenium 中通用的查找方法来查找元素</p>
<p>iOS 平台，可以使用 UIAutomation 来进行元素选择</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">el = self.driver.find_element_by_ios_uiautomation(<span class="string">&#x27;.elements()[0]&#x27;</span>)</span><br><span class="line">el = self.driver.find_element_by_ios_uiautomation(<span class="string">&#x27;.elements()&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>还可以使用 iOS Predicates 来进行元素选择</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">el = self.driver.find_element_by_ios_predicate(<span class="string">&#x27;wdName=&quot;Buttons&quot;&#x27;</span>)</span><br><span class="line">el = self.driver.find_element_by_ios_predicate(<span class="string">&#x27;wdName=&quot;SearchBar&quot; AND isWDDivisible == 1&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>也可使用 iOS Class Chain 来选择</p>
<p>此方法只适用于 XCUIText 驱动</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">el = self.driver.find_element_by_ios_class_chain(<span class="string">&#x27;XCUIElementTypeWindow/XCUIElementTypeButton[3]&#x27;</span>)</span><br><span class="line">el = self.driver.find_element_by_ios_class_chain(<span class="string">&#x27;XCUIElementTypeWindow/XCUIElementTypeButton&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>点击</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tap(self, positions, duration=<span class="literal">None</span>)</span><br><span class="line"><span class="comment">#positions 点击的位置组成的列表</span></span><br><span class="line"><span class="comment">#duration  点击持续时间</span></span><br><span class="line">tap([(<span class="number">100</span>,<span class="number">200</span>),(<span class="number">100</span>,<span class="number">60</span>)], <span class="number">500</span>) <span class="comment">#模拟点击屏幕的几个点</span></span><br></pre></td></tr></table></figure>

<p>对某个元素如按钮，可以直接调用 click() 模拟点击</p>
<ul>
<li>屏幕拖动</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">scroll(self, origin_el, destination_el)</span><br><span class="line"><span class="comment">#实现从元素 origin_el 滚动至 destination_el</span></span><br><span class="line"><span class="comment">#origin_el 被操作元素</span></span><br><span class="line"><span class="comment">#destination_el 目标元素</span></span><br><span class="line"></span><br><span class="line">swipe(self, start_x, start_y, end_X, end_Y, duration=<span class="literal">None</span>) <span class="comment">#从A点滑动到B点</span></span><br><span class="line"></span><br><span class="line">flick(self, start_x, start_y, end_X, end_Y) <span class="comment">#从A点快速滑动到B点</span></span><br></pre></td></tr></table></figure>

<ul>
<li>拖拽</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">drag_and_drop(self, origin_el, destination_el)</span><br><span class="line"><span class="comment">#实现从元素 origin_el 拖拽至 destination_el</span></span><br></pre></td></tr></table></figure>

<ul>
<li>文本输入</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">set_text()</span><br></pre></td></tr></table></figure>

<ul>
<li>动作键</li>
</ul>
<p>与 Selenium 中的ActionChains 类似， Appi 中的 TouchAction 可支持的方法有 tap()、press()、long_press()、release()、move_to()、wait()、cancel() 等</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">el = self.driver.find_element_by_accessiblity_id</span><br><span class="line">action = TouchAction(self.driver)</span><br><span class="line">action.tap(el).perform</span><br></pre></td></tr></table></figure>

<p>选中一个元素，然后利用 TouchAction 实现点击操作</p>
<p>如果要拖动</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">els = self.driver.find_elements_by_class_name(<span class="string">&#x27;listView&#x27;</span>)</span><br><span class="line">a1 = TouchAction()</span><br><span class="line">a1.press(els[<span class="number">0</span>]).move_to(x=<span class="number">10</span>, y=<span class="number">0</span>).move_to(x=<span class="number">10</span>,y=<span class="number">-75</span>).move_to(x=<span class="number">10</span>,y=<span class="number">-100</span>).release()</span><br><span class="line">aw = TouchAction()</span><br><span class="line">a2.press(els[<span class="number">1</span>]).move_to(x=<span class="number">10</span>, y=<span class="number">0</span>).move_to(x=<span class="number">10</span>, y=<span class="number">-30</span>).move_to(x=<span class="number">10</span>, y=<span class="number">-600</span>).release()</span><br></pre></td></tr></table></figure>

<p>更多参考 <a href="https://testerhome.com/topics/3711">https://testerhome.com/topics/3711</a></p>
<h4 id="11-5-Appium-爬取朋友圈"><a href="#11-5-Appium-爬取朋友圈" class="headerlink" title="11.5 Appium 爬取朋友圈"></a>11.5 Appium 爬取朋友圈</h4><p>代码 <a href="https://github.com/Python3WebSpider/Moments">https://github.com/Python3WebSpider/Moments</a></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">FLICK_START_X = <span class="number">300</span></span><br><span class="line">FLICK_START_Y = <span class="number">300</span></span><br><span class="line">FLICK_DISTANCE = <span class="number">700</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#... 进入朋友圈页面 模拟上滑</span></span><br><span class="line"> self.driver.swipe(FLICK_START_X, FLICK_START_Y + FLICK_DISTANCE, FLICK_START_X, FLICK_START_Y)</span><br><span class="line"><span class="comment"># 遍历每条状态 获取数据保存</span></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 昵称</span></span><br><span class="line">        nickname = item.find_element_by_id(<span class="string">&#x27;com.tencent.mm:id/aig&#x27;</span>).get_attribute(<span class="string">&#x27;text&#x27;</span>)</span><br><span class="line">        <span class="comment"># 正文</span></span><br><span class="line">        content = item.find_element_by_id(<span class="string">&#x27;com.tencent.mm:id/cwm&#x27;</span>).get_attribute(<span class="string">&#x27;text&#x27;</span>)</span><br><span class="line"><span class="comment">#...</span></span><br></pre></td></tr></table></figure>





<p>使用终端代替Xcode</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 解锁keychain，以便可以正常的签名应用，</span><br><span class="line">PASSWORD&#x3D;&quot;replace-with-your-password&quot;</span><br><span class="line">security unlock-keychain -p $PASSWORD ~&#x2F;Library&#x2F;Keychains&#x2F;login.keychain</span><br><span class="line"></span><br><span class="line"># 获取设备的UDID</span><br><span class="line">UDID&#x3D;$(idevice_id -l | head -n1)</span><br><span class="line"></span><br><span class="line"># 运行测试</span><br><span class="line">xcodebuild -project WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner -destination &quot;id&#x3D;$UDID&quot; test</span><br></pre></td></tr></table></figure>



<h4 id="11-5-Appium-mitmdump爬取京东商品"><a href="#11-5-Appium-mitmdump爬取京东商品" class="headerlink" title="11.5 Appium+mitmdump爬取京东商品"></a>11.5 Appium+mitmdump爬取京东商品</h4><p>Charles 抓包分析数据</p>
<p>mitmdump 抓取解析数据保存</p>
<p>Appium驱动APP完成一系列动作</p>
<h4 id="报错问题"><a href="#报错问题" class="headerlink" title="报错问题"></a>报错问题</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">A new session could not be created. Details: Appium&#39;s IosDriver does not support xcode version 13.3</span><br><span class="line">Apple has deprecated UIAutomation. Use the &quot;XCUITest&quot; automationName capability instead</span><br></pre></td></tr></table></figure>

<p>添加参数 automationName=XCUITest</p>
<h4 id="11-6-Airtest"><a href="#11-6-Airtest" class="headerlink" title="11.6 Airtest"></a>11.6 Airtest</h4><p>自动化测试工具</p>
<p>airtest 官方文档 <a href="https://airtest.readthedocs.io/zh_CN/latest/index.html">https://airtest.readthedocs.io/zh_CN/latest/index.html</a></p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Python3网络爬虫开发实战-2基本库使用</title>
    <url>/2022/04/11/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-2%E5%9F%BA%E6%9C%AC%E5%BA%93%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>urllib、request</p>
<h4 id="2-基本库使用"><a href="#2-基本库使用" class="headerlink" title="2. 基本库使用"></a>2. 基本库使用</h4><h4 id="urllib"><a href="#urllib" class="headerlink" title="urllib"></a>urllib</h4><p>Python内置 HTTP 请求库，包含4个模块</p>
<ul>
<li>request</li>
</ul>
<p>基本 HTTP 请求模块，用来模拟发送请求</p>
<ul>
<li>error</li>
</ul>
<p>异常处理，如果出现请求错误，可以捕获这些异常</p>
<ul>
<li>parse</li>
</ul>
<p>工具模块，提供了许多 URL 处理方法 如拆分、解析、合并</p>
<ul>
<li>robotparser</li>
</ul>
<p>识别网站 robots.txt 文件，然后判断哪些网站可以爬，实际用的少</p>
<h5 id="发送请求"><a href="#发送请求" class="headerlink" title="发送请求"></a>发送请求</h5><h6 id="urlopen"><a href="#urlopen" class="headerlink" title="urlopen()"></a>urlopen()</h6><p>可以完成简单请求和网页抓取</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> http.client <span class="keyword">import</span> HTTPResponse</span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"></span><br><span class="line">ssl._create_default_https_context = ssl._create_unverified_context</span><br><span class="line">response = urllib.request.urlopen(<span class="string">&#x27;https://www.python.org&#x27;</span>) <span class="comment">#type: HTTPResponse</span></span><br><span class="line">print(<span class="built_in">type</span>(response)) <span class="comment">#&lt;class &#x27;http.client.HTTPResponse&#x27;&gt;</span></span><br><span class="line">print(response.read().decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">print(response.status) <span class="comment">#200</span></span><br><span class="line">print(response.getheaders())</span><br><span class="line">print(response.getheader(<span class="string">&#x27;Server&#x27;</span>)) <span class="comment">#nginx</span></span><br></pre></td></tr></table></figure>

<p>调用 read() 方法可以得到返回的网页内容</p>
<blockquote>
<p>response 敲属性代码没提示，加上类型注释 #type: HTTPResponse</p>
<p>或者使用 isinstance 指定 assert isinstance(response, HTTPResponse)</p>
</blockquote>
<p>urlopen 的参数 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">urlopen(url, data=<span class="literal">None</span>, timeout=socket._GLOBAL_DEFAULT_TIMEOUT,*, cafile=<span class="literal">None</span>, capath=<span class="literal">None</span>, cadefault=<span class="literal">False</span>, context=<span class="literal">None</span>)</span><br></pre></td></tr></table></figure>

<h6 id="data参数"><a href="#data参数" class="headerlink" title="data参数"></a>data参数</h6><p>可选，需要使用 bytes() 方法将参数转化为字节流编码格式的内容，即 bytes 类型。</p>
<p>如果传递了这个参数，那么它的请求方式不再是 GET，而是 POST 了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> http.client <span class="keyword">import</span> HTTPResponse</span><br><span class="line"></span><br><span class="line">data = <span class="built_in">bytes</span>(urllib.parse.urlencode(&#123;<span class="string">&#x27;word&#x27;</span>: <span class="string">&#x27;hello&#x27;</span>&#125;),encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">response = urllib.request.urlopen(<span class="string">&#x27;http://httpbin.org/post&#x27;</span>, data=data) <span class="comment">#type: HTTPResponse</span></span><br><span class="line">print(response.read().decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>byte() 方法第一个参数需要 str 类型，需要用 urllib.parse 模块里的 urlencode() 方法将参数字典转化为字符串；第二个参数指定编码格式</p>
<p>站点 <a href="http://httpbin.org/post">http://httpbin.org/post</a>  可以提供 HTTP 请求测试</p>
<h6 id="timeout参数"><a href="#timeout参数" class="headerlink" title="timeout参数"></a>timeout参数</h6><p>设置超时时间，单位秒，请求超出设置的时间还没有得到响应，抛出异常</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">import</span> urllib.error</span><br><span class="line"><span class="keyword">from</span> http.client <span class="keyword">import</span> HTTPResponse</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = urllib.request.urlopen(<span class="string">&#x27;http://httpbin.org/get&#x27;</span>, timeout=<span class="number">0.1</span>)<span class="comment">#type: HTTPResponse</span></span><br><span class="line"><span class="keyword">except</span> urllib.error.URLError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(e.reason, socket.timeout):</span><br><span class="line">        print(<span class="string">&#x27;TIME OUT&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>其它参数</li>
</ul>
<p>context 参数：必须是 ssl.SSLContext 类型，用来指定 SSL 设置</p>
<p>cafile 和 capath ：分别指定 CA 证书 和 它的路径，这个在请求 HTTPS 链接时会有用</p>
<h6 id="Request"><a href="#Request" class="headerlink" title="Request"></a>Request</h6><p>利用 urlopen 方法可以发起最基本的请求，但它几个简单的参数并不足以构建一个完整的请求，如果需要 Headers 等信息，可以利用更加强大的 Resquest 类来构建</p>
<p>利用 Request 可以将请求独立成一个对象，更加丰富的配置参数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> http.client <span class="keyword">import</span> HTTPResponse</span><br><span class="line"></span><br><span class="line">request = urllib.request.Request(<span class="string">&#x27;https://python.org&#x27;</span>)</span><br><span class="line">response = urllib.request.urlopen(request) <span class="comment">#type: HTTPResponse</span></span><br><span class="line">print(response.read().decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>Request 参数：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">url, data=<span class="literal">None</span>, headers=&#123;&#125;,origin_req_host=<span class="literal">None</span>, unverifiable=<span class="literal">False</span>,method=<span class="literal">None</span></span><br></pre></td></tr></table></figure>

<p>url：必传参数，其它都是可选</p>
<p>data：如果要传，必须传 bytes（字节流）类型的，如果它是字典，先用 urllib.parse 模块里的 urlenode() 编码</p>
<p>headers： 是一个字典，可以在构建请求时通过 headers 直接构建，也可通过调用请求实例的 add_header()方法添加，可以通过修改 User-Agent 来伪装浏览器，默认是 Python-urllib</p>
<p>origin_req_host：请求方 host 名称或 IP 地址</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> http.client <span class="keyword">import</span> HTTPResponse</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://httpbin.org/post&#x27;</span></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/4.0 (compatible)&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Host&#x27;</span>: <span class="string">&#x27;httpbin.org&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">dict</span> = &#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Germey&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">data = <span class="built_in">bytes</span>(urllib.parse.urlencode(<span class="built_in">dict</span>), encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">req = request.Request(url=url, data=data, headers=headers, method=<span class="string">&#x27;POST&#x27;</span>)</span><br><span class="line">response = request.urlopen(req) <span class="comment"># type:HTTPResponse</span></span><br><span class="line">print(response.read().decode(<span class="string">&#x27;utf-8&#x27;</span>))&#125;</span><br></pre></td></tr></table></figure>

<p>unverifiable：这个请求是否是无法验证的，默认 false，</p>
<p>method：请求方法 POST GET</p>
<p>headers 也可以用 add_header() 方法添加</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">req = request.Request(url=url, data=data, method=<span class="string">&#x27;POST&#x27;</span>)</span><br><span class="line">req.add_header(<span class="string">&#x27;User-Agent&#x27;</span>, <span class="string">&#x27;Mozilla/4.0 (compatible; MSIE 5.5; Windows NT)&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h6 id="高级用法"><a href="#高级用法" class="headerlink" title="高级用法"></a>高级用法</h6><p>更高级的操作（Cookie处理、设置代理）该怎么操作？使用 Handler，可以理解为各种处理器</p>
<p>urllib.request 模块里的 BaseHandler 类是所有 Handler 的父类</p>
<p>子类：</p>
<p>HTTPDefaultErrorHandler：处理 HTTP 响应错误，错误会抛出 HTTPError 类型异常</p>
<p>HTTPRedirectHandler：用于处理重定向</p>
<p>HTTPCookieProcessor：用于处理 Cookies</p>
<p>ProxyHandler：用于设置代理</p>
<p>HTTPPasswordMgr：用于管理密码</p>
<p>HTTPBasicAuthHandler：用于管理认证，如果一个链接打开时需要认证，可以用它来解决认证问题</p>
<p>OpenerDirector：可以称为 Opener，之前用过的 urlopen 方法，实际上就是 urllib 库为我们提供的一个 Opener</p>
<p>用法：登录验证、代理、Cookie</p>
<h6 id="登录验证"><a href="#登录验证" class="headerlink" title="登录验证"></a>登录验证</h6><p>访问某些网站：<a href="https://ssr3.scrape.center/">https://ssr3.scrape.center/</a> 可能会弹出这样的认证窗口，表示这个网站启用了基本身份认证</p>
<p><img src="/Users/caodaxun/hexo/source/_posts/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-2%E5%9F%BA%E6%9C%AC%E5%BA%93%E4%BD%BF%E7%94%A8/1.png" alt="1"></p>
<p>爬取这样的页面，借助 HTTPBasicAuthHandler 模块就可以完成</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> HTTPPasswordMgrWithDefaultRealm,HTTPBasicAuthHandler, build_opener</span><br><span class="line"><span class="keyword">from</span> urllib.error <span class="keyword">import</span> URLError</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    username = <span class="string">&#x27;admin&#x27;</span></span><br><span class="line">    password = <span class="string">&#x27;admin&#x27;</span></span><br><span class="line">    url = <span class="string">&#x27;https://ssr3.scrape.center/&#x27;</span></span><br><span class="line">    p = HTTPPasswordMgrWithDefaultRealm()</span><br><span class="line">    p.add_password(<span class="literal">None</span>, url, username, password)</span><br><span class="line">    auth_handler = HTTPBasicAuthHandler(p)</span><br><span class="line">    opener = build_opener(auth_handler)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = opener.<span class="built_in">open</span>(url)</span><br><span class="line">        html = result.read().decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        print(html)</span><br><span class="line">    <span class="keyword">except</span> URLError <span class="keyword">as</span> e:</span><br><span class="line">        print(e.reason)</span><br></pre></td></tr></table></figure>

<p>首先实例化 HTTPBasicAuthHandler 对象 auth_handler，参数是 HTTPPasswordMgrWithDefaultRealm，利用 add_password 方法添加用户名和密码，这样就建立了一个用来处理验证的 Handler 类</p>
<p>然后将 auth_handler 当作参数传入 build_opener，构建一个 Opener。最后利用 Opener 类中的 Open 方法打开链接，即可完成验证</p>
<h6 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> ProxyHandler, build_opener</span><br><span class="line"><span class="keyword">from</span> urllib.error <span class="keyword">import</span> URLError</span><br><span class="line"></span><br><span class="line">proxy_handler = ProxyHandler(&#123;</span><br><span class="line">    <span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;http://127.0.0.1:8080&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;https&#x27;</span>: <span class="string">&#x27;https://127.0.0.1:8080&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line">opener = build_opener(proxy_handler)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = opener.<span class="built_in">open</span>(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line">    print(response.read().decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"><span class="keyword">except</span> URLError <span class="keyword">as</span> e:</span><br><span class="line">    print(e.reason)</span><br></pre></td></tr></table></figure>

<p>这里事先在本地搭建一个 HTTP 代理，并让其运行在 8080 端口上</p>
<p>ProxyHandler，参数是一个字典，健名是协议类型，键值是代理链接，可以添加多个代理</p>
<p>然后利用这个 Handler 和 build_opener 方法构建一个 Opener，之后发送请求即可</p>
<h6 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h6><ul>
<li>获取网站 Cookie</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> http.cookiejar, urllib.request</span><br><span class="line"></span><br><span class="line">cookie = http.cookiejar.CookieJar()</span><br><span class="line">handler = urllib.request.HTTPCookieProcessor(cookie)</span><br><span class="line">opener = urllib.request.build_opener(handler)</span><br><span class="line">response = opener.<span class="built_in">open</span>(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> cookie:</span><br><span class="line">    print(item.name + <span class="string">&#x27;=&#x27;</span> + item.value)</span><br></pre></td></tr></table></figure>

<ul>
<li>文件格式输出 Cookie</li>
</ul>
<p>Cookie 实际上也是以文本形式保存的</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> http.cookiejar, urllib.request</span><br><span class="line">    </span><br><span class="line">filename = <span class="string">&#x27;cookie.txt&#x27;</span></span><br><span class="line">cookie = http.cookiejar.MozillaCookieJar(filename)</span><br><span class="line">handler = urllib.request.HTTPCookieProcessor(cookie)</span><br><span class="line">opener = urllib.request.build_opener(handler)</span><br><span class="line">response = opener.<span class="built_in">open</span>(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line">cookie.save(ignore_discard=<span class="literal">True</span>, ignore_expires=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>MozillaCookieJar 是 CookieJar 的子类，可以用来处理跟 Cookie 和文件相关的事件，例如读取和保存 Cookie，可以将 Cookie 保存成 Mozilla 型浏览器的 Cookie 格式。运行上面实例后生成一个 cookie.txt 文件</p>
<ul>
<li>LWPCookieJar</li>
</ul>
<p>LWPCookieJar 同样可以读取和保存 Cookie，只是保存格式不一样，会保存成 LWP 格式，改成：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">cookie = http.cookiejar.LWPCookieJar(filename)</span><br></pre></td></tr></table></figure>

<ul>
<li>读取 Cookie</li>
</ul>
<p>LWPCookieJar 为例</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> http.cookiejar, urllib.request</span><br><span class="line">    </span><br><span class="line">cookie = http.cookiejar.LWPCookieJar()</span><br><span class="line">cookie.load(<span class="string">&#x27;cookie.txt&#x27;</span>, ignore_expires=<span class="literal">True</span>, ignore_discard=<span class="literal">True</span>)</span><br><span class="line">handler = urllib.request.HTTPCookieProcessor(cookie)</span><br><span class="line">opener = urllib.request.build_opener(handler)</span><br><span class="line">response = opener.<span class="built_in">open</span>(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line">print(response.read().decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>利用 load 方法读取本地的 Cookie 文件获取 Cookie 内容</p>
<h5 id="处理异常"><a href="#处理异常" class="headerlink" title="处理异常"></a>处理异常</h5><p>urllib 库中的 error 模块定义了由 request 模块产生的异常</p>
<h6 id="URLError"><a href="#URLError" class="headerlink" title="URLError"></a>URLError</h6><p>由 request 模块生成的异常都可以通过捕获这个类来处理，有一个 reason 属性，返回错误的原因</p>
<p>例子：打开一个不存在的页面</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> request,error</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = request.urlopen(<span class="string">&#x27;https://cuiqingcai.com/404&#x27;</span>)</span><br><span class="line"><span class="keyword">except</span> error.URLError <span class="keyword">as</span> e:</span><br><span class="line">    print(e.reason) <span class="comment">#Not Found</span></span><br></pre></td></tr></table></figure>

<h6 id="HTTPError"><a href="#HTTPError" class="headerlink" title="HTTPError"></a>HTTPError</h6><p>URLError 的子类，专门用来处理 HTTP 请求错误，比如认证失败，有3个属性，code，reason，headers</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">except</span> error.HTTPError <span class="keyword">as</span> e:</span><br><span class="line">    print(e.code, e.reason, e.headers, seq=<span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>URLError 是 HTTPError 的父类，所以先捕获子类错误再捕获父类错误，更好写法如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">except</span> error.HTTPError <span class="keyword">as</span> e:</span><br><span class="line">    print(e.code, e.reason, e.headers, seq=<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"><span class="keyword">except</span> error.URLError <span class="keyword">as</span> e:</span><br><span class="line">    print(e.reason)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">&#x27;success&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>reason 返回的不一定是字符串，也可能是一个对象</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> request,error</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">...</span><br><span class="line"><span class="keyword">except</span> error.HTTPError <span class="keyword">as</span> e:</span><br><span class="line">  print(<span class="built_in">type</span>(e.reason)) <span class="comment">#&lt;class&#x27;socket.timeout&#x27;&gt;</span></span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">isinstance</span>(e.reason, socket.timeout): <span class="comment">#通过 isinstance 判断类型</span></span><br><span class="line">    print(<span class="string">&#x27;TIME OUT&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h5 id="解析链接"><a href="#解析链接" class="headerlink" title="解析链接"></a>解析链接</h5><p>urllib 库还提供了 parse 模块，定义了处理 URL 的标准接口，例如实现 URL 各部分的抽取、合并及链接转换</p>
<h6 id="urlparse"><a href="#urlparse" class="headerlink" title="urlparse"></a>urlparse</h6><p>实现 URL 的识别和分段</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse</span><br><span class="line">result = urlparse(<span class="string">&#x27;http://www.baidu.com/index.html;user?id=s#comment&#x27;</span>)</span><br><span class="line">print(<span class="built_in">type</span>(result), result)</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">urllib</span>.<span class="title">parse</span>.<span class="title">ParseResult</span>&#x27;&gt; </span></span><br><span class="line"><span class="class"><span class="title">ParseResult</span>(<span class="params">scheme=<span class="string">&#x27;http&#x27;</span>, netloc=<span class="string">&#x27;www.baidu.com&#x27;</span>, path=<span class="string">&#x27;/index.html&#x27;</span>, params=<span class="string">&#x27;user&#x27;</span>, query=<span class="string">&#x27;id=s&#x27;</span>, fragment=<span class="string">&#x27;comment&#x27;</span></span>)</span></span><br></pre></td></tr></table></figure>

<p>输出结果是 ParseResult 类型，包含 6 个部分，scheme、netloc(域名)、path、params(参数)、query(查询条件)、fragment(锚点，#号后面)</p>
<p>可以用属性名或者索引顺序来获取</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(result.scheme, result[<span class="number">0</span>], result.netloc, result[<span class="number">1</span>], sep=<span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><code>#</code> 后面是锚点，用于直接定位页面内部的下拉位置</p>
<p>urlparse() 有3个参数：urlstring、scheme、allow_fragments</p>
<p>scheme：http或https等 urlstring中不包含 scheme 信息时才生效</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result = urlparse(<span class="string">&#x27;www.baidu.com/index.html;user?id=s#comment&#x27;</span>,scheme=<span class="string">&#x27;https&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>allow_fragments：如果被设置为 false，fragment 部分就会被忽略</p>
<h6 id="urlunparse"><a href="#urlunparse" class="headerlink" title="urlunparse"></a>urlunparse</h6><p>参数是一个可迭代对象，长度必须是6，构造URL</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlunparse</span><br><span class="line">data = [<span class="string">&#x27;http&#x27;</span>,<span class="string">&#x27;www.baidu.com&#x27;</span>,<span class="string">&#x27;index.html&#x27;</span>,<span class="string">&#x27;user&#x27;</span>,<span class="string">&#x27;a=6&#x27;</span>,<span class="string">&#x27;comment&#x27;</span>]</span><br><span class="line">print(urlunparse(data))</span><br><span class="line"><span class="comment">#结果</span></span><br><span class="line">http://www.baidu.com/index.html;user?a=6#comment</span><br><span class="line"><span class="comment">#这里data用了列表类型，也可以用其它类型比如元组或者特定的数据结构</span></span><br></pre></td></tr></table></figure>

<h6 id="urlsplit"><a href="#urlsplit" class="headerlink" title="urlsplit"></a>urlsplit</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlsplit</span><br><span class="line">result = urlsplit(<span class="string">&#x27;http://www.baidu.com/index.html;user?id=s#comment&#x27;</span>)</span><br><span class="line">print(<span class="built_in">type</span>(result), result)</span><br></pre></td></tr></table></figure>

<p>和 urlparse 使用类似，不过不再单独解析 params 部分（params会合并到path中），只返回 5个 结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">urllib</span>.<span class="title">parse</span>.<span class="title">SplitResult</span>&#x27;&gt; <span class="title">SplitResult</span>(<span class="params">scheme=<span class="string">&#x27;http&#x27;</span>, netloc=<span class="string">&#x27;www.baidu.com&#x27;</span>, path=<span class="string">&#x27;/index.html;user&#x27;</span>, query=<span class="string">&#x27;id=s&#x27;</span>, fragment=<span class="string">&#x27;comment&#x27;</span></span>)</span></span><br></pre></td></tr></table></figure>

<h6 id="urlunsplit"><a href="#urlunsplit" class="headerlink" title="urlunsplit"></a>urlunsplit</h6><p>将链接各个部分组合成完成链接，传入参数是一个可迭代对象，如列表、元组，长度必须是5</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlunsplit</span><br><span class="line">data = [<span class="string">&#x27;http&#x27;</span>,<span class="string">&#x27;www.baidu.com&#x27;</span>,<span class="string">&#x27;index.html&#x27;</span>,<span class="string">&#x27;a=6&#x27;</span>,<span class="string">&#x27;comment&#x27;</span>]</span><br><span class="line">print(urlunsplit(data))</span><br><span class="line"><span class="comment">#http://www.baidu.com/index.html?a=6#comment</span></span><br></pre></td></tr></table></figure>



<h6 id="urljoin"><a href="#urljoin" class="headerlink" title="urljoin"></a>urljoin</h6><p>urlunparse 和 urlunsplit 我们可以完成链接的合并，不过必须有特定的长度，链接的每一部分都要清晰的分开</p>
<p>生成链接还有个方法 urljoin() 方法</p>
<p>可以提供一个 base_url 基础链接作为第一个参数，将新的链接作为第二个参数</p>
<p>该方法会分析 base_url 的 scheme、netloc、和path 这3个内容对新链接缺失的部分进行补充</p>
<p>实现连接拼合与生成</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urljoin</span><br><span class="line"></span><br><span class="line">print(urljoin(<span class="string">&#x27;http://www.baidu.com&#x27;</span>, <span class="string">&#x27;FAQ.html&#x27;</span>))</span><br><span class="line">print(urljoin(<span class="string">&#x27;http://www.baidu.com&#x27;</span>, <span class="string">&#x27;https://cuiqingcai.com/FAQ.html&#x27;</span>))</span><br><span class="line">print(urljoin(<span class="string">&#x27;http://www.baidu.com/about.html&#x27;</span>, <span class="string">&#x27;https://cuiqingcai.com/FAQ.html&#x27;</span>))</span><br><span class="line">print(urljoin(<span class="string">&#x27;http://www.baidu.com/about.html&#x27;</span>, <span class="string">&#x27;https://cuiqingcai.com/FAQ.html?question=2&#x27;</span>))</span><br><span class="line">print(urljoin(<span class="string">&#x27;http://www.baidu.com?wd=abc&#x27;</span>, <span class="string">&#x27;https://cuiqingcai.com/index.php&#x27;</span>))</span><br><span class="line">print(urljoin(<span class="string">&#x27;http://www.baidu.com&#x27;</span>, <span class="string">&#x27;?category=2#comment&#x27;</span>))</span><br><span class="line">print(urljoin(<span class="string">&#x27;www.baidu.com&#x27;</span>, <span class="string">&#x27;?category=2#comment&#x27;</span>))</span><br><span class="line">print(urljoin(<span class="string">&#x27;www.baidu.com#comment&#x27;</span>, <span class="string">&#x27;?category=2&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http://www.baidu.com/FAQ.html</span><br><span class="line">https://cuiqingcai.com/FAQ.html</span><br><span class="line">https://cuiqingcai.com/FAQ.html</span><br><span class="line">https://cuiqingcai.com/FAQ.html?question=2</span><br><span class="line">https://cuiqingcai.com/index.php</span><br><span class="line">http://www.baidu.com?category=2#comment</span><br><span class="line">www.baidu.com?category=2#comment</span><br><span class="line">www.baidu.com?category=2</span><br></pre></td></tr></table></figure>

<p>base_url 提供了三项内容 scheme、netloc、path</p>
<p>如果3项在新链接不存在就补充，新链接存在就使用新链接部分，base_url 里的就不起作用了，以右边新链接为准</p>
<h6 id="urlencode"><a href="#urlencode" class="headerlink" title="urlencode"></a>urlencode</h6><p>将字典序列化为 GET 请求参数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlencode</span><br><span class="line">params = &#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;germey&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;age&#x27;</span>: <span class="number">22</span></span><br><span class="line">&#125;</span><br><span class="line">base_url = <span class="string">&#x27;http://www.baidu.com?&#x27;</span></span><br><span class="line">url = base_url + urlencode(params)</span><br><span class="line">print(url)</span><br></pre></td></tr></table></figure>

<h6 id="parse-qs"><a href="#parse-qs" class="headerlink" title="parse_qs"></a>parse_qs</h6><p>将请求参数反序列化成字典类型</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> parse_qs</span><br><span class="line">query = <span class="string">&#x27;name=germey&amp;age=22&#x27;</span></span><br><span class="line">print(parse_qs(query))</span><br><span class="line"><span class="comment">#结果 &#123;&#x27;name&#x27;:[&#x27;germey&#x27;],&#x27;age&#x27;:[&#x27;22&#x27;]&#125;</span></span><br></pre></td></tr></table></figure>



<h6 id="parse-sql"><a href="#parse-sql" class="headerlink" title="parse_sql"></a>parse_sql</h6><p>将参数转化成元组组成的列表</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> parse_qsl</span><br><span class="line">query = <span class="string">&#x27;name=germey&amp;age=2&#x27;</span></span><br><span class="line">print(parse_qsl(query))</span><br><span class="line"><span class="comment">#结果 [(&#x27;name&#x27;, &#x27;germey&#x27;), (&#x27;age&#x27;, &#x27;2&#x27;)]</span></span><br></pre></td></tr></table></figure>

<h6 id="quote"><a href="#quote" class="headerlink" title="quote"></a>quote</h6><p>将内容转化为 URL 编码格式，URL 中带中文参数时，可能导致乱码问题，用这个可以将中文字符转化为 URL 编码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line">keyword = <span class="string">&#x27;测试&#x27;</span></span><br><span class="line">url = <span class="string">&#x27;https://baidu.com/s?wd=&#x27;</span> + quote(keyword)</span><br><span class="line"><span class="comment">#结果：https://baidu.com/s?wd=%E5%joj</span></span><br></pre></td></tr></table></figure>

<h6 id="unquote"><a href="#unquote" class="headerlink" title="unquote"></a>unquote</h6><p>可以进行 URL 解码，将编码后的结果进行解码</p>
<h5 id="分析-Robots-协议"><a href="#分析-Robots-协议" class="headerlink" title="分析 Robots 协议"></a>分析 Robots 协议</h5><p>urllib 的 robotparser 模块，可以实现网站 Robots 协议的分析</p>
<h6 id="Robots-协议"><a href="#Robots-协议" class="headerlink" title="Robots 协议"></a>Robots 协议</h6><p>爬虫协议，全名叫网络爬虫排除标准，告诉爬虫和搜索引擎哪些页面可以抓取不抓取，通常是一个 robots.txt 协议，一般放在网站根目录下，样例</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Uaser-agent: *</span><br><span class="line">Disallow: &#x2F;   </span><br><span class="line">Allow: &#x2F;public&#x2F;</span><br></pre></td></tr></table></figure>

<p>这限定了所有搜索爬虫只能爬取 public 目录，User-agent 描述了爬虫的名称，设置为 * 代表 Robots 协议对所有爬虫都有效</p>
<p>User-agent: Baiduspider 代表设置的规则对百度是有效的，如果有多条User-agent记录，则意味着多个爬虫会受到限制</p>
<p>Disallow: /   代表不允许爬取所有页面</p>
<h6 id="robotparser"><a href="#robotparser" class="headerlink" title="robotparser"></a>robotparser</h6><p>了解 Robots 协议之后，就可以使用 robotparse 模块来解析 robots.txt 了，该模块提供了一个类 RobotFileParse，它可以根据某网站的 robots.txt 文件来判断一个爬虫是否有权限来爬取这个网页</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.robotparser <span class="keyword">import</span> RobotFileParser</span><br><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen</span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"></span><br><span class="line">ssl._create_default_https_context = ssl._create_unverified_context</span><br><span class="line">rp = RobotFileParser()</span><br><span class="line">rp.set_url(<span class="string">&#x27;https://www.jianshu.com/robots.txt&#x27;</span>)</span><br><span class="line">rp.read()</span><br><span class="line"><span class="comment">#判断网页是否可以被抓取</span></span><br><span class="line">print(rp.can_fetch(<span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;https://www.jianshu.com/p/823596514412&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>常用几个方法：</p>
<p>set_url()：设置 robots.txt 文件的链接</p>
<p>read()：读取 robots.txt 文件并进行分析，不会返回任何内容，但执行了读取操作</p>
<p>parse()：用来解析 robots.txt 文件，传入的参数是 robots.txt 某些行的内容</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">rp.parse(urlopen(<span class="string">&#x27;https://www.baidu.com/rotots.txt&#x27;</span>).read().decode(<span class="string">&#x27;utf-8&#x27;</span>).split(<span class="string">&#x27;\n&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>can_fetch()：两个参数，第一个 User-agent，第二个要抓取的URL，返回该搜索引擎是否可以抓取这个URL</p>
<p>mtime()：返回上次抓取和分析 robots.txt 时间</p>
<h4 id="使用-Request"><a href="#使用-Request" class="headerlink" title="使用 Request"></a>使用 Request</h4><p>urllib POST、PUT 等请求时的写法不太方便，处理网页验证和 Cookie 时需写 Opener 和 Handler 类来处理</p>
<h5 id="GET-请求"><a href="#GET-请求" class="headerlink" title="GET 请求"></a>GET 请求</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">r = requests.get(<span class="string">&#x27;https://www.baidu.com/&#x27;</span>)</span><br><span class="line">print(<span class="built_in">type</span>(r))</span><br><span class="line">print(r.status_code)</span><br><span class="line">print(<span class="built_in">type</span>(r.text))</span><br><span class="line">print(r.text)</span><br><span class="line">print(r.cookies)</span><br></pre></td></tr></table></figure>

<p>调用 get() 方法实现与 urlopen 相同的操作，得到一个 Response 对象</p>
<h6 id="GET带参数"><a href="#GET带参数" class="headerlink" title="GET带参数"></a>GET带参数</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span>  requests</span><br><span class="line">params = &#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;germey&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;age&#x27;</span>: <span class="number">22</span></span><br><span class="line">&#125;</span><br><span class="line">r = requests.get(<span class="string">&#x27;http://httpbin.org/get&#x27;</span>, params=params)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure>

<p>网页的返回类型实际上是 str 类型，是JSON格式的，如果想得到J SON 格式数据</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(r.json())</span><br></pre></td></tr></table></figure>

<p>如果返回结果不是 JSON 格式，会出现解析错误，抛出 json.decoder.JSONDecodeError 异常</p>
<h6 id="获取二进制数据"><a href="#获取二进制数据" class="headerlink" title="获取二进制数据"></a>获取二进制数据</h6><p>图片、音频、视频这些文件本质上都是二进制码组成</p>
<p>提取图片保存下来</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">r = requests.get(<span class="string">&#x27;https://github.com/favicon.ico&#x27;</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;vavicon.ico&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f: <span class="comment">#wb写入</span></span><br><span class="line">    f.write(r.content)</span><br><span class="line"><span class="comment">#调用了open方法，第一个参数文件名，第二个参数代表以二进制写的形式打开，可以向文件写入二进制数据</span></span><br></pre></td></tr></table></figure>

<h5 id="POST-请求"><a href="#POST-请求" class="headerlink" title="POST 请求"></a>POST 请求</h5><p>request.post(…)</p>
<h5 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">files = &#123;<span class="string">&#x27;file&#x27;</span>: <span class="built_in">open</span>(<span class="string">&#x27;favicon.ico&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>)&#125; <span class="comment">#rb读取</span></span><br><span class="line">r = requests.post(<span class="string">&#x27;https://httpbin.org/post&#x27;</span>, files=files)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure>

<h5 id="Cookies"><a href="#Cookies" class="headerlink" title="Cookies"></a>Cookies</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">r = requests.get(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line">print(r.cookies)<span class="comment">#RequestsCookieJar</span></span><br><span class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> r.cookies.items():</span><br><span class="line">    print(key+<span class="string">&#x27;=&#x27;</span>+value)</span><br></pre></td></tr></table></figure>

<p>模拟Cookies，放 headers里面</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">headers = &#123;</span><br><span class="line">	<span class="string">&#x27;Cookie&#x27;</span>: <span class="string">&#x27;xxx&#x27;</span></span><br><span class="line">  <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;xxx&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">r = request.get(<span class="string">&#x27;https://xxxx&#x27;</span>, headers=headers)</span><br></pre></td></tr></table></figure>

<p>也可以通过 cookies 参数来设置，不过需要构建 RequestsCookieJar对象，然后复制下来的 cookies 利用 split 方法分割，再利用 set 方法设置好每个 Cookie 的 key 和 value</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">cookies = <span class="string">&#x27;xxx;xxx;xxx;&#x27;</span></span><br><span class="line">jar = requests.cookies.RequestsCookieJar()</span><br><span class="line"><span class="keyword">for</span> cookies <span class="keyword">in</span> cookies.split(<span class="string">&#x27;;&#x27;</span>):</span><br><span class="line">  key, value = cookie.split(<span class="string">&#x27;=&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">  jar.<span class="built_in">set</span>(key, value)</span><br><span class="line">r = request.get(<span class="string">&#x27;https://xxxx&#x27;</span>, cookies=jar)</span><br></pre></td></tr></table></figure>



<h5 id="会话维持"><a href="#会话维持" class="headerlink" title="会话维持"></a>会话维持</h5><p>方便维持一个会话，不用担心 cookies 问题</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">requests.get(<span class="string">&#x27;http://httpbin.org/cookies/set/number/123456&#x27;</span>)<span class="comment">#请求这个网址时可以设置一个cookie</span></span><br><span class="line">r = requests.get(<span class="string">&#x27;http://httpbin.org/cookies&#x27;</span>)</span><br><span class="line">print(r.text)</span><br><span class="line"><span class="comment">#结果&#123;&quot;cookies&quot;: &#123;&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>上面是两个不相关的会话，第一个设置了 cookies，第二个 cookies 为空</p>
<p>使用 session</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">s = requests.session()</span><br><span class="line">s.get(<span class="string">&#x27;http://httpbin.org/cookies/set/number/123456&#x27;</span>)</span><br><span class="line">r = s.get(<span class="string">&#x27;http://httpbin.org/cookies&#x27;</span>)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure>

<p>成功获取，两个请求在同一会话，不用担心 cookies 问题</p>
<p>通常用于模拟登录成功之后再进行下一步的操作</p>
<h5 id="SSL-证书验证"><a href="#SSL-证书验证" class="headerlink" title="SSL 证书验证"></a>SSL 证书验证</h5><p>请求一个 HTTPS 站点，但证书验证错误的页面，会报 SSLError 错误，如何避免这个错误？</p>
<p>request 提供了证书验证的功能，使用 verify 参数控制是否检查证书</p>
<p>将 verify 参数设置为 False 即可</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">response = requests.get(<span class="string">&#x27;https://www.12306.cn&#x27;</span>, verify=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>不过会报警告，建议我们指定证书，可以设置忽略警告的方式屏蔽警告</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> request.packages <span class="keyword">import</span> urllib3</span><br><span class="line">urllib3.disable.warnings()</span><br><span class="line">response = requests.get(<span class="string">&#x27;https://www.12306.cn&#x27;</span>, verify=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>或者捕获警告到日志方式忽略警告</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">logging.captureWarning(<span class="literal">True</span>)</span><br><span class="line">response = requests.get(<span class="string">&#x27;https://www.12306.cn&#x27;</span>, verify=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>当然也可以指定本地证书用作客户端证书，这可以是单个文件（包含秘钥和证书）或一个包含两个文件路径的元组</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">response = requests.get(<span class="string">&#x27;https://www.12306.cn&#x27;</span>, cert=(<span class="string">&#x27;/path/server.crt&#x27;</span>, <span class="string">&#x27;/path/key&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>上面的例子，我们需要有 crt 和 key 文件，且指定路径。本地私有证书的key必须是解密状态</p>
<h5 id="身份认证"><a href="#身份认证" class="headerlink" title="身份认证"></a>身份认证</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> requests.auth <span class="keyword">import</span> HTTPBasicAuth</span><br><span class="line"></span><br><span class="line">r = requests.get(<span class="string">&#x27;https://ssr3.scrape.center&#x27;</span>, auth=HTPBasicAuth(<span class="string">&#x27;admin&#x27;</span>,<span class="string">&#x27;admin&#x27;</span>))</span><br><span class="line">print(r.status_code)</span><br></pre></td></tr></table></figure>

<p>更简单写法，直接传元组，会默认使用 HTPBasicAuth 类来认证</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">r = requests.get(<span class="string">&#x27;https://ssr3.scrape.center&#x27;</span>, auth=(<span class="string">&#x27;admin&#x27;</span>,<span class="string">&#x27;admin&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>requests 库还提供了其他认证方式，如 OAuth 认证，需要安装 oauth 包</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install requests_oauthlib</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> requests_oauthlib <span class="keyword">import</span> OAuth1</span><br><span class="line">url = <span class="string">&#x27;xxxx&#x27;</span></span><br><span class="line">auth = OAuth1(<span class="string">&#x27;YOUR_APP_KEY&#x27;</span>,<span class="string">&#x27;YOUR_APP_SECRET&#x27;</span>,<span class="string">&#x27;USER_OAUTH_TOKEN&#x27;</span>,<span class="string">&#x27;USER_OAUTH_TOKEN_SECRET&#x27;</span>)</span><br><span class="line">requests.get(url, auth=auth)</span><br></pre></td></tr></table></figure>



<h5 id="代理设置"><a href="#代理设置" class="headerlink" title="代理设置"></a>代理设置</h5><p>某些网站测试请求几次能正常获取，一旦大规模爬取，网站可能会弹出验证码或跳转登录页面内</p>
<p>用代理来解决这个问题，就要用到 proxies 参数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">proxies = &#123;</span><br><span class="line">  <span class="string">&quot;http&quot;</span>: <span class="string">&quot;http://10.10.1.10:3128&quot;</span>,</span><br><span class="line">  <span class="string">&quot;http&quot;</span>: <span class="string">&quot;http://10.10.1.10:1080&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line">request.get(<span class="string">&quot;https://www.taobao.com&quot;</span>, proxiex=proxies)</span><br></pre></td></tr></table></figure>

<p>若代理需要使用 HTTP Basic Auth，可以使用类似 <a href="http://user:pasword@host:port">http://user:pasword@host:port</a> 这样的语法来设置</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">proxiex = &#123;</span><br><span class="line">	<span class="string">&quot;http&quot;</span>: <span class="string">&quot;http://user:password@10.10.1.10:3128&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除了 HTTP 代理外，request 还支持 SOCKS 协议的代理</p>
<p>需要安装 socks 这个库</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pip3 install <span class="string">&#x27;requests[socks]&#x27;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">proxies = &#123;</span><br><span class="line">  <span class="string">&quot;http&quot;</span>: <span class="string">&quot;socks5://user:password@host:port&quot;</span>,</span><br><span class="line">  <span class="string">&quot;http&quot;</span>: <span class="string">&quot;socks5://user:password@host:port&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line">request.get(<span class="string">&quot;https://www.httpbin.org/get&quot;</span>, proxiex=proxies)</span><br></pre></td></tr></table></figure>



<h5 id="Prepared-Request"><a href="#Prepared-Request" class="headerlink" title="Prepared Request"></a>Prepared Request</h5><p>介绍 urllib 时，可以将请求表示为数据结构，各个参数通过一个 Request 对象来表示。这里 requests 也可以做到，这个数据结构叫 Prepared Request</p>
<p>有了 Request 这个对象，就可以将请求当作独立的对象来看待，这样在队列调度时会非常方便</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> requests.sessions <span class="keyword">import</span> Session</span><br><span class="line">s = Session()</span><br><span class="line">r = requests.get(<span class="string">&#x27;http://xxx&#x27;</span>)</span><br><span class="line">prepped = s.prepare_request(r)</span><br><span class="line">r = s.send(prepped)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure>

<p>调用 Session 的 prepare_request 方法将其转换为一个 Prepared Request 对象，然后调用 send 方法发送即可</p>
<h4 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h4><p>正则表达式测试工具 <a href="http://tool.oschina.net/regex/">http://tool.oschina.net/regex/</a></p>
<h4 id="httpx"><a href="#httpx" class="headerlink" title="httpx"></a>httpx</h4><p>urllib 和 requests 仅支持 HTTP/1.1，不支持 HTTP/2.0，hyper 和 httpx 支持</p>
<p>案例：<a href="https://spa16.scrape.center/">https://spa16.scrape.center/</a> 是强制使用 HTTP/2.0 访问的一个网站，浏览器打开查看 Network 面板，看到 Protocol 一列都是 h2</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install &#39;httpx[http2]&#39; #即安装了httpx 又安装了httpx对HTTP&#x2F;2.0的支持</span><br></pre></td></tr></table></figure>

<p>httpx  和 requests 的很多 API 存在相似之处</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> httpx</span><br><span class="line">response = httpx.get(<span class="string">&#x27;https://www.httpbin.org/get&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>httpx 默认是不会开启对 HTTP/2.0 的支持的，需要手动声明一下才能使用 HTTP/2.0 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> httpx</span><br><span class="line">client = httpx.Client(http2=<span class="literal">True</span>)</span><br><span class="line">response = client.get(<span class="string">&#x27;https://spa16.scrape.center/&#x27;</span>)</span><br><span class="line">print(response.text)</span><br></pre></td></tr></table></figure>

<h5 id="Client-对象"><a href="#Client-对象" class="headerlink" title="Client 对象"></a>Client 对象</h5><p>推荐使用方式是 with as 语句</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> httpx</span><br><span class="line"><span class="keyword">with</span> httpx.Client() <span class="keyword">as</span> client:</span><br><span class="line">  response = client.get(<span class="string">&#x27;https://www.httpbin.org/get&#x27;</span>)</span><br><span class="line">  print(response)</span><br></pre></td></tr></table></figure>

<p>等价于</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">client = httpx.Client()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">	response = client.get(<span class="string">&#x27;https://www.httpbin.org/get&#x27;</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">  client.close()</span><br></pre></td></tr></table></figure>

<p>声明 Client 对象时，可以额外指定一些参数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">headers = &#123;<span class="string">&#x27;User-Agent&#x27;</span>:<span class="string">&#x27;my-app/0.0.1&#x27;</span>&#125;</span><br><span class="line">client = httpx.Client(headers=headers)</span><br></pre></td></tr></table></figure>

<h5 id="支持异步请求"><a href="#支持异步请求" class="headerlink" title="支持异步请求"></a>支持异步请求</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> httpx</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">fetch</span>(<span class="params">url</span>):</span></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">with</span> httpx.AsyncClient(http2=<span class="literal">True</span>) <span class="keyword">as</span> client:</span><br><span class="line">    response = <span class="keyword">await</span> client.get(url)</span><br><span class="line">    print(response.text)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  asyncio.get_event_loop().run_until_complete(fetch(<span class="string">&#x27;https://www.httpbin.org/get&#x27;</span>))</span><br></pre></td></tr></table></figure>



<h4 id="爬虫案例"><a href="#爬虫案例" class="headerlink" title="爬虫案例"></a>爬虫案例</h4><p>案例链接 <a href="https://ssr1.scrape.center/">https://ssr1.scrape.center/</a></p>
<h5 id="多进程加速"><a href="#多进程加速" class="headerlink" title="多进程加速"></a>多进程加速</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">page</span>):</span></span><br><span class="line">  index_html = scrape_index(page)</span><br><span class="line">  deatail_urls = parse_index(index_html)</span><br><span class="line">  <span class="keyword">for</span> detail_url <span class="keyword">in</span> detail_urls:</span><br><span class="line">    detail_html = scrape_detail(detail_html)</span><br><span class="line">    data = parse_detail(detail_html)</span><br><span class="line">    logging.info(<span class="string">&#x27;get detail data %s&#x27;</span>, data)</span><br><span class="line">    logging.info(<span class="string">&#x27;saving data to json data&#x27;</span>)</span><br><span class="line">    save_data(data)</span><br><span class="line">    logging.info(<span class="string">&#x27;data save success&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  pool = multiprocessing.Pool()</span><br><span class="line">  pages = <span class="built_in">range</span>(<span class="number">1</span>, TOTAL_PAGE+<span class="number">1</span>)</span><br><span class="line">  pool.<span class="built_in">map</span>(main, pages)</span><br><span class="line">  pool.close()</span><br><span class="line">  pool.join()</span><br></pre></td></tr></table></figure>

<p>声明进程池，调用 map 方法，第一个参数就是要调用的方法，第二个参数是需要遍历的页码</p>
<p>这样会依次遍历 pages 中的内容，把 1-10 这个10个页码分别传递给 main 方法，并把每次调用分别变成一个进程，加入进程池中，进程池会根据当前运行环境来决定运行多少个进程</p>
<h4 id="抓取猫眼电影排行"><a href="#抓取猫眼电影排行" class="headerlink" title="抓取猫眼电影排行"></a>抓取猫眼电影排行</h4><p>(爬不了了有滑块验证)</p>
<p>书本配套代码 <a href="https://github.com/Python3WebSpider/MaoYan">https://github.com/Python3WebSpider/MaoYan</a></p>
<p>排行链接  <a href="https://maoyan.com/board/4">https://maoyan.com/board/4</a></p>
<p>第二页链接  <a href="https://maoyan.com/board/4?offset=10">https://maoyan.com/board/4?offset=10</a></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> requests.exceptions <span class="keyword">import</span> RequestException</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_one_page</span>(<span class="params">url</span>):</span></span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		headers = &#123;</span><br><span class="line">			<span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10_6_10; en-us) AppleWebKit/534.50 (KHTML, like Gecko) Version/5.1 Safari/534.50&#x27;</span></span><br><span class="line">		&#125;</span><br><span class="line">		response = requests.get(url, headers=headers)</span><br><span class="line">		<span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">			<span class="keyword">return</span> response.text</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">	<span class="keyword">except</span> RequestException:</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	url = <span class="string">&#x27;https://maoyan.com/board/4&#x27;</span></span><br><span class="line">	html = get_one_page(url)</span><br><span class="line">	print(html)</span><br></pre></td></tr></table></figure>

<p>可以通过浏览器查看源码，选择网络查看原始请求部分</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dd</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;board-index board-index-1&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/films/1200486&quot;</span> <span class="attr">title</span>=<span class="string">&quot;我不是药神&quot;</span> <span class="attr">class</span>=<span class="string">&quot;image-link&quot;</span> <span class="attr">data-act</span>=<span class="string">&quot;boarditem-click&quot;</span> <span class="attr">data-val</span>=<span class="string">&quot;&#123;movieId:1200486&#125;&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;//s3plus.meituan.net/v1/mss_e2821d7f0cfe4ac1bf9202ecf9590e67/cdn-prod/file:5788b470/image/loading_2.e3d934bf.png&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;poster-default&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">img</span> <span class="attr">data-src</span>=<span class="string">&quot;https://p0.meituan.net/movie/414176cfa3fea8bed9b579e9f42766b9686649.jpg@160w_220h_1e_1c&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;我不是药神&quot;</span> <span class="attr">class</span>=<span class="string">&quot;board-img&quot;</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;board-item-main&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;board-item-content&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;movie-item-info&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;name&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/films/1200486&quot;</span> <span class="attr">title</span>=<span class="string">&quot;我不是药神&quot;</span> <span class="attr">data-act</span>=<span class="string">&quot;boarditem-click&quot;</span> <span class="attr">data-val</span>=<span class="string">&quot;&#123;movieId:1200486&#125;&quot;</span>&gt;</span>我不是药神<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;star&quot;</span>&gt;</span>主演：徐峥,周一围,王传君<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;releasetime&quot;</span>&gt;</span>上映时间：2018-07-05<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">		  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;movie-item-number score-num&quot;</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;score&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;integer&quot;</span>&gt;</span>9.<span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fraction&quot;</span>&gt;</span>6<span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span>        </span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dd</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>一部电影信息对应源码是一个 dd 节点</p>
<p>先获取排行信息，在 class 为 board-index 的 i 节点内，提取 i 节点内的信息</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;dd&gt;.*?board-index.*?&gt;(.*?)&lt;/i&gt;</span><br></pre></td></tr></table></figure>

<p>图片信息：dd 后面有个 a 节点，内部有两个 img 节点，第二个 img 节点的 data-src 属性是图片的链接，提取第二个 img 节点 data-sr 属性</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;dd&gt;.*?board-index.*?&gt;(.*?)&lt;/i&gt;.*?data-src=&quot;(.*?)&quot;</span><br></pre></td></tr></table></figure>

<p>电影名称：后面 p 节点内， class 为 name</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;dd&gt;.*?board-index.*?&gt;(.*?)&lt;/i&gt;.*?data-src=&quot;(.*?)&quot;.*?name.*?&gt;(.*?)&lt;/a&gt;</span><br></pre></td></tr></table></figure>

<p>findall 提取</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pattern = re.<span class="built_in">compile</span>(<span class="string">&#x27;&lt;dd&gt;.*?board-index.*?&gt;(.*?)&lt;/i&gt;.*?data-src=&quot;(.*?)&quot;.*?name.*?&gt;(.*?)&lt;/a&gt;&#x27;</span>, re.S)</span><br><span class="line">items = re.findall(pattern, html)</span><br><span class="line">print(items)</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[(<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;https://p0.meituan.net/movie/414176cfa3fea8bed9b579e9f42766b9686649.jpg@160w_220h_1e_1c&#x27;</span>, <span class="string">&#x27;&lt;a href=&quot;/films/1200486&quot; title=&quot;我不是药神&quot; data-act=&quot;boarditem-click&quot; data-val=&quot;&#123;movieId:1200486&#125;&quot;&gt;我不是药神&#x27;</span>), (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;https://p0.meituan.net/movie/8112a8345d7f1d807d026282f2371008602126.jpg@160w_220h_1e_1c&#x27;</span>, <span class="string">&#x27;&lt;a href=&quot;/films/1297&quot; title=&quot;肖申克的救赎&quot; data-act=&quot;boarditem-click&quot; data-val=&quot;&#123;movieId:1297&#125;&quot;&gt;肖申克的救赎&#x27;</span>), (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;https://p1.meituan.net/movie/c9b280de01549fcb71913edec05880585769972.jpg@160w_220h_1e_1c&#x27;</span>, <span class="string">&#x27;&lt;a href=&quot;/films/1206605&quot; title=&quot;绿皮书&quot; data-act=&quot;boarditem-click&quot; data-val=&quot;&#123;movieId:1206605&#125;&quot;&gt;绿皮书&#x27;</span>), (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;https://p0.meituan.net/movie/609e45bd40346eb8b927381be8fb27a61760914.jpg@160w_220h_1e_1c&#x27;</span>, <span class="string">&#x27;&lt;a href=&quot;/films/1292&quot; title=&quot;海上钢琴师&quot; data-act=&quot;boarditem-click&quot; data-val=&quot;&#123;movieId:1292&#125;&quot;&gt;海上钢琴师&#x27;</span>), (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;https://p1.meituan.net/movie/ac8f0004928fbce5a038a007b7c73cec746794.jpg@160w_220h_1e_1c&#x27;</span>, <span class="string">&#x27;&lt;a href=&quot;/films/1216365&quot; title=&quot;小偷家族&quot; data-act=&quot;boarditem-click&quot; data-val=&quot;&#123;movieId:1216365&#125;&quot;&gt;小偷家族&#x27;</span>), (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;https://p0.meituan.net/movie/61fea77024f83b3700603f6af93bf690585789.jpg@160w_220h_1e_1c&#x27;</span>, <span class="string">&#x27;&lt;a href=&quot;/films/1203&quot; title=&quot;霸王别姬&quot; data-act=&quot;boarditem-click&quot; data-val=&quot;&#123;movieId:1203&#125;&quot;&gt;霸王别姬&#x27;</span>), (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;https://p0.meituan.net/movie/005955214d5b3e50c910d7a511b0cb571445301.jpg@160w_220h_1e_1c&#x27;</span>, <span class="string">&#x27;&lt;a href=&quot;/films/1211270&quot; title=&quot;哪吒之魔童降世&quot; data-act=&quot;boarditem-click&quot; data-val=&quot;&#123;movieId:1211270&#125;&quot;&gt;哪吒之魔童降世&#x27;</span>), (<span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;https://p1.meituan.net/movie/580d81a2c78bf204f45323ddb4244b6c6821175.jpg@160w_220h_1e_1c&#x27;</span>, <span class="string">&#x27;&lt;a href=&quot;/films/1303&quot; title=&quot;美丽人生&quot; data-act=&quot;boarditem-click&quot; data-val=&quot;&#123;movieId:1303&#125;&quot;&gt;美丽人生&#x27;</span>), (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;https://p1.meituan.net/movie/6bea9af4524dfbd0b668eaa7e187c3df767253.jpg@160w_220h_1e_1c&#x27;</span>, <span class="string">&#x27;&lt;a href=&quot;/films/4055&quot; title=&quot;这个杀手不太冷&quot; data-act=&quot;boarditem-click&quot; data-val=&quot;&#123;movieId:4055&#125;&quot;&gt;这个杀手不太冷&#x27;</span>), (<span class="string">&#x27;10&#x27;</span>, <span class="string">&#x27;https://p0.meituan.net/moviemachine/c2496a7290a72eac6081321898c347693550574.jpg@160w_220h_1e_1c&#x27;</span>, <span class="string">&#x27;&lt;a href=&quot;/films/416&quot; title=&quot;盗梦空间&quot; data-act=&quot;boarditem-click&quot; data-val=&quot;&#123;movieId:416&#125;&quot;&gt;盗梦空间&#x27;</span>)]</span><br></pre></td></tr></table></figure>

<p>写入文件</p>
<p>通过 JSON库的 dumps() 方法实现字典的序列化，ensure_ascii 为 False，保证输出结果是中文形式而不是 Unicode 编码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_to_file</span>(<span class="params">content</span>):</span></span><br><span class="line">	<span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;result.txt&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f: <span class="comment">#a appending追加写入</span></span><br><span class="line">		print(<span class="built_in">type</span>(json.dumps(content)))</span><br><span class="line">		f.write(json.dumps(content, ensure_ascii=<span class="literal">False</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>分页爬取：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">offset</span>):</span></span><br><span class="line">	url = <span class="string">&#x27;https://maoyan.com/board/4?offset=&#x27;</span> + <span class="built_in">str</span>(offset) </span><br><span class="line">	html = get_one_page(url)</span><br><span class="line">	pattern = re.<span class="built_in">compile</span>(<span class="string">&#x27;&lt;dd&gt;.*?board-index.*?&gt;(.*?)&lt;/i&gt;.*?data-src=&quot;(.*?)&quot;.*?name.*?&gt;(.*?)&lt;/a&gt;&#x27;</span>, re.S)</span><br><span class="line">	items = re.findall(pattern, html)</span><br><span class="line">	print(items)</span><br><span class="line">	write_to_file(items)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">		main(offset=i*<span class="number">10</span>)</span><br><span class="line">		time.sleep(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<h4 id=""><a href="#" class="headerlink" title=""></a></h4>]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Python3网络爬虫开发实战-3解析库使用</title>
    <url>/2022/04/11/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-3%E8%A7%A3%E6%9E%90%E5%BA%93%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<h4 id="3-解析库使用"><a href="#3-解析库使用" class="headerlink" title="3. 解析库使用"></a>3. 解析库使用</h4><h4 id="XPath"><a href="#XPath" class="headerlink" title="XPath"></a>XPath</h4><p>更多XPath用法 <a href="http://www.w3school.com.cn/xpath/index.asp">http://www.w3school.com.cn/xpath/index.asp</a></p>
<p>XML 路径语言</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install lxml</span><br></pre></td></tr></table></figure>



<ul>
<li>常用规则</li>
</ul>
<table>
<thead>
<tr>
<th>表达式</th>
<th align="left">选取此节点的所有子节点</th>
</tr>
</thead>
<tbody><tr>
<td>/</td>
<td align="left">从当前节点选取直接子节点</td>
</tr>
<tr>
<td>//</td>
<td align="left">从当前节点选取子孙节点</td>
</tr>
<tr>
<td>.</td>
<td align="left">选取当前节点</td>
</tr>
<tr>
<td>..</td>
<td align="left">选取当前节点的父节点</td>
</tr>
<tr>
<td>@</td>
<td align="left">选取属性</td>
</tr>
<tr>
<td>nodename</td>
<td align="left">选取此节点的所有子节点</td>
</tr>
</tbody></table>
<p>例如：所有名称为 title，同时属性 lang 的值为 eng 的节点</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;title[@lang&#x3D;&#39;eng&#39;]</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line">text = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;div&gt;</span></span><br><span class="line"><span class="string">  &lt;ul&gt;</span></span><br><span class="line"><span class="string">    &lt;li class=&quot;item-0&quot;&gt;&lt;a href=&quot;link1.html&quot;&gt;first item&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">    &lt;li class=&quot;item-1&quot;&gt;&lt;a href=&quot;link2.html&quot;&gt;second item&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">    &lt;li class=&quot;item-inactive&quot;&gt;&lt;a href=&quot;link3.html&quot;&gt;third item&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">    &lt;li class=&quot;item-1&quot;&gt;&lt;a href=&quot;link4.html&quot;&gt;fourth item&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">    &lt;li class=&quot;item-0&quot;&gt;&lt;a href=&quot;link5.html&quot;&gt;fifth item&lt;/a&gt;</span></span><br><span class="line"><span class="string">  &lt;/ul&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">html = etree.HTML(text)</span><br><span class="line">result = etree.tostring(html) <span class="comment"># type: bytes</span></span><br><span class="line">print(result.decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>导入 lxml 库的 etree 模块，声明一段 HTML 文本，调用 HTML 类进行初始化，这样就成功构造了一个 XPath 解析对象</p>
<p>HTML 文件最后一个 li 节点是没有闭合的，但 etree 模块可以自动修正 HTML 文本，处理后 li 节点被补全，还自动添加了 body、html 节点</p>
<p>toString 输出修正后的 HTML 代码，结果是 bytes 类型，利用 decode 转成 str 类型</p>
<p>也可读取文本进行解析</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">html = etree.parse(<span class="string">&#x27;./test.html&#x27;</span>, etree.HTMLParser())</span><br></pre></td></tr></table></figure>

<h5 id="所有结点"><a href="#所有结点" class="headerlink" title="所有结点"></a>所有结点</h5><p>一般用 // 开头的 XPath 规则来选取所有符合要求的节点</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">from</span> lxml.etree <span class="keyword">import</span> _Element</span><br><span class="line">text = <span class="string">&#x27;xxxxx&#x27;</span></span><br><span class="line">html = etree.HTML(text) <span class="comment"># type: _Element</span></span><br><span class="line">result = html.xpath(<span class="string">&#x27;//*&#x27;</span>)</span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>html.xpath 代码没提示，可以先打印类型 print(type(html)) -&gt; &lt;class ‘lxml.etree._Element’&gt;</p>
<p>再通过导包的方式</p>
</blockquote>
<p>这里使用 * 代表匹配所有节点，也就是获取整个 HTML 文本中的所有节点</p>
<p>返回形式是一个列表，每个元素是 Element 类型，其后跟了节点的名称，</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[&lt;Element html at <span class="number">0x7f8f63e97280</span>&gt;, &lt;Element body at <span class="number">0x7f8f63f225c0</span>&gt;, &lt;Element div at <span class="number">0x7f8f63f22b40</span>&gt;, &lt;Element ul at <span class="number">0x7f8f63f22b80</span>&gt;, &lt;Element li at <span class="number">0x7f8f63f22bc0</span>&gt;, &lt;Element a at <span class="number">0x7f8f63f22c40</span>&gt;, &lt;Element li at <span class="number">0x7f8f63f22c80</span>&gt;, &lt;Element a at <span class="number">0x7f8f63f22cc0</span>&gt;, &lt;Element li at <span class="number">0x7f8f63f22d00</span>&gt;, &lt;Element a at <span class="number">0x7f8f63f22c00</span>&gt;, &lt;Element li at <span class="number">0x7f8f63f22d40</span>&gt;, &lt;Element a at <span class="number">0x7f8f63f22d80</span>&gt;, &lt;Element li at <span class="number">0x7f8f63f22dc0</span>&gt;, &lt;Element a at <span class="number">0x7f8f63f22e00</span>&gt;]</span><br></pre></td></tr></table></figure>

<p>也可以指定节点名称，例如像获取所有 li 节点</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result = html.xpath(<span class="string">&#x27;//li&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="子节点"><a href="#子节点" class="headerlink" title="子节点"></a>子节点</h5><p>/ 或 // 查找元素的子节点或子孙节点</p>
<p>/用于选取节点的直接子节点，如果获取节点的所有子孙节点，使用 //</p>
<p>例如：选择所有 li 节点的所有直接 a 子节点</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result = html.xpath(<span class="string">&#x27;//li/a&#x27;</span>) </span><br></pre></td></tr></table></figure>

<p>ul 节点下的所有子孙 a 节点</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result = html.xpath(<span class="string">&#x27;//ul//a&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="父节点"><a href="#父节点" class="headerlink" title="父节点"></a>父节点</h5><p>href 属性为 link4.html 的 a 节点，然后再获取其父结点，然后再获取其 class 属性</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result = html.xpath(<span class="string">&#x27;//a[@href=&quot;link4.html&quot;]/../@class&#x27;</span>)</span><br><span class="line"><span class="comment">#结果：item-1</span></span><br></pre></td></tr></table></figure>

<p>也可以通过 parent:: 获取父节点</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result = html.xpath(<span class="string">&#x27;//a[@href=link4.html/parent::*/@class]&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="属性匹配"><a href="#属性匹配" class="headerlink" title="属性匹配"></a>属性匹配</h5><p>@ 符号进行属性过滤，如果选取 class 为 item-1 的 li 节点</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result = html.xpath(<span class="string">&#x27;//li[@class=&#x27;</span>item<span class="number">-1</span><span class="string">&#x27;]&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="文本获取"><a href="#文本获取" class="headerlink" title="文本获取"></a>文本获取</h5><p>XPath 中的 text() 方法获取节点中的文本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#先选取a节点再获取文本</span></span><br><span class="line">result = html.xpath(<span class="string">&#x27;//li[@class=&quot;item-0&quot;]/a/text()&#x27;</span>)</span><br><span class="line">结果：[<span class="string">&#x27;first item&#x27;</span>, <span class="string">&#x27;fifth item&#x27;</span>]</span><br><span class="line"><span class="comment">#或者使用//</span></span><br><span class="line">result = html.xpath(<span class="string">&#x27;//li[@class=&quot;item-0&quot;]//text()&#x27;</span>)</span><br><span class="line">结果：[<span class="string">&#x27;first item&#x27;</span>, <span class="string">&#x27;fifth item&#x27;</span>, <span class="string">&#x27;\n  \t&#x27;</span>] <span class="comment">#因为自动修正的尾标签换行了</span></span><br></pre></td></tr></table></figure>

<p>如果想获取某些特定子孙节点下的所有文本，可以先选取到特定的子孙节点，再调用 text()</p>
<h5 id="属性获取"><a href="#属性获取" class="headerlink" title="属性获取"></a>属性获取</h5><p>获取 li 节点下所有 a 节点的 href 属性</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result = html.xpath(<span class="string">&#x27;//li/a/@href&#x27;</span>)</span><br><span class="line">结果</span><br><span class="line">[<span class="string">&#x27;link1.html&#x27;</span>, <span class="string">&#x27;link2.html&#x27;</span>, <span class="string">&#x27;link3.html&#x27;</span>, <span class="string">&#x27;link4.html&#x27;</span>, <span class="string">&#x27;link5.html&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h5 id="属性多值匹配"><a href="#属性多值匹配" class="headerlink" title="属性多值匹配"></a>属性多值匹配</h5><p>某些节点的属性可能有多个值</p>
<p>下面 html 中 li 节点的 class 属性有两个值 li 和 li-list，就需要用到 cantains() 函数了</p>
<p>contains 第一个参数传属性名称，第二个参数传属性值，传入的属性包含属性值就匹配</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">text = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;li class=&quot;li li-first&quot;&gt;&lt;a href=&quot;link.html&quot;&gt;first item&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">html = etree.HTML(text)</span><br><span class="line">result = html.xpath(<span class="string">&#x27;//li[contains(@class, &quot;li&quot;)]/a/text()&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="多属性匹配"><a href="#多属性匹配" class="headerlink" title="多属性匹配"></a>多属性匹配</h5><p>多个属性确定一个节点，就需要同时匹配多个属性，可以使用 and 连接</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">text = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;li class=&quot;li li-first&quot; name=&quot;item&quot;&gt;&lt;a href=&quot;link.html&quot;&gt;first item&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">html = etree.HTML(text)</span><br><span class="line">result = html.xpath(<span class="string">&#x27;//li[contains(@class, &quot;li&quot;) and @name=&quot;item&quot;]/a/text()&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>运算符：</li>
</ul>
<table>
<thead>
<tr>
<th>or、and</th>
<th>或、与</th>
</tr>
</thead>
<tbody><tr>
<td>+、-、*、div、mod</td>
<td>加、减、乘、除、除法余数</td>
</tr>
<tr>
<td>&gt;、=、&lt;、!=、&gt;=、&lt;=</td>
<td>大于、等于、小于、不等于、大于等于、小于等于</td>
</tr>
</tbody></table>
<h5 id="按序选择"><a href="#按序选择" class="headerlink" title="按序选择"></a>按序选择</h5><p>有时候匹配了多个节点，只想要其中某个节点</p>
<p>可以利用中括号传入索引的方法获取特定次序的节点</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result = html.xpath(<span class="string">&#x27;//li[1]/a/text()&#x27;</span>)  <span class="comment">#第一个li节点 </span></span><br><span class="line">result = html.xpath(<span class="string">&#x27;//li[last()]/a/text()&#x27;</span>) <span class="comment">#最后一个li节点</span></span><br><span class="line">result = html.xpath(<span class="string">&#x27;//li[position()&lt;3]/a/text()&#x27;</span>)<span class="comment">#位置小于3的li节点</span></span><br><span class="line">result = html.xpath(<span class="string">&#x27;//li[last()-2]/a/text()&#x27;</span>) <span class="comment">#倒数第3个节点</span></span><br></pre></td></tr></table></figure>

<p>Xpath 中提供了 100 多个函数，具体参考 <a href="http://www.w3school.com.en/xpath/xpath_functions.asp">http://www.w3school.com.en/xpath/xpath_functions.asp</a></p>
<h5 id="节点轴选择"><a href="#节点轴选择" class="headerlink" title="节点轴选择"></a>节点轴选择</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">//获取所有祖先节点</span><br><span class="line">result = html.xpath(<span class="string">&#x27;//li[1]/ancestor::*&#x27;</span>)</span><br><span class="line">//获取所有 div 的祖先节点</span><br><span class="line">result = html.xpath(<span class="string">&#x27;//li[1]/ancestor::div&#x27;</span>)</span><br><span class="line">//获取 li 节点所有属性值</span><br><span class="line">result = html.xpath(<span class="string">&#x27;//li[1]/attribute::*&#x27;</span>)</span><br><span class="line">//获取直接字节点，取 href 属性为 link.html 的 a 节点</span><br><span class="line">result = html.xpath(<span class="string">&#x27;//li[1]/child::a[@href=&quot;link1.html&quot;]&#x27;</span>)</span><br><span class="line">//获取子孙节点，取包含 span 节点</span><br><span class="line">result = html.xpath(<span class="string">&#x27;//li[1]/descendant::span&#x27;</span>)</span><br><span class="line">//获取当前节点之后所有节点，只获取第二个后续节点</span><br><span class="line">result = html.xpath(<span class="string">&#x27;//li[1]/following::*[2]&#x27;</span>)</span><br><span class="line">//获取当前节点之后的所有同级节点</span><br><span class="line">result = html.xpath(<span class="string">&#x27;//li[1]/following-sibling::*&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>XPath 轴 <a href="http://www.w3school.com.cn/xpath/xpath_axes.asp">http://www.w3school.com.cn/xpath/xpath_axes.asp</a></p>
<h4 id="Beautiful-Soup"><a href="#Beautiful-Soup" class="headerlink" title="Beautiful Soup"></a>Beautiful Soup</h4><p>HTML 或 XML 的解析库，借助网页的结构和属性等特性来解析网页</p>
<p>自动将输入文档转换为 Unicode 编码，输出文档转换为 UTF-8 编码，不需要考虑编码方式</p>
<p>Beautiful Soup 在解析时依赖解析器，lxml 解析器有解析 HTML 和 XML 的功能，且速度快，容错能力强</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install beautifulsoup4</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line">soup = BeautifulSoup(<span class="string">&#x27;&lt;p&gt;Hello&lt;/p&gt;&#x27;</span>, <span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line">print(soup.p.string) <span class="comment">#选取p节点，调用string属性就可以得到里面文本了</span></span><br></pre></td></tr></table></figure>

<p>第一个参数 HTML字符串， 第二个参数为解析器的类型</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">html = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;html&gt;&lt;head&gt;&lt;title&gt;The Dormouse&#x27;s story&lt;/title&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;p class=&quot;title&quot; name=&quot;dromouse&quot;&gt;&lt;b&gt;The Dormouse&#x27;s story&lt;/b&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;p class=&quot;story&quot; Once upon a time there were three little sisters; and their names were</span></span><br><span class="line"><span class="string">&lt;a href=&quot;http://example.com/elsie&quot; class=&quot;sister&quot; id=&quot;linkl&quot;&gt;&lt;! - Elsie ...&gt;&lt;/a&gt;,</span></span><br><span class="line"><span class="string">&lt;a href=&quot;http://example.com/lacie&quot; class=&quot;sister&quot; id=&quot;link2&quot;&gt;Lacie&lt;/a&gt; and</span></span><br><span class="line"><span class="string">&lt;a href=&quot;http://example.com/tillie&quot; class=&quot;sister&quot; id=&quot;link3&quot;&gt;Tillie&lt;/a&gt;;</span></span><br><span class="line"><span class="string">and they lived at the bottom of a well.&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;p class=&quot;story&quot;&gt;...&lt;/p&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">soup = BeautifulSoup(html, <span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line">print(soup.prettify())</span><br><span class="line">print(soup.title.string)</span><br></pre></td></tr></table></figure>

<p>调用 pretttify() 方法，把要解析的字符串以标准的缩进格式输出，Beautiful Soup 可以自动更正格式</p>
<p>soup.title.string 选取 title 节点，再调用 string 属性就可以得到里面的文本了</p>
<h5 id="节点选择器"><a href="#节点选择器" class="headerlink" title="节点选择器"></a>节点选择器</h5><p>直接调用节点名称就可以选择节点元素，再调用 string 属性就可以得到节点内的文本了</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">print(soup.title)</span><br><span class="line">print(<span class="built_in">type</span>(soup.title))</span><br><span class="line">print(soup.title.string)</span><br><span class="line">print(soup.head)</span><br><span class="line">print(soup.p)</span><br><span class="line">结果</span><br><span class="line">&lt;title&gt;The Dormouse<span class="string">&#x27;s story&lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;class &#x27;</span>bs4.element.Tag<span class="string">&#x27;&gt;</span></span><br><span class="line"><span class="string">The Dormouse&#x27;</span>s story</span><br><span class="line">&lt;head&gt;&lt;title&gt;The Dormouse<span class="string">&#x27;s story&lt;/title&gt;&lt;/head&gt;</span></span><br><span class="line">&lt;p class=&quot;title&quot; name=&quot;dromouse&quot;&gt;&lt;b&gt;The Dormouse&#x27;s story&lt;/b&gt;&lt;/p&gt;</span><br></pre></td></tr></table></figure>

<p>只打印了第一个 p 节点的内容，多个节点时，这种选择方式只会选择到第一个匹配的节点，后面的其它节点都会被忽略</p>
<h5 id="提取信息"><a href="#提取信息" class="headerlink" title="提取信息"></a>提取信息</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">//获取节点名称</span><br><span class="line">print(soup.title.name)  		</span><br><span class="line">title</span><br></pre></td></tr></table></figure>

<p>一个节点可能有多个属性，如 id 和 class 等，调用 attrs 获取所有属性，返回结果是字典形式</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">//获取所有属性</span><br><span class="line">print(soup.p.attrs)			 		</span><br><span class="line">&#123;<span class="string">&#x27;class&#x27;</span>: [<span class="string">&#x27;title&#x27;</span>], <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;dromouse&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">//获取 name 属性</span><br><span class="line">print(soup.p.attrs[<span class="string">&#x27;name&#x27;</span>])	</span><br><span class="line">dromouse</span><br></pre></td></tr></table></figure>

<p>比较简单方式，注意返回有的是字符串，有的是字符串组成的列表</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(soup.p[<span class="string">&#x27;name&#x27;</span>])</span><br><span class="line">print(soup.p[<span class="string">&#x27;class&#x27;</span>])</span><br><span class="line"><span class="comment">#需要注意有的返回字符串，有的返回字符串组成的列表，要注意判断类型</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;获取内容(是第一个 p 节点)</span><br><span class="line">print(soup.p.string)</span><br></pre></td></tr></table></figure>

<h5 id="嵌套选择"><a href="#嵌套选择" class="headerlink" title="嵌套选择"></a>嵌套选择</h5><p>选取一个节点，可以继续调用节点进行下一步选择</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">print(soup.head.title.string)</span><br></pre></td></tr></table></figure>

<h5 id="关联选择"><a href="#关联选择" class="headerlink" title="关联选择"></a>关联选择</h5><p>有时候不能一步就选到想要的节点元素，需要先选中某个节点元素，然后以它为基准再选择它的父节点、子节点、兄弟节点</p>
<h6 id="直接子节点-contents、children"><a href="#直接子节点-contents、children" class="headerlink" title="直接子节点 contents、children"></a>直接子节点 contents、children</h6><p>添加一个 p 节点</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;p class=&quot;story&quot;&gt;</span><br><span class="line">	Once upon a time there were three little sisters; <span class="keyword">and</span> their names were</span><br><span class="line">  &lt;a href=&quot;http://example.com/elsie&quot; class=&quot;sister&quot; id=&quot;linkl&quot;&gt; </span><br><span class="line">    &lt;span&gt; Elsie&lt;/span&gt;</span><br><span class="line">  &lt;/a&gt;</span><br><span class="line">&lt;/p&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">html = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line">soup = BeautifulSoup(html,<span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line">print(soup.p.contents)</span><br></pre></td></tr></table></figure>

<p>调用 contents 属性，结果返回 p 节点的直接子节点，返回结果是一个列表形式</p>
<p>包含文本和节点，得到的是直接子节点的列表（span是子孙节点在a节点里面，没有单独选出来）</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">print(soup.p.contents)</span><br><span class="line">[&#x27;\n\tOnce upon a time there were three little sisters; and their names were\n\t&#x27;, &lt;a class=&quot;sister&quot; href=&quot;http://example.com/elsie&quot; id=&quot;linkl&quot;&gt;</span><br><span class="line">&lt;span&gt; Elsie&lt;/span&gt;</span><br><span class="line">&lt;/a&gt;, &#x27;\n&#x27;]</span><br></pre></td></tr></table></figure>

<p>同样可以直接调用 children 属性得到相应的结果，返回结果是生成器类型</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(soup.p.children)</span><br><span class="line"><span class="keyword">for</span> i, child <span class="keyword">in</span> <span class="built_in">enumerate</span>(soup.p.children):</span><br><span class="line">  print(i, child)</span><br></pre></td></tr></table></figure>



<h6 id="子孙节点-descendants"><a href="#子孙节点-descendants" class="headerlink" title="子孙节点 descendants"></a>子孙节点 descendants</h6><p>如果要获取所有子孙节点的话，调用 descendants 属性，返回结果是生成器类型</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(soup.p.descendants)</span><br><span class="line"><span class="keyword">for</span> i, child <span class="keyword">in</span> <span class="built_in">enumerate</span>(soup.p.descendants):</span><br><span class="line">    print(i, child)</span><br></pre></td></tr></table></figure>



<h6 id="父节点和-祖先节点"><a href="#父节点和-祖先节点" class="headerlink" title="父节点和 祖先节点"></a>父节点和 祖先节点</h6><p>获取父节点，调用 parent 属性</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(soup.a.parent)</span><br></pre></td></tr></table></figure>

<p>想要获取所有的祖先节点，调用 parents 属性，返回结果是生成器类型，这里用列表输出索引和内容</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(<span class="built_in">list</span>(<span class="built_in">enumerate</span>(soup.a.parents)))</span><br></pre></td></tr></table></figure>



<h6 id="兄弟节点（同级节点）"><a href="#兄弟节点（同级节点）" class="headerlink" title="兄弟节点（同级节点）"></a>兄弟节点（同级节点）</h6><p>next_sibling 节点下一个兄弟元素</p>
<p>previous_sibling 节点上一个兄弟元素</p>
<p>next_siblings 所有前面的兄弟元素</p>
<p>previous_siblings 所有后面的兄弟元素</p>
<h5 id="提取信息-1"><a href="#提取信息-1" class="headerlink" title="提取信息"></a>提取信息</h5><p>返回的是单个节点，直接调用 string、attrs 等属性获取文本和属性</p>
<p>多个节点的生成器，则可转为列表后取出某个元素，然后调用 string、attrs</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(soup.a.next_sibling)</span><br><span class="line">print(soup.a.next_sibling.string)</span><br><span class="line">print(<span class="built_in">list</span>(soup.a.parents)[<span class="number">0</span>])</span><br><span class="line">pirnt(<span class="built_in">list</span>(soup.a.parents)[<span class="number">0</span>].attrs[<span class="string">&#x27;class&#x27;</span>])</span><br></pre></td></tr></table></figure>

<h5 id="方法选择器"><a href="#方法选择器" class="headerlink" title="方法选择器"></a>方法选择器</h5><p>前面的选择方法都是通过属性来选择的，Beautiful Soup 还提供了一些查询方法</p>
<h6 id="find-all"><a href="#find-all" class="headerlink" title="find_all()"></a>find_all()</h6><p>查找所有符合条件的元素，传入属性或文本，就可以得到符合条件的元素</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">find_all(name, attrs, recursive, text, **kwargs)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">html = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  &lt;div class=&quot;panel&quot;&gt;</span></span><br><span class="line"><span class="string">  &lt;div class=&quot;panel-heading&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;h4&gt;Hello&lt;/h4&gt;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;</span></span><br><span class="line"><span class="string">  &lt;div class=&quot;panel-body&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;ul class=&quot;list&quot; id=&quot;list-1&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;li class=&quot;element&quot;&gt;Foo&lt;/li&gt;</span></span><br><span class="line"><span class="string">      &lt;li class=&quot;element&quot;&gt;Bar&lt;/li&gt;</span></span><br><span class="line"><span class="string">      &lt;li class=&quot;element&quot;&gt;Jay&lt;/li&gt;</span></span><br><span class="line"><span class="string">    &lt;/ul&gt;</span></span><br><span class="line"><span class="string">    &lt;ul class=&quot;list list-small&quot; id=&quot;list-2&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;li class=&quot;element&quot;&gt;Foo&lt;/li&gt;</span></span><br><span class="line"><span class="string">      &lt;li class=&quot;element&quot;&gt;Bar&lt;/li&gt;</span></span><br><span class="line"><span class="string">    &lt;/ul&gt;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>  (1) name 根据节点名来查询元素</p>
<p>查询所有 ul 节点，返回结果是列表类型</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">soup = BeautifulSoup(html,<span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line">print(soup.find_all(name=<span class="string">&#x27;ul&#x27;</span>)) </span><br><span class="line"><span class="comment">#结果列表类型，长度2</span></span><br></pre></td></tr></table></figure>

<p>查询出所有 ul 节点后，再继续查询其内部的 li 节点</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">soup = BeautifulSoup(html,<span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> ul <span class="keyword">in</span> soup.find_all(name=<span class="string">&#x27;ul&#x27;</span>):</span><br><span class="line">  print(ul.find_all(name=<span class="string">&#x27;li&#x27;</span>))</span><br><span class="line">  <span class="keyword">for</span> li <span class="keyword">in</span> ul.find_all(name=<span class="string">&#x27;li&#x27;</span>):</span><br><span class="line">    print(li.string)</span><br></pre></td></tr></table></figure>



<p>(2)  attrs 传入属性查询</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(soup.find_all(attrs=&#123;<span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;list-1&#x27;</span>&#125;))</span><br><span class="line">print(soup.find_all(attrs=&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;elements&#x27;</span>&#125;))</span><br><span class="line"></span><br><span class="line">print(soup.find_all(<span class="built_in">id</span>=<span class="string">&#x27;list-1&#x27;</span>))</span><br><span class="line">print(soup.find_all(class_=<span class="string">&#x27;element&#x27;</span>)) </span><br><span class="line"><span class="comment">#class 是 Python 关键字，需要加下划线</span></span><br></pre></td></tr></table></figure>



<p>(3) text 匹配节点的文本，可以传字符串或正则表达式对象</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#参数为正则表达式对象</span></span><br><span class="line">print(soup.find_all(text=re.<span class="built_in">compile</span>(<span class="string">&#x27;link&#x27;</span>)))</span><br></pre></td></tr></table></figure>

<h6 id="find"><a href="#find" class="headerlink" title="find()"></a>find()</h6><p>返回的是单个元素，也就是第一个匹配的元素</p>
<ol start="3">
<li>其它查询方法</li>
</ol>
<p>find_parents() 和 find_parent()：前者返回所有祖先节点，后者返回直接父节点</p>
<p>find_next_siblings() 和 find_next_sibling()：前者返回后面所有兄弟节点，后者返回后面第一个兄弟节点</p>
<p>find_previous_siblings() 和 find_previous_sibling()：：前者返回前面所有兄弟节点，后者返回前面第一个兄弟节点</p>
<p>find_all_next() 和 find_next()：前者返回节点后所有符合条件的节点，后者返回第一个符合条件的节点</p>
<p>find_all_previous() 和 find_previous：</p>
<h5 id="CSS-选择器"><a href="#CSS-选择器" class="headerlink" title="CSS 选择器"></a>CSS 选择器</h5><p>Beautiful Soup还提供了另一种选择器，CSS 选择器</p>
<p>只需要调用 select ，传入相应 CSS 选择器即可</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">html = &#x27;&#x27;&#x27;</span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;panel&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;panel-heading&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h4</span>&gt;</span>Hello<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;panel-body&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;list&quot;</span> <span class="attr">id</span>=<span class="string">&quot;list-1&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;element&quot;</span>&gt;</span>Foo<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;element&quot;</span>&gt;</span>Bar<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;element&quot;</span>&gt;</span>Jay<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;list list-small&quot;</span> <span class="attr">id</span>=<span class="string">&quot;list-2&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;element&quot;</span>&gt;</span>Foo<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;element&quot;</span>&gt;</span>Bar<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#x27;&#x27;&#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="code"><pre><span class="line">soup = BeautifulSoup(html, <span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line">print(soup.select(<span class="string">&#x27;.panel .panel-heading&#x27;</span>))   <span class="comment"># 选择class</span></span><br><span class="line">print(soup.select(<span class="string">&#x27;ul li&#x27;</span>)) <span class="comment">#选择所有ul节点下面的li节点</span></span><br><span class="line">print(soup.select(<span class="string">&#x27;#list-2 .element&#x27;</span>)) <span class="comment"># 选择id</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#结果</span></span><br><span class="line">[&lt;div class=&quot;panel-heading&quot;&gt;</span><br><span class="line">&lt;h4&gt;Hello&lt;/h4&gt;</span><br><span class="line">&lt;/div&gt;]</span><br><span class="line"></span><br><span class="line">[&lt;li class=&quot;element&quot;&gt;Foo&lt;/li&gt;, &lt;li class=&quot;element&quot;&gt;Bar&lt;/li&gt;, &lt;li class=&quot;element&quot;&gt;Jay&lt;/li&gt;, &lt;li class=&quot;element&quot;&gt;Foo&lt;/li&gt;, &lt;li class=&quot;element&quot;&gt;Bar&lt;/li&gt;]</span><br><span class="line"></span><br><span class="line">[&lt;li class=&quot;element&quot;&gt;Foo&lt;/li&gt;, &lt;li class=&quot;element&quot;&gt;Bar&lt;/li&gt;]</span><br></pre></td></tr></table></figure>

<h6 id="嵌套选择-1"><a href="#嵌套选择-1" class="headerlink" title="嵌套选择"></a>嵌套选择</h6><p>select() 方法同样支持嵌套选择，如先选择所有 ul 节点，再遍历每个 ul 节点，选择其 li 节点</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> ul <span class="keyword">in</span> soup.select(<span class="string">&#x27;ul&#x27;</span>):</span><br><span class="line">	print(ul.select(<span class="string">&#x27;li&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>输出了所有 ul 节点下所有 li 节点组成的列表</p>
<h6 id="获取属性"><a href="#获取属性" class="headerlink" title="获取属性"></a>获取属性</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> ul <span class="keyword">in</span> soup.select(<span class="string">&#x27;ul&#x27;</span>):</span><br><span class="line">	print(ul[<span class="string">&#x27;id&#x27;</span>])</span><br><span class="line">	print(ul.attrs[<span class="string">&#x27;id&#x27;</span>])</span><br></pre></td></tr></table></figure>

<h6 id="获取文本"><a href="#获取文本" class="headerlink" title="获取文本"></a>获取文本</h6><p>获取文本可以用 string 属性，还有个方法 get_text()</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> li <span class="keyword">in</span> soup.select(<span class="string">&#x27;li&#x27;</span>):</span><br><span class="line">	print(<span class="string">&#x27;Get Text:&#x27;</span>, li.get_text())</span><br><span class="line">	print(<span class="string">&#x27;String:&#x27;</span>, li.string)</span><br></pre></td></tr></table></figure>



<h4 id="pyquery"><a href="#pyquery" class="headerlink" title="pyquery"></a>pyquery</h4><p>如果比较喜欢用CSS选择器，对jQuery有所了解，可以使用 pyquery</p>
<h5 id="字符串初始化"><a href="#字符串初始化" class="headerlink" title="字符串初始化"></a>字符串初始化</h5><p>传入 HTML 字符串（常用）</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pyquery <span class="keyword">import</span> PyQuery <span class="keyword">as</span> pq <span class="comment">#引入 PyQuery 对象，取别名 pq</span></span><br><span class="line">html = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;div&gt;</span></span><br><span class="line"><span class="string">&lt;ul&gt;</span></span><br><span class="line"><span class="string">&lt;li class=&quot;item-0&quot;&gt;first item&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;li class=&quot;item-1&quot;&gt;&lt;a href=&quot;link2.html&quot;&gt;second item&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;li class=&quot;item-0 active&quot;&gt;&lt;a href=&quot;link3.html&quot;&gt;&lt;span class=&quot;bold&quot;&gt;third item&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;li class=&quot;item-1 active&quot;&gt;&lt;a href=&quot;link4.html&quot;&gt;fourth item&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;li class=&quot;item-0&quot;&gt;&lt;a href=&quot;link5.html&quot;&gt;fifth item&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;/ul&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">doc = pq(html)</span><br><span class="line">print(doc(<span class="string">&#x27;li&#x27;</span>)) <span class="comment">#选择所有li节点</span></span><br></pre></td></tr></table></figure>

<h5 id="URL-初始化"><a href="#URL-初始化" class="headerlink" title="URL 初始化"></a>URL 初始化</h5><p>可以传入网页的 URL</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">doc = pq(<span class="string">&#x27;https://cuiqingcai.com&#x27;</span>)</span><br><span class="line">print(doc(<span class="string">&#x27;title&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>PyQuery对象会先请求这个URL，然后用得到的 HTML 内容完成初始化，相当于网页的源码以字符串的形式传递给 PyQuery 类来初始化，相当于：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pyquery <span class="keyword">import</span> PyQuery <span class="keyword">as</span> pq</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">doc = pq(requests.get(<span class="string">&#x27;https://cuiqingcai.com&#x27;</span>).text)</span><br><span class="line">print(doc(<span class="string">&#x27;title&#x27;</span>))</span><br></pre></td></tr></table></figure>

<h5 id="文件初始化"><a href="#文件初始化" class="headerlink" title="文件初始化"></a>文件初始化</h5><p>可以传本地文件名</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">doc = pq(filename=<span class="string">&#x27;demo.html&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="基于CSS选择器"><a href="#基于CSS选择器" class="headerlink" title="基于CSS选择器"></a>基于CSS选择器</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">html = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;div id=&quot;container&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;ul class=&quot;list&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;li class=&quot;item-0&quot;&gt;first item&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;li class=&quot;item-1&quot;&gt;&lt;a href=&quot;link2.html&quot;&gt;second item&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;li class=&quot;item-0 active&quot;&gt;&lt;a href=&quot;link3.html&quot;&gt;&lt;span class=&quot;bold&quot;&gt;third item&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;li class=&quot;item-1 active&quot;&gt;&lt;a href=&quot;link4.html&quot;&gt;fourth item&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;li class=&quot;item-0&quot;&gt;&lt;a href=&quot;link5.html&quot;&gt;fifth item&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;/ul&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">doc = pq(html)</span><br><span class="line">print(doc(<span class="string">&#x27;#container .list li&#x27;</span>))</span><br><span class="line">print(<span class="built_in">type</span>(doc(<span class="string">&#x27;#container .list li&#x27;</span>))) <span class="comment">#pyquery.pyquery.PyQuery</span></span><br></pre></td></tr></table></figure>

<p>先选取 id 为 container 的节点，然后再选取其内部的 class 为 list 的节点内部的所有 li 节点</p>
<h6 id="查找节点"><a href="#查找节点" class="headerlink" title="查找节点"></a>查找节点</h6><p>常用查询函数和 jQuery 中函数的用法完全相同</p>
<h6 id="子节点-1"><a href="#子节点-1" class="headerlink" title="子节点"></a>子节点</h6><p>查找子节点需要用到 find() 方法，传入参数是 CSS 选择器</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">items = doc(<span class="string">&#x27;.list&#x27;</span>) <span class="comment">#选取class为list的节点</span></span><br><span class="line">lis = items.find(<span class="string">&#x27;li&#x27;</span>)<span class="comment">#选取内部li节点</span></span><br><span class="line">print(lis)</span><br></pre></td></tr></table></figure>

<p>其实 find() 查找范围是节点的所有子孙节点，如果只想查找子节点可以用 children()</p>
<p>如果要筛选所有子节点中符合条件的节点，比如节点中 class 为 active 的节点，可以像 children() 方法传入 CSS 选择器 .active</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">lis = items.children(<span class="string">&#x27;.active&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h6 id="父节点-1"><a href="#父节点-1" class="headerlink" title="父节点"></a>父节点</h6><p>可以用 parent() 方法来获取某个节点的父节点</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">doc = pq(html)</span><br><span class="line">items = doc(<span class="string">&#x27;.list&#x27;</span>) <span class="comment">#type: pyquery</span></span><br><span class="line">print(<span class="built_in">type</span>(items))</span><br><span class="line">container = items.parent()</span><br><span class="line">print(container)</span><br><span class="line"><span class="comment">#先选取class为list的节点</span></span><br></pre></td></tr></table></figure>

<p>想要获取祖先节点用 parents()</p>
<p>想要筛选某个祖先节点，向 parents() 传入 CSS 选择器，这样就会返回祖先节点中符合 CSS 选择器的节点</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">parent = items.parents(<span class="string">&#x27;.wrap&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h6 id="兄弟节点"><a href="#兄弟节点" class="headerlink" title="兄弟节点"></a>兄弟节点</h6><p>siblings() 方法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">li = doc(<span class="string">&#x27;.list .item-0.active&#x27;</span>) <span class="comment">#type: pyquery</span></span><br><span class="line">print(li.siblings())</span><br><span class="line">print(li.siblings(<span class="string">&#x27;.active&#x27;</span>))<span class="comment">#筛选class为active的节点</span></span><br></pre></td></tr></table></figure>

<p>选择 class 为 list 的节点，内部的 class 为 item-0 和 active 的节点</p>
<h6 id="遍历"><a href="#遍历" class="headerlink" title="遍历"></a>遍历</h6><p>pyquery 库的选择结果可能是多个节点，也可能是单个节点，类型都是 PyQuery 类型</p>
<p>单个节点可以直接打印输出，也可直接转成字符串</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">li = doc(<span class="string">&#x27;.item-0.active&#x27;</span>)</span><br><span class="line">print(li)</span><br><span class="line">print(<span class="built_in">str</span>(li))</span><br></pre></td></tr></table></figure>

<p>遍历，调用 items() 方法，得到一个生成器，遍历下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">lis = doc(<span class="string">&#x27;li&#x27;</span>).items</span><br><span class="line"><span class="keyword">for</span> li <span class="keyword">in</span> lis:</span><br><span class="line">	print(li)</span><br></pre></td></tr></table></figure>

<h5 id="获取信息"><a href="#获取信息" class="headerlink" title="获取信息"></a>获取信息</h5><ol>
<li>获取属性</li>
</ol>
<p>调用 attr() 方法获取属性</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a = doc(<span class="string">&#x27;.item-0.active a&#x27;</span>)<span class="comment">#class为item-0和active的li节点内的a节点</span></span><br><span class="line">print(a.attr(<span class="string">&#x27;href&#x27;</span>))<span class="comment">#调用attr方法传入属性的名称</span></span><br><span class="line"><span class="comment">#也可调用attr属性来获取</span></span><br><span class="line">print(a.attr.href)</span><br></pre></td></tr></table></figure>

<p>多个节点调用attr()方法只返回第一个节点属性，获取所有的需要遍历</p>
<ol start="2">
<li>获取文本</li>
</ol>
<p>text() 方法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(a.text())</span><br></pre></td></tr></table></figure>

<p>获取内部 HTML 文本，html() 方法</p>
<h5 id="节点操作"><a href="#节点操作" class="headerlink" title="节点操作"></a>节点操作</h5><p>pyquery 提供了一系列方法对节点进行动态修改</p>
<ul>
<li>addClass removeClass</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">li = doc(<span class="string">&#x27;.item-0.active&#x27;</span>)</span><br><span class="line">li.removeClass(<span class="string">&#x27;active&#x27;</span>)</span><br><span class="line">li.addClass(<span class="string">&#x27;active&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>attr、text、html</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">li = doc(<span class="string">&#x27;.item-0 .active&#x27;</span>)</span><br><span class="line">li.attr(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;link&#x27;</span>)</span><br><span class="line">li.text(<span class="string">&#x27;change item&#x27;</span>)</span><br><span class="line">li.html(<span class="string">&#x27;&lt;span&gt;change item&lt;/span&gt;&#x27;</span>)</span><br><span class="line"><span class="comment">#调用 attr 方法后 li节点多了个原本不存在属性 name 值为link</span></span><br><span class="line"><span class="comment">#调用attr修改属性 text html修改节点内部内容</span></span><br></pre></td></tr></table></figure>

<ul>
<li>remove</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">html = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;div class=&quot;wrap&quot;&gt;</span></span><br><span class="line"><span class="string">  Hello,world</span></span><br><span class="line"><span class="string">  &lt;p&gt;This is a paragraph&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">doc = pq(html)</span><br><span class="line">wrap = doc(<span class="string">&#x27;.wrap&#x27;</span>)</span><br><span class="line">print(wrap.text())</span><br><span class="line"><span class="comment">#结果Hello,world This is a paragraph</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">wrap.find(<span class="string">&#x27;p&#x27;</span>).remove() <span class="comment">#选取p节点，然后调用remove方法将其移除</span></span><br><span class="line">print(wrap.text())</span><br></pre></td></tr></table></figure>

<p>还有其它节点操作方法 append() empty() prepend()</p>
<p>参考 <a href="http://pyquery.readthedocs.io/en/latest/api.html">http://pyquery.readthedocs.io/en/latest/api.html</a></p>
<ul>
<li>伪类选择器</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">doc(<span class="string">&#x27;li:first-child&#x27;</span>)<span class="comment">#第一个li节点</span></span><br><span class="line">doc(<span class="string">&#x27;li:last-child&#x27;</span>)<span class="comment">#最后一个li节点</span></span><br><span class="line">doc(<span class="string">&#x27;li:nth-child(2)&#x27;</span>)<span class="comment">#第二个li节点</span></span><br><span class="line">doc(<span class="string">&#x27;li:gt(2)&#x27;</span>)<span class="comment">#第三个li之后的节点</span></span><br><span class="line">doc(<span class="string">&#x27;li:nth-child(2n)&#x27;</span>)<span class="comment">#偶数位的li节点</span></span><br><span class="line">doc(<span class="string">&#x27;li:contains(second)&#x27;</span>)<span class="comment">#包含second文本的li节点</span></span><br></pre></td></tr></table></figure>

<h4 id=""><a href="#" class="headerlink" title=""></a></h4><h4 id="parsel"><a href="#parsel" class="headerlink" title="parsel"></a>parsel</h4><p>支持使用 XPath 和 CSS 选择器对内容进行修改和提取，同时还融合了正则表达式的提取功能</p>
<p>Scrapy 框架的选择器就是基于 parsel 做的二次封装</p>
<h5 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h5><p>一般会用 parsel 库里的 Selector 声明一个 Selector 对象</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> parsel <span class="keyword">import</span> Selector</span><br><span class="line">html = <span class="string">&#x27;xxxx&#x27;</span></span><br><span class="line">selector = Selector(text=html)</span><br></pre></td></tr></table></figure>

<p>有了 Selector 对象就可以使用 css he xpath 方法分别传入 CSS选择器和XPath进行提取</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">items = selector.css(<span class="string">&#x27;.item-0&#x27;</span>)</span><br><span class="line">items2 = selector.xpath(<span class="string">&#x27;//li[contains(@class, &quot;item-0&quot;)]&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>结果都是 SelectorList 对象</p>
<h5 id="提取文本"><a href="#提取文本" class="headerlink" title="提取文本"></a>提取文本</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> parsel <span class="keyword">import</span> Selector</span><br><span class="line">html = <span class="string">&#x27;xxx&#x27;</span></span><br><span class="line">selector = Selector(text=html)</span><br><span class="line">items = selector.css(<span class="string">&#x27;.item-0&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">  text = item.xpath(<span class="string">&#x27;.//text()&#x27;</span>).get()</span><br><span class="line">  print(text)</span><br></pre></td></tr></table></figure>

<p>这里用 <code>.//text()</code>  这个 xpath 写法提取了当前节点的所有内容，此时如果不再调用其它方法，那么返回的结果依然为 Selector 构成的可迭代对象 SelectorList</p>
<p>SelectorList 有一个 get 方法，可以将 SelectorList 包含的 Selector 对象中的内容提取出来</p>
<p>get 方法的作用是 从 SelectorList 里面提取第一个 Selector 对象，然后输出其中结果</p>
<p>如果提取所有的 Selector，使用 getall 方法。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result = selector.css(<span class="string">&#x27;.item-0 *::text&#x27;</span>).getall()</span><br><span class="line"><span class="comment">#这里 *用来提取所有子节点（包括纯文本节点）提取文本需要加上 ::text</span></span><br></pre></td></tr></table></figure>

<h5 id="提取属性"><a href="#提取属性" class="headerlink" title="提取属性"></a>提取属性</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result = selector.css(<span class="string">&#x27;.item-0.active a::attr(href)&#x27;</span>).get()</span><br><span class="line">result = selector.xpath(<span class="string">&#x27;//li[contains(@class,&quot;item-0&quot;) and contains(@class, &quot;active&quot;)]/a/@href&#x27;</span>).get()</span><br></pre></td></tr></table></figure>

<p>对于 CSS 选择器，选取属性需要加 ::attr()，并传入对应的属性名称才可选取，对于 XPath，直接用 /@再加属性名称即可选取</p>
<h5 id="正则提取"><a href="#正则提取" class="headerlink" title="正则提取"></a>正则提取</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result = selector.css(<span class="string">&#x27;.item-0&#x27;</span>).re(<span class="string">&#x27;link.*&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>这里先用 css 方法提取了所有 class 包含 item-0 的节点，然后用 re 方法传入 link.* 用来匹配包含link 的所有结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result = selector.css(<span class="string">&#x27;.item-0 *::text&#x27;</span>).re(<span class="string">&#x27;.*item&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>也可用 re_first 方法来提取第一个符合规则的结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result = selector.css(<span class="string">&#x27;.item-0&#x27;</span>).re_first(<span class="string">&#x27;&lt;span class=&quot;bold&quot;&gt;(.*?)&lt;/span&gt;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>调用了 re_first 方法，提取的是被 span 标签包含的文本值，提取结果用小括号括起来表示一个提取分组，最后输出的结果就是小括号包围的部分</p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Python3网络爬虫开发实战-数据存储</title>
    <url>/2022/04/12/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-4%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/</url>
    <content><![CDATA[<h4 id="4-文件存储"><a href="#4-文件存储" class="headerlink" title="4 文件存储"></a>4 文件存储</h4><h4 id="4-1-TXT-文本存储"><a href="#4-1-TXT-文本存储" class="headerlink" title="4.1 TXT 文本存储"></a>4.1 TXT 文本存储</h4><p>保存知乎上近期热点</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pyquery <span class="keyword">import</span> PyQuery <span class="keyword">as</span> pq</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&#x27;https://www.zhihu.com/explore&#x27;</span></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.0 Safari/605.1.15&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">html = requests.get(url, headers=headers).text</span><br><span class="line">doc = pq(html)</span><br><span class="line"><span class="comment"># items = doc(&#x27;.css-4cffwv&#x27;)</span></span><br><span class="line">items = doc(<span class="string">&#x27;.css-4cffwv .css-vurnku .css-1as7ang&#x27;</span>).items()</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">    topic = item(<span class="string">&#x27;.css-1g4zjtl a&#x27;</span>).text()</span><br><span class="line">    des = item(<span class="string">&#x27;.css-13jrecd&#x27;</span>).text()</span><br><span class="line">    file = <span class="built_in">open</span>(<span class="string">&#x27;explore.txt&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    file.write(<span class="string">&#x27;\n&#x27;</span>.join([topic, des]))</span><br><span class="line">    file.write(<span class="string">&#x27;\n&#x27;</span> + <span class="string">&#x27;=&#x27;</span> * <span class="number">50</span> + <span class="string">&#x27;\n&#x27;</span> )</span><br><span class="line">    file.close()</span><br></pre></td></tr></table></figure>

<p>open 第一个参数为保存文件名称，第二个参数为 a 代表追加方式写入到文本</p>
<p>写入完成后需要调用 close 方法关闭文件对象</p>
<h5 id="打开方式"><a href="#打开方式" class="headerlink" title="打开方式"></a>打开方式</h5><table>
<thead>
<tr>
<th>打开方式</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>r</td>
<td>只读方式打开，文件指针放在文件开头</td>
</tr>
<tr>
<td>rb</td>
<td>以二进制只读方式打开一个文件，文件指针放在文件开头</td>
</tr>
<tr>
<td>r+</td>
<td>以读写方式打开一个文件，文件指针放在文件开头</td>
</tr>
<tr>
<td>rb+</td>
<td>以二进制读写方式打开一个文件，文件指针放在文件开头</td>
</tr>
<tr>
<td>w</td>
<td>以写入方式打开一个文件，文件已存在会覆盖，不存在则创建</td>
</tr>
<tr>
<td>wb</td>
<td>以二进制写入方式打开一个文件，文件已存在会覆盖，不存在则创建</td>
</tr>
<tr>
<td>w+</td>
<td>以读写入方式打开一个文件，文件已存在会覆盖，不存在则创建</td>
</tr>
<tr>
<td>wb+</td>
<td>以二进制读写方式打开一个文件，文件已存在会覆盖，不存在则创建</td>
</tr>
<tr>
<td>a</td>
<td>以追加方式打开一个文件，文件已存在新内容写入已有内容之后，不存在则创建</td>
</tr>
<tr>
<td>ab</td>
<td>以二进制追加方式打开一个文件，文件已存在新内容写入已有内容之后，不存在则创建</td>
</tr>
<tr>
<td>a+</td>
<td>以读写方式打开一个文件，文件已存在新内容写入已有内容之后，不存在则创建</td>
</tr>
<tr>
<td>ab+</td>
<td></td>
</tr>
</tbody></table>
<h5 id="简化写法"><a href="#简化写法" class="headerlink" title="简化写法"></a>简化写法</h5><p>with as 语法，with 控制块结束时，文件会自动关闭，不需要调用 close</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;explore.txt&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    file.write(<span class="string">&#x27;\n&#x27;</span>.join([topic, des]))</span><br><span class="line">    file.write(<span class="string">&#x27;\n&#x27;</span> + <span class="string">&#x27;=&#x27;</span> * <span class="number">50</span> + <span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="4-2-JSON-文件存储"><a href="#4-2-JSON-文件存储" class="headerlink" title="4.2 JSON 文件存储"></a>4.2 JSON 文件存储</h4><h5 id="读取-JSON"><a href="#读取-JSON" class="headerlink" title="读取 JSON"></a>读取 JSON</h5><p>可以调用 JSON 库的 loads() 方法将 JSON 文本字符串转为 JSON 对象，通过 dumps() 将 JSON 对象转为文本字符串</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="built_in">str</span> = <span class="string">&#x27;[&#123;&quot;name&quot;: &quot;Bob&quot;&#125;,&#123;&quot;gender&quot;: &quot;male&quot;&#125;]&#x27;</span></span><br><span class="line">data = json.loads(<span class="built_in">str</span>)</span><br><span class="line">print(data)</span><br><span class="line"><span class="comment">#转成JSON就可以用索引获取内容了</span></span><br><span class="line">data[<span class="number">0</span>][<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">data[<span class="number">0</span>].get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">data[<span class="number">0</span>].get(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;jack&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>获取键值推荐使用 get 方法，如果键名不存在不会报错，返回None，get 方法还可以传入第二个参数（默认值）</p>
<p>下面实现从 JSON 文本中读取内容</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;data.json&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">  <span class="built_in">str</span> = file.read()</span><br><span class="line">  data = json.loads(<span class="built_in">str</span>)</span><br><span class="line">  print(data)</span><br></pre></td></tr></table></figure>

<p>更简便的写法，直接使用 load 方法传入文件操作对象</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line">data = json.load(<span class="built_in">open</span>(<span class="string">&#x27;data.json&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">print(data)</span><br></pre></td></tr></table></figure>

<h5 id="输出JSON"><a href="#输出JSON" class="headerlink" title="输出JSON"></a>输出JSON</h5><p>将JSON对象转为字符串，写入文本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">data = [&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Bob&#x27;</span>&#125;, &#123;<span class="string">&#x27;gender&#x27;</span>: <span class="string">&#x27;male&#x27;</span>&#125;]</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;data.json&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">  file.write(json.dumps(data))</span><br></pre></td></tr></table></figure>

<p>如果想保存JSON格式，再加一个参数 indent，代表缩进字符个数</p>
<p>输出中文，加参数 ensure_ascii 为 False</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">file.write(json.dumps(data, indent=<span class="number">2</span>, ensure_ascii=<span class="literal">False</span>))</span><br></pre></td></tr></table></figure>

<p>类比 loads 和 load 方法，dumps 同样也有 dump 方法，可以直接将 JSON 对象全部写入文件</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">json.dump(data, <span class="built_in">open</span>(<span class="string">&#x27;data.json&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>), indent=<span class="number">2</span>, ensure_ascii=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>



<h4 id="4-3-CSV-文件存储"><a href="#4-3-CSV-文件存储" class="headerlink" title="4.3 CSV 文件存储"></a>4.3 CSV 文件存储</h4><p>逗号分隔值或字符分隔值，文件以纯文本形式存储表格数据</p>
<h5 id="写入"><a href="#写入" class="headerlink" title="写入"></a>写入</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;data.csv&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> csvfile:</span><br><span class="line">    writer = csv.writer(csvfile)</span><br><span class="line">    writer.writerow([<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;age&#x27;</span>])</span><br><span class="line">    writer.writerow([<span class="string">&#x27;10001&#x27;</span>, <span class="string">&#x27;Mike&#x27;</span>, <span class="string">&#x27;20&#x27;</span>])</span><br><span class="line">    writer.writerow([<span class="string">&#x27;10002&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;21&#x27;</span>])</span><br><span class="line">    writer.writerow([<span class="string">&#x27;10003&#x27;</span>, <span class="string">&#x27;Jack&#x27;</span>, <span class="string">&#x27;22&#x27;</span>])</span><br></pre></td></tr></table></figure>

<p>首先打开 data.csv 文件，模式为 w 写入，调用 csv 库的 writer 方法初始化写入对象，调用 writerow() 方法传入写入的每行数据</p>
<p>以文本方式打开，写入的文本默认以逗号分隔</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">id</span>,name,age</span><br><span class="line"><span class="number">10001</span>,Mike,<span class="number">20</span></span><br><span class="line"><span class="number">10002</span>,Bob,<span class="number">21</span></span><br><span class="line"><span class="number">10003</span>,Jack,<span class="number">22</span></span><br></pre></td></tr></table></figure>

<p>也可以用 Excel 打开，每个值对应一个单元格</p>
<p>可以指定分隔符号</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">writer = csv.writer(csvfile,delimiter=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line"><span class="comment">#文本方式打开</span></span><br><span class="line"><span class="built_in">id</span> name age</span><br><span class="line"><span class="number">10001</span> Mike <span class="number">20</span></span><br><span class="line"><span class="number">10002</span> Bob <span class="number">21</span></span><br><span class="line"><span class="number">10003</span> Jack <span class="number">22</span></span><br></pre></td></tr></table></figure>

<p>Excel 打开只有一个单元格显示所有值了</p>
<p>writerrows() 写入多行，参数需要二维列表</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">writer = csv.writer(csvfile)</span><br><span class="line">writer.writerow([<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;age&#x27;</span>])</span><br><span class="line">writer.writerows([[<span class="string">&#x27;10001&#x27;</span>, <span class="string">&#x27;Mike&#x27;</span>, <span class="string">&#x27;20&#x27;</span>],[<span class="string">&#x27;10002&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;21&#x27;</span>],[<span class="string">&#x27;10003&#x27;</span>, <span class="string">&#x27;Jack&#x27;</span>, <span class="string">&#x27;22&#x27;</span>]])</span><br></pre></td></tr></table></figure>

<ul>
<li>字典的写入方式</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;data.csv&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> csvfile:</span><br><span class="line">    fieldnames = [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;age&#x27;</span>]</span><br><span class="line">    writer = csv.DictWriter(csvfile, fieldnames=fieldnames)</span><br><span class="line">    writer.writeheader() <span class="comment">#写入头信息</span></span><br><span class="line">    writer.writerow(&#123;<span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;10001&#x27;</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Mike&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">20</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>如果要写入中文内容，需要给 open 参数指定编码格式</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;data.csv&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>pandas 库写入cvs</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">data = [</span><br><span class="line">  &#123;<span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;10001&#x27;</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Mkie&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">20</span>&#125;,</span><br><span class="line">  &#123;<span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;10002&#x27;</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">22</span>&#125;,</span><br><span class="line">]</span><br><span class="line">df = pd.DataFrame(data)</span><br><span class="line">df.to_csv(<span class="string">&#x27;data.csv&#x27;</span>, index=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>df 的 to_csv 方法也可将数据保存为 CSV 文件</p>
<h5 id="读取"><a href="#读取" class="headerlink" title="读取"></a>读取</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;data.csv&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> csvfile:</span><br><span class="line">    reader = csv.reader(csvfile)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> reader:</span><br><span class="line">        print(row)</span><br></pre></td></tr></table></figure>

<p>构造 Reader 对象，遍历输出每行内容，每行都是一个列表形式</p>
<ul>
<li>pandas 库读取 cvs</li>
</ul>
<p>利用 read_csv 方法将数据从 csv 中读取出来</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;data.csv&#x27;</span>)</span><br><span class="line">print(df)</span><br></pre></td></tr></table></figure>

<p>如果指向读取文件里面的数据，可以把 df 再进一步转化为列表或者元组</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">data = df.values.tolist()</span><br></pre></td></tr></table></figure>

<p>直接对 df 进行逐行遍历，同样能得到列表类型的结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df = pd.read_csv(<span class="string">&#x27;data.csv&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> index, row <span class="keyword">in</span> df.iterrows():</span><br><span class="line">  print(row.tolist())</span><br></pre></td></tr></table></figure>





<h4 id="关系型数据库存储"><a href="#关系型数据库存储" class="headerlink" title="关系型数据库存储"></a>关系型数据库存储</h4><p>基于关系模型的数据库，关系模型是通过二维表来保存的，存储方式是行列组成的表</p>
<h4 id="4-4-MySQL-存储"><a href="#4-4-MySQL-存储" class="headerlink" title="4.4 MySQL 存储"></a>4.4 MySQL 存储</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line">db = pymysql.connect(host=<span class="string">&#x27;localhost&#x27;</span>,user=<span class="string">&#x27;root&#x27;</span>,password=<span class="string">&#x27;12345678&#x27;</span>,port=<span class="number">3306</span>)</span><br><span class="line">cursor = db.cursor()</span><br><span class="line">cursor.execute(<span class="string">&#x27;SELECT VERSION()&#x27;</span>)</span><br><span class="line">data = cursor.fetchone() //获取第一条数据</span><br><span class="line">print(<span class="string">&#x27;Database version:&#x27;</span>, data)</span><br><span class="line">cursor.execute(<span class="string">&#x27;CREATE DATABASE spiders DEFAULT CHARACTER SET utf8&#x27;</span>)</span><br><span class="line">db.close()</span><br></pre></td></tr></table></figure>

<p>通过 PyMySQL 的 connect() 方法声明一个 MySQL 连接对象 db，端口默认 3306</p>
<p>连接成功后需要调用 cursor 获得 MySQL 的操作游标，利用游标来执行 SQL语句，直接用 execute() 方法来执行</p>
<p>fetchone 方法来获得第一条数据</p>
<p>第二句创建数据库的操作，数据库名 spiders，默认编码 UTF-8</p>
<p>终端登录数据库 mysql -uroot -p</p>
<p>show databases; 查询创建成功的数据库</p>
<h5 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h5><p>创建了数据库后，连接时需要额外参数 db</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">db = pymysql.connect(host=<span class="string">&#x27;localhost&#x27;</span>,user=<span class="string">&#x27;root&#x27;</span>,password=<span class="string">&#x27;12345678&#x27;</span>,port=<span class="number">3306</span>,db=<span class="string">&#x27;spiders&#x27;</span>)</span><br><span class="line">cursor = db.cursor()</span><br><span class="line">sql = <span class="string">&#x27;CREATE TABLE IF NOT EXISTS students (id VARCHAR(255) NOT NULL, name VARCHAR(255) NOT NULL, age INT NOT NULL, PRIMARY KEY (id))&#x27;</span></span><br><span class="line">cursor.execute(sql)</span><br><span class="line">db.close()</span><br></pre></td></tr></table></figure>

<h5 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">id</span> = <span class="string">&#x27;20120001&#x27;</span></span><br><span class="line">user = <span class="string">&#x27;Bob&#x27;</span></span><br><span class="line">age = <span class="number">20</span></span><br><span class="line">db = pymysql.connect(host=<span class="string">&#x27;localhost&#x27;</span>,user=<span class="string">&#x27;root&#x27;</span>,password=<span class="string">&#x27;12345678&#x27;</span>,port=<span class="number">3306</span>,db=<span class="string">&#x27;spiders&#x27;</span>)</span><br><span class="line">cursor = db.cursor()</span><br><span class="line">sql = <span class="string">&#x27;INSERT INTO students(id, name, age) values(%s, %s, %s)&#x27;</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    cursor.execute(sql, (<span class="built_in">id</span>, user, age))</span><br><span class="line">    db.commit()<span class="comment">#插入、更新、删除 都需要commit</span></span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    db.rollback()<span class="comment">#执行失败回滚</span></span><br><span class="line">db.close()</span><br></pre></td></tr></table></figure>

<p>优化插入方法</p>
<p>实现传入一个字典来插入数据的方法，这样增加字段后就不需要去修改SQL语句和插入操作</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">db = pymysql.connect(host=<span class="string">&#x27;localhost&#x27;</span>, user=<span class="string">&#x27;root&#x27;</span>, password=<span class="string">&#x27;12345678&#x27;</span>, port=<span class="number">3306</span>, db=<span class="string">&#x27;spiders&#x27;</span>)</span><br><span class="line">cursor = db.cursor()</span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;20120003&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Bob1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;age&#x27;</span>: <span class="number">20</span></span><br><span class="line">&#125;</span><br><span class="line">table = <span class="string">&#x27;students&#x27;</span></span><br><span class="line">keys = <span class="string">&#x27;,&#x27;</span>.join(data.keys()) <span class="comment">#id,user,age</span></span><br><span class="line">values = <span class="string">&#x27;,&#x27;</span>.join([<span class="string">&#x27;%s&#x27;</span>] * <span class="built_in">len</span>(data))</span><br><span class="line">sql = <span class="string">f&#x27;INSERT INTO <span class="subst">&#123;table&#125;</span>(<span class="subst">&#123;keys&#125;</span>) VALUES(<span class="subst">&#123;values&#125;</span>)&#x27;</span>.<span class="built_in">format</span>(table=table, keys=keys, values=values)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">if</span> cursor.execute(sql, <span class="built_in">tuple</span>(data.values())):</span><br><span class="line">        print(<span class="string">&#x27;Success&#x27;</span>)</span><br><span class="line">        db.commit()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    db.rollback()</span><br><span class="line">    print(<span class="string">&#x27;Failed&#x27;</span>)</span><br><span class="line">db.close()</span><br></pre></td></tr></table></figure>

<h5 id="更新数据"><a href="#更新数据" class="headerlink" title="更新数据"></a>更新数据</h5><p>如果数据存在，则更新数据，如果数据不存在，则插入数据</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">db = pymysql.connect(host=<span class="string">&#x27;localhost&#x27;</span>, user=<span class="string">&#x27;root&#x27;</span>, password=<span class="string">&#x27;12345678&#x27;</span>, port=<span class="number">3306</span>, db=<span class="string">&#x27;spiders&#x27;</span>)</span><br><span class="line">cursor = db.cursor()</span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;20120003&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Bob1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;age&#x27;</span>: <span class="number">24</span></span><br><span class="line">&#125;</span><br><span class="line">table = <span class="string">&#x27;students&#x27;</span></span><br><span class="line">keys = <span class="string">&#x27;,&#x27;</span>.join(data.keys()) <span class="comment">#id,user,age</span></span><br><span class="line">values = <span class="string">&#x27;,&#x27;</span>.join([<span class="string">&#x27;%s&#x27;</span>] * <span class="built_in">len</span>(data))</span><br><span class="line">sql = <span class="string">f&#x27;INSERT INTO <span class="subst">&#123;table&#125;</span>(<span class="subst">&#123;keys&#125;</span>) VALUES (<span class="subst">&#123;values&#125;</span>) ON DUPLICATE KEY UPDATE&#x27;</span>.<span class="built_in">format</span>(table=table,keys=keys,values=values)</span><br><span class="line">update = <span class="string">&#x27;,&#x27;</span>.join([<span class="string">&quot; &#123;key&#125; = %s&quot;</span>.<span class="built_in">format</span>(key = key) <span class="keyword">for</span> key <span class="keyword">in</span> data])</span><br><span class="line">sql+=update</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">if</span> cursor.execute(sql, <span class="built_in">tuple</span>(data.values())*<span class="number">2</span>):</span><br><span class="line">        print(<span class="string">&#x27;Success&#x27;</span>)</span><br><span class="line">        db.commit()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    db.rollback()</span><br><span class="line">    print(<span class="string">&#x27;Failed&#x27;</span>)</span><br><span class="line">db.close()</span><br><span class="line"><span class="comment">#INSERT INTO students(id,name,age) VALUES (%s,%s,%s) ON DUPLICATE KEY UPDATEid = %s,name = %s,age = %s</span></span><br></pre></td></tr></table></figure>

<p>ON DUPLICATE KEY UPDATE 主键已存在就执行更新操作</p>
<h5 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">db = pymysql.connect(host=<span class="string">&#x27;localhost&#x27;</span>, user=<span class="string">&#x27;root&#x27;</span>, password=<span class="string">&#x27;12345678&#x27;</span>, port=<span class="number">3306</span>, db=<span class="string">&#x27;spiders&#x27;</span>)</span><br><span class="line">cursor = db.cursor()</span><br><span class="line">table = <span class="string">&#x27;students&#x27;</span></span><br><span class="line">condition = <span class="string">&#x27;age &gt; 22&#x27;</span></span><br><span class="line">sql = <span class="string">f&#x27;DELETE FROM <span class="subst">&#123;table&#125;</span> WHERE <span class="subst">&#123;condition&#125;</span>&#x27;</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    cursor.execute(sql)</span><br><span class="line">    db.commit()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    db.rollback()</span><br><span class="line">db.close()</span><br></pre></td></tr></table></figure>

<h5 id="查询数据"><a href="#查询数据" class="headerlink" title="查询数据"></a>查询数据</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">db = pymysql.connect(host=<span class="string">&#x27;localhost&#x27;</span>, user=<span class="string">&#x27;root&#x27;</span>, password=<span class="string">&#x27;12345678&#x27;</span>, port=<span class="number">3306</span>, db=<span class="string">&#x27;spiders&#x27;</span>)</span><br><span class="line">cursor = db.cursor()</span><br><span class="line">sql = <span class="string">&#x27;SELECT * FROM students WHERE age &gt; 18&#x27;</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    cursor.execute(sql)</span><br><span class="line">    print(<span class="string">&#x27;Count:&#x27;</span>, cursor.rowcount) <span class="comment">#查询结果条数 总共2条</span></span><br><span class="line">    one = cursor.fetchone() </span><br><span class="line">    print(<span class="string">&#x27;One:&#x27;</span>, one) <span class="comment">#获取结果第一条</span></span><br><span class="line">    results = cursor.fetchall() <span class="comment">#获取到剩下的1条 按指针偏移查找的 fetchone 已取了一条</span></span><br><span class="line">    print(<span class="string">&#x27;Result Type:&#x27;</span>, <span class="built_in">type</span>(results))</span><br><span class="line">    print(<span class="string">&#x27;Results:&#x27;</span>, results)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> results:</span><br><span class="line">        print(row)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    db.rollback()</span><br><span class="line">db.close()</span><br><span class="line"><span class="comment">#结果</span></span><br><span class="line">Count: <span class="number">2</span></span><br><span class="line">One: (<span class="string">&#x27;20120001&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>, <span class="number">20</span>)</span><br><span class="line">Result Type: &lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">tuple</span>&#x27;&gt;</span></span><br><span class="line"><span class="class"><span class="title">Results</span>:</span> ((<span class="string">&#x27;20120002&#x27;</span>, <span class="string">&#x27;Jack&#x27;</span>, <span class="number">22</span>),)</span><br><span class="line">(<span class="string">&#x27;20120002&#x27;</span>, <span class="string">&#x27;Jack&#x27;</span>, <span class="number">22</span>)</span><br></pre></td></tr></table></figure>

<p>还可以用 while 循环加 fetchone 方法获取所有数据</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">row = cursor.fetchone()</span><br><span class="line"><span class="keyword">while</span> row:</span><br><span class="line">  print(<span class="string">&#x27;Row:&#x27;</span>, row)</span><br><span class="line">  row = cursor.fetchone()<span class="comment">#每循环一次 指针就会偏移一条数据</span></span><br></pre></td></tr></table></figure>

<h4 id="非关系型数据库"><a href="#非关系型数据库" class="headerlink" title="非关系型数据库"></a>非关系型数据库</h4><p>基于键值对的，数据之间没有耦合性，性能高</p>
<p>文档型数据库：MongoDB</p>
<p>键值存储数据库：Redis、Oracle BDB</p>
<h4 id="4-5-MongoDB-存储"><a href="#4-5-MongoDB-存储" class="headerlink" title="4.5 MongoDB 存储"></a>4.5 MongoDB 存储</h4><p>基于分布式文件存储的开源数据库系统，内容存储形式类似 JSON 对象，字段值可以包含其它文档、数组及文档数组</p>
<h5 id="连接-MongoDB"><a href="#连接-MongoDB" class="headerlink" title="连接 MongoDB"></a>连接 MongoDB</h5><p>使用 PyMongo 库里的 MongoClient，第一个参数地址 host，第二个参数为端口默认27017</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pymongo</span><br><span class="line">client = pymongo.MongoClient(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">27017</span>)</span><br><span class="line"><span class="comment">#第一个参数host还可传入MongoDB的连接字符串，以mongodb开头</span></span><br><span class="line">client = MongoClient(<span class="string">&#x27;mongodb://localhost:27017/&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pymongo <span class="keyword">import</span> MongoClient</span><br><span class="line">client = MongoClient(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">27017</span>)</span><br></pre></td></tr></table></figure>

<p>这样就创建 MongoDB 的连接对象了</p>
<h5 id="指定数据库"><a href="#指定数据库" class="headerlink" title="指定数据库"></a>指定数据库</h5><p>指定操作哪个数据库</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">db = client.test <span class="comment">#调用client的test即可返回test数据库</span></span><br><span class="line"><span class="comment">#也可以</span></span><br><span class="line">db = client[<span class="string">&#x27;test&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h5 id="指定集合"><a href="#指定集合" class="headerlink" title="指定集合"></a>指定集合</h5><p>MongoDB的每个数据库又包含许多集合，类似关系型数据库中的表</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">collection &#x3D; db.students</span><br><span class="line">collection &#x3D; db[&#39;students&#39;]</span><br></pre></td></tr></table></figure>

<h5 id="插入数据-1"><a href="#插入数据-1" class="headerlink" title="插入数据"></a>插入数据</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">student1 = &#123;</span><br><span class="line">    <span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;2017002&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Bob2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;age&#x27;</span>: <span class="number">20</span>,</span><br><span class="line">    <span class="string">&#x27;gender&#x27;</span>: <span class="string">&#x27;male&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">student2 = &#123;</span><br><span class="line">    <span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;2017003&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Bob3&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;age&#x27;</span>: <span class="number">20</span>,</span><br><span class="line">    <span class="string">&#x27;gender&#x27;</span>: <span class="string">&#x27;male&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">client = pymongo.MongoClient(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">27017</span>)</span><br><span class="line">db = client.tests</span><br><span class="line">collection = db.students</span><br><span class="line">result = collection.insert_one(student1) <span class="comment">#单条插入</span></span><br><span class="line">result = collection.insert_many([student1, student2]) <span class="comment">#多条插入</span></span><br><span class="line">print(result)</span><br><span class="line">print(result.inserted_ids)</span><br></pre></td></tr></table></figure>

<p>MongoDB 中每条数据都有一个 _id 属性作为唯一标识，如果没有显式指明该属性，那么 MongoDB 会自动产生一个 ObjectId 类型的 _id 属性</p>
<h5 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h5><p>find_one()</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result = collection.find_one(&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Bob&#x27;</span>&#125;) <span class="comment">#查询name为Bob的数据</span></span><br><span class="line">print(result)</span><br><span class="line"><span class="comment">#结果</span></span><br><span class="line">&#123;<span class="string">&#x27;_id&#x27;</span>: ObjectId(<span class="string">&#x27;62554aac23dcb7329838bd6b&#x27;</span>), <span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;2017001&#x27;</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">20</span>, <span class="string">&#x27;gender&#x27;</span>: <span class="string">&#x27;male&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>多了个_id属性 ，也可跟进 ObjectId来查询，如果查询结果不存在返回 None</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> bson.objectid <span class="keyword">import</span> ObjectId</span><br><span class="line">result = collection.find_one(&#123;<span class="string">&#x27;_id&#x27;</span>: ObjectId(<span class="string">&#x27;62554aac23dcb7329838bd6b&#x27;</span>)&#125;)</span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>

<p>find()</p>
<p>多条数据查询 find() 返回一个生成器</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result = collection.find(&#123;<span class="string">&#x27;age&#x27;</span>: <span class="number">20</span>&#125;)<span class="comment">#查询年龄20数据</span></span><br><span class="line">result = collection.find(&#123;<span class="string">&#x27;age&#x27;</span>: &#123;<span class="string">&#x27;$gt&#x27;</span>: <span class="number">20</span>&#125;&#125;) <span class="comment">#年龄大于20数据</span></span><br></pre></td></tr></table></figure>

<ul>
<li>比较符号</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$lt 小于 $gt大于 $lte小于等于 $gte大于等于 $ne不等于 $in 在范围内 $nin 不在范围内</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">&#x27;age&#x27;</span>: &#123;<span class="string">&#x27;$in&#x27;</span>: [<span class="number">20</span>, <span class="number">33</span>]&#125;&#125;</span><br><span class="line">&#123;<span class="string">&#x27;age&#x27;</span>: &#123;<span class="string">&#x27;$nin&#x27;</span>: [<span class="number">20</span>, <span class="number">33</span>]&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>还可进行正则匹配查询，如 以M开头的学生数据</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result = connection.find(&#123;<span class="string">&#x27;name&#x27;</span>: &#123;<span class="string">&#x27;$regex&#x27;</span>: <span class="string">&#x27;^M.*&#x27;</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#$regex 匹配正则表达式 </span></span><br><span class="line">&#123;<span class="string">&#x27;name&#x27;</span>: &#123;<span class="string">&#x27;$regex&#x27;</span>: <span class="string">&#x27;^M.*&#x27;</span>&#125;&#125;</span><br><span class="line"><span class="comment">#$exists 属性是否存在 </span></span><br><span class="line">&#123;<span class="string">&#x27;name&#x27;</span>: &#123;<span class="string">&#x27;$exists&#x27;</span>: <span class="string">&#x27;True&#x27;</span>&#125;&#125;</span><br><span class="line"><span class="comment">#$type 类型判断</span></span><br><span class="line">&#123;<span class="string">&#x27;name&#x27;</span>: &#123;<span class="string">&#x27;$type&#x27;</span>: <span class="string">&#x27;int&#x27;</span>&#125;&#125;</span><br><span class="line"><span class="comment">#$mod 数字模操作</span></span><br><span class="line">&#123;<span class="string">&#x27;name&#x27;</span>: &#123;<span class="string">&#x27;$mod&#x27;</span>: [<span class="number">5</span>, <span class="number">0</span>]&#125;&#125;</span><br><span class="line"><span class="comment">#$text 文本查询</span></span><br><span class="line">&#123;<span class="string">&#x27;name&#x27;</span>: &#123;<span class="string">&#x27;$text&#x27;</span>: <span class="string">&#x27;Mike&#x27;</span>&#125;&#125; <span class="comment">#text类型的属性中包含Mike字符串</span></span><br><span class="line"><span class="comment">#$where 高级条件查询 </span></span><br><span class="line">&#123;<span class="string">&#x27;name&#x27;</span>: &#123;<span class="string">&#x27;$where&#x27;</span>: <span class="string">&#x27;^M.*&#x27;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>更详细 <a href="https://docs.mongodb.com/manual/reference/operator/query">https://docs.mongodb.com/manual/reference/operator/query</a></p>
<h5 id="计数"><a href="#计数" class="headerlink" title="计数"></a>计数</h5><p>统计查询结果有多少条，count()</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">count = collection.find().count()</span><br><span class="line"><span class="comment">#或者统计符合某个条件的数据</span></span><br><span class="line">count = collection.find(&#123;<span class="string">&#x27;age&#x27;</span>: <span class="number">20</span>&#125;).count</span><br></pre></td></tr></table></figure>

<h5 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h5><p>sort() 方法，其中传入排序的字段及升降序标志即可</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">results = collection.find().sort(<span class="string">&#x27;name&#x27;</span>, pymongo.ASCENDING)</span><br><span class="line">print([result[<span class="string">&#x27;name&#x27;</span>] <span class="keyword">for</span> result <span class="keyword">in</span> results])</span><br><span class="line"><span class="comment">#降序 pymongo.DESCENDING</span></span><br></pre></td></tr></table></figure>

<h5 id="偏移"><a href="#偏移" class="headerlink" title="偏移"></a>偏移</h5><p>只想取某几个元素，利用 skip() 方法偏移几个位置，比如偏移 2 就忽略前两个元素，得到第3个元素</p>
<p>还可利用 limit() 方法限制返回个数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">results = collection.find().sort(<span class="string">&#x27;name&#x27;</span>, pymongo.ASCENDING).skip(<span class="number">2</span>)</span><br><span class="line">results = collection.find().sort(<span class="string">&#x27;name&#x27;</span>, pymongo.ASCENDING).skip(<span class="number">2</span>).limit(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<h5 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h5><p>update() 方法，指定更新的条件和更新后的数据即可</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">collection = &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Kevin&#x27;</span>&#125;</span><br><span class="line">student = collection.find_one(condition)</span><br><span class="line">student[<span class="string">&#x27;age&#x27;</span>] = <span class="number">25</span></span><br><span class="line">result = collection.update(collection, student)</span><br><span class="line">print(result) <span class="comment">#&#123;&#x27;ok&#x27;:1,&#x27;nModified&#x27;: 1,&#x27;n&#x27;:1,&#x27;updateExisting&#x27;: True&#125;</span></span><br><span class="line"><span class="comment">#先将数据查询出来，修改年龄，调用update更新</span></span><br></pre></td></tr></table></figure>

<p>也可用 $set 操作符更新</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result = collection.update(condition, &#123;<span class="string">&#x27;$set&#x27;</span>: student&#125;)</span><br></pre></td></tr></table></figure>

<p>官方推荐使用 update_noe 和 update_many 方法处理单条和多条数据更新，第二个参数需要传 <code>&#123;&#39;$set&#39;: student&#125;</code> 形式数据</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result = collection.update_one(condition, &#123;<span class="string">&#x27;$set&#x27;</span>: student&#125;)</span><br><span class="line">print(result.matched_count, result.modified_count) </span><br></pre></td></tr></table></figure>

<p>指定查询条件为age大于20，更新条件是age加1，就是对第一条符合条件的学生数据age加1</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">condition = &#123;<span class="string">&#x27;age&#x27;</span>: &#123;<span class="string">&#x27;$gt&#x27;</span>:<span class="number">20</span>&#125;&#125;</span><br><span class="line">result = collection.update_one(condition, &#123;<span class="string">&#x27;$inc&#x27;</span>: &#123;<span class="string">&#x27;age&#x27;</span>:<span class="number">1</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>upsert 参数</li>
</ul>
<p>upsert 设置 True，就可以实现存在即更新，不存在即插入的功能，更新时会参照第一个参数设置的 name 字段</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_data</span>(<span class="params">data</span>):</span></span><br><span class="line">	collection.update_one(&#123;</span><br><span class="line">		<span class="string">&#x27;name&#x27;</span>: data.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">	&#125;,&#123;<span class="string">&#x27;$set&#x27;</span>: data&#125;, upsert: <span class="literal">True</span>)</span><br></pre></td></tr></table></figure>



<h5 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h5><p>delete_one()、 delete_many()</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result = collection.delete_one(&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Kevin&#x27;</span>&#125;)</span><br><span class="line">result = collection.delete_many(<span class="string">&#x27;age&#x27;</span>: &#123;<span class="string">&#x27;$lt&#x27;</span>: <span class="number">25</span>&#125;)</span><br><span class="line">print(result.delete_count) <span class="comment">#删除数据条数</span></span><br></pre></td></tr></table></figure>

<h5 id="其它操作"><a href="#其它操作" class="headerlink" title="其它操作"></a>其它操作</h5><p>find_one_and_delete、find_one_and_replace、find_one_and_update</p>
<h5 id="异步存储"><a href="#异步存储" class="headerlink" title="异步存储"></a>异步存储</h5><p>要实现 MongoDB 异步存储，离不开异步实现的 MongoDB 存储库 motor</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install motor</span><br></pre></td></tr></table></figure>

<p>motor 的连接声明和 pymongo 类似</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> motor.motor_asyncio <span class="keyword">import</span> AsyncIOMotorClient</span><br><span class="line">MONGO_CONNECTION_STRING = <span class="string">&#x27;mongodb://localhost:27017&#x27;</span></span><br><span class="line">MONGO_DB_NAME = <span class="string">&#x27;books&#x27;</span></span><br><span class="line">MONGO_COLLECTION_NAME = <span class="string">&#x27;books&#x27;</span></span><br><span class="line"></span><br><span class="line">client = AsyncIOMotorClient(MONGO_CONNECTION_STRING)</span><br><span class="line">db = client[MONGO_DB_NAME]</span><br><span class="line">collection = db[MONGO_COLLECTION_NAME]</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">save_data</span>(<span class="params">data</span>):</span></span><br><span class="line">  <span class="keyword">if</span> data:</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> collection.update_one(&#123;</span><br><span class="line">      <span class="string">&#x27;id&#x27;</span>: data.get(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">    &#125;,&#123;</span><br><span class="line">      <span class="string">&#x27;$set&#x27;</span>: data</span><br><span class="line">    &#125;, upsert=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>



<h4 id="4-6-Redis-存储"><a href="#4-6-Redis-存储" class="headerlink" title="4.6 Redis 存储"></a>4.6 Redis 存储</h4><p>基于内存的高效的键值型非关系型数据库</p>
<p>redis-py 库提供两个类 Redis 和 StrictRedis 来实现 Redis 的命令操作</p>
<p>官方推荐使用 StrictRedis</p>
<h5 id="连接Redis"><a href="#连接Redis" class="headerlink" title="连接Redis"></a>连接Redis</h5><p>先在本地安装好 Redis，并运行在6379端口</p>
<p>启动服务</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">redis-server</span><br></pre></td></tr></table></figure>

<p>连接Redis并测试</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> StrictRedis</span><br><span class="line"><span class="comment">#不传的话这就是4个默认参数</span></span><br><span class="line">redis = StrictRedis(host=<span class="string">&#x27;localhost&#x27;</span>,port=<span class="number">6379</span>,db=<span class="number">0</span>,password=<span class="literal">None</span>)</span><br><span class="line">redis.<span class="built_in">set</span>(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>)</span><br><span class="line">print(redis.get(<span class="string">&#x27;name&#x27;</span>))</span><br><span class="line"><span class="comment">#能打印 b&#x27;Bob&#x27; 说明连接成功，并可执行set()和get()操作了</span></span><br></pre></td></tr></table></figure>

<p>也可用ConnectionPool来测试</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> StrictRedis,ConnectionPool</span><br><span class="line">pool = ConnectionPool(host=<span class="string">&#x27;localhost&#x27;</span>,port=<span class="number">6379</span>,db=<span class="number">0</span>,password=<span class="literal">None</span>)</span><br><span class="line">redis = StrictRedis(connection_pool=pool)</span><br><span class="line"><span class="comment">#公网访问</span></span><br><span class="line">pool = ConnectionPool(host=<span class="string">&#x27;120.79.222.153&#x27;</span>,port=<span class="number">6379</span>,db=<span class="number">0</span>,password=<span class="literal">None</span>)</span><br></pre></td></tr></table></figure>

<p>ConnectionPool 还支持通过 URL 来构建</p>
<p>URL 支持的格式有3种</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="comment">#创建Redis TCP连接 Redis+SSL连接 Redis UNIX socket连接</span></span><br><span class="line">redis://[:password]@host:port/db </span><br><span class="line">rediss://[:password]@host:port/db</span><br><span class="line">unix://[:password]@/path/to/socket.sock?db=db</span><br></pre></td></tr></table></figure>

<p>password 部分有则可以写，没有可以省略</p>
<p>使用第一种连接字符串进行连接</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">url = <span class="string">&#x27;redis://@localhost:6379/0&#x27;</span></span><br><span class="line">pool = ConnectionPool.from_url(url)</span><br><span class="line">redis = StrictRedis(connection_pool=pool)</span><br><span class="line">print(redis.get(<span class="string">&#x27;name&#x27;</span>))</span><br></pre></td></tr></table></figure>

<h5 id="键操作"><a href="#键操作" class="headerlink" title="键操作"></a>键操作</h5><p>键的一些判断和操作方法</p>
<h5 id="字符串操作"><a href="#字符串操作" class="headerlink" title="字符串操作"></a>字符串操作</h5><p>Redis支持最基本的键值对形式存储</p>
<h5 id="列表操作"><a href="#列表操作" class="headerlink" title="列表操作"></a>列表操作</h5><p>Redis 还提供了列表存储，列表内的元素可以重复，而且可以从两端存储</p>
<h5 id="集合操作"><a href="#集合操作" class="headerlink" title="集合操作"></a>集合操作</h5><p>还提供了集合存储，集合中的元素都是不重复的</p>
<h5 id="有序集合操作"><a href="#有序集合操作" class="headerlink" title="有序集合操作"></a>有序集合操作</h5><p>有序集合比集合多了一个分数字段，利用它可以对集合中的数据进行排序</p>
<h5 id="散列操作"><a href="#散列操作" class="headerlink" title="散列操作"></a>散列操作</h5><p>Redis 还提供了散列表的数据结构，可以用name指定一个散列表的名称，表内存储了各个键值对</p>
<h5 id="Redis-Dump"><a href="#Redis-Dump" class="headerlink" title="Redis Dump"></a>Redis Dump</h5><p>提供了 Redis 数据的导入导出功能</p>
<p>redis-dump 用于导出数据</p>
<p>redis-load 用于导入数据</p>
<h5 id="redis-dump"><a href="#redis-dump" class="headerlink" title="redis-dump"></a>redis-dump</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">redis-dump -h #查看用法</span><br><span class="line">-u #代表Redis连接字符串</span><br><span class="line">-d #代表数据库代号</span><br><span class="line">-s #代表导出之后的休眠时间</span><br><span class="line">-c #代表分块大小 默认10000</span><br><span class="line">-f #代表导出时的过滤器</span><br><span class="line">-0 #代表禁用运行时的优化</span><br><span class="line">-V #显示版本</span><br><span class="line">-D #开启调试</span><br></pre></td></tr></table></figure>

<p>导出命令</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">redis-dump -u :xxpassword@localhost:6379</span><br><span class="line">#如果没有密码</span><br><span class="line">redis-dump -u localhost:6379</span><br></pre></td></tr></table></figure>

<p>运行之后可以将本地0至15号数据库的所有数据输出</p>
<p>每条数据包含6个字段，db 数据库代号，key 键名，ttl 该键值对的有效时间，type 键值类型，value 内容，size 占用空间</p>
<p>如果想输出 JSON 文件</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">redis-dump -u :xxpassword@localhost:6379 &gt; .&#x2F;redis_data.jl</span><br></pre></td></tr></table></figure>

<p>可以 -d 参数，指定某个数据库导出</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">redis-dump -u :xxpassword@localhost:6379 -d 1 &gt; .&#x2F;redis_data.jl</span><br></pre></td></tr></table></figure>

<p>-f 参数过滤，如想导出以 adsl 开头的数据</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">redis-dump -u :xxpassword@localhost:6379 -f adsl:* &gt; .&#x2F;redis_data.jl</span><br></pre></td></tr></table></figure>

<h5 id="redis-load"><a href="#redis-load" class="headerlink" title="redis-load"></a>redis-load</h5><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">redis-load --help</span><br><span class="line">-n #代表不检测UTF-8编码</span><br></pre></td></tr></table></figure>

<p>可以将 JSON 行文件导入到 Redis 数据库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt; redis_data.json redis-load -u :xxpassword@localhost:6379</span><br><span class="line">#或者</span><br><span class="line">cat redis_data.json | redis-load -u :xxpassword@localhost:6379</span><br></pre></td></tr></table></figure>



<h4 id="4-7-Elasticsearch搜索引擎存储"><a href="#4-7-Elasticsearch搜索引擎存储" class="headerlink" title="4.7 Elasticsearch搜索引擎存储"></a>4.7 Elasticsearch搜索引擎存储</h4><p>Elasticsearch 是一个开源的搜索引擎</p>
<h4 id="4-8-RabbitMQ"><a href="#4-8-RabbitMQ" class="headerlink" title="4.8 RabbitMQ"></a>4.8 RabbitMQ</h4><p>开源消息队列系统，一个消息队列中间件，实现进程间的通信</p>
<p>RabbitMQ 就是一个消息队列，我们要实现进程间通信，本质上是一个生产者-消费者模型，即一个进程作为生产者往消息队列放入消息，一个进程作为消费者监听并处理消息队列中的消息</p>
<p>声明队列：通过指定一些参数，创建消息队列</p>
<p>生产内容：生产者根据队列的连接信息连接队列，往队列中放入消息</p>
<p>消费内容：消费者根据队列的连接信息连接队列，从队列中取出消息</p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Python3网络爬虫开发实战-7JavaScript动态渲染页面爬取1</title>
    <url>/2022/10/06/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-7JavaScript%E5%8A%A8%E6%80%81%E6%B8%B2%E6%9F%93%E9%A1%B5%E9%9D%A2%E7%88%AC%E5%8F%961/</url>
    <content><![CDATA[<h4 id="7-动态渲染页面爬取"><a href="#7-动态渲染页面爬取" class="headerlink" title="7. 动态渲染页面爬取"></a>7. 动态渲染页面爬取</h4><p>Python 提供了许多模拟浏览器运行的库，如  Selenium、Splash、PyV8、Ghost 等</p>
<p>有些 Ajax 接口含有很多加密参数，难以直接找出其规律，也很难直接分析 Ajax 来抓取，可以使用模拟浏览器运行的方式来实现，不用管 Ajax 接口到底有哪些参数</p>
<h4 id="7-1-Selenium-的使用"><a href="#7-1-Selenium-的使用" class="headerlink" title="7.1 Selenium 的使用"></a>7.1 Selenium 的使用</h4><p>Selenium 是一个自动化测试工具，利用它可以驱动浏览器执行特定的动作，如点击、下拉，同时还可以获取浏览器当前呈现页面的源码，做到可见即可爬</p>
<p>需要配置好 ChromeDriver，安装好 python 的 selenium 库</p>
<h5 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h5><h5 id="声明浏览器对象"><a href="#声明浏览器对象" class="headerlink" title="声明浏览器对象"></a>声明浏览器对象</h5><p>Selenium 支持非常多浏览器，如 Chrome、Firefox等</p>
<p>初始化浏览器对象并赋值为 browser 对象</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line">browser = webdriver.Chrome()  <span class="comment">#弹出Chrome浏览器</span></span><br><span class="line">browser = webdriver.Safari()</span><br><span class="line">browser = webdriver.Firefox()</span><br></pre></td></tr></table></figure>

<h5 id="访问页面"><a href="#访问页面" class="headerlink" title="访问页面"></a>访问页面</h5><p>调用 get() 来请求页面，传入链接 URL 即可</p>
<p>如 get() 方法访问页面，打印源代码再关闭浏览器</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">browser = webdriver.Chrome()  <span class="comment">#弹出Chrome浏览器</span></span><br><span class="line">browser.get(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line">print(browser.page_source)<span class="comment">#打印源代码</span></span><br><span class="line">browser.close()</span><br></pre></td></tr></table></figure>

<h5 id="查找节点"><a href="#查找节点" class="headerlink" title="查找节点"></a>查找节点</h5><p>Selenium 可以驱动浏览器完成各种动作，如填充表单模拟点击等</p>
<h6 id="单个节点-find-element"><a href="#单个节点-find-element" class="headerlink" title="单个节点 find_element"></a>单个节点 find_element</h6><p>比如想获取百度搜索框的这个节点，查看源码找到搜索框</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">imput</span> <span class="attr">id</span>=<span class="string">&quot;kw&quot;</span> <span class="attr">name</span>=<span class="string">&quot;wd&quot;</span> <span class="attr">class</span>=<span class="string">&quot;s_ipt&quot;</span> <span class="attr">value</span> <span class="attr">maxlength</span>=<span class="string">&quot;255&quot;</span> <span class="attr">autocomplete</span>=<span class="string">&quot;off&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>接下来就是获取它了，可以通过 find_element_by_name() 根据 name 值获取，find_element_by_id() 是根据 id 获取，还有根据 XPath、CSS 选择器等获取方式</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">browser = webdriver.Chrome()  <span class="comment">#弹出Chrome浏览器</span></span><br><span class="line">browser.get(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line">input_first = browser.find_element_by_id(<span class="string">&#x27;kw&#x27;</span>)</span><br><span class="line">input_second = browser.find_element_by_class_name(<span class="string">&#x27;s_ipt&#x27;</span>)</span><br><span class="line">input_third = browser.find_element_by_name(<span class="string">&#x27;wd&#x27;</span>)</span><br><span class="line">input_forth = browser.find_element_by_xpath(<span class="string">&#x27;//*[@id=&quot;kw&quot;]&#x27;</span>)</span><br><span class="line">input_five  = browser.find_element_by_css_selector(<span class="string">&#x27;#kw&#x27;</span>)</span><br><span class="line">print(input_first, input_second, input_third, input_forth, input_five)</span><br></pre></td></tr></table></figure>

<p>返回结果都是</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&lt;selenium.webdriver.remote.webelement.WebElement (session=<span class="string">&quot;21787490d750c720cf715181e538f416&quot;</span>, element=<span class="string">&quot;b3dcf1e9-05a9-4a1c-8e83-deebd46c2413&quot;</span>)&gt; </span><br></pre></td></tr></table></figure>

<p>获取单个节点可以使用：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">find_element_by_id	find_element_by_name	find_element_by_xpath</span><br><span class="line">find_element_by_link_text	find_element_by_partial_link_text</span><br><span class="line">find_element_by_tag_name	find_element_by_class_name</span><br><span class="line">find_element_by_css_selector</span><br></pre></td></tr></table></figure>



<h6 id="通用方法-find-element"><a href="#通用方法-find-element" class="headerlink" title="通用方法 find_element"></a>通用方法 find_element</h6><p>selenium 还提供了通用的方法 find_element() ，两个参数：查找方式 By 和方式的取值</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line">input_first = browser.find_element(By.ID, <span class="string">&#x27;kw&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h6 id="多个节点-find-elements"><a href="#多个节点-find-elements" class="headerlink" title="多个节点  find_elements()"></a>多个节点  find_elements()</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">browser = webdriver.Chrome()  <span class="comment">#弹出Chrome浏览器</span></span><br><span class="line">browser.get(<span class="string">&#x27;https://www.taobao.com&#x27;</span>)</span><br><span class="line"><span class="built_in">list</span> = browser.find.elements_by_css_selector(<span class="string">&#x27;.service-bd li&#x27;</span>)</span><br><span class="line"><span class="comment">#也可直接用 find_elements() 方法来选择</span></span><br><span class="line"><span class="built_in">list</span> = browser.find_elements(By.CSS_SELECTOR, <span class="string">&#x27;.service-bd li&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h6 id="节点交互"><a href="#节点交互" class="headerlink" title="节点交互"></a>节点交互</h6><p>让浏览器执行一些动作，输入文字 send_keys()，清空文字 clear()， 点击按钮 click()</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.remote.webelement <span class="keyword">import</span> WebElement</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="built_in">input</span> = browser.find_element(By.ID, <span class="string">&#x27;kw&#x27;</span>)<span class="comment"># type: WebElement</span></span><br><span class="line"><span class="built_in">input</span>.send_keys(<span class="string">&#x27;iPhone&#x27;</span>)</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">input</span>.clear()</span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"><span class="built_in">input</span>.send_keys(<span class="string">&#x27;iPad&#x27;</span>)</span><br><span class="line">button = browser.find_element(By.ID, <span class="string">&#x27;su&#x27;</span>) <span class="comment"># type: WebElement</span></span><br><span class="line">button.click()</span><br></pre></td></tr></table></figure>

<p>驱动浏览器打开百度，输入文字，清空搜索，调用 click() 点击搜索</p>
<p>更多操作交互查看 </p>
<p><a href="https://selenium-python.readthedocs.io/api.html#module-selenium.webdriver.remote.webelement">https://selenium-python.readthedocs.io/api.html#module-selenium.webdriver.remote.webelement</a></p>
<h6 id="动作链"><a href="#动作链" class="headerlink" title="动作链"></a>动作链</h6><p>一些操作没有特定的执行对象，比如鼠标拖拽，键盘按键等，这些动作用另一种方式来执行，就是动作链</p>
<p>拖拽实例</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;iframe frameborder=&quot;0&quot; id=&quot;iframeResult&quot; style=&quot;height: 592.96px;&quot; cd_frame_id_=&quot;8cb7e7ff87254590477aee6f726ea77d&quot;&gt;&lt;/iframe&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver <span class="keyword">import</span> ActionChains</span><br><span class="line"></span><br><span class="line">browser = webdriver.Chrome()</span><br><span class="line">url = <span class="string">&#x27;http://www.runoob.com/try/try.php?filename=jqueryui-api-droppable&#x27;</span></span><br><span class="line">browser.get(url)</span><br><span class="line">browser.switch_to.frame(<span class="string">&#x27;iframeResult&#x27;</span>) <span class="comment">#切换frame</span></span><br><span class="line">source = browser.find_element_by_css_selector(<span class="string">&#x27;#draggable&#x27;</span>)<span class="comment">#拖拽节点</span></span><br><span class="line">target = browser.find_element_by_css_selector(<span class="string">&#x27;#droppable&#x27;</span>)<span class="comment">#拖拽目标节点</span></span><br><span class="line">actions = ActionChains(browser)</span><br><span class="line">actions.drag_and_drop(source, target)</span><br><span class="line">actions.perform()<span class="comment">#执行</span></span><br></pre></td></tr></table></figure>

<p>更多动作链操作</p>
<p><a href="https://selenium-python.readthedocs.io/api.html#module-selenium.webdriver.common.action_chains">https://selenium-python.readthedocs.io/api.html#module-selenium.webdriver.common.action_chains</a></p>
<h6 id="执行-JavaScript"><a href="#执行-JavaScript" class="headerlink" title="执行 JavaScript"></a>执行 JavaScript</h6><p>利用 execute_script() 将进度条下拉到最底部，然后弹窗</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">browser = webdriver.Chrome()</span><br><span class="line">browser.get(<span class="string">&#x27;https://www.zhihu.com/explore&#x27;</span>)</span><br><span class="line">browser.execute_script(<span class="string">&#x27;window.scrollTo(0, document.body.scrollHeight)&#x27;</span>)</span><br><span class="line">browser.execute_script(<span class="string">&#x27;alert(&quot;To Bottom&quot;)&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="获取节点信息"><a href="#获取节点信息" class="headerlink" title="获取节点信息"></a>获取节点信息</h5><p>前面通过 page_souce 属性获取网页源代码，接着就可以使用解析库（正则、Beautiful Soup、pyquery）等来提取信息</p>
<p>Selenium 已提供了选取节点的方法，返回 WebElement 类型，它也有相关的方法和属性来直接提取节点信息，如属性、文本等。这样就可以不用通过解析源代码来提取信息了</p>
<h6 id="获取属性"><a href="#获取属性" class="headerlink" title="获取属性"></a>获取属性</h6><p>通过 get_attribute() 方法获取节点属性，输入想要获取的属性名</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.remote.webelement <span class="keyword">import</span> WebElement</span><br><span class="line">browser = webdriver.Chrome()</span><br><span class="line">browser.get(<span class="string">&#x27;https://www.zhihu.com/explore&#x27;</span>)</span><br><span class="line">logo = browser.find_element_by_class_name(<span class="string">&#x27;ExploreHomePage-specialsLoginImg&#x27;</span>) <span class="comment"># type: WebElement</span></span><br><span class="line">print(logo)</span><br><span class="line">print(logo.get_attribute(<span class="string">&#x27;class&#x27;</span>))</span><br></pre></td></tr></table></figure>

<h6 id="获取文本值"><a href="#获取文本值" class="headerlink" title="获取文本值"></a>获取文本值</h6><p>每个 WebElement 都有 text 属性，获取到节点内部的文本信息</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">logo = browser.find_element_by_class_name(<span class="string">&#x27;ExploreHomePage-ContentSection-header&#x27;</span>) <span class="comment"># type: WebElement</span></span><br><span class="line">print(logo.text)</span><br></pre></td></tr></table></figure>

<h6 id="获取-id、位置、标签名和大小"><a href="#获取-id、位置、标签名和大小" class="headerlink" title="获取 id、位置、标签名和大小"></a>获取 id、位置、标签名和大小</h6><p>id 获取节点id，location 获取该节点在页面中相对位置，tag_name 获取标签名称，size 获取节点大小也就是宽高</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(logo.<span class="built_in">id</span>)</span><br><span class="line">print(logo.location)</span><br><span class="line">print(logo.tag_name)</span><br><span class="line">print(logo.size)</span><br></pre></td></tr></table></figure>

<h5 id="切换-Frame"><a href="#切换-Frame" class="headerlink" title="切换 Frame"></a>切换 Frame</h5><p>网页中有一种节点叫作 iframe，也就是子 Frame，相当于页面的子页面</p>
<p>Selenium 打开页面后，默认是在父级 Frame 里面操作，此时如果页面中还有子 Frame，它是不能获取到子Frame 里面的节点的，需要用 switch_to.frame() 方法来切换 Frame</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> selenium.common.exceptions <span class="keyword">import</span> NoSuchElementException</span><br><span class="line"></span><br><span class="line">browser = webdriver.Chrome()</span><br><span class="line">url = <span class="string">&#x27;http://www.runoob.com/try/try.php?filename=jqueryui-api-droppable&#x27;</span></span><br><span class="line">browser.get(url)</span><br><span class="line">browser.switch_to.frame(<span class="string">&#x27;iframeResult&#x27;</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    logo = browser.find_element_by_class_name(<span class="string">&#x27;logo&#x27;</span>)</span><br><span class="line"><span class="keyword">except</span> NoSuchElementException:</span><br><span class="line">    print(<span class="string">&#x27;No Logo&#x27;</span>)</span><br><span class="line">browser.switch_to.parent_frame()</span><br><span class="line">logo = browser.find_element_by_class_name(<span class="string">&#x27;logo&#x27;</span>)</span><br><span class="line">print(logo)</span><br><span class="line">print(logo.text)</span><br><span class="line"><span class="comment">#结果</span></span><br><span class="line">No Logo</span><br><span class="line">&lt;selenium.webdriver.remote.webelement.WebElement (session=<span class="string">&quot;020e37884ff7c4ab42f87a840d6bc616&quot;</span>, element=<span class="string">&quot;d5450a09-946b-4ace-b6b2-f3dd7c0382fd&quot;</span>)&gt;</span><br></pre></td></tr></table></figure>

<p>这里先通过 switch_to.frame 切换到子 Frame里面，尝试获取父级 Frame 里的 logo 节点（这是不能找到的）找不到抛出异常，接着切换回父级 Frame，然后再次重新获取节点，此时成功获取了</p>
<p>所以当页面中包含子 Frame 时，如果想获取子 Frame 中的节点，需要先调用 switch_to.frame 方法切换到对应的 Frame，然后再进行操作</p>
<h5 id="延时等待"><a href="#延时等待" class="headerlink" title="延时等待"></a>延时等待</h5><p>Selenium 中，get 方法会在网页框架加载结束后执行，此时如果获取 page_source，可能并不是浏览器完全加载完成的页面，有些还有额外的 Ajax 请求，需要等待一段时间，确保节点已加载出来</p>
<h6 id="隐式等待"><a href="#隐式等待" class="headerlink" title="隐式等待"></a>隐式等待</h6><p>implicitly_wait</p>
<p>如果 Selenium 没有在 DOM 中找到节点，将继续等待，超出设定时间抛出找不到节点的异常</p>
<p>当查找节点没有立即出现，隐式等待一段时间再查找DOM，默认时间0</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">browser = webdriver.Chrome()</span><br><span class="line">browser.implicitly_wait(<span class="number">10</span>) <span class="comment">#隐式等待</span></span><br><span class="line">browser.get(<span class="string">&#x27;https://www.zhihu.com/explore&#x27;</span>)</span><br><span class="line"><span class="built_in">input</span> = browser.find_element_by_class_name(<span class="string">&#x27;zu-top-add-question&#x27;</span>)</span><br><span class="line">print(<span class="built_in">input</span>)</span><br></pre></td></tr></table></figure>

<h6 id="显式等待"><a href="#显式等待" class="headerlink" title="显式等待"></a>显式等待</h6><p>指定要查找的结点，指定一个最长等待时间，规定时间内加载出来了这个节点，就返回查找节点，超过时间未找到节点抛出异常</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line">browser = webdriver.Chrome()</span><br><span class="line">browser.implicitly_wait(<span class="number">10</span>)<span class="comment"># 指定最长等待时间</span></span><br><span class="line">browser.get(<span class="string">&#x27;https://www.taobao.com/&#x27;</span>)</span><br><span class="line">wait = WebDriverWait(browser, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">input</span> = wait.until(EC.presence_of_element_located(By.ID, <span class="string">&#x27;q&#x27;</span>)) <span class="comment">#节点出现</span></span><br><span class="line">button = wait.until(EC.element_to_be_clickable(By.CSS_SELECTOR, <span class="string">&#x27;.btn-search&#x27;</span>)) <span class="comment">#节点可点击</span></span><br><span class="line">print(<span class="built_in">input</span>, button)</span><br></pre></td></tr></table></figure>

<p>引入 WebDriverWait 对象，指定最长等待时间</p>
<p>调用 until 方法，传入要等待条件 presence_of_element_located 节点出现的意思，参数是节点的定位元组，ID 为 q 的节点搜索框</p>
<p>10秒内搜索框成功加载出来，就返回该节点，超过10秒抛出异常</p>
<p>element_to_be_clickable 可点击，查按钮查找 CSS 选择器 .btn-search ，10秒内它是可点击的，也就是成功加载出来了，就返回这个按钮节点，超过10秒不可点击，也就是没有加载出来，就抛出异常</p>
<h6 id="其它等待条件"><a href="#其它等待条件" class="headerlink" title="其它等待条件"></a>其它等待条件</h6><p>比如判断标题内容，判断某个节点内是否出现了某文字等</p>
<table>
<thead>
<tr>
<th>等待条件</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>title_is</td>
<td>标题是某内容</td>
</tr>
<tr>
<td>title_contains</td>
<td>标题包含某内容</td>
</tr>
<tr>
<td>presence_of_element_loated</td>
<td>节点加载出来，传入定位元组(By.ID,’p’)</td>
</tr>
<tr>
<td>visibility_of_element_located</td>
<td>节点可见，传入定位元组</td>
</tr>
<tr>
<td>visibility_of</td>
<td>可见，传入节点对象</td>
</tr>
<tr>
<td>presence_of_all_elements_located</td>
<td>所有节点加载出来</td>
</tr>
<tr>
<td>text_to_be_present_in_element</td>
<td>某个节点文本包含某文字</td>
</tr>
<tr>
<td>text_to_be_present_in_element_value</td>
<td>某个节点值包含某文字</td>
</tr>
<tr>
<td>frame_to_be_available_and_switch_to_it</td>
<td>加载并切换</td>
</tr>
<tr>
<td>invisibility_of_element_located</td>
<td>节点不可见</td>
</tr>
<tr>
<td>element_to_be_clickable</td>
<td>节点可点击</td>
</tr>
<tr>
<td>staleness_of</td>
<td>判断一个结点是否仍在DOM，可判断页面是否已刷新</td>
</tr>
<tr>
<td>element_to_be_selected</td>
<td>节点可选择，传入节点对象</td>
</tr>
<tr>
<td>element_located_to_be_selected</td>
<td>节点可选择，传入定位元组</td>
</tr>
<tr>
<td>element_selection_state_to_be</td>
<td>传入节点对象及状态，相等返回True，否则返回False</td>
</tr>
<tr>
<td>element_located_selection_state_to_be</td>
<td>传入定位元组及状态，相等返回True，否则返回False</td>
</tr>
<tr>
<td>alert_is_present</td>
<td>是否出现警告</td>
</tr>
</tbody></table>
<p>更多等待条件的参数及用法</p>
<p> <a href="https://selenium-python.readthedocs.io/api.html#module-selenium.webdriver.support.expected_conditions">https://selenium-python.readthedocs.io/api.html#module-selenium.webdriver.support.expected_conditions</a></p>
<h5 id="前进和后退"><a href="#前进和后退" class="headerlink" title="前进和后退"></a>前进和后退</h5><p>back() 和 forward()</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">browser.back()</span><br><span class="line">browser.forward()</span><br></pre></td></tr></table></figure>

<h5 id="Cookies"><a href="#Cookies" class="headerlink" title="Cookies"></a>Cookies</h5><p>获取、添加、删除 Cookies</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(browser.get_cookie())</span><br><span class="line">browser.add_cookie(&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;name&#x27;</span>&#125;)</span><br><span class="line">browser.delete_all_cookies()</span><br></pre></td></tr></table></figure>

<h5 id="选项卡管理"><a href="#选项卡管理" class="headerlink" title="选项卡管理"></a>选项卡管理</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">browser = webdriver.Chrome()</span><br><span class="line">browser.get(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line">browser.execute_script(<span class="string">&#x27;window.open()&#x27;</span>) <span class="comment">#打开新选项卡</span></span><br><span class="line">print(browser.window_handles) <span class="comment">#打印所有选项卡</span></span><br><span class="line">browser.switch_to.window(browser.window_handles[<span class="number">1</span>]) <span class="comment">#切换选项卡</span></span><br><span class="line">browser.get(<span class="string">&#x27;https://www.zhihu.com/explore&#x27;</span>) <span class="comment">#新选项卡打开页面</span></span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">browser.switch_to.window(browser.window_handles[<span class="number">0</span>]) <span class="comment">#切换到第1个选项卡</span></span><br></pre></td></tr></table></figure>

<h5 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h5><p>try except</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.common.exceptions <span class="keyword">import</span> NoSuchElementException, TimeoutException</span><br><span class="line"></span><br><span class="line">browser = webdriver.Chrome()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">  browser.get(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line"><span class="keyword">except</span> TimeoutException:</span><br><span class="line">  print(<span class="string">&#x27;Time Out&#x27;</span>)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">  browser.find_element_by_id(<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line"><span class="keyword">except</span> NoSuchElementException:</span><br><span class="line">  print(<span class="string">&#x27;No Element&#x27;</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">  browser.close()</span><br></pre></td></tr></table></figure>

<p>更多异常类 <a href="https://selenium-python.readthedocs.io/api.html#module-selenium.common.exceptions">https://selenium-python.readthedocs.io/api.html#module-selenium.common.exceptions</a></p>
<h5 id="反屏蔽"><a href="#反屏蔽" class="headerlink" title="反屏蔽"></a>反屏蔽</h5><p>现在很多网站都增加了对 Selenium 的检测，防止一些爬虫的恶意爬取，检测到 Selenium 打开浏览器，就直接屏蔽</p>
<p>检测原理是检测当前浏览器窗口下 window.navigator 对象中是否包含 webdriver 属性，在正常使用浏览器时这个属性应该是 undefined</p>
<p><a href="https://antispider1.scrape.center/">https://antispider1.scrape.center/</a></p>
<p>Selenium 中，可以使用 CDP（Chrome 开发工具协议）解决这个问题，利用它可以实现在每个页面刚加载的时候就执行 JavaScript 语句</p>
<p>还可以加入几个选项来隐藏 WebDriver 提示条河自动化扩展信息</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver <span class="keyword">import</span> ChromeOptions</span><br><span class="line"></span><br><span class="line">option = ChromeOptions()</span><br><span class="line">option.add_experimental_option(<span class="string">&#x27;excludeSwitches&#x27;</span>, [<span class="string">&#x27;enable-automation&#x27;</span>])</span><br><span class="line">option.add_experimental_option(<span class="string">&#x27;useAutomationExtension&#x27;</span>, <span class="literal">False</span>)</span><br><span class="line">browser = webdriver.Chrome(options=option)</span><br><span class="line">browser.execute_cpd_cmd(<span class="string">&#x27;Page.addScriptToEvaluateOnNewDocument&#x27;</span>,&#123;</span><br><span class="line">  <span class="string">&#x27;source&#x27;</span>:<span class="string">&#x27;Object.defineProperty(navigator, &quot;webdriver&quot;, &#123;get:() =&gt; undefined&#125;)&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line">browser.get(<span class="string">&#x27;htttps://antispider1.scrape.center/&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="无头模式"><a href="#无头模式" class="headerlink" title="无头模式"></a>无头模式</h5><p>可以借助 ChromeOptions 对象开启 Chrome 浏览器的无头模式</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver <span class="keyword">import</span> ChromeOptions</span><br><span class="line"></span><br><span class="line">option = ChromeOptions()</span><br><span class="line">option.add_argument(<span class="string">&#x27;--headless&#x27;</span>)</span><br><span class="line">browser = webdriver.Chrome(options=option)</span><br><span class="line">browser.set_window_size(<span class="number">1366</span>,<span class="number">768</span>)</span><br><span class="line">browser.get(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line">browser.get_screenshot_as_file(<span class="string">&#x27;preview.png&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>无头模式下最好设置下窗口大小</p>
<h4 id="7-2-Splash-使用"><a href="#7-2-Splash-使用" class="headerlink" title="7.2 Splash 使用"></a>7.2 Splash 使用</h4><p>Splash Scripts Reference <a href="https://splash.readthedocs.io/en/stable/scripting-ref.html">https://splash.readthedocs.io/en/stable/scripting-ref.html</a></p>
<p>Splash 是一个 JavaScript 渲染服务，是一个带有 HTTP API 的轻量级浏览器，对接了 Python 中的 Twisted 和 QT 库，利用它同样可以动态渲染页面的抓取</p>
<ul>
<li>Splash 可以实现功能</li>
</ul>
<p>异步方式处理多个网页渲染过程</p>
<p>获取渲染后的页面的源代码或截图</p>
<p>通过关闭图片渲染或者使用 Adblock 规则来加快页面渲染速度</p>
<p>可执行特定的 JavaScript 脚本</p>
<p>可通过 Lua 脚本来控制页面渲染过程</p>
<p>获取渲染的详细过程并通过 HAR（HTTP Archive）格式呈现</p>
<h5 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h5><p>Docker 安装 Splash 后启动，本机 8050 端口运行了 Splash 服务，打开 <a href="http://localhost:8050/">http://localhost:8050</a> 可以看到 Web 页面，显示一个渲染示例，有个输入框默认 <a href="http://google.com/">http://google.com</a></p>
<p>修改成百度 <a href="https://www.baidu.com/">https://www.baidu.com</a> ，点击 Render me 测试渲染</p>
<p>可以看到网页返回结果显示了渲染截图、HAR加载统计数据、网页的源代码</p>
<p>通过 HAR 结果可以看到，Splash 执行了整个网页的渲染过程，包括 CSS、JavaScript 的加载等过程，呈现的页面和在浏览器中得到的结果一致</p>
<p>返回查看入口的脚本 </p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(splash, args)</span></span></span><br><span class="line">  <span class="built_in">assert</span>(splash:go(args.url))</span><br><span class="line">  <span class="built_in">assert</span>(splash:wait(<span class="number">0.5</span>))</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    html = splash:html(),</span><br><span class="line">    png = splash:png(),</span><br><span class="line">    har = splash:har(),</span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>这是用 Lua 语言写的脚本，首先调用 go() 方法去加载页面，然后调用 wait() 方法等待一定时间，最后返回页面的源码、截图、HAR等信息</p>
<h5 id="Splash-Lua-脚本"><a href="#Splash-Lua-脚本" class="headerlink" title="Splash Lua 脚本"></a>Splash Lua 脚本</h5><p>Splash 可以通过 Lua 脚本执行一系列渲染操作，这样就可以用 Splash 来模拟类似 Chrome、PhantomJs 的操作</p>
<h6 id="入口及返回值"><a href="#入口及返回值" class="headerlink" title="入口及返回值"></a>入口及返回值</h6><p>方法的返回值可以是字符形式或者字典形式</p>
<p>evaljs() 方法传入 JavaScript 脚本</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(splash, args)</span></span></span><br><span class="line">  splash:go(args.url)</span><br><span class="line">  splash:wait(<span class="number">0.5</span>)</span><br><span class="line">  <span class="keyword">local</span> title = splash:evaljs(<span class="string">&#x27;document.title&#x27;</span>)</span><br><span class="line">  <span class="keyword">return</span> title</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"># <span class="keyword">return</span> &#123;hello: <span class="string">&quot;world&quot;</span>&#125; </span><br><span class="line"># <span class="keyword">return</span> <span class="string">&#x27;hello&#x27;</span></span><br></pre></td></tr></table></figure>

<h6 id="异步处理"><a href="#异步处理" class="headerlink" title="异步处理"></a>异步处理</h6><p>Splash 支持异步处理，但是没有显式指明回调方法，其回调的跳转是在 Splash 内部完成</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(splash, args)</span></span></span><br><span class="line">  <span class="keyword">local</span> example_urls = &#123;<span class="string">&quot;www.baidu.com&quot;</span>, <span class="string">&quot;www.taobao.com&quot;</span>, <span class="string">&quot;www.zhihu.com&quot;</span>&#125;</span><br><span class="line">  <span class="keyword">local</span> urls = args.urls <span class="keyword">or</span> example_urls</span><br><span class="line">  <span class="keyword">local</span> results = &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> index, url <span class="keyword">in</span> <span class="built_in">ipairs</span>(urls) <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> ok, reason = splash:go(<span class="string">&quot;http://&quot;</span> .. url) #lua字符串拼接</span><br><span class="line">    <span class="keyword">if</span> ok <span class="keyword">then</span></span><br><span class="line">      splash:wait(<span class="number">2</span>)</span><br><span class="line">      results[url] = splash:png()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">return</span> results</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>go() 方法会返回加载页面的结果状态，如果返回错误 ok 变量就为空</p>
<p>Splash 执行到 wait 方法时，会转而处理其他任务，等待指定时间后再回来继续处理</p>
<p>Lua 脚本语法 <a href="http://www.runoob.com/lua/lua-basic-syntax.html">http://www.runoob.com/lua/lua-basic-syntax.html</a></p>
<h5 id="Splash-对象属性"><a href="#Splash-对象属性" class="headerlink" title="Splash 对象属性"></a>Splash 对象属性</h5><h6 id="args"><a href="#args" class="headerlink" title="args"></a>args</h6><p>该属性可以获取加载时配置的参数</p>
<p>Splash 支持将 main 方法的第二个参数直接设置为 args，第二个参数 args 就相当于 splash.args 属性，下面两个方法是等价的</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(splash, args)</span></span></span><br><span class="line">	<span class="keyword">local</span> url = args.url</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(splash)</span></span></span><br><span class="line">	<span class="keyword">local</span> url = splash.args.url</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="js-enabled"><a href="#js-enabled" class="headerlink" title="js_enabled"></a>js_enabled</h6><p>Splash 的 JavaScript 执行开关，设置为 true 或 false 来控制是否执行 JavaScript，默认开启一般不用设置</p>
<h6 id="resource-timeout"><a href="#resource-timeout" class="headerlink" title="resource_timeout"></a>resource_timeout</h6><p>设置加载超时时间，单位秒，0 或 nil 不检测超时</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">splash.resourcce_timeout = <span class="number">0.1</span></span><br></pre></td></tr></table></figure>

<h6 id="images-enabled"><a href="#images-enabled" class="headerlink" title="images_enabled"></a>images_enabled</h6><p>设置图片是否加载，默认加载，禁用后可以节省流量提高网页加载速度，禁用后可能会影响 JavaScript 渲染，因为禁用后外层DOM节点高度会受影响，进而影响 DOM 节点位置</p>
<p>Splash 使用了缓存，如果一开始加载出来了网页图片，然后禁用图片加载，重新加载页面，之前加载好的图片可能还会显示出来，重启Splash即可</p>
<h6 id="plugins-enabled"><a href="#plugins-enabled" class="headerlink" title="plugins_enabled"></a>plugins_enabled</h6><p>可以控制浏览器插件（如Flash插件）是否开启，默认 false</p>
<h6 id="scroll-postion"><a href="#scroll-postion" class="headerlink" title="scroll_postion"></a>scroll_postion</h6><p>可以控制页面上下或左右滚动</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">splash.scroll_position = &#123;y=<span class="number">400</span>&#125;</span><br><span class="line">splash.scroll_position = &#123;x=<span class="number">200</span>, y=<span class="number">400</span>&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Splash-对象的方法"><a href="#Splash-对象的方法" class="headerlink" title="Splash 对象的方法"></a>Splash 对象的方法</h5><h6 id="go"><a href="#go" class="headerlink" title="go"></a>go</h6><p>请求某个链接，可以模拟GET和POST请求，支持传入请求头、表单</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">ok, reason = splash:go&#123;url, baseurl=<span class="literal">nil</span>, headers=<span class="literal">nil</span>, http_method=<span class="string">&quot;GET&quot;</span>, body=<span class="literal">nil</span>, formdata=<span class="literal">nil</span>&#125;</span><br><span class="line"></span><br><span class="line">#baseurl 资源加载相对路径 可选</span><br><span class="line">#body POST请求时的表单数据 Content-<span class="built_in">type</span> 为 application/json</span><br><span class="line">#fordata POST请求时的表单数据 Content-<span class="built_in">type</span> 为 application/x-www-form-urlencoded</span><br></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(splash, args)</span></span></span><br><span class="line">	<span class="keyword">local</span> ok, reason = splash:go&#123;<span class="string">&quot;http://httpbin.org/post&quot;</span>, http_method=<span class="string">&quot;POST&quot;</span>, body=<span class="string">&quot;name=Germey&quot;</span>&#125;</span><br><span class="line">	<span class="keyword">if</span> ok <span class="keyword">then</span></span><br><span class="line">		<span class="keyword">return</span> splash:html() #返回网页源码</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="wait"><a href="#wait" class="headerlink" title="wait"></a>wait</h6><figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">ok, reason = splash:wait&#123;<span class="built_in">time</span>, cancel_on_redirect=<span class="literal">false</span>, cancel_on_error=<span class="literal">true</span>&#125;</span><br></pre></td></tr></table></figure>

<p>cancel_on_redirect 可选，默认false，如果发生了重定向就停止等待，并返回重定向结果</p>
<p>cancel_on_error 可选，默认false，如果发生了加载错误，就停止等待</p>
<h6 id="jsfunc"><a href="#jsfunc" class="headerlink" title="jsfunc"></a>jsfunc</h6><p>可以直接调用 JavaScript 定义的方法，调用的方法需要用双中括号包围</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(splash, args)</span></span></span><br><span class="line">  <span class="keyword">local</span> get_div_count = splash:jsfunc(<span class="string">[[</span></span><br><span class="line"><span class="string">  function()&#123;</span></span><br><span class="line"><span class="string">    var body = document.body;</span></span><br><span class="line"><span class="string">    var divs = body.getElementsByTagName(&#x27;div&#x27;);</span></span><br><span class="line"><span class="string">    return divs.length;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  ]]</span>)</span><br><span class="line">  splash:go(<span class="string">&quot;https://www.baidu.com&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> (<span class="string">&quot;There are %s DIVS&quot;</span>):<span class="built_in">format</span>(get_div_count())</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>更多JavaScript 到 Lua 转换细节 <a href="https://splash.readthedocs.io/en/stable/scripting-ref.html">https://splash.readthedocs.io/en/stable/scripting-ref.html</a></p>
<h6 id="evaljs"><a href="#evaljs" class="headerlink" title="evaljs"></a>evaljs</h6><p>可以执行 JavaScript 代码并返回最后一条 JavaScript 语句的返回结果</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> title = splash:evaljs(<span class="string">&quot;document.title&quot;</span>)</span><br></pre></td></tr></table></figure>

<h6 id="runjs"><a href="#runjs" class="headerlink" title="runjs"></a>runjs</h6><p>可以执行 JavaScript 代码，与 evaljs() 功能类似，但更偏向于执行某些动作或声明某些方法</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">splash:runjs(<span class="string">&quot;foo = function() &#123; return &#x27;bar&#x27; &#125;&quot;</span>) #声明一个JavaScript定义的方法</span><br><span class="line"><span class="keyword">local</span> result = splash:evaljs(<span class="string">&quot;foo()&quot;</span>) #通过evaljs()调用得到结果</span><br></pre></td></tr></table></figure>

<h6 id="autoload"><a href="#autoload" class="headerlink" title="autoload()"></a>autoload()</h6><p>可以设置每个页面访问时自动加载的对象</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">ok, reason = splash:autoload&#123;source_or_url, source=<span class="literal">nil</span>, url=<span class="literal">nil</span>&#125;</span><br></pre></td></tr></table></figure>

<p>source_or_url JavaScript 代码或者 JavaScript 库链接</p>
<p>source JavaScript 代码</p>
<p>url JavaScript 库链接</p>
<p>此方法只负责加载 JavaScript 代码或库，不执行任何操作，如果要执行，evaljs()</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(splash, args)</span></span></span><br><span class="line">	splash:autoload(<span class="string">[[</span></span><br><span class="line"><span class="string">  function get_document_title()&#123;</span></span><br><span class="line"><span class="string">    return document.title;</span></span><br><span class="line"><span class="string">  &#125;  </span></span><br><span class="line"><span class="string">  ]]</span>)</span><br><span class="line">  splash:go(<span class="string">&quot;https://www.baidu.com&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> splash:evaljs(<span class="string">&quot;get_document_title()&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>这里用 autoload 声明了一个 JavaScript 方法</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(splash, args)</span></span></span><br><span class="line">	<span class="built_in">assert</span>(splash:autoload(<span class="string">&quot;https://code.jquery.com/jquery-2.1.3.min.js&quot;</span>))</span><br><span class="line">  <span class="built_in">assert</span>(splash:go(<span class="string">&quot;https://www.taobao.com&quot;</span>))</span><br><span class="line">  <span class="keyword">local</span> version = splash:evaljs(<span class="string">&quot;$.fn.jquery&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;JQuery version&#x27;</span> .. version</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="call-later"><a href="#call-later" class="headerlink" title="call_later()"></a>call_later()</h6><p>可以通过设置定时任务和延迟时间来实现任务延迟执行，并且可以在执行前通过 cancel() 方法重新执行特定任务</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">timer = splash:call_later(callback, delay)</span><br></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(splash, args)</span></span></span><br><span class="line">  <span class="keyword">local</span> snapshots = &#123;&#125;</span><br><span class="line">  <span class="keyword">local</span> timer = splash:call_later(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    snapshots[<span class="string">&quot;a&quot;</span>] = splash:png()</span><br><span class="line">    splash:wait(<span class="number">1.0</span>)</span><br><span class="line">    snapshots[<span class="string">&quot;b&quot;</span>] = splash:png()</span><br><span class="line">  <span class="keyword">end</span>, <span class="number">1.5</span>)</span><br><span class="line">  <span class="built_in">assert</span>(splash:go(<span class="string">&quot;https://www.baidu.com&quot;</span>))</span><br><span class="line">  splash:wait(<span class="number">3.0</span>)</span><br><span class="line">  timer:reraise()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> snapshots</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>设置了一个定时任务，1.5 秒的时候获取网页截图，等待1秒，2.5秒的时候再获取网页截图</p>
<h6 id="http-get"><a href="#http-get" class="headerlink" title="http_get()"></a>http_get()</h6><p>模拟发送 HTTP 的 GET请求</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">response = splash:http_get(url, headers=<span class="literal">nil</span>, follow_redirects=<span class="literal">true</span>)</span><br></pre></td></tr></table></figure>

<p>follow_redirects 是否启动自动重定向 默认 true</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(splash, args)</span></span></span><br><span class="line">	<span class="keyword">local</span> treat = <span class="built_in">require</span>(<span class="string">&quot;treat&quot;</span>)</span><br><span class="line">	<span class="keyword">local</span> response = splash:http_get(<span class="string">&quot;http://httpbin.org/get&quot;</span>)</span><br><span class="line">  	<span class="keyword">return</span> &#123;</span><br><span class="line">      html = treat.as_string(response.body),</span><br><span class="line">      url = response.url,</span><br><span class="line">      <span class="built_in">status</span> = response.<span class="built_in">status</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="http-post"><a href="#http-post" class="headerlink" title="http_post()"></a>http_post()</h6><p>模拟 POST 请求</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">response = splash:http_post&#123;url, headers=<span class="literal">nil</span>, follow_redirects=<span class="literal">true</span>, body=<span class="literal">nil</span>&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(splash, args)</span></span></span><br><span class="line">	<span class="keyword">local</span> treat = <span class="built_in">require</span>(<span class="string">&quot;treat&quot;</span>)</span><br><span class="line">  <span class="keyword">local</span> json = <span class="built_in">require</span>(<span class="string">&quot;json&quot;</span>)</span><br><span class="line">	<span class="keyword">local</span> response = splash:http_post&#123;<span class="string">&quot;http://httpbin.org/post&quot;</span>,</span><br><span class="line">  	body=json.encode(&#123;name=<span class="string">&quot;Germey&quot;</span>&#125;),</span><br><span class="line">    headers = &#123;[<span class="string">&quot;content-type&quot;</span>] = <span class="string">&quot;application/json&quot;</span>&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  	<span class="keyword">return</span> &#123;</span><br><span class="line">      html = treat.as_string(response.body),</span><br><span class="line">      url = response.url,</span><br><span class="line">      <span class="built_in">status</span> = response.<span class="built_in">status</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="set-content"><a href="#set-content" class="headerlink" title="set_content()"></a>set_content()</h6><p>用来设置页面内容</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">funciton main(splash)</span><br><span class="line">	<span class="built_in">assert</span>(splash:set_content(<span class="string">&quot;&lt;html&gt;&lt;body&gt;hello&lt;/body&gt;&lt;/html&gt;&quot;</span>))</span><br><span class="line">	<span class="keyword">return</span> splash:png()</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="html"><a href="#html" class="headerlink" title="html"></a>html</h6><p>获取网页源代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">return splash:html()</span><br></pre></td></tr></table></figure>

<h6 id="png、jpeg"><a href="#png、jpeg" class="headerlink" title="png、jpeg"></a>png、jpeg</h6><p>获取 PNG/JPEG 格式的页面截图</p>
<h6 id="har"><a href="#har" class="headerlink" title="har"></a>har</h6><p>获取页面加载过程描述信息</p>
<h6 id="url"><a href="#url" class="headerlink" title="url"></a>url</h6><p>获取当前正在访问的URL</p>
<h6 id="get-cookies"><a href="#get-cookies" class="headerlink" title="get_cookies()"></a>get_cookies()</h6><p>获取当前页面的 Cookies</p>
<h6 id="add-cookie"><a href="#add-cookie" class="headerlink" title="add_cookie()"></a>add_cookie()</h6><p>添加 Cookie</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">cookies = splash:add_cookie&#123;name, value, <span class="built_in">path</span>=<span class="literal">nil</span>, domain=<span class="literal">nil</span>, expires=<span class="literal">nil</span>, httpOnly=<span class="literal">nil</span>, secure=<span class="literal">nil</span>&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span><span class="params">(splash)</span></span></span><br><span class="line">	splash:add_cookie&#123;<span class="string">&quot;sessionid&quot;</span>, <span class="string">&quot;34234jojo&quot;</span>, <span class="string">&quot;/&quot;</span>, domain=<span class="string">&quot;http://example.com&quot;</span>&#125;</span><br><span class="line">  splash:go(<span class="string">&quot;http://example.com&quot;</span>)</span><br><span class="line">  <span class="keyword">return</span> splash:html()</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="clear-cookies"><a href="#clear-cookies" class="headerlink" title="clear_cookies()"></a>clear_cookies()</h6><p>清除所有 cookies</p>
<h6 id="get-viewport-size"><a href="#get-viewport-size" class="headerlink" title="get_viewport_size()"></a>get_viewport_size()</h6><p>获取当前浏览器页面的大小，即宽高</p>
<h6 id="set-viewport-size"><a href="#set-viewport-size" class="headerlink" title="set_viewport_size()"></a>set_viewport_size()</h6><p>设置浏览器页面宽高</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">splash:set_viewport(<span class="number">400</span>, <span class="number">700</span>)</span><br></pre></td></tr></table></figure>

<h6 id="set-viewport-full"><a href="#set-viewport-full" class="headerlink" title="set_viewport_full()"></a>set_viewport_full()</h6><p>设置浏览器全屏显示</p>
<h6 id="set-user-agent"><a href="#set-user-agent" class="headerlink" title="set_user_agent"></a>set_user_agent</h6><p>设置浏览器 User-Agent</p>
<h6 id="set-custom-headers"><a href="#set-custom-headers" class="headerlink" title="set_custom_headers()"></a>set_custom_headers()</h6><p>设置请求头</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">splash:set_custom_headers(&#123;</span><br><span class="line">	[<span class="string">&quot;User-Agent&quot;</span>] = <span class="string">&quot;Splash&quot;</span>,</span><br><span class="line">	[<span class="string">&quot;Site&quot;</span>] = <span class="string">&quot;Splash&quot;</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h6 id="select"><a href="#select" class="headerlink" title="select"></a>select</h6><p>选中符合条件的第一个节点，如果有多个符合条件只会返回一个，参数是CSS 选择器</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="built_in">input</span> = splash:<span class="built_in">select</span>(<span class="string">&quot;#kw&quot;</span>)</span><br><span class="line"><span class="built_in">input</span>:send_text(<span class="string">&#x27;Splash&#x27;</span>)</span><br><span class="line">splash:wait(<span class="number">3</span>)</span><br><span class="line"><span class="keyword">return</span> splash:png()</span><br></pre></td></tr></table></figure>

<h6 id="select-all"><a href="#select-all" class="headerlink" title="select_all()"></a>select_all()</h6><p>选中所有符合条件的节点，参数是CSS 选择器</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">local</span> treat = <span class="built_in">require</span>(<span class="string">&#x27;treat&#x27;</span>)</span><br><span class="line"><span class="built_in">assert</span>(splash:go(<span class="string">&quot;https://quotes.toscrape.com/&quot;</span>))</span><br><span class="line"><span class="keyword">local</span> texts = splash:select_all(<span class="string">&#x27;.quote .text&#x27;</span>)</span><br><span class="line"> <span class="keyword">for</span> index, text <span class="keyword">in</span> <span class="built_in">ipairs</span>(texts) <span class="keyword">do</span></span><br><span class="line">   results[index] = text.node.innerHTML</span><br><span class="line"> <span class="keyword">end</span></span><br><span class="line"> <span class="keyword">return</span> treat.as_array(results)</span><br></pre></td></tr></table></figure>

<p>通过 CSS 选择器选中了节点的正文内容，随后遍历所有节点，将内容获取下来</p>
<h6 id="mouse-click"><a href="#mouse-click" class="headerlink" title="mouse_click"></a>mouse_click</h6><p>可以模拟鼠标点击操作，参数为坐标x和y，也可以直接选中某个节点</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="built_in">input</span> = splash:<span class="built_in">select</span>(<span class="string">&#x27;#kw&#x27;</span>)</span><br><span class="line"><span class="built_in">input</span>:send_text(<span class="string">&#x27;Splash&#x27;</span>)</span><br><span class="line">submit = splash:<span class="built_in">select</span>(<span class="string">&#x27;#su&#x27;</span>)</span><br><span class="line">submit:mouse_click()</span><br></pre></td></tr></table></figure>



<p>针对页面元素的API操作 <a href="https://splash.readthedocs.io/en/stable/scripting-element-object.html">https://splash.readthedocs.io/en/stable/scripting-element-object.html</a></p>
<h5 id="Splash-API-调用"><a href="#Splash-API-调用" class="headerlink" title="Splash API 调用"></a>Splash API 调用</h5><p>如何利用 Splash 渲染页面，Splash 提供了一些 HTTP API 接口，只需要请求这些接口并传递相应的参数即可</p>
<h6 id="render-html"><a href="#render-html" class="headerlink" title="render.html"></a>render.html</h6><p>用于获取 JavaScript 渲染的页面的 HTML 代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:8050&#x2F;render.html?url&#x3D;https:&#x2F;&#x2F;www.baidu.com</span><br></pre></td></tr></table></figure>

<p>传递一个url参数来指定渲染 URL，返回结果即页面渲染后的源代码</p>
<p>Python 实现</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">url = <span class="string">&#x27;http://localhost:8050/render.html?url=https://www.baidu.com&#x27;</span></span><br><span class="line">response = requests.get(url)</span><br><span class="line">print(respons.text)</span><br></pre></td></tr></table></figure>

<p>此接口还可以指定其它参数 如wait 等待秒数 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">url = <span class="string">&#x27;http://localhost:8050/render.html?url=https://www.baidu.com&amp;wait=5&#x27;</span></span><br></pre></td></tr></table></figure>

<p>还支持代理设置、图片加载设置、Headers 设置、请求方法设置</p>
<p>具体用法 <a href="https://splash.readthedocs.io/en/stable/api.html">https://splash.readthedocs.io/en/stable/api.html</a></p>
<h6 id="render-png"><a href="#render-png" class="headerlink" title="render.png"></a>render.png</h6><p>可以获取网页截图，参数比 render.html 多了几个 比如 width 和 height 来控制宽高</p>
<p>返回 PNG 格式的图片二进制数据</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:8050&#x2F;render.png?url&#x3D;https:&#x2F;&#x2F;www.baidu.com&amp;wait&#x3D;5&amp;width&#x3D;1000&amp;height&#x3D;700</span><br></pre></td></tr></table></figure>

<p>具体用法 <a href="https://splash.readthedocs.io/en/stable/api.html">https://splash.readthedocs.io/en/stable/api.html</a></p>
<h6 id="render-jpeg"><a href="#render-jpeg" class="headerlink" title="render.jpeg"></a>render.jpeg</h6><p>和 render.png 类似，返回 JPEG 格式二进制图片</p>
<h6 id="render-har"><a href="#render-har" class="headerlink" title="render.har"></a>render.har</h6><p>获取页面加载的 HAR 数据，JSON 格式的</p>
<h6 id="render-json"><a href="#render-json" class="headerlink" title="render.json"></a>render.json</h6><p>包含了前面接口所有功能，JSON 格式</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:8050&#x2F;render.json?url&#x3D;http:&#x2F;&#x2F;httpbin.org</span><br></pre></td></tr></table></figure>

<p>可以传入不同的参数控制返回结果，传入html=1 返回结果会增加源代码数据 png=1 增加 PNG 截图数据，传入 har=1 会获得页面 HAR 数据</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:8050&#x2F;render.json?url&#x3D;http:&#x2F;&#x2F;httpbin.org&amp;html&#x3D;1&amp;png&#x3D;1&amp;har&#x3D;1</span><br></pre></td></tr></table></figure>

<h6 id="execute"><a href="#execute" class="headerlink" title="execute"></a>execute</h6><p>用此接口便可实现与 Lua脚本的对接</p>
<p>如果实现一些交互操作的话，使用 execute 接口</p>
<p>写个简单的脚本</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">function main(splash)</span><br><span class="line">	return &#39;hello&#39;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>然后将此接口转化为 URL 编码的字符串，拼接到 execute 接口后面</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:8050&#x2F;execute?lua_source&#x3D;function+main%jo342342</span><br></pre></td></tr></table></figure>

<p>lua_source 参数传递了转码后的 Lua 脚本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line">lua = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">function main(splash)</span></span><br><span class="line"><span class="string">	return &#x27;hello&#x27;</span></span><br><span class="line"><span class="string">end</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">url = <span class="string">&#x27;http://localhost:8050/execute?lua_source=&#x27;</span> + quote(lua)</span><br><span class="line">response = requests.get(url)</span><br></pre></td></tr></table></figure>

<p>返回 JSON 格式，成功获取了请求的 URL、状态码、网页源代码</p>
<h5 id="Splash-负载均衡配置"><a href="#Splash-负载均衡配置" class="headerlink" title="Splash 负载均衡配置"></a>Splash 负载均衡配置</h5><p>具体配置 <a href="https://setup.scrape.center/splash-loadbalance">https://setup.scrape.center/splash-loadbalance</a></p>
<p>Splash 做页面抓取时，如果爬取的量非常大，任务非常多，用一个Splash服务来处理压力太大，搭建一个负载均衡器把压力分散到服务器上，相当于多台机器多个服务共同参与任务的处理，减小单个 Splash服务的压力</p>
<h6 id="配置-Splash-服务"><a href="#配置-Splash-服务" class="headerlink" title="配置 Splash 服务"></a>配置 Splash 服务</h6><p>要搭建 Splash 负载均衡，首先要有多个 Splash 服务</p>
<p>比如 4台远程主机的 8050 端口上都开启了 Splash 服务，访问其中任何一个服务时，都可以使用 Splash 服务</p>
<h6 id="配置负载均衡"><a href="#配置负载均衡" class="headerlink" title="配置负载均衡"></a>配置负载均衡</h6><p>任意一台带有公网IP 的主机配置负载均衡，主机上装好 Nginx 修改 Nginx 配置文件 nginx.conf</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">	upstream splash &#123;</span><br><span class="line">		least_conn;</span><br><span class="line">		server 41.159.27:8050;</span><br><span class="line">		server 41.159.27:8050;</span><br><span class="line">		server 41.159.27:8050;</span><br><span class="line">		server 41.159.27:8050;</span><br><span class="line">	&#125;</span><br><span class="line">	server&#123;</span><br><span class="line">		listen 8050;</span><br><span class="line">		location &#x2F; &#123;</span><br><span class="line">			proxy_pass http:splash;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>。。。</p>
<p>配置完成后重启 Nginx 服务</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sudo nginx -s reload</span><br></pre></td></tr></table></figure>

<p>直接访问 Nginx 所在服务器的 8050 端口，即可实现负载均衡了</p>
<h6 id="配置认证"><a href="#配置认证" class="headerlink" title="配置认证"></a>配置认证</h6>]]></content>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Python3网络爬虫开发实战-7JavaScript动态渲染页面爬取2</title>
    <url>/2022/10/07/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-7JavaScript%E5%8A%A8%E6%80%81%E6%B8%B2%E6%9F%93%E9%A1%B5%E9%9D%A2%E7%88%AC%E5%8F%962/</url>
    <content><![CDATA[<h4 id="7-3-Pyppeteer-使用"><a href="#7-3-Pyppeteer-使用" class="headerlink" title="7.3 Pyppeteer 使用"></a>7.3 Pyppeteer 使用</h4><p>Puppeteer 是 Google 基于 Node.js 开发的一个工具，有了它，我们可以利用 JavaScript 控制 Chrome 浏览器的一些操作</p>
<p>Pyppeteer 其实就是 Puppeteer 的 Python 版实现</p>
<p>Pyppeteer 是依赖 Chromium 浏览器运行的，如果第一次运行 Pyppeteer 没有按照 Chromium 浏览器，程序会自动帮我们安装和配置好</p>
<p>Pyppeteer 是基于 Python 的新特性 async 实现的，所以它的一些操作执行也支持异步方式</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install pyppeteer</span><br></pre></td></tr></table></figure>

<h5 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> pyppeteer <span class="keyword">import</span> launch</span><br><span class="line"><span class="keyword">from</span> pyquery <span class="keyword">import</span> PyQuery <span class="keyword">as</span> pq</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">  browser = <span class="keyword">await</span> launch() <span class="comment">#启动浏览器</span></span><br><span class="line">  page = <span class="keyword">await</span> browser.newPage()</span><br><span class="line">  <span class="keyword">await</span> page.goto(<span class="string">&#x27;https://spa2.scrape.center/&#x27;</span>)  <span class="comment">#访问网站</span></span><br><span class="line">  <span class="keyword">await</span> page.waitForSelector(<span class="string">&#x27;.item .name&#x27;</span>) <span class="comment">#等待节点加载出来</span></span><br><span class="line">  doc = pq(<span class="keyword">await</span> page.content()) </span><br><span class="line">  <span class="comment">#通过pyquery从源码中提取电影名称输出</span></span><br><span class="line">  names = [item.text() <span class="keyword">for</span> item <span class="keyword">in</span> doc(<span class="string">&#x27;.item .name&#x27;</span>).items()]</span><br><span class="line">  print(<span class="string">&#x27;Names&#x27;</span>, names)</span><br><span class="line">  <span class="keyword">await</span> browser.close()</span><br><span class="line"></span><br><span class="line">asyncio.get_event_loop().run_until_complete(main())</span><br></pre></td></tr></table></figure>

<p>利用 Pyppeteer 可以控制浏览器执行几乎所有想实现的操作</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> pyppeteer <span class="keyword">import</span> launch</span><br><span class="line"></span><br><span class="line">width, height = <span class="number">1366</span>,<span class="number">768</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">  browser = <span class="keyword">await</span> launch()</span><br><span class="line">  page = <span class="keyword">await</span> browser.newPage()</span><br><span class="line">  <span class="keyword">await</span> page.setViewport(&#123;<span class="string">&#x27;width&#x27;</span>: width, <span class="string">&#x27;height&#x27;</span>: height&#125;)</span><br><span class="line">  <span class="keyword">await</span> page.goto(<span class="string">&#x27;https://spa2.scrape.center/&#x27;</span>)  <span class="comment">#访问网站</span></span><br><span class="line">  <span class="keyword">await</span> page.waitForSelector(<span class="string">&#x27;.item .name&#x27;</span>) <span class="comment">#等待节点加载出来</span></span><br><span class="line">  <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line">  <span class="keyword">await</span> page.screenshot(path=<span class="string">&#x27;example.png&#x27;</span>)</span><br><span class="line">  dimensions = <span class="keyword">await</span> page.evaluate(<span class="string">&#x27;&#x27;&#x27;()=&gt;&#123;</span></span><br><span class="line"><span class="string">  	return &#123;</span></span><br><span class="line"><span class="string">  		width:document.documentElement.clientWidth,</span></span><br><span class="line"><span class="string">  		height:document.documentElement.clientHeight,</span></span><br><span class="line"><span class="string">  		deviceScaleFactor:window.devicePixelRatio,</span></span><br><span class="line"><span class="string">  	&#125;</span></span><br><span class="line"><span class="string">  &#125;&#x27;&#x27;&#x27;</span>)</span><br><span class="line">  print(dimensions)</span><br><span class="line">  <span class="keyword">await</span> browser.close()</span><br><span class="line"></span><br><span class="line">asyncio.get_event_loop().run_until_complete(main())</span><br></pre></td></tr></table></figure>

<p>API 文档链接 <a href="https://pyppeteer.github.io/pyppeteer/reference.html">https://pyppeteer.github.io/pyppeteer/reference.html</a></p>
<h5 id="Launch"><a href="#Launch" class="headerlink" title="Launch"></a>Launch</h5><h5 id="无头模式"><a href="#无头模式" class="headerlink" title="无头模式"></a>无头模式</h5><p>设置 handless=False 启动的时候就能看到页面了，默认 True，启动时看不到任何界面</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> launch(handless=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<h5 id="调试模式"><a href="#调试模式" class="headerlink" title="调试模式"></a>调试模式</h5><p>devtool=True 每开启一个页面就会弹出一个调试窗口，如果设置为 True，无头模式就会关闭，界面始终会显现出来</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">browser = <span class="keyword">await</span> launch(devtools=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h5 id="禁用提示条"><a href="#禁用提示条" class="headerlink" title="禁用提示条"></a>禁用提示条</h5><p>浏览器的提示，Chrome 正受到自动测试软件的控制</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">browser = <span class="keyword">await</span> launch(handless=<span class="literal">False</span>, args=[<span class="string">&#x27;--disable-infobars&#x27;</span>])</span><br></pre></td></tr></table></figure>

<h5 id="防止检测"><a href="#防止检测" class="headerlink" title="防止检测"></a>防止检测</h5><p>pyppeteer 的 Page 对象有一个叫作 evaluateOnNewDocument 方法，意思是每次加载网页的时候执行某条语句，这里可以利用它执行隐藏 webdriver 属性的命令</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> pyppeteer <span class="keyword">import</span> launch</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">  browser = <span class="keyword">await</span> launch(handless=<span class="literal">False</span>, args=[<span class="string">&#x27;--disable-infobars&#x27;</span>])</span><br><span class="line">  page = <span class="keyword">await</span> browser.newPage()</span><br><span class="line">  <span class="keyword">await</span> page.evaluateOnNewDocument(<span class="string">&#x27;Object.defineProperty(navigator, &quot;webdriver&quot;,&#123;get:()=&gt; undefined&#125;)&#x27;</span>)</span><br><span class="line">  <span class="keyword">await</span> page.goto(<span class="string">&#x27;https://antispider1.scrape.center/&#x27;</span>)</span><br><span class="line">  <span class="keyword">await</span> asyncio.sleep(<span class="number">100</span>)</span><br><span class="line">  </span><br><span class="line">asyncio.get_event_loop().run_until_complete(main())</span><br></pre></td></tr></table></figure>

<h5 id="页面大小设置"><a href="#页面大小设置" class="headerlink" title="页面大小设置"></a>页面大小设置</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">width, height = <span class="number">1366</span>,<span class="number">768</span></span><br><span class="line"><span class="keyword">await</span> page.setViewPort(&#123;<span class="string">&#x27;width&#x27;</span>: width, <span class="string">&#x27;height&#x27;</span>: height&#125;)</span><br></pre></td></tr></table></figure>

<h5 id="用户数据持久化"><a href="#用户数据持久化" class="headerlink" title="用户数据持久化"></a>用户数据持久化</h5><p>设置用户目录，启动浏览器的时候设置 userDataDir</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> pyppeteer <span class="keyword">import</span> launch</span><br><span class="line"></span><br><span class="line">browser = <span class="keyword">await</span> launch(handless=<span class="literal">False</span>, userDataDir=<span class="string">&#x27;./userdata&#x27;</span>,args=[<span class="string">&#x27;--disable-infobars&#x27;</span>])</span><br><span class="line">  page = <span class="keyword">await</span> browser.newPage()</span><br><span class="line">  <span class="keyword">await</span> page.goto(<span class="string">&#x27;https://www.taobao.com&#x27;</span>)</span><br><span class="line">  <span class="keyword">await</span> asyncio.sleep(<span class="number">100</span>)</span><br><span class="line">  </span><br><span class="line">asyncio.get_event_loop().run_until_complete(main())</span><br></pre></td></tr></table></figure>

<p>运行代码，登录淘宝，可以看到当前运行目录下多了一个 userdata 文件夹，再次运行发现淘宝已处于登录状态</p>
<h5 id="无痕模式"><a href="#无痕模式" class="headerlink" title="无痕模式"></a>无痕模式</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">width, height = <span class="number">1366</span>,<span class="number">768</span></span><br><span class="line">browser = <span class="keyword">await</span> launch(handless=<span class="literal">False</span>,args=[<span class="string">&#x27;--disable-infobars&#x27;</span>], <span class="string">f&#x27;--window-size=<span class="subst">&#123;width&#125;</span>,<span class="subst">&#123;height&#125;</span>&#x27;</span>)</span><br><span class="line">context = <span class="keyword">await</span> browser.createIncognitoBrowserContest()</span><br><span class="line">page = <span class="keyword">await</span> context.newPage()</span><br></pre></td></tr></table></figure>

<h5 id="Page"><a href="#Page" class="headerlink" title="Page"></a>Page</h5><h6 id="选择器"><a href="#选择器" class="headerlink" title="选择器"></a>选择器</h6><p>Page 对象内置了很多用于选取节点的选择器方法。</p>
<p>J 方法：传入一个选择器，就能返回匹配到的第一个节点，等价于 querySelector 方法；</p>
<p>JJ 方法，传入选择器，返回符合选择器的所有节点组成的列表，等价于 querySelectorAll</p>
<p>JJeval() 等价于 querySelectorAllEval()</p>
<p>Jeval() 等价于 querySelectorEval()</p>
<p>Jx() 等价于 xpath()</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> page.waitForSelector(<span class="string">&#x27;.item .name&#x27;</span>)</span><br><span class="line">j_result1 = <span class="keyword">await</span> page.J(<span class="string">&#x27;.item .name&#x27;</span>)</span><br><span class="line">j_result2 = <span class="keyword">await</span> page.querySelector(<span class="string">&#x27;.item .name&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#获取url组成列表</span></span><br><span class="line"><span class="keyword">await</span> page.querySelectorAllEval(<span class="string">&#x27;,item .name&#x27;</span>, <span class="string">&#x27;nodes =&gt; nodes.map(node =&gt; node.href)&#x27;</span>)</span><br><span class="line"><span class="keyword">await</span> page.querySelectorEval(<span class="string">&#x27;.cover&#x27;</span>, <span class="string">&#x27;node =&gt; node.src&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>querySelectorAllEval 接收两个参数一个selector选择器，另一个pageFunction，代表要执行的 JavaScript 方法，这个方法的作用是找出和选择器匹配的节点，然后根据 pageFunction 定义的逻辑从这些节点中抽取出对应的结果并返回</p>
<h6 id="选项操作"><a href="#选项操作" class="headerlink" title="选项操作"></a>选项操作</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pages = <span class="keyword">await</span> browser.pages()</span><br><span class="line">page1 = pages[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">await</span> = page1.bringToFront() <span class="comment">#切换选项卡</span></span><br></pre></td></tr></table></figure>

<h6 id="页面操作"><a href="#页面操作" class="headerlink" title="页面操作"></a>页面操作</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> page.goBack()</span><br><span class="line"><span class="keyword">await</span> page.goFroward()</span><br><span class="line"><span class="keyword">await</span> page.reload()</span><br><span class="line"><span class="keyword">await</span> page.pdf()</span><br><span class="line"><span class="keyword">await</span> page.screenshot()</span><br><span class="line"><span class="keyword">await</span> page.setContent(<span class="string">&#x27;&lt;h2&gt;hello world&lt;/h2&gt;&#x27;</span>)</span><br><span class="line"><span class="keyword">await</span> page.setUserAgent(<span class="string">&#x27;Python&#x27;</span>)</span><br><span class="line"><span class="keyword">await</span> page.setExtraHTTPHeaders(headers=&#123;&#125;)</span><br><span class="line"><span class="keyword">await</span> page.close()</span><br><span class="line"><span class="keyword">await</span> browser.close()</span><br></pre></td></tr></table></figure>

<h6 id="点击"><a href="#点击" class="headerlink" title="点击"></a>点击</h6><p>click 第一个参数是选择器，即哪里操作，第二个参数是几项配置</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> page.waitForSelector(<span class="string">&#x27;.item .name&#x27;</span>)</span><br><span class="line"><span class="keyword">await</span> page.click(<span class="string">&#x27;.item .name&#x27;</span>, options=&#123;</span><br><span class="line">  <span class="string">&#x27;button&#x27;</span>: <span class="string">&#x27;right&#x27;</span>, <span class="comment">#left、middle、right</span></span><br><span class="line">  <span class="string">&#x27;clickCount&#x27;</span>: <span class="number">1</span>, <span class="comment">#1或2</span></span><br><span class="line">	<span class="string">&#x27;delay&#x27;</span>: <span class="number">3000</span>, <span class="comment">#毫秒 延迟点击</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">await</span> browser.close()</span><br></pre></td></tr></table></figure>

<h6 id="输入文本"><a href="#输入文本" class="headerlink" title="输入文本"></a>输入文本</h6><p>给 type 方法第一个参数传入选择器，第二个参数输入想要输入的内容</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> page.<span class="built_in">type</span>(<span class="string">&#x27;#q&#x27;</span>, <span class="string">&#x27;iPad&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h6 id="获取信息"><a href="#获取信息" class="headerlink" title="获取信息"></a>获取信息</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> page.content() <span class="comment">#获取源码</span></span><br><span class="line"><span class="keyword">await</span> page.cookies()</span><br></pre></td></tr></table></figure>

<h6 id="执行-JavaScript"><a href="#执行-JavaScript" class="headerlink" title="执行 JavaScript"></a>执行 JavaScript</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dimensions = <span class="keyword">await</span> page.evaluate(<span class="string">&#x27;&#x27;&#x27;()=&gt;&#123;</span></span><br><span class="line"><span class="string">  return &#123;</span></span><br><span class="line"><span class="string">    width:document.documentElement.clientWidth,</span></span><br><span class="line"><span class="string">    height:document.documentElement.clientHeight,</span></span><br><span class="line"><span class="string">    deviceScaleFactor:window.devicePixelRatio,</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;&#x27;&#x27;&#x27;</span>)</span><br><span class="line">print(dimensions)</span><br></pre></td></tr></table></figure>

<h6 id="延时等待"><a href="#延时等待" class="headerlink" title="延时等待"></a>延时等待</h6><p>waitForSelector 传入CSS 选择器，如果找到符合条件的节点，就立马返回结果</p>
<p>waitForFunction 等待某个JavaScript 方法执行完毕或返回结果</p>
<p>waitNavigation 等待页面跳转</p>
<p>waitForRequest、waitForResponse 等待特定请求发出，等待特定请求对应的响应</p>
<p>waitFor 通用的等待方法</p>
<p>waitForXPath 等待复合 XPath 的节点加载出来</p>
<h6 id="其他功能"><a href="#其他功能" class="headerlink" title="其他功能"></a>其他功能</h6><p>还有其他功能如键盘事件、鼠标事件、对话框事件等 </p>
<p><a href="https://miyakogi.github.io/pyppeteer/reference.html">https://miyakogi.github.io/pyppeteer/reference.html</a></p>
<h4 id="7-4-Playwright"><a href="#7-4-Playwright" class="headerlink" title="7.4 Playwright"></a>7.4 Playwright</h4><p>微软2020年初开源的新一代自动化测试工具</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install playwright</span><br><span class="line">playwright install</span><br></pre></td></tr></table></figure>

<p>安装完成后可以使用 Playwright 启动 Chromium、firefox 或 WebKit 浏览器来进行自动化操作</p>
<h5 id="基本使用-1"><a href="#基本使用-1" class="headerlink" title="基本使用"></a>基本使用</h5><p>playwright 支持两种编写模式，一种是和 Pyppeteer 一样的异步模式；一种是和 Selenium 一样的同步模式</p>
<p>同步模式</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> playwright.sync_api <span class="keyword">import</span> sync_playwright</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> sync_playwright() <span class="keyword">as</span> p:</span><br><span class="line">  <span class="keyword">for</span> browser_type <span class="keyword">in</span> [p.chromium, p.firefox, p.webkit]</span><br><span class="line">  browser = browser_type.launch(headless=<span class="literal">False</span>)</span><br><span class="line">  page = browser.new_Page()</span><br><span class="line">  page.goto(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line">  page.screenshot(path=<span class="string">f&#x27;screenshot-<span class="subst">&#123;browser_type.name&#125;</span>.png&#x27;</span>)</span><br><span class="line">  print(page.title())</span><br><span class="line">  browser.close()</span><br></pre></td></tr></table></figure>

<p>异步模式</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> playwright.sync_api <span class="keyword">import</span> sync_playwright</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span>  </span><br><span class="line">  <span class="keyword">with</span> sync_playwright() <span class="keyword">as</span> p:</span><br><span class="line">    <span class="keyword">for</span> browser_type <span class="keyword">in</span> [p.chromium, p.firefox, p.webkit]</span><br><span class="line">    browser = <span class="keyword">await</span> browser_type.launch()</span><br><span class="line">    page = <span class="keyword">await</span> browser.new_Page()</span><br><span class="line">    page.goto(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line">    page.screenshot(path=<span class="string">f&#x27;screenshot-<span class="subst">&#123;browser_type.name&#125;</span>.png&#x27;</span>)</span><br><span class="line">    print(<span class="keyword">await</span> page.title())</span><br><span class="line">    browser.close()</span><br><span class="line">    </span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>

<h5 id="代码生成"><a href="#代码生成" class="headerlink" title="代码生成"></a>代码生成</h5><p>Playwright 还可以录制我们在浏览器中的操作并自动生成代码，通过 playwright 的命令行调用 codegen 实现</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">playwright codegen --help</span><br><span class="line">- target 使用语言默认python，代表会生成同步模式的操作代码，如果传入 python-async 则生成异步模式的代码</span><br><span class="line">- o 输出代码文件名称</span><br><span class="line">-b 使用浏览器，默认chromium</span><br><span class="line">-device 可以模拟使用手机浏览器（如iPhone11）</span><br><span class="line">-lang 代表设置浏览器的语言</span><br><span class="line">-timeout 可以设置页面加载的超时时间</span><br><span class="line"></span><br><span class="line">playwright codegen -o script.py -b firefox</span><br></pre></td></tr></table></figure>

<p>运行代码后弹出 Firefox 浏览器，同时右侧输出一个脚本窗口</p>
<h5 id="支持移动端浏览器"><a href="#支持移动端浏览器" class="headerlink" title="支持移动端浏览器"></a>支持移动端浏览器</h5><p>Playwright 的另一个特色就是支持模拟移动端浏览器，例如模拟打开 iPhone12ProMax 上的Safari浏览器</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> playwright.sync_api <span class="keyword">import</span> sync_playwright</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> sync_playwright() <span class="keyword">as</span> p:</span><br><span class="line">  iphone_12_pro_max = p.device[<span class="string">&#x27;iPhone 12 Pro Max&#x27;</span>]</span><br><span class="line">  browser = p.webkit.launch(headless=<span class="literal">False</span>)</span><br><span class="line">  context = browser.new_context(</span><br><span class="line">   **iphone_12_pro_max,</span><br><span class="line">    locale=<span class="string">&#x27;zh-CN&#x27;</span></span><br><span class="line">  )</span><br><span class="line">  page = context.new_page()</span><br><span class="line">  page.goto(<span class="string">&#x27;https://www.whatismybrowser.com/&#x27;</span>) <span class="comment">#一个获取浏览器信息的网站</span></span><br><span class="line">  page.wait_for_load_state(state=<span class="string">&#x27;networkidle&#x27;</span>) <span class="comment">#等待页面的某个状态完成 空闲状态完成就是当前页面初始化和数据加载完成</span></span><br><span class="line">  page.screenshot(path=<span class="string">&#x27;browser-iphone.png&#x27;</span>)</span><br><span class="line">  browser.close()</span><br></pre></td></tr></table></figure>

<h5 id="选择器-1"><a href="#选择器-1" class="headerlink" title="选择器"></a>选择器</h5><h6 id="文本选择"><a href="#文本选择" class="headerlink" title="文本选择"></a>文本选择</h6><p>文本选择支持直接使用 text= 这样的语法进行筛选</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">page.click(<span class="string">&#x27;text=Log in&#x27;</span>) <span class="comment">#选择并点击文本内容是Log in的节点</span></span><br></pre></td></tr></table></figure>

<h6 id="CSS选择器"><a href="#CSS选择器" class="headerlink" title="CSS选择器"></a>CSS选择器</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#根据id或者class进行筛选</span></span><br><span class="line">page.click(<span class="string">&quot;button&quot;</span>)</span><br><span class="line">page.click(<span class="string">&quot;#nav-bar .contact-us-item&quot;</span>)</span><br><span class="line"><span class="comment">#根据特定的节点属性筛选</span></span><br><span class="line">page.click(<span class="string">&quot;[data-test=login-button]&quot;</span>)</span><br><span class="line">page.click(<span class="string">&quot;[aria-label=&#x27;Sign in&#x27;]&quot;</span>)</span><br></pre></td></tr></table></figure>

<h6 id="CSS选择器-文本值"><a href="#CSS选择器-文本值" class="headerlink" title="CSS选择器+文本值"></a>CSS选择器+文本值</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#选择文本值中包含Playwright字符串的 article节点</span></span><br><span class="line">page.click(<span class="string">&quot;article:has-text(&#x27;Playwright&#x27;)&quot;</span>)</span><br><span class="line"><span class="comment">#选择id为nav-bar的节点中文本值为 Contact us的节点</span></span><br><span class="line">page.click(<span class="string">&quot;#nav-bar :text(&#x27;Contact us&#x27;)&quot;</span>)</span><br></pre></td></tr></table></figure>

<h6 id="CSS选择器-节点关系"><a href="#CSS选择器-节点关系" class="headerlink" title="CSS选择器+节点关系"></a>CSS选择器+节点关系</h6><p>CSS选择器还可以结合节点关系来筛选节点，例如使用 has 指定另外一个选择器</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#选择class为item-description的节点，且节点包含class为item-promo-banner的子节点</span></span><br><span class="line">page.click(<span class="string">&quot;.item-description:has(.item-promo-banner)&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#right-of 指定位于某个节点右侧的节点</span></span><br><span class="line"><span class="comment">#选择input结点，且该节点要位于文本值为Username的节点的右侧</span></span><br><span class="line">page.click(<span class="string">&quot;input:right-of(:text(&#x27;Username&#x27;))&quot;</span>)</span><br></pre></td></tr></table></figure>

<h6 id="XPath"><a href="#XPath" class="headerlink" title="XPath"></a>XPath</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">page.click(<span class="string">&quot;xpath=//button&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>更多关于选择器的用法 <a href="https://playwright.dev/python/docs/selectors">https://playwright.dev/python/docs/selectors</a></p>
<h5 id="常用操作方法"><a href="#常用操作方法" class="headerlink" title="常用操作方法"></a>常用操作方法</h5><p>Page 对象提供了一个 on 方法，用来监听页面中发生的各个事件，例如close、console、load、request、response 等</p>
<h6 id="事件监听"><a href="#事件监听" class="headerlink" title="事件监听"></a>事件监听</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> playwright.sync_api <span class="keyword">import</span> sync_playwright</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_response</span>(<span class="params">response</span>):</span></span><br><span class="line">  print(<span class="string">f&#x27;Status <span class="subst">&#123;response.status&#125;</span>: <span class="subst">&#123;response.url&#125;</span>&#x27;</span>)<span class="comment">#输出状态码和链接</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> sync_playwright <span class="keyword">as</span> p:</span><br><span class="line">  browser = p.chromium.launch(headless=<span class="literal">False</span>)</span><br><span class="line">  page = browser.new_page()</span><br><span class="line">  page.on(<span class="string">&#x27;response&#x27;</span>, on_response)</span><br><span class="line">  page.goto(<span class="string">&#x27;https://spa6.scrape.center/&#x27;</span>)</span><br><span class="line">  page.wait_for_load_state(<span class="string">&#x27;networkidle&#x27;</span>)</span><br><span class="line">  browser.close()</span><br></pre></td></tr></table></figure>

<p>监听 response 事件，回调方法设置 on_response</p>
<p>可以输出 JSON</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_response</span>(<span class="params">response</span>):</span></span><br><span class="line">  <span class="keyword">if</span> <span class="string">&#x27;/api/movie/&#x27;</span> <span class="keyword">in</span> response.url <span class="keyword">and</span> response.status == <span class="number">200</span>:</span><br><span class="line">    print(response.json())</span><br></pre></td></tr></table></figure>

<h6 id="获取页面源码"><a href="#获取页面源码" class="headerlink" title="获取页面源码"></a>获取页面源码</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">html = page.content()</span><br><span class="line">print(html)</span><br></pre></td></tr></table></figure>

<h6 id="页面点击"><a href="#页面点击" class="headerlink" title="页面点击"></a>页面点击</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">page.click(selector, **kwargs)</span><br><span class="line"></span><br><span class="line">click_count 点击次数默认<span class="number">1</span></span><br><span class="line">timeout 单位秒默认<span class="number">30</span> 等待找到要点击的节点的超时时间</span><br><span class="line">position 传入字典，有x y属性，代表点击位置相对节点左上角的偏移量</span><br><span class="line">force 默认<span class="literal">False</span> 即使按钮设置了不可点击也能强制点击</span><br></pre></td></tr></table></figure>

<p>click 内部执行逻辑，找到Selector匹配的节点，如果没有找到，一直等到直到超时，</p>
<h6 id="文本输入"><a href="#文本输入" class="headerlink" title="文本输入"></a>文本输入</h6><p>第一个参数选择器，第二个参数输入值，还可以通过 timeout 指定查找对应节点的超时时间</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">page.fill(selector, value, **kwargs)</span><br></pre></td></tr></table></figure>

<h6 id="获取节点属性"><a href="#获取节点属性" class="headerlink" title="获取节点属性"></a>获取节点属性</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">page.get_attribute(selector, name, **kwargs)</span><br><span class="line"></span><br><span class="line"><span class="comment">#查找class为name的a节点，name参数传入了href，代表获取超链接内容</span></span><br><span class="line">page.get_attribute(<span class="string">&#x27;a.name&#x27;</span>, <span class="string">&#x27;href&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h6 id="获取多个节点"><a href="#获取多个节点" class="headerlink" title="获取多个节点"></a>获取多个节点</h6><p>query_selector_all</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">elements = page.query_selector_all(<span class="string">&#x27;a.name&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> element <span class="keyword">in</span> elements:</span><br><span class="line">  print(element.get_attribute(<span class="string">&#x27;href&#x27;</span>)) <span class="comment">#节点属性</span></span><br><span class="line">  print(element.text_content()) <span class="comment">#节点文本</span></span><br></pre></td></tr></table></figure>

<h6 id="获取单个节点"><a href="#获取单个节点" class="headerlink" title="获取单个节点"></a>获取单个节点</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">element = page.query_selector(<span class="string">&#x27;a.name&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h6 id="网络劫持"><a href="#网络劫持" class="headerlink" title="网络劫持"></a>网络劫持</h6><p>route，利用这个方法可以实现网络劫持和修改操作，如修改 request 的属性，修改相应结果等</p>
<p>修改请求</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> playwright.sync_api <span class="keyword">import</span> sync_playwright</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> aync_playwright <span class="keyword">as</span> p:</span><br><span class="line">  browser = p.chromium.launch(headless=<span class="literal">False</span>)</span><br><span class="line">  page = browser.new_page()</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">cancel_request</span>(<span class="params">route, request</span>):</span></span><br><span class="line">    route.abort()</span><br><span class="line">    </span><br><span class="line">  page.route(re.<span class="built_in">compile</span>(<span class="string">r&quot;\(.png)|\(.jpg)&quot;</span>), cancel_request) <span class="comment">#包含.png或者.jpg的链接</span></span><br><span class="line">  page.goto(<span class="string">&quot;https://spa6.scrape.center/&quot;</span>)</span><br><span class="line">  page.wait_for_load(<span class="string">&#x27;networkidle&#x27;</span>)</span><br><span class="line">  page.screenshot(path=<span class="string">&#x27;no_picture.png&#x27;</span>)</span><br><span class="line">  browser.close()</span><br></pre></td></tr></table></figure>

<p>修改响应</p>
<p>custom_response.html </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modify_response</span>(<span class="params">reoute, request</span>):</span></span><br><span class="line">  route.fulfill(path=<span class="string">&#x27;./custom_response.html&#x27;</span>)</span><br><span class="line">  </span><br><span class="line">page.route(<span class="string">&#x27;/&#x27;</span>, modify_response)</span><br><span class="line">page.goto(<span class="string">&quot;https://spa6.scrape.center/&quot;</span>)</span><br></pre></td></tr></table></figure>



<h4 id="7-5-使用-Selenium-爬取淘宝商品"><a href="#7-5-使用-Selenium-爬取淘宝商品" class="headerlink" title="7.5 使用 Selenium 爬取淘宝商品"></a>7.5 使用 Selenium 爬取淘宝商品</h4><p>代码 <a href="https://github.com/Python3WebSpider/TaobaoProduct">https://github.com/Python3WebSpider/TaobaoProduct</a></p>
<p>利用 Selenium 模拟浏览器操作抓取淘宝的商品信息，并将结果保存到MongoDB</p>
<h6 id="获取商品列表"><a href="#获取商品列表" class="headerlink" title="获取商品列表"></a>获取商品列表</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"><span class="keyword">from</span> selenium.common.exceptions <span class="keyword">import</span> TimeoutException</span><br><span class="line"></span><br><span class="line">browser = webdriver.Chrome()</span><br><span class="line">wait = WebDriverWait(browser, <span class="number">10</span>)</span><br><span class="line">KEYWORD = <span class="string">&#x27;iPad&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index_page</span>(<span class="params">page</span>):</span></span><br><span class="line">  <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  抓取索引页</span></span><br><span class="line"><span class="string">  :param page: 页码</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  print(<span class="string">&#x27;正在爬取第&#x27;</span>, page, <span class="string">&#x27;页&#x27;</span>)</span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">      url = <span class="string">&#x27;https://s.taobao.com/search?q=&#x27;</span> + quote(KEYWORD)</span><br><span class="line">      browser.get(url)</span><br><span class="line">      <span class="keyword">if</span> page &gt; <span class="number">1</span>:</span><br><span class="line">          <span class="built_in">input</span> = wait.until(</span><br><span class="line">              EC.presence_of_element_located((By.CSS_SELECTOR, <span class="string">&#x27;#mainsrp-pager div.form &gt; input&#x27;</span>)))</span><br><span class="line">          submit = wait.until(</span><br><span class="line">              EC.element_to_be_clickable((By.CSS_SELECTOR, <span class="string">&#x27;#mainsrp-pager div.form &gt; span.btn.J_Submit&#x27;</span>)))</span><br><span class="line">          <span class="built_in">input</span>.clear()</span><br><span class="line">          <span class="built_in">input</span>.send_keys(page)</span><br><span class="line">          submit.click()</span><br><span class="line">      wait.until(</span><br><span class="line">          EC.text_to_be_present_in_element((By.CSS_SELECTOR, <span class="string">&#x27;#mainsrp-pager li.item.active &gt; span&#x27;</span>), <span class="built_in">str</span>(page)))</span><br><span class="line">      wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, <span class="string">&#x27;.m-itemlist .items .item&#x27;</span>)))</span><br><span class="line">      get_products()</span><br><span class="line">  <span class="keyword">except</span> TimeoutException:</span><br><span class="line">      index_page(page)</span><br></pre></td></tr></table></figure>

<p>定义了 index_page() 方法，抓取商品列表</p>
<p>访问搜索链接，页码大于1就进行跳页操作，否则等待页面加载完成</p>
<p>等待加载使用 WebDriverWait 对象，指定最长等待时间 10 秒，这个时间内匹配了等待条件，也就说页面加载出来了，就立即返回相应结果继续向下执行，否则到了最大时间没加载出来时，抛出异常</p>
<p>等待商品加载出来 presence_of_element_located，传入 CSS 选择器 .m-itemlist .items .item，这选择器对应页面内容是每个商品的信息块</p>
<p>是否跳转到了对应页面，跳转到某一页后页码都会高亮，只需要判断当前高亮的页码数是当前页码即可</p>
<p>text_to_be_present_in_element 会等待指定的文本出现在某个节点里时返回成功，会检测当前高亮的页码节点是不是传过来的页码数</p>
<h6 id="解析商品列表"><a href="#解析商品列表" class="headerlink" title="解析商品列表"></a>解析商品列表</h6><p>直接返回页面源代码，使用pyquery解析</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_products</span>():</span></span><br><span class="line">  <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  提取商品数据</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  html = browser.page_source</span><br><span class="line">  doc = pq(html)</span><br><span class="line">  items = doc(<span class="string">&#x27;#mainsrp-itemlist .items .item&#x27;</span>).items()</span><br><span class="line">  <span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">      product = &#123;</span><br><span class="line">          <span class="string">&#x27;image&#x27;</span>: item.find(<span class="string">&#x27;.pic .img&#x27;</span>).attr(<span class="string">&#x27;data-src&#x27;</span>),</span><br><span class="line">          <span class="string">&#x27;price&#x27;</span>: item.find(<span class="string">&#x27;.price&#x27;</span>).text(),</span><br><span class="line">          <span class="string">&#x27;deal&#x27;</span>: item.find(<span class="string">&#x27;.deal-cnt&#x27;</span>).text(),</span><br><span class="line">          <span class="string">&#x27;title&#x27;</span>: item.find(<span class="string">&#x27;.title&#x27;</span>).text(),</span><br><span class="line">          <span class="string">&#x27;shop&#x27;</span>: item.find(<span class="string">&#x27;.shop&#x27;</span>).text(),</span><br><span class="line">          <span class="string">&#x27;location&#x27;</span>: item.find(<span class="string">&#x27;.location&#x27;</span>).text()</span><br><span class="line">      &#125;</span><br><span class="line">      print(product)</span><br><span class="line">      save_to_mongo(product)</span><br></pre></td></tr></table></figure>

<h6 id="保存到-MongoDB"><a href="#保存到-MongoDB" class="headerlink" title="保存到 MongoDB"></a>保存到 MongoDB</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">MONGO_URL = <span class="string">&#x27;localhost&#x27;</span></span><br><span class="line">MONGO_DB = <span class="string">&#x27;taobao&#x27;</span></span><br><span class="line">MONGO_COLLECTION = <span class="string">&#x27;products&#x27;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_to_mongo</span>(<span class="params">result</span>):</span></span><br><span class="line">  <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  保存至MongoDB</span></span><br><span class="line"><span class="string">  :param result: 结果</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">      <span class="keyword">if</span> db[MONGO_COLLECTION].insert(result):</span><br><span class="line">          print(<span class="string">&#x27;存储到MongoDB成功&#x27;</span>)</span><br><span class="line">  <span class="keyword">except</span> Exception:</span><br><span class="line">      print(<span class="string">&#x27;存储到MongoDB失败&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>quote()</p>
<p>单个字符串编码，url 多个字符串编码用 urlencode</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line">KEYWORD = <span class="string">&#x27;ipad&#x27;</span></span><br><span class="line">url = <span class="string">&#x27;https://s.taobao.com/search?q=&#x27;</span> + quote(KEYWORD)</span><br></pre></td></tr></table></figure>

<h6 id="遍历每页"><a href="#遍历每页" class="headerlink" title="遍历每页"></a>遍历每页</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">MAX_PAGE = <span class="number">100</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">  <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  遍历每一页</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, MAX_PAGE + <span class="number">1</span>):</span><br><span class="line">      index_page(i)</span><br><span class="line">  browser.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main()</span><br></pre></td></tr></table></figure>





<h6 id="Chrome-Handless-模式"><a href="#Chrome-Handless-模式" class="headerlink" title="Chrome Handless 模式"></a>Chrome Handless 模式</h6><p>Chrome59版本开始已开始支持 Handless 模式，也就是无界面模式，这样爬取的时候就不会弹出浏览器了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">chrome_options = webdriver.ChromeOptions()</span><br><span class="line">chrome_options.add_argument(<span class="string">&#x27;--headless&#x27;</span>)</span><br><span class="line">browser = webdriver.Chrome(chrome_options=chrome_options)</span><br></pre></td></tr></table></figure>

<h6 id="Config"><a href="#Config" class="headerlink" title="Config"></a>Config</h6><p>可以把常量设置放 Config.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">MONGO_URL = <span class="string">&#x27;localhost&#x27;</span></span><br><span class="line">MONGO_DB = <span class="string">&#x27;taobao&#x27;</span></span><br><span class="line">MONGO_COLLECTION = <span class="string">&#x27;products&#x27;</span></span><br><span class="line">KEYWORD = <span class="string">&#x27;ipad&#x27;</span></span><br><span class="line">MAX_PAGE = <span class="number">100</span></span><br></pre></td></tr></table></figure>

<p>使用 <code>from config import *</code> 导入</p>
<h6 id="对接-Firefox"><a href="#对接-Firefox" class="headerlink" title="对接 Firefox"></a>对接 Firefox</h6><p>只需要更改</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">browser = webdriver.Firefox()</span><br></pre></td></tr></table></figure>



<h4 id="7-6Selenium爬取实战"><a href="#7-6Selenium爬取实战" class="headerlink" title="7.6Selenium爬取实战"></a>7.6Selenium爬取实战</h4><h4 id="7-7Pyppeteer爬取实战"><a href="#7-7Pyppeteer爬取实战" class="headerlink" title="7.7Pyppeteer爬取实战"></a>7.7Pyppeteer爬取实战</h4><h4 id="7-8CSS位置偏移反爬案例"><a href="#7-8CSS位置偏移反爬案例" class="headerlink" title="7.8CSS位置偏移反爬案例"></a>7.8CSS位置偏移反爬案例</h4><h4 id="7-9字体反爬案例"><a href="#7-9字体反爬案例" class="headerlink" title="7.9字体反爬案例"></a>7.9字体反爬案例</h4>]]></content>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Python3网络爬虫开发实战-8验证码识别</title>
    <url>/2022/04/14/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-8%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/</url>
    <content><![CDATA[<h4 id="8-验证码识别"><a href="#8-验证码识别" class="headerlink" title="8. 验证码识别"></a>8. 验证码识别</h4><p>识别验证码需要 tesserocr 库</p>
<p>还需要安装 Selenium、Pillow、NumPy、retrying 库，用来模拟登录</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install selenium pillow numpy retrying</span><br></pre></td></tr></table></figure>





<h5 id="8-1-图形验证码识别"><a href="#8-1-图形验证码识别" class="headerlink" title="8.1 图形验证码识别"></a>8.1 图形验证码识别</h5><p>中国知网的注册页面有图形验证码 <a href="http://my.cnki.net/elibregister/commonRegister.aspx">http://my.cnki.net/elibregister/commonRegister.aspx</a></p>
<p>新标签打开图形验证码 <a href="http://my.cnki.net/elibregister/CheckCode.aspx">http://my.cnki.net/elibregister/CheckCode.aspx</a> 保存到本地命名为 code.jpg</p>
<p>案例网站 <a href="https://captcha7.scrape.center/">https://captcha7.scrape.center/</a> </p>
<h6 id="识别测试"><a href="#识别测试" class="headerlink" title="识别测试"></a>识别测试</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> tesserocr</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  image = Image.<span class="built_in">open</span>(<span class="string">&#x27;code.jpg&#x27;</span>)</span><br><span class="line">  result = tesserocr.image_to_text(image)</span><br><span class="line">  print(result)</span><br></pre></td></tr></table></figure>

<p>新建 Image 对象，调用 tesserocr 的 image_to_text 方法，传入 Image 对象即可完成识别，转换成文本</p>
<p>还有个简单的方法，直接将图片文件转为字符串</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(tesserocr.file_to_text(<span class="string">&#x27;code.jpg&#x27;</span>))</span><br></pre></td></tr></table></figure>

<img src="Python3网络爬虫开发实战-8验证码识别/WeChat05c8c73a3a3040aeed742174d56d4712.png" alt="WeChat05c8c73a3a3040aeed742174d56d4712" style="zoom:60%;" />

<h6 id="验证码处理"><a href="#验证码处理" class="headerlink" title="验证码处理"></a>验证码处理</h6><p>有些验证码上有多余线条干扰图片的识别，这种情况需要做一些额外的处理，如转灰度、二值化等操作</p>
<p>图片里那些造成干扰的点，颜色大多比文本的颜色更浅，因此可以通过颜色将造成干扰的点排除掉</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">image = Image.<span class="built_in">open</span>(<span class="string">&#x27;code.png&#x27;</span>)</span><br><span class="line">print(np.array(image).shape)</span><br><span class="line">print(image.mode)</span><br><span class="line"><span class="comment">#结果</span></span><br><span class="line">(<span class="number">38</span>, <span class="number">112</span>, <span class="number">4</span>)</span><br><span class="line">RGBA <span class="comment">#有透明通道的真彩色</span></span><br></pre></td></tr></table></figure>

<p>从结果可以看出，这个图片其实是一个三维数组</p>
<p>38 和 112 代表图片的高和宽，4 是每个像素点的表示向量</p>
<p>4 表示最后一维是一个长度为4的数组，分别代表 R、G、B、A，即一个像素点由 4 个数字表示。如果 image.mode 是 RGB，这个值就是 3</p>
<ul>
<li>mode：</li>
</ul>
<p>定义了图片类型和像素的位宽，一共有 9 种类型</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1：像素用 1 位表示，Python 中表示为 True 或 False，即二值化</span><br><span class="line">L：像素用 8 位表示，取值 0~255，表示灰度图像，数值越小，颜色越黑</span><br><span class="line">P：像素用 8 位表示，即调色板数据</span><br><span class="line">RBG：像素用 3x8 位表示，即真彩色；</span><br><span class="line">RGBA：像素用 4x8 位表示，即有透明通道的真彩色</span><br><span class="line">CMYK: 像素用 4x8 位表示，即印刷四色模式</span><br><span class="line">YCbCr：像素用 3x8 位表示，即彩色视频格式</span><br><span class="line">I：像素用 32 位整型表示</span><br><span class="line">F：像素用 32 位浮点型表示</span><br></pre></td></tr></table></figure>

<p>为了方便处理，可以把 RGBA 转为更简单的 L，即把图片转化为灰度图像，图片对象的 convert 方法中传入 L 即可</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">image = image.convert(<span class="string">&#x27;L&#x27;</span>) <span class="comment">#将图像转化为灰度图像</span></span><br><span class="line">image = image.convert(<span class="string">&#x27;1&#x27;</span>) <span class="comment">#将图像二值化处理</span></span><br><span class="line">image.show()</span><br></pre></td></tr></table></figure>

<ul>
<li>将图片转化为灰度图像，再根据阈值删除图片中的干扰点</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">image = Image.<span class="built_in">open</span>(<span class="string">&#x27;code.png&#x27;</span>)</span><br><span class="line">image = image.convert(<span class="string">&#x27;L&#x27;</span>) <span class="comment">#转化为灰度图像</span></span><br><span class="line">threshold = <span class="number">50</span> <span class="comment">#灰度的阈值</span></span><br><span class="line">array = np.array(image) <span class="comment">#将图片转化为 NumPy 数组</span></span><br><span class="line">array = np.where(array &gt; threshold, <span class="number">255</span>, <span class="number">0</span>) <span class="comment">#大于阈值的图片像素设为255白色，否则小于设黑色</span></span><br><span class="line">image = Image.fromarray(array.astype(<span class="string">&#x27;uint8&#x27;</span>)) <span class="comment">#Numpy数组转Image</span></span><br><span class="line">image.show()</span><br></pre></td></tr></table></figure>

<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-8%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/WeChatb4e68e7e53ab397fa08b0b2a70230d24.png" alt="WeChatb4e68e7e53ab397fa08b0b2a70230d24"></p>
<p>将变量 threshold 设置为 50，代表灰度的阈值，接着将图片转化为 NumPy 数组，利用 NumPy 的 where 方法对数组进行筛选和处理，指定大于阈值的图片像素设置为 255，表示白色，否则设置为0，表示黑色</p>
<p>处理过后干扰点不见了，图片变成黑白分明</p>
<p>利用 Image 对象的 convert() 方法传入参数 L，即可将图片转化为灰度图像</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">image = Image.<span class="built_in">open</span>(<span class="string">&#x27;code.jpg&#x27;</span>)</span><br><span class="line">image = image.convert(<span class="string">&#x27;L&#x27;</span>)</span><br><span class="line">image.show()</span><br></pre></td></tr></table></figure>

<img src="Python3网络爬虫开发实战-8验证码识别/WeChat502e6f6ba61943c5b6c39e8bc4d5c4f6.png" alt="WeChat502e6f6ba61943c5b6c39e8bc4d5c4f6" style="zoom:50%;" />

<p>传入 1 即可将图片进行二值化处理</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">image = image.convert(<span class="string">&#x27;1&#x27;</span>)</span><br></pre></td></tr></table></figure>

<img src="Python3网络爬虫开发实战-8验证码识别/WeChata596e46fadb12785691911910ffddb8e.png" alt="WeChata596e46fadb12785691911910ffddb8e" style="zoom:50%;" />

<p>还可以指定二值化的阈值，默认阈值127</p>
<p>不能直接转化原图，要将原图先转化为灰度图像，然后再指定二值化阈值，下面指定100，背景被去掉了部分会变得黑白分明</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">image = Image.<span class="built_in">open</span>(<span class="string">&#x27;code.jpg&#x27;</span>)</span><br><span class="line">image = image.convert(<span class="string">&#x27;L&#x27;</span>)</span><br><span class="line">table = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    <span class="keyword">if</span> i &lt; <span class="number">100</span>:</span><br><span class="line">        table.append(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        table.append(<span class="number">1</span>)</span><br><span class="line">image = image.point(table, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">image.show()</span><br></pre></td></tr></table></figure>

<img src="Python3网络爬虫开发实战-8验证码识别/WeChat506046716da1f482080b704db38e3f6f.png" alt="WeChat506046716da1f482080b704db38e3f6f" style="zoom:60%;" />

<p>针对一些有干扰的图片，可以做一些灰度和二值化处理，可以提高图片识别的正确率</p>
<h5 id="8-2识别实战"><a href="#8-2识别实战" class="headerlink" title="8.2识别实战"></a>8.2识别实战</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> tesserocr</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> retrying <span class="keyword">import</span> retry</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.wait <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> selenium.common.exceptions <span class="keyword">import</span> TimeoutException</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment">#对验证码图片做去噪处理</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">preprocess</span>(<span class="params">image</span>):</span></span><br><span class="line">    image = image.convert(<span class="string">&#x27;L&#x27;</span>)</span><br><span class="line">    array = np.array(image)</span><br><span class="line">    array = np.where(array &gt; <span class="number">50</span>, <span class="number">255</span>, <span class="number">0</span>)</span><br><span class="line">    image = Image.fromarray(array.astype(<span class="string">&#x27;uint8&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> image</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#1打开案例网站</span></span><br><span class="line"><span class="comment">#2找到用户名、密码输入框，输入</span></span><br><span class="line"><span class="comment">#3找到并截取验证码图片，转化为图片对象</span></span><br><span class="line"><span class="comment">#4预处理验证码，去除噪声</span></span><br><span class="line"><span class="comment">#5识别验证码，得到识别结果</span></span><br><span class="line"><span class="comment">#6去除识别结果中一些非字母符和数字符</span></span><br><span class="line"><span class="comment">#7找到验证码输入框，输入验证码</span></span><br><span class="line"><span class="comment">#8点击登录按钮</span></span><br><span class="line"><span class="comment">#9等待登录成功字样出现，如果出现证明验证码识别正确，否则重复以上步骤重试</span></span><br><span class="line">  </span><br><span class="line"><span class="meta">@retry(stop_max_attempt_number=10, retry_on_result=lambda x: x is False)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>():</span></span><br><span class="line">    browser.get(<span class="string">&#x27;https://captcha7.scrape.center/&#x27;</span>)</span><br><span class="line">    browser.find_element_by_css_selector(<span class="string">&#x27;.username input[type=&quot;text&quot;]&#x27;</span>).send_keys(<span class="string">&#x27;admin&#x27;</span>)</span><br><span class="line">    browser.find_element_by_css_selector(<span class="string">&#x27;.password input[type=&quot;password&quot;]&#x27;</span>).send_keys(<span class="string">&#x27;admin&#x27;</span>)</span><br><span class="line">    captcha = browser.find_element_by_css_selector(<span class="string">&#x27;#captcha&#x27;</span>)</span><br><span class="line">    image = Image.<span class="built_in">open</span>(BytesIO(captcha.screenshot_as_png))</span><br><span class="line">    image = preprocess(image)</span><br><span class="line">    captcha = tesserocr.image_to_text(image)</span><br><span class="line">    captcha = re.sub(<span class="string">&#x27;[^A-Za-z0-9]&#x27;</span>, <span class="string">&#x27;&#x27;</span>, captcha)</span><br><span class="line">    browser.find_element_by_css_selector(<span class="string">&#x27;.captcha input[type=&quot;text&quot;]&#x27;</span>).send_keys(captcha)</span><br><span class="line">    browser.find_element_by_css_selector(<span class="string">&#x27;.login&#x27;</span>).click()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        WebDriverWait(browser, <span class="number">10</span>).until(EC.presence_of_element_located((By.XPATH, <span class="string">&#x27;//h2[contains(., &quot;登录成功&quot;)]&#x27;</span>)))</span><br><span class="line">        time.sleep(<span class="number">10</span>)</span><br><span class="line">        browser.close()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> TimeoutException:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    browser = webdriver.Chrome()</span><br><span class="line">    login()</span><br></pre></td></tr></table></figure>

<p>用到了 retrying 来指定重试条件和重试次数。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">lambda</span> x: x <span class="keyword">is</span> <span class="literal">False</span></span><br><span class="line"><span class="comment">#相当于</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span>(<span class="params">x</span>):</span></span><br><span class="line">  <span class="keyword">return</span> x <span class="keyword">is</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>





<h5 id="8-3-滑动验证码识别"><a href="#8-3-滑动验证码识别" class="headerlink" title="8.3 滑动验证码识别"></a>8.3 滑动验证码识别</h5><p>拖动拼合滑块的验证码</p>
<p>可以和原图对比检测的方式来识别缺口位置</p>
<p>同时获取两张图片，设定一个对比阈值，然后遍历两张图片，找出相同位置像素 RGB 差距超过此阈值的像素点，此像素点的位置就是缺口的位置</p>
<h6 id="模拟点击"><a href="#模拟点击" class="headerlink" title="模拟点击"></a>模拟点击</h6><p>头条登录页面测试</p>
<p>安居客登录页面测试 <a href="https://m.anjuke.com/member/login/?from=m_yhzx_dltx">https://m.anjuke.com/member/login/?from=m_yhzx_dltx</a></p>
<p>头条的滑动缺口是单独一张图片，大小为缺口大小</p>
<p>安居客滑动缺口带背景</p>
<p>模拟输入手机号点击验证码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.remote.webelement <span class="keyword">import</span> WebElement</span><br><span class="line"></span><br><span class="line">browser = webdriver.Chrome()</span><br><span class="line">wait = WebDriverWait(browser, <span class="number">20</span>)</span><br><span class="line">mobile = <span class="string">&#x27;xxxxxxxx&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_phone_input</span>():</span></span><br><span class="line">  phone_input = wait.until(EC.presence_of_element_located((By.ID, <span class="string">&#x27;dynamicPhone&#x27;</span>))) <span class="comment"># type: WebElement</span></span><br><span class="line">  phone_input.send_keys(mobile)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_code_button</span>():</span></span><br><span class="line">  button = wait.until(EC.element_to_be_clickable((By.ID, <span class="string">&#x27;dynamicVerifiCodeText&#x27;</span>))) <span class="comment"># type: WebElement</span></span><br><span class="line">  button.click()</span><br></pre></td></tr></table></figure>

<h6 id="识别缺口"><a href="#识别缺口" class="headerlink" title="识别缺口"></a>识别缺口</h6><h6 id="图片截取"><a href="#图片截取" class="headerlink" title="图片截取"></a>图片截取</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">img = wait.until(EC.presence_of_element_located((By.CLASS_NAME, <span class="string">&#x27;dvc-captcha__puzzleImg&#x27;</span>))) <span class="comment">#type: WebElement</span></span><br><span class="line">img.screenshot(<span class="string">&#x27;img1.png&#x27;</span>)</span><br><span class="line">shot2 = img.screenshot_as_png</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;img2.png&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(shot2)</span><br></pre></td></tr></table></figure>

<h5 id="8-4-使用OpenCV识别滑动验证码缺口"><a href="#8-4-使用OpenCV识别滑动验证码缺口" class="headerlink" title="8.4 使用OpenCV识别滑动验证码缺口"></a>8.4 使用OpenCV识别滑动验证码缺口</h5><p>测试地址 <a href="https://captcha1.scrape.center/">https://captcha1.scrape.center</a></p>
<p>安装库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install python-opencv</span><br></pre></td></tr></table></figure>

<p>步骤</p>
<ol>
<li><p>对验证码图片进行高斯模糊滤波处理，消除部分噪声干扰</p>
</li>
<li><p>利用边缘检测算法，通过调整相应阈值识别出验证码图片中滑块的边缘</p>
</li>
<li><p>基于上一步得到的边缘轮廓信息，对比面积、位置、周长等特征筛选出最可能的轮廓</p>
</li>
</ol>
<h6 id="高斯滤波"><a href="#高斯滤波" class="headerlink" title="高斯滤波"></a>高斯滤波</h6><p>高斯滤波用来去除图片中的一些噪声，减少噪声干扰，其实就是把图片模糊化，为下一步的边缘检测做好铺垫</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#src：需要处理的图片</span></span><br><span class="line"><span class="comment">#ksize：高斯滤波处理所用的高斯内核大小，需要传入一个元组，包含x和y两个元素</span></span><br><span class="line"><span class="comment">#sigmaY：高斯内核函数在X方向上的标准偏差</span></span><br><span class="line"><span class="comment">#sigmaY: 高斯内核函数在y方向上的标准偏差</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GaussianBlur</span>(<span class="params">src, ksize, sigmaX,dst=<span class="literal">None</span>, sigmaY=<span class="literal">None</span>, borderType=<span class="literal">None</span></span>)</span></span><br></pre></td></tr></table></figure>

<p>ksize 和 sigmaX 是必传参数，案例 ksize 可以取作 (5,5)，sigmaX 取作 0</p>
<p>经过高斯滤波后，图片会变模糊</p>
<h6 id="边缘检测"><a href="#边缘检测" class="headerlink" title="边缘检测"></a>边缘检测</h6><p>由于验证码图片里的目标缺口通常具有比较明显的边缘，所以借助一些边缘检测算法，再加上调整阈值是可以找出缺口位置的</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#image：需要处理的图片</span></span><br><span class="line"><span class="comment">#threshold1：阈值，最小判定临界点</span></span><br><span class="line"><span class="comment">#threshold2：阈值，最大判定临界点</span></span><br><span class="line"><span class="comment">#apertureSize：用于查找图片渐变的索贝尔内核的大小</span></span><br><span class="line"><span class="comment">#L2gradient：用于查找梯度幅度的等式</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Canny</span>(<span class="params">image, threshold1, threshold2, edges=<span class="literal">None</span>,apertureSize=<span class="literal">None</span>,L2gradient=<span class="literal">None</span></span>)</span></span><br></pre></td></tr></table></figure>

<p>通常只需设置 threshold1, threshold2 的值，数值大小视具体图片而定，这里可以取200和450，边缘检测算法处理后，会保留一些比较明显的边缘信息</p>
<h6 id="轮廓提取"><a href="#轮廓提取" class="headerlink" title="轮廓提取"></a>轮廓提取</h6><p>进行边缘检测后处理后，可以看到图片中会保留比较明显的边缘信息，下一步可以利用 OpenCV 技术提取边缘轮廓</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#image：需要处理的图片</span></span><br><span class="line"><span class="comment">#mode：用于定义轮廓的检索模式</span></span><br><span class="line"><span class="comment">#method：用于定义轮廓的近似方法</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">findContours</span>(<span class="params">image,mode,method,contours=<span class="literal">None</span>,hierarch=<span class="literal">None</span>,offset=<span class="literal">None</span></span>)</span></span><br></pre></td></tr></table></figure>

<p>这里将 mode 设置为 RETR_CCOMP，将 method 设置为 CHAIN_APPROX_SIMPLE</p>
<h6 id="外接矩形"><a href="#外接矩形" class="headerlink" title="外接矩形"></a>外接矩形</h6><p>提取到边缘轮廓后，可以计算出轮廓的外接矩形，以便我们根据面积和周长等参数判断提取到的轮廓是不是目标缺口的轮廓</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#array：可以是一个灰度图或者2D点集</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">boundingRect</span>(<span class="params">array</span>)</span></span><br></pre></td></tr></table></figure>

<h6 id="轮廓面积"><a href="#轮廓面积" class="headerlink" title="轮廓面积"></a>轮廓面积</h6><p>获取到各个轮廓的外接矩形后，可以根据面积和周长筛选缺口所在位置</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#contour：轮廓信息</span></span><br><span class="line"><span class="comment">#oriented：方向标识符，默认值False，面积以绝对值形式返回；若取True，方法会返回一个带符号的面积值，正负取决于轮廓方向（顺时针或逆时针）</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">contourArea</span>(<span class="params">contour, oriented=<span class="literal">None</span></span>)</span></span><br></pre></td></tr></table></figure>

<h6 id="轮廓周长"><a href="#轮廓周长" class="headerlink" title="轮廓周长"></a>轮廓周长</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#curve：轮廓信息</span></span><br><span class="line"><span class="comment">#closed：轮廓是否封闭</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">arcLength</span>(<span class="params">curve, closed</span>)</span></span><br></pre></td></tr></table></figure>

<h6 id="缺口识别"><a href="#缺口识别" class="headerlink" title="缺口识别"></a>缺口识别</h6><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"></span><br><span class="line">GAUSSIAN_BLUR_KERNEL_SIZE = (<span class="number">5</span>, <span class="number">5</span>)</span><br><span class="line">GAUSSIAN_BLUR_SIGMA_X = <span class="number">0</span></span><br><span class="line">CANNY_THRESHOLD1 = <span class="number">200</span></span><br><span class="line">CANNY_THRESHOLD2 = <span class="number">450</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#高斯滤波处理</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_gaussian_blur_image</span>(<span class="params">image</span>):</span></span><br><span class="line">    <span class="keyword">return</span> cv2.GaussianBlur(image, GAUSSIAN_BLUR_KERNEL_SIZE, GAUSSIAN_BLUR_SIGMA_X)</span><br><span class="line"></span><br><span class="line"><span class="comment">#边缘检测处理</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_canny_image</span>(<span class="params">image</span>):</span></span><br><span class="line">    <span class="keyword">return</span> cv2.Canny(image, CANNY_THRESHOLD1, CANNY_THRESHOLD2)</span><br><span class="line"></span><br><span class="line"><span class="comment">#提取轮廓信息</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_contours</span>(<span class="params">image</span>):</span></span><br><span class="line">    contours, _ = cv2.findContours(image, cv2.RETR_CCOMP, cv2.CHAIN_APPROX_SIMPLE)</span><br><span class="line">    <span class="keyword">return</span> contours</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_contour_area_threshold</span>(<span class="params">image_width, image_height</span>):</span></span><br><span class="line">    contour_area_min = (image_width * <span class="number">0.15</span>) * (image_height * <span class="number">0.25</span>) * <span class="number">0.8</span></span><br><span class="line">    contour_area_max = (image_width * <span class="number">0.15</span>) * (image_height * <span class="number">0.25</span>) * <span class="number">1.2</span></span><br><span class="line">    <span class="keyword">return</span> contour_area_min, contour_area_max</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_arc_length_threshold</span>(<span class="params">image_width, image_height</span>):</span></span><br><span class="line">    arc_length_min = ((image_width * <span class="number">0.15</span>) + (image_height * <span class="number">0.25</span>)) * <span class="number">2</span> * <span class="number">0.8</span></span><br><span class="line">    arc_length_max = ((image_width * <span class="number">0.15</span>) + (image_height * <span class="number">0.25</span>)) * <span class="number">2</span> * <span class="number">1.2</span></span><br><span class="line">    <span class="keyword">return</span> arc_length_min, arc_length_max</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_offset_threshold</span>(<span class="params">image_width</span>):</span></span><br><span class="line">    offset_min = <span class="number">0.2</span> * image_width</span><br><span class="line">    offset_max = <span class="number">0.85</span> * image_width</span><br><span class="line">    <span class="keyword">return</span> offset_min, offset_max</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    image_raw = cv2.imread(<span class="string">&#x27;captcha.png&#x27;</span>) <span class="comment">#读取原始图片</span></span><br><span class="line">    image_height, image_width, _ = image_raw.shape <span class="comment">#获取宽高</span></span><br><span class="line">    image_gaussian_blur = get_gaussian_blur_image(image_raw)<span class="comment">#高斯滤波处理</span></span><br><span class="line">    image_canny = get_canny_image(image_gaussian_blur) <span class="comment">#边缘检测处理</span></span><br><span class="line">    contours = get_contours(image_canny) <span class="comment">#提取轮廓信息</span></span><br><span class="line">    cv2.imwrite(<span class="string">&#x27;image_canny.png&#x27;</span>, image_canny)</span><br><span class="line">    cv2.imwrite(<span class="string">&#x27;image_gaussian_blur.png&#x27;</span>, image_gaussian_blur)</span><br><span class="line">    contour_area_min, contour_area_max = get_contour_area_threshold(image_width, image_height)</span><br><span class="line">    arc_length_min, arc_length_max = get_arc_length_threshold(image_width, image_height)</span><br><span class="line">    offset_min, offset_max = get_offset_threshold(image_width)</span><br><span class="line">    offset = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> contour <span class="keyword">in</span> contours:</span><br><span class="line">        x, y, w, h = cv2.boundingRect(contour)</span><br><span class="line">        <span class="keyword">if</span> contour_area_min &lt; cv2.contourArea(contour) &lt; contour_area_max <span class="keyword">and</span> \</span><br><span class="line">                arc_length_min &lt; cv2.arcLength(contour, <span class="literal">True</span>) &lt; arc_length_max <span class="keyword">and</span> \</span><br><span class="line">                offset_min &lt; x &lt; offset_max:</span><br><span class="line">            cv2.rectangle(image_raw, (x, y), (x + w, y + h), (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), <span class="number">2</span>)</span><br><span class="line">            offset = x</span><br><span class="line">    cv2.imwrite(<span class="string">&#x27;image_label.png&#x27;</span>, image_raw)</span><br><span class="line">    print(<span class="string">&#x27;offset&#x27;</span>, offset)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>



<h5 id="8-5-头条验证码识别"><a href="#8-5-头条验证码识别" class="headerlink" title="8.5 头条验证码识别"></a>8.5 头条验证码识别</h5><p>模拟点击显示滑动验证码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> numpy</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.remote.webelement <span class="keyword">import</span> WebElement</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">from</span> numpy <span class="keyword">import</span> ndarray</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver <span class="keyword">import</span> ActionChains</span><br><span class="line"></span><br><span class="line">browser = webdriver.Chrome()</span><br><span class="line">wait = WebDriverWait(browser, <span class="number">20</span>)</span><br><span class="line">mobile = <span class="string">&#x27;186xxxx&#x27;</span></span><br><span class="line"></span><br><span class="line">browser.get(<span class="string">&#x27;https://www.toutiao.com&#x27;</span>)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">button = wait.until(EC.presence_of_element_located((By.XPATH, <span class="string">&#x27;//*[@id=&quot;root&quot;]/div/div[5]/div[2]/div[1]/div/a&#x27;</span>))) <span class="comment"># type: WebElement</span></span><br><span class="line">button.click()</span><br><span class="line"><span class="built_in">input</span> = wait.until(EC.presence_of_element_located((By.XPATH, <span class="string">&#x27;//*[@id=&quot;login_modal_ele&quot;]/div/article/article/div[1]/div[1]/div[2]/article/div[1]/div/input&#x27;</span>))) <span class="comment"># type: WebElement</span></span><br><span class="line"><span class="built_in">input</span>.send_keys(mobile)</span><br><span class="line">code = browser.find_element_by_xpath(<span class="string">&#x27;//*[@id=&quot;login_modal_ele&quot;]/div/article/article/div[1]/div[1]/div[2]/article/div[2]/div/span&#x27;</span>) <span class="comment"># type: WebElement</span></span><br><span class="line">code.click()</span><br></pre></td></tr></table></figure>

<p>获取验证码图片，保存到本地</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">onload_save_img</span>(<span class="params">url, name</span>):</span></span><br><span class="line">  <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  下载链接图片</span></span><br><span class="line"><span class="string">  :param url: 图片链接</span></span><br><span class="line"><span class="string">  :param name: 保存图片名字</span></span><br><span class="line"><span class="string">  :return:</span></span><br><span class="line"><span class="string">  &#x27;&#x27;&#x27;</span></span><br><span class="line">  r = requests.get(url)</span><br><span class="line">  <span class="keyword">with</span> <span class="built_in">open</span>(name, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">      f.write(r.content)</span><br><span class="line"></span><br><span class="line"><span class="comment">#获取验证码图片</span></span><br><span class="line">slider_elem = wait.until(EC.presence_of_element_located((By.XPATH, <span class="string">&#x27;//*[@id=&quot;captcha_container&quot;]/div/div[2]/img[2]&#x27;</span>))) <span class="comment"># type: WebElement</span></span><br><span class="line">bk_elem = wait.until(EC.presence_of_element_located((By.XPATH, <span class="string">&#x27;//*[@id=&quot;captcha-verify-image&quot;]&#x27;</span>))) <span class="comment"># type: WebElement</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#保存图片</span></span><br><span class="line">onload_save_img(slider_elem.get_attribute(<span class="string">&#x27;src&#x27;</span>), <span class="string">&#x27;slider_elem.jpg&#x27;</span>)</span><br><span class="line">onload_save_img(bk_elem.get_attribute(<span class="string">&#x27;src&#x27;</span>), <span class="string">&#x27;bk_elem.jpg&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#可以获取保存图片宽高</span></span><br><span class="line"><span class="comment">#缺口宽高</span></span><br><span class="line"><span class="comment">#width, height = slider_pic.shape[::-1]  # 取宽度和高度 -1 通道</span></span><br></pre></td></tr></table></figure>

<img src="Python3网络爬虫开发实战-8验证码识别/bk_elem.jpg" alt="bk_elem" style="zoom:50%;" />

<img src="Python3网络爬虫开发实战-8验证码识别/slider_elem.jpg" alt="slider_elem" style="zoom:67%;" />

<p>读取灰度图片</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 读取灰度图片 0灰度图片 1RBG图片</span></span><br><span class="line">slider_pic = cv2.imread(<span class="string">&#x27;slider_elem.jpg&#x27;</span>, <span class="number">0</span>)  <span class="comment"># type: ndarray</span></span><br><span class="line">bk_pic = cv2.imread(<span class="string">&#x27;bk_elem.jpg&#x27;</span>, <span class="number">0</span>)  <span class="comment"># type: ndarray</span></span><br></pre></td></tr></table></figure>

<img src="Python3网络爬虫开发实战-8验证码识别/bk_resize.jpg" alt="bk_resize" style="zoom:80%;" />

<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-8%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/slider_resize.jpg" alt="slider_resize"></p>
<p>将保存图片进行缩放处理，缩放到网页上缺口图和背景图大小</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#获取缺口y值 计算缩放宽高</span></span><br><span class="line">slider_resize_y = slider_elem.location.get(<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">slider_resize_w, slider_resize_h = (slider_elem.size.get(<span class="string">&#x27;width&#x27;</span>), slider_elem.size.get(<span class="string">&#x27;height&#x27;</span>))</span><br><span class="line">bk_resize_y = bk_elem.location.get(<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">bk_resize_w, bk_resize_h = (bk_elem.size.get(<span class="string">&#x27;width&#x27;</span>), bk_elem.size.get(<span class="string">&#x27;height&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#对图片缩放处理后重新保存</span></span><br><span class="line">slider_resize = cv2.resize(slider_pic, (slider_resize_w, slider_resize_h))</span><br><span class="line">bk_resize = cv2.resize(bk_pic, (bk_resize_w, bk_resize_h))</span><br><span class="line">cv2.imwrite(<span class="string">&#x27;slider_resize.jpg&#x27;</span>, slider_resize)</span><br><span class="line">cv2.imwrite(<span class="string">&#x27;bk_resize.jpg&#x27;</span>, bk_resize)</span><br></pre></td></tr></table></figure>

<p>将背景图上缺口上下部分裁剪处理方便识别</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#裁剪方法 retval = img[y:y+h, x:x+w]  x,y 左上角坐标值 w,h 宽度、高度</span></span><br><span class="line"><span class="comment">#裁剪中间部分 (0,43,340,68)</span></span><br><span class="line">x,y,w,h = [<span class="number">0</span>, slider_resize_y-bk_resize_y, bk_resize_w, slider_resize_h]</span><br><span class="line">bk_cutimg = bk_resize[y:y+h, x:x+w]</span><br><span class="line"></span><br><span class="line"> cv2.imwrite(<span class="string">&#x27;bk_cutimg.jpg&#x27;</span>, bk_cutimg)</span><br></pre></td></tr></table></figure>

<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-8%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/bk_cutimg.jpg" alt="bk_cutimg"></p>
<p>消除噪声，边缘识别</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">canny</span>(<span class="params">image</span>):</span></span><br><span class="line">  <span class="comment">#高斯滤波 消除噪声干扰</span></span><br><span class="line">  image = cv2.GaussianBlur(image, (<span class="number">3</span>,<span class="number">3</span>), <span class="number">0</span>)</span><br><span class="line">  <span class="comment">#边缘识别</span></span><br><span class="line">  <span class="keyword">return</span> cv2.Canny(image, <span class="number">50</span>, <span class="number">150</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 读取滑块图</span></span><br><span class="line">slider_pic = cv2.imread(<span class="string">&#x27;slider_resize.jpg&#x27;</span>)</span><br><span class="line"><span class="comment"># 读取背景图</span></span><br><span class="line">bk_cutimg = cv2.imread(<span class="string">&#x27;bk_cutimg.jpg&#x27;</span>)</span><br><span class="line"></span><br><span class="line">slider_pic = canny(slider_pic)</span><br><span class="line">bk_cutimg = canny(bk_cutimg)</span><br><span class="line"></span><br><span class="line">cv2.imwrite(<span class="string">&#x27;canny_slider.jpg&#x27;</span>, slider_pic)</span><br><span class="line">cv2.imwrite(<span class="string">&#x27;canny_bk.jpg&#x27;</span>, bk_cutimg)</span><br></pre></td></tr></table></figure>

<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-8%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/canny_bk.jpg" alt="canny_bk"></p>
<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-8%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/canny_slider.jpg" alt="canny_slider"></p>
<p>模板匹配，将匹配的缺口位置绘制出来</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#模板匹配</span></span><br><span class="line"><span class="comment"># 比较两张图的重叠区域</span></span><br><span class="line">result = cv2.matchTemplate(bk_cutimg, slider_pic, cv2.TM_CCORR_NORMED)  <span class="comment"># type: ndarray</span></span><br><span class="line">top, left = np.unravel_index(result.argmax(), result.shape)</span><br><span class="line">print(<span class="string">&#x27;滑块缺口位置&#x27;</span>, left, top, slider_resize_w, slider_resize_h)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 绘制缺口矩形</span></span><br><span class="line">img_draw = bk_cutimg.copy()</span><br><span class="line">cv2.rectangle(img_draw, pt1=(left, top), pt2=(left + slider_resize_w, top + slider_resize_h), color=(<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>), thickness=<span class="number">5</span>)</span><br><span class="line">cv2.imwrite(<span class="string">&#x27;img_draw.png&#x27;</span>, img_draw)</span><br></pre></td></tr></table></figure>

<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-8%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/img_draw.png" alt="img_draw"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#等待拖动滑块显示</span></span><br><span class="line">slider = wait.until(EC.presence_of_element_located((By.XPATH, <span class="string">&#x27;//*[@id=&quot;secsdk-captcha-drag-wrapper&quot;]/div[2]&#x27;</span>)))  <span class="comment"># type: WebElement</span></span><br></pre></td></tr></table></figure>

<p>根据缺口位置，生成移动轨迹</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_track</span>(<span class="params">distance</span>):</span></span><br><span class="line">  print(<span class="string">&#x27;distance=&#x27;</span>, distance)</span><br><span class="line">  <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  根据偏移量获取移动轨迹</span></span><br><span class="line"><span class="string">  :param distance: 偏移量</span></span><br><span class="line"><span class="string">  :return: 移动轨迹</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  rate = <span class="number">0.6</span></span><br><span class="line">  t = <span class="number">0.2</span></span><br><span class="line">  v = <span class="number">0</span></span><br><span class="line">  tracks = []</span><br><span class="line">  mid = rate * distance</span><br><span class="line">  s = <span class="number">0</span></span><br><span class="line">  <span class="keyword">while</span> s &lt; distance:</span><br><span class="line">      v0 = v</span><br><span class="line">      <span class="keyword">if</span> s &lt; mid:</span><br><span class="line">          a = <span class="number">20</span></span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">          a = <span class="number">-3</span></span><br><span class="line">      s0 = v0 * t + <span class="number">0.5</span> * a * t * t</span><br><span class="line">      v = v0 + a + t</span><br><span class="line">      tracks.append(<span class="built_in">round</span>(s0))</span><br><span class="line">      s += s0</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">sum</span>(tracks) != distance:</span><br><span class="line">      tracks.append(distance-<span class="built_in">sum</span>(tracks))</span><br><span class="line">  <span class="keyword">return</span> tracks</span><br></pre></td></tr></table></figure>

<p>模拟拖动滑块</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shake_mouse</span>():</span></span><br><span class="line">  ActionChains(browser).move_by_offset(xoffset=<span class="number">-2</span>,yoffset=<span class="number">0</span>).perform()</span><br><span class="line">  ActionChains(browser).move_by_offset(xoffset=<span class="number">2</span>,yoffset=<span class="number">0</span>).perform()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">move_to_gap</span>(<span class="params">slider, tracks</span>):</span></span><br><span class="line">  <span class="comment"># back_tracks = [-1, -1, -2, -2, -3, -2, -2, -1, -1]</span></span><br><span class="line">  ActionChains(browser).click_and_hold(slider).perform()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> x <span class="keyword">in</span> tracks:</span><br><span class="line">      ActionChains(browser).move_by_offset(xoffset=x,yoffset=<span class="number">0</span>).perform()</span><br><span class="line">  sleep(<span class="number">0.5</span>)</span><br><span class="line">  <span class="comment"># for x in back_tracks:</span></span><br><span class="line">  <span class="comment">#     ActionChains(browser).move_by_offset(xoffset=x,yoffset=0).perform()</span></span><br><span class="line">  shake_mouse()</span><br><span class="line">  sleep(<span class="number">0.5</span>)</span><br><span class="line">  ActionChains(browser).release().perform()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tracks = get_track(left) <span class="comment"># type: list</span></span><br><span class="line">tracks = <span class="built_in">list</span>(<span class="built_in">filter</span>(<span class="keyword">lambda</span> x: x != <span class="number">0</span>, tracks))</span><br><span class="line">move_to_gap(slider, tracks)</span><br></pre></td></tr></table></figure>



<ul>
<li>保存图片的方式</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">captcha = browser.find_element_by_css_selectro(<span class="string">&#x27;#captcha&#x27;</span>)</span><br><span class="line">image = Image.<span class="built_in">open</span>(BytesIO(captcha.screenshot_as_png))</span><br></pre></td></tr></table></figure>

<p>直接保存图片</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">captcha.screenshot(<span class="string">&#x27;xx.png&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="8-6-使用深度学习识别图形验证码"><a href="#8-6-使用深度学习识别图形验证码" class="headerlink" title="8.6 使用深度学习识别图形验证码"></a>8.6 使用深度学习识别图形验证码</h5><p>深度学习框架 PyTorch</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pip3 install torch torchvision</span><br></pre></td></tr></table></figure>

<h5 id="8-7-使用深度学习识别滑动验证码缺口"><a href="#8-7-使用深度学习识别滑动验证码缺口" class="headerlink" title="8.7 使用深度学习识别滑动验证码缺口"></a>8.7 使用深度学习识别滑动验证码缺口</h5><h5 id="8-8-打码平台识别验证码"><a href="#8-8-打码平台识别验证码" class="headerlink" title="8.8 打码平台识别验证码"></a>8.8 打码平台识别验证码</h5><h5 id="8-9-手机验证码的自动化处理"><a href="#8-9-手机验证码的自动化处理" class="headerlink" title="8.9 手机验证码的自动化处理"></a>8.9 手机验证码的自动化处理</h5><p>Flask 写一个 API，代码保存为 server.py 运行</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python3 server.py</span><br></pre></td></tr></table></figure>

<p>为了方便测试，可以用 Ngrok 工具将该服务暴露到公网</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ngrok http 500</span><br></pre></td></tr></table></figure>

<p>Ngrok 可以方便地将任何非公网的服务暴露到公网访问，并配置特定的二级临时二级域名，但一个域名有时长限制，所以通常仅供测试使用 <a href="https://gnrok.com/">https://gnrok.com</a></p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
</search>
