<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"8.0.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>

  <meta name="description" content="简单记录下">
<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="简单记录下">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="daxun">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/2/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Hexo</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Hexo</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">简单记录下</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">daxun</p>
  <div class="site-description" itemprop="description">简单记录下</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
        
          <span class="site-state-item-count">93</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">
      

      
    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/04/%E9%80%86%E5%90%91-Theos/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/04/%E9%80%86%E5%90%91-Theos/" class="post-title-link" itemprop="url">逆向-Theos</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-07-04 17:45:49" itemprop="dateCreated datePublished" datetime="2022-07-04T17:45:49+08:00">2022-07-04</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-10-23 19:06:45" itemprop="dateModified" datetime="2022-10-23T19:06:45+08:00">2022-10-23</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/ludashi/p/5714095.html">逆向工程之Theos</a></p>
<p><a target="_blank" rel="noopener" href="https://theos.dev/docs/logos">Tweak Logos</a></p>
<p>Theos 一个跨平台的越狱开发工具包</p>
<p>Theos 相当于对 Cydia Substrate 的封装，因而能实现对 Object-C 运行时的 Hook，也能实现对 C 语言函数的 Hook</p>
<h4 id="Theos-安装"><a href="#Theos-安装" class="headerlink" title="Theos 安装"></a>Theos 安装</h4><h5 id="安装-ldid"><a href="#安装-ldid" class="headerlink" title="安装 ldid"></a>安装 ldid</h5><p>Theos 开发中，iOS 文件的签名由 ldid 工具来完成，ldid 取代了 Xcode 自带的 codesign</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew instll ldid</span><br></pre></td></tr></table></figure>

<p>或者下载 <a target="_blank" rel="noopener" href="http://joedj.net/ldid">http://joedj.net/ldid</a> 放到 /opt/theos/bin 目录下，添加执行权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod 777 &#x2F;opt&#x2F;theos&#x2F;bin&#x2F;ldid</span><br></pre></td></tr></table></figure>

<ul>
<li>安装 xz、lzma（没装）</li>
</ul>
<p>两种压缩模块，为了后面 <code>make package</code> 能顺利通过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ brew install xz</span><br><span class="line">$ sudo cpan IO::Compress::Lzma</span><br></pre></td></tr></table></figure>

<h5 id="安装-dpkg，dpkg-deb"><a href="#安装-dpkg，dpkg-deb" class="headerlink" title="安装 dpkg，dpkg-deb"></a>安装 dpkg，dpkg-deb</h5><p>可以使用 dpkg 制作 deb，Theos开发的插件都会以deb的格式进行发布</p>
<p>有了 dpkg-deb，Theos才能正确把工程打包成 deb 文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew install dpkg</span><br><span class="line">brew install dpkg-deb</span><br></pre></td></tr></table></figure>

<ul>
<li>添加环境变量</li>
</ul>
<p>.bash_profile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export THEOS&#x3D;&#x2F;opt&#x2F;theos</span><br><span class="line">export PATH&#x3D;$PATH:$THEOS&#x2F;bin</span><br></pre></td></tr></table></figure>

<h5 id="安装-theos"><a href="#安装-theos" class="headerlink" title="安装 theos"></a>安装 theos</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo git clone --recursive https:&#x2F;&#x2F;github.com&#x2F;theos&#x2F;theos.git $THEOS</span><br></pre></td></tr></table></figure>

<ul>
<li>设置 $THEOS 用户组权限</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo chown -R $(id -u):$(id -g) $THEOS</span><br></pre></td></tr></table></figure>

<p>最后 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ source ~&#x2F;.bash_profile</span><br></pre></td></tr></table></figure>

<h4 id="常用模块"><a href="#常用模块" class="headerlink" title="常用模块"></a>常用模块</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$THEOS&#x2F;bin&#x2F;nic.pl</span><br><span class="line">NIC 2.0 - New Instance Creator</span><br><span class="line">------------------------------</span><br><span class="line">  [1.] iphone&#x2F;activator_event</span><br><span class="line">  [2.] iphone&#x2F;application_modern</span><br><span class="line">  [3.] iphone&#x2F;application_swift</span><br><span class="line">  [4.] iphone&#x2F;flipswitch_switch</span><br><span class="line">  [5.] iphone&#x2F;framework</span><br><span class="line">  [6.] iphone&#x2F;library</span><br><span class="line">  [7.] iphone&#x2F;preference_bundle_modern</span><br><span class="line">  [8.] iphone&#x2F;tool</span><br><span class="line">  [9.] iphone&#x2F;tool_swift</span><br><span class="line">  [10.] iphone&#x2F;tweak</span><br><span class="line">  [11.] iphone&#x2F;xpc_service</span><br><span class="line">Choose a Template (required):</span><br></pre></td></tr></table></figure>

<p>tweak：插件模板</p>
<p>tool：命令行工具模板</p>
<p>application：系统级应用模板</p>
<p>xpc_service：XPC 服务模板</p>
<h4 id="Tweak插件开发"><a href="#Tweak插件开发" class="headerlink" title="Tweak插件开发"></a>Tweak插件开发</h4><p>iOS 越狱平台下的插件称为 tweak。实质就是 iOS 平台的动态库 dylib，利用 Cydia Substrate 提供的组件进行加载，完成特定功能</p>
<p>所有 Tweak 都保存在 /Library/MobileSubstrate/DynamicLibraries 目录，Tweak 后缀名为 .dylib</p>
<p>终端输入 nic.pl，工程模板选择 [10.] iphone/tweak，创建一个 tweak 工程</p>
<ul>
<li>配置参数</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Project Name (required): 项目名称</span><br><span class="line">Package Name [com.yourcompany.langjitweak]: 包名</span><br><span class="line">Author&#x2F;Maintainer Name 作者名字，默认当前登录用户名</span><br><span class="line">[iphone&#x2F;tweak] MobileSubstrate Bundle filter: 注入应用的BundleID</span><br><span class="line">[iphone&#x2F;tweak] List of applications to terminate upon installation (space-separated, &#39;-&#39; for none) [SpringBoard]: 安装成功后需结束的进程，默认SpringBoard，不需要结束任务进程输入 -</span><br></pre></td></tr></table></figure>

<p>为了方便修改，可以在生成的文件夹新建 Xcode 项目，将文件拖入 Xcode 项目编辑</p>
<ul>
<li>目录结构</li>
</ul>
<p>![图片 1](逆向-Theos/图片 1.png)</p>
<h5 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h5><p>指定工程用到源文件、框架、库等信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">#引入Makefile的公共文件</span><br><span class="line">include $(THEOS)&#x2F;makefiles&#x2F;common.mk  </span><br><span class="line">#指定处理器架构 多个架构空格分开 最新的A12处理器设备还需要arm64e</span><br><span class="line">ARCHS&#x3D;arm64 arm64e</span><br><span class="line"></span><br><span class="line">#指定目标规范 A12处理器设备指定SDK版本必须大于10.1</span><br><span class="line">#指定目标平台为iOS，编译器为clang，使用10.2版本SDK编译该tweak，编译后的程序只能在8.0及以上系统运行</span><br><span class="line"></span><br><span class="line">TARGET &#x3D; iphone:clang:10.2:8.0</span><br><span class="line">#可以省略编译类型 SDK设置为latest 指定Tweak支持的系统版本</span><br><span class="line">TARGET &#x3D; iphone:latest:8.0</span><br><span class="line"></span><br><span class="line">#指定的项目名称</span><br><span class="line">TWEAK_NAME &#x3D; iThunderHelper		</span><br><span class="line">iThunderHelper_CFLAGS &#x3D; -fobjc-arc</span><br><span class="line"></span><br><span class="line">#tweak包含的源文件(头文件除外)多个文件空格分开</span><br><span class="line">#如 iThunderHelper_FILES &#x3D; Tweak.xm ANYMethodLog.m PYG.m</span><br><span class="line">iThunderHelper_FILES &#x3D; Tweak.xm				</span><br><span class="line"></span><br><span class="line">#根据不同工程类型指定.mk文件，tweak工程是tweak.mk 还可以填入 application.mk及tool.mk</span><br><span class="line">include $(THEOS_MAKE_PATH)&#x2F;tweak.mk</span><br><span class="line"></span><br><span class="line">#导入Framework</span><br><span class="line">iThunderHelper_FRAMEWORKS &#x3D; UIKit</span><br><span class="line"></span><br><span class="line">#导入私有Framework</span><br><span class="line">iThunderHelper_PRIVATE_FRAMEWORKS &#x3D; ChatKit</span><br><span class="line"></span><br><span class="line">#链接动态库 libz.dylib和libsqlite.dylib</span><br><span class="line">iThunderHelper_LDFLAGS &#x3D; -lz -lsqlite</span><br><span class="line"></span><br><span class="line">iThunderHelper_LIBRARIES &#x3D; rocketbootstrap</span><br><span class="line"></span><br><span class="line">#这里做了端口映射 需要iproxy 2222 22</span><br><span class="line">THEOS_DEVICE_IP &#x3D; localhost</span><br><span class="line">THEOS_DEVICE_PORT &#x3D; 2222  </span><br><span class="line">或者</span><br><span class="line">THEOS_DEVICE_IP &#x3D; IP地址 </span><br><span class="line"></span><br><span class="line">#安装后执行的命令</span><br><span class="line">after-install::  </span><br><span class="line">	install.exec &quot;kill -9 MobileSMS&quot;</span><br></pre></td></tr></table></figure>

<h5 id="Tweak-xm"><a href="#Tweak-xm" class="headerlink" title="Tweak.xm"></a>Tweak.xm</h5><p> 生成的默认源文件，后缀 .xm 表示支持 Logos 和 C/C++语法，如果后缀为 .x ，说明源文件支持 Logos和C语法</p>
<h5 id="control"><a href="#control" class="headerlink" title="control"></a>control</h5><p>deb 包的必备文件，记录 deb 包管理系统所需的基本信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Package: com.ithunderhelper #deb包的唯一ID</span><br><span class="line">Name: ithunderhelper #描述tweak名字</span><br><span class="line"></span><br><span class="line">#deb包的依赖项，多个依赖逗号隔开，指定版本号则在后面用括号标注</span><br><span class="line"># Depends: mobilesubstrate, com.rpetrich.rocketbootstrap(&gt;&#x3D;1.0.2)</span><br><span class="line">Depends: mobilesubstrate </span><br><span class="line"></span><br><span class="line">Version: 0.0.1	#deb包当前版本</span><br><span class="line">Architecture: iphoneos-arm #描述deb包的架构，不可修改</span><br><span class="line">Description: An awesome MobileSubstrate tweak!  #对tweak的简要描述</span><br><span class="line">Maintainer: cao #deb包维护人员</span><br><span class="line">Author: cao  #描述tweak的开发者</span><br><span class="line">Section: Tweaks #deb包所属类别</span><br></pre></td></tr></table></figure>

<h5 id="iThunderHelper-plist"><a href="#iThunderHelper-plist" class="headerlink" title="iThunderHelper.plist"></a>iThunderHelper.plist</h5><p> tweak的作用对象</p>
<h5 id="编译打包安装"><a href="#编译打包安装" class="headerlink" title="编译打包安装"></a>编译打包安装</h5><ul>
<li>编译</li>
</ul>
<p>编译 make，从日志看到 Theos 完成了预处理、编译、链接、签名一系列动作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br></pre></td></tr></table></figure>

<p>编译生成 dylib 文件保存在 .theos/obj/debug/ 文件夹下</p>
<p>arm64和armv7分别有相应架构的 dylib 文件，外层的dylib 则是所有架构合并后的</p>
<ul>
<li>指定编译模式</li>
</ul>
<p>tweak 默认编译模式是 debug，如果想改为 release，只需要指定 DEBUG=0</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ DEBUG&#x3D;0 make</span><br></pre></td></tr></table></figure>

<ul>
<li>打包</li>
</ul>
<p>make package 会先执行 make 命令，然后执行 dpkg-deb 命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make package</span><br></pre></td></tr></table></figure>

<p>在 ./packages 目录生成一个 deb 包</p>
<ul>
<li>安装</li>
</ul>
<p>图形安装：</p>
<p>可以把 deb 通过爱思助手或者 scp 拷贝到设备指定目录，iFile 找到 deb 包，进入文件详情，点击安装</p>
<p>命令行安装：</p>
<p>scp 拷贝到设备，再利用 dpkg 命令安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ dpkg -i xxx.deb</span><br></pre></td></tr></table></figure>

<p>通过Theos安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ make package install</span><br></pre></td></tr></table></figure>

<h4 id="Logos语法"><a href="#Logos语法" class="headerlink" title="Logos语法"></a>Logos语法</h4><h5 id="hook"><a href="#hook" class="headerlink" title="%hook"></a>%hook</h5><p>指定需要hook的Class 以%end结尾</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%hook MainViewController</span><br><span class="line"><span class="comment">//hook的方法</span></span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<h5 id="log"><a href="#log" class="headerlink" title="%log"></a>%log</h5><p>打印类名、函数、参数等信息</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%log((<span class="built_in">NSString</span> *)<span class="string">@&quot;tutuTest&quot;</span>, (<span class="built_in">NSString</span> *)<span class="string">@&quot;Debug&quot;</span>);</span><br></pre></td></tr></table></figure>

<h5 id="orig"><a href="#orig" class="headerlink" title="%orig"></a>%orig</h5><p>执行原始代码</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//可以有返回值 </span></span><br><span class="line"><span class="keyword">id</span> value = %orig;</span><br><span class="line"><span class="comment">//调用原来方法 </span></span><br><span class="line"><span class="keyword">id</span> value = %orig(arg1);</span><br><span class="line"></span><br><span class="line"><span class="comment">//%orig还可以更改原始函数的参数  %orig(参数)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//将arg的参数修改为change arg2</span></span><br><span class="line">%orig(<span class="string">@&quot;change arg2&quot;</span>, arg2); </span><br></pre></td></tr></table></figure>

<h5 id="group"><a href="#group" class="headerlink" title="%group"></a>%group</h5><p>将hook分组，便于代码管理及按条件初始化，以%end结尾</p>
<p>一个 %group 可以包含多个%hook，不属于某个自定义group的%hook会被归类到%group _ungrouped中</p>
<p>如果定义了group 那么一定要写%init(group)</p>
<p>%init初始化某个%group 必须在%hook或%ctor内调用</p>
<p>调用了%init，%group才能起作用</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">%group group1</span><br><span class="line">%hook ViewController</span><br><span class="line">-(<span class="keyword">void</span>)loginBtnCloick:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;111&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">%end</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%group group2</span><br><span class="line">%hook ViewController</span><br><span class="line">-(<span class="keyword">void</span>)loginBtnCloick:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;222&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">%end</span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<p>group需要初始化</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">%ctor &#123;</span><br><span class="line"> <span class="built_in">NSString</span> *v = [[<span class="built_in">UIDevice</span> currentDevice] systemVersion];</span><br><span class="line"> <span class="keyword">if</span>(v.doubleValue &gt; <span class="number">11.0</span>) &#123;</span><br><span class="line">    %init(group1)；</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    %init(group2)；</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%hook TargetClass</span><br><span class="line">- (<span class="keyword">void</span>)targetMethod &#123;</span><br><span class="line">  <span class="built_in">NSString</span> *v = [[<span class="built_in">UIDevice</span> currentDevice] systemVersion];</span><br><span class="line"> <span class="keyword">if</span>(v.doubleValue &gt; <span class="number">11.0</span>) &#123;</span><br><span class="line">    %init(group1)；</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    %init(group2)；</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<h5 id="ctor"><a href="#ctor" class="headerlink" title="%ctor"></a>%ctor</h5><p>完成初始化工作 没定义会隐式生成 构造函数，构造函数</p>
<p>一般可以用来初始化%group 不需要%end结尾</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">%hook SpringBoard</span><br><span class="line"><span class="comment">//hook方法</span></span><br><span class="line">%end</span><br><span class="line">%ctor &#123;</span><br><span class="line">    %init(_ungrouped); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="dtor"><a href="#dtor" class="headerlink" title="%dtor"></a>%dtor</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%dtor &#123;</span><br><span class="line">    <span class="comment">//析构</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="new"><a href="#new" class="headerlink" title="%new"></a>%new</h5><p>给现有class添加新函数</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">%hook XLMemberManager</span><br><span class="line"><span class="comment">//hook方法</span></span><br><span class="line"><span class="comment">//%new 不用%end  写在%hook类内部</span></span><br><span class="line">%new</span><br><span class="line">- (<span class="keyword">void</span>)newmethod &#123;</span><br><span class="line">&#125;</span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<p>添加了新方法，使用 [self newmethod] 调用会报错。</p>
<p>只需要加个定义，骗过编译器</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">XLMemberManager</span></span></span><br><span class="line">- (<span class="keyword">void</span>)newmethod;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h5 id="c"><a href="#c" class="headerlink" title="%c"></a>%c</h5><p>动态获取一个类的定义 相当于objc_getClass 或 NSClassFroming</p>
<p>获取某个类 %c(ViewController)</p>
<p>然后可以调用类方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">XLMemberConfigure</span></span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line">...</span><br><span class="line">XLMemberConfigure *configure = [[%c(XLMemberConfigure) alloc] init];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;memberConfigure=%@&quot;</span>, configure);</span><br></pre></td></tr></table></figure>

<h5 id="property"><a href="#property" class="headerlink" title="%property"></a>%property</h5><p>添加属性</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%subclass MyObject: <span class="built_in">NSObject</span></span><br><span class="line">%property (<span class="keyword">nonatomic</span>, <span class="keyword">retain</span>) <span class="built_in">NSString</span> *someValue;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h5 id="subclass"><a href="#subclass" class="headerlink" title="%subclass"></a>%subclass</h5><p>运行时创建子类</p>
<p>父类中不存在的方法用%new说明符，要实例化新类的一个对象用%c运算符</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">%subclass MyObject : <span class="built_in">NSObject</span></span><br><span class="line">- (<span class="keyword">id</span>)init &#123;</span><br><span class="line">	<span class="keyword">self</span> = %orig;</span><br><span class="line">	[<span class="keyword">self</span> setSomeValue:<span class="string">@&quot;value&quot;</span>];</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//the following two new methods act as `@property (nonatomic, retain) id someValue;`</span></span><br><span class="line">%new</span><br><span class="line">- (<span class="keyword">id</span>)someValue &#123;</span><br><span class="line">	<span class="keyword">return</span> objc_getAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(someValue));</span><br><span class="line">&#125;</span><br><span class="line">%new</span><br><span class="line">- (<span class="keyword">void</span>)setSomeValue:(<span class="keyword">id</span>)value &#123;</span><br><span class="line">	objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(someValue), value, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">&#125;</span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<h5 id="hookf"><a href="#hookf" class="headerlink" title="%hookf"></a>%hookf</h5><p>给指定函数生成Hook，是对 MSHookFunction() 函数的包装格式</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//rtype：返回值</span></span><br><span class="line"><span class="comment">//symbolName：原函数地址</span></span><br><span class="line">%hookf(rtype, symbolName, args...)&#123;...&#125;</span><br></pre></td></tr></table></figure>

<p>symbolName 可以传入函数地址或者函数符号</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//传入地址</span></span><br><span class="line">FILE *fopen(<span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">const</span> <span class="keyword">char</span> *mode);</span><br><span class="line">%hookf(File *, fopen, <span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">const</span> <span class="keyword">char</span> *mode) &#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;fopen hooked&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(path[<span class="number">0</span>] !=<span class="string">&#x27;/&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> %orig;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果将 symbolName 作为字符串传入，那么函数将被动态查找</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FILE *fopen(<span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">const</span> <span class="keyword">char</span> *mode);</span><br><span class="line">%hookf(File *, <span class="string">&quot;_open&quot;</span>, <span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">const</span> <span class="keyword">char</span> *mode) &#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;fopen hooked&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(path[<span class="number">0</span>] !=<span class="string">&#x27;/&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> %orig;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Logos-Tip"><a href="#Logos-Tip" class="headerlink" title="Logos Tip"></a>Logos Tip</h4><h5 id="获取类成员变量"><a href="#获取类成员变量" class="headerlink" title="获取类成员变量"></a>获取类成员变量</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用substitute提供的MSHookIvar</span></span><br><span class="line"><span class="built_in">UIView</span> *_anyView = MSHookIvar&lt;<span class="built_in">UIView</span>*&gt;(<span class="keyword">self</span>,<span class="string">&quot;_view&quot;</span>);</span><br><span class="line">_anyView.backgroundColor = [<span class="built_in">UIColor</span> redColor];</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用原生valueForKey</span></span><br><span class="line">XLMemberConfigure *config = [<span class="keyword">self</span> valueForKey:<span class="string">@&quot;_config&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用ZKSwizzle提供的ZKHookIvar</span></span><br><span class="line"><span class="meta">#import ZKSwizzle<span class="meta-string">&quot;&quot;</span></span></span><br><span class="line"><span class="built_in">NSString</span> *deviceMode = ZKHookIvar(config, <span class="built_in">NSString</span> *, <span class="string">&quot;_deviceModel&quot;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>打印参数Class</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">void</span>)showLuckyMoneyWithPickingStatus:(<span class="built_in">NSObject</span> *)arg1 withController:(<span class="keyword">id</span>)arg2 delegate:(<span class="keyword">id</span>)arg3</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">NSLog</span>(<span class="string">@&quot;status = %@, className = %@&quot;</span>,arg1,<span class="built_in">NSStringFromClass</span>(arg1.class));</span><br><span class="line">	%log; %orig;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>方法声明</li>
</ul>
<p>需要在注入的类里面调用某个方法 添加方法的声明就可以了 </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">P1HomeNearbyViewController</span> : <span class="title">UIViewController</span></span></span><br><span class="line">- (<span class="keyword">void</span>)takeAction:(<span class="keyword">id</span>)arg1 withEvent:(<span class="keyword">id</span>)arg2;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>也可以不用写父类 </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">P1HomeNearbyViewController</span></span></span><br><span class="line">- (<span class="keyword">void</span>)takeAction:(<span class="keyword">id</span>)arg1 withEvent:(<span class="keyword">id</span>)arg2;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>再 hook P1HomeNearbyViewController的 takeAction 方法里就可以直接用self 否则会self报错</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)takeAction:(<span class="keyword">id</span>)arg1 withEvent:(<span class="keyword">id</span>)arg2 &#123;</span><br><span class="line">  dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">1.0</span> * <span class="built_in">NSEC_PER_SEC</span>)),      dispatch_get_main_queue(), ^&#123;</span><br><span class="line">      [<span class="keyword">self</span> takeAction:arg1 withEvent:arg2];</span><br><span class="line">  &#125;);</span><br><span class="line">  %log;</span><br><span class="line">  %or&#125;ig;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>类声明</li>
</ul>
<p>为了通过编译，有些类需要声明，可以创建 .h 头文件，内容都是从 class-dump 出来的文件拷贝</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">PSSpecifier</span>:<span class="title">NSObject</span> </span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">retain</span>) <span class="keyword">id</span> target;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">PSSpecifier</span></span></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>Tweak.xm </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&quot;PSSpecifier.h&quot;</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>修改返回值</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//能否预览 直接1可以预览</span></span><br><span class="line">- (_Bool )canPreview &#123;</span><br><span class="line">  %log;</span><br><span class="line">  _Bool r = %orig;</span><br><span class="line">  r = <span class="number">1</span>;<span class="comment">//返回1</span></span><br><span class="line">  HBLogDebug(<span class="string">@&quot; = %d&quot;</span>, r);</span><br><span class="line">  <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>注释方法</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)timerAction:(<span class="keyword">id</span>)arg1 &#123;</span><br><span class="line">  %log;</span><br><span class="line">  <span class="comment">//%orig;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>阻止alertcontroller弹窗</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加方法声明 重写presentViewController方法 阻止alertController显示</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">LivePlayBackVC</span> : <span class="title">UIViewController</span></span></span><br><span class="line">- (<span class="keyword">void</span>)presentViewController:(<span class="built_in">UIViewController</span> *)present animated:(<span class="built_in">BOOL</span>)animated completion:(<span class="keyword">void</span> (^ _Nullable)(<span class="keyword">void</span>))completion;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line">  </span><br><span class="line">%hook LivePlayBackVC</span><br><span class="line">- (<span class="keyword">void</span>)presentViewController:(<span class="built_in">UIViewController</span> *)present animated:(<span class="built_in">BOOL</span>)animated completion:(<span class="keyword">void</span> (^ _Nullable)(<span class="keyword">void</span>))completion&#123;</span><br><span class="line">    HBLogDebug(<span class="string">@&quot;presentViewController&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">%end</span><br></pre></td></tr></table></figure>

<ul>
<li>控制器跳转 </li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TBBuyStandardViewController *vc = [[%c(TBBuyStandardViewController) alloc] initWithNavigatorURL:arg1 query: arg2];</span><br></pre></td></tr></table></figure>

<h4 id="命令行工具开发"><a href="#命令行工具开发" class="headerlink" title="命令行工具开发"></a>命令行工具开发</h4><p>Theos 提供的 tool 模板用来编写命令行工具，Cydia Substrate 自带的 cynject 工具就是例子</p>
<p>编写小工具，根据输入进程名查找 PID （等同于ps -ax | grep xxx）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$THEOS&#x2F;bin&#x2F;nic.pl</span><br><span class="line">NIC 2.0 - New Instance Creator</span><br><span class="line">------------------------------</span><br><span class="line">[8.] iphone&#x2F;tool</span><br><span class="line">Choose a Template (required): 8</span><br><span class="line">Project Name (required): FindProcess</span><br><span class="line">Package Name [com.yourcompany.findprocess]:com.FindProcess</span><br><span class="line">Author&#x2F;Maintainer Name [midland]:</span><br><span class="line">Instantiating iphone&#x2F;tool in findprocess&#x2F;...</span><br><span class="line">Done.</span><br></pre></td></tr></table></figure>

<p>创建 tool 工程，接下来步骤和 tweak 类似，打开 main.mm 修改代码…</p>
<p>由于使用了纯 C 代码，输入 make 命令直接编译会出现错误，需将 main.mm 修改为 main.c</p>
<p>同时修改 Makefile 中的 findprocess_FILES 一行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">findprocess_FILES &#x3D; main.c</span><br></pre></td></tr></table></figure>

<p>DEBUG=0 make package install 将命令行工具安装到设备</p>
<p>如果提示 THEOS_DEVICE_IP 问题，添加环境变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export THEOS_DEVICE_IP&#x3D;192.168.0.101</span><br></pre></td></tr></table></figure>



<ul>
<li>兼容 iOS11-iOS13</li>
</ul>
<p>编译好的包在 iOS11-iOS13 可能出现 <code>killed:9</code> 错误</p>
<p>新建 ent.xml</p>
<img src="逆向-Theos/图片 2.png" alt="图片 2" style="zoom:80%;" />

<p>修改 Makefile，配置 CODESIGN_FLAGS 参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">findprocess_CODESIGN_FLAGS &#x3D; -S.&#x2F;ent.xml</span><br></pre></td></tr></table></figure>

<p>修改安装路径（不是必须的）命令行工具默认安装到 /usr/bin 目录，该路径可以修改配置 INSTALL_PATH 参数即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">findprocess_INSERT_PATH&#x3D; &#x2F;bin</span><br></pre></td></tr></table></figure>

<p>重新编译安装后 Cydia 里路径被改为 /bin 了</p>
<img src="逆向-Theos/图片 3.png" alt="图片 3" style="zoom:50%;" />

<p>测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~root# findprocess WeChat</span><br></pre></td></tr></table></figure>

<h4 id="系统应用开发"><a href="#系统应用开发" class="headerlink" title="系统应用开发"></a>系统应用开发</h4><p>Theos 提供的 application 模板用来开发系统级应用比如 Filza，权限更高无法通过常规方式删除</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$THEOS&#x2F;bin&#x2F;nic.pl</span><br><span class="line">NIC 2.0 - New Instance Creator</span><br><span class="line">------------------------------</span><br><span class="line">[2.] iphone&#x2F;application_modern</span><br><span class="line">Choose a Template (required): 2</span><br><span class="line">Project Name (required): bookApp</span><br><span class="line">Package Name [com.yourcompany.bookapp]: com.bookApp</span><br><span class="line">Author&#x2F;Maintainer Name [midland]:</span><br><span class="line">[iphone&#x2F;application_modern] Class name prefix (two or more characters) [XX]:CD</span><br></pre></td></tr></table></figure>

<p>生成文件</p>
<img src="逆向-Theos/图片 4.png" alt="图片 4" style="zoom:90%;" />

<p>修改文件 CDRootViewController.m 内容</p>
<img src="逆向-Theos/图片 5.png" alt="图片 5" style="zoom:80%;" />

<p>代码在视图中间添加 Test 按钮，单机按钮，获取进程权限，然后打开keychain数据库，由于使用了 sqlite3，所以需要修改 Makefile，增加 xxx_LDFLAGS参数将其链接进来</p>
<img src="逆向-Theos/图片 6.png" alt="图片 6" style="zoom:70%;" />

<p>after-install 是 deb 文件安装后执行的命令。第二条命令是结束进程</p>
<p>DEBUG=0 make package install 编译安装到设备</p>
<p>运行日志 getuid 和 geteuid 都返回了501（mobile权限）代码执行失败</p>
<ul>
<li>以root权限运行（iOS11以下）</li>
</ul>
<p>Linux下可以使用 setuid(0)及setgid(0)提升权限，打开 main.m 修改如下</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[]) &#123;</span><br><span class="line">	<span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">        setuid(<span class="number">0</span>);</span><br><span class="line">        setgid(<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">UIApplicationMain</span>(argc, argv, <span class="literal">nil</span>, <span class="built_in">NSStringFromClass</span>(CDAppDelegate.class));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译安装后闪退了，这是因为backboardd以mobile权限运行不能加载要求root权限的程序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~root# ps aux | grep backboardd</span><br><span class="line">mobile 2438 0.6 1.0 .....</span><br></pre></td></tr></table></figure>

<p>换句话说，崩溃是好事，说明提升成功了，对 iOS11 以下的系统处理方法比较复杂</p>
<p>。。。</p>
<ul>
<li>以root权限运行（iOS11、iOS12）</li>
<li>以root权限运行（iOS13）</li>
</ul>
<h4 id="守护进程开发"><a href="#守护进程开发" class="headerlink" title="守护进程开发"></a>守护进程开发</h4><p>守护进程是一个运行在系统后台、不受前台用户交互影响的进程，通常，守护进程以字母 d 结尾</p>
<p>其实就是一个命令行程序和一个 plist 文件构成</p>
<p>syslogd 是处理系统日志的后台，afc2d是文件服务的后台进程等</p>
<p>编写一个简单 pygioserbookd 守护进程，启动时打印一行日志，并往 tmp 目录写入 pp.log 文件后常驻后台</p>
<p>选择 tool 模板创建工程</p>
<p>修改 main.mm</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp) &#123;</span><br><span class="line">    <span class="built_in">NSString</span> *str = <span class="string">@&quot;[PYGiOSBook] 守护进程启动成功&quot;</span>;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, str);</span><br><span class="line">    [str writeToFile:<span class="string">@&quot;/tmp/pp.log&quot;</span> atomically:<span class="literal">YES</span> encoding:<span class="built_in">NSUTF8StringEncoding</span> error:<span class="literal">nil</span>];</span><br><span class="line">    <span class="comment">//保持运行</span></span><br><span class="line">    <span class="built_in">CFRunLoopRun</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>安装到设备，测试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root# pygioserbookd</span><br></pre></td></tr></table></figure>

<h5 id="守护进程配置"><a href="#守护进程配置" class="headerlink" title="守护进程配置"></a>守护进程配置</h5><p>新建 com.pygioserbookd.plist </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE plist PUBLIC &quot;-&#x2F;&#x2F;Apple&#x2F;&#x2F;DTD PLIST 1.0&#x2F;&#x2F;EN&quot; &quot;http:&#x2F;&#x2F;www.apple.com&#x2F;DTDs&#x2F;PropertyList-1.0.dtd&quot;&gt;</span><br><span class="line">&lt;plist version&#x3D;&quot;1.0&quot;&gt;</span><br><span class="line">&lt;dict&gt;</span><br><span class="line">	&lt;key&gt;RunAtLoad&lt;&#x2F;key&gt;</span><br><span class="line">	&lt;string&gt;true&lt;&#x2F;string&gt;</span><br><span class="line">	&lt;key&gt;Program&lt;&#x2F;key&gt;</span><br><span class="line">	&lt;string&gt;&#x2F;usr&#x2F;bin&#x2F;pygioserbookd&lt;&#x2F;string&gt;</span><br><span class="line">	&lt;key&gt;Label&lt;&#x2F;key&gt;</span><br><span class="line">	&lt;string&gt;com.pygioserbookd&lt;&#x2F;string&gt;</span><br><span class="line">&lt;&#x2F;dict&gt;</span><br><span class="line">&lt;&#x2F;plist&gt;</span><br></pre></td></tr></table></figure>

<p>Label：守护进程唯一标识</p>
<p>Program：对应的可执行文件</p>
<p>RunAtLoad：加载的同时启动</p>
<p>如果后台进程需要其它的参数，只需要在文件中增加类似下面的键值对即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;key&gt;ProgramArguments&lt;&#x2F;key&gt;</span><br><span class="line">&lt;array&gt;</span><br><span class="line">	&lt;string&gt;-m&lt;&#x2F;string&gt;</span><br><span class="line">	&lt;string&gt;-i&lt;&#x2F;string&gt;</span><br><span class="line">	&lt;string&gt;其它参数&lt;&#x2F;string&gt;</span><br><span class="line">&lt;&#x2F;array&gt;</span><br></pre></td></tr></table></figure>

<p>iOS 的根进程是 launchd，它会在开机时检查 /System/Library/LaunchDaemons 和 /Library/LaunchDaemons 目录下所有符合条件的 plist 文件。</p>
<p>所以把 com.pygioserbookd.plist 文件放到上面任意目录下，输入 reboot 重启设备（又要重新越狱），查看发现 pygioserbookd 已随系统启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root# ps aux | grep pygioserbookd</span><br></pre></td></tr></table></figure>

<p>也可以不重启，iOS 提供了 launchctl 命令行工具。用于显示、加载、卸载、启动和关闭守护进程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;获取信息</span><br><span class="line">&#x2F;&#x2F;第一列进程ID，如果显示 - 说明已加载，但没运行</span><br><span class="line">&#x2F;&#x2F;第二列上次退出的状态码，0成功，正数错误退出，负数收到信号后退出</span><br><span class="line">&#x2F;&#x2F;第三列守护进程唯一标识</span><br><span class="line">root# launchctl list  </span><br><span class="line">-   78 com.apple.networkd_priv</span><br><span class="line">258 0  com.apple.apsd</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;加载&#x2F;卸载（load&#x2F;unload）</span><br><span class="line">root# launchctl load &#x2F;Library&#x2F;LaunchDaemons&#x2F;com.pygioserbookd.plist</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;启动&#x2F;停止（start&#x2F;stop）</span><br><span class="line">root# launchctl start com.pygioserbookd</span><br></pre></td></tr></table></figure>

<h5 id="自动部署"><a href="#自动部署" class="headerlink" title="自动部署"></a>自动部署</h5><p>编写好守护进程，处理那些 plist 文件需要人工干预来处理，这里利用 Theos 的 layout 功能来完成自动部署</p>
<p>工程目录下创建 layout 文件夹，theos 在打包时会将其中的内容按照路径添加到 deb 包中</p>
<p>1、先将 com.pygioserbookd.plist 文件放到 layout/Library/LaunchDaemons 文件夹内</p>
<p>2、新建 DEBIAN 文件夹并将 control 移进来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir .&#x2F;layout&#x2F;DEBIAN</span><br><span class="line">$ mv control .&#x2F;layout&#x2F;DEBIAN</span><br></pre></td></tr></table></figure>

<p>3、在 DEBIAN 文件夹中分别新建 postinst、preinst、prerm 文件，各自内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#postinst deb包安装完成后所需的配置工作</span><br><span class="line">#!bin&#x2F;sh</span><br><span class="line">launchctl load &#x2F;Library&#x2F;LaunchDaemons&#x2F;com.pygioserbookd.plist</span><br><span class="line"></span><br><span class="line">#preinst 解压前执行的脚本</span><br><span class="line">#!bin&#x2F;sh</span><br><span class="line">launchctl unload &#x2F;Library&#x2F;LaunchDaemons&#x2F;com.pygioserbookd.plist 2&gt;&amp;1 &gt; &#x2F;dev&#x2F;null</span><br><span class="line"></span><br><span class="line">#prerm 卸载deb包前执行</span><br><span class="line">#!bin&#x2F;sh</span><br><span class="line">launchctl unload &#x2F;Library&#x2F;LaunchDaemons&#x2F;com.pygioserbookd.plist</span><br></pre></td></tr></table></figure>

<p>这几个脚本分别用于 deb 包安装前后的一些处理，其实是吧人工执行 launchctl 命令的过程用脚本代替</p>
<p>make package 打包后，所有文件已经按照 layout 的结构打包进去了。</p>
<p>利用 layout 能方便地将所有需要集成的文件统一进行处理</p>
<p>make package install 安装完后通过 launchctl list 查看 pygioserbookd 是还未启动的</p>
<ul>
<li>报错问题</li>
</ul>
<p>make package 之后提示 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ERROR: maintainer script &#39;preinst&#39; has bad permissions 644 (must be &gt;&#x3D;0555 and &lt;&#x3D;0775)</span><br><span class="line"></span><br><span class="line">#添加权限</span><br><span class="line">chmod 755 preinst</span><br><span class="line">chmod 755 postinst</span><br><span class="line">chmod 755 prerm</span><br></pre></td></tr></table></figure>





<h4 id="增加系统设置项"><a href="#增加系统设置项" class="headerlink" title="增加系统设置项"></a>增加系统设置项</h4><p>PreferenceLoader 是一个开源的基础依赖包，越狱插件的系统设置菜单就是由它提供，Cydia 搜索安装 PreferenceLoader</p>
<p>进入系统设置时 PreferenceLoader 会从 /Library/PreferenceLoader/Preferences/ 目录下解析符合规则的 plist 文件，并生成响应的控件动态添加到系统设置</p>
<p><a target="_blank" rel="noopener" href="http://iphonedevwiki.net/index.php/PreferenceBundles">http://iphonedevwiki.net/index.php/PreferenceBundles</a></p>
<p><a target="_blank" rel="noopener" href="https://iphonedev.wiki/index.php/Preferences_specifier_plist">https://iphonedev.wiki/index.php/Preferences_specifier_plist</a></p>
<p>theos 选择 iphone/preference_bundle_modern 模板</p>
<blockquote>
<p>需要引用私有库 Preferences，编译提示找不到路径</p>
</blockquote>
<h4 id="进程间通信"><a href="#进程间通信" class="headerlink" title="进程间通信"></a>进程间通信</h4><p>进程间通信（IPC）就是在不同进程之间传播或交换信息，正向开发中只能使用苹果公司提供 URLScheme，应用之间互相调用并且传送简单字符的一种机制</p>
<h5 id="Notification通信"><a href="#Notification通信" class="headerlink" title="Notification通信"></a>Notification通信</h5><p>CFNotificationCenterGetDarwinNotifyCenter() 有一个 userinfo 参数，但实际上无法传递，总是为 nil，不适合传递参数</p>
<h5 id="XPC通信"><a href="#XPC通信" class="headerlink" title="XPC通信"></a>XPC通信</h5><p>仅限于系统级别应用，如果用普通应用是不可达的</p>
<h5 id="RocketBootstrap通信"><a href="#RocketBootstrap通信" class="headerlink" title="RocketBootstrap通信"></a>RocketBootstrap通信</h5><p><a target="_blank" rel="noopener" href="https://iphonedev.wiki/index.php/RocketBootstrap#CPDistributedMessagingCenter_Example">RocketBootstrap</a></p>
<p>私有框架 APPSupport 中存在一个 CPDistributedMessagingCenter（分布式消息传递中心）使用简单的消息和字典来提供不同进程之间的通信</p>
<p>RocketBootstrap 就是在其上进行封装，越过沙盒限制，给越狱环境提供稳定的进程通信服务，cydia 中搜索安装即可</p>
<p>RocketBootstrap 要求在权限比较高的进程中启动一个服务，再通过发送通知的方式越过沙盒，因此创建一个 tweak 并注入 SpringBoard进程</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;rocketbootstrap/rocketbootstrap.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;AppSupport/CPDistributedMessagingCenter.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">%group HookSpringBoard</span><br><span class="line"></span><br><span class="line">%hook SpringBoard</span><br><span class="line">- (<span class="keyword">void</span>)applicationDidFinishLaunching:(<span class="keyword">id</span>)application &#123;</span><br><span class="line">    %orig;</span><br><span class="line">    CPDistributedMessagingCenter *c = [%c(CPDistributedMessagingCenter) centerNamed:<span class="string">@&quot;MyCPCenter&quot;</span>];</span><br><span class="line">    rocketbootstrap_distributedmessagingcenter_apply(c);</span><br><span class="line">    [c runServerOnCurrentThread];</span><br><span class="line">    [c registerForMessageName:<span class="string">@&quot;MyCPCenterNoti&quot;</span> target: <span class="keyword">self</span> selector:<span class="keyword">@selector</span>(handleMessage:withUserInfo:)];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;注册监听&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//收到沙盒内发的消息时弹出对话框</span></span><br><span class="line">%new</span><br><span class="line">- (<span class="keyword">void</span>)handleMessage:(<span class="built_in">NSString</span> *)name withUserInfo:(<span class="built_in">NSDictionary</span> *)userInfo &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;handleMessage withUserInfo&quot;</span>);</span><br><span class="line">    <span class="built_in">NSString</span> *action = userInfo[<span class="string">@&quot;action&quot;</span>];</span><br><span class="line">    <span class="keyword">if</span> ([action isEqualToString:<span class="string">@&quot;AlertView&quot;</span>]) &#123;</span><br><span class="line">        <span class="built_in">NSString</span> *nsInfo = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;book=%@, author=%@&quot;</span>, userInfo[<span class="string">@&quot;book&quot;</span>], userInfo[<span class="string">@&quot;author&quot;</span>]];</span><br><span class="line">        <span class="built_in">UIAlertView</span> *alert = [[<span class="built_in">UIAlertView</span> alloc] initWithTitle:<span class="string">@&quot;来自应用沙盒的消息&quot;</span> message:nsInfo delegate:<span class="literal">nil</span> cancelButtonTitle:<span class="string">@&quot;确定&quot;</span> otherButtonTitles: <span class="literal">nil</span>, <span class="literal">nil</span>];</span><br><span class="line">        [alert show];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%end</span><br><span class="line"></span><br><span class="line">%ctor &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;__[PYGiOSReBook] inject success__&quot;</span>);</span><br><span class="line">    <span class="built_in">NSString</span> *bundleIdentifier = [[<span class="built_in">NSBundle</span> mainBundle] bundleIdentifier];</span><br><span class="line">    <span class="keyword">if</span> ([bundleIdentifier isEqualToString:<span class="string">@&quot;com.apple.springboard&quot;</span>]) &#123;</span><br><span class="line">        %init(HookSpringBoard);</span><br><span class="line">    &#125;</span><br><span class="line">    %init;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>修改 Makefile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">include $(THEOS)&#x2F;makefiles&#x2F;common.mk</span><br><span class="line"></span><br><span class="line">TWEAK_NAME &#x3D; RocketBootstrapTest</span><br><span class="line"></span><br><span class="line">RocketBootstrapTest_FILES &#x3D; Tweak.xm</span><br><span class="line">RocketBootstrapTest_CFLAGS &#x3D; -fobjc-arc</span><br><span class="line"></span><br><span class="line">include $(THEOS_MAKE_PATH)&#x2F;tweak.mk</span><br><span class="line"></span><br><span class="line">ARCHS &#x3D; arm64</span><br><span class="line">RocketBootstrapTest_LIBRARIES &#x3D; rocketbootstrap</span><br><span class="line">RocketBootstrapTest_PRIVATE_FRAMEWORKS &#x3D; AppSupport</span><br></pre></td></tr></table></figure>

<p>还需要添加 AppSupport 框架，可以在 <a target="_blank" rel="noopener" href="https://github.com/theos/sdks">https://github.com/theos/sdks</a>  找到SDK 版本，选择和自己 SDK 接近的版本就可以了</p>
<p>下载的 SDK 两种使用方法：</p>
<p>1、如选择 iPhoneOS14.5，将整个 iPhoneOS14.5.sdk 文件夹复制到 $THEOS/sdks 目录下</p>
<p>修改 Makefile 的 TARGET 字段，强制指定 SDK 为下载版本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TARGET &#x3D; iphone:14.5:8.0</span><br></pre></td></tr></table></figure>

<p>2、将 iPhoneOS14.5.sdk/System/Library/PrivateFrameworks 目录下找到所需要的私有库（也可以全部选择）复制到目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;Applications&#x2F;Xcode.app&#x2F;Contents&#x2F;Developer&#x2F;Platforms&#x2F;iPhoneOS.platform&#x2F;Developer&#x2F;SDKs&#x2F;iPhoneOS.sdk&#x2F;System&#x2F;Library&#x2F;PrivateFr-ameworks</span><br><span class="line">（书上写的是PrivateFr-ameworks 不知道是不是写错了是 PrivateFrameworks）</span><br></pre></td></tr></table></figure>

<blockquote>
<p>两种方式都没成功，make 编译找不到库 ld: framework not found AppSupport</p>
</blockquote>
<ul>
<li>发送消息</li>
</ul>
<p>Xcode 新建项目，</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;rocketbootstrap/rocketbootstrap.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;AppSupport/CPDistributedMessagingCenter.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">NSMutableDictionary</span> *userInfo = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">userInfo[<span class="string">@&quot;action&quot;</span>] = <span class="string">@&quot;AlertView&quot;</span>;</span><br><span class="line">userInfo[<span class="string">@&quot;book&quot;</span>] = <span class="string">@&quot;book1&quot;</span>;</span><br><span class="line">userInfo[<span class="string">@&quot;author&quot;</span>] = <span class="string">@&quot;author1&quot;</span>;</span><br><span class="line">CPDistributedMessagingCenter *c = [CPDistributedMessagingCenter centerNamed:<span class="string">@&quot;MyCPCenter&quot;</span>];</span><br><span class="line">rocketbootstrap_distributedmessagingcenter_apply(c);</span><br><span class="line">[c sendMessageName:<span class="string">@&quot;MyCPCenterNoti&quot;</span> userInfo:userInfo];</span><br></pre></td></tr></table></figure>

<p>还要配置头文件路径。Build Setting - Header Search Paths 添加 /opt/theos/vendor/include</p>
<p>接着将 /opt/theos/vendor/lib/librocketbootstrap.tbd 动态库添加到项目</p>
<blockquote>
<p>#import &lt;AppSupport/CPDistributedMessagingCenter.h&gt; 找不到文件，只能把 AppSupport.framework 拖入项目，新建了两个项目一个注册监听，一个发送消息，测试结果两个app间没收到消息，有空再试</p>
</blockquote>
<h4 id="deb重打包"><a href="#deb重打包" class="headerlink" title="deb重打包"></a>deb重打包</h4><p>有时候需要对别人 deb 包进行修改破解限制，就需要 deb 重打包</p>
<p>新建必要目录，存放解包后的文件及打包后的文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir extract</span><br><span class="line">$ mkdir extract&#x2F;DEBIAN</span><br><span class="line">$ mkdir build</span><br></pre></td></tr></table></figure>

<h5 id="安装-dpkg"><a href="#安装-dpkg" class="headerlink" title="安装 dpkg"></a>安装 dpkg</h5><p>安装 <a target="_blank" rel="noopener" href="https://www.macports.org/install.php">MacPorts</a> 软件包管理软件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo port install dpkg</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ brew install dpkg</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ dpkg-deb -c deb文件 &#x2F;&#x2F;显示文件列表</span><br><span class="line">$ dpkg-deb -X deb文件 输出路径 &#x2F;&#x2F;解压获取到Library中文件，里面有dylib</span><br><span class="line">$ dpkg-deb -e deb文件 输出路径 &#x2F;&#x2F;解压获取到Control文件</span><br><span class="line">$ dpkg-deb -R deb文件 输出路径 &#x2F;&#x2F;获取到 dylib和control文件</span><br><span class="line">$ dpkg-deb -b 通过-解压出来的文件 xxx.deb &#x2F;&#x2F;打包生成deb</span><br></pre></td></tr></table></figure>

<h5 id="解包"><a href="#解包" class="headerlink" title="解包"></a>解包</h5><p>-X参数可以提取deb包中的所有文件到 extract，-e 参数可以提取deb包中的控制信息到extract/DEBIAN</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ dpkg -X .&#x2F;xxx.deb extract</span><br><span class="line">$ dpkg -e .&#x2F;xxx.deb extract&#x2F;DEBIAN</span><br></pre></td></tr></table></figure>

<ul>
<li>重新打包成deb</li>
</ul>
<p>检查目录是否存在 .DS_Store 文件删除，再设置用户组权限打包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo chown -R root:wheel .&#x2F;extract</span><br><span class="line">$ dpkg-deb -b extract&#x2F; build&#x2F; </span><br><span class="line">#如果安装报错将打包命令修改成如下 </span><br><span class="line">$ dpkg-deb -Z gzip -b extract&#x2F; build&#x2F;</span><br></pre></td></tr></table></figure>



<p>dpkg 可以在 iOS 设备上安装 deb 包，SSH 到设备</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dpkg -i &#x2F;var&#x2F;mobile&#x2F;Cydown&#x2F;test.deb</span><br></pre></td></tr></table></figure>





<h4 id="报错修改"><a href="#报错修改" class="headerlink" title="报错修改"></a>报错修改</h4><p>make package install</p>
<ol>
<li>提示 <code>obsolete compression type &#39;lzma&#39;; use xz instead</code></li>
</ol>
<p>解决：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">到theos目录 HTEOS&#x2F;makefiles&#x2F;package&#x2F;deb.mk</span><br><span class="line">第六行的THEOSPLATFORM_DPKG_DEB_COMPRESSION?&#x3D;lzma 把lzma改成xz就可以了</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>提示 <code>dpkg: error processing /tmp/_theos_install.deb (--install):</code></li>
</ol>
<p>解决：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">到目录 THEOS&#x2F;makefiles&#x2F;package&#x2F;deb.mk</span><br><span class="line">vim 进入 注释这一行</span><br><span class="line">#$(ECHO_NOTHING)COPYFILE_DISABLE&#x3D;1 $(FAKEROOT) -r $(_THEOS_PLATFORM_DPKG_DEB) -Z$(_THEOS_PLATFORM_DPKG_DEB_COMPRESSION) -b &quot;$(THEOS_STAGING_DIR)&quot; &quot;$(_THEOS_DEB_PACKAGE_FILENAME)&quot;$(ECHO_END)</span><br><span class="line">添加 </span><br><span class="line">$(ECHO_NOTHING)COPYFILE_DISABLE&#x3D;1 $(FAKEROOT) -r dpkg-deb -Zgzip -b &quot;$(THEOS_STAGING_DIR)&quot; &quot;$(_THEOS_DEB_PACKAGE_FILENAME)&quot; $(STDERR_NULL_REDIRECT)$(ECHO_END)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>Showing Recent Messages</p>
<p>An empty identity is not valid when signing a binary for the product type ‘Dynamic Library’.</p>
</li>
</ol>
<p>解决：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BuildSettings-User-Defined 添加 key CODE_SIGNING_ALLOWED NO</span><br></pre></td></tr></table></figure>










      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/20/%E9%80%86%E5%90%91-Frida%E8%AE%B0%E5%BD%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/20/%E9%80%86%E5%90%91-Frida%E8%AE%B0%E5%BD%95/" class="post-title-link" itemprop="url">逆向-Frida记录</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-06-20 10:57:17" itemprop="dateCreated datePublished" datetime="2022-06-20T10:57:17+08:00">2022-06-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-05-06 09:09:14" itemprop="dateModified" datetime="2023-05-06T09:09:14+08:00">2023-05-06</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          输入密码
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/06/20/%E9%80%86%E5%90%91-Frida%E8%AE%B0%E5%BD%95/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/18/%E9%80%86%E5%90%91-Frida%E7%BB%95%E8%BF%87iOS%E5%8F%8D%E8%B0%83%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/18/%E9%80%86%E5%90%91-Frida%E7%BB%95%E8%BF%87iOS%E5%8F%8D%E8%B0%83%E8%AF%95/" class="post-title-link" itemprop="url">逆向-Frida绕过iOS反调试</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-06-18 00:08:34 / 修改时间：15:43:34" itemprop="dateCreated datePublished" datetime="2022-06-18T00:08:34+08:00">2022-06-18</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>macOS</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ iproxy 2222 22 #端口转发</span><br><span class="line">$ ssh -p 2222 root@localhost</span><br></pre></td></tr></table></figure>

<p>iOS设备上，查找应用进程名称</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root# ps -e</span><br><span class="line">8082 ??   0:16.32 &#x2F;var&#x2F;containers&#x2F;Bundle&#x2F;Application&#x2F;XXXX&#x2F;XinHuaShe.app&#x2F;XinHuaShe</span><br></pre></td></tr></table></figure>

<p>启动 debugserver 附加到 XinHuaShe 进程，监听 1234 端口，等待电脑端 LLDB 接入</p>
<p>debugserver 主机IP地址:端口号 -a 应用进程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root# debugserver *:1234 -a XinHuaShe</span><br><span class="line">Attaching to process XinHuaShe...</span><br><span class="line">Segmentation fault: 11</span><br></pre></td></tr></table></figure>

<p>提示 <code>Segmentation fault: 11</code> 了 ，APP 做了反调试的防护</p>
<p>目前公开的反动态调试的防护就 ptrace</p>
<p>启动 APP</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root# debugserver -x posix *:1234 &#x2F;var&#x2F;containers&#x2F;Bundle&#x2F;Application&#x2F;CB03D455-A7BC-4762-84C6-3FAE31A3C67C&#x2F;XinHuaShe.app&#x2F;XinHuaShe</span><br></pre></td></tr></table></figure>

<p>电脑端</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ iproxy 1234 1234</span><br><span class="line">$ lldb</span><br><span class="line">(lldb) process connect connect:&#x2F;&#x2F;localhost:1234 &#x2F;&#x2F;手机IP地址</span><br><span class="line">error: failed to get reply to handshake packet  &#x2F;&#x2F;报错了</span><br></pre></td></tr></table></figure>

<p>修改启动debugserver</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root# debugserver -x posix localhost:1234 &#x2F;var&#x2F;containers&#x2F;Bundle&#x2F;Application&#x2F;CB03D455-A7BC-4762-84C6-3FAE31A3C67C&#x2F;XinHuaShe.app&#x2F;XinHuaShe</span><br></pre></td></tr></table></figure>

<p>继续</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">$ lldb</span><br><span class="line">(lldb) process connect connect:&#x2F;&#x2F;localhost:1234 &#x2F;&#x2F;手机IP地址</span><br><span class="line"></span><br><span class="line">Process 9824 stopped</span><br><span class="line">* thread #1, stop reason &#x3D; signal SIGSTOP</span><br><span class="line">    frame #0: 0x0000000108c91000 dyld&#96; _dyld_start</span><br><span class="line">dyld&#96;_dyld_start:</span><br><span class="line">-&gt;  0x108c91000 &lt;+0&gt;:  mov    x28, sp</span><br><span class="line">    0x108c91004 &lt;+4&gt;:  and    sp, x28, #0xfffffffffffffff0</span><br><span class="line">    0x108c91008 &lt;+8&gt;:  mov    x0, #0x0</span><br><span class="line">    0x108c9100c &lt;+12&gt;: mov    x1, #0x0</span><br><span class="line">    0x108c91010 &lt;+16&gt;: stp    x1, x0, [sp, #-0x10]!</span><br><span class="line">    0x108c91014 &lt;+20&gt;: mov    x29, sp</span><br><span class="line">    0x108c91018 &lt;+24&gt;: sub    sp, sp, #0x10             ; &#x3D;0x10</span><br><span class="line">    0x108c9101c &lt;+28&gt;: ldr    x0, [x28]</span><br><span class="line">Target 0: (XinHuaShe) stopped.</span><br><span class="line"></span><br><span class="line">(lldb) c</span><br><span class="line">Process 9824 resuming</span><br><span class="line">Process 9824 exited with status &#x3D; 45 (0x0000002d) &#x2F;&#x2F;直接退出了</span><br><span class="line"></span><br><span class="line">(lldb) b ptrace &#x2F;&#x2F;给ptrace下断点</span><br><span class="line">Breakpoint 1: no locations (pending).</span><br><span class="line">WARNING:  Unable to resolve breakpoint to any actual locations.</span><br><span class="line">(lldb) c</span><br><span class="line">Process 9841 resuming</span><br><span class="line">1 location added to breakpoint 1</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;打印调用栈</span><br><span class="line">(lldb) bt</span><br><span class="line">error: invalid thread</span><br><span class="line">external version is 20200929_18:15:57_6075104</span><br><span class="line">Object_Creator constructor</span><br><span class="line">Process 9841 stopped</span><br><span class="line">* thread #1, queue &#x3D; &#39;com.apple.main-thread&#39;, stop reason &#x3D; breakpoint 1.1</span><br><span class="line">    frame #0: 0x00000001b02a33b0 libsystem_kernel.dylib&#96; __ptrace</span><br><span class="line">libsystem_kernel.dylib&#96;__ptrace:</span><br><span class="line">-&gt;  0x1b02a33b0 &lt;+0&gt;:  adrp   x9, 213850</span><br><span class="line">    0x1b02a33b4 &lt;+4&gt;:  add    x9, x9, #0x110            ; &#x3D;0x110</span><br><span class="line">    0x1b02a33b8 &lt;+8&gt;:  str    wzr, [x9]</span><br><span class="line">    0x1b02a33bc &lt;+12&gt;: mov    x16, #0x1a</span><br><span class="line">    0x1b02a33c0 &lt;+16&gt;: svc    #0x80</span><br><span class="line">    0x1b02a33c4 &lt;+20&gt;: b.lo   0x1b02a33e4               ; &lt;+52&gt;</span><br><span class="line">    0x1b02a33c8 &lt;+24&gt;: pacibsp</span><br><span class="line">    0x1b02a33cc &lt;+28&gt;: stp    x29, x30, [sp, #-0x10]!</span><br><span class="line">Target 0: (XinHuaShe) stopped.</span><br></pre></td></tr></table></figure>

<p>x30 寄存器也叫 lr 寄存器，打印返回地址 p/x $lr</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p&#x2F;x $lr</span><br><span class="line">(unsigned long) $0 &#x3D; 0x00000001003139e0</span><br><span class="line">(lldb) image list -o -f</span><br><span class="line">[  0] 0x0000000000254000 &#x2F;private&#x2F;var&#x2F;containers&#x2F;Bundle&#x2F;Application&#x2F;CB03D455-A7BC-4762-84C6-3FAE31A3C67C&#x2F;XinHuaShe.app&#x2F;XinHuaShe(0x0000000100254000)</span><br></pre></td></tr></table></figure>

<p>地址转换下  0x00000001003139e0 - 0x0000000000254000 = 0x1000BF9E0</p>
<p>IDA 中查找 0x1000BF9E0 地址</p>
<img src="逆向-Frida绕过iOS反调试/图片 1.png" alt="图片 1" style="zoom:100%;" />

<p>这段代码的含义就明显了，动态调用 ptrace，达到反动态调试的目的</p>
<p>这段函数位于 sub_1000BF9A0 内部</p>
<p>定位到函数右键 Jump to xref</p>
<p>看到 sub_1000BF9A0 的显示调用这地址 start+20</p>
<p>![图片 2](逆向-Frida绕过iOS反调试/图片 2.png)</p>
<p>双击 start+20 查看实现，它是 start 函数，在 start 函数中动态调用 ptrace 函数来达到反动态调试的目的</p>
<ul>
<li>去掉 sub_1000BF9A0</li>
</ul>
<ol>
<li>可以用 tweak 的方式</li>
</ol>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;substrate.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;mach-o/dyld.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> (*old_sub_ACF0)(<span class="keyword">void</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> new_sub_ACF0(<span class="keyword">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// old_sub_ACF0();</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;iOSRE: anti-anti-debugging&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%ctor &#123;</span><br><span class="line">  <span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> _sub_ACF0 = (_dyld_get_image_vmaddr_slide(<span class="number">0</span>) + <span class="number">0xACF0</span>) | <span class="number">0x1</span>;</span><br><span class="line">    <span class="keyword">if</span> (_sub_ACF0) <span class="built_in">NSLog</span>(<span class="string">@&quot;iOSRE: Found sub_ACF0!&quot;</span>);</span><br><span class="line">    MSHookFunction((<span class="keyword">void</span> *)_sub_ACF0, (<span class="keyword">void</span> *)&amp;new_sub_ACF0, (<span class="keyword">void</span> **)&amp;old_sub_ACF0);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>使用 fishhook</li>
<li>Frida replace 掉 sub_1000BF9A0 函数</li>
</ol>
<p>hook.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取函数地址</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_rva</span>(<span class="params"><span class="built_in">module</span>, offset</span>) </span>&#123;</span><br><span class="line">	<span class="comment">//获取基地址</span></span><br><span class="line">	<span class="keyword">var</span> base_addr = Module.findBaseAddress(<span class="built_in">module</span>)</span><br><span class="line">	<span class="comment">//函数地址 = 基地址+偏移地址</span></span><br><span class="line">	<span class="keyword">var</span> target_addr = base_addr.add(offset) </span><br><span class="line">	<span class="keyword">if</span> (Process.arch == <span class="string">&#x27;arm&#x27;</span>) &#123; <span class="comment">//如果是32位地址+1</span></span><br><span class="line">		<span class="keyword">return</span> target_addr.add(<span class="number">1</span>)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> target_addr</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ObjC.available) &#123; <span class="comment">//OC类加载完成</span></span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;\n[*] Starting Hooking&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> target_addr = get_rva(<span class="string">&#x27;XinHuaShe&#x27;</span>, <span class="number">0xBF9A0</span>)</span><br><span class="line">	<span class="comment">//NativeCallback(func, returnType, argTypes[,abi])</span></span><br><span class="line">	<span class="comment">//或者不用参数</span></span><br><span class="line">	Interceptor.replace(ptr(target_addr), <span class="keyword">new</span> NativeCallback(<span class="function"><span class="keyword">function</span>(<span class="params">argc, argv</span>)</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;hook sub_ptrace bypass&#x27;</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">	&#125;, int, [int, int]))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>hook.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">bundle = <span class="string">&#x27;com.xinhuamm.d0001&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#sys.argv[1] 第一个参数 </span></span><br><span class="line"><span class="keyword">with</span> codecs.<span class="built_in">open</span>(sys.argv[<span class="number">1</span>], <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    source = f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment">#f = open(sys.argv[1], &#x27;r&#x27;) #打开frida脚本</span></span><br><span class="line"><span class="comment">#source = f.read() #读取frida脚本</span></span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device(<span class="number">1000</span>) <span class="comment">#连接usb设备 1000表示超时</span></span><br><span class="line">pid = device.spawn(bundle) <span class="comment">#启动指定bundleId的app</span></span><br><span class="line">session = device.attach(pid)  <span class="comment">#附加到app</span></span><br><span class="line">script = session.create_script(source) <span class="comment">#创建frida javaScript脚本</span></span><br><span class="line">script.load() <span class="comment">#load脚本到app进程中 这样即注入成功</span></span><br><span class="line">device.resume(pid) <span class="comment">#恢复app运行</span></span><br><span class="line">sys.stdin.read()<span class="comment">#读取打印日志</span></span><br></pre></td></tr></table></figure>

<p>执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3.8 hook.py hook.js</span><br></pre></td></tr></table></figure>

<p>报错 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Failed to spawn: the request to open &quot;com.xinhuamm.d0001&quot; failed.</span><br></pre></td></tr></table></figure>

















<p><a target="_blank" rel="noopener" href="https://la0s.github.io/2019/03/07/anti_ptrace/">Frida绕过iOS反调试</a></p>
<p><a target="_blank" rel="noopener" href="https://iosre.com/t/7-2-0-ios/770">干掉高德地图反动态调试</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/17/%E9%80%86%E5%90%91-Frida-RPC%E8%B0%83%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/17/%E9%80%86%E5%90%91-Frida-RPC%E8%B0%83%E7%94%A8/" class="post-title-link" itemprop="url">逆向-Frida RPC调用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-06-17 16:39:38" itemprop="dateCreated datePublished" datetime="2022-06-17T16:39:38+08:00">2022-06-17</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-05-04 14:59:27" itemprop="dateModified" datetime="2023-05-04T14:59:27+08:00">2023-05-04</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a>RPC</h4><p>Frida 提供了 RPC（远程过程调用）功能，开发人员可以将封装好的任意函数指定为 RPC函数，提供给Python使用。</p>
<p>比如应用中存在一个加密函数，开发者不想分析它的实现，只是想调用它来得到结果，则可以将此加密函数导出，利用Python来调用它</p>
<p>只需要知道加密函数的名称和地址，还有相应的参数，即可直接调用加密函数得到加密后的结果。</p>
<p>利用 rpc.exports={} 导出RPC函数，多个函数间用逗号分隔</p>
<h4 id="OC方法"><a href="#OC方法" class="headerlink" title="OC方法"></a>OC方法</h4><p>定义 CoreClass 类里面 4 个方法 </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSString</span> *)getDeviceId &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">@&quot;e10adc3949ba59abbe56e057f20f883e&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="built_in">NSString</span> *)httpPost:(<span class="built_in">NSURL</span> *)url &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;URL: %@&quot;</span>, url);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">@&quot;test&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span>*)encrypt:(<span class="built_in">NSData</span>*)data key:(<span class="built_in">NSString</span>*)key&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;data: %@&quot;</span>, data);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;key: %@&quot;</span>, key);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">@&quot;encrypt successed!&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSString</span>*)decrypt:(<span class="built_in">NSString</span>*)str key:(<span class="built_in">NSString</span>*)key&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;str: %@&quot;</span>, str);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;key: %@&quot;</span>, key);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">@&quot;decrypt successed!&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="JS中调用OC方法"><a href="#JS中调用OC方法" class="headerlink" title="JS中调用OC方法"></a>JS中调用OC方法</h4><p>现在要在 JS 里调用这 4 个方法</p>
<ul>
<li><p>实例方法需要初始化一个实例</p>
</li>
<li><p>类方法不需要初始化实例，在方法名称后面加上一个 _ 就可以调用了</p>
</li>
</ul>
<p>JS 脚本: rpc.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;\n[*] Starting Hooking&#x27;</span>)</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">var</span> coreClass = ObjC.classes.CoreClass.alloc()</span><br><span class="line">		<span class="comment">//JS调用OC实例方法</span></span><br><span class="line">		<span class="keyword">var</span> deviceId = coreClass[<span class="string">&#x27;- getDeviceId&#x27;</span>].call(coreClass)</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;deviceId: &#x27;</span>+deviceId)</span><br><span class="line">    </span><br><span class="line">		<span class="comment">//JS调用OC类方法</span></span><br><span class="line">		<span class="keyword">var</span> url = ObjC.classes.NSURL.URLWithString_(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line">		<span class="keyword">var</span> retString = ObjC.classes.CoreClass.httpPost_(url)</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;retString: &#x27;</span>+retString)</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">var</span> str = ObjC.classes.NSString.stringWithString_(<span class="string">&#x27;testStr&#x27;</span>)</span><br><span class="line">		<span class="comment">//NSData *data = [str dataUsingEncoding:NSUTF8StringEncoding]</span></span><br><span class="line">		<span class="keyword">var</span> data = str.dataUsingEncoding_(<span class="number">4</span>)</span><br><span class="line">		<span class="keyword">var</span> key = ObjC.classes.NSString.stringWithString_(<span class="string">&#x27;key&#x27;</span>)</span><br><span class="line">		</span><br><span class="line">    <span class="comment">//JS调用OC实例方法，带参数</span></span><br><span class="line">    <span class="comment">//方法也可以写成 &#x27;- encrypt::&#x27;</span></span><br><span class="line">		<span class="keyword">var</span> encryptString = coreClass[<span class="string">&#x27;- encrypt:key:&#x27;</span>].call(coreClass, data, key)</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;encryptString: &#x27;</span>+encryptString)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> decryptString = coreClass[<span class="string">&#x27;- decrypt::&#x27;</span>].call(coreClass, str, key)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;decryptString: &#x27;</span>+decryptString)</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">		<span class="built_in">console</span>.log(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行 rpc.js</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ python3.8 cmake.py rpc.js</span><br><span class="line"></span><br><span class="line">[*] Starting Hooking</span><br><span class="line">deviceId: e10adc3949ba59abbe56e057f20f883e</span><br><span class="line">retString: test</span><br><span class="line">encryptString: encrypt successed!</span><br><span class="line">decryptString: decrypt successed!</span><br></pre></td></tr></table></figure>

<h4 id="导出方法给python调用"><a href="#导出方法给python调用" class="headerlink" title="导出方法给python调用"></a>导出方法给python调用</h4><p>接下来将代码导出给 Python 使用，JS 代码里定义 4 个函数</p>
<p>getDeviceId、httpPost、encrypt、decrypt，4个函数分别代表了调用目标进程的4个OC方法，然后用 rpc.exports 将 4 个函数导出</p>
<p>rpc.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;\n[*] Starting Hooking&#x27;</span>)</span><br><span class="line">	</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getHomeDirectory</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> NSHomeDirectory = <span class="keyword">new</span> NativeFunction(ptr(Module.findExportByName(<span class="string">&quot;Foundation&quot;</span>, <span class="string">&quot;NSHomeDirectory&quot;</span>)), <span class="string">&#x27;pointer&#x27;</span>, [])</span><br><span class="line">    <span class="keyword">var</span> path = <span class="keyword">new</span> ObjC.Object(NSHomeDirectory());</span><br><span class="line">    <span class="keyword">return</span> path.toString()</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">getDeviceId</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="keyword">var</span> coreClass = ObjC.classes.CoreClass.alloc()</span><br><span class="line">		<span class="keyword">var</span> deviceId = coreClass[<span class="string">&#x27;- getDeviceId&#x27;</span>].call(coreClass)</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;deviceId: &#x27;</span>+deviceId)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">httpPost</span>(<span class="params">inputurl</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">var</span> url = ObjC.classes.NSURL.URLWithString_(inputurl)</span><br><span class="line">		<span class="keyword">var</span> retString = ObjC.classes.CoreClass.httpPost_(url)</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;retString: &#x27;</span>+retString)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">encrypt</span>(<span class="params">inputstr, inputkey</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">var</span> coreClass = ObjC.classes.CoreClass.alloc()</span><br><span class="line">		<span class="keyword">var</span> str = ObjC.classes.NSString.stringWithString_(inputstr)</span><br><span class="line">		<span class="comment">//NSData *data = [str dataUsingEncoding:NSUTF8StringEncoding]</span></span><br><span class="line">		<span class="keyword">var</span> data = str.dataUsingEncoding_(<span class="number">4</span>)</span><br><span class="line">		<span class="keyword">var</span> key = ObjC.classes.NSString.stringWithString_(inputkey)</span><br><span class="line">		<span class="keyword">var</span> encryptString = coreClass[<span class="string">&#x27;- encrypt:key:&#x27;</span>].call(coreClass, data, key)</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;encryptString: &#x27;</span>+encryptString)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">decrypt</span>(<span class="params">inputstr, inputkey</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">var</span> coreClass = ObjC.classes.CoreClass.alloc()</span><br><span class="line">		<span class="keyword">var</span> decryptStr = ObjC.classes.NSString.stringWithString_(inputstr)</span><br><span class="line">		<span class="keyword">var</span> key2 = ObjC.classes.NSString.stringWithString_(inputkey)</span><br><span class="line">		<span class="keyword">var</span> decryptString = coreClass[<span class="string">&#x27;- decrypt:key:&#x27;</span>].call(coreClass, decryptStr, key2)</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">&#x27;decryptString: &#x27;</span>+decryptString)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	rpc.exports = &#123;</span><br><span class="line">    gethomedirectory: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="comment">// homedirectory 必须小写</span></span><br><span class="line">      <span class="keyword">return</span> getHomeDirectory()</span><br><span class="line">    &#125;,</span><br><span class="line">		deviceid: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			getDeviceId()</span><br><span class="line">		&#125;,</span><br><span class="line">		httppost: <span class="function"><span class="keyword">function</span>(<span class="params">inputurl</span>)</span>&#123;</span><br><span class="line">			httpPost(inputurl)</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="function"><span class="title">encrypt</span>(<span class="params">inputstr, inputkey</span>)</span>&#123;</span><br><span class="line">			encrypt(inputstr, inputkey)</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="function"><span class="title">decrypt</span>(<span class="params">inputstr, inputkey</span>)</span>&#123;</span><br><span class="line">			decrypt(inputstr, inputkey)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Python调用"><a href="#Python调用" class="headerlink" title="Python调用"></a>Python调用</h4><p>Python调用 cmake.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">bundle = <span class="string">&#x27;com.CMake&#x27;</span></span><br><span class="line"></span><br><span class="line">print(sys.argv[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> codecs.<span class="built_in">open</span>(sys.argv[<span class="number">1</span>], <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    source = f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment">#f = open(s, &#x27;r&#x27;) #打开frida脚本</span></span><br><span class="line"><span class="comment">#source = f.read() #读取frida脚本</span></span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device(<span class="number">1000</span>) <span class="comment">#连接usb设备 1000表示超时</span></span><br><span class="line">pid = device.spawn(bundle) <span class="comment">#启动指定bundleId的app</span></span><br><span class="line">session = device.attach(pid)  <span class="comment">#附加到app</span></span><br><span class="line">script = session.create_script(source) <span class="comment">#创建frida javaScript脚本</span></span><br><span class="line">script.load() <span class="comment">#load脚本到app进程中 这样即注入成功</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#rpc调用</span></span><br><span class="line">rpc = script.exports</span><br><span class="line">rpc.deviceid()</span><br><span class="line">rpc.httppost(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line">rpc.encrypt(<span class="string">&#x27;str1&#x27;</span>, <span class="string">&#x27;key1&#x27;</span>)</span><br><span class="line">rpc.decrypt(<span class="string">&#x27;str2&#x27;</span>, <span class="string">&#x27;key2&#x27;</span>)</span><br><span class="line"></span><br><span class="line">print(rpc.homeDirectory())</span><br><span class="line"></span><br><span class="line">device.resume(pid) <span class="comment">#恢复app运行</span></span><br><span class="line">sys.stdin.read()<span class="comment">#读取打印日志</span></span><br></pre></td></tr></table></figure>

<h4 id="导出C函数"><a href="#导出C函数" class="headerlink" title="导出C函数"></a>导出C函数</h4><p>rpc.js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//打开URL</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">openURL</span>(<span class="params">url</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> UIApplication = ObjC.classes.UIApplication.sharedApplication();</span><br><span class="line">  <span class="keyword">var</span> toOpen = ObjC.classes.NSURL.URLWithString_(url);</span><br><span class="line">  <span class="keyword">return</span> UIApplication.openURL_(toOpen);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//C函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getHomeDir</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> NSHomeDirectory = <span class="keyword">new</span> NativeFunction(ptr(Module.findExportByName(<span class="string">&quot;Foundation&quot;</span>,<span class="string">&quot;NSHomeDirectory&quot;</span>)),<span class="string">&#x27;pointer&#x27;</span>,[]);</span><br><span class="line">  <span class="keyword">var</span> path = <span class="keyword">new</span> Objc.Object(NSHomeDirectory())</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;homeDir:&#x27;</span>+path)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//播放系统声音</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">playSystemSound</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">new</span> NativeFunction(Module.ExportByName(<span class="string">&#x27;AudioToolbox&#x27;</span>,<span class="string">&#x27;AudioServicesPlaySystemSound&#x27;</span>),<span class="string">&#x27;void&#x27;</span>,[<span class="string">&#x27;int&#x27;</span>])(<span class="number">1111</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//导出RPC函数</span></span><br><span class="line">rpc.exports = &#123;</span><br><span class="line">  homeDir: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    getHomeDir();</span><br><span class="line">  &#125;</span><br><span class="line">  openUrl: <span class="function"><span class="keyword">function</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">    openURL(url);</span><br><span class="line">  &#125;,</span><br><span class="line">  sound: <span class="function"><span class="title">fucntion</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  	playSystemSound();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>rpc.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  <span class="comment">#附加到目标进程</span></span><br><span class="line">  session = frida.get_usb_device().attach(<span class="string">u&#x27;App Store&#x27;</span>)</span><br><span class="line">  <span class="comment">#读取JS脚本</span></span><br><span class="line">  <span class="keyword">with</span> codecs.<span class="built_in">open</span>(<span class="string">&#x27;./rpc.js&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    souce = f.read()</span><br><span class="line">    </span><br><span class="line">  script = session.create_script(source)</span><br><span class="line">  script.load()</span><br><span class="line">  rpc = script.exports</span><br><span class="line">  rpc.openurl(<span class="string">&quot;https://www.chinapyg.com&quot;</span>);</span><br><span class="line">  rpc.sound()</span><br><span class="line">  session.detach()</span><br></pre></td></tr></table></figure>

<p>本例的JS脚本导出了两个RPC函数，程序启动后执行rpc.py脚本将rpc.js文件注入</p>
<h4 id="JS-中调用OC"><a href="#JS-中调用OC" class="headerlink" title="JS 中调用OC"></a>JS 中调用OC</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="built_in">UIAlertView</span> = ObjC.classes.UIAlertView; <span class="comment">/* iOS 7 */</span></span><br><span class="line"><span class="keyword">const</span> view = <span class="built_in">UIAlertView</span>.alloc().initWithTitle_message_delegate_cancelButtonTitle_otherButtonTitles_(</span><br><span class="line">    <span class="string">&#x27;Frida&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Hello from Frida&#x27;</span>,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="string">&#x27;OK&#x27;</span>,</span><br><span class="line">    <span class="literal">NULL</span>);</span><br><span class="line">view.show();</span><br><span class="line">view.release();</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Defining a Block that will be passed as handler parameter to +[UIAlertAction actionWithTitle:style:handler:]</span></span><br><span class="line"><span class="keyword">const</span> handler = new ObjC.Block(&#123;</span><br><span class="line">  retType: <span class="string">&#x27;void&#x27;</span>,</span><br><span class="line">  argTypes: [<span class="string">&#x27;object&#x27;</span>],</span><br><span class="line">  implementation() &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Import ObjC classes</span></span><br><span class="line"><span class="keyword">const</span> <span class="built_in">UIAlertController</span> = ObjC.classes.UIAlertController;</span><br><span class="line"><span class="keyword">const</span> <span class="built_in">UIAlertAction</span> = ObjC.classes.UIAlertAction;</span><br><span class="line"><span class="keyword">const</span> <span class="built_in">UIApplication</span> = ObjC.classes.UIApplication;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Using Grand Central Dispatch to pass messages (invoke methods) in application&#x27;s main thread</span></span><br><span class="line">ObjC.schedule(ObjC.mainQueue, () =&gt; &#123;</span><br><span class="line">  <span class="comment">// Using integer numerals for preferredStyle which is of type enum UIAlertControllerStyle</span></span><br><span class="line">  <span class="keyword">const</span> alert = <span class="built_in">UIAlertController</span>.alertControllerWithTitle_message_preferredStyle_(<span class="string">&#x27;Frida&#x27;</span>, <span class="string">&#x27;Hello from Frida&#x27;</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="comment">// Again using integer numeral for style parameter that is enum</span></span><br><span class="line">  <span class="keyword">const</span> defaultAction = <span class="built_in">UIAlertAction</span>.actionWithTitle_style_handler_(<span class="string">&#x27;OK&#x27;</span>, <span class="number">0</span>, handler);</span><br><span class="line">  alert.addAction_(defaultAction);</span><br><span class="line">  <span class="comment">// Instead of using `ObjC.choose()` and looking for UIViewController instances</span></span><br><span class="line">  <span class="comment">// on the heap, we have direct access through UIApplication:</span></span><br><span class="line">  <span class="built_in">UIApplication</span>.sharedApplication().keyWindow().rootViewController().presentViewController_animated_completion_(alert, <span class="literal">true</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Get a reference to the openURL selector</span></span><br><span class="line"><span class="keyword">const</span> openURL = ObjC.classes.UIApplication[<span class="string">&#x27;- openURL:&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Intercept the method</span></span><br><span class="line">Interceptor.attach(openURL.implementation, &#123;</span><br><span class="line">  onEnter(args) &#123;</span><br><span class="line">    <span class="comment">// As this is an Objective-C method, the arguments are as follows:</span></span><br><span class="line">    <span class="comment">// 0. &#x27;self&#x27;</span></span><br><span class="line">    <span class="comment">// 1. The selector (openURL:)</span></span><br><span class="line">    <span class="comment">// 2. The first argument to the openURL method</span></span><br><span class="line">    <span class="keyword">const</span> myNSURL = new ObjC.Object(args[<span class="number">2</span>]);</span><br><span class="line">    <span class="comment">// Convert it to a JS string</span></span><br><span class="line">    <span class="keyword">const</span> myJSURL = myNSURL.absoluteString().toString();</span><br><span class="line">    <span class="comment">// Log it</span></span><br><span class="line">    console.log(<span class="string">&#x27;Launching URL: &#x27;</span> + myJSURL);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>












      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/17/%E9%80%86%E5%90%91-Frida%E6%8B%A6%E6%88%AAsub-xxx%E5%87%BD%E6%95%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/17/%E9%80%86%E5%90%91-Frida%E6%8B%A6%E6%88%AAsub-xxx%E5%87%BD%E6%95%B0/" class="post-title-link" itemprop="url">逆向-Frida拦截sub_xxx函数</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-06-17 14:50:27" itemprop="dateCreated datePublished" datetime="2022-06-17T14:50:27+08:00">2022-06-17</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-05-04 14:50:10" itemprop="dateModified" datetime="2023-05-04T14:50:10+08:00">2023-05-04</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>IDA 里看到的 <code>sub_1000061B4</code>  这种类型的函数是没有符号的，所以 IDA 解析时就显示 <code>sub_1000061B4</code></p>
<p>1000061B4 是 IDA 读取到的函数地址</p>
<p>定义一个函数</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> add(<span class="keyword">int</span> num1, <span class="keyword">int</span> num2) &#123;</span><br><span class="line">    <span class="keyword">int</span> sum = num1 + num2;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    <span class="keyword">int</span> sum = add(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;1+1=%d&quot;</span>, sum);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译后将可执行文件拖入 IDA，显示定义的函数是这种 </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall add(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2) &#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(a1 + a2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先使用命令去掉符号 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ strip -x &#x2F;Users&#x2F;xxx&#x2F;Desktop&#x2F;CMake&#x2F;CMake.app&#x2F;CMake</span><br></pre></td></tr></table></figure>

<p>再使用 IDA 查看可执行文件，就只会显示 sub_xxx 这类名称，而没有函数的真实名称</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall sub_1000061B4(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2) &#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(a1 + a2);</span><br><span class="line">&#125;</span><br><span class="line">sub_1000061B4(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="built_in">CFSTR</span>(<span class="string">&quot;1+1=%d&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>编写 Frida 脚本</p>
<p>sub_1000061B4 函数地址 1000061B4，64位基址 0x100000000, 0x1000061B4-0x100000000 就是0x61B4</p>
<p>或者也可以在 IDA 中先将基址设置为 0，这样定位到目标函数的地址就是函数地址。</p>
<p>IDA 上 C 函数偏移地址 0x61B4 </p>
<h4 id="cmake-js"><a href="#cmake-js" class="headerlink" title="cmake.js"></a>cmake.js</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">获取函数的内存地址</span></span><br><span class="line"><span class="comment">module: 模块名称</span></span><br><span class="line"><span class="comment">offset: IDA中的函数地址</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_rva</span>(<span class="params"><span class="built_in">module</span>, offset</span>) </span>&#123;</span><br><span class="line">	<span class="comment">//获取基地址</span></span><br><span class="line">	<span class="keyword">var</span> base_addr = Module.findBaseAddress(<span class="built_in">module</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">console</span>.log(hexdump(ptr(base_addr), &#123;</span><br><span class="line">    length:<span class="number">16</span>,</span><br><span class="line">    header: <span class="literal">true</span>,</span><br><span class="line">    ansi: <span class="literal">true</span></span><br><span class="line">  &#125;))</span><br><span class="line">  </span><br><span class="line">	<span class="comment">//函数地址 = 基地址+偏移地址</span></span><br><span class="line">	<span class="keyword">var</span> target_addr = base_addr.add(offset) </span><br><span class="line">	<span class="keyword">if</span> (Process.arch == <span class="string">&#x27;arm&#x27;</span>) &#123; </span><br><span class="line">		<span class="keyword">return</span> target_addr.add(<span class="number">1</span>) <span class="comment">//如果是32位地址+1</span></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> target_addr</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ObjC.available) &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">&#x27;\n[*] Starting Hooking&#x27;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">var</span> target_addr = get_rva(<span class="string">&#x27;CMake&#x27;</span>, <span class="number">0x61B4</span>)</span><br><span class="line">	</span><br><span class="line">	Interceptor.attach(ptr(target_addr), &#123;</span><br><span class="line">		onEnter: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;onEnter&#x27;</span>);</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;num1: &#x27;</span>+ args[<span class="number">0</span>])</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;num2: &#x27;</span>+ args[<span class="number">1</span>])</span><br><span class="line">		&#125;, </span><br><span class="line">		onLeave: <span class="function"><span class="keyword">function</span>(<span class="params">retval</span>) </span>&#123;</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;onLeave&#x27;</span>)</span><br><span class="line">			<span class="built_in">console</span>.log(<span class="string">&#x27;Return value: &#x27;</span>+ retval)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ python3.8 cmake.py cmake.js</span><br><span class="line"></span><br><span class="line">[*] Starting Hooking</span><br><span class="line">onEnter</span><br><span class="line">num1: 0x1</span><br><span class="line">num2: 0x2</span><br><span class="line">onLeave</span><br><span class="line">Return value: 0x3</span><br></pre></td></tr></table></figure>

<p>可以看到输入 1 + 2 结果 3</p>
<h4 id="cmake-py"><a href="#cmake-py" class="headerlink" title="cmake.py"></a>cmake.py</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">bundle = <span class="string">&#x27;com.CMake&#x27;</span></span><br><span class="line"></span><br><span class="line">print(sys.argv[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> codecs.<span class="built_in">open</span>(sys.argv[<span class="number">1</span>], <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    source = f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment">#f = open(s, &#x27;r&#x27;) #打开frida脚本</span></span><br><span class="line"><span class="comment">#source = f.read() #读取frida脚本</span></span><br><span class="line"></span><br><span class="line">device = frida.get_usb_device(<span class="number">1000</span>) <span class="comment">#连接usb设备 1000表示超时</span></span><br><span class="line">pid = device.spawn(bundle) <span class="comment">#启动指定bundleId的app</span></span><br><span class="line">session = device.attach(pid)  <span class="comment">#附加到app</span></span><br><span class="line">script = session.create_script(source) <span class="comment">#创建frida javaScript脚本</span></span><br><span class="line">script.load() <span class="comment">#load脚本到app进程中 这样即注入成功</span></span><br><span class="line">device.resume(pid) <span class="comment">#恢复app运行</span></span><br><span class="line">sys.stdin.read()<span class="comment">#读取打印日志</span></span><br></pre></td></tr></table></figure>

























<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42400619/article/details/113385014?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165544788016782184643503%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&request_id=165544788016782184643503&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-6-113385014-null-null.nonecase&utm_term=frida+%E5%AE%9E%E6%88%98&spm=1018.2226.3001.4450">Frida如何拦截sub_xxx函数</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/13/%E9%80%86%E5%90%91-%E7%A0%B8%E5%A3%B3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/13/%E9%80%86%E5%90%91-%E7%A0%B8%E5%A3%B3/" class="post-title-link" itemprop="url">逆向-砸壳</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-06-13 15:12:38" itemprop="dateCreated datePublished" datetime="2022-06-13T15:12:38+08:00">2022-06-13</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-10-22 11:26:00" itemprop="dateModified" datetime="2022-10-22T11:26:00+08:00">2022-10-22</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%80%86%E5%90%91/" itemprop="url" rel="index"><span itemprop="name">逆向</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id=""><a href="#" class="headerlink" title=""></a></h4><p>脱壳原理</p>
<p>dyld加载MachO文件，将MachO文件导出</p>
<h4 id="检测是否加壳"><a href="#检测是否加壳" class="headerlink" title="检测是否加壳"></a>检测是否加壳</h4><ul>
<li>使用 otool</li>
</ul>
<p>otool 可以看到二进制文件的信息有个 crypt，cryptid = 1 已加壳，crypt = 0，未加壳</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">otool -l WeChat | grep crypt</span><br></pre></td></tr></table></figure>

<ul>
<li>使用 MachOView 查看</li>
</ul>
<p>可执行文件拖入 MachOView 展开 Load Commands 节点 LC_ENCRYPTION_INFO_64</p>
<p>可以看到 Crypt ID</p>
<img src="逆向-砸壳/WeChatc7de80a199f342265e06ba9817134a60.png" alt="WeChatc7de80a199f342265e06ba9817134a60" style="zoom:80%;" />

<h4 id="脱壳"><a href="#脱壳" class="headerlink" title="脱壳"></a>脱壳</h4><h5 id="Clutch"><a href="#Clutch" class="headerlink" title="Clutch"></a>Clutch</h5><blockquote>
<p>使用问题比较多，好多砸壳失败的</p>
</blockquote>
<p>全自动脱壳工具，原理是应用运行时的内存数据按照一定格式导出，并重新打包为 ipa 文件</p>
<ul>
<li>安装</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/KJCracks/Clutch/releases">https://github.com/KJCracks/Clutch/releases</a> 下载最新版 Clutch 2.0.4</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ iproxy 2222 22 #端口转发</span><br><span class="line">#macOS执行</span><br><span class="line">$ scp -p 2222 -r .&#x2F;Clutch root@localhost:&#x2F;usr&#x2F;bin&#x2F;</span><br><span class="line">#iOS设备执行</span><br><span class="line">$ chmod +x &#x2F;usr&#x2F;bin&#x2F;Clutch</span><br></pre></td></tr></table></figure>

<p>输入 Clutch，输出了帮助信息则安装配置成功</p>
<ul>
<li>Clutch</li>
</ul>
<p>Clutch -i 参数打印所有应用列表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root# Clutch -i</span><br><span class="line">Installed apps:</span><br><span class="line">1:  今日头条 &lt;com.ss.iphone.article.News&gt;</span><br></pre></td></tr></table></figure>

<p>脱壳</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root# Clutch -d com.ss.iphone.article.News</span><br></pre></td></tr></table></figure>

<p>脱壳完成后的 ipa 包在 <code>/private/var/mobile/Documents/Dumped</code> 路径</p>
<p>再拷贝到电脑</p>
<h5 id="dumpedcrypted"><a href="#dumpedcrypted" class="headerlink" title="dumpedcrypted"></a>dumpedcrypted</h5><p>脱壳原理：程序运行过程中将代码段里的数据 dump 下来</p>
<ul>
<li>编译  dumpdecrypted</li>
</ul>
<p>下载 <a target="_blank" rel="noopener" href="https://github.com/stefanesser/dumpdecrypted">https://github.com/stefanesser/dumpdecrypted</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cd dumpdecrypted-master</span><br><span class="line">$ make</span><br></pre></td></tr></table></figure>

<p>生成 dumpdecrypted.dylib</p>
<ul>
<li>给 dumpdecrypted.dylib 重签名 </li>
</ul>
<p>可以使用 ldid 签名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldid -S dumpdecrypted.dylib</span><br></pre></td></tr></table></figure>

<p>或者使用 codesign 签名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codesign -f -s - .&#x2F;dumpdecrypted.dylib</span><br></pre></td></tr></table></figure>

<ul>
<li>拷贝 dumpdecrypted.dylib 到设备</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ scp -P2222 .&#x2F;dumpdecrypted.dylib root@localhost:&#x2F;usr&#x2F;bin&#x2F;</span><br></pre></td></tr></table></figure>

<ul>
<li>dumpdecrypted 脱壳</li>
</ul>
<p>查找路径和进程ID</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cd &#x2F;temp</span><br><span class="line">$ ps -e | grep WhatsApp</span><br><span class="line">#或者</span><br><span class="line">$ ps -ax | grep WhatsApp</span><br><span class="line">$ ps -aux | grep WhatsApp</span><br></pre></td></tr></table></figure>

<p>使用 DYLD_INSERT_LIBRARIES 环境变量将 dumpdecrypted.dylib 注入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DYLD_INSERT_LIBRARIES&#x3D;&#x2F;usr&#x2F;lib&#x2F;dumpdecrypted.dylib &#x2F;var&#x2F;mobile&#x2F;Containers&#x2F;Bundle&#x2F;Application&#x2F;1C8620F5-AFB5-46F8-9283-5FF70F4ADB5D&#x2F;WhatsApp.app&#x2F;WhatsApp</span><br></pre></td></tr></table></figure>

<p>生成 WhatsApp.decrypted 为脱壳后的文件，将文件拷贝到电脑</p>
<p>有些包是多架构的需要抽取指定架构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lipo AppStore.decrypted -thin arm64 -output AppStore.arm64</span><br></pre></td></tr></table></figure>

<h5 id="frida-ios-dump"><a href="#frida-ios-dump" class="headerlink" title="frida-ios-dump"></a>frida-ios-dump</h5><p>通过注入 JS 实现内存 dump，然后利用 Python 自动复制到 macOS生成ipa文件</p>
<p>原理和 dumpdecrypted 一样，都是通过把内存中已解密的数据 dump 再修复 Mach-O</p>
<ul>
<li>安装 frida</li>
</ul>
<p>iOS 设备 添加 Cydia 源：<a target="_blank" rel="noopener" href="https://build.frida.re/">https://build.frida.re</a>  安装 Frida for A12+ devices</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#macOS安装frida</span><br><span class="line">$ sudo pip install frida</span><br><span class="line">#如果报错</span><br><span class="line">$ sudo pip install frida -upgrade -ignore-installed six</span><br></pre></td></tr></table></figure>

<ul>
<li>配置 frida-ios-dump 环境</li>
</ul>
<p>下载 <a target="_blank" rel="noopener" href="https://github.com/AloneMonkey/frida-ios-dump">https://github.com/AloneMonkey/frida-ios-dump</a> 放到 /opt/dump 目录</p>
<p>安装依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo pip install -r requirements.txt --upgrade</span><br></pre></td></tr></table></figure>

<p>可以添加别名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ vim ~&#x2F;.bash_profile</span><br><span class="line">$ alias dump.py&#x3D;“&#x2F;opt&#x2F;dump&#x2F;frida-ios-dump-3.x&#x2F;dump.py”</span><br><span class="line">$ source ~&#x2F;.bash_profile</span><br></pre></td></tr></table></figure>

<ul>
<li>砸壳</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#端口转发</span><br><span class="line">$ iproxy 2222 22</span><br><span class="line">#列出所有应用</span><br><span class="line">$ python3.8 dump.py -l</span><br><span class="line">#砸壳</span><br><span class="line">$ python3.8 dump.py com.moutai.mall</span><br></pre></td></tr></table></figure>

<h5 id="DumpDecrypter（推荐）"><a href="#DumpDecrypter（推荐）" class="headerlink" title="DumpDecrypter（推荐）"></a>DumpDecrypter（推荐）</h5><p>Cydia - Cydiakk中文源，搜索 DumpDecrypter 可以一键砸壳</p>
<h5 id="修复闪退"><a href="#修复闪退" class="headerlink" title="修复闪退"></a>修复闪退</h5><p>脱壳后的 ipa 包安装后闪退</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#解压ipa包</span><br><span class="line">$ unzip decrypted-app.ipa</span><br><span class="line">#导出ent.xml</span><br><span class="line">$ codesign -d --entitlements - .&#x2F;Payload&#x2F;WhatsApp.app &gt; emt.xml</span><br><span class="line">#codesign重签名</span><br><span class="line">$ codesign -s - --entitlements ent.xml -f .&#x2F;Payload&#x2F;WhatsApp.app&#x2F;WhatsApp</span><br><span class="line">#压缩成新ipa包</span><br><span class="line">$ zip -r WhatsApp_ok.ipa Payload</span><br></pre></td></tr></table></figure>

<h5 id="LLDB-手动砸壳"><a href="#LLDB-手动砸壳" class="headerlink" title="LLDB 手动砸壳"></a>LLDB 手动砸壳</h5><p>LLDB手动脱壳实现原理是从内存中 dump 出解密后的数据，并修复 Mach-O 头部。</p>
<p>点击 APP 启动，内核开始读取 MachO，查看 MachO 是否被加密</p>
<p>如果没有加密，直接交给 dyld 加载并运行</p>
<p>如果加密，则需要内核解密，得到解密后的 MachO 文件，再交给 dyld 加载运行</p>
<ul>
<li>SSH 连接设备</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ iproxy 2222 22</span><br><span class="line">$ ssh -p 2222 root@localhost</span><br></pre></td></tr></table></figure>

<p>ps 命令找到目标路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ps -e | grep SogouInput</span><br><span class="line">4096 ??  0:04.69 &#x2F;var&#x2F;containers&#x2F;Bundle&#x2F;Application&#x2F;3546467A-CBFD-45D6-B27C-04682210031E&#x2F;SogouInput.app&#x2F;SogouInput</span><br></pre></td></tr></table></figure>

<ul>
<li>拷贝到桌面</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ scp -r -P 2222 root@localhost:&#x2F;var&#x2F;containers&#x2F;Bundle&#x2F;Application&#x2F;3546467A-CBFD-45D6-B27C-04682210031E&#x2F;SogouInput.app ~&#x2F;Desktop</span><br></pre></td></tr></table></figure>

<ul>
<li>查看是否加密</li>
</ul>
<p>要在内存中解密二进制文件，就需要知道加密数据的偏移量及大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">otool -l SogouInput | grep crypt</span><br><span class="line"> cryptoff 6299648  &#x2F;&#x2F;文件偏移</span><br><span class="line">cryptsize 4096		 &#x2F;&#x2F;加密文件大小</span><br><span class="line">  cryptid 1			   &#x2F;&#x2F;是否加密</span><br></pre></td></tr></table></figure>

<p>MachO 从位置 6299648（十进制） 开始后的 4096（十进制） 字节都被加密了</p>
<ul>
<li>开始脱壳</li>
</ul>
<p>LLDB 附加进程，然后获取 APP 的内存加载地址</p>
<ul>
<li>LLDB 连接</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iproxy 1234 1234</span><br></pre></td></tr></table></figure>

<p>设备上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debugserver *:1234 -a SogouInput</span><br></pre></td></tr></table></figure>

<p>Mac</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lldb</span><br><span class="line">(lldb) process connect connect:&#x2F;&#x2F;localhost:1234</span><br><span class="line">(lldb) image list -o -f  </span><br><span class="line">[  0] 0x0000000004e0c000 &#x2F;private&#x2F;var&#x2F;containers&#x2F;Bundle&#x2F;Application&#x2F;3546467A-CBFD-45D6-B27C-04682210031E&#x2F;SogouInput.app&#x2F;SogouInput(0x0000000104e0c000)</span><br></pre></td></tr></table></figure>

<p>image list 查看 APP 在内存中的偏移 ASLR 为 0x0000000104e0c000</p>
<p>如果这边遇到报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">error: rejecting incoming connection from ::ffff:127.0.0.1 (expecting ::1)</span><br></pre></td></tr></table></figure>

<p>debugserver 连接改成 <code>debugserver 127.0.0.1:1234 -a SogouInput</code></p>
<ul>
<li>Dump出解密部分二进制文件</li>
</ul>
<p>利用 memory 命令从内存中dump出解密后的二进制数据，保存到文件</p>
<p>读取内存中的数据拷贝出来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;memory read --force --outfile 输出文件目录名称 --binary --count 加密文件的大小 ASLR+文件偏移 </span><br><span class="line">(--force 按字节读取意思)</span><br><span class="line">memory read --force --outfile .&#x2F;decrypted.bin --binary --count 4096 0x0000000104e0c000+6299648</span><br></pre></td></tr></table></figure>

<p>此时发现多了一个 decrypted.bin 文件</p>
<ul>
<li>修复文件</li>
</ul>
<p>dump 出来的数据没有 Mach-O 头部的信息，需要修复才能使用。将 dump 出来的数据重新写回脱壳前的文件，以替换加密的数据</p>
<ul>
<li>dd 指令将Dump出的二进制文件写入MachO文件</li>
</ul>
<p>指定大小文件写入另外一个文件里面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;dd seek&#x3D;文件偏移 bs&#x3D;单位为1字节 conv&#x3D;转换方式（保留未被截取部分的内容）if&#x3D;输入文件地址 of&#x3D;输出文件地址</span><br><span class="line">&#x2F;&#x2F;~&#x2F;Desktop目录</span><br><span class="line">dd seek&#x3D;6299648 bs&#x3D;1 conv&#x3D;notrunc if&#x3D;.&#x2F;decrypted.bin of&#x3D;.&#x2F;SogouInput.app&#x2F;SogouInput</span><br></pre></td></tr></table></figure>

<ul>
<li>更改 cycript 为 0，最后一步修改加密标记</li>
</ul>
<p>MachOView 打开 SogouInput</p>
<p>在 Load Command - LC_ENCRYPTION_INFO_64 可以看到 Crypt ID 值为 1</p>
<p>修改 Crypt ID 的 Data 0000001 改为 0000000，保存再次查看是否加密</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">otool -l SogouInput.app&#x2F;SogouInput | grep crypt</span><br><span class="line">     cryptoff 6299648</span><br><span class="line">    cryptsize 4096</span><br><span class="line">      cryptid 0</span><br></pre></td></tr></table></figure>

<p>利用 class-dump 导出头文件测试下能不能导出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class-dump -H &#x2F;Users&#x2F;midland_whk&#x2F;Desktop&#x2F;SogouInput.app&#x2F;SogouInput -o &#x2F;Users&#x2F;midland_whk&#x2F;Desktop&#x2F;header&#x2F;</span><br></pre></td></tr></table></figure>






































      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/13/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/13/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/" class="post-title-link" itemprop="url">逆向-汇编</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-06-13 11:44:38" itemprop="dateCreated datePublished" datetime="2022-06-13T11:44:38+08:00">2022-06-13</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-03-30 20:07:32" itemprop="dateModified" datetime="2023-03-30T20:07:32+08:00">2023-03-30</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="通用寄存器"><a href="#通用寄存器" class="headerlink" title="通用寄存器"></a>通用寄存器</h4><p>ARM64 有 31 个通用寄存器，每个寄存器可以存储一个 64 位的数据</p>
<p>使用 X0 ~ X30 时，它就是一个 64 位的数据</p>
<p>使用 W0 ~ W30 时，实际访问的是这些寄存器的低 32 位，写入时会将高 32 位清 0 </p>
<p>32 位寄存器并不是独立存在的，比如 W0 是 X0 的低 32 位</p>
<img src="逆向-汇编/通用寄存器.png" alt="通用寄存器" style="zoom:60%;" />



<p>Xcode 重新命名了 X29 X30 叫 fp  lr，除了 X0~X30寄存器外，还有一个 SP 寄存器。</p>
<h5 id="X0-X7"><a href="#X0-X7" class="headerlink" title="X0 ~ X7"></a>X0 ~ X7</h5><p>用来传递函数的参数，如果有更多的参数则使用栈来传递；X0 也用来存放函数的返回值</p>
<h5 id="SP寄存器"><a href="#SP寄存器" class="headerlink" title="SP寄存器"></a>SP寄存器</h5><p>Stack Pointer，栈指针寄存器，指向栈的顶部</p>
<h5 id="FP寄存器"><a href="#FP寄存器" class="headerlink" title="FP寄存器"></a>FP寄存器</h5><p>Frame Pointer，即 X29，帧指针寄存器，指向栈的底部</p>
<h5 id="LR寄存器"><a href="#LR寄存器" class="headerlink" title="LR寄存器"></a>LR寄存器</h5><p>Link Register，即 X30，链接寄存器，存储着函数调用完成时的返回地址，用来做函数调用栈跟踪</p>
<h5 id="PC寄存器"><a href="#PC寄存器" class="headerlink" title="PC寄存器"></a>PC寄存器</h5><p>指令指针寄存器，保存的是将要执行的下一条指令的内存地址</p>
<p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/PC%E5%AF%84%E5%AD%98%E5%99%A8.png" alt="PC寄存器"></p>
<h4 id="寄存器操作"><a href="#寄存器操作" class="headerlink" title="寄存器操作"></a>寄存器操作</h4><ul>
<li>读取寄存器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ register read				#读取整个寄存器</span><br><span class="line">x0 &#x3D; 0x....</span><br><span class="line">x1 &#x3D; 0x....</span><br><span class="line">$ register read $x0		#读取 x0 寄存器</span><br></pre></td></tr></table></figure>

<ul>
<li>修改寄存器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ register write $x1 1</span><br><span class="line">$ register read $x1</span><br></pre></td></tr></table></figure>

<ul>
<li>打印操作</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ po $x1			#打印 OC 对象</span><br><span class="line">$ x&#x2F;s $x1	    #将 X1 寄存器的C字符串打印出来 打印出调用方法名字</span><br><span class="line"></span><br><span class="line">$ p&#x2F;x $x7		  #p命令输出原生类型</span><br><span class="line">$ p&#x2F;d $x7</span><br></pre></td></tr></table></figure>

<ul>
<li>内存读写</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># -c 参数指定要读取的字节</span><br><span class="line">$ memory read $x0  #读取内存  如果读取数据超过1024字节会报错 加 --force 参数</span><br><span class="line">$ memory read 0x0000.. 0x0000.. #按区间读取</span><br><span class="line"></span><br><span class="line">#--outfile 读取的内存数据保存到文件</span><br><span class="line">$ memory read 0x000... -c 1025 --force -outfile &#x2F;tmp&#x2F;1.txt</span><br><span class="line"></span><br><span class="line">$ memory write 0x00.. 0x24 #修改成 0x24</span><br></pre></td></tr></table></figure>

<ul>
<li>反汇编</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ dis -a 0x00.. #反汇编指定地址</span><br></pre></td></tr></table></figure>

<ul>
<li>调用栈</li>
</ul>
<p>这里看到 frame， ru #1 0x000..f04</p>
<p>用这个地址减去 ASLR 的偏移量即可得到文件的偏移地址 </p>
<p>在 IDA 中取搜索这个文件偏移地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ bt</span><br><span class="line">$ bt 2  #指定打印 2 层</span><br></pre></td></tr></table></figure>

<ul>
<li>单步命令</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ni  #单步执行 遇到子函数不进入，会执行到下一行</span><br><span class="line">$ si  #单步执行 遇到子函数进入</span><br><span class="line">$ finish 完成功能并退出子函数，如在 objc_msgSend 函数内任何地址输入finish，会完成objc_msgSend的原始调用</span><br><span class="line">$ return 和finish不同会直接退出子函数，原始代码流程不会调用，该命令通常在反-反调试时用于跳过检测函数</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x104f227bB &lt;+8&gt;: mov W8, #-0x1</span><br></pre></td></tr></table></figure>

<p>加了#号表示常数，将 -1 赋值给 w8</p>
<p>orr 按位或</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/<span class="regexp">/读取 x9 寄存器值</span></span><br><span class="line"><span class="regexp">(lldb)register read $x9</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 修改 pc 寄存器的指向位置</span></span><br><span class="line"><span class="regexp">(lldb)register write $pc 0x182a367b8</span></span><br><span class="line"><span class="regexp">(lldb)register read $pc</span></span><br></pre></td></tr></table></figure>

<p>我们可以通过改变 pc寄存器 的内容来控制 CPU 执行目标指令</p>
<ul>
<li>mov 指令，可以用来修改大部分寄存器的值（不能用于设置pc的值）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov x0, #10</span><br><span class="line">mov x1, #20</span><br></pre></td></tr></table></figure>

<ul>
<li>bl 指令</li>
</ul>
<p>转移（跳转指令）</p>
<ul>
<li>ret 指令</li>
</ul>
<p>默认使用 lr（X30）寄存器的值</p>
<ul>
<li>Xcode 新建汇编代码</li>
</ul>
<p>Xcode 新建选择 Assembly File，命名为 asm.s </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;标号 告诉编译器生成的二进制机器码会保存到代码段</span><br><span class="line">.text</span><br><span class="line">&#x2F;&#x2F;告诉编译器 全局标号暴露给外面 _A _B</span><br><span class="line">.global _A,_B</span><br><span class="line"></span><br><span class="line">_A:</span><br><span class="line">    &#x2F;&#x2F;将a0存入到x0寄存器</span><br><span class="line">    mov x0,#0xa0</span><br><span class="line">    mov x1,#0x00</span><br><span class="line">    &#x2F;&#x2F;x0和#0x14加法运算 结果放到x1</span><br><span class="line">    add x1, x0, #0x14</span><br><span class="line">    &#x2F;&#x2F;跳转到B</span><br><span class="line">    bl _B</span><br><span class="line">    mov x0,#0x0</span><br><span class="line">    ret</span><br><span class="line">_B:</span><br><span class="line">    add x0, x0, #0x10</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>

<p>调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">int A(); &#x2F;&#x2F;声明</span><br><span class="line">int main(int argc,char *argv[])&#123;</span><br><span class="line">  A(); &#x2F;&#x2F;调用</span><br><span class="line">  @autoreleasepool&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以在调用处 A(); 打断点调试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-&gt; 0x10031a7f0 &lt;+24&gt;: bl 0x10031ab44</span><br></pre></td></tr></table></figure>

<p>s 指令进入，就到了上面的汇编指令了，ni 按汇编指令一步步往下走</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(lldb)s</span><br><span class="line">(lldb)ni</span><br></pre></td></tr></table></figure>

<ul>
<li>LR 寄存器</li>
</ul>
<p>也称为 X30 寄存器，指向返回地址，存储函数调用完成时的返回地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-&gt; 0x10439ab38 &lt;+4&gt;: bl   0x10439ab44</span><br><span class="line">	 0x10439ab3c &lt;+8&gt;: mov  x0, #0xaaaa</span><br></pre></td></tr></table></figure>

<p>lr 值就是 0x10439ab3c</p>
<h4 id="状态寄存器-CPSR"><a href="#状态寄存器-CPSR" class="headerlink" title="状态寄存器 CPSR"></a>状态寄存器 CPSR</h4><p>状态寄存器用来保存指令运行结果的一些信息，比如相加结果是否溢出、是否为0及是否为负数，和其它寄存器不一样，其它寄存器是用来存放数据的，都是整个寄存器具有一个含义</p>
<p>而 CPSR 寄存器是按位起作用，每一位都有专门含义 </p>
<p>CPSR 寄存器是 32 位的</p>
<ul>
<li>低 8 位（包括 I、F、T 和 M[0-4]）称为控制位，程序无法修改，除非 CPU 运行与特权模式下，程序才能修改</li>
<li>N、Z、C、V 均为条件码标志位，内容可被算术或逻辑运算的结果所改变，并且可以决定某条指令是否被执行</li>
</ul>
<img src="逆向-汇编/图片.png" alt="15201620642085" style="zoom:70%;" />

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">funcC</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> b = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (a == b) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;a == b&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;a != b&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>if(a == b)</code>   处打断点调试，查看汇编代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b.ne 0x102fc68f8  &#x2F;&#x2F;带条件的跳转</span><br></pre></td></tr></table></figure>

<p>断点到 b.ne 后，查看 CPSR 寄存器</p>
<p>控制台 选择All Variable 可以看到寄存器的参数<br>查看 cpsr 寄存器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cpsr &#x3D; (unsigned int) 0x80000000</span><br></pre></td></tr></table></figure>

<p>第一个16进制位是 8，代表 N、Z、C、V  这 4 个二进制位</p>
<p> 16 进制 0x8，转换成二进制就是 1000 （可以用计算器计算）</p>
<p>正常流程结果是打印 <code>a != b</code></p>
<p>现在将修改 cpsr 寄存器的值为 0100 就是 0x4</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(lldb) register write cpsr <span class="number">0x40000000</span></span><br><span class="line">(lldb) register read cpsr</span><br><span class="line">cpsr = <span class="number">0x40000000</span></span><br><span class="line">(lldb) c</span><br><span class="line">a == b</span><br></pre></td></tr></table></figure>

<h5 id="N"><a href="#N" class="headerlink" title="N"></a>N</h5><p>符号标志位，两个有符号整数进行运算时，N=1 表示结果为负数；N=0 表示运行结果为正数或0</p>
<h5 id="Z"><a href="#Z" class="headerlink" title="Z"></a>Z</h5><p>0 标志位，Z=1 表示运算结果为零；Z=0 表示运算结果为非领</p>
<h5 id="C"><a href="#C" class="headerlink" title="C"></a>C</h5><p>进位标志位</p>
<p>加法运算：运算结果产生了进位 C=1 ，否则 C=0</p>
<p>减法运算：运算时产生了借位 C=0，否则 C=1</p>
<h5 id="V"><a href="#V" class="headerlink" title="V"></a>V</h5><p>溢出标志位，V=1 表示符号位溢出</p>
<p>正数+正数为负数 溢出</p>
<p>负数+负数为正数 溢出</p>
<p>正数+负数 不可能溢出</p>
<h4 id="常见ARM64指令集"><a href="#常见ARM64指令集" class="headerlink" title="常见ARM64指令集"></a>常见ARM64指令集</h4><h5 id="算术指令"><a href="#算术指令" class="headerlink" title="算术指令"></a>算术指令</h5><p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E5%B8%B8%E7%94%A8%E7%AE%97%E6%9C%AF%E6%8C%87%E4%BB%A4.png" alt="常用算术指令"></p>
<h5 id="跳转指令"><a href="#跳转指令" class="headerlink" title="跳转指令"></a>跳转指令</h5><p>条件跳转<img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E5%B8%B8%E7%94%A8%E8%B7%B3%E8%BD%AC%E6%8C%87%E4%BB%A4.png" alt="常用跳转指令"></p>
<p>无条件跳转</p>
<p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E6%97%A0%E6%9D%A1%E4%BB%B6%E8%B7%B3%E8%BD%AC.png" alt="无条件跳转"></p>
<h5 id="逻辑指令"><a href="#逻辑指令" class="headerlink" title="逻辑指令"></a>逻辑指令</h5><p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E5%B8%B8%E7%94%A8%E9%80%BB%E8%BE%91%E6%8C%87%E4%BB%A4.png" alt="常用逻辑指令"></p>
<h5 id="数据传输指令"><a href="#数据传输指令" class="headerlink" title="数据传输指令"></a>数据传输指令</h5><p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E6%8C%87%E4%BB%A4.png" alt="常用数据传输指令"></p>
<h5 id="地址偏移指令"><a href="#地址偏移指令" class="headerlink" title="地址偏移指令"></a>地址偏移指令</h5><p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E5%B8%B8%E7%94%A8%E5%9C%B0%E5%9D%80%E5%81%8F%E7%A7%BB%E6%8C%87%E4%BB%A4.png" alt="常用地址偏移指令"></p>
<h5 id="移位运算指令"><a href="#移位运算指令" class="headerlink" title="移位运算指令"></a>移位运算指令</h5><p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E5%B8%B8%E7%94%A8%E7%A7%BB%E4%BD%8D%E8%BF%90%E7%AE%97%E6%8C%87%E4%BB%A4.png" alt="常用移位运算指令"></p>
<h5 id="加载-存储指令"><a href="#加载-存储指令" class="headerlink" title="加载/存储指令"></a>加载/存储指令</h5><p>加载/存储指令都是成对出现的</p>
<p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E5%B8%B8%E7%94%A8%E5%8A%A0%E8%BD%BD:%E5%AD%98%E5%82%A8%E6%8C%87%E4%BB%A41.png" alt="常用加载:存储指令1"></p>
<p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E5%B8%B8%E7%94%A8%E5%8A%A0%E8%BD%BD:%E5%AD%98%E5%82%A8%E6%8C%87%E4%BB%A42.png" alt="常用加载:存储指令2"></p>
<p>ARM 指令的一个重要特点是可以条件执行，每条 ARM 指令的条件码域包含 4 位条件码，共16种</p>
<p>几乎所有指令均根据 CPSR 中条件码的状态和指令条件码域的设置有条件地执行，当指令执行条件满足时，指令被执行，否则被忽略</p>
<p><img src="/%E9%80%86%E5%90%91-%E6%B1%87%E7%BC%96/%E6%8C%87%E4%BB%A4%E6%9D%A1%E4%BB%B6%E7%A0%81.png" alt="指令条件码"></p>
<h4 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h4><p>栈的增长方向是从高地址到低地址的。栈低是高地址，栈顶是低地址</p>
<p>后进先出，高地址向低地址扩展数据结构</p>
<img src="逆向-汇编/栈.png" alt="栈" style="zoom:50%;" />



<ul>
<li>str（store register）指令</li>
</ul>
<p>将数据从寄存器中读出来，存到内存</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">str w0,[x8]  w0取出放到x8所指向的地方</span><br></pre></td></tr></table></figure>

<ul>
<li>ldr（load register） 指令</li>
</ul>
<p>将数据从内存中读出来，存到寄存器中</p>
<p>str 和 ldr 的变种 ldp 和 stp 还可以操作 2 个寄存器</p>
<p><u>函数的调用会开辟栈帧，在AArch64 中，函数的参数是通过 X0~X7 传递的</u></p>
<p>函数的返回值使用 X0 寄存器保存</p>
<p>X1 是方法名，X2是第一个参数</p>
<p>编译器生成汇编时，首先会计算所需要的栈空间大小。</p>
<p>方法的头部通过 <u>向下</u> 移动SP指针在栈上分配空间，把当前FP和LR保存起来</p>
<p>方法的尾部恢复栈上的FP和LR到寄存器，然后向上移动栈指针SP，来释放栈上的内存。这两部分其实也是为了保持栈平衡，前面开辟了多少空间，调用结束后就需要归还多少，从而恢复成函数调用前的样子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sub sp, sp, #0x20 ;拉伸栈空间</span><br><span class="line">stp x29, x30, [sp, #0x20] ;保存x29(FP)和x30(LR)寄存器</span><br><span class="line">add x29, sp, #0x20 	; 抬高栈底</span><br><span class="line">...</span><br><span class="line">ldp x29,x30,[sp, #0x20] ;还原x29和x30</span><br><span class="line">add sp, sp, #0x30 ;释放栈空间</span><br></pre></td></tr></table></figure>









<ul>
<li>函数嵌套调用：会将 X29、X30寄存器入栈保护</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">int g &#x3D; 12;</span><br><span class="line"></span><br><span class="line">int func(int a, int b)&#123;</span><br><span class="line">    printf(&quot;haha&quot;);</span><br><span class="line">    int c &#x3D; a + g;</span><br><span class="line">    return c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc, char * argv[]) &#123;</span><br><span class="line">    func(10, 20);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>printf(&quot;haha&quot;)</code> 处打断点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">	  0x102732730 &lt;+20&gt;: adrp   x0, 1</span><br><span class="line">    0x102732734 &lt;+24&gt;: add    x0, x0, #0xf2b      ; &#x3D;0xf2b </span><br><span class="line">-&gt;  0x102732738 &lt;+28&gt;: bl     0x102732a7c         ; symbol stub for: printf</span><br></pre></td></tr></table></figure>

<p>X0 存储的是第一个参数，动态调试可以直接打印 X0 的值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(lldb) register read $x0</span><br><span class="line">      x0 &#x3D; 0x0000000102733f2b  &quot;haha&quot;</span><br></pre></td></tr></table></figure>

<p>分析</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">0x102732730 &lt;+20&gt;: adrp   x0, 1</span><br><span class="line">adrp 就是 address page, 每一页就是 4k，4k就是 12 位</span><br><span class="line">意思是</span><br><span class="line">将 1 左移 12 位，(1后面补上12个0) -&gt; 0x1000 (用计算器)</span><br><span class="line">将当前 pc 寄存器值 0x102732730，低 12 位清 0 -&gt; 0x102732000</span><br><span class="line">相加赋值给 X0 0x102732000+0x1000 &#x3D; 0x102733000</span><br><span class="line"></span><br><span class="line">0x102732734 &lt;+24&gt;: add    x0, x0, #0xf2b      ; &#x3D;0xf2b</span><br><span class="line">X0 加上 0xf2b </span><br><span class="line">(lldb) p&#x2F;x 0x102733000+0xf2b</span><br><span class="line">(long) $0 &#x3D; 0x0000000102733f2b</span><br><span class="line">常量地址就找到了 -&gt; p (char*)0x0000000102733f2b</span><br><span class="line">(char *) $3 &#x3D; 0x0000000102733f2b &quot;haha&quot;</span><br></pre></td></tr></table></figure>



<h4 id="循环选择判断"><a href="#循环选择判断" class="headerlink" title="循环选择判断"></a>循环选择判断</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmp w0, w1</span><br></pre></td></tr></table></figure>

<p>cmp 比较指令</p>
<p>BL标号：跳转到标号处执行<br>B.GT 比较结果是大于，执行标号，否则不跳转<br>B.GE 比较结果是大于等于，执行标号，否则不跳转<br>B.GQ 比较结果是等于，执行标号，否则不跳转<br>B.HI 比较结果是无符号大于，执行标号，否则不跳转</p>
<p>b.le 小于等于<br>b.lt 小于</p>
<p>dowhile循环：判断条件在后面，满足条件往前跳<br>while循环：判断条件在里面，不满足就往外跳</p>
<h4 id="Objc汇编机制"><a href="#Objc汇编机制" class="headerlink" title="Objc汇编机制"></a>Objc汇编机制</h4><p>OC 中 X0 寄存器保存了对象本身</p>
<p>X1 寄存器保存了方法名</p>
<p>X2 ~ X7 开始是参数，其它参数通过栈传递，由于是 64 位的程序，所以每 8 个字节一组</p>
<h4 id="ARM64"><a href="#ARM64" class="headerlink" title="ARM64"></a>ARM64</h4><p>汇编代码里以点 . 开头的关键字不是指令而是助记符，也叫作伪指令，它不会被编译成机器码，作用是告诉编译器做一些特殊的操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.extern 声明外部函数</span><br><span class="line">.align  字节对齐的方式，如4字节对齐 .align 4</span><br><span class="line">.data   数据段，用于存储需要用到的数据</span><br><span class="line">.text   代码段，告诉编译器代码生成的二进制机器码会保存在代码段</span><br><span class="line">.global 表示一个全局符号</span><br></pre></td></tr></table></figure>





<h4 id="内联汇编"><a href="#内联汇编" class="headerlink" title="内联汇编"></a>内联汇编</h4><p>高级语言中嵌入汇编代码，这种方式称为内联汇编</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">asm &#123;volatile&#125;(&quot;汇编语句模板&quot;</span><br><span class="line">	:输出(可选)</span><br><span class="line">	:输入(可选)</span><br><span class="line">	:会被破坏的寄存器(可选)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>包含 4 个部分，各部分用 ：分隔。汇编语句模板必不可少，其它三部分可选，如果使用了后面部分，而前面部分为空，也需要用 ：分隔，相应部分内容为空</p>
<p>参数 volatile 可选，如果用了它，则告诉编译器不允许对该内联汇编进行优化，否则启动优化选项(-O)进行编译时，汇编代码会被编译器优化的面目全非</p>
<p>Xcode 写个加法函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">int arm_sum(int a, int b) &#123;</span><br><span class="line">    int sum &#x3D; 0;</span><br><span class="line">    asm volatile(</span><br><span class="line">                &quot;add %w0, %w1, %w2&quot; </span><br><span class="line">                 : &quot;&#x3D;r&quot; (sum)</span><br><span class="line">                 : &quot;r&quot; (a), &quot;r&quot; (b)</span><br><span class="line">                 :);</span><br><span class="line">    return sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一行：汇编语句模板 %w0, %w1, %w2 代表指令的操作数，称为占位符。内联汇编根据它们将C语言表达式与指令操作数对应起来</p>
<p>模板后面的小括号内是C语言表达式</p>
<p>上面表达式有3个 sum、a、b，按照出现顺序分别与指令操作数%0、%1、%2 对应，操作数最多只能有10个。百分号 % 后面的字母表示这个变量的位宽，w 表示 32 位，x 表示 64 位。</p>
<p>第二行：输出参数，= 号表示，sum是输出操作符，r 表示需要将 sum 与某个通用寄存器相关联</p>
<p>第三行：输入参数，r 表示该表达式需要先放入某个寄存器，然后在指令中使用该寄存器参与运算</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#汇编指令，如果多句用\t\n来分割</span><br><span class="line">asm(</span><br><span class="line">&quot;mov x0,1\t\n&quot;</span><br><span class="line">&quot;mov x1,2\t\n&quot;</span><br><span class="line">...</span><br><span class="line">)</span><br></pre></td></tr></table></figure>







<h4 id="IDA"><a href="#IDA" class="headerlink" title="IDA"></a>IDA</h4><p>在反汇编代码窗口输入分号，就能够添加注释</p>
<h4 id="Hopper"><a href="#Hopper" class="headerlink" title="Hopper"></a>Hopper</h4><p>在反汇编窗口输入分号能够对代码添加注释，使用 shift+; 组合键可以在代码所在的行后面添加注释</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/09/%E9%80%86%E5%90%91%E5%B7%A5%E5%85%B7-Dobby/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/09/%E9%80%86%E5%90%91%E5%B7%A5%E5%85%B7-Dobby/" class="post-title-link" itemprop="url">逆向工具-Dobby</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-06-09 10:52:34" itemprop="dateCreated datePublished" datetime="2022-06-09T10:52:34+08:00">2022-06-09</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-04-30 17:19:52" itemprop="dateModified" datetime="2023-04-30T17:19:52+08:00">2023-04-30</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%80%86%E5%90%91%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">逆向工具</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="Inline-Hook"><a href="#Inline-Hook" class="headerlink" title="Inline Hook"></a>Inline Hook</h4><p>修改函数的前 N 字节内存，使其跳转到自己编写的函数，这样原函数的逻辑就被新函数接管了，同时还应该保存原函数的前 N 个字节，以便在需要时能正确恢复原来的汇编代码从而执行原始逻辑</p>
<h4 id="Dobby"><a href="#Dobby" class="headerlink" title="Dobby"></a>Dobby</h4><p>Dobby（原名 HookZz）<a target="_blank" rel="noopener" href="https://github.com/jmpews/Dobby">https://github.com/jmpews/Dobby</a></p>
<h5 id="编译-Xcode-工程"><a href="#编译-Xcode-工程" class="headerlink" title="编译 Xcode 工程"></a>编译 Xcode 工程</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;jmpews&#x2F;Dobby.git --depth&#x3D;1</span><br></pre></td></tr></table></figure>

<p>直接执行脚本编译 （编译出的framework没有头文件使用报错了）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 scripts&#x2F;platform_builder.py --platform&#x3D;iphoneos --arch&#x3D;all</span><br></pre></td></tr></table></figure>

<p>或者</p>
<p>这是个跨平台的，需要 cmake 将工程编译成为 Xcode 工程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cd Dobby &amp;&amp; mkdir build_for_ios_arm64 &amp;&amp; cd build_for_ios_arm64 </span><br><span class="line"></span><br><span class="line">cmake .. -G Xcode \</span><br><span class="line">-DCMAKE_TOOLCHAIN_FILE&#x3D;cmake&#x2F;ios.toolchain.cmake \</span><br><span class="line">-DPLATFORM&#x3D;OS64 -DARCHS&#x3D;&quot;arm64&quot; -DCMAKE_SYSTEM_PROCESSOR&#x3D;arm64 \</span><br><span class="line">-DENABLE_BITCODE&#x3D;0 -DENABLE_ARC&#x3D;0 -DENABLE_VISIBILITY&#x3D;1 -DDEPLOYMENT_TARGET&#x3D;9.3 \</span><br><span class="line">-DDynamicBinaryInstrument&#x3D;ON -DNearBranch&#x3D;ON -DPlugin.SymbolResolver&#x3D;ON -DPlugin.Darwin.HideLibrary&#x3D;ON -DPlugin.Darwin.ObjectiveC&#x3D;ON</span><br><span class="line"></span><br><span class="line">#github 上是下面的(使用这个)</span><br><span class="line">cd Dobby &amp;&amp; mkdir build_for_ios &amp;&amp; cd build_for_ios</span><br><span class="line">cmake .. -G Xcode -DCMAKE_SYSTEM_NAME&#x3D;iOS -DCMAKE_OSX_ARCHITECTURES&#x3D;arm64 -DCMAKE_SYSTEM_PROCESSOR&#x3D;arm64 -DCMAKE_OSX_DEPLOYMENT_TARGET&#x3D;9.3</span><br></pre></td></tr></table></figure>

<ul>
<li>报错 Could not find toolchain file: cmake/ios.toolchain.cmake 问题 </li>
</ul>
<p>cmake 下载安装 <a target="_blank" rel="noopener" href="https://cmake.org/download/">https://cmake.org/download/</a></p>
<p>下载 <a target="_blank" rel="noopener" href="https://github.com/leetal/ios-cmake">https://github.com/leetal/ios-cmake</a> 放到 cmake 目录</p>
<p>cmake 编译后生成一个 Xcode 工程</p>
<img src="逆向工具-Dobby/WeChat646a5d4c48c7a119b2d324b20ff968a3.png" alt="WeChat646a5d4c48c7a119b2d324b20ff968a3" style="zoom:80%;" />

<ul>
<li>编译 DobbyX 报错 <code>__DOBBY_BUILD_VERSION__</code> 没定义</li>
</ul>
<p>直接添加一个宏定义 <code>#define __DOBBY_BUILD_VERSION__ &quot;0.0.1&quot;</code></p>
<p>编译 DobbyX.framework</p>
<p><img src="/%E9%80%86%E5%90%91%E5%B7%A5%E5%85%B7-Dobby/WeChatc1fcfbfb83d8dd9daed4ac78a60cadbd.png" alt="WeChatc1fcfbfb83d8dd9daed4ac78a60cadbd"></p>
<h4 id="Dobby-使用"><a href="#Dobby-使用" class="headerlink" title="Dobby 使用"></a>Dobby 使用</h4><h5 id="导入-Framework"><a href="#导入-Framework" class="headerlink" title="导入 Framework"></a>导入 Framework</h5><p>创建测试工程 testDobby，将 DobbyX.framework 拖入工程</p>
<p>运行后报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dyld: Library not loaded: @rpath&#x2F;DobbyX.framework&#x2F;DobbyX</span><br><span class="line">  Referenced from: &#x2F;private&#x2F;var&#x2F;containers&#x2F;Bundle&#x2F;Application&#x2F;B6A97E11-656E-461B-93B0-A1D72E9313AB&#x2F;testDobby.app&#x2F;testDobby</span><br><span class="line">  Reason: image not found</span><br><span class="line">dyld: launch, loading dependent libraries</span><br><span class="line">DYLD_LIBRARY_PATH&#x3D;&#x2F;usr&#x2F;lib&#x2F;system&#x2F;introspection</span><br><span class="line">DYLD_INSERT_LIBRARIES&#x3D;&#x2F;Developer&#x2F;usr&#x2F;lib&#x2F;libBacktraceRecording.dylib:&#x2F;Developer&#x2F;usr&#x2F;lib&#x2F;libMainThreadChecker.dylib:&#x2F;Developer&#x2F;Library&#x2F;PrivateFrameworks&#x2F;DTDDISupport.framework&#x2F;libViewDebuggerSupport.dylib</span><br></pre></td></tr></table></figure>

<p>Link Binary With Libraries 需要添加 DobbyX.framework</p>
<p>将 Framework 首次拖入工程，Xcode 不会自动帮你拷贝，运行时会发现 Framework 没有打包进入 APP 包，造成 DYLD 加载时找不到库报错 </p>
<p>TARGETS testDobby - Build Phases，点击 + 选择 New Copy Files Phase</p>
<p>Copy Files 中，Destination 选择 Frameworks</p>
<img src="逆向工具-Dobby/WeChat511e8790f7c557a95e07f4c3227c5f93.png" alt="WeChat511e8790f7c557a95e07f4c3227c5f93" style="zoom:80%;" />

<p>运行后提示 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[*] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[*] Dobby</span><br><span class="line">[*] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[*] dobby in debug log mode, disable with cmake flag &quot;-DDOBBY_DEBUG&#x3D;OFF&quot;</span><br></pre></td></tr></table></figure>



<h5 id="Dobby-核心函数"><a href="#Dobby-核心函数" class="headerlink" title="Dobby 核心函数"></a>Dobby 核心函数</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">DobbyHook</span><span class="params">(<span class="keyword">void</span> *address, <span class="keyword">void</span> *replace_call, <span class="keyword">void</span> **origin_call)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#address：需要 Hook 的函数地址</span></span><br><span class="line">#replace_all：新函数地址</span><br><span class="line">#origin_call：保留原始函数的指针的地址</span><br></pre></td></tr></table></figure>

<h4 id=""><a href="#" class="headerlink" title=""></a></h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;DobbyX/dobby.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//2.定义函数指针，用于保存被替换函数的地址</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> (*sum_p)(<span class="keyword">int</span> a, <span class="keyword">int</span> b);</span><br><span class="line"></span><br><span class="line"><span class="comment">//1.定义将要被 HOOK 的函数</span></span><br><span class="line"><span class="keyword">int</span> sum(<span class="keyword">int</span> a, <span class="keyword">int</span> b) &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//3.定义新函数，用此函数替换将要HOOK的函数</span></span><br><span class="line"><span class="keyword">int</span> mySum(<span class="keyword">int</span> a, <span class="keyword">int</span> b) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;Sum: %d, 🍺🍺&quot;</span>, sum_p(a, b)); <span class="comment">//调用原函数</span></span><br><span class="line">    <span class="keyword">return</span> a - b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">  	<span class="comment">//4.调用DobbyHook进行函数的HOOK</span></span><br><span class="line">    DobbyHook(sum, mySum, (<span class="keyword">void</span> *)&amp;sum_p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;Sum: %d&quot;</span>, sum(<span class="number">10</span>, <span class="number">20</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#sum函数HOOK成功，先输出原始函数的执行结果，再输出替换函数的执行结果</span><br><span class="line">Sum: 30, 🍺🍺</span><br><span class="line">Sum: -10</span><br></pre></td></tr></table></figure>

<h4 id="MonkeyDev导入Dobby"><a href="#MonkeyDev导入Dobby" class="headerlink" title="MonkeyDev导入Dobby"></a>MonkeyDev导入Dobby</h4><p>写个 demo，去掉符号，target-Development-Development postProcessing 设置为NO</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> sum(<span class="keyword">int</span> a, <span class="keyword">int</span> b) &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;Sum: %d&quot;</span>, sum(<span class="number">10</span>, <span class="number">20</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行后将生成的可执行文件拖入 IDA 中找到 sum 函数地址 0x100005D6C </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__text:<span class="number">0000000100005</span>D6C                 EXPORT _sum</span><br><span class="line">__text:<span class="number">0000000100005</span>D6C _sum    ; CODE XREF: -[ViewController touchesBegan:withEvent:]+<span class="number">54</span>↓p</span><br><span class="line">__text:<span class="number">0000000100005</span>D6C</span><br><span class="line">__text:<span class="number">0000000100005</span>D6C var_8           = <span class="number">-8</span></span><br><span class="line">__text:<span class="number">0000000100005</span>D6C var_4           = <span class="number">-4</span></span><br><span class="line">__text:<span class="number">0000000100005</span>D6C</span><br><span class="line">__text:<span class="number">0000000100005</span>D6C                 SUB             SP, SP, #<span class="number">0x10</span></span><br></pre></td></tr></table></figure>

<h5 id="导入-Dobby"><a href="#导入-Dobby" class="headerlink" title="导入 Dobby"></a>导入 Dobby</h5><p>MonkeyDev 创建项目，将生成的 ipa 拖入 MonkeyDev，pod init 添加 Podfile</p>
<p>项目目录创建文件夹 DXDobby，里面有 DobbyX.framework 和 DXDobby.podspec</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">DXDobby</span><br><span class="line">	-- DobbyX.framework</span><br><span class="line">	-- DXDobby.podspec</span><br><span class="line">	</span><br><span class="line">Pod::Spec.new <span class="keyword">do</span> |s|</span><br><span class="line">  s.name             = <span class="string">&#x27;DXDobby&#x27;</span></span><br><span class="line">  s.version          = <span class="string">&#x27;0.0.1&#x27;</span></span><br><span class="line">  s.summary          = <span class="string">&#x27;A short description of DXSetting.&#x27;</span></span><br><span class="line">    s.description      = &lt;&lt;-DESC</span><br><span class="line">TODO: Add <span class="keyword">long</span> description of the pod here.</span><br><span class="line">                       DESC</span><br><span class="line">  s.homepage         = <span class="string">&#x27;https://github.com/xx/DXSetting&#x27;</span></span><br><span class="line">  s.license          = &#123; :type =&gt; <span class="string">&#x27;MIT&#x27;</span>, :file =&gt; <span class="string">&#x27;LICENSE&#x27;</span> &#125;</span><br><span class="line">  s.author           = &#123; <span class="string">&#x27;caodaxun&#x27;</span> =&gt; <span class="string">&#x27;xx@xx.com.cn&#x27;</span> &#125;</span><br><span class="line">  s.source           = &#123; :git =&gt; <span class="string">&#x27;https://gitee.com/xx/xx.git&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">  s.ios.deployment_target = <span class="string">&#x27;11.0&#x27;</span></span><br><span class="line">  s.vendored_frameworks = <span class="string">&#x27;*.framework&#x27;</span></span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>Podfile 中 pod 本地 framework</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod &#39;DXDobby&#39;, :path &#x3D;&gt; &#39;.&#x2F;DXDobby&#39;</span><br></pre></td></tr></table></figure>

<h5 id="HOOK函数地址"><a href="#HOOK函数地址" class="headerlink" title="HOOK函数地址"></a>HOOK函数地址</h5><p>尝试在 .xm 的 %ctor 初始化中使用 Dobby，不过报错了，在 load 方法中去 hook</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&quot;HookTest.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;DobbyX/dobby.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mach-o/dyld.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">HookTest</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> (*sum_p)(<span class="keyword">int</span> a, <span class="keyword">int</span> b);</span><br><span class="line"><span class="keyword">int</span> mySum(<span class="keyword">int</span> a, <span class="keyword">int</span> b) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;hook 到了 sum 之前: %d &quot;</span>, sum_p(a, b));</span><br><span class="line">    <span class="keyword">return</span> a - b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="keyword">static</span> uintptr_t sumOrg = <span class="number">0x100005D6C</span>;</span><br><span class="line">  	<span class="comment">//获取 ASLR</span></span><br><span class="line">    uintptr_t aslr = (uintptr_t)_dyld_get_image_vmaddr_slide(<span class="number">0</span>);</span><br><span class="line">    sumOrg += aslr;</span><br><span class="line">    DobbyHook(sumOrg, mySum, (<span class="keyword">void</span> *)&amp;sum_p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>使用 DobbyInstrument</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> hook_call(RegisterContext *ctx, <span class="keyword">const</span> HookEntryInfo *info) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;hook_call: %p %p %p&quot;</span>, info-&gt;target_address, info-&gt;function_address, info-&gt;instruction_address);</span><br><span class="line">    <span class="comment">// 打印寄存器 X0 的值</span></span><br><span class="line">    printf(<span class="string">&quot;Value in X0 register: %#llx\n&quot;</span>, ctx-&gt;general.regs.x0);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    <span class="keyword">static</span> uintptr_t sumOrg = <span class="number">0x100005D6C</span>;</span><br><span class="line">    uintptr_t aslr = (uintptr_t)_dyld_get_image_vmaddr_slide(<span class="number">0</span>);</span><br><span class="line">    sumOrg += aslr;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;hook sum 函数地址 0x%llx&quot;</span>, sumOrg);</span><br><span class="line">    <span class="keyword">if</span> (DobbyInstrument((<span class="keyword">void</span> *)sumOrg, hook_call) == RS_SUCCESS) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;success&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="Dobby-其它方法"><a href="#Dobby-其它方法" class="headerlink" title="Dobby 其它方法"></a>Dobby 其它方法</h4><h5 id="DobbyInstrument"><a href="#DobbyInstrument" class="headerlink" title="DobbyInstrument"></a>DobbyInstrument</h5><p>可以在函数执行过程中，对函数参数、返回值、cpu上下文信息进行监控和记录，可以使用 RegisterContext 结构体访问寄存器和内存数据</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">ctx：上下文信息</span></span><br><span class="line"><span class="comment">info：插件的一些信息</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (*DBICallTy)(RegisterContext *ctx, <span class="keyword">const</span> HookEntryInfo *info);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">address：hook的函数地址</span></span><br><span class="line"><span class="comment">dbi_call：函数指针，函数执行期间需要调用的回调函数</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">int</span> DobbyInstrument(<span class="keyword">void</span> *address, DBICallTy dbi_call);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义回调函数</span></span><br><span class="line"><span class="keyword">void</span> my_pre_call(RegisterContext *ctx, <span class="keyword">const</span> HookEntryInfo *info) &#123;</span><br><span class="line">    <span class="keyword">int</span> num_syscall;</span><br><span class="line">    <span class="keyword">void</span> *sp = (<span class="keyword">void</span> *)ctx-&gt;sp;</span><br><span class="line">    <span class="keyword">void</span> *lr = (<span class="keyword">void</span> *)ctx-&gt;lr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取系统调用号</span></span><br><span class="line">    num_syscall = ctx-&gt;general.x[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断是否为 SYS_ptrace 系统调用</span></span><br><span class="line">    <span class="keyword">if</span> (num_syscall == SYS_ptrace) &#123;</span><br><span class="line">        <span class="keyword">int</span> *request_ptr = (<span class="keyword">int</span> *)((<span class="keyword">char</span> *)sp + <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span> (*request_ptr == PT_DENY_ATTACH) &#123;</span><br><span class="line">            <span class="comment">// 修改参数为 10</span></span><br><span class="line">            *request_ptr = <span class="number">10</span>;</span><br><span class="line">            <span class="comment">// 打印日志信息</span></span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;[AntiDebugBypass] catch &#x27;syscall(SYS_ptrace, PT_DENY_ATTACH, 0, &quot;</span></span><br><span class="line">                  <span class="string">@&quot;0, 0)&#x27; and bypass.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%ctor &#123;</span><br><span class="line">    <span class="keyword">void</span> *syscall_ptr = dlsym(RTLD_DEFAULT, <span class="string">&quot;syscall&quot;</span>);</span><br><span class="line">    DobbyInstrument(syscall_ptr, my_pre_call);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="DobbyDestroy"><a href="#DobbyDestroy" class="headerlink" title="DobbyDestroy"></a>DobbyDestroy</h5><p>撤销 hook 操作</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// destory and restore hook</span></span><br><span class="line"><span class="keyword">int</span> DobbyDestroy(<span class="keyword">void</span> *address);</span><br></pre></td></tr></table></figure>

<h5 id="DobbySymbolResolver"><a href="#DobbySymbolResolver" class="headerlink" title="DobbySymbolResolver"></a>DobbySymbolResolver</h5><p>迭代符号表并查找符号的方法，返回值为指针类型，表示找到的符号地址</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// iterate symbol table and find symbol</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">image_name：动态链接库名称</span></span><br><span class="line"><span class="comment">symbol_name：查找符号名称</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">void</span> *DobbySymbolResolver(<span class="keyword">const</span> <span class="keyword">char</span> *image_name, <span class="keyword">const</span> <span class="keyword">char</span> *symbol_name);</span><br></pre></td></tr></table></figure>

<p>例子 </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//例子</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;dobby.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 目标函数</span></span><br><span class="line"><span class="keyword">int</span> add(<span class="keyword">int</span> a, <span class="keyword">int</span> b) &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于替换目标函数的 Hook 函数</span></span><br><span class="line"><span class="keyword">int</span> add_hook(<span class="keyword">int</span> a, <span class="keyword">int</span> b) &#123;</span><br><span class="line">    printf(<span class="string">&quot;add_hook: %d + %d = %d\n&quot;</span>, a, b, a + b);</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main() &#123;</span><br><span class="line">    <span class="comment">// 查找目标函数地址</span></span><br><span class="line">    <span class="keyword">void</span> *add_addr = DobbySymbolResolver(<span class="string">&quot;libtest.so&quot;</span>, <span class="string">&quot;add&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (add_addr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        printf(<span class="string">&quot;Failed to find symbol: add\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Hook 目标函数</span></span><br><span class="line">    <span class="keyword">if</span> (DobbyHook(add_addr, (<span class="keyword">void</span> *)add_hook, <span class="literal">NULL</span>) != RS_SUCCESS) &#123;</span><br><span class="line">        printf(<span class="string">&quot;Failed to hook function: add\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用目标函数</span></span><br><span class="line">    <span class="keyword">int</span> result = add(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    printf(<span class="string">&quot;Result: %d\n&quot;</span>, result);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解除目标函数 Hook</span></span><br><span class="line">    <span class="keyword">if</span> (DobbyDestroy(add_addr) != RS_SUCCESS) &#123;</span><br><span class="line">        printf(<span class="string">&quot;Failed to destroy hook function: add\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="DobbyGlobalOffsetTableReplace"><a href="#DobbyGlobalOffsetTableReplace" class="headerlink" title="DobbyGlobalOffsetTableReplace"></a>DobbyGlobalOffsetTableReplace</h5><p><code>DobbyGlobalOffsetTableReplace</code> 是 Dobby 库中用于 Hook 全局偏移表（Global Offset Table，简称 GOT）中的符号实现函数 Hook 的方法。GOT 表是 ELF 文件中存储全局变量和函数地址的位置，所有引用该变量或函数的代码都会通过 GOT 来找到变量或函数的地址。通过 Hook GOT 表中的某个符号，可以将其映射到一个自定义的函数地址上，从而实现对其的 Hook</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// global offset table</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">image_name：待 Hook 的 ELF 文件名，例如 libtest.so。</span></span><br><span class="line"><span class="comment">symbol_name：待 Hook 的符号名，可以是变量名或函数名。</span></span><br><span class="line"><span class="comment">fake_func：替换后的函数指针。</span></span><br><span class="line"><span class="comment">orig_func：原始函数指针的地址</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">int</span> DobbyGlobalOffsetTableReplace(<span class="keyword">char</span> *image_name, <span class="keyword">char</span> *symbol_name, <span class="keyword">void</span> *fake_func, <span class="keyword">void</span> **orig_func);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;dobby.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 目标函数</span></span><br><span class="line"><span class="keyword">int</span> add(<span class="keyword">int</span> a, <span class="keyword">int</span> b) &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于替换目标函数的 Hook 函数</span></span><br><span class="line"><span class="keyword">int</span> add_hook(<span class="keyword">int</span> a, <span class="keyword">int</span> b) &#123;</span><br><span class="line">    printf(<span class="string">&quot;add_hook: %d + %d = %d\n&quot;</span>, a, b, a + b);</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main() &#123;</span><br><span class="line">    <span class="keyword">void</span> *handle = dlopen(<span class="string">&quot;libtest.so&quot;</span>, RTLD_NOW);</span><br><span class="line">    <span class="keyword">if</span> (handle == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        printf(<span class="string">&quot;Failed to open library: libtest.so\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查找目标函数符号的地址</span></span><br><span class="line">    <span class="keyword">void</span> *add_addr = dlsym(handle, <span class="string">&quot;add&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (add_addr == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        printf(<span class="string">&quot;Failed to find symbol: add\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 替换目标函数符号的地址</span></span><br><span class="line">    <span class="keyword">void</span> *orig_add_addr = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (DobbyGlobalOffsetTableReplace(<span class="string">&quot;libtest.so&quot;</span>, <span class="string">&quot;add&quot;</span>, (<span class="keyword">void</span> *)add_hook, &amp;orig_add_addr) != RS_SUCCESS) &#123;</span><br><span class="line">        printf(<span class="string">&quot;Failed to hook function: add\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用目标函数</span></span><br><span class="line">    <span class="keyword">int</span> result = ((<span class="keyword">int</span> (*)(<span class="keyword">int</span>, <span class="keyword">int</span>))add_addr)(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    printf(<span class="string">&quot;Result: %d\n&quot;</span>, result);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解除目标函数 Hook</span></span><br><span class="line">    <span class="keyword">if</span> (DobbyGlobalOffsetTableReplace(<span class="string">&quot;libtest.so&quot;</span>, <span class="string">&quot;add&quot;</span>, orig_add_addr, <span class="literal">NULL</span>) != RS_SUCCESS) &#123;</span><br><span class="line">        printf(<span class="string">&quot;Failed to destroy hook function: add\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dlclose(handle);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="dobby-register-image-load-callback"><a href="#dobby-register-image-load-callback" class="headerlink" title="dobby_register_image_load_callback"></a>dobby_register_image_load_callback</h5><p><code>dobby_register_image_load_callback</code> 函数是 Dobby 库中用于注册动态链接器加载 ELF 文件时的回调函数的方法。当动态链接器加载一个新的 ELF 文件时，Dobby 库会自动调用注册的回调函数，并传递该 ELF 文件的文件名和句柄</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// register linker load image callback</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (*linker_load_callback_t)(<span class="keyword">const</span> <span class="keyword">char</span> *image_name, <span class="keyword">void</span> *handle);</span><br><span class="line"><span class="keyword">void</span> dobby_register_image_load_callback(linker_load_callback_t func);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;dobby.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 回调函数</span></span><br><span class="line"><span class="keyword">void</span> image_loaded_callback(<span class="keyword">const</span> <span class="keyword">char</span> *image_name, <span class="keyword">void</span> *handle) &#123;</span><br><span class="line">    printf(<span class="string">&quot;Image loaded: %s, handle: %p\n&quot;</span>, image_name, handle);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main() &#123;</span><br><span class="line">    <span class="comment">// 注册回调函数</span></span><br><span class="line">    dobby_register_image_load_callback(image_loaded_callback);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载 ELF 文件</span></span><br><span class="line">    <span class="keyword">void</span> *handle = dlopen(<span class="string">&quot;libtest.so&quot;</span>, RTLD_NOW);</span><br><span class="line">    <span class="keyword">if</span> (handle == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        printf(<span class="string">&quot;Failed to open library: libtest.so\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 卸载 ELF 文件</span></span><br><span class="line">    dlclose(handle);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="Hook-svc-0x80"><a href="#Hook-svc-0x80" class="headerlink" title="Hook svc#0x80"></a>Hook svc#0x80</h4><h5 id="svc-ptrace"><a href="#svc-ptrace" class="headerlink" title="svc ptrace"></a>svc ptrace</h5><p>写个 demo svc ptrace 反调试</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> svc_ptrace() &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __arm64__</span></span><br><span class="line">    __asm__(<span class="string">&quot;mov X0, #31\n&quot;</span></span><br><span class="line">            <span class="string">&quot;mov X1, #0\n&quot;</span></span><br><span class="line">            <span class="string">&quot;mov X2, #0\n&quot;</span></span><br><span class="line">            <span class="string">&quot;mov X3, #0\n&quot;</span></span><br><span class="line">            <span class="string">&quot;mov w16, #26\n&quot;</span></span><br><span class="line">            <span class="string">&quot;svc #0x80&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="查找-svc-0x80-地址"><a href="#查找-svc-0x80-地址" class="headerlink" title="查找 svc #0x80 地址"></a>查找 <code>svc #0x80</code> 地址</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;mach-o/dyld.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;mach-o/loader.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;mach-o/nlist.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">__attribute__((constructor)) <span class="keyword">static</span> <span class="keyword">void</span> search_svc_0x80() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">NSString</span> *binaryPath = [[<span class="built_in">NSBundle</span> mainBundle] executablePath];</span><br><span class="line">    <span class="built_in">NSData</span> *binaryData = [<span class="built_in">NSData</span> dataWithContentsOfFile:binaryPath];</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">struct</span> mach_header_64 *header1 = (<span class="keyword">const</span> <span class="keyword">struct</span> mach_header_64 *)[binaryData bytes];</span><br><span class="line">    </span><br><span class="line">    FILE *file = fopen([binaryPath UTF8String], <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!file) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;Failed to open file: %@&quot;</span>, binaryPath);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//基地址</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">struct</span> mach_header_64 *header = (<span class="keyword">struct</span> mach_header_64 *)_dyld_get_image_header(<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (header-&gt;magic != MH_MAGIC_64) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;Not a 64-bit Mach-O binary!&quot;</span>);</span><br><span class="line">        fclose(file);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> cpu_type = header-&gt;cputype;</span><br><span class="line">    <span class="keyword">int</span> cpu_subtype = header-&gt;cpusubtype;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 找到__TEXT段的LC_SEGMENT_64结构体</span></span><br><span class="line">    <span class="keyword">struct</span> segment_command_64 *text_segment = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">for</span> (uint32_t i = <span class="number">0</span>; i &lt; header-&gt;ncmds; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">struct</span> load_command *lc = (<span class="keyword">const</span> <span class="keyword">struct</span> load_command *)((<span class="keyword">const</span> <span class="keyword">char</span> *)header + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> mach_header_64) + i * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> load_command));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (lc-&gt;cmd == LC_SEGMENT_64) &#123;</span><br><span class="line">            <span class="keyword">struct</span> segment_command_64 *segment = (<span class="keyword">struct</span> segment_command_64 *)lc;</span><br><span class="line">            <span class="keyword">if</span> (strcmp(segment-&gt;segname, <span class="string">&quot;__TEXT&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">                text_segment = segment;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!text_segment) &#123;</span><br><span class="line">        printf(<span class="string">&quot;Failed to find __TEXT segment\n&quot;</span>);</span><br><span class="line">        fclose(file);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 遍历__TEXT段的__text节，寻找svc #0x80指令</span></span><br><span class="line">    uint64_t base_address = text_segment-&gt;vmaddr;</span><br><span class="line">    uint64_t file_offset = text_segment-&gt;fileoff;</span><br><span class="line">    <span class="keyword">for</span> (uint32_t i = <span class="number">0</span>; i &lt; text_segment-&gt;nsects; i++) &#123;</span><br><span class="line">        <span class="comment">//节</span></span><br><span class="line">        <span class="keyword">struct</span> section_64 *section = (<span class="keyword">struct</span> section_64 *)((<span class="keyword">char</span> *)text_segment + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> segment_command_64) + (i * <span class="keyword">sizeof</span>(<span class="keyword">struct</span> section_64)));</span><br><span class="line">        <span class="keyword">if</span> (strcmp(section-&gt;sectname, <span class="string">&quot;__text&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">            printf(<span class="string">&quot;Searching for svc #0x80 within section &#x27;%s&#x27;...\n&quot;</span>, section-&gt;sectname);</span><br><span class="line">            uint64_t section_base_address = base_address + section-&gt;addr;</span><br><span class="line">            uint64_t section_file_offset = file_offset + section-&gt;offset;</span><br><span class="line">            uint64_t section_size = section-&gt;size;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 读取__text节的内容到缓冲区buffer中</span></span><br><span class="line">            fseek(file, section_file_offset, SEEK_SET);</span><br><span class="line">            <span class="keyword">unsigned</span> <span class="keyword">char</span> *buffer = (<span class="keyword">unsigned</span> <span class="keyword">char</span> *)malloc(section_size);</span><br><span class="line">            fread(buffer, section_size, <span class="number">1</span>, file);</span><br><span class="line"></span><br><span class="line">            uint64_t svc_instruction_address = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">// 遍历缓冲区中每一个字节，查找&quot;svc #0x80&quot;指令</span></span><br><span class="line">            <span class="keyword">for</span> (uint64_t j = <span class="number">0</span>; j &lt; section_size - <span class="number">3</span>; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (buffer[j] == <span class="number">0x01</span> &amp;&amp; buffer[j+<span class="number">1</span>] == <span class="number">0x10</span> &amp;&amp; buffer[j+<span class="number">2</span>] == <span class="number">0x00</span> &amp;&amp; buffer[j+<span class="number">3</span>] == <span class="number">0xD4</span>) &#123;</span><br><span class="line">                    <span class="comment">// 找到&quot;svc #0x80&quot;指令，计算其在内存中的地址并记录</span></span><br><span class="line">                    svc_instruction_address = section_base_address + j;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">//减去 PAGEZERO（0x100000000） 减之后就和IDA上查看地址一样了</span></span><br><span class="line">                    svc_instruction_address -= <span class="number">0x100000000</span>;</span><br><span class="line">                  </span><br><span class="line">                    <span class="built_in">NSLog</span>(<span class="string">@&quot;找到 svc #0x80 地址 0x%llx&quot;</span>, svc_instruction_address);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            free(buffer);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行后打印 <code>找到 svc #0x80 地址 0x100005d9c</code></p>
<p>砸壳后将可执行文件放入 IDA 中找到 svc 指令的位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">__text:0000000100005D88 _svc_ptrace   ; CODE XREF: -[ViewController viewDidLoad]+38↑p</span><br><span class="line">__text:0000000100005D88                 MOV             X0, #0x1F</span><br><span class="line">__text:0000000100005D8C                 MOV             X1, #0</span><br><span class="line">__text:0000000100005D90                 MOV             X2, #0</span><br><span class="line">__text:0000000100005D94                 MOV             X3, #0</span><br><span class="line">__text:0000000100005D98                 MOV             W16, #0x1A</span><br><span class="line">__text:0000000100005D9C                 SVC             0x80</span><br><span class="line">__text:0000000100005DA0                 RET</span><br></pre></td></tr></table></figure>

<p>那么如果要 hook 函数地址，hook 0x100005d9c + 模块偏移地址 </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">oid hook_call(RegisterContext *ctx, <span class="keyword">const</span> HookEntryInfo *info) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;hook_call: %p %p %p&quot;</span>, info-&gt;target_address, info-&gt;function_address, info-&gt;instruction_address);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> w16;</span><br><span class="line">    <span class="keyword">int</span> x0;</span><br><span class="line">    w16 = (<span class="keyword">int</span>)(uint64_t)(ctx-&gt;general.regs.x16);</span><br><span class="line">    x0 = (<span class="keyword">int</span>)(uint64_t)(ctx-&gt;general.regs.x0);</span><br><span class="line">    </span><br><span class="line">    printf(<span class="string">&quot;修改前：w16:%#llx, x0: %#llx\n&quot;</span>, ctx-&gt;general.regs.x0, ctx-&gt;general.regs.x16);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (w16 == SYS_ptrace &amp;&amp; x0 == PT_DENY_ATTACH) &#123; <span class="comment">//ptrace反调试</span></span><br><span class="line">        ctx-&gt;general.regs.x0 = <span class="number">10</span>; <span class="comment">//改成10允许ptrace</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 打印寄存器 X0 的值</span></span><br><span class="line">    printf(<span class="string">&quot;修改后：w16:%#llx, x0: %#llx\n&quot;</span>, ctx-&gt;general.regs.x0, ctx-&gt;general.regs.x16);</span><br><span class="line">&#125;</span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">  <span class="keyword">static</span> uintptr_t svc0x80 = <span class="number">0x100005cb4</span>;</span><br><span class="line">  uintptr_t aslr = (uintptr_t)_dyld_get_image_vmaddr_slide(<span class="number">0</span>);</span><br><span class="line">  svc0x80 += aslr;</span><br><span class="line">  <span class="keyword">if</span> (DobbyInstrument((<span class="keyword">void</span> *)svc0x80, hook_call) == RS_SUCCESS) &#123;</span><br><span class="line">      <span class="built_in">NSLog</span>(<span class="string">@&quot;success&quot;</span>);</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
































      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/30/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%8F%8D%E7%BC%96%E8%AF%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/30/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%8F%8D%E7%BC%96%E8%AF%91/" class="post-title-link" itemprop="url">微信小程序反编译</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-05-30 17:13:02" itemprop="dateCreated datePublished" datetime="2022-05-30T17:13:02+08:00">2022-05-30</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-10-24 10:31:41" itemprop="dateModified" datetime="2022-10-24T10:31:41+08:00">2022-10-24</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903603484753927">微信小程序反编译实战（一）解包</a></p>
<h4 id="frida"><a href="#frida" class="headerlink" title="frida"></a>frida</h4><p>利用 frida-trace 跟踪类的所有方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida-trace -U -f com.ss.iphone.ugc.Aweme -m &quot;-[AWEAwemeShareViewController *]&quot;</span><br></pre></td></tr></table></figure>

<h4 id="node-js安装"><a href="#node-js安装" class="headerlink" title="node.js安装"></a>node.js安装</h4><p><a target="_blank" rel="noopener" href="https://nodejs.org/en/">https://nodejs.org/en/</a> 或者</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ brew install node</span><br><span class="line"></span><br><span class="line">#依赖安装</span><br><span class="line">npm install uglify-es --save</span><br><span class="line">npm install esprima  --save</span><br><span class="line">npm install css-tree  --save</span><br><span class="line">npm install cssbeautify --save</span><br><span class="line">npm install vm2  --save</span><br><span class="line">npm install uglify-es  --save</span><br><span class="line">npm install js-beautify  --save</span><br><span class="line">npm install escodegen  --save</span><br><span class="line">npm install cheerio --save</span><br></pre></td></tr></table></figure>

<h4 id="wxapkg"><a href="#wxapkg" class="headerlink" title="wxapkg"></a>wxapkg</h4><p>小程序是以 wxapkg 拓展名的文件，在微信沙盒目录下搜索 wxapkg</p>
<p>iPhone 设备微信打开小程序，打开微信沙盒目录，搜索 wxapkg 找到最新时间的 wxapkg 文件</p>
<p>导出拷贝到电脑</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;var&#x2F;mobile&#x2F;Containers&#x2F;Data&#x2F;Application&#x2F;3A176EEE-76AD-4424-8966-961834916101&#x2F;Library&#x2F;WechatPrivate&#x2F;0461325054f5668774d3cf52bc6ead7b&#x2F;WeApp&#x2F;LocalCache&#x2F;release&#x2F;wx48e51a643b3b85db</span><br></pre></td></tr></table></figure>

<ul>
<li>也可以通过安卓模拟器获取</li>
</ul>
<p>网易MuMu，开启Root权限，进入设置中心，基本设置，勾选开启Root权限</p>
<p>安装RE文件管理器和微信，打开微信进入小程序</p>
<p>RE文件管理器进入 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;data&#x2F;data&#x2F;com.tencent.mm&#x2F;MicroMsg&#x2F;&#123;一串32位16进制字符串&#125;&#x2F;appbrand&#x2F;pkg</span><br></pre></td></tr></table></figure>

<p>长按-压缩所选文件-发送</p>
<h4 id="wxapkg-解包"><a href="#wxapkg-解包" class="headerlink" title="wxapkg 解包"></a>wxapkg 解包</h4><p>node.js 脚本还原小程序源码</p>
<p>解包脚本  <a target="_blank" rel="noopener" href="https://github.com/larack8/wxappUnpacker">https://github.com/larack8/wxappUnpacker</a>  </p>
<p>加个代理访问快些  <a target="_blank" rel="noopener" href="https://gh.fakev.cn/larack8/wxappUnpacker">https://gh.fakev.cn/larack8/wxappUnpacker</a>  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#一键解包还原</span><br><span class="line">#自动将 wxapkg 文件解包，并将包中相关的已被编译&#x2F;混淆的文件自动恢复原状（包括目录结构）</span><br><span class="line">node .&#x2F;wuWxapkg.js &#x2F;Users&#x2F;xxx&#x2F;Desktop&#x2F;unpack&#x2F;10.wxapkg</span><br></pre></td></tr></table></figure>

<p>最后在微信开发者工具中，新建空白小程序工程，将还原后的相关目录文件导入工程，即可编译运行起来</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/21/ReactiveObjC%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/21/ReactiveObjC%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">ReactiveObjC使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-05-21 12:08:17" itemprop="dateCreated datePublished" datetime="2022-05-21T12:08:17+08:00">2022-05-21</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-09-14 15:26:42" itemprop="dateModified" datetime="2022-09-14T15:26:42+08:00">2022-09-14</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li>MVVM </li>
</ul>
<p>MVVM 中，view 和 view controller 联系在一起，我们把它们视为一个组件，view 和 view controller ，都不能直接引用 model，而是直接引用视图模型（viewModel）viewModel 是一个放置用户输入验证逻辑，视图显示逻辑，发起网络请求和其他代码的地方</p>
<p>view 引用 viewModel，但反过来不行，即不要在viewModel 中引入 #import UIKit.h，任何视图的引用都不应该放在 viewModel 中。viewModel 引用 model，但反过来不行</p>
<h4 id="1-MVVM登录"><a href="#1-MVVM登录" class="headerlink" title="1.MVVM登录"></a>1.MVVM登录</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">需求：1.监听两个文本框的内容，有内容才允许按钮点击</span></span><br><span class="line"><span class="comment">     2.默认登录请求.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">用MVVM：实现，之前界面的所有业务逻辑</span></span><br><span class="line"><span class="comment">分析：1.之前界面的所有业务逻辑都交给控制器做处理</span></span><br><span class="line"><span class="comment">     2.在MVVM架构中把控制器的业务全部搬去VM模型，也就是每个控制器对应一个VM模型.</span></span><br><span class="line"><span class="comment">步骤：</span></span><br><span class="line"><span class="comment">    1.创建LoginViewModel类，处理登录界面业务逻辑.</span></span><br><span class="line"><span class="comment">    2.这个类里面应该保存着账号的信息，创建一个账号Account模型</span></span><br><span class="line"><span class="comment">    3.LoginViewModel应该保存着账号信息Account模型。</span></span><br><span class="line"><span class="comment">    4.需要时刻监听Account模型中的账号和密码的改变，怎么监听？</span></span><br><span class="line"><span class="comment">    5.在非RAC开发中，都是习惯赋值，在RAC开发中，需要改变开发思维，由赋值转变为绑定，可以在一开始初始化的时候，就给Account模型中的属性绑定，并不需要重写set方法。</span></span><br><span class="line"><span class="comment">    6.每次Account模型的值改变，就需要判断按钮能否点击，在VM模型中做处理，给外界提供一个能否点击按钮的信号.</span></span><br><span class="line"><span class="comment">    7.这个登录信号需要判断Account中账号和密码是否有值，用KVO监听这两个值的改变，把他们聚合成登录信号.</span></span><br><span class="line"><span class="comment">    8.监听按钮的点击，由VM处理，应该给VM声明一个RACCommand，专门处理登录业务逻辑.</span></span><br><span class="line"><span class="comment">    9.执行命令，把数据包装成信号传递出去</span></span><br><span class="line"><span class="comment">    10.监听命令中信号的数据传递</span></span><br><span class="line"><span class="comment">    11.监听命令的执行时刻</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rac_textSignal只有用户输入才有效，如果只是直接赋值 </span><br><span class="line">eg:<span class="keyword">self</span>.inputView.phoneTextField.text = <span class="string">@&quot;xxxx&quot;</span>  <span class="keyword">self</span>.inputView.phoneTextField.rac_textSignal 就不会触发的</span><br><span class="line">RAC(<span class="keyword">self</span>.viewModel , mobilePhone) = </span><br><span class="line">[RACSignal merge: @[RACObserve(<span class="keyword">self</span>.inputView.phoneTextField,text),</span><br><span class="line">     								<span class="keyword">self</span>.inputView.phoneTextField.rac_textSignal]];</span><br></pre></td></tr></table></figure>

<h5 id="控制器代码"><a href="#控制器代码" class="headerlink" title="控制器代码"></a>控制器代码</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) LoginViewModel *loginViewModel;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) <span class="keyword">IBOutlet</span> <span class="built_in">UITextField</span> *accountField;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) <span class="keyword">IBOutlet</span> <span class="built_in">UITextField</span> *pwdField;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) <span class="keyword">IBOutlet</span> <span class="built_in">UIButton</span> *loginBtn;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">- (LoginViewModel *)loginViewModel &#123;</span><br><span class="line">    <span class="keyword">if</span> (_loginViewModel == <span class="literal">nil</span>) &#123;</span><br><span class="line">        _loginViewModel = [[LoginViewModel alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _loginViewModel;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 视图模型绑定</span></span><br><span class="line">- (<span class="keyword">void</span>)bindModel &#123;</span><br><span class="line">    <span class="comment">// 给模型的属性绑定信号</span></span><br><span class="line">    <span class="comment">// 只要账号文本框一改变，就会给account赋值</span></span><br><span class="line">    RAC(<span class="keyword">self</span>.loginViewModel.account, account) = _accountField.rac_textSignal;</span><br><span class="line">    RAC(<span class="keyword">self</span>.loginViewModel.account, pwd) = _pwdField.rac_textSignal;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 绑定登录按钮</span></span><br><span class="line">    RAC(<span class="keyword">self</span>.loginBtn,enabled) = <span class="keyword">self</span>.loginViewModel.enableLoginSignal;</span><br><span class="line">    </span><br><span class="line">   <span class="comment">// 监听登录按钮点击</span></span><br><span class="line">    [[_loginBtn rac_signalForControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">        <span class="comment">// 执行登录事件</span></span><br><span class="line">        [<span class="keyword">self</span>.loginViewModel.LoginCommand execute:<span class="literal">nil</span>];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="VM代码"><a href="#VM代码" class="headerlink" title="VM代码"></a>VM代码</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">LoginViewModel</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) Account *account;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否允许登录的信号</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) RACSignal *enableLoginSignal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) RACCommand *LoginCommand;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">LoginViewModel</span></span></span><br><span class="line">- (Account *)account</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (_account == <span class="literal">nil</span>) &#123;</span><br><span class="line">        _account = [[Account alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _account;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">instancetype</span>)init</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> initialBind];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化绑定</span></span><br><span class="line">- (<span class="keyword">void</span>)initialBind &#123;</span><br><span class="line">    <span class="comment">// 监听账号的属性值改变，把他们聚合成一个信号。</span></span><br><span class="line">    _enableLoginSignal = [RACSignal combineLatest:@[RACObserve(<span class="keyword">self</span>.account, account),RACObserve(<span class="keyword">self</span>.account, pwd)] reduce:^<span class="keyword">id</span>(<span class="built_in">NSString</span> *account,<span class="built_in">NSString</span> *pwd)&#123;</span><br><span class="line">        <span class="keyword">return</span> @(account.length &amp;&amp; pwd.length);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 处理登录业务逻辑</span></span><br><span class="line">    _LoginCommand = [[RACCommand alloc] initWithSignalBlock:^RACSignal *(<span class="keyword">id</span> input) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;点击了登录&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">            <span class="comment">// 模仿网络延迟</span></span><br><span class="line">            dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">0.5</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                [subscriber sendNext:<span class="string">@&quot;登录成功&quot;</span>];</span><br><span class="line">                <span class="comment">// 数据传送完毕，必须调用完成，否则命令永远处于执行状态</span></span><br><span class="line">                [subscriber sendCompleted];</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 监听登录产生的数据</span></span><br><span class="line">    [_LoginCommand.executionSignals.switchToLatest subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([x isEqualToString:<span class="string">@&quot;登录成功&quot;</span>]) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;登录成功&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 监听登录状态</span></span><br><span class="line">    [[_LoginCommand.executing skip:<span class="number">1</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([x isEqualToNumber:@(<span class="literal">YES</span>)]) &#123;</span><br><span class="line">            <span class="comment">// 正在登录ing... 用蒙版提示</span></span><br><span class="line">            [MBProgressHUD showMessage:<span class="string">@&quot;正在登录...&quot;</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="comment">// 登录成功 隐藏蒙版</span></span><br><span class="line">            [MBProgressHUD hideHUD];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-登录"><a href="#2-登录" class="headerlink" title="2.登录"></a>2.登录</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将信号输出应用到对象属性上</span></span><br><span class="line">RAC(<span class="keyword">self</span>.passwordTextField, backgroundColor) =</span><br><span class="line">[validPasswordSignal</span><br><span class="line">    map:^<span class="keyword">id</span>(<span class="built_in">NSNumber</span> *passwordValid)&#123;</span><br><span class="line">      <span class="keyword">return</span>[passwordValid boolValue] ? [<span class="built_in">UIColor</span> clearColor]:[<span class="built_in">UIColor</span> yellowColor];</span><br><span class="line">&#125;];</span><br><span class="line"> </span><br><span class="line">RAC(<span class="keyword">self</span>.usernameTextField, backgroundColor) =</span><br><span class="line">[validUsernameSignal</span><br><span class="line">    map:^<span class="keyword">id</span>(<span class="built_in">NSNumber</span> *passwordValid)&#123;</span><br><span class="line">     <span class="keyword">return</span>[passwordValid boolValue] ? [<span class="built_in">UIColor</span> clearColor]:[<span class="built_in">UIColor</span> yellowColor];</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">//聚合信号决定登录按钮是否可用</span></span><br><span class="line">RACSignal *signUpActiveSignal =</span><br><span class="line">  [RACSignal combineLatest:@[validUsernameSignal, validPasswordSignal]</span><br><span class="line">                    reduce:^<span class="keyword">id</span>(<span class="built_in">NSNumber</span>*usernameValid, <span class="built_in">NSNumber</span> *passwordValid)&#123;</span><br><span class="line">                      <span class="keyword">return</span> @([usernameValid boolValue]&amp;&amp;[passwordValid boolValue]);</span><br><span class="line">                    &#125;];</span><br><span class="line">[signUpActiveSignal subscribeNext:^(<span class="built_in">NSNumber</span>*signupActive)&#123;</span><br><span class="line">   <span class="keyword">self</span>.signInButton.enabled =[signupActive boolValue];</span><br><span class="line"> &#125;];</span><br><span class="line"></span><br><span class="line">[[[[<span class="keyword">self</span>.signInButton</span><br><span class="line">   rac_signalForControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>]</span><br><span class="line">   doNext:^(<span class="keyword">id</span> x)&#123; <span class="comment">//附加操作</span></span><br><span class="line">     <span class="keyword">self</span>.signInButton.enabled =<span class="literal">NO</span>;</span><br><span class="line">     <span class="keyword">self</span>.signInFailureText.hidden =<span class="literal">YES</span>;</span><br><span class="line">   &#125;]</span><br><span class="line">   flattenMap:^<span class="keyword">id</span>(<span class="keyword">id</span> x)&#123;</span><br><span class="line">     <span class="keyword">return</span>[<span class="keyword">self</span> signInSignal];</span><br><span class="line">   &#125;]</span><br><span class="line">   subscribeNext:^(<span class="built_in">NSNumber</span>*signedIn)&#123;</span><br><span class="line">     <span class="keyword">self</span>.signInButton.enabled =<span class="literal">YES</span>;</span><br><span class="line">     <span class="built_in">BOOL</span> success =[signedIn boolValue];</span><br><span class="line">     <span class="keyword">self</span>.signInFailureText.hidden = success;</span><br><span class="line">     <span class="keyword">if</span>(success)&#123;</span><br><span class="line">       [<span class="keyword">self</span> performSegueWithIdentifier:<span class="string">@&quot;signInSuccess&quot;</span> sender:<span class="keyword">self</span>];</span><br><span class="line">     &#125;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">- (RACSignal *)signInSignal &#123;</span><br><span class="line"><span class="keyword">return</span> [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber)&#123;</span><br><span class="line">   [<span class="keyword">self</span>.signInService </span><br><span class="line">     signInWithUsername:<span class="keyword">self</span>.usernameTextField.text</span><br><span class="line">               password:<span class="keyword">self</span>.passwordTextField.text</span><br><span class="line">               complete:^(<span class="built_in">BOOL</span> success)&#123;</span><br><span class="line">                    [subscriber sendNext:@(success)];</span><br><span class="line">                    [subscriber sendCompleted];</span><br><span class="line">     &#125;];</span><br><span class="line">   	 <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">  &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-MVVM网络请求"><a href="#3-MVVM网络请求" class="headerlink" title="3.MVVM网络请求"></a>3.MVVM网络请求</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">需求：请求豆瓣图书信息，url:https://api.douban.com/v2/book/search?q=基础</span></span><br><span class="line"><span class="comment">分析：请求一样，交给VM模型管理</span></span><br><span class="line"><span class="comment">步骤:</span></span><br><span class="line"><span class="comment">    1.控制器提供一个视图模型（requesViewModel），处理界面的业务逻辑</span></span><br><span class="line"><span class="comment">    2.VM提供一个命令，处理请求业务逻辑</span></span><br><span class="line"><span class="comment">    3.在创建命令的block中，会把请求包装成一个信号，等请求成功的时候，就会把数据传递出去。</span></span><br><span class="line"><span class="comment">    4.请求数据成功，应该把字典转换成模型，保存到视图模型中，控制器想用就直接从视图模型中获取。</span></span><br><span class="line"><span class="comment">    5.假设控制器想展示内容到tableView，直接让视图模型成为tableView的数据源，把所有的业务逻辑交给视图模型去做，这样控制器的代码就非常少了。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h5 id="控制器代码-1"><a href="#控制器代码-1" class="headerlink" title="控制器代码"></a>控制器代码</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="built_in">UITableView</span> *tableView;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) RequestViewModel *requesViewModel;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line">- (RequestViewModel *)requesViewModel &#123;</span><br><span class="line">    <span class="keyword">if</span> (_requesViewModel == <span class="literal">nil</span>) &#123;</span><br><span class="line">        _requesViewModel = [[RequestViewModel alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _requesViewModel;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">  [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建tableView</span></span><br><span class="line">  <span class="built_in">UITableView</span> *tableView = [[<span class="built_in">UITableView</span> alloc] initWithFrame:<span class="keyword">self</span>.view.bounds];</span><br><span class="line">  tableView.dataSource = <span class="keyword">self</span>.requesViewModel;</span><br><span class="line"></span><br><span class="line">  [<span class="keyword">self</span>.view addSubview:tableView];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 执行请求</span></span><br><span class="line">  RACSignal *requesSiganl = [<span class="keyword">self</span>.requesViewModel.reuqesCommand execute:<span class="literal">nil</span>];</span><br><span class="line">   <span class="comment">// 获取请求的数据</span></span><br><span class="line">    [requesSiganl subscribeNext:^(<span class="built_in">NSArray</span> *x) &#123;</span><br><span class="line">        <span class="keyword">self</span>.requesViewModel.models = x;</span><br><span class="line">        [<span class="keyword">self</span>.tableView reloadData]; </span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h5 id="VM代码-1"><a href="#VM代码-1" class="headerlink" title="VM代码"></a>VM代码</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">RequestViewModel</span> : <span class="title">NSObject</span>&lt;<span class="title">UITableViewDataSource</span>&gt;</span></span><br><span class="line"><span class="comment">// 请求命令</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) RACCommand *reuqesCommand;</span><br><span class="line"><span class="comment">//模型数组</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSArray</span> *models;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">RequestViewModel</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> initialBind];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)initialBind &#123;</span><br><span class="line">    _reuqesCommand = [[RACCommand alloc] initWithSignalBlock:^RACSignal *(<span class="keyword">id</span> input) &#123;</span><br><span class="line">        </span><br><span class="line">        RACSignal *requestSignal = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">  </span><br><span class="line">            <span class="built_in">NSMutableDictionary</span> *parameters = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">            parameters[<span class="string">@&quot;q&quot;</span>] = <span class="string">@&quot;基础&quot;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 发送请求</span></span><br><span class="line">            [[AFHTTPRequestOperationManager manager] GET:<span class="string">@&quot;https://api.douban.com/v2/book/search&quot;</span> parameters:parameters success:^(AFHTTPRequestOperation *operation, <span class="keyword">id</span> responseObject) &#123;</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,responseObject);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 请求成功调用</span></span><br><span class="line">                <span class="comment">// 把数据用信号传递出去</span></span><br><span class="line">                [subscriber sendNext:responseObject];</span><br><span class="line">                [subscriber sendCompleted];</span><br><span class="line"></span><br><span class="line">            &#125; failure:^(AFHTTPRequestOperation *operation, <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">                <span class="comment">// 请求失败调用</span></span><br><span class="line">            &#125;];</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">        &#125;];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在返回数据信号时，把数据中的字典映射成模型信号，传递出去</span></span><br><span class="line">        <span class="keyword">return</span> [requestSignal map:^<span class="keyword">id</span>(<span class="built_in">NSDictionary</span> *value) &#123;</span><br><span class="line">            <span class="built_in">NSMutableArray</span> *dictArr = value[<span class="string">@&quot;books&quot;</span>];</span><br><span class="line">            <span class="comment">// 字典转模型，遍历字典中的所有元素，全部映射成模型，并且生成数组</span></span><br><span class="line">            <span class="built_in">NSArray</span> *modelArr = [[dictArr.rac_sequence map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">                <span class="keyword">return</span> [Book bookWithDict:value];</span><br><span class="line">            &#125;] array];</span><br><span class="line">            <span class="keyword">return</span> modelArr;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;];</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark - UITableViewDataSource</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSInteger</span>)tableView:(<span class="built_in">UITableView</span> *)tableView numberOfRowsInSection:(<span class="built_in">NSInteger</span>)section</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.models.count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UITableViewCell</span> *)tableView:(<span class="built_in">UITableView</span> *)tableView cellForRowAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSString</span> *ID = <span class="string">@&quot;cell&quot;</span>;</span><br><span class="line">    <span class="built_in">UITableViewCell</span> *cell = [tableView dequeueReusableCellWithIdentifier:ID];</span><br><span class="line">    <span class="keyword">if</span> (cell == <span class="literal">nil</span>) &#123;</span><br><span class="line">        cell = [[<span class="built_in">UITableViewCell</span> alloc] initWithStyle:<span class="built_in">UITableViewCellStyleSubtitle</span> reuseIdentifier:ID];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Book *book = <span class="keyword">self</span>.models[indexPath.row];</span><br><span class="line">    cell.detailTextLabel.text = book.subtitle;</span><br><span class="line">    cell.textLabel.text = book.title;</span><br><span class="line">    <span class="keyword">return</span> cell;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h4 id="4-Cell复用问题"><a href="#4-Cell复用问题" class="headerlink" title="4.Cell复用问题"></a>4.Cell复用问题</h4><p> Cell复用时清理数据绑定或者事件监听的问题</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">SUGoodsCell</span></span></span><br><span class="line">- (<span class="keyword">void</span>) awakeFromNib &#123;</span><br><span class="line">    [<span class="keyword">super</span> awakeFromNib];</span><br><span class="line">    RAC(<span class="keyword">self</span>.usernameLabel,  text) = RACObserve(<span class="keyword">self</span>,  viewModel.username);</span><br><span class="line">    RAC(<span class="keyword">self</span>.userIdLabel,  text) = RACObserve(<span class="keyword">self</span>,  viewModel.userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 注意viewModel出现在RACObserve宏中逗号右边。 这些 cell 终将被重用，新的viewModels将会被赋值，如果我们不将 viewModel放在逗号右边，那就会监听viewModel属性的变化然后每次都要重新设置绑定；如果放在逗号右边， RACObserve将会为我们负责这些事儿， 因此我们只需要设定一次绑定并让Reactive Cocoa做剩余的部分</p>
<p> 当然，RAC给UITableViewCell提供了一个方法：rac_prepareForReuseSignal，它的作用是当Cell即将要被重用时，告诉Cell。想象Cell上有多个button，Cell在初始化时给每个button都addTarget:action:forControlEvents，被重用时需要先移除这些target，下面这段代码就可以很方便地解决这个问题</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[[[<span class="keyword">self</span>.cancelButton</span><br><span class="line">    rac_signalForControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>]</span><br><span class="line">    takeUntil:<span class="keyword">self</span>.rac_prepareForReuseSignal]</span><br><span class="line">    subscribeNext:^(<span class="built_in">UIButton</span> *x) &#123;</span><br><span class="line">    <span class="comment">// do other things</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<ul>
<li>cell 复用</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 外界订阅处理 </span></span><br><span class="line">cell.button.rx.tap .subscribe(onNext: &#123; () <span class="keyword">in</span> </span><br><span class="line">print(</span><br><span class="line">  <span class="string">&quot;点击了 \(indexPath)&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">.disposed(by: cell.disposeBag)</span><br><span class="line"> </span><br><span class="line"><span class="comment">// cell内部处理 </span></span><br><span class="line">override func prepareForReuse() &#123;</span><br><span class="line">    <span class="keyword">super</span>.prepareForReuse() </span><br><span class="line">    <span class="comment">// 销毁垃圾袋重置</span></span><br><span class="line">    disposeBag = DisposeBag()</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<h4 id="5-UITableView-MVVM-RAC"><a href="#5-UITableView-MVVM-RAC" class="headerlink" title="5.UITableView MVVM+RAC"></a>5.UITableView MVVM+RAC</h4><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/119559ac0961">https://www.jianshu.com/p/119559ac0961</a></p>
<p>viewModel 绑定整个视图，通过 viewModel 获得列表 model后，创建 cellModel（celll的viewModel），每个 cell 绑定 cellModel，cell 根据cellModel变化而变化</p>
<img src="ReactiveObjC使用/图片2.png" alt="图片2" style="zoom:67%;" />

<p>cell单独配置对应的cellviewmodel rac网络请求回来后，把实体model用cellviewmodel进行组装，</p>
<p>主viewmodel请求数据 解析成 [model]</p>
<p>转换成 [cellViewModel]</p>
<p>!(cell加了一层viewmodel 项目变得复杂了)</p>
<p>cell中有个cellVM来管理cell中要显示的数据，cellVM来自于VC中datasource数组</p>
<p>网络请求完成后将字典-》模型 再通过模型初始化cellVM 再将cellVM放入datasource</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RAC(_defaultLab, hidden) = [RACObserve(cellModel, idDefault) not];</span><br></pre></td></tr></table></figure>

<h4 id="6-网络下图图片完成按钮可点击"><a href="#6-网络下图图片完成按钮可点击" class="headerlink" title="6.网络下图图片完成按钮可点击"></a>6.网络下图图片完成按钮可点击</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">-(<span class="keyword">void</span>)btnAvliableWhenImgOK&#123;</span><br><span class="line">    <span class="comment">//  观察img 是否修改，如果修改就会触发</span></span><br><span class="line">    RACSignal * imagAvaibaleSignal = [RACObserve(<span class="keyword">self</span>, <span class="keyword">self</span>.imageView.image) map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">        <span class="keyword">return</span>  value ? @YES : @NO;</span><br><span class="line">    &#125;];    </span><br><span class="line">    [imagAvaibaleSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;xx =%@&quot;</span>,x);</span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="keyword">self</span>.shareBtn.rac_command = [[RACCommand alloc] initWithEnabled:imagAvaibaleSignal signalBlock:^RACSignal *(<span class="keyword">id</span> input) &#123;</span><br><span class="line">        <span class="comment">// do share logic</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;input =%@&quot;</span>,input);</span><br><span class="line">        <span class="keyword">return</span> [RACSignal empty];<span class="comment">// 必须返回一个信号，不能返回nil</span></span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="comment">// 一个command 需要execute 才能触发执行 但是和btn绑定的command不需要</span></span><br><span class="line">    <span class="comment">//  [self.shareBtn.rac_command execute:@&quot;100&quot;];</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="7-token失效"><a href="#7-token失效" class="headerlink" title="7.token失效"></a>7.token失效</h4><p>token 失效后捕获 error，重新请求 token，concat 拼接继续上一次请求</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *requestSignal = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    <span class="comment">// suppose first time send request, access token is expired or invalid</span></span><br><span class="line">    <span class="comment">// and next time it is correct.</span></span><br><span class="line">    <span class="comment">// the block will be triggered twice.</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">BOOL</span> isFirstTime = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">NSString</span> *url = <span class="string">@&quot;http://httpbin.org/ip&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (!isFirstTime) &#123;</span><br><span class="line">        url = <span class="string">@&quot;http://nonexists.com/error&quot;</span>;</span><br><span class="line">        isFirstTime = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;url:%@&quot;</span>, url);</span><br><span class="line">    [[AFHTTPRequestOperationManager manager] GET:url parameters:<span class="literal">nil</span> success:^(AFHTTPRequestOperation *operation, <span class="keyword">id</span> responseObject) &#123;</span><br><span class="line">        [subscriber sendNext:responseObject];</span><br><span class="line">        [subscriber sendCompleted];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;subscriber sendcompleted&quot;</span>);</span><br><span class="line">    &#125; failure:^(AFHTTPRequestOperation *operation, <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;subscriber send error&quot;</span>);</span><br><span class="line">        [subscriber sendError:error];</span><br><span class="line"></span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="keyword">self</span>.labelForName.text = <span class="string">@&quot;sending request...&quot;</span>;</span><br><span class="line"><span class="comment">//Subscribes to the returned signal when an error occurs.</span></span><br><span class="line"></span><br><span class="line">[[requestSignal catch:^RACSignal *(<span class="built_in">NSError</span> *error) &#123;<span class="comment">// requestSignal 发送error 触发 catch&#123;&#125;  catch 中返回的signal 发送next 在subcribeNext接收后，再追加一次requestSignal</span></span><br><span class="line">    <span class="keyword">self</span>.labelForName.text = <span class="string">@&quot;oops, invalid access token&quot;</span>;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;catch ....&quot;</span>);</span><br><span class="line">    <span class="comment">// 模拟获取token的请求，然后concat requestSignal，再次发送之前的请求</span></span><br><span class="line">    <span class="keyword">return</span> [[RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        <span class="keyword">double</span> delayInSeconds = <span class="number">1.0</span>;</span><br><span class="line">        dispatch_time_t popTime = dispatch_time(DISPATCH_TIME_NOW, (int64_t)(delayInSeconds * <span class="built_in">NSEC_PER_SEC</span>));</span><br><span class="line">        dispatch_after(popTime, dispatch_get_main_queue(), ^(<span class="keyword">void</span>)&#123;</span><br><span class="line">            [subscriber sendNext:@YES];</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;subscriber sendNext...&quot;</span>);</span><br><span class="line">            [subscriber sendCompleted];</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;]concat:requestSignal];</span><br><span class="line">&#125;] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;next =%@&quot;</span>,x);</span><br><span class="line">    <span class="keyword">if</span> ([x isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">self</span>.labelForName.text = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;result:%@&quot;</span>, x[<span class="string">@&quot;origin&quot;</span>]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125; completed:^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;completed&quot;</span>);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h4 id="8-Command-登录"><a href="#8-Command-登录" class="headerlink" title="8.Command 登录"></a>8.Command 登录</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.loginCommand = [[RACCommand alloc] initWithSignalBlock:^RACSignal *(<span class="keyword">id</span> input) &#123;</span><br><span class="line">    <span class="comment">//模拟login signal</span></span><br><span class="line">    <span class="keyword">return</span> [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        [subscriber sendNext:<span class="string">@&quot;1000&quot;</span>];</span><br><span class="line">        [subscriber sendCompleted];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// -executionSignals returns a signal that includes the signals returned from</span></span><br><span class="line"><span class="comment">// the above block, one for each time the command is executed.</span></span><br><span class="line">[<span class="keyword">self</span>.loginCommand.executionSignals subscribeNext:^(RACSignal *loginSignal) &#123;</span><br><span class="line">    <span class="comment">// Log a message whenever we log in successfully.</span></span><br><span class="line">    [loginSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;xxx  %@&quot;</span>,x);</span><br><span class="line">    &#125;];</span><br><span class="line">    [loginSignal subscribeCompleted:^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;Logged in successfully!&quot;</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Executes the login command when the button is pressed. 按钮点击触发</span></span><br><span class="line"><span class="keyword">self</span>.shareBtn.rac_command = <span class="keyword">self</span>.loginCommand;</span><br></pre></td></tr></table></figure>

<h4 id="9-搜索框搜索"><a href="#9-搜索框搜索" class="headerlink" title="9.搜索框搜索"></a>9.搜索框搜索</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[[[[[[<span class="keyword">self</span>.textField.rac_textSignal throttle:<span class="number">1</span>]distinctUntilChanged]ignore:<span class="string">@&quot;&quot;</span>] map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;value =%@&quot;</span>,value);</span><br><span class="line">    <span class="keyword">return</span> [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        <span class="comment">//  network request</span></span><br><span class="line">        [subscriber sendNext:value];</span><br><span class="line">        [subscriber sendCompleted];</span><br><span class="line">        <span class="keyword">return</span> [RACDisposable disposableWithBlock:^&#123;</span><br><span class="line">            <span class="comment">//  cancel request</span></span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;] switchToLatest] subscribeNext:^(<span class="keyword">id</span> x) &#123;<span class="comment">// 如果不switchToLastest 则返回一个signal</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;x = %@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h4 id="10-MVVM-RAC"><a href="#10-MVVM-RAC" class="headerlink" title="10.MVVM+RAC"></a>10.MVVM+RAC</h4><p>获取列表数据</p>
<p>在 MVVM 里，网络通信相关的操作都是由 viewModel 来处理的，所以在 ViewModel 里定义一个 RACCommand</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*  获取数据Command</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) RACCommand *fetchProductCommand;</span><br><span class="line"></span><br><span class="line"><span class="comment">//在ViewModel 的 init 方法对它进行初始化</span></span><br><span class="line">_fetchProductCommand = [[RACCommand alloc]initWithSignalBlock:^RACSignal *(<span class="keyword">id</span> input) &#123;</span><br><span class="line">     <span class="keyword">return</span> [[[APIClient sharedClient]</span><br><span class="line">              fetchProductWithPageIndex:@(<span class="number">1</span>)]</span><br><span class="line">              takeUntil:<span class="keyword">self</span>.cancelCommand.executionSignals];</span><br><span class="line"> &#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">//订阅Command，获取数据后赋值给 items</span></span><br><span class="line">@weakify(<span class="keyword">self</span>);</span><br><span class="line">[[_fetchProductCommand.executionSignals switchToLatest] subscribeNext:^(ResponseData *response) &#123;</span><br><span class="line">    @strongify(<span class="keyword">self</span>);</span><br><span class="line">    <span class="keyword">if</span> (!response.success) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.errors sendNext:response.error];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.items = [ProductListModel objectArrayWithKeyValuesArray:response.data];</span><br><span class="line">        <span class="keyword">self</span>.page = response.page;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<p>在 ViewController 里，订阅 ViewModel 的 items，有变化时 reload tableview</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[RACObserve(<span class="keyword">self</span>.viewModel, items) subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">     @strongify(<span class="keyword">self</span>);</span><br><span class="line">     [<span class="keyword">self</span>.table reloadData];</span><br><span class="line"> &#125;];</span><br></pre></td></tr></table></figure>

<p>tableView 的 dataSource</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark - UITableViewDataSource</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSInteger</span>)numberOfSectionsInTableView:(<span class="built_in">UITableView</span> *)tableView &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSInteger</span>)tableView:(<span class="built_in">UITableView</span> *)tableView numberOfRowsInSection:(<span class="built_in">NSInteger</span>)section &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.viewModel.items.count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UITableViewCell</span> *)tableView:(<span class="built_in">UITableView</span> *)tableView cellForRowAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</span><br><span class="line">    ProductListCell *cell = [tableView dequeueReusableCellWithIdentifier:<span class="string">@&quot;ProductListCell&quot;</span> forIndexPath:indexPath];</span><br><span class="line">    cell.viewModel = [<span class="keyword">self</span>.viewModel itemViewModelForIndex:indexPath.row];</span><br><span class="line">    <span class="keyword">return</span> cell;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UITableViewCell 中</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)initWithCoder:(<span class="built_in">NSCoder</span> *)aDecoder &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> initWithCoder:aDecoder];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        @weakify(<span class="keyword">self</span>);</span><br><span class="line">        [RACObserve(<span class="keyword">self</span>, viewModel) subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">            @strongify(<span class="keyword">self</span>);</span><br><span class="line">            <span class="keyword">self</span>.productNameLabel.text = <span class="keyword">self</span>.viewModel.ProductName;</span><br><span class="line">            <span class="keyword">self</span>.bankNameLabel.text = <span class="keyword">self</span>.viewModel.ProductBank;</span><br><span class="line">            <span class="keyword">self</span>.profitLabel.text = <span class="keyword">self</span>.viewModel.ProductProfit;</span><br><span class="line">            <span class="keyword">self</span>.saleStatusLabel.text = <span class="keyword">self</span>.viewModel.SaleStatusCn;</span><br><span class="line">            <span class="keyword">self</span>.productTermLabel.text = <span class="keyword">self</span>.viewModel.ProductTerm;</span><br><span class="line">            <span class="keyword">self</span>.productAmtLabel.text = <span class="keyword">self</span>.viewModel.ProductAmt;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="11-Error"><a href="#11-Error" class="headerlink" title="11.Error"></a>11.Error</h4><p>BaseViewModel</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">BaseViewModel</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) RACSubject *errors;</span><br></pre></td></tr></table></figure>

<p>ViewModel 对 RACCommand 的 errors 进行合并</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[RACSignal merge:@[_fetchProductCommand.errors, <span class="keyword">self</span>.fetchMoreProductCommand.errors]] subscribe:<span class="keyword">self</span>.errors];</span><br></pre></td></tr></table></figure>

<p>RACCommannd 判断是否出现 error</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@weakify(<span class="keyword">self</span>);</span><br><span class="line">[[_fetchProductCommand.executionSignals switchToLatest] subscribeNext:^(ResponseData *response) &#123;</span><br><span class="line">   @strongify(<span class="keyword">self</span>);</span><br><span class="line">   <span class="keyword">if</span> (!response.success) &#123;</span><br><span class="line">       [<span class="keyword">self</span>.errors sendNext:response.error];</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="keyword">self</span>.items = [ProductListModel objectArrayWithKeyValuesArray:response.data];</span><br><span class="line">       <span class="keyword">self</span>.page = response.page;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<p>ViewController 中对 errors 进行订阅 </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[_viewModel.errors subscribeNext:^(<span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">   ResponseData *data = [ResponseData objectWithKeyValues:error.userInfo];</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@&quot;something error:%@&quot;</span>, data.keyValues);</span><br><span class="line">   <span class="comment">//<span class="doctag">TODO:</span> 这里可以选择一种合适的方式将错误信息展示出来</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h4 id="12-http-请求-cancel"><a href="#12-http-请求-cancel" class="headerlink" title="12.http 请求 cancel"></a>12.http 请求 cancel</h4><p>ViewModel 中定义一个表示取消HTTP请求的 RACCommand</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) RACCommand *cancelCommand;</span><br><span class="line"></span><br><span class="line"> _fetchProductCommand = [[RACCommand alloc]initWithSignalBlock:^RACSignal *(<span class="keyword">id</span> input) &#123;</span><br><span class="line">   <span class="keyword">return</span> [[[APIClient sharedClient]</span><br><span class="line">            fetchProductWithPageIndex:@(<span class="number">1</span>)]</span><br><span class="line">            takeUntil:<span class="keyword">self</span>.cancelCommand.executionSignals];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

































<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/manji/p/4846591.html">一次 MVVM+RAC实践</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/e10e5ca413b7">ReactiveCocoa进阶篇</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/20/ReactiveObjC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/20/ReactiveObjC/" class="post-title-link" itemprop="url">ReactiveObjC</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-05-20 14:15:08" itemprop="dateCreated datePublished" datetime="2022-05-20T14:15:08+08:00">2022-05-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-05-11 10:29:59" itemprop="dateModified" datetime="2023-05-11T10:29:59+08:00">2023-05-11</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p> <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/ceebb496c226">RAC资源帖</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/87ef6720a096">ReactiveCocoa基础篇</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/e10e5ca413b7">ReactiveCocoa进阶篇</a></p>
<h4 id="RACSignal"><a href="#RACSignal" class="headerlink" title="RACSignal"></a>RACSignal</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用步骤</span></span><br><span class="line"><span class="comment">// 1.创建信号 + (RACSignal *)createSignal:(RACDisposable * (^)(id&lt;RACSubscriber&gt; subscriber))didSubscribe</span></span><br><span class="line"><span class="comment">// 2.订阅信号,才会激活信号. - (RACDisposable *)subscribeNext:(void (^)(id x))nextBlock</span></span><br><span class="line"><span class="comment">// 3.发送信号 - (void)sendNext:(id)value</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RACSignal底层实现：</span></span><br><span class="line"><span class="comment">// 1.创建信号，首先把didSubscribe保存到信号中，还不会触发。</span></span><br><span class="line"><span class="comment">// 2.当信号被订阅，也就是调用signal的subscribeNext:nextBlock</span></span><br><span class="line"><span class="comment">// 2.2 subscribeNext内部会创建订阅者subscriber，并且把nextBlock保存到subscriber中。</span></span><br><span class="line"><span class="comment">// 2.1 subscribeNext内部会调用siganl的didSubscribe</span></span><br><span class="line"><span class="comment">// 3.siganl的didSubscribe中调用[subscriber sendNext:@1];</span></span><br><span class="line"><span class="comment">// 3.1 sendNext底层其实就是执行subscriber的nextBlock</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.创建信号</span></span><br><span class="line">RACSignal *signal = [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    <span class="comment">// block调用时刻：每当有订阅者订阅信号，就会调用block</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.发送信号</span></span><br><span class="line">    [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果不再发送数据，最好发送信号完成，内部会自动调用[RACDisposable disposable]取消订阅信号</span></span><br><span class="line">    [subscriber sendCompleted];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [RACDisposable disposableWithBlock:^&#123;</span><br><span class="line">        <span class="comment">// block调用时刻：当信号发送完成或者发送错误，就会自动执行这个block,取消订阅信号</span></span><br><span class="line">        <span class="comment">// 执行完Block后，当前信号就不在被订阅了</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;信号被销毁&quot;</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">//3.订阅信号，才会激活信号</span></span><br><span class="line">[signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="comment">//block调用时刻：每当有信号发出数据，就会调用block</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;接收到数据：%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果：</span></span><br><span class="line"><span class="comment">接收到数据：1</span></span><br><span class="line"><span class="comment">信号被销毁</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h4 id="RacSubscribe"><a href="#RacSubscribe" class="headerlink" title="RacSubscribe"></a>RacSubscribe</h4><p>表示订阅者的意思，用于发送信号，这是一个协议，不是一个类，只要遵守了这个协议，并且实现方法才能成为订阅者。通过 create 创建的信号，都有一个订阅者，帮助发送数据</p>
<h4 id="RACDisposable"><a href="#RACDisposable" class="headerlink" title="RACDisposable"></a>RACDisposable</h4><p>用于取消订阅或者清理资源，当信号发送完成或者发送错误的时候，就会自动触发它</p>
<p>使用场景：不想监听某个信号时，可以通过它主动取消订阅信号</p>
<h4 id="RACSubject"><a href="#RACSubject" class="headerlink" title="RACSubject"></a>RACSubject</h4><p>信号提供者，自己可以充当信号，又能发送信号</p>
<p>通常用来代替代理，有了它，就不必要定义代理了</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用步骤</span></span><br><span class="line"><span class="comment">// 1.创建信号 [RACSubject subject]，跟RACSiganl不一样，创建信号时没有block。</span></span><br><span class="line"><span class="comment">// 2.订阅信号 - (RACDisposable *)subscribeNext:(void (^)(id x))nextBlock</span></span><br><span class="line"><span class="comment">// 3.发送信号 sendNext:(id)value</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 底层实现</span></span><br><span class="line"><span class="comment">// RACSubject:底层实现和RACSignal不一样。</span></span><br><span class="line"><span class="comment">// 1.调用subscribeNext订阅信号，只是把订阅者保存起来，并且订阅者的nextBlock已经赋值了。</span></span><br><span class="line"><span class="comment">// 2.调用sendNext发送信号，遍历刚刚保存的所有订阅者，一个一个调用订阅者的nextBlock</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 简单使用</span></span><br><span class="line"><span class="comment">//1.创建信号</span></span><br><span class="line">RACSubject *subject = [RACSubject subject];</span><br><span class="line"><span class="comment">//2.订阅信号</span></span><br><span class="line">[subject subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;第一个订阅者%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line">[subject subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;第二个订阅者%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">//3.发送信号</span></span><br><span class="line">[subject sendNext:<span class="string">@&quot;1&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果</span></span><br><span class="line"><span class="comment">第一个订阅者1</span></span><br><span class="line"><span class="comment">第二个订阅者1</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h5 id="RACSubject-替换代理"><a href="#RACSubject-替换代理" class="headerlink" title="RACSubject 替换代理"></a>RACSubject 替换代理</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 需求:</span></span><br><span class="line"><span class="comment">// 1.给当前控制器添加一个按钮，modal到另一个控制器界面</span></span><br><span class="line"><span class="comment">// 2.另一个控制器view中有个按钮，点击按钮，通知当前控制器</span></span><br><span class="line"></span><br><span class="line">步骤一：在第二个控制器.h，添加一个RACSubject代替代理。</span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TwoViewController</span> : <span class="title">UIViewController</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) RACSubject *delegateSignal;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">步骤二：监听第二个控制器按钮点击</span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TwoViewController</span></span></span><br><span class="line">- (<span class="keyword">IBAction</span>)notice:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">   <span class="comment">// 通知第一个控制器，告诉它，按钮被点了</span></span><br><span class="line">   <span class="comment">// 通知代理</span></span><br><span class="line">   <span class="comment">// 判断代理信号是否有值</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">self</span>.delegateSignal) &#123;</span><br><span class="line">      <span class="comment">// 有值，才需要通知</span></span><br><span class="line">      [<span class="keyword">self</span>.delegateSignal sendNext:<span class="literal">nil</span>];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">步骤三：在第一个控制器中，监听跳转按钮，给第二个控制器的代理信号赋值，并且监听.</span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">OneViewController</span> </span></span><br><span class="line">- (<span class="keyword">IBAction</span>)btnClick:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">  <span class="comment">// 创建第二个控制器</span></span><br><span class="line">  TwoViewController *twoVc = [[TwoViewController alloc] init];</span><br><span class="line">  <span class="comment">// 设置代理信号</span></span><br><span class="line">  twoVc.delegateSignal = [RACSubject subject];</span><br><span class="line">  <span class="comment">// 订阅代理信号</span></span><br><span class="line">  [twoVc.delegateSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">      <span class="built_in">NSLog</span>(<span class="string">@&quot;点击了通知按钮&quot;</span>);</span><br><span class="line">  &#125;];</span><br><span class="line">  <span class="comment">// 跳转到第二个控制器</span></span><br><span class="line">  [<span class="keyword">self</span> presentViewController:twoVc animated:<span class="literal">YES</span> completion:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h4 id="RACReplaySubject"><a href="#RACReplaySubject" class="headerlink" title="RACReplaySubject"></a>RACReplaySubject</h4><p>重复提供信号类，RACSubject 的子类</p>
<p>区别：</p>
<p>RACReplaySubject 可以先发送信号，再订阅信号。RACSubject 就不可以</p>
<p>使用场景：</p>
<p>如果一个信号每被订阅一次，就需要把之前的值重复发送一遍，使用重复提供信号类</p>
<p>可以设置 capacity 数量来限制缓存的 value 的数量，即缓存最新的几个值</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RACReplaySubject使用步骤:</span></span><br><span class="line"><span class="comment">// 1.创建信号 [RACSubject subject]，跟RACSiganl不一样，创建信号时没有block。</span></span><br><span class="line"><span class="comment">// 2.可以先订阅信号，也可以先发送信号。</span></span><br><span class="line"><span class="comment">// 2.1 订阅信号 - (RACDisposable *)subscribeNext:(void (^)(id x))nextBlock</span></span><br><span class="line"><span class="comment">// 2.2 发送信号 sendNext:(id)value</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RACReplaySubject:底层实现和RACSubject不一样。</span></span><br><span class="line"><span class="comment">// 1.调用sendNext发送信号，把值保存起来，然后遍历刚刚保存的所有订阅者，一个一个调用订阅者的nextBlock。</span></span><br><span class="line"><span class="comment">// 2.调用subscribeNext订阅信号，遍历保存的所有值，一个一个调用订阅者的nextBlock</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果想当一个信号被订阅，就重复播放之前所有值，需要先发送信号，在订阅信号。</span></span><br><span class="line"><span class="comment">// 也就是先保存值，在订阅值</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.创建信号</span></span><br><span class="line">RACReplaySubject *replaySubject = [RACReplaySubject subject];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.发送信号</span></span><br><span class="line">[replaySubject sendNext:@<span class="number">1</span>];</span><br><span class="line">[replaySubject sendNext:@<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.订阅信号</span></span><br><span class="line">[replaySubject subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@&quot;第一个订阅者接收到的数据%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 订阅信号</span></span><br><span class="line">[replaySubject subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@&quot;第二个订阅者接收到的数据%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果</span></span><br><span class="line"><span class="comment">第一个订阅者接收到的数据1</span></span><br><span class="line"><span class="comment">第一个订阅者接收到的数据2</span></span><br><span class="line"><span class="comment">第二个订阅者接收到的数据1</span></span><br><span class="line"><span class="comment">第二个订阅者接收到的数据2</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h4 id="RACTuple"><a href="#RACTuple" class="headerlink" title="RACTuple"></a>RACTuple</h4><p>元组类，类似 NSArray，用来包装值</p>
<h4 id="RACSequence"><a href="#RACSequence" class="headerlink" title="RACSequence"></a>RACSequence</h4><p>RAC 中的集合类，用于代替 NSArray，NSDictionary 可以使用它来快速遍历数组和字典</p>
<h5 id="遍历数组"><a href="#遍历数组" class="headerlink" title="遍历数组"></a>遍历数组</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.遍历数组</span></span><br><span class="line"><span class="built_in">NSArray</span> *numbers = @[@<span class="number">1</span>, @<span class="number">2</span>, @<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里其实是三步</span></span><br><span class="line"><span class="comment">// 第一步: 把数组转换成集合RACSequence numbers.rac_sequence</span></span><br><span class="line"><span class="comment">// 第二步: 把集合RACSequence转换RACSignal信号类,numbers.rac_sequence.signal</span></span><br><span class="line"><span class="comment">// 第三步: 订阅信号，激活信号，会自动把集合中的所有值，遍历出来。</span></span><br><span class="line">[numbers.rac_sequence.signal subscribeNext:^(<span class="keyword">id</span>  _Nullable x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">结果</span></span><br><span class="line"><span class="comment">1</span></span><br><span class="line"><span class="comment">2</span></span><br><span class="line"><span class="comment">3</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h5 id="遍历字典"><a href="#遍历字典" class="headerlink" title="遍历字典"></a>遍历字典</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2.遍历字典,遍历出来的键值对会包装成RACTuple(元组对象)</span></span><br><span class="line"><span class="built_in">NSDictionary</span> *dict = @&#123;<span class="string">@&quot;name&quot;</span>: <span class="string">@&quot;jack&quot;</span>, <span class="string">@&quot;age&quot;</span>: @<span class="number">18</span>&#125;;</span><br><span class="line">[dict.rac_sequence.signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">  <span class="comment">// 解包元组，会把元组的值，按顺序给参数里面的变量赋值</span></span><br><span class="line">  RACTupleUnpack(<span class="built_in">NSString</span> *key, <span class="built_in">NSString</span> *value) = x;</span><br><span class="line">  <span class="comment">// 相当于以下写法</span></span><br><span class="line">  <span class="comment">//NSString *key = x[0];</span></span><br><span class="line">  <span class="comment">//NSString *value = x[1];</span></span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ %@&quot;</span>, key, value);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="拼接数组"><a href="#拼接数组" class="headerlink" title="拼接数组"></a>拼接数组</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSArray</span> *arr1 = @[<span class="string">@&quot;1&quot;</span>, <span class="string">@&quot;2”];</span></span><br><span class="line"><span class="string">NSArray *arr2 = @[@&quot;</span><span class="number">3</span><span class="string">&quot;, @&quot;</span><span class="number">4</span><span class="string">&quot;];</span></span><br><span class="line"><span class="string">NSArray *arr3 = @[arr1.rac_sequence, arr2.rac_sequence].rac_sequence.flatten.array;</span></span><br><span class="line"><span class="string">//arr3 两个数组相加 1 2 3 4</span></span><br></pre></td></tr></table></figure>

<h5 id="字典转模型"><a href="#字典转模型" class="headerlink" title="字典转模型"></a>字典转模型</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3.1 OC写法</span></span><br><span class="line"><span class="built_in">NSString</span> *filePath = [[<span class="built_in">NSBundle</span> mainBundle] pathForResource:<span class="string">@&quot;flags.plist&quot;</span> ofType:<span class="literal">nil</span>];</span><br><span class="line"><span class="built_in">NSArray</span> *dictArr = [<span class="built_in">NSArray</span> arrayWithContentsOfFile:filePath];</span><br><span class="line"><span class="built_in">NSMutableArray</span> *items = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSDictionary</span> *dict <span class="keyword">in</span> dictArr) &#123;</span><br><span class="line">    FlagItem *item = [FlagItem flagWithDict:dict];</span><br><span class="line">    [items addObject:item];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.2 RAC写法</span></span><br><span class="line"><span class="built_in">NSString</span> *filePath = [[<span class="built_in">NSBundle</span> mainBundle] pathForResource:<span class="string">@&quot;flags.plist&quot;</span> ofType:<span class="literal">nil</span>];</span><br><span class="line"><span class="built_in">NSArray</span> *dictArr = [<span class="built_in">NSArray</span> arrayWithContentsOfFile:filePath];</span><br><span class="line"><span class="built_in">NSMutableArray</span> *flags = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">_flags = flags;</span><br><span class="line"><span class="comment">// rac_sequence注意点：调用subscribeNext，并不会马上执行nextBlock，而是会等一会。</span></span><br><span class="line">[dictArr.rac_sequence.signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="comment">// 运用RAC遍历字典，x：字典</span></span><br><span class="line">    FlagItem *item = [FlagItem flagWithDict:x];</span><br><span class="line">    [flags addObject:item];</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 3.3 RAC高级写法:</span></span><br><span class="line"><span class="built_in">NSString</span> *filePath = [[<span class="built_in">NSBundle</span> mainBundle] pathForResource:<span class="string">@&quot;flags.plist&quot;</span> ofType:<span class="literal">nil</span>];</span><br><span class="line"><span class="built_in">NSArray</span> *dictArr = [<span class="built_in">NSArray</span> arrayWithContentsOfFile:filePath];</span><br><span class="line"><span class="comment">// map:映射的意思，目的：把原始值value映射成一个新值</span></span><br><span class="line"><span class="comment">// array: 把集合转换成数组</span></span><br><span class="line"><span class="comment">// 底层实现：当信号被订阅，会遍历集合中的原始值，映射成新值，并且保存到新的数组里。</span></span><br><span class="line"><span class="built_in">NSArray</span> *flags = [[dictArr.rac_sequence map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">    <span class="keyword">return</span> [FlagItem flagWithDict:value];</span><br><span class="line">&#125;] array];</span><br></pre></td></tr></table></figure>

<h4 id="RACCommand"><a href="#RACCommand" class="headerlink" title="RACCommand"></a>RACCommand</h4><p>RAC 中用于处理事件的类，可以把事件如何处理，事件中的数据如何传递，包装到这个类中，可以方便的监控事件的整个过程</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一、RACCommand使用步骤:</span></span><br><span class="line"><span class="comment">// 1.创建命令 initWithSignalBlock:(RACSignal * (^)(id input))signalBlock</span></span><br><span class="line"><span class="comment">// 2.在signalBlock中，创建RACSignal，并且作为signalBlock的返回值</span></span><br><span class="line"><span class="comment">// 3.执行命令 - (RACSignal *)execute:(id)input</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 二、RACCommand使用注意:</span></span><br><span class="line"><span class="comment">// 1.signalBlock必须要返回一个信号，不能传nil.</span></span><br><span class="line"><span class="comment">// 2.如果不想要传递信号，直接创建空的信号[RACSignal empty];</span></span><br><span class="line"><span class="comment">// 3.RACCommand中信号如果数据传递完，必须调用[subscriber sendCompleted]，这时命令才会执行完毕，否则永远处于执行中。</span></span><br><span class="line"><span class="comment">// 4.RACCommand需要被强引用，否则接收不到RACCommand中的信号，因此RACCommand中的信号是延迟发送的</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 三、RACCommand设计思想：内部signalBlock为什么要返回一个信号，这个信号有什么用。</span></span><br><span class="line"><span class="comment">// 1.在RAC开发中，通常会把网络请求封装到RACCommand，直接执行某个RACCommand就能发送请求。</span></span><br><span class="line"><span class="comment">// 2.当RACCommand内部请求到数据的时候，需要把请求的数据传递给外界，这时候就需要通过signalBlock返回的信号传递了</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 四、如何拿到RACCommand中返回信号发出的数据。</span></span><br><span class="line"><span class="comment">// 1.RACCommand有个执行信号源executionSignals，这个是signal of signals(信号的信号),意思是信号发出的数据是信号，不是普通的类型。</span></span><br><span class="line"><span class="comment">// 2.订阅executionSignals就能拿到RACCommand中返回的信号，然后订阅signalBlock返回的信号，就能获取发出的值。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 五、监听当前命令是否正在执行executing</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 六、使用场景,监听按钮点击，网络请求</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.创建命令</span></span><br><span class="line">RACCommand *command = [[RACCommand alloc] initWithSignalBlock:^RACSignal * (<span class="keyword">id</span> input) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;执行命令&quot;</span>);</span><br><span class="line">    <span class="comment">// 2.创建信号,用来传递数据</span></span><br><span class="line">    <span class="keyword">return</span> [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        [subscriber sendNext:<span class="string">@&quot;请求数据&quot;</span>];</span><br><span class="line">        <span class="comment">// 注意：数据传递完，最好调用sendCompleted，这时命令才执行完毕</span></span><br><span class="line">        [subscriber sendCompleted];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// 强引用命令，不要被销毁，否则接收不到数据</span></span><br><span class="line">_command = command;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.订阅RACCommand中的信号</span></span><br><span class="line">[command.executionSignals subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    [x subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, x);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// RAC高级用法</span></span><br><span class="line"><span class="comment">// switchToLatest:用于signal of signals，获取signal of signals发出的最新信号,也就是可以直接拿到RACCommand中的信号</span></span><br><span class="line">[command.executionSignals.switchToLatest subscribeNext:^(<span class="keyword">id</span>  _Nullable x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">[[command.executing skip:<span class="number">1</span>] subscribeNext:^(<span class="built_in">NSNumber</span> * x) &#123;</span><br><span class="line">    <span class="keyword">if</span> ([x boolValue] == <span class="literal">YES</span>) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;正在执行&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;执行完成&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.执行命令</span></span><br><span class="line">[command execute:@<span class="number">1</span>];</span><br></pre></td></tr></table></figure>

<p>对 RACCommand 进行错误处理，不应该使用subscribeError: 对 RACCommand 的 executionSignals</p>
<p>进行错误的订阅，因为 executionSignals 这个信号是不会发送error事件的</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[command.errors subscribeNext:^(<span class="built_in">NSError</span> * _Nullable x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;error %@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>



<h4 id="RACMulticastConnection"><a href="#RACMulticastConnection" class="headerlink" title="RACMulticastConnection"></a>RACMulticastConnection</h4><p>用于当一个信号，被多次订阅时，为了保证创建信号时，避免多次调用创建信号中的 block，造成副作用，可以使用这个类型处理</p>
<p>解决重复请求的问题</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// RACMulticastConnection使用步骤:</span></span><br><span class="line"><span class="comment">// 1.创建信号 + (RACSignal *)createSignal:(RACDisposable * (^)(id&lt;RACSubscriber&gt; subscriber))didSubscribe</span></span><br><span class="line"><span class="comment">// 2.创建连接 RACMulticastConnection *connect = [signal publish];</span></span><br><span class="line"><span class="comment">// 3.订阅信号,注意：订阅的不再是之前的信号，而是连接的信号。 [connect.signal subscribeNext:nextBlock]</span></span><br><span class="line"><span class="comment">// 4.连接 [connect connect]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// RACMulticastConnection底层原理:</span></span><br><span class="line"><span class="comment">// 1.创建connect，connect.sourceSignal -&gt; RACSignal(原始信号)  connect.signal -&gt; RACSubject</span></span><br><span class="line"><span class="comment">// 2.订阅connect.signal，会调用RACSubject的subscribeNext，创建订阅者，而且把订阅者保存起来，不会执行block。</span></span><br><span class="line"><span class="comment">// 3.[connect connect]内部会订阅RACSignal(原始信号)，并且订阅者是RACSubject</span></span><br><span class="line"><span class="comment">// 3.1.订阅原始信号，就会调用原始信号中的didSubscribe</span></span><br><span class="line"><span class="comment">// 3.2 didSubscribe，拿到订阅者调用sendNext，其实是调用RACSubject的sendNext</span></span><br><span class="line"><span class="comment">// 4.RACSubject的sendNext,会遍历RACSubject所有订阅者发送信号。</span></span><br><span class="line"><span class="comment">// 4.1 因为刚刚第二步，都是在订阅RACSubject，因此会拿到第二步所有的订阅者，调用他们的nextBlock</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 需求：假设在一个信号中发送请求，每次订阅一次都会发送请求，这样就会导致多次请求。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.创建请求信号</span></span><br><span class="line">RACSignal *signal1 = [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;发送请求&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// 2.订阅信号</span></span><br><span class="line">[signal1 subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;接收数据&quot;</span>);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// 2.订阅信号</span></span><br><span class="line">[signal1 subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;接收数据&quot;</span>);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">运行结果，会执行两遍发送请求，也就是每次订阅都会发送一次请求</span></span><br><span class="line"><span class="comment">发送请求</span></span><br><span class="line"><span class="comment">发送请求</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解决：使用RACMulticastConnection就能解决.</span></span><br><span class="line"><span class="comment">// 1.创建请求信号</span></span><br><span class="line">RACSignal *signal = [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;发送请求&quot;</span>);</span><br><span class="line">    [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">RACMulticastConnection *connect = [signal publish];</span><br><span class="line"><span class="comment">// 2.订阅信号</span></span><br><span class="line">[connect.signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;订阅者一信号%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// 2.订阅信号</span></span><br><span class="line">[connect.signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;订阅者二信号%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line">[connect connect];</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">发送请求</span></span><br><span class="line"><span class="comment">订阅者一信号1</span></span><br><span class="line"><span class="comment">订阅者二信号1</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h4 id="RACScheduler"><a href="#RACScheduler" class="headerlink" title="RACScheduler"></a>RACScheduler</h4><p>RAC 中的队列，用 GCD 封装的</p>
<h4 id="RACUnit"><a href="#RACUnit" class="headerlink" title="RACUnit"></a>RACUnit</h4><p>表示 stream 不包含有意义的值，可以理解为 nil</p>
<h4 id="RACEvent"><a href="#RACEvent" class="headerlink" title="RACEvent"></a>RACEvent</h4><p>把数据包装成信号事件（signal event）</p>
<h4 id="常见用法"><a href="#常见用法" class="headerlink" title="常见用法"></a>常见用法</h4><h5 id="代替代理"><a href="#代替代理" class="headerlink" title="代替代理"></a>代替代理</h5><p>rac_signalForSelector：用于代替代理</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 需求：自定义redView,监听红色view中按钮点击</span></span><br><span class="line"><span class="comment">// 之前都是需要通过代理监听，给红色View添加一个代理属性，点击按钮的时候，通知代理做事情</span></span><br><span class="line"><span class="comment">// rac_signalForSelector:把调用某个对象的方法的信息转换成信号，就要调用这个方法，就会发送信号。</span></span><br><span class="line"><span class="comment">// 这里表示只要redV调用btnClick:,就会发出信号，订阅就好了。</span></span><br><span class="line"></span><br><span class="line">[[redView rac_signalForSelector:<span class="keyword">@selector</span>(btnAction:)] subscribeNext:^(RACTuple *x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;红色按钮点击&quot;</span>);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="keyword">self</span> rac_signalForSelector:<span class="keyword">@selector</span>(scrollViewDidScroll:) fromProtocol:<span class="class"><span class="keyword">@protocol</span>(<span class="title">UIScrollViewDelegate</span>)] <span class="title">subscribeNext</span>:^(<span class="title">RACTuple</span> *<span class="title">tuple</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>



<h5 id="代替KVO"><a href="#代替KVO" class="headerlink" title="代替KVO"></a>代替KVO</h5><p>rac_valuesAndChangesForKeyPath：用于监听某个对象的属性改变</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 把监听redV的center属性改变转换成信号，只要值改变就会发送信号</span></span><br><span class="line"><span class="comment">// observer:可以传入nil</span></span><br><span class="line">[[redView rac_valuesAndChangesForKeyPath:<span class="string">@&quot;center&quot;</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> observer:<span class="literal">nil</span>] subscribeNext:^(RACTwoTuple&lt;<span class="keyword">id</span>,<span class="built_in">NSDictionary</span> *&gt; *x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="监听事件"><a href="#监听事件" class="headerlink" title="监听事件"></a>监听事件</h5><p>rac_signalForControlEvents：用于监听某个事件</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 把按钮点击事件转换为信号，点击按钮，就会发送信号</span></span><br><span class="line">[[<span class="keyword">self</span>.btn rac_signalForControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>] subscribeNext:^(<span class="built_in">UIControl</span> *x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;按钮被点击&quot;</span>);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="代替通知"><a href="#代替通知" class="headerlink" title="代替通知"></a>代替通知</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 把监听到的通知转换信号</span></span><br><span class="line">[[[<span class="built_in">NSNotificationCenter</span> defaultCenter] rac_addObserverForName:<span class="built_in">UIKeyboardWillShowNotification</span> object:<span class="literal">nil</span>] subscribeNext:^(<span class="built_in">NSNotification</span> *x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;键盘弹出&quot;</span>);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="监听文本框文字改变"><a href="#监听文本框文字改变" class="headerlink" title="监听文本框文字改变"></a>监听文本框文字改变</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 5.监听文本框的文字改变</span></span><br><span class="line">[_textField.rac_textSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@&quot;文字改变了%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="多次请求，都获取到数据才展示界面"><a href="#多次请求，都获取到数据才展示界面" class="headerlink" title="多次请求，都获取到数据才展示界面"></a>多次请求，都获取到数据才展示界面</h5><p><code>rac_liftSelector:withSignalsFromArray:Signals</code> ：当传入的Signals(信号数组)，每一个signal都至少sendNext过一次，就会去触发第一个selector参数的方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 6.处理多个请求，都返回结果的时候，统一做处理.</span></span><br><span class="line">RACSignal *request1 = [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:<span class="string">@&quot;发送请求1&quot;</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line">RACSignal *request2 = [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:<span class="string">@&quot;发送请求2&quot;</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// 使用注意：几个信号，参数一的方法就几个参数，每个参数对应信号发出的数据。</span></span><br><span class="line">[<span class="keyword">self</span> rac_liftSelector:<span class="keyword">@selector</span>(updateUIWithR1:r2:) withSignalsFromArray:@[request1, request2]];</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)updateUIWithR1:(<span class="keyword">id</span>)data1 r2:(<span class="keyword">id</span>)data2 &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;更新UI %@ %@&quot;</span>, data1, data2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="常见宏"><a href="#常见宏" class="headerlink" title="常见宏"></a>常见宏</h4><ul>
<li>RAC(TARGET, …)</li>
</ul>
<p>给某个对象绑定属性</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只要文本框文字改变，就会修改label的文字</span></span><br><span class="line">RAC(<span class="keyword">self</span>.labelView,text) = _textField.rac_textSignal;</span><br></pre></td></tr></table></figure>

<ul>
<li>RACObserve(TARGET, KEYPATH)</li>
</ul>
<p>监听某个对象的某个属性，返回的是信号</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[RACObserve(<span class="keyword">self</span>.view, center) subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<ul>
<li>@weakify(Obj)和@strongify(Obj)</li>
</ul>
<p>需要自己手动导入 RACEXTScope.h 才可使用</p>
<ul>
<li>RACTuplePack</li>
</ul>
<p>把数据包装成 RACTuple（元组类）</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RACTuple *tuple = RACTuplePack(@<span class="number">1</span>, @<span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>RACTupleUnpack</li>
</ul>
<p>把 RACTuple（元组类）解包成对应数据</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RACTuple *tuple = RACTuplePack(<span class="string">@&quot;jack&quot;</span>, @<span class="number">20</span>);</span><br><span class="line">RACTupleUnpack(<span class="built_in">NSString</span> *name, <span class="built_in">NSNumber</span> *age) = tuple;</span><br></pre></td></tr></table></figure>

<h4 id="常见操作方法"><a href="#常见操作方法" class="headerlink" title="常见操作方法"></a>常见操作方法</h4><p>RAC开发，应该把重心放在绑定，也就是可以在创建一个对象的时候，就绑定好以后想要做的事情，而不是等赋值之后在去做事情</p>
<p>列如：把数据展示到控件上，之前都是重写控件的setModel方法，用RAC就可以在一开始创建控件的时候，就绑定好数据</p>
<h5 id="映射-flattenMap-Map"><a href="#映射-flattenMap-Map" class="headerlink" title="映射 flattenMap Map"></a>映射 flattenMap Map</h5><p>用于把源信号内容映射成新的内容</p>
<ul>
<li>flattenMap</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// flattenMap作用:把源信号的内容映射成一个新的信号，信号可以是任意类型</span></span><br><span class="line"></span><br><span class="line">[[_textField.rac_textSignal flattenMap:^__kindof RACSignal * (<span class="built_in">NSString</span> *value) &#123;</span><br><span class="line">    <span class="comment">// 返回值：绑定信号的内容.</span></span><br><span class="line">    <span class="keyword">return</span> [RACReturnSignal <span class="keyword">return</span>:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;输出:%@&quot;</span>, value]];</span><br><span class="line">&#125;] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<ul>
<li>Map</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 监听文本框的内容改变，把结构重新映射成一个新值</span></span><br><span class="line"></span><br><span class="line">[[_textField.rac_textSignal map:^<span class="keyword">id</span> (<span class="built_in">NSString</span> * value) &#123;</span><br><span class="line">  	<span class="comment">// 返回值：就是处理完源信号的内容。</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;输出:%@&quot;</span>, value];</span><br><span class="line">&#125;] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<ul>
<li>区别</li>
</ul>
<p>flattenMap 中的 block 返回信号</p>
<p>Map 中的 block 返回对象</p>
<p>signal of signal 用 flattenMap</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">RACSubject *signalOfSignals = [RACSubject subject];</span><br><span class="line">RACSubject *signal = [RACSubject subject];</span><br><span class="line"></span><br><span class="line">[[signalOfSignals flattenMap:^__kindof RACSignal * (<span class="keyword">id</span> value) &#123;</span><br><span class="line">    <span class="comment">// 当signalOfsignals的signals发出信号才会调用</span></span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="comment">// 只有signalOfsignals的signal发出信号才会调用，</span></span><br><span class="line">    <span class="comment">// 因为内部订阅了bindBlock中返回的信号，也就是flattenMap返回的信号。</span></span><br><span class="line">    <span class="comment">// 也就是flattenMap返回的信号发出内容，才会调用。</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@aaa&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// 信号的信号发送信号</span></span><br><span class="line">[signalOfSignals sendNext:signal];</span><br><span class="line"><span class="comment">// 信号发送内容</span></span><br><span class="line">[signal sendNext:@<span class="number">1</span>];</span><br></pre></td></tr></table></figure>

<h5 id="组合-concat"><a href="#组合-concat" class="headerlink" title="组合 concat"></a>组合 concat</h5><p>按一定顺序拼接信号，当多个信号发出的时候，有顺序的接收信号</p>
<p>前面信号发送完成，后面信号才被激活</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *signalA = [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">    [subscriber sendCompleted];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line">RACSignal *signalB = [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt;  subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:@<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// 把signalA拼接到signalB后，signalA发送完成，signalB才会被激活</span></span><br><span class="line">RACSignal *concatSignal = [signalA concat:signalB];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以后只需要面对拼接信号开发。</span></span><br><span class="line"><span class="comment">// 订阅拼接的信号，不需要单独订阅signalA，signalB</span></span><br><span class="line"><span class="comment">// 内部会自动订阅。</span></span><br><span class="line"><span class="comment">// 注意：第一个信号必须发送完成，第二个信号才会被激活</span></span><br><span class="line">[concatSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">1</span></span><br><span class="line"><span class="comment">2</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *concatSignal =  [[signalA concat:signalC] concat:signalB]; </span><br><span class="line"><span class="comment">//或者</span></span><br><span class="line">RACSignal *concatSignal =  [RACSignal concat:@[signalA,signalC,signalB] ];</span><br></pre></td></tr></table></figure>

<h5 id="then"><a href="#then" class="headerlink" title="then"></a>then</h5><p>用于连接两个信号，当第一个信号完成，才会连接 then 返回的信号</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注意使用then，之前信号的值会被忽略掉.</span></span><br><span class="line"><span class="comment">// 底层实现：1、先过滤掉之前的信号发出的值。2.使用concat连接then返回的信号</span></span><br><span class="line">[[[RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">    [subscriber sendCompleted];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;] then:^RACSignal *&#123;</span><br><span class="line">    <span class="keyword">return</span> [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        [subscriber sendNext:@<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="comment">// 只能接收到第二个信号的值，也就是then返回信号的值 2</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="merge"><a href="#merge" class="headerlink" title="merge"></a>merge</h5><p>把多个信号合并为一个信号，任何一个信号有新值的时候就会调用</p>
<p> 一个页面n个请求 拿到哪个数据就显示哪个数据 可以没有顺序</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 底层实现：</span></span><br><span class="line"><span class="comment">// 1.合并信号被订阅的时候，就会遍历所有信号，并且发出这些信号。</span></span><br><span class="line"><span class="comment">// 2.每发出一个信号，这个信号就会被订阅</span></span><br><span class="line"><span class="comment">// 3.也就是合并信号一被订阅，就会订阅里面所有的信号。</span></span><br><span class="line"><span class="comment">// 4.只要有一个信号被发出就会被监听</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *signalA = [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line">RACSignal *signalB = [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt;  subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:@<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// 合并信号,任何一个信号发送数据，都能监听到</span></span><br><span class="line">RACSignal *mergeSignal = [signalA merge:signalB];</span><br><span class="line"></span><br><span class="line">[mergeSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="zipWith"><a href="#zipWith" class="headerlink" title="zipWith"></a>zipWith</h5><p>把两个信号压缩成一个信号，只有当两个信号同时发出信号内容时，并且把两个信号的内容合并成一个元组，才会触发压缩流的 next 事件</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 底层实现:</span></span><br><span class="line"><span class="comment">// 1.定义压缩信号，内部就会自动订阅signalA，signalB</span></span><br><span class="line"><span class="comment">// 2.每当signalA或者signalB发出信号，就会判断signalA，signalB有没有发出个信号，有就会把最近发出的信号都包装成元组发出</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *signalA = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">   [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">RACSignal *signalB = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">   [subscriber sendNext:@<span class="number">2</span>];</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 压缩信号A，信号B</span></span><br><span class="line">RACSignal *zipSignal = [signalA zipWith:signalB];</span><br><span class="line">[zipSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">&lt;RACTwoTuple:0xxx&gt;(1,2)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h5 id="combineLatest"><a href="#combineLatest" class="headerlink" title="combineLatest"></a>combineLatest</h5><p>将多个信号合并起来，并且拿到各个信号的最新值，必须每个合并的 signal 至少都有过一次 sendNext，才会触发合并的信号</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 底层实现：</span></span><br><span class="line"><span class="comment">// 1.当组合信号被订阅，内部会自动订阅signalA，signalB,必须两个信号都发出内容，才会被触发。</span></span><br><span class="line"><span class="comment">// 2.并且把两个信号组合成元组发出。</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *signalA = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">   [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">RACSignal *signalB = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">   [subscriber sendNext:@<span class="number">2</span>];</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 把两个信号组合成一个信号,跟zip一样，没什么区别</span></span><br><span class="line">RACSignal *combineSignal = [signalA combineLatest:signalB];</span><br><span class="line">[combineSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">&lt;RACTwoTuple:0xxx&gt;(1,2)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h5 id="reduce"><a href="#reduce" class="headerlink" title="reduce"></a>reduce</h5><p>用于信号发出的内容是元组，把信号发出元组的值聚合成一个值</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *signalA = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">   [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line">RACSignal *signalB = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">   [subscriber sendNext:@<span class="number">2</span>];</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 聚合</span></span><br><span class="line"><span class="comment">// 常见的用法，（先组合在聚合）。combineLatest:(id&lt;NSFastEnumeration&gt;)signals reduce:(id (^)())reduceBlock</span></span><br><span class="line"><span class="comment">// reduce中的block简介:</span></span><br><span class="line"><span class="comment">// reduceblcok中的参数，有多少信号组合，reduceblcok就有多少参数，每个参数就是之前信号发出的内容</span></span><br><span class="line"><span class="comment">// reduceblcok的返回值：聚合信号之后的内容</span></span><br><span class="line">RACSignal *reduceSignal = [RACSignal combineLatest:@[signalA, signalB] reduce:^<span class="keyword">id</span>(<span class="built_in">NSNumber</span> *num1 ,<span class="built_in">NSNumber</span> *num2)&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;%@ %@&quot;</span>,num1,num2];</span><br><span class="line">&#125;];</span><br><span class="line">[reduceSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="过滤-filter"><a href="#过滤-filter" class="headerlink" title="过滤 filter"></a>过滤 filter</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 每次信号发出，会先执行过滤条件判断.</span></span><br><span class="line">[_textField.rac_textSignal filter:^<span class="built_in">BOOL</span>(<span class="built_in">NSString</span> *value) &#123;</span><br><span class="line">    <span class="keyword">return</span> value.length &gt; <span class="number">3</span>;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="ignore"><a href="#ignore" class="headerlink" title="ignore"></a>ignore</h5><p>忽略完某些值的信号</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 内部调用filter过滤，忽略掉ignore的值</span></span><br><span class="line">[[_textField.rac_textSignal ignore:<span class="string">@&quot;1&quot;</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="startWith"><a href="#startWith" class="headerlink" title="startWith"></a>startWith</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//在开始前添加数据 打印 hello world 1 2 3 4</span></span><br><span class="line">RACSignal *signal = @[@<span class="number">1</span>,@<span class="number">2</span>,@<span class="number">3</span>,@<span class="number">4</span>].rac_sequence.signal;</span><br><span class="line">RACSignal *signal2 = [signal startWith:<span class="string">@&quot;hello world&quot;</span>];</span><br><span class="line">[signal2 subscribeNext:^(<span class="keyword">id</span>  _Nullable x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="distinctUntilChanged"><a href="#distinctUntilChanged" class="headerlink" title="distinctUntilChanged"></a>distinctUntilChanged</h5><p>当上一次的值和当前的值有明显变化就会发出信号，否则被忽略掉</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 过滤，当上一次和当前的值不一样，就会发出内容。</span></span><br><span class="line"><span class="comment">// 在开发中，刷新UI经常使用，只有两次数据不一样才需要刷新</span></span><br><span class="line">[[_textField.rac_textSignal distinctUntilChanged] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="take"><a href="#take" class="headerlink" title="take"></a>take</h5><p>从开始一共取 N 次的信号</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1、创建信号</span></span><br><span class="line">RACSubject *signal = [RACSubject subject];</span><br><span class="line"><span class="comment">// 2、处理信号，订阅信号</span></span><br><span class="line">[[signal take:<span class="number">1</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.发送信号</span></span><br><span class="line">[signal sendNext:@<span class="number">1</span>];</span><br><span class="line">[signal sendNext:@<span class="number">2</span>];</span><br></pre></td></tr></table></figure>

<h5 id="takeLast"><a href="#takeLast" class="headerlink" title="takeLast"></a>takeLast</h5><p>取最后 N 次的信号，前提条件，订阅者必须调用完成</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1、创建信号</span></span><br><span class="line">RACSubject *signal = [RACSubject subject];</span><br><span class="line"><span class="comment">// 2、处理信号，订阅信号</span></span><br><span class="line">[[signal takeLast:<span class="number">1</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.发送信号</span></span><br><span class="line">[signal sendNext:@<span class="number">1</span>];</span><br><span class="line">[signal sendNext:@<span class="number">2</span>];</span><br><span class="line">[signal sendCompleted];</span><br></pre></td></tr></table></figure>

<h5 id="takeUntil"><a href="#takeUntil" class="headerlink" title="takeUntil"></a>takeUntil</h5><p>获取信号值直到某个信号执行完成</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 监听文本框的改变直到当前对象被销毁</span></span><br><span class="line">[_textField.rac_textSignal takeUntil:<span class="keyword">self</span>.rac_willDeallocSignal];</span><br></pre></td></tr></table></figure>

<h5 id="skip"><a href="#skip" class="headerlink" title="skip"></a>skip</h5><p>跳过几个信号</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 表示输入第一次，不会被监听到，跳过第一次发出的信号</span></span><br><span class="line">[[_textField.rac_textSignal skip:<span class="number">1</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="switchToLatest"><a href="#switchToLatest" class="headerlink" title="switchToLatest"></a>switchToLatest</h5><p>用于 signalOfSignals（信号的信号），有时候信号也会发出信号，获取 signalOfSignals 发送的最新信号</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">RACSubject *signalOfSignals = [RACSubject subject];</span><br><span class="line">RACSubject *signal = [RACSubject subject];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取信号中信号最近发出信号，订阅最近发出的信号。</span></span><br><span class="line"><span class="comment">// 注意switchToLatest：只能用于信号中的信号</span></span><br><span class="line">[signalOfSignals.switchToLatest subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line">[signalOfSignals sendNext:signal];</span><br><span class="line">[signal sendNext:@<span class="number">1</span>];</span><br></pre></td></tr></table></figure>

<h5 id="ifThenElse"><a href="#ifThenElse" class="headerlink" title="ifThenElse"></a>ifThenElse</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *signalA = @[@<span class="number">1</span>, @<span class="number">2</span>, @<span class="number">3</span>].rac_sequence.signal;</span><br><span class="line">RACSignal *signalB = @[<span class="string">@&quot;a&quot;</span>, <span class="string">@&quot;b&quot;</span>, <span class="string">@&quot;c&quot;</span>].rac_sequence.signal;</span><br><span class="line">RACSubject *subject = [RACSubject subject];</span><br><span class="line">[[RACSignal <span class="keyword">if</span>:subject then:signalA <span class="keyword">else</span>:signalB] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line">[subject sendNext:@<span class="number">1</span>];</span><br><span class="line">dispatch_after(dispatch_time(DISPATCH_TIME_NOW, <span class="number">2</span>), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">    [subject sendNext:@<span class="number">0</span>];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h5 id="doNext，doCompleted"><a href="#doNext，doCompleted" class="headerlink" title="doNext，doCompleted"></a>doNext，doCompleted</h5><p>doNext 执行 Next 之前，会先执行这个 block</p>
<p>doCompleted 执行 sendCompleted 之前，会先执行这个 block</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> [[[[RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">    [subscriber sendCompleted];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;] doNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;doNext&quot;</span>);</span><br><span class="line">&#125;] doCompleted:^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;doCompleted&quot;</span>);</span><br><span class="line">&#125;] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">doNext</span></span><br><span class="line"><span class="comment">1</span></span><br><span class="line"><span class="comment">doCompleted</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h5 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h5><p>deliverOn：内容传递切换到指定线程中，副作用在原来线程中，把在创建信号时 block 中的代码称之为副作用</p>
<p>subscribeOn：内容传递和副作用都会切换到指定线程中</p>
<h5 id="timeout"><a href="#timeout" class="headerlink" title="timeout"></a>timeout</h5><p>超时，让一个信号在一定时间后自动报错</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *signal = [[RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;] timeout:<span class="number">1</span> onScheduler:[RACScheduler currentScheduler]];</span><br><span class="line"></span><br><span class="line">[signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125; error:^(<span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">    <span class="comment">// 1秒后会自动调用</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,error);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="interval"><a href="#interval" class="headerlink" title="interval"></a>interval</h5><p>定时，每隔一段时间发出信号</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[[RACSignal interval:<span class="number">1</span> onScheduler:[RACScheduler currentScheduler]] subscribeNext:^(<span class="keyword">id</span> x) &#123;   </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="delay"><a href="#delay" class="headerlink" title="delay"></a>delay</h5><p>延迟发送 next</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *signal = [[[RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;] delay:<span class="number">2</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="retry"><a href="#retry" class="headerlink" title="retry"></a>retry</h5><p>重试，只要失败，就会重新执行创建信号中的 block，直到成功</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">__block <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">[[[RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">  <span class="keyword">if</span> (i == <span class="number">10</span>) &#123;</span><br><span class="line">      [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="built_in">NSLog</span>(<span class="string">@&quot;接收到错误&quot;</span>);</span><br><span class="line">      [subscriber sendError:<span class="literal">nil</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  i++;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;] retry] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125; error:^(<span class="built_in">NSError</span> *error) &#123;</span><br><span class="line"></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="replay"><a href="#replay" class="headerlink" title="replay"></a>replay</h5><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zz-vv/p/4834042.html">replay、replayLast、replayLazily</a></p>
<p>对于普通的信号，每次订阅都会导致信号中的代码被执行一遍（block中的代码）</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">__block <span class="keyword">int</span> num = <span class="number">0</span>;</span><br><span class="line">RACSignal *signal = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    num ++;</span><br><span class="line">    [subscriber sendNext:@(num)];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line">[signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;s1:%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line">[signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;s2:%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line">[signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;s3:%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">s1:1</span></span><br><span class="line"><span class="comment">s2:2</span></span><br><span class="line"><span class="comment">s3:3</span></span><br><span class="line"><span class="comment">block 中的代码被执行了3次</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>replay 返回一个新的信号，源信号被订阅时，会立即发送订阅者全部历史的值，不会重复执行源信号中的订阅代码，订阅者还将接收未来发送过去的值</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//演示：每个新添加的订阅者接收到信号中全部的值（不管之前还是将来发出的值）</span></span><br><span class="line">RACSubject *letters = [RACSubject subject];</span><br><span class="line">RACSignal *signal = [letters replay]; </span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;Subscribe S1&quot;</span>);</span><br><span class="line">[signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;S1: %@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;Send A&quot;</span>);</span><br><span class="line">[letters sendNext:<span class="string">@&quot;A&quot;</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;Send B&quot;</span>);</span><br><span class="line">[letters sendNext:<span class="string">@&quot;B&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;Subscribe S2&quot;</span>);</span><br><span class="line">[signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;S2: %@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;Send C&quot;</span>);</span><br><span class="line">[letters sendNext:<span class="string">@&quot;C&quot;</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;Send D&quot;</span>);</span><br><span class="line">[letters sendNext:<span class="string">@&quot;D&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;Subscribe S3&quot;</span>);</span><br><span class="line">[signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;S3: %@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Subscribe S1   </span></span><br><span class="line"><span class="comment">Send A   </span></span><br><span class="line"><span class="comment">S1: A</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">Send B</span></span><br><span class="line"><span class="comment">S1: B</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">Subscribe S2</span></span><br><span class="line"><span class="comment">S2: A</span></span><br><span class="line"><span class="comment">S2: B //发送历史值</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">Send C</span></span><br><span class="line"><span class="comment">S1: C</span></span><br><span class="line"><span class="comment">S2: C</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">Send D</span></span><br><span class="line"><span class="comment">S1: D</span></span><br><span class="line"><span class="comment">S2: D</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">Subscribe S3</span></span><br><span class="line"><span class="comment">S3: A</span></span><br><span class="line"><span class="comment">S3: B</span></span><br><span class="line"><span class="comment">S3: C</span></span><br><span class="line"><span class="comment">S3: D //发送历史值</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h5 id="replayLast"><a href="#replayLast" class="headerlink" title="replayLast"></a>replayLast</h5><p>返回一个新的信号，源信号被订阅时，会立即发送给订阅者最新的值，不会重复执行源信号中的订阅代码，订阅者还将接收未来发送过去的值</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Subscribe S1</span><br><span class="line">Send A</span><br><span class="line">S1: A</span><br><span class="line"> </span><br><span class="line">Send B</span><br><span class="line">S1: B</span><br><span class="line"> </span><br><span class="line">Subscribe S2</span><br><span class="line">S2: B <span class="comment">//接收最新值</span></span><br><span class="line"> </span><br><span class="line">Send C</span><br><span class="line">S1: C</span><br><span class="line">S2: C</span><br><span class="line"> </span><br><span class="line">Send D</span><br><span class="line">S1: D</span><br><span class="line">S2: D</span><br><span class="line"> </span><br><span class="line">Subscribe S3</span><br><span class="line">S3: D</span><br></pre></td></tr></table></figure>





<h5 id="throttle"><a href="#throttle" class="headerlink" title="throttle"></a>throttle</h5><p>当某个信号发送比较频繁时，可以使用节流，在某一段时间不发送信号内容，过了一段时间获取信号的最新内容发出</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">RACSubject *signal = [RACSubject subject];</span><br><span class="line">_signal = signal;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 节流，在一定时间（1秒）内，不接收任何信号内容，过了这个时间（1秒）获取最后发送的信号内容发出。</span></span><br><span class="line">[[signal throttle:<span class="number">1</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>





      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/06/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-6%E5%BC%82%E6%AD%A5%E7%88%AC%E8%99%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/06/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-6%E5%BC%82%E6%AD%A5%E7%88%AC%E8%99%AB/" class="post-title-link" itemprop="url">Python3网络爬虫开发实战-6异步爬虫</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-05-06 22:57:27" itemprop="dateCreated datePublished" datetime="2022-05-06T22:57:27+08:00">2022-05-06</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-07-12 11:19:39" itemprop="dateModified" datetime="2023-07-12T11:19:39+08:00">2023-07-12</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>使用协程来实现异步操作，如在爬虫场景下，发出一个请求后，需要等待一定时间才能得到响应，在这等待过程中，程序可以干许多其他事情，得到响应之后再切换回来继续处理，这样可以充分利用CPU和其他资源</p>
<ul>
<li>event_loop：事件循环，相当于一个无限循环，可以把一些函数注册到这个事件循环上，当满足发生条件的时候，就调用对应的处理方法</li>
<li>coroutine：协程，可以将协程对象注册到事件循环中，它会被事件循环调用。可以使用 async 关键字来定义一个方法，这个方法在调用时不会立即被执行，而是会返回一个协程对象</li>
<li>task：任务，这是对协程对象的进一步封装，包含协程对象的各个状态</li>
<li>future：代表将来执行或者没有执行的任务的结果，实际上和 task 没有本质的区别</li>
</ul>
<h4 id="定义协程"><a href="#定义协程" class="headerlink" title="定义协程"></a>定义协程</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">execute</span>(<span class="params">x</span>):</span></span><br><span class="line">    print(<span class="string">&#x27;Number&#x27;</span>, x)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    print(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    coroutine = execute(<span class="number">1</span>) <span class="comment">#方法没有立即执行，返回协程对象</span></span><br><span class="line">    print(<span class="string">&#x27;After calling execute&#x27;</span>)</span><br><span class="line">    loop = asyncio.get_event_loop() <span class="comment">#创建事件循环</span></span><br><span class="line">    loop.run_until_complete(coroutine)<span class="comment">#将协程对象注册到事件循环</span></span><br><span class="line">    print(<span class="string">&#x27;After calling loop&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">After calling execute</span></span><br><span class="line"><span class="string">Number 1</span></span><br><span class="line"><span class="string">After calling loop</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>引入 asyncio 包，这样才能使用 async 和 await 关键字</p>
<p>直接调用 execute 方法并没有立即执行，而是返回一个协程对象</p>
<p>之后调用 get_event_loop 方法创建一个事件循环 loop，调用 loop 对象的 run_until_complete 方法将协程对象注册到事件循环中，接着启动</p>
<p>async 定义的方法会变成一个无法直接执行的协程对象，必须将此对象注册到事件循环中才可以执行</p>
<p>前面提到 task 是对协程的进一步封装，比协程多了运行状态，如 running、finished，可以利用这些状态获取协程执行情况</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">coroutine = execute(<span class="number">1</span>)</span><br><span class="line">print(<span class="string">&#x27;After calling execute&#x27;</span>)</span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">task = loop.create_task(coroutine) <span class="comment">#将协程对象转化为task对象！</span></span><br><span class="line">print(<span class="string">&#x27;Task:&#x27;</span>, task)</span><br><span class="line">loop.run_until_complete(task)</span><br><span class="line">print(<span class="string">&#x27;Task:&#x27;</span>, task)</span><br><span class="line">print(<span class="string">&#x27;After calling loop&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">After calling execute</span></span><br><span class="line"><span class="string">Task: &lt;Task pending name=&#x27;Task-1&#x27; coro=&lt;execute() running at xxx&gt;&gt;</span></span><br><span class="line"><span class="string">Number 1</span></span><br><span class="line"><span class="string">Task: &lt;Task finished name=&#x27;Task-1&#x27; coro=&lt;execute() done, defined at xxx&gt;</span></span><br><span class="line"><span class="string">After calling loop</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>定义 task 的另一种方式，直接调用 asyncio 包的 ensure_future 方法，返回也是 task 对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">task = asyncio.ensure_future(coroutine)</span><br><span class="line">loop.run_until_complete(task)</span><br></pre></td></tr></table></figure>

<h4 id="绑定回调"><a href="#绑定回调" class="headerlink" title="绑定回调"></a>绑定回调</h4><p>为某个 task 对象绑定一个回调方法    </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">request</span>():</span></span><br><span class="line">    url = <span class="string">&#x27;https://www.baidu.com&#x27;</span></span><br><span class="line">    status = requests.get(url)</span><br><span class="line">    <span class="keyword">return</span> status</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">callback</span>(<span class="params">task</span>):</span></span><br><span class="line">    print(<span class="string">&#x27;Status:&#x27;</span>, task.result())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    print(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    coroutine = request()</span><br><span class="line">    task = asyncio.ensure_future(coroutine)<span class="comment">#定义task</span></span><br><span class="line">    task.add_done_callback(callback) <span class="comment">#回调方法</span></span><br><span class="line">    print(<span class="string">&#x27;Task:&#x27;</span>, task)</span><br><span class="line"></span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    loop.run_until_complete(task)<span class="comment">#注册到事件循环才能执行</span></span><br><span class="line">    print(<span class="string">&#x27;Task:&#x27;</span>, task)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Task: &lt;Task pending name=&#x27;Task-1&#x27; coro=&lt;request() running at xxx cb=[callback() xx&gt;</span></span><br><span class="line"><span class="string">Status: &lt;Response [200]&gt;</span></span><br><span class="line"><span class="string">Task: &lt;Task finished name=&#x27;Task-1&#x27; coro=&lt;request() done, defined at xx result=&lt;Response [200]&gt;&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>task 执行完毕后，就可以调用 callback 方法了，同时 task 对象还会作为参数传递给 callback 方法，调用 task 对象的 result 方法就可以获取返回结果</p>
<p>这里即使不使用回调方法，在 task 运行完毕后，也可直接调用 task.result() 方法获取结果</p>
<h4 id="多任务协程"><a href="#多任务协程" class="headerlink" title="多任务协程"></a>多任务协程</h4><p>如果想执行多次请求，使用 asyncio 包中的 wait 方法执行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tasks = [asyncio.ensure_future(request()) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)]</span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">loop.run_until_complete(asyncio.wait(tasks))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> task <span class="keyword">in</span> tasks:</span><br><span class="line">    print(<span class="string">&#x27;Task Result:&#x27;</span>, task.result())</span><br><span class="line"><span class="comment">#5个任务被顺次执行</span></span><br></pre></td></tr></table></figure>

<p>这里 for 循环创建 5 个 task，组成一个列表，列表先传给 asyncio 包的 wait 方法，再将其注册到事件循环，就可以发起 5 哥任务了</p>
<h4 id="协程实现"><a href="#协程实现" class="headerlink" title="协程实现"></a>协程实现</h4><p>当遇到需要等待的情况时，程序可以暂时挂起，转而执行其他操作，从而避免因一直等待一个程序而耗费过多的时间，能够充分利用资源</p>
<p>要实现异步处理，先得有挂起操作，当一个任务需要等待 IO 结果的时候，可以挂起当前任务，转而执行其它任务</p>
<ul>
<li>await 关键字</li>
</ul>
<p>可以将耗时等待的操作挂起，让出控制权。如果协程在执行的时候遇到 await，事件循环就会将协程挂起，转而执行别的协程，直到其它协程挂起或执行完毕</p>
<ul>
<li>await 后面的对象必须是如下格式之一：</li>
</ul>
<p>一个原生的协程对象；</p>
<p>一个由 types.coroutine修饰的生成器，这个生成器可以返回协程对象；</p>
<p>一个包含 <code>__await__</code> 方法的对象返回一个迭代器</p>
<h4 id="使用-aiohttp"><a href="#使用-aiohttp" class="headerlink" title="使用 aiohttp"></a>使用 aiohttp</h4><p>aiohttp 是一个支持异步请求的库，和 asyncio 配合使用，可以非常方便的实现异步请求操作</p>
<p>官方文档链接 <a target="_blank" rel="noopener" href="https://aiohttp.readthedocs.io/">https://aiohttp.readthedocs.io/</a> </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">url</span>):</span></span><br><span class="line">    session = aiohttp.ClientSession()</span><br><span class="line">    response = <span class="keyword">await</span> session.get(url)</span><br><span class="line">    <span class="keyword">await</span> response.text()</span><br><span class="line">    <span class="keyword">await</span> session.close()</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">request</span>():</span></span><br><span class="line">    url = <span class="string">&#x27;https://www.baidu.com&#x27;</span></span><br><span class="line">    print(<span class="string">&#x27;waiting for&#x27;</span>, url)</span><br><span class="line">    response = <span class="keyword">await</span> get(url)</span><br><span class="line">    print(<span class="string">&#x27;get response from&#x27;</span>, url, <span class="string">&#x27;response:&#x27;</span>, response)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  tasks = [asyncio.ensure_future(request()) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)]</span><br><span class="line">  loop = asyncio.get_event_loop()</span><br><span class="line">  loop.run_until_complete(asyncio.wait(tasks))</span><br></pre></td></tr></table></figure>

<p>当遇到阻塞式操作（await）时，task 被挂起，事件循环会寻找当前未被挂起的协程继续执行，到第10个task，全部 task 都被挂起了，只好等待，请求5秒后几个请求几乎同时有了响应，然后几个 task 也被唤醒接着执行，并输出结果</p>
<h4 id="aiohttp-的使用"><a href="#aiohttp-的使用" class="headerlink" title="aiohttp 的使用"></a>aiohttp 的使用</h4><p>aiohttp 官方文档 <a target="_blank" rel="noopener" href="https://docs.aiohtto.org/">https://docs.aiohtto.org</a></p>
<p>aiohttp 是一个基于 asyncio 的异步 HTTP 网络模块，既提供了服务端，又提供了客户端。用服务端可以搭建一个支持异步处理的服务器，这个服务器就是用来处理请求并返回响应的，类似 Django、Flask、Tornado 等一些 Web 服务器。而客户端可以用来发起请求</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"></span><br><span class="line"><span class="comment">#每个异步方法前都需要加 async 来修饰</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">fetch</span>(<span class="params">session, url</span>):</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> response:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> response.text(), response.status</span><br><span class="line"><span class="comment">#response.text()返回协程需要加await</span></span><br><span class="line">      </span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        html, status = <span class="keyword">await</span> fetch(session, <span class="string">&#x27;https://cuiqingcai.com&#x27;</span>)</span><br><span class="line">        print(<span class="string">f&#x27;html:<span class="subst">&#123;html[:<span class="number">100</span>]&#125;</span>...&#x27;</span>)</span><br><span class="line">        print(<span class="string">f&#x27;status: <span class="subst">&#123;status&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    loop.run_until_complete(main())</span><br></pre></td></tr></table></figure>

<p>with as 前同样需要 async 来修饰，python 中，with as 语句用于声明一个上下文管理器，能够帮我们自动分配和释放资源，<u>异步方法中，with as 前加 async 代表声明一个支持异步的上下文管理器</u></p>
<p>对于一些返回协程的操作，前面需要加 await 来修饰。返回的是协程对象，前面就要加 await，response 调用 text 方法返回的是协程对象，前面需要加 awiat，而状态码返回的就是一个数值，不需要加 await，看对应返回类型决定加不加 await</p>
<p>Python 3.7 后可以使用 <code>asyncio.run(main())</code> 代替最后的启动操作，不需要显式声明事件循环，run 方法内部会自动启动一个事件循环</p>
<h5 id="URL-参数设置"><a href="#URL-参数设置" class="headerlink" title="URL 参数设置"></a>URL 参数设置</h5><p>参数设置借助 params 参数，传入字典</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    params = &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;germey&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">25</span>&#125;</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> session.get(<span class="string">&#x27;https://www.httpbin.org/get&#x27;</span>, params=params) <span class="keyword">as</span> response:</span><br><span class="line">            print(<span class="keyword">await</span> response.text())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    asyncio.get_event_loop().run_until_complete(main())</span><br></pre></td></tr></table></figure>

<h5 id="其它请求类型"><a href="#其它请求类型" class="headerlink" title="其它请求类型"></a>其它请求类型</h5><p>aiohttp 还支持其它请求类型，POST、PUT、DELETE 等</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">session.post(<span class="string">&#x27;http://xxx&#x27;</span>, data=<span class="string">b&#x27;data&#x27;</span>)</span><br><span class="line">session.put(<span class="string">&#x27;http://xxx&#x27;</span>)</span><br><span class="line">session.delete(<span class="string">&#x27;http://xxx&#x27;</span>)</span><br><span class="line">session.options(<span class="string">&#x27;http://xxx&#x27;</span>)</span><br><span class="line">session.head(<span class="string">&#x27;http://xxx&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="POST-请求"><a href="#POST-请求" class="headerlink" title="POST 请求"></a>POST 请求</h5><p>对于 POST 表单提交 Content-Type 为 application/x-www-form-urlencoded</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">data = &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;germey&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">25</span>&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">with</span> session.post(<span class="string">&#x27;https://www.httpbin.org/post&#x27;</span>, data=data) <span class="keyword">as</span> response:</span><br></pre></td></tr></table></figure>

<p>对于 POST JSON，Content-Type 为 application/json</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">data = &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;germey&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">25</span>&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">with</span> session.post(<span class="string">&#x27;https://www.httpbin.org/post&#x27;</span>, json=data) <span class="keyword">as</span> response:</span><br></pre></td></tr></table></figure>

<h5 id="响应"><a href="#响应" class="headerlink" title="响应"></a>响应</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">print(<span class="string">&#x27;status:&#x27;</span>, response.status)</span><br><span class="line">print(<span class="string">&#x27;headers:&#x27;</span>, response.headers)</span><br><span class="line">print(<span class="string">&#x27;body:&#x27;</span>, <span class="keyword">await</span> response.text())</span><br><span class="line">print(<span class="string">&#x27;bytes:&#x27;</span>, <span class="keyword">await</span> response.read())</span><br><span class="line">print(<span class="string">&#x27;json:&#x27;</span>, <span class="keyword">await</span> response.json())</span><br></pre></td></tr></table></figure>

<p>返回的是一个协程对象需要加 await。具体查看 aiohttp 的 API</p>
<p>链接 <a target="_blank" rel="noopener" href="https://docs.aiohttp.org/en/stable/client_reference.html">https://docs.aiohttp.org/en/stable/client_reference.html</a></p>
<h5 id="超时设置"><a href="#超时设置" class="headerlink" title="超时设置"></a>超时设置</h5><p>借助 ClientTimeout 对象设置超时，例如设置 1 秒的超时时间，超时会抛出 TimeoutError 异常，类型为 asyncio.TimeoutError</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    data = &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;germey&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">25</span>&#125;</span><br><span class="line">    timeout = aiohttp.ClientTimeout(total=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession(timeout=timeout) <span class="keyword">as</span> session:</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>ClientTimeout 还有其他参数，connect、socket_connect 等</p>
<p><a target="_blank" rel="noopener" href="https://docs.aiohttp.org/en/stable/client_quickstart.html#timeouts">https://docs.aiohttp.org/en/stable/client_quickstart.html#timeouts</a></p>
<h5 id="并发限制"><a href="#并发限制" class="headerlink" title="并发限制"></a>并发限制</h5><p>asyncio 的 Semaphore 来控制并发量</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">CONCURRENCY = <span class="number">5</span></span><br><span class="line">URL = <span class="string">&#x27;https://www.baidu.com&#x27;</span></span><br><span class="line"></span><br><span class="line">semaphore = asyncio.Semaphore(CONCURRENCY) <span class="comment">#创建信号量对象</span></span><br><span class="line">session = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">scripe_api</span>():</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> semaphore:<span class="comment">#1</span></span><br><span class="line">        print(<span class="string">&#x27;scrapping:&#x27;</span>, URL)</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> session.get(URL) <span class="keyword">as</span> response:</span><br><span class="line">            <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> response.text()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="keyword">global</span> session;</span><br><span class="line">    session = aiohttp.ClientSession()</span><br><span class="line">    scripe_index_tasks = [asyncio.ensure_future(scripe_api()) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>)]</span><br><span class="line">    <span class="keyword">await</span> asyncio.gather(*scripe_index_tasks)<span class="comment">#2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    asyncio.get_event_loop().run_until_complete(main())</span><br></pre></td></tr></table></figure>

<p>创建信号量对象</p>
<p>使用：把 semaphore 直接放置在对应的爬取方法里，使用 async with 语句将 semaphore 作为上下文对象即可。这样信号量便可以控制进入爬取的最大协程数量</p>
<p>main 方法里声明了 1000 个 task，传递给 gather 方法运行</p>
<h4 id="aiohttp-Web-Server"><a href="#aiohttp-Web-Server" class="headerlink" title="aiohttp Web Server"></a>aiohttp Web Server</h4><p><a target="_blank" rel="noopener" href="https://docs.aiohttp.org/en/stable/web_quickstart.html#run-a-simple-web-server">https://docs.aiohttp.org/en/stable/web_quickstart.html#run-a-simple-web-server</a></p>
<p><a target="_blank" rel="noopener" href="https://aiomysql.readthedocs.io/en/latest/">https://aiomysql.readthedocs.io/en/latest/</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> aiohttp <span class="keyword">import</span> web</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">hello</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">return</span> web.Response(text=<span class="string">&#x27;Hello world&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">return</span> web.Response(text=<span class="string">&#x27;&lt;h1&gt;Awesome&lt;/h1&gt;&#x27;</span>, content_type=<span class="string">&#x27;text/html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">init_app</span>():</span></span><br><span class="line">    app = web.Application() <span class="comment">#创建应用程序对象</span></span><br><span class="line">    app.router.add_route(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/&#x27;</span>, index) <span class="comment">#添加路由</span></span><br><span class="line">    app.router.add_get(<span class="string">&#x27;/hello&#x27;</span>, hello)</span><br><span class="line">    <span class="keyword">return</span> app</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    logging.basicConfig(level=logging.INFO)</span><br><span class="line">    app = asyncio.run(init_app())</span><br><span class="line">    web.run_app(app, host=<span class="string">&#x27;127.0.0.1&#x27;</span>, port=<span class="number">8000</span>)</span><br></pre></td></tr></table></figure>



<h4 id="aiohttp-异步爬取实战"><a href="#aiohttp-异步爬取实战" class="headerlink" title="aiohttp 异步爬取实战"></a>aiohttp 异步爬取实战</h4><p>MongoDB 的异步存储，异步实现的 MongoDB 存储库 motor，motor 的连接声明和 pymongo 是类似的，保存数据的调用方法也基本一致</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install motor</span><br></pre></td></tr></table></figure>

<p>通用爬取方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">logging.basicConfig(level=logging.INFO,</span><br><span class="line">                    <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(levelname)s: %(message)s&#x27;</span>)</span><br><span class="line"></span><br><span class="line">INDEX_URL = <span class="string">&#x27;https://spa5.scrape.center/api/book/?limit=18&amp;offset=&#123;offset&#125;&#x27;</span></span><br><span class="line">DETAIL_URL = <span class="string">&#x27;https://spa5.scrape.center/api/book/&#123;id&#125;&#x27;</span></span><br><span class="line">PAGE_SIZE = <span class="number">18</span></span><br><span class="line">PAGE_NUMBER = <span class="number">1</span></span><br><span class="line">CONCURRENCY = <span class="number">5</span></span><br><span class="line">session = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">scrape_api</span>(<span class="params">url</span>):</span></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">with</span> semaphore:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">      logging.info(<span class="string">&#x27;scraping %s&#x27;</span>, url)</span><br><span class="line">      <span class="keyword">async</span> <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> response:</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">await</span> response.json()</span><br><span class="line">    <span class="keyword">except</span> aiohttp.ClientError:</span><br><span class="line">       logging.error(<span class="string">&#x27;error occurred while scraping %s&#x27;</span>, url, exc_info=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="comment"># index tasks</span></span><br><span class="line">    <span class="keyword">global</span> session</span><br><span class="line">    session = aiohttp.ClientSession()</span><br><span class="line">    scrape_index_tasks = [asyncio.ensure_future(scrape_index(page)) <span class="keyword">for</span> page <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, PAGE_NUMBER + <span class="number">1</span>)]</span><br><span class="line">    results = <span class="keyword">await</span> asyncio.gather(*scrape_index_tasks)</span><br><span class="line">    print(<span class="string">&#x27;results&#x27;</span>, results)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    loop.run_until_complete(main())</span><br></pre></td></tr></table></figure>
























      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/28/Airtest/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/28/Airtest/" class="post-title-link" itemprop="url">Airtest</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-04-28 16:05:12" itemprop="dateCreated datePublished" datetime="2022-04-28T16:05:12+08:00">2022-04-28</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-04-29 11:05:58" itemprop="dateModified" datetime="2022-04-29T11:05:58+08:00">2022-04-29</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://airtest.netease.com/changelog.html">AirtestIDE 下载</a> </p>
<p><a target="_blank" rel="noopener" href="https://airtest.doc.io.netease.com/tutorial/1_quick_start_guide/">官网Airetest Project Docs</a></p>
<p>AiretestIDE 一个跨平台的UI自动化测试编辑器，适用游戏和APP</p>
<p>自动化录制脚本、一键回放、报告查看；支持基于图像识别的 Airtest 框架；支持基于UI控件搜索的Poco框架</p>
<h4 id="连接设备"><a href="#连接设备" class="headerlink" title="连接设备"></a>连接设备</h4><ul>
<li>连接 iOS 手机</li>
</ul>
<p>手机通用-开发者-Enable UI Automation 需要开启</p>
<p>需要安装 Xcode 的 Mac 电脑</p>
<p><a target="_blank" rel="noopener" href="https://github.com/AirtestProject/IOS-Tagent">iOS-Tagent</a> 基于 facebook 的 WebDriverAgent 项目上进行开发的</p>
<p>可以使用 Appium 的 WebDriverAgent 工具来部署iOS真机，也可使用 Airtest 下的 iOS-Tagent 工具来部署真机</p>
<p>Appium 的 WebDriverAgent 工具安装 <a target="_blank" rel="noopener" href="https://testerhome.com/topics/7220">https://testerhome.com/topics/7220</a></p>
<p>Facebook 的 WebDriverAgent 工具安装 <a target="_blank" rel="noopener" href="https://testerhome.com/topics/10463">https://testerhome.com/topics/10463</a></p>
<p>下载  iOS-Tagent 项目</p>
<p>Scheme-&gt;WebDriverAgentRunner-&gt;选择设备</p>
<p>product -&gt; Test 报错 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Building for iOS, but the embedded framework &#39;CocoaAsyncSocket.framework&#39; was built for iOS + iOS Simulator.</span><br><span class="line">Building for iOS, but the linked and embedded framework &#39;WebDriverAgentLib.framework&#39; was built for iOS + iOS Simulator.</span><br></pre></td></tr></table></figure>

<p>解决：选择 WebDriverAgentRunner Target -&gt; Build Setting -&gt; Build Options -&gt; Validate Workspace 设置为 YES</p>
<p>需要 libimobiledevice</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">brew install libimobiledevice</span><br><span class="line">#端口转发 第一个是mac端口 第二个是iPhone端口</span><br><span class="line">#会将iPhone上8100的数据转发到mac的8100端口上</span><br><span class="line">iproxy 8100 8100</span><br></pre></td></tr></table></figure>

<p>访问地址 <a target="_blank" rel="noopener" href="http://127.0.0.1:8100/status">http://127.0.0.1:8100/status</a> 可以看到返回的设备信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;value&quot; : &#123;</span><br><span class="line">    &quot;state&quot; : &quot;success&quot;,</span><br><span class="line">    &quot;os&quot; : &#123;</span><br><span class="line">      &quot;name&quot; : &quot;iOS&quot;,</span><br><span class="line">      &quot;version&quot; : &quot;13.1.3&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;ios&quot; : &#123;</span><br><span class="line">      &quot;simulatorVersion&quot; : &quot;13.1.3&quot;,</span><br><span class="line">      &quot;ip&quot; : &quot;10.1.253.216&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;build&quot; : &#123;</span><br><span class="line">      &quot;time&quot; : &quot;Dec 22 2020 14:54:08&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sessionId&quot; : null,</span><br><span class="line">  &quot;status&quot; : 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问 <a target="_blank" rel="noopener" href="http://127.0.0.1:8100/inspector">http://127.0.0.1:8100/inspector</a> 可以看设备界面，但是报错了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;value&quot; : &#123;</span><br><span class="line">    &quot;error&quot; : &quot;unknown command&quot;,</span><br><span class="line">    &quot;message&quot; : &quot;Unhandled endpoint: \&#x2F;inspector -- http:\&#x2F;\&#x2F;127.0.0.1:8100\&#x2F; with parameters &#123;\n wildcards &#x3D; (\ninspector\n);\n&#125;&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sessionId&quot; : null,</span><br><span class="line">  &quot;status&quot; : 6</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打开 AirtestIDE，连接 <a target="_blank" rel="noopener" href="http://127.0.0.1:8100/">http://127.0.0.1:8100</a> 连接不上</p>
<p>Xcode控制台报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-[XCUIScreen screenshotDataForQuality:rect:error:]: unrecognized selector sent to instance 0x28070ffc0</span><br></pre></td></tr></table></figure>

<p>重新下载xcode项目 <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1FCZ-FPQSqYmiGc5QjdjUew">https://pan.baidu.com/s/1FCZ-FPQSqYmiGc5QjdjUew</a>  nk77 可以连接上</p>
<p>左上角 + 号，新建一个 Airtest Project</p>
<img src="Airtest/WeChat74e3de483b997363ebd9b50d174b58cc.png" alt="WeChat74e3de483b997363ebd9b50d174b58cc" style="zoom:67%;" /> 

<p>自动生成初始化代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># -*- encoding&#x3D;utf8 -*-</span><br><span class="line">__author__ &#x3D; &quot;midland_whk&quot;</span><br><span class="line">from airtest.core.api import *</span><br><span class="line">auto_setup(__file__)</span><br></pre></td></tr></table></figure>

<p>辅助窗中点击 touch，这时可以在右侧设备界面拖动框柱想要点击的区域，会自动生成一行点击代码</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/26/%E8%AE%B0%E5%BD%95%E4%B8%8B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/26/%E8%AE%B0%E5%BD%95%E4%B8%8B2/" class="post-title-link" itemprop="url">记录下2</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-04-26 09:13:55" itemprop="dateCreated datePublished" datetime="2022-04-26T09:13:55+08:00">2022-04-26</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-05-20 10:45:03" itemprop="dateModified" datetime="2022-05-20T10:45:03+08:00">2022-05-20</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          输入密码
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/04/26/%E8%AE%B0%E5%BD%95%E4%B8%8B2/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/25/%E8%AE%B0%E5%BD%95%E4%B8%8B1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/25/%E8%AE%B0%E5%BD%95%E4%B8%8B1/" class="post-title-link" itemprop="url">记录下1</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-04-25 10:36:44" itemprop="dateCreated datePublished" datetime="2022-04-25T10:36:44+08:00">2022-04-25</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-07-14 11:05:07" itemprop="dateModified" datetime="2023-07-14T11:05:07+08:00">2023-07-14</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          输入密码
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/04/25/%E8%AE%B0%E5%BD%95%E4%B8%8B1/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/23/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-%E5%88%86%E5%B8%83%E5%BC%8F%E7%88%AC%E8%99%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/23/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-%E5%88%86%E5%B8%83%E5%BC%8F%E7%88%AC%E8%99%AB/" class="post-title-link" itemprop="url">Python3网络爬虫开发实战-分布式爬虫</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-04-23 10:35:41" itemprop="dateCreated datePublished" datetime="2022-04-23T10:35:41+08:00">2022-04-23</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-04-24 09:30:18" itemprop="dateModified" datetime="2022-04-24T09:30:18+08:00">2022-04-24</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>分布式爬虫将多台主机组合起来，共同完成一个爬取任务</p>
<p>Scrapy-Redis 库提供了 Scrapy 分布式的队列、调度器、去重等功能</p>
<h4 id="14-3-Scrapy-分布式实现"><a href="#14-3-Scrapy-分布式实现" class="headerlink" title="14.3 Scrapy 分布式实现"></a>14.3 Scrapy 分布式实现</h4><p>利用 Scrapy-Redis 来实现分布式对接</p>
<h5 id="搭建-Redis-服务器"><a href="#搭建-Redis-服务器" class="headerlink" title="搭建 Redis 服务器"></a>搭建 Redis 服务器</h5><p>要实现分布式部署，多台主机需要共享爬取队列和去重集合，而这两部分内容是存于 Redis 数据库中的，需要搭建一个可公网访问的 Redis 服务器</p>
<p>推荐使用 Linux 服务器，可以购买阿里云、腾讯云、Azure等提供的云主机，一般都会配有公网 IP</p>
<p>阿里云、腾讯云的服务器需要配置安全组放通 Redis 运行端口才可以远程访问</p>
<h5 id="配置-Scrapy-Redis"><a href="#配置-Scrapy-Redis" class="headerlink" title="配置 Scrapy-Redis"></a>配置 Scrapy-Redis</h5><ul>
<li>核心配置</li>
</ul>
<p>将调度器的类和去重的类替换为 Scrapy-Redis 提供的类，settings.py 里添加配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SCHEDULER &#x3D; &quot;scrapy_redis.scheduler.Scheduler&quot;</span><br><span class="line">DUPEFILTER_CLASS &#x3D; &quot;scrapy_redis.dupefilter.RFPDupeFilter&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>Redis 连接配置</li>
</ul>
<p>方式一：通过连接字符串配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">redis://[:password]@host:port/db</span><br><span class="line">rediss://[:password]@host:port/db</span><br><span class="line">unix://[:password]@/path/to/socket.sock?db=db</span><br><span class="line"><span class="comment">#如 redis://:foobared@127.2.34.25:6379</span></span><br></pre></td></tr></table></figure>

<p>中括号代表此选项可有可无 db是数据库代号，默认值 0</p>
<p>settings.py 里配置为 REDIS_URL 变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REDIS_URL &#x3D; &#39;redis:&#x2F;&#x2F;:foobared@127.2.34.25:6379&#39;</span><br></pre></td></tr></table></figure>

<p>方式二：是分项单独配置， settings.py 中配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">REDIS_HOST &#x3D; &#39;127.2.34.25&#39;</span><br><span class="line">REDIS_PORT &#x3D; &#39;6379&#39;</span><br><span class="line">REDIS_PASSWORD &#x3D; &#39;foobared&#39;</span><br></pre></td></tr></table></figure>

<h5 id="配置调度队列"><a href="#配置调度队列" class="headerlink" title="配置调度队列"></a>配置调度队列</h5><p>此配置可选，默认使用 PriorityQueue，如果想更改配置，可有配置 SCHEDULER_QUEUE_CLASS 变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SCHEDULER_QUEUE_CLASS &#x3D; &#39;scrapy_redis.queue.PriorityQueue&#39;</span><br><span class="line">SCHEDULER_QUEUE_CLASS &#x3D; &#39;scrapy_redis.queue.FifoQueue&#39;</span><br><span class="line">SCHEDULER_QUEUE_CLASS &#x3D; &#39;scrapy_redis.queue.LifoQueue&#39;</span><br></pre></td></tr></table></figure>

<p>任选一配置，即可切换爬取队列的存储方式</p>
<h5 id="配置持久化"><a href="#配置持久化" class="headerlink" title="配置持久化"></a>配置持久化</h5><p>可选配置，默认 False。Scrapy-Redis 默认会在爬取全部完成清空爬取队列和去重指纹集合</p>
<p>如果不想自动清空爬取队列和去重指纹集合，可以增加配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SCHEDULER_PERSIST &#x3D; True</span><br></pre></td></tr></table></figure>

<h5 id="配置重爬"><a href="#配置重爬" class="headerlink" title="配置重爬"></a>配置重爬</h5><p>可选配置，默认 False，如果配置了持久化或者强制中断了爬虫，那么爬取队列和指纹集合不会被清空，爬虫重启之后就会接上次爬取，如果想重新爬取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SCHEDULER_FLUSH_ON_START &#x3D; True</span><br></pre></td></tr></table></figure>

<p>分布式爬取不常用此配置</p>
<h5 id="Pipeline-配置"><a href="#Pipeline-配置" class="headerlink" title="Pipeline 配置"></a>Pipeline 配置</h5><p>可选配置，默认不启动</p>
<h5 id="配置存储目标"><a href="#配置存储目标" class="headerlink" title="配置存储目标"></a>配置存储目标</h5><p>最好将存储目标存到同一地方，可以在服务器上搭建一个 MongoDB 服务，或者购买 MongoDB 数据存储服务</p>
<p>这里使用服务器上搭建的 MongoDB 服务 ，IP120.27.34.25 用户名 admin 密码 admin123</p>
<p>修改 MONGO_URI </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MONGO_URI &#x3D; &#39;mongodb:&#x2F;&#x2F;admin:admin123@120.27.34.25:27017&#39;</span><br></pre></td></tr></table></figure>

<h5 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy crawl weibocn</span><br></pre></td></tr></table></figure>

<p>每台主机启动了此命令之后，就会从配置的 Redis 数据库中调度 Request，做到爬取队列共享和指纹集合共享，每台主机占用各自的宽带和处理器，不会互相影响</p>
<h4 id="14-5-Bloom-Filter-对接"><a href="#14-5-Bloom-Filter-对接" class="headerlink" title="14.5 Bloom Filter 对接"></a>14.5 Bloom Filter 对接</h4><p>布隆过滤器，用来检测一个元素是否在一个集合中</p>
<h5 id="对接-Scrapy-Redis"><a href="#对接-Scrapy-Redis" class="headerlink" title="对接 Scrapy-Redis"></a>对接 Scrapy-Redis</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install scrapy-redis-bloomfilter</span><br></pre></td></tr></table></figure>

<p>配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#去重类，要使用Bloom Filter 替换 DUPEFILTER_CLASS</span></span><br><span class="line">DUPEFILTER_CLASS = <span class="string">&#x27;scrapy_redis_bloomfilter.dupefilter.RFPDupeFilter&#x27;</span></span><br><span class="line"><span class="comment">#散列函数的个数 默认 6</span></span><br><span class="line">BLOOMFILTER_HASH_NUMBER = <span class="number">6</span></span><br><span class="line"><span class="comment">#Bloom Filter 的bit参数 默认30 占用128M空间，去重量级1亿</span></span><br><span class="line">BLOOMFILTER_BIT = <span class="number">30</span></span><br></pre></td></tr></table></figure>



<h4 id="分布式爬虫部署"><a href="#分布式爬虫部署" class="headerlink" title="分布式爬虫部署"></a>分布式爬虫部署</h4><h4 id="15-1-Scrapyd-分布式部署"><a href="#15-1-Scrapyd-分布式部署" class="headerlink" title="15.1 Scrapyd 分布式部署"></a>15.1 Scrapyd 分布式部署</h4><p>Scrapyd 运行 Scrapy 爬虫的服务程序，提供一系列 HTTP 接口帮助部署、启动、停止、删除爬虫程序</p>
<h5 id="Scrapyd"><a href="#Scrapyd" class="headerlink" title="Scrapyd"></a>Scrapyd</h5><h5 id="Scrapyd-API"><a href="#Scrapyd-API" class="headerlink" title="Scrapyd API"></a>Scrapyd API</h5><h4 id="15-2-Scrapyd-Client"><a href="#15-2-Scrapyd-Client" class="headerlink" title="15.2 Scrapyd-Client"></a>15.2 Scrapyd-Client</h4><p>Scrapyd-Client 为了方便 Scrapy 项目的部署，提供了两个功能</p>
<p>将项目打包成 Egg文件</p>
<p>将打包生成的Egg文件通过 addversion.json 接口部署到 Scrapyd 上</p>
<h5 id="Scrapyd-Client-部署"><a href="#Scrapyd-Client-部署" class="headerlink" title="Scrapyd-Client 部署"></a>Scrapyd-Client 部署</h5><h4 id="15-3-Scrapyd-对接-Docker"><a href="#15-3-Scrapyd-对接-Docker" class="headerlink" title="15.3 Scrapyd 对接 Docker"></a>15.3 Scrapyd 对接 Docker</h4><p>将 Scrapyd 打包成一个 Docker 镜像，那么在服务器上只需要执行 Docker 命令就可以启动 Scrapyd 服务，就不用关心 Python 环境问题，也不需要担心版本冲突问题</p>
<h4 id="15-4-Scrapyd-批量部署"><a href="#15-4-Scrapyd-批量部署" class="headerlink" title="15.4 Scrapyd 批量部署"></a>15.4 Scrapyd 批量部署</h4>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/21/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-9%E4%BB%A3%E7%90%86%E7%9A%84%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/21/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-9%E4%BB%A3%E7%90%86%E7%9A%84%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">Python3网络爬虫开发实战-9代理的使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-04-21 09:15:06" itemprop="dateCreated datePublished" datetime="2022-04-21T09:15:06+08:00">2022-04-21</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-10-17 09:01:44" itemprop="dateModified" datetime="2022-10-17T09:01:44+08:00">2022-10-17</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>如果本机有相关代理软件的话，软件一般会在本机创建 HTTP 或 SOCKS 代理服务</p>
<p>只要设置了代理，就可以成功将本机 IP 切换到代理软件连接的服务器的 IP 了</p>
<p>设置代理后测试网址 <a target="_blank" rel="noopener" href="http://httpbin.org/get">http://httpbin.org/get</a></p>
<h4 id="9-1-代理设置"><a href="#9-1-代理设置" class="headerlink" title="9.1 代理设置"></a>9.1 代理设置</h4><h5 id="urllib"><a href="#urllib" class="headerlink" title="urllib"></a>urllib</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.error <span class="keyword">import</span> URLError</span><br><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> ProxyHandler, build_opener</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  proxy = <span class="string">&#x27;183.172.236.158:10080&#x27;</span></span><br><span class="line">  proxy_handler = ProxyHandler(&#123;</span><br><span class="line">      <span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;http://&#x27;</span> + proxy,</span><br><span class="line">      <span class="string">&#x27;https&#x27;</span>: <span class="string">&#x27;https://&#x27;</span> + proxy</span><br><span class="line">  &#125;)</span><br><span class="line">  opener = build_opener(proxy_handler)</span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">      response = opener.<span class="built_in">open</span>(<span class="string">&#x27;http://httpbin.org/get&#x27;</span>)</span><br><span class="line">      print(response.read().decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">  <span class="keyword">except</span> URLError <span class="keyword">as</span> e:</span><br><span class="line">      print(e.reason)</span><br></pre></td></tr></table></figure>

<p>使用 ProxyHandler 设置代理</p>
<p>结果，origin 字段标明了客户端的 IP</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;args&quot;: &#123;&#125;, </span><br><span class="line">  &quot;headers&quot;: &#123;</span><br><span class="line">    &quot;Accept-Encoding&quot;: &quot;identity&quot;, </span><br><span class="line">    &quot;Host&quot;: &quot;httpbin.org&quot;, </span><br><span class="line">    &quot;User-Agent&quot;: &quot;Python-urllib&#x2F;3.8&quot;, </span><br><span class="line">    &quot;X-Amzn-Trace-Id&quot;: &quot;Root&#x3D;1-6260b354-5d0a11da29ddab260babe279&quot;</span><br><span class="line">  &#125;, </span><br><span class="line">  &quot;origin&quot;: &quot;183.172.236.158&quot;, </span><br><span class="line">  &quot;url&quot;: &quot;http:&#x2F;&#x2F;httpbin.org&#x2F;get&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果是需要认证的代理，只需要在代理前面加入代理认证的用户名和密码即可，将上面的 proxy 变量改成</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy &#x3D; &#39;username:password@183.172.236.158:10080&#39;</span><br></pre></td></tr></table></figure>

<p>如果代理是 SOCKS5 类型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.error <span class="keyword">import</span> URLError</span><br><span class="line"><span class="keyword">import</span> socks</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line">socks.set_default_proxy(socks.SOCKS5, <span class="string">&#x27;183.172.236.158&#x27;</span>, <span class="string">&#x27;10080&#x27;</span>)</span><br><span class="line">socket.socket = socks.socksocket</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = request.urlopen(<span class="string">&#x27;http://httpbin.org/get&#x27;</span>)</span><br><span class="line">    print(response.read().decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"><span class="keyword">except</span> URLError <span class="keyword">as</span> e:</span><br><span class="line">    print(e.reason)</span><br></pre></td></tr></table></figure>

<p>此处需要一个 socks 模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install PySocks</span><br></pre></td></tr></table></figure>

<p>如果本地有一个 SOCKS5代理，运行在 10080 端口，运行成功和上面是一样的</p>
<h5 id="requests"><a href="#requests" class="headerlink" title="requests"></a>requests</h5><p>只需要传入 proxies 即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">proxy = <span class="string">&#x27;183.172.236.158:10080&#x27;</span></span><br><span class="line"><span class="comment">#如果需要认证，改成 proxy = &#x27;username:password@183.172.236.158:10080&#x27;</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;http://&#x27;</span> + proxy,</span><br><span class="line">    <span class="string">&#x27;https&#x27;</span>: <span class="string">&#x27;https://&#x27;</span> + proxy</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = requests.get(<span class="string">&#x27;http://httpbin.org/get&#x27;</span>, proxies=proxies)</span><br><span class="line">    print(response.text)</span><br><span class="line"><span class="keyword">except</span> requests.exceptions.ConnectionError <span class="keyword">as</span> e:</span><br><span class="line">    print(<span class="string">&#x27;Error&#x27;</span>, e.args)</span><br></pre></td></tr></table></figure>

<p>如果需要使用 SOCKS5代理，将 proxies 改成</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">proxy = <span class="string">&#x27;183.172.236.158:10080&#x27;</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;socks5&#x27;</span> + proxy,</span><br><span class="line">    <span class="string">&#x27;https&#x27;</span>: <span class="string">&#x27;socks5&#x27;</span> + proxy</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要额外安装一个模块，叫作 requests[socks]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install &#39;requests[socks]&#39;</span><br></pre></td></tr></table></figure>

<p>还有一种设置方式，和 urllib 中的方法相同，相比第一种方法，此方法是全局设置的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> socks</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">socks.set_default_proxy(socks.SOCKS5, <span class="string">&#x27;183.172.236.158&#x27;</span>, <span class="string">&#x27;10080&#x27;</span>)</span><br><span class="line">socket.socket = socks.socksocket</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = requests.get(<span class="string">&#x27;http://httpbin.org/get&#x27;</span>)</span><br><span class="line">    print(response.read().decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"><span class="keyword">except</span> URLError <span class="keyword">as</span> e:</span><br><span class="line">    print(e.reason)</span><br></pre></td></tr></table></figure>

<h5 id="httpx"><a href="#httpx" class="headerlink" title="httpx"></a>httpx</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> httpx</span><br><span class="line">proxy = <span class="string">&#x27;127.0.0.1:7890&#x27;</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">&#x27;http://&#x27;</span>: <span class="string">&#x27;http://&#x27;</span> + proxy,</span><br><span class="line">    <span class="string">&#x27;https://&#x27;</span>: <span class="string">&#x27;https://&#x27;</span> + proxy</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">with</span> httpx.Client(proxies=proxies) <span class="keyword">as</span> client:</span><br><span class="line">  response = client.get(<span class="string">&#x27;https://www.httpbin.org/get&#x27;</span>)</span><br><span class="line">  print(response.text)</span><br></pre></td></tr></table></figure>



<h5 id="Selenium"><a href="#Selenium" class="headerlink" title="Selenium"></a>Selenium</h5><p>Chrome、PhantomJS</p>
<h6 id="Chrome"><a href="#Chrome" class="headerlink" title="Chrome"></a>Chrome</h6><p>通过 ChromeOptions 来设置代理，创建 Chrome 对象使用 options 参数传递即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">proxy = <span class="string">&#x27;101.132.189.87:9090&#x27;</span></span><br><span class="line">chrome_options = webdriver.ChromeOptions()</span><br><span class="line">chrome_options.add_argument(<span class="string">&#x27;--proxy-server=http://&#x27;</span> + proxy)</span><br><span class="line">browser = webdriver.Chrome(options=options)</span><br><span class="line">browser.get(<span class="string">&#x27;http://httpbin.org/get&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>如果是认证代理，设置会比较麻烦</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.chrome.options <span class="keyword">import</span> Options</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"></span><br><span class="line">ip = <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">port = <span class="number">9743</span></span><br><span class="line">username = <span class="string">&#x27;foo&#x27;</span></span><br><span class="line">password = <span class="string">&#x27;bar&#x27;</span></span><br><span class="line"></span><br><span class="line">manifest_json = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;version&quot;: &quot;1.0.0&quot;,</span></span><br><span class="line"><span class="string">    &quot;manifest_version&quot;: 2,</span></span><br><span class="line"><span class="string">    &quot;name&quot;: &quot;Chrome Proxy&quot;,</span></span><br><span class="line"><span class="string">    &quot;permissions&quot;: [</span></span><br><span class="line"><span class="string">        &quot;proxy&quot;,</span></span><br><span class="line"><span class="string">        &quot;tabs&quot;,</span></span><br><span class="line"><span class="string">        &quot;unlimitedStorage&quot;,</span></span><br><span class="line"><span class="string">        &quot;storage&quot;,</span></span><br><span class="line"><span class="string">        &quot;&lt;all_urls&gt;&quot;,</span></span><br><span class="line"><span class="string">        &quot;webRequest&quot;,</span></span><br><span class="line"><span class="string">        &quot;webRequestBlocking&quot;</span></span><br><span class="line"><span class="string">    ],</span></span><br><span class="line"><span class="string">    &quot;background&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;scripts&quot;: [&quot;background.js&quot;]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">background_js = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">var config = &#123;</span></span><br><span class="line"><span class="string">        mode: &quot;fixed_servers&quot;,</span></span><br><span class="line"><span class="string">        rules: &#123;</span></span><br><span class="line"><span class="string">          singleProxy: &#123;</span></span><br><span class="line"><span class="string">            scheme: &quot;http&quot;,</span></span><br><span class="line"><span class="string">            host: &quot;%(ip)s&quot;,</span></span><br><span class="line"><span class="string">            port: %(port)s</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">chrome.proxy.settings.set(&#123;value: config, scope: &quot;regular&quot;&#125;, function() &#123;&#125;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">function callbackFn(details) &#123;</span></span><br><span class="line"><span class="string">    return &#123;</span></span><br><span class="line"><span class="string">        authCredentials: &#123;</span></span><br><span class="line"><span class="string">            username: &quot;%(username)s&quot;,</span></span><br><span class="line"><span class="string">            password: &quot;%(password)s&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">chrome.webRequest.onAuthRequired.addListener(</span></span><br><span class="line"><span class="string">            callbackFn,</span></span><br><span class="line"><span class="string">            &#123;urls: [&quot;&lt;all_urls&gt;&quot;]&#125;,</span></span><br><span class="line"><span class="string">            [&#x27;blocking&#x27;]</span></span><br><span class="line"><span class="string">)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span> % &#123;<span class="string">&#x27;ip&#x27;</span>: ip, <span class="string">&#x27;port&#x27;</span>: port, <span class="string">&#x27;username&#x27;</span>: username, <span class="string">&#x27;password&#x27;</span>: password&#125;</span><br><span class="line"></span><br><span class="line">plugin_file = <span class="string">&#x27;proxy_auth_plugin.zip&#x27;</span></span><br><span class="line"><span class="keyword">with</span> zipfile.ZipFile(plugin_file, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> zp:</span><br><span class="line">    zp.writestr(<span class="string">&quot;manifest.json&quot;</span>, manifest_json)</span><br><span class="line">    zp.writestr(<span class="string">&quot;background.js&quot;</span>, background_js)</span><br><span class="line">chrome_options = Options()</span><br><span class="line">chrome_options.add_argument(<span class="string">&quot;--start-maximized&quot;</span>)</span><br><span class="line">chrome_options.add_extension(plugin_file)</span><br><span class="line">browser = webdriver.Chrome(chrome_options=chrome_options)</span><br><span class="line">browser.get(<span class="string">&#x27;http://httpbin.org/get&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>需要创建 manifest.json 配置文件和 background.js 脚本来设置代理，运行代码后会生成一个 proxy_auth_plugin.zip 文件来保存当前配置</p>
<h6 id="PhantomJS"><a href="#PhantomJS" class="headerlink" title="PhantomJS"></a>PhantomJS</h6><p><del>设置代理可以借助 service_args 参数，也就是命令行参数</del></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">module &#39;selenium.webdriver&#39; has no attribute &#39;PhantomJS&#39;</span><br></pre></td></tr></table></figure>

<p>不支持了</p>
<h5 id="aiohttp-代理设置"><a href="#aiohttp-代理设置" class="headerlink" title="aiohttp 代理设置"></a>aiohttp 代理设置</h5><h5 id="Pyppeteer代理设置"><a href="#Pyppeteer代理设置" class="headerlink" title="Pyppeteer代理设置"></a>Pyppeteer代理设置</h5><h5 id="Playwright代理设置"><a href="#Playwright代理设置" class="headerlink" title="Playwright代理设置"></a>Playwright代理设置</h5><h4 id="9-2-代理池的维护"><a href="#9-2-代理池的维护" class="headerlink" title="9.2 代理池的维护"></a>9.2 代理池的维护</h4><h5 id="存储模块"><a href="#存储模块" class="headerlink" title="存储模块"></a>存储模块</h5><p>存储抓取下来的代理，这里用 Redis 的有序集合，集合中每一个元素都是不重复的</p>
<h5 id="获取模块"><a href="#获取模块" class="headerlink" title="获取模块"></a>获取模块</h5><p>需要定时在各大代理网站抓取代理</p>
<h5 id="检测模块"><a href="#检测模块" class="headerlink" title="检测模块"></a>检测模块</h5><p>需要定时检测数据库中的代理</p>
<p>使用异步请求库 aiohttp 来进行检测</p>
<h5 id="接口模块"><a href="#接口模块" class="headerlink" title="接口模块"></a>接口模块</h5><p>用 API 来提供对外服务的接口</p>
<p>为了使代理池可以作为一个独立服务运行，最好增加一个接口模块，并以 WebAPI的形式暴露可用代理</p>
<h5 id="调度模块"><a href="#调度模块" class="headerlink" title="调度模块"></a>调度模块</h5><p>调用上面定义的模块，将上面模块通过多进程的形式运行起来</p>
<h4 id="9-3-付费代理"><a href="#9-3-付费代理" class="headerlink" title="9.3 付费代理"></a>9.3 付费代理</h4><p>讯代理 <a target="_blank" rel="noopener" href="http://www.xdaili.cn/">http://www.xdaili.cn</a></p>
<p>阿布云代理 <a target="_blank" rel="noopener" href="https://www.abuyun.com/">https://www.abuyun.com</a></p>
<h4 id="9-4-ADSL拨号代理"><a href="#9-4-ADSL拨号代理" class="headerlink" title="9.4 ADSL拨号代理"></a>9.4 ADSL拨号代理</h4><p>ADSL 通过拨号的方式上网，需要输入 ADSL 账号和密码，每次拨号就更换一个 IP，如果将 ADSL 主机作为代理，每隔一段时间主机拨号就换一个 IP，这样可以有效防止 IP 被封，主机稳定性好，代理响应速度很快</p>
<h5 id="购买主机"><a href="#购买主机" class="headerlink" title="购买主机"></a>购买主机</h5><p>购买动态拨号 VPS 主机</p>
<p>阿斯云 <a target="_blank" rel="noopener" href="https://asiyun.cn/">https://asiyun.cn</a></p>
<p>云立方 <a target="_blank" rel="noopener" href="http://www.yunlifang.cn/dynamicvps.asp">http://www.yunlifang.cn/dynamicvps.asp</a></p>
<p>建议选择电信线路，可以自行选择主机配置</p>
<p>推荐安装 CentOS 7 Linux 系统</p>
<p>找到远程管理面板-远程连接用户名和密码，也就是 SSH 远程连接服务器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh root@xxx.xx.xx.xx -p xxx</span><br></pre></td></tr></table></figure>

<p>输入管理密码，就可以连接上远程服务器了</p>
<p>进入后有个可用的脚本文件 ppp.sh，这是拨号初始化的脚本</p>
<p>运行 ppp.sh 脚本，输入用户名、密码等待它的配置完成</p>
<p>输入拨号命令 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adsl-start</span><br></pre></td></tr></table></figure>

<p>运行成功后就可以去试 ping 外网了</p>
<p>停止拨号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adsl-stop</span><br></pre></td></tr></table></figure>

<p>阿斯云拨号命令 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pppoe-start</span><br><span class="line">pppoe-stor</span><br></pre></td></tr></table></figure>



<p>断线重播的命令就是两个命令组合起来，每次拨号，ifconfig 查看主机 IP，发现主机 IP 一直在变化</p>
<h5 id="设置代理服务器"><a href="#设置代理服务器" class="headerlink" title="设置代理服务器"></a>设置代理服务器</h5><p>Linux 下搭建 HTTP 代理服务器，推荐 TinyProxy 和 Squid</p>
<h6 id="TinyProxy"><a href="#TinyProxy" class="headerlink" title="TinyProxy"></a>TinyProxy</h6><p>这里以 TinyProxy 为例</p>
<ul>
<li>安装 TinyProxy</li>
</ul>
<p>CentOS 系统使用 yum 来安装，其它系统如 Ubuntu，可以选择 apt-get 等命令安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y epel-release</span><br><span class="line">yum update -y</span><br><span class="line">yum install -y tinyproxy</span><br></pre></td></tr></table></figure>

<ul>
<li>配置 TinyProxy</li>
</ul>
<p>TinyProxy 安装完成后还要配置一下才可以用作代理服务器，需要编辑配置文件</p>
<p>/etc/tinyproxy/tinyproxy.conf</p>
<p><code>Port 8888</code>  这里可以设置代理的端口，默认 8888</p>
<p>继续找到代码  <code>Allow 127.0.0.1</code> 这行代码表示被允许连接的主机 IP，如果希望连接任何主机，这行代码注释即可，这里选择注释，也就是任何主机都可以使用这台主机作为代理服务器</p>
<p>设置完成后重启 TinyProxy 即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable tinyproxy.service</span><br><span class="line">systemctl restart tinyproxy.service</span><br></pre></td></tr></table></figure>

<p>防火墙开放该端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT -p tcp --dport 8888 -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>如果想直接关闭防火墙也可以</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld.service</span><br></pre></td></tr></table></figure>

<ul>
<li>验证 TinyProxy</li>
</ul>
<p>先用 ifconfig 查看当前主机的 IP，比如这主机拨号 IP 为 112.88.118.212</p>
<p>其它主机运行测试下</p>
<p>用 curl 命令设置代理请求，检测代理是否生效</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -x 112.88.118.212:8888 httpbin.org&#x2F;get</span><br></pre></td></tr></table></figure>

<p>如果有正常的结果输出，并且 origin 的值为代理 IP 就证明 TinyProxy 设置成功了</p>
<h6 id="Squid"><a href="#Squid" class="headerlink" title="Squid"></a>Squid</h6><p>安装 Squid</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo yum -y update</span><br><span class="line">yum -y install squid</span><br><span class="line"></span><br><span class="line">systemctl start squid  #启动Squid</span><br><span class="line">systemctl enable squid #开机自动启动</span><br><span class="line">systemctl status squid #查看运行状态</span><br></pre></td></tr></table></figure>

<p>默认 Squid 运行在 3128 端口</p>
<ul>
<li>开启允许外网访问</li>
</ul>
<p>修改  <code>/etc/squid/squid.conf</code></p>
<p>允许公网访问，将 <code>http_access deny all</code> 修改为 <code>http_access allow all</code></p>
<p>还需要在配置文件的开头 acl 配置的部分添加该行内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">acl all src 0.0.0.0&#x2F;0</span><br></pre></td></tr></table></figure>

<p>还可以将 Squid 配置成高度匿名代理，这样目标网站就无法从通过一些参数如 X-Forward-For 来得知爬虫机本身的 IP 了，配置文件添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request_header_access Via deny all</span><br><span class="line">request_header_access X-Forwarded-For deny all</span><br></pre></td></tr></table></figure>

<p>云主机厂商可能默认封禁了 Squid 的 3128 端口，更换端口</p>
<p><code>http_port 3128</code> 修改为 <code>http_port 3328</code></p>
<p>修改完配置后保存，重启 Squid </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart squid</span><br></pre></td></tr></table></figure>

<p>还需要宝塔面板或者命令开放3328防火墙端口</p>
<p>云主机上运行 curl 命令测试 Squid 的代理效果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -x http:&#x2F;&#x2F;127.0.0.1:3328 https:&#x2F;&#x2F;httpbin.org&#x2F;get</span><br><span class="line">ifconfig</span><br></pre></td></tr></table></figure>

<p>返回 origin 字段 IP 106.45.104.166 和 ifconfig 返回的云主机 IP 一致</p>
<p>本机运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -x http:&#x2F;&#x2F;106.45.104.166:3328 https:&#x2F;&#x2F;httpbin.org&#x2F;get</span><br></pre></td></tr></table></figure>

<p>返回结果看到 origin 字段返回地址就是云主机 IP地址了</p>
<h5 id="存储模块-1"><a href="#存储模块-1" class="headerlink" title="存储模块"></a>存储模块</h5><p>配置一个可以公网访问的 Redis 数据库，云主机可以将自己的代理存储到对应的 Redis 数据库中</p>
<p>云主机要进行 Redis 数据库的操作，可以使用 Python 实现，先在云主机上装 Python</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install python3</span><br></pre></td></tr></table></figure>

<p>自动拨号、连接 Redis 数据库、获取本机代理、设置 Redis 数据库的操作</p>
<p>使用 adslproxy 包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install adslproxy</span><br></pre></td></tr></table></figure>

<p>安装完成后使用 export 设置环境变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">export REDIS_HOST&#x3D;&lt;Redis数据库的地址&gt;</span><br><span class="line">export REDIS_PORT&#x3D;&lt;Redis数据库的端口&gt;</span><br><span class="line">export REDIS_PASSWORD&#x3D;&lt;Redis数据库的密码&gt;</span><br><span class="line">export PROXY_PORT&#x3D;&lt;拨号云主机配置的代理端口&gt;</span><br><span class="line">export DIAL_BASH&#x3D;&lt;拨号脚本&gt; #pppoe-stop;pppoe-start</span><br><span class="line">export DIAL_IFNAME&#x3D;&lt;网卡名称&gt; #ppp0</span><br><span class="line">export CLIENT_NAME&#x3D;&lt;云主机的唯一标识&gt;</span><br><span class="line">export DIAL_CYCLE&#x3D;&lt;拨号间隔&gt;</span><br></pre></td></tr></table></figure>

<p>运行 <code>adslproxy send</code> 拨号</p>
<h5 id="拨号模块"><a href="#拨号模块" class="headerlink" title="拨号模块"></a>拨号模块</h5><p>定时拨号</p>
<p>只需要在拨号主机上运行定时脚本，每隔一段时间拨号一次，更新 IP，然后将 IP 在 Redis  散列表中更新即可</p>
<p>接下来就是获取IP，获取拨号后的 IP，只需要 ifconfig 命令，解析出对应网卡的 IP</p>
<p>获取 IP 之后，还需要进行有效性检测。拨号主机可以自己检测，比如可以利用 requests 设置自身的代理请求外网，如果成功，那么证明代理可用，然后再修改 Redis 散列表，更新代理</p>
<p>拨号后主机是离线状态，Redis 散列表中还存留上次的代理，这代理是无法使用的，每台主机在拨号之前还需要将自身的代理从 Redis 散列表中移除</p>
<h5 id="接口模块-1"><a href="#接口模块-1" class="headerlink" title="接口模块"></a>接口模块</h5><p>利用 Tornado 的Server模块搭建 Web 接口服务</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/19/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-Scrapy%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/19/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-Scrapy%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">Python3网络爬虫开发实战-Scrapy框架使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-04-19 22:00:23" itemprop="dateCreated datePublished" datetime="2022-04-19T22:00:23+08:00">2022-04-19</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-04-24 09:30:18" itemprop="dateModified" datetime="2022-04-24T09:30:18+08:00">2022-04-24</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Scrapy 功能非常强大，爬取效率高，相关扩展组件多，可配置和可扩展程度非常高，几乎可以应对所有反爬网站，是目前Python中使用最广泛的爬虫框架</p>
<p>官方文档 <a target="_blank" rel="noopener" href="https://doc.scrapy.org/en/latest/index.html">https://doc.scrapy.org/en/latest/index.html</a></p>
<h4 id="Scrapy"><a href="#Scrapy" class="headerlink" title="Scrapy"></a>Scrapy</h4><h5 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy startproject tutorial</span><br></pre></td></tr></table></figure>

<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-Scrapy%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/WeChatf2beb120c54835739c5d7653fc0fc630.png" alt="WeChatf2beb120c54835739c5d7653fc0fc630"></p>
<p>scrapy.cfg：Scrapy 项目的配置文件，定义了项目配置文件路径、部署相关信息等内容，Scrapy 部署时的配置文件</p>
<p>items.py：定义 Item 数据结构，所有的 Item 的定义都可以放这里，定义爬取的数据结构</p>
<p>pipelines.py：定义 Item Pipeline 的实现，所有 Item Pipeline 的实现都可以放这里，定义数据管道</p>
<p>settings.py：定义项目的全局配置，配置文件</p>
<p>middlewares.py：定义 Spider Middlewares 和 Downloader Middlewares 的实现，爬取时的中间件</p>
<p>spiders：其内包含一个个 Spider 的实现，每个 Spider 都有一个文件，放置 Spiders 的文件夹</p>
<h5 id="创建-Spider"><a href="#创建-Spider" class="headerlink" title="创建 Spider"></a>创建 Spider</h5><p>Spider 是自己定义的类，Scrapy 用它来从网页抓取内容，并解析抓取的结果，不过这个类必须继承 Scrapy 提供的 Spider 类 scrapy.Spider，还要定义 Spider 的名称和起始请求，以及怎样处理爬取后的结果的方法</p>
<p>命令行创建一个 Spider，生成 Quotes 这个 Spider</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd tutorial</span><br><span class="line">scrapy genspider quotes quotes.toscrape.com</span><br></pre></td></tr></table></figure>

<p>执行 genspider 命令，第一个参数是 Spider 名称，第二个参数是网站域名</p>
<p>执行完毕后，spiders 文件夹中多了一个 quotes.py</p>
<p>内容：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QuotesSpider</span>(<span class="params">scrapy.Spider</span>):</span></span><br><span class="line">    name = <span class="string">&#x27;quotes&#x27;</span></span><br><span class="line">    allowed_domains = [<span class="string">&#x27;quotes.toscrape.com&#x27;</span>]</span><br><span class="line">    start_urls = [<span class="string">&#x27;http://quotes.toscrape.com/&#x27;</span>]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>name 每个项目唯一的名字，区分不同的Spider</p>
<p>allowed_domains 允许爬取的域名，如果初始或后续的请求链接不在这个域名下的，则请求链接会被过滤</p>
<p>start_urls，包含了Spider在启动时爬取的url列表，初始请求是由它来定义的</p>
<p>parse 是 Spider 的一个方法，默认情况下，被调用时 start_urls 里面的链接构成的请求完成下载执行后，返回的响应会作为唯一的参数传递给这个函数，该方法解析返回的响应、提取数据或者进一步生成要处理的请求</p>
<h5 id="创建-Item"><a href="#创建-Item" class="headerlink" title="创建 Item"></a>创建 Item</h5><p>Item 是保存爬取数据的容器，使用方法和字典类似</p>
<p>创建 Item 需要继承 scrapy.Item 类，并且定义类型为 scrapy.Field 的字段</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QuoteItem</span>(<span class="params">scrapy.Item</span>):</span></span><br><span class="line">    <span class="comment"># define the fields for your item here like:</span></span><br><span class="line">    text = scrapy.Field()</span><br><span class="line">    author = scrapy.Field()</span><br><span class="line">    tags = scrapy.Field()</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h5 id="解析-Response"><a href="#解析-Response" class="headerlink" title="解析 Response"></a>解析 Response</h5><p>parse() 方法的参数 response 是 start_urls 里面的链接爬取后的结果，所以在 parse() 方法中，我们可以直接对 response 变量包含的内容进行解析</p>
<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-Scrapy%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/WeChatb6f074004233d523d5e359e02e4ffb4e.png" alt="WeChatb6f074004233d523d5e359e02e4ffb4e"></p>
<p>网页结构中每一页都有多个 class 为 quote 的区块，每个区块都包含 text、author、tags，需要先找出所有的 quote，然后提取每一个 quote 中的内容</p>
<p>提取方式可以是 CSS 选择器或XPath 选择器</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;quote&quot;</span> <span class="attr">itemscope</span>=<span class="string">&quot;&quot;</span> <span class="attr">itemtype</span>=<span class="string">&quot;http://schema.org/CreativeWork&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;text&quot;</span> <span class="attr">itemprop</span>=<span class="string">&quot;text&quot;</span>&gt;</span>“The world as we have ....”<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>by <span class="tag">&lt;<span class="name">small</span> <span class="attr">class</span>=<span class="string">&quot;author&quot;</span> <span class="attr">itemprop</span>=<span class="string">&quot;author&quot;</span>&gt;</span>Albert Einstein<span class="tag">&lt;/<span class="name">small</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/author/Albert-Einstein&quot;</span>&gt;</span>(about)<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;tags&quot;</span>&gt;</span></span><br><span class="line">        Tags:</span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">class</span>=<span class="string">&quot;keywords&quot;</span> <span class="attr">itemprop</span>=<span class="string">&quot;keywords&quot;</span> <span class="attr">content</span>=<span class="string">&quot;change,deep-thoughts,thinking,world&quot;</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;tag&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/tag/change/page/1/&quot;</span>&gt;</span>change<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;tag&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/tag/deep-thoughts/page/1/&quot;</span>&gt;</span>deep-thoughts<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;tag&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/tag/thinking/page/1/&quot;</span>&gt;</span>thinking<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;tag&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/tag/world/page/1/&quot;</span>&gt;</span>world<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">    quotes = response.css(<span class="string">&#x27;.quote&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> quote <span class="keyword">in</span> quotes:</span><br><span class="line">        text = quote.css(<span class="string">&#x27;.text::text&#x27;</span>).extract_first()</span><br><span class="line">        autnor = quote.css(<span class="string">&#x27;.author::text&#x27;</span>).extract_first()</span><br><span class="line">        tags = quote.css(<span class="string">&#x27;.tags .tag::text&#x27;</span>).extract()</span><br></pre></td></tr></table></figure>

<p>先利用选择器选取所有的 quote，并将其赋值为 quotes 变量，然后利用 for 循环对每个 quote 遍历，解析每个 quote 内容</p>
<p>对 text 来说，它的 class 为 text，所以用 .text 选择器来选取，这个结果实际上是整个带有标签的节点，要获取正文内容，可以加 ::text 来获取，这时的结果是长度为 1 的列表，所以要用 extract_first() 方法来获取第一个元素；对 tags 来说，由于我们要获取所有的标签，所以用 extract() 方法获取整个列表即可</p>
<h5 id="使用-Item"><a href="#使用-Item" class="headerlink" title="使用 Item"></a>使用 Item</h5><p>解析结果赋值 Item 的每一个字段</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tutorial.items <span class="keyword">import</span> QuoteItem</span><br><span class="line">...</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">      quotes = response.css(<span class="string">&#x27;.quote&#x27;</span>)</span><br><span class="line">      <span class="keyword">for</span> quote <span class="keyword">in</span> quotes:</span><br><span class="line">          item = QuoteItem()</span><br><span class="line">          item[<span class="string">&#x27;text&#x27;</span>] = quote.css(<span class="string">&#x27;.text::text&#x27;</span>).extract_first()</span><br><span class="line">          item[<span class="string">&#x27;autnor&#x27;</span>] = quote.css(<span class="string">&#x27;.author::text&#x27;</span>).extract_first()</span><br><span class="line">          item[<span class="string">&#x27;tags&#x27;</span>] = quote.css(<span class="string">&#x27;.tags .tag::text&#x27;</span>).extract()</span><br><span class="line">          <span class="keyword">yield</span> item</span><br></pre></td></tr></table></figure>

<h5 id="后续-Request"><a href="#后续-Request" class="headerlink" title="后续 Request"></a>后续 Request</h5><p>上面操作实现了从初始页面抓取内容，下一页的内容需要从当前页面中找到信息来生成下一个请求</p>
<p>拉取页面到底部有个 Next 按钮，查看源码，它的链接是 /page/2/ 全链接是 <a target="_blank" rel="noopener" href="http://quotes.toscrape.com/page/2">http://quotes.toscrape.com/page/2</a> ，通过这个链接可以构造下一个请求</p>
<p>构造请求时需要用到 scrapy.Request，传递两个参数 url 和 callback</p>
<p>url：请求链接</p>
<p>callback：回调函数，会将请求的响应作为参数传递给这个回调函数，回调函数进行解析或生成下一个请求</p>
<p>修改后完整 Spider 类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">from</span> tutorial.items <span class="keyword">import</span> QuoteItem</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QuotesSpider</span>(<span class="params">scrapy.Spider</span>):</span></span><br><span class="line">  name = <span class="string">&#x27;quotes&#x27;</span></span><br><span class="line">  allowed_domains = [<span class="string">&#x27;quotes.toscrape.com&#x27;</span>]</span><br><span class="line">  start_urls = [<span class="string">&#x27;http://quotes.toscrape.com/&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">      quotes = response.css(<span class="string">&#x27;.quote&#x27;</span>)</span><br><span class="line">      <span class="keyword">for</span> quote <span class="keyword">in</span> quotes:</span><br><span class="line">          item = QuoteItem()</span><br><span class="line">          item[<span class="string">&#x27;text&#x27;</span>] = quote.css(<span class="string">&#x27;.text::text&#x27;</span>).extract_first()</span><br><span class="line">          item[<span class="string">&#x27;autnor&#x27;</span>] = quote.css(<span class="string">&#x27;.author::text&#x27;</span>).extract_first()</span><br><span class="line">          item[<span class="string">&#x27;tags&#x27;</span>] = quote.css(<span class="string">&#x27;.tags .tag::text&#x27;</span>).extract()</span><br><span class="line">          <span class="keyword">yield</span> item</span><br><span class="line">      <span class="comment">#利用选择器生成下一页的请求</span></span><br><span class="line">      <span class="built_in">next</span> = response.css(<span class="string">&#x27;.pager .next a::attr(&quot;href&quot;)&#x27;</span>).extract_first()</span><br><span class="line">      <span class="comment">#urljoin()方法可以将相对URL构造成一个绝对的URL</span></span><br><span class="line">      url = response.urljoin(<span class="built_in">next</span>)</span><br><span class="line">      <span class="comment">#返回下一页请求</span></span><br><span class="line">      <span class="keyword">yield</span>  scrapy.Request(url=url, callback=self.parse)</span><br></pre></td></tr></table></figure>

<h5 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h5><p>进入目录运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy crawl quotes</span><br></pre></td></tr></table></figure>

<p>运行后 Scrapy 输出当前的版本号及正在启动项目名称、settings.py  中一些重写后的配置、Middlewares、Pipelines</p>
<p>接下来就输出各个页面的抓取结果了</p>
<p>最后输出整个抓取过程的统计信息，请求字节数、请求次数、响应次数、完成原因等</p>
<h5 id="保存到文件"><a href="#保存到文件" class="headerlink" title="保存到文件"></a>保存到文件</h5><p>Scrapy 提供的 Feed Exports 可以将结果输出，如想将上面结果保存成 JSON 文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy crawl quotes -o quotes.json</span><br></pre></td></tr></table></figure>

<p>还可以每一个 Item 输出一行 JSON，输出后缀为 jl，为 jsonline 的缩写</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scrapy crawl quotes -o quotes.jl</span><br><span class="line">或者 </span><br><span class="line">scrapy crawl quotes -o quotes.jsonline</span><br></pre></td></tr></table></figure>

<p>输出格式还支持很多种，如 csv、xml、pickle、marshal 等，还支持 ftp、s3等远程输出，还可以通过自定义 ItemExporter 来实现其他的输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">scrapy crawl quotes -o quotes.csv</span><br><span class="line">scrapy crawl quotes -o quotes.xml</span><br><span class="line">scrapy crawl quotes -o quotes.pickle</span><br><span class="line">scrapy crawl quotes -o quotes.marshal</span><br><span class="line">scrapy crawl quotes -o ftp:&#x2F;&#x2F;user:pass@ftp.example.com&#x2F;path&#x2F;to&#x2F;quotes.csv</span><br></pre></td></tr></table></figure>

<p>通过 Scrapy 提供的 FeedExports，可以轻松的输出抓取结果到文件，想要更复杂的输出，如输出到数据库，可以使用 ItemPileline 来完成</p>
<h5 id="使用-Item-Pipeline"><a href="#使用-Item-Pipeline" class="headerlink" title="使用 Item Pipeline"></a>使用 Item Pipeline</h5><p>Item Pipeline 为项目管道，Item 生成后，它会自动被送到 Item Pipeline 进行处理，常用 Item Pipeline 来做如下操作</p>
<p>清理 HTML 数据、验证爬取数据，检查爬取字段、查重并丢弃重复内容、将爬取结果保存到数据库</p>
<p>要实现 Item Pipeline，只需要定义一个类并实现 process_item() 方法，启用 Item Pipeline 后，Item Pipeline 会自动调用这个方法，process_item() 方法必须返回包含数据的字典或 Item 对象或者抛出 DropItem 异常</p>
<p>process_item() 有两个参数，一个参数是 item，每次 Spider 生成的 Item 都会作为参数传递过来，第二个参数是 Spider，就是 Spider 的实例</p>
<p>实现 Item Pipeline，筛掉 text 长度大于 50 的Item，并将结果保存到 MongoDB</p>
<p>修改项目里的 pipelines.py 文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.exceptions <span class="keyword">import</span> DropItem</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextPipeline</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">      self.limit = <span class="number">50</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">process_item</span>(<span class="params">self, item, spider</span>):</span></span><br><span class="line">      <span class="keyword">if</span> item[<span class="string">&#x27;text&#x27;</span>]:</span><br><span class="line">          <span class="keyword">if</span> <span class="built_in">len</span>(item[<span class="string">&#x27;text&#x27;</span>] &gt; self.limit):</span><br><span class="line">              <span class="comment">#截断后拼省略号返回</span></span><br><span class="line">              item[<span class="string">&#x27;text&#x27;</span>] = item[<span class="string">&#x27;text&#x27;</span>][<span class="number">0</span>:self.limit].rstrip() + <span class="string">&#x27;...&#x27;</span></span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">          <span class="keyword">return</span> DropItem(<span class="string">&#x27;Missing Text&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>接下来将处理后的 item 存入 MongoDB，定义另外一个 Pipeline，MongoPipeline</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymongo</span><br><span class="line"><span class="keyword">from</span> scrapy.exceptions <span class="keyword">import</span> DropItem</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MongoPipeline</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, mongo_uri, mongo_db</span>):</span></span><br><span class="line">      self.mongo_uri = mongo_uri</span><br><span class="line">      self.mongo_db = mongo_db</span><br><span class="line"><span class="meta">  @classmethod</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">from_crawler</span>(<span class="params">cls, crawler</span>):</span></span><br><span class="line">      <span class="keyword">return</span> cls(</span><br><span class="line">          mongo_uri=crawler.settings.get(<span class="string">&#x27;MONGO_URI&#x27;</span>),</span><br><span class="line">          mongo_db=crawler.settings.get(<span class="string">&#x27;MONGODB_DATABASE&#x27;</span>)</span><br><span class="line">      )</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">open_spider</span>(<span class="params">self, spider</span>):</span></span><br><span class="line">      self.cline = pymongo.MongoClient(self.mongo_uri)</span><br><span class="line">      self.db = self.cline[self.mongo_db]</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">process_item</span>(<span class="params">self, item, spider</span>):</span></span><br><span class="line">      name = item.__class__.__name__</span><br><span class="line">      self.db[name].insert(<span class="built_in">dict</span>(item))</span><br><span class="line">      <span class="keyword">return</span> item</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">close_spider</span>(<span class="params">self, spider</span>):</span></span><br><span class="line">      self.cline.close()</span><br></pre></td></tr></table></figure>

<p>MongoPipeline 实现了另外几个方法</p>
<p>from_crawler：是一个类方法，用 @classmethod 标识，是一种依赖注入的方式，参数是 crawler，通过 crawler 可以拿到全局配置的每个配置信息，全局配置 settings.py 定义了 MongoDB 连接需要的地址和数据库名称，拿到配置信息返回类对象即可，这方法主要用来获取 setting.py 中的配置</p>
<p>open_spider：当 Spider 开启时，这个方法被调用，上面程序中主要进行了一些初始化操作</p>
<p>close_spider：当 Spider 关闭时，这个方法被调用，上面程序中将数据库连接关闭</p>
<p>process_item() 方法则执行了数据库插入操作</p>
<p>定义好了 TextPipeline 和 MongoPipeline 两个类后，需要在 settings.py 中使用他们，MongoDB 的连接信息还需要定义</p>
<p>settings.py 中加入</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">TIME_PIPELINES = &#123;</span><br><span class="line">	<span class="string">&#x27;tutorial.pipelines.TextPipeline&#x27;</span>: <span class="number">300</span>,</span><br><span class="line">	<span class="string">&#x27;tutorial.pipelines.MongoPipeline&#x27;</span>: <span class="number">400</span></span><br><span class="line">&#125;</span><br><span class="line">MONGO_URI = <span class="string">&#x27;localhost&#x27;</span></span><br><span class="line">MONGO_DB = <span class="string">&#x27;tutorial&#x27;</span></span><br></pre></td></tr></table></figure>

<p>赋值 TIME_PIPELINES 字典，键名是 Pipeline 的类名称，键值是调用优先级，是一个数字，数字越小则对应 Pipeline 越先被调用</p>
<p>重新执行爬取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy crawl quotes</span><br></pre></td></tr></table></figure>

<h4 id="13-3-Selecotr-用法"><a href="#13-3-Selecotr-用法" class="headerlink" title="13.3 Selecotr 用法"></a>13.3 Selecotr 用法</h4><p>Scrapy 还提供了自己的数据提取方法，即 Selector，Selector 是基于 lxml 来构建的，支持 XPath 选择器、CSS 选择器以及正则表达式</p>
<h5 id="直接使用"><a href="#直接使用" class="headerlink" title="直接使用"></a>直接使用</h5><p>Selector 是一个可以独立使用的模块，可以利用 Selector 来构建一个选择器对象，然后调用它的相关方法 如</p>
<p>xpath()、css() 等来提取数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy <span class="keyword">import</span> Selector</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  body = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  &lt;html&gt;</span></span><br><span class="line"><span class="string">      &lt;head&gt;</span></span><br><span class="line"><span class="string">          &lt;title&gt;Hello World&lt;/title&gt;</span></span><br><span class="line"><span class="string">      &lt;/head&gt;</span></span><br><span class="line"><span class="string">  &lt;/html&gt;</span></span><br><span class="line"><span class="string">  &#x27;&#x27;&#x27;</span></span><br><span class="line">  selector = Selector(text=body)</span><br><span class="line">  title = selector.xpath(<span class="string">&#x27;//title/text()&#x27;</span>).extract_first()</span><br><span class="line">  title1 = selector.xpath(<span class="string">&#x27;//title/text()&#x27;</span>).extract()</span><br><span class="line">  title2 = selector.xpath(<span class="string">&#x27;//title/text()&#x27;</span>)</span><br><span class="line">  print(title)</span><br><span class="line">  print(title1)</span><br><span class="line">  print(title2)</span><br><span class="line"><span class="comment">#Hello World</span></span><br><span class="line"><span class="comment">#[&#x27;Hello World&#x27;]</span></span><br><span class="line"><span class="comment">#[&lt;Selector xpath=&#x27;//title/text()&#x27; data=&#x27;Hello World&#x27;&gt;]</span></span><br></pre></td></tr></table></figure>

<h5 id="Scrapy-shell"><a href="#Scrapy-shell" class="headerlink" title="Scrapy shell"></a>Scrapy shell</h5><p>借助 Scrapy shell 来模拟 Scrapy 请求的过程 ，讲解相关的提取方法</p>
<p>官方文档的样例来做演示 <a target="_blank" rel="noopener" href="https://docs.scrapy.org/en/latest/_static/selectors-sample1.html">https://docs.scrapy.org/en/latest/_static/selectors-sample1.html</a></p>
<p>开启 Scrapy shell</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy shell https:&#x2F;&#x2F;docs.scrapy.org&#x2F;en&#x2F;latest&#x2F;_static&#x2F;selectors-sample1.html</span><br></pre></td></tr></table></figure>

<p>就进入 Scrapy shell 模式，这过程其实是 Scrapy 发起了一次请求，请求的URL就是命令行下输入的 URL，然后把一些可操作的变量传递给我们，如request、response 等</p>
<img src="Python3网络爬虫开发实战-Scrapy框架使用/WeChatae25474d863d90da3fe12abbc4a54da0.png" alt="WeChatae25474d863d90da3fe12abbc4a54da0" style="zoom:80%;" />

<p>可以在命令模式下输入命令调用对象的一些操作方法，回车之后实时显示结果</p>
<p>查看页面源码</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">&#x27;http://example.com/&#x27;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Example website<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&#x27;images&#x27;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;image1.html&#x27;</span>&gt;</span>Name: My image 1 <span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;image1_thumb.jpg&#x27;</span> /&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;image2.html&#x27;</span>&gt;</span>Name: My image 2 <span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;image2_thumb.jpg&#x27;</span> /&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;image3.html&#x27;</span>&gt;</span>Name: My image 3 <span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;image3_thumb.jpg&#x27;</span> /&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;image4.html&#x27;</span>&gt;</span>Name: My image 4 <span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;image4_thumb.jpg&#x27;</span> /&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;image5.html&#x27;</span>&gt;</span>Name: My image 5 <span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;image5_thumb.jpg&#x27;</span> /&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="XPath-选择器"><a href="#XPath-选择器" class="headerlink" title="XPath 选择器"></a>XPath 选择器</h5><p>进入 Scrapy shell 之后，操作 response 这个变量来进行分析</p>
<p>response 有一个属性 selector，调用 response.selector 返回的内容就相当于用 response 的body 构造了一个 Selector 对象，通过这个 Selector 对象可以调用解析方法如 xpath()、css() 等</p>
<ul>
<li>查询嵌套查询</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#从html提取a节点</span><br><span class="line">&gt;&gt;&gt; result &#x3D; response.selector.xpath(&#39;&#x2F;&#x2F;a&#39;)</span><br><span class="line">&gt;&gt;&gt; result</span><br><span class="line">[&lt;Selector xpath&#x3D;&#39;&#x2F;&#x2F;a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image1.html&quot;&gt;Name: My image ...&#39;&gt;, </span><br><span class="line">&lt;Selector xpath&#x3D;&#39;&#x2F;&#x2F;a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image2.html&quot;&gt;Name: My image ...&#39;&gt;, </span><br><span class="line">&lt;Selector xpath&#x3D;&#39;&#x2F;&#x2F;a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image3.html&quot;&gt;Name: My image ...&#39;&gt;, </span><br><span class="line">&lt;Selector xpath&#x3D;&#39;&#x2F;&#x2F;a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image4.html&quot;&gt;Name: My image ...&#39;&gt;, </span><br><span class="line">&lt;Selector xpath&#x3D;&#39;&#x2F;&#x2F;a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image5.html&quot;&gt;Name: My image ...&#39;&gt;]</span><br><span class="line">#从a节点提取img节点</span><br><span class="line">&gt;&gt;&gt; result.xpath(&#39;.&#x2F;img&#39;)</span><br></pre></td></tr></table></figure>

<p>选择器前面加 . (点)，代表提取元素内部的数据，没有加点则代表从根节点开始提取</p>
<ul>
<li>提取内容</li>
</ul>
<p>Scrapy 提供了两个使用的快捷方法 </p>
<p>response.xpath() 和 response.css() 功能等同于 response.selector.xpath() 和 response.selector.css()</p>
<p>现在得到的是 SelectorList 类型的变量，该变量是由 Selector 对象组成的列表，可以用索引单独提取其中某个 Selector 元素</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; result[0]</span><br><span class="line">&lt;Selector xpath&#x3D;&#39;&#x2F;&#x2F;a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image1.html&quot;&gt;Name: My image ...&#39;&gt;</span><br></pre></td></tr></table></figure>

<p>提取内容 extract() 方法</p>
<p>加一层 /text() 就可以获取节点的内部文本，或者加一层 /@href 就可获取节点的 href 属性，@符号后面就是要获取的属性名称</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; result.extract()</span><br><span class="line">&gt;&gt;&gt; response.xpath(&#39;&#x2F;&#x2F;a&#x2F;text()&#39;).extract()</span><br></pre></td></tr></table></figure>

<ul>
<li>提取单个元素 extract_first() 不用担心数组越界问题</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#将第一个匹配结果取出来 extract_first()</span><br><span class="line">&gt;&gt;&gt; result.xpath(&#39;&#x2F;&#x2F;a[@href&#x3D;&quot;image1.html&quot;]&#x2F;text()&#39;).extract_first()</span><br></pre></td></tr></table></figure>

<ul>
<li>提取不到使用默认值</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; result.xpath(&#39;&#x2F;&#x2F;a[@href&#x3D;&quot;image1.html&quot;]&#x2F;text()&#39;).extract_first(&#39;Default Image&#39;)</span><br><span class="line">#默认值 Default Image</span><br></pre></td></tr></table></figure>

<h5 id="CSS-选择器"><a href="#CSS-选择器" class="headerlink" title="CSS 选择器"></a>CSS 选择器</h5><p>选取 a 节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; response.css(&#39;a&#39;)</span><br><span class="line">[&lt;Selector xpath&#x3D;&#39;descendant-or-self::a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image1.html&quot;&gt;Name: My image ...&#39;&gt;, &lt;Selector xpath&#x3D;&#39;descendant-or-self::a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image2.html&quot;&gt;Name: My image ...&#39;&gt;, &lt;Selector xpath&#x3D;&#39;descendant-or-self::a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image3.html&quot;&gt;Name: My image ...&#39;&gt;, &lt;Selector xpath&#x3D;&#39;descendant-or-self::a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image4.html&quot;&gt;Name: My image ...&#39;&gt;, &lt;Selector xpath&#x3D;&#39;descendant-or-self::a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image5.html&quot;&gt;Name: My image ...&#39;&gt;]</span><br><span class="line">&gt;&gt;&gt; response.css(&#39;a&#39;).extract()</span><br><span class="line">&gt;&gt;&gt; response.css(&#39;a&#39;).extract_first()</span><br></pre></td></tr></table></figure>

<ul>
<li>属性选择和嵌套选择</li>
</ul>
<p>查找 a 节点内部 img 节点，只需要加一个空格和img 即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; response.css(&#39;a[href&#x3D;&quot;image1.html&quot;]&#39;).extract()</span><br><span class="line">[&#39;&lt;a href&#x3D;&quot;image1.html&quot;&gt;Name: My image 1 &lt;br&gt;&lt;img src&#x3D;&quot;image1_thumb.jpg&quot;&gt;&lt;&#x2F;a&gt;&#39;]</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; response.css(&#39;a[href&#x3D;&quot;image1.html&quot;] img&#39;).extract()</span><br><span class="line">[&#39;&lt;img src&#x3D;&quot;image1_thumb.jpg&quot;&gt;&#39;]</span><br></pre></td></tr></table></figure>

<ul>
<li>节点内部文本和属性获取</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; response.css(&#39;a[href&#x3D;&quot;image1.html&quot;]::text&#39;).extract_first()</span><br><span class="line">&#39;Name: My image 1 &#39;</span><br><span class="line">&gt;&gt;&gt; response.css(&#39;a[href&#x3D;&quot;image1.html&quot;] img::attr(src)&#39;).extract_first()</span><br><span class="line">&#39;image1_thumb.jpg&#39;</span><br></pre></td></tr></table></figure>

<p>获取文本和属性要用 ::text 和 ::attr() 的写法</p>
<ul>
<li>CSS 选择器 XPath 选择器嵌套使用</li>
</ul>
<p>获取所有 img 节点的 src 属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; response.xpath(&#39;&#x2F;&#x2F;a&#39;).css(&#39;img&#39;).xpath(&#39;@src&#39;).extract()</span><br><span class="line">[&#39;image1_thumb.jpg&#39;, &#39;image2_thumb.jpg&#39;, &#39;image3_thumb.jpg&#39;, &#39;image4_thumb.jpg&#39;, &#39;image5_thumb.jpg&#39;]</span><br></pre></td></tr></table></figure>

<h5 id="正则匹配"><a href="#正则匹配" class="headerlink" title="正则匹配"></a>正则匹配</h5><p>Scrapy 还支持正则匹配</p>
<p>a 节点中文本类似于 Name: My image 1，现在提取 Name: 后面内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; response.xpath(&#39;&#x2F;&#x2F;a&#x2F;text()&#39;).re(&#39;Name:\s(.*)&#39;)</span><br><span class="line">[&#39;My image 1 &#39;, &#39;My image 2 &#39;, &#39;My image 3 &#39;, &#39;My image 4 &#39;, &#39;My image 5 &#39;]</span><br></pre></td></tr></table></figure>

<p>给 re() 方法传一个正则表达式，(.*) 就是要匹配的内容</p>
<p>同时存在两个分组，结果会按序输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; response.xpath(&#39;&#x2F;&#x2F;a&#x2F;text()&#39;).re(&#39;(.*?)\s(.*)&#39;)</span><br><span class="line">[&#39;Name:&#39;, &#39;My image 1 &#39;, &#39;Name:&#39;, &#39;My image 2 &#39;, &#39;Name:&#39;, &#39;My image 3 &#39;, &#39;Name:&#39;, &#39;My image 4 &#39;, &#39;Name:&#39;, &#39;My image 5 &#39;]</span><br></pre></td></tr></table></figure>

<p>类似 extract_first() 方法 re_first() 方法可以选择列表第一个元素</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; response.xpath(&#39;&#x2F;&#x2F;a&#x2F;text()&#39;).re_first(&#39;Name:\s(.*)&#39;)</span><br><span class="line">&#39;My image 1 &#39;</span><br></pre></td></tr></table></figure>

<p>response 对象不能直接调用 re() 和 re_first() ，如果想要对全文进行正则匹配，可以先调用 xpath() 方法再正则匹配</p>
<h4 id="13-4-Spider-用法"><a href="#13-4-Spider-用法" class="headerlink" title="13.4 Spider 用法"></a>13.4 Spider 用法</h4><h5 id="Spider-类"><a href="#Spider-类" class="headerlink" title="Spider 类"></a>Spider 类</h5><p>定义的 Spider 是继承自 scrapy.spiders.Spider</p>
<p>scrapy.spiders.Spider 类提供了 start_requests() 方法的默认实现，读取并请求 start_urls 属性，并根据返回的结果调用 parse() 方法解析结果。</p>
<p>name：爬虫名称，一般以网站域名名称来命名，Spider 爬取 mywebsite.com，命名为 mywebsite</p>
<p>allow_domains：允许爬取的域名，是可选配置，不在此范围的链接不会被跟进爬取</p>
<p>start_urls：起始 URL 列表，没有实现 start_requests() 方法时，默认会从这个列表开始抓取</p>
<p>custom_settings：一个字典，专属本 Spider 的配置，会覆盖全局的设置，此设置必须在初始化前被更新，必须定义成类变量</p>
<p>crawler：是由 from_crawler() 方法设置的，代表本 Spider 类对应的 Crawler 对象，Crawler 对象包含了很多项目组件，利用它可以获取项目一些配置信息，最常见的获取项目的设置信息，即 settings</p>
<p>settings：一个Settings 对象，利用它可以直接获取项目全局设置变量</p>
<ul>
<li>start_requests()</li>
</ul>
<p>此方法用于生成初始请求，必须返回一个可迭代对象。此方法会默认使用 start_urls 里面的URL 来构造 Request，而且 Request 是 GET请求方式，如果想在启动时以 POST 方式访问某个站点，可以直接重写这个方法，发送 POST 请求时使用 FormRequest</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImagesSpider</span>(<span class="params">Spider</span>):</span></span><br><span class="line">  name = <span class="string">&#x27;images&#x27;</span></span><br><span class="line">  allowed_domains = [<span class="string">&#x27;images.so.com&#x27;</span>]</span><br><span class="line">  start_urls = [<span class="string">&#x27;http://images.so.com/&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">start_requests</span>(<span class="params">self</span>):</span></span><br><span class="line">      data = &#123;<span class="string">&#x27;ch&#x27;</span>: <span class="string">&#x27;photography&#x27;</span>, <span class="string">&#x27;listtype&#x27;</span>: <span class="string">&#x27;new&#x27;</span>&#125;</span><br><span class="line">      base_url = <span class="string">&#x27;https://image.so.com/zjl?&#x27;</span></span><br><span class="line">      <span class="keyword">for</span> page <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, self.settings.get(<span class="string">&#x27;MAX_PAGE&#x27;</span>) + <span class="number">1</span>):</span><br><span class="line">          data[<span class="string">&#x27;sn&#x27;</span>] = page * <span class="number">30</span></span><br><span class="line">          <span class="comment">#利用urlencode()方法将字典转化为URL的GET参数</span></span><br><span class="line">          params = urlencode(data)</span><br><span class="line">          url = base_url + params</span><br><span class="line">          <span class="keyword">yield</span> Request(url, self.parse)</span><br></pre></td></tr></table></figure>

<ul>
<li>parse()</li>
</ul>
<p>当 Response 没指定回调函数时，该方法被调用，负责处理 Response，处理返回结果，并从中提取想要的数据和下一步请求。需要返回一个包含 Request 或 Item 的可迭代对象</p>
<p>close()：当 Spider 关闭时，该方法被调用，这里一般会定义释放资源的一些操作</p>
<h4 id="13-5-Downloader-Middleware"><a href="#13-5-Downloader-Middleware" class="headerlink" title="13.5 Downloader Middleware"></a>13.5 Downloader Middleware</h4><p>下载中间件，处于 Scrapy 的 Request 和 Response 之间的处理模块</p>
<p>Scheduler 从队列中拿出一个 Request 发送给 Downloader 执行下载，这过程会经过 Downloader Middlewares 的处理</p>
<p>当 Downloader 将 Request 下载完成得到的 Response 返回给 Spider 时会再次经过  Downloader Middlewares 处理</p>
<p>修改 User-Agent、处理重定向、设置代理、失败重试、设置Cookies等功能都需要借助  Downloader Middlewares 实现</p>
<p>Scrapy 已经提供了许多  Downloader Middlewares，比如失败重试、自动重定向等功能的 Middleware，被 DOWNLOADER_MIDDLEWARES_BASE 变量定义，是一个字典格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&#39;scrapy.downloadermiddlewares.robotstxt.RobotsTxtMiddleware&#39;: 100</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>键值是 优先级，数字越小会被优先调用</p>
<p>Scrapy 提供了一个设置变量 DOWNLOADER_MIDDLEWARES，直接修改这个变量就可以添加自己定义的  Downloader Middlewares</p>
<h5 id="核心方法"><a href="#核心方法" class="headerlink" title="核心方法"></a>核心方法</h5><p>每个  Downloader Middlewares 都定义了一个或多个方法的类，核心方法三个</p>
<p>process_request(request, spider)</p>
<p>process_response(request, response, spider)</p>
<p>process_exception(request, exception, spider)</p>
<p>只需要实现一个方法，就可以定义一个 Downloader Middlewares </p>
<ul>
<li>process_request(request, spider)</li>
</ul>
<p>Request 被 Scrapy 引擎调度给Downloader之前，会被调用</p>
<p>可以用 process_request 对 Request 方法进行处理。返回值必须为 None、Response对象、Request 对象之一，或者抛出 IgnoreRequest 异常</p>
<ul>
<li>process_response(request, response, spider)</li>
</ul>
<p>Downloader 执行 Request 下载之后，会得到对应的 Response，Scrapy 引擎便会将 Response 发送给 Spider 进行解析。发送之前，可以用 process_response 方法对 Response 进行处理。返回值必须为 None、Response对象、Request 对象之一，或者抛出 IgnoreRequest 异常</p>
<ul>
<li>process_exception(request, exception, spider)</li>
</ul>
<p>Downloader 或 process_rqeuest() 方法抛出异常时被调用</p>
<h5 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h5><p>新建项目</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy startproject scrapydownloadertest</span><br></pre></td></tr></table></figure>

<p>进入项目新建 Spider， 名为 httpbin</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd scrapydownloadertest</span><br><span class="line">scrapy genspider httpbin httpbin.org</span><br></pre></td></tr></table></figure>

<p>修改内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpbinSpider</span>(<span class="params">scrapy.Spider</span>):</span></span><br><span class="line">  name = <span class="string">&#x27;httpbin&#x27;</span></span><br><span class="line">  allowed_domains = [<span class="string">&#x27;httpbin.org&#x27;</span>]</span><br><span class="line">  start_urls = [<span class="string">&#x27;http://httpbin.org/get&#x27;</span>]</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">      self.logger.debug(response.text)</span><br></pre></td></tr></table></figure>

<p>运行  <code>scrapy crawl httpbin</code></p>
<p>运行结果包含 Scrapy 发送的 Request 信息 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> DEBUG: &#123;</span><br><span class="line">  &quot;args&quot;: &#123;&#125;,</span><br><span class="line">  &quot;headers&quot;: &#123;</span><br><span class="line">    &quot;Accept&quot;: &quot;text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8&quot;,</span><br><span class="line">    &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;,</span><br><span class="line">    &quot;Accept-Language&quot;: &quot;en&quot;,</span><br><span class="line">    &quot;Host&quot;: &quot;httpbin.org&quot;,</span><br><span class="line">    &quot;User-Agent&quot;: &quot;Scrapy&#x2F;2.4.1 (+https:&#x2F;&#x2F;scrapy.org)&quot;,</span><br><span class="line">    &quot;X-Amzn-Trace-Id&quot;: &quot;Root&#x3D;1-625fa44b-7de6f90f1696c8d44ba334ab&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;origin&quot;: &quot;14.155.91.98&quot;,</span><br><span class="line">  &quot;url&quot;: &quot;http:&#x2F;&#x2F;httpbin.org&#x2F;get&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>修改 User-Agent 两种方式</li>
</ul>
<p>第一种修改 settings 里的 USER_AGENT 变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">USERAGENT &#x3D; &#39;xxxx&#39;</span><br></pre></td></tr></table></figure>

<p>如果想设置更灵活，比如随机 User-Agent，需要借助 Downloader Middleware</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomUserAgentMiddleware</span>():</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">      self.user_agents = [</span><br><span class="line">          <span class="string">&#x27;xxx1&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;xxx2&#x27;</span>,</span><br><span class="line">      ]</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">process_request</span>(<span class="params">self, request, spider</span>):</span></span><br><span class="line">      request.headers[<span class="string">&#x27;User-Agent&#x27;</span>] = random.choice(self.user_agents)</span><br></pre></td></tr></table></figure>

<p>要使这个 Downloader Middleware 生效还要去调用它，在 settings.py 中，将 DOWNLOADER_MIDDLEWARES 取消注释</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DOWNLOADER_MIDDLEWARES = &#123;</span><br><span class="line"><span class="string">&#x27;scrapydownloadertest.middlewares.RandomUserAgentMiddleware&#x27;</span>: <span class="number">543</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次运行发现 User-Agent 被修改了 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">DEBUG: &#123;</span><br><span class="line">  &quot;args&quot;: &#123;&#125;,</span><br><span class="line">  &quot;headers&quot;: &#123;</span><br><span class="line">    &quot;Accept&quot;: &quot;text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8&quot;,</span><br><span class="line">    &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;,</span><br><span class="line">    &quot;Accept-Language&quot;: &quot;en&quot;,</span><br><span class="line">    &quot;Host&quot;: &quot;httpbin.org&quot;,</span><br><span class="line">    &quot;User-Agent&quot;: &quot;xxx2&quot;,</span><br><span class="line">    &quot;X-Amzn-Trace-Id&quot;: &quot;Root&#x3D;1-625fa838-4f44d9361feb25107824c407&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;origin&quot;: &quot;14.155.91.98&quot;,</span><br><span class="line">  &quot;url&quot;: &quot;http:&#x2F;&#x2F;httpbin.org&#x2F;get&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>修改响应</li>
</ul>
<p>RandomUserAgentMiddleware 中添加 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_response</span>(<span class="params">self, response, spider</span>):</span></span><br><span class="line">    response.status = <span class="number">201</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>

<p>再 Spider 的 parse() 方法添加输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.logger.debug(&#39;Status code:&#39; + str(response.status))</span><br></pre></td></tr></table></figure>

<h4 id="13-6-Spider-Middleware"><a href="#13-6-Spider-Middleware" class="headerlink" title="13.6 Spider Middleware"></a>13.6 Spider Middleware</h4><p>Spider Middleware 三个作用</p>
<p>Response 发送给 Spider 之前对 Response 进行处理</p>
<p>Request 发送给 Scheduler 之前对 Request 进行处理</p>
<p>Item 发送给 Item Pipeline 之前对 Item 进行处理</p>
<p>Scrapy 已经提供了许多 Spider Middleware，被 SPIDER_MIDDLEWARES_BASE 变量定义</p>
<p>Spider Middleware 4个核心方法，只需要实现其中一个方法就可以定义一个 Spider Middleware</p>
<ul>
<li>process_spider_input(response, spider)</li>
</ul>
<p>Response 被 Spider Middleware 处理时被调用</p>
<p>返回 None 或者抛出异常</p>
<ul>
<li>process_spider_output(response, result, spider)</li>
</ul>
<p>当 Spider 处理 Response 返回结果时被调用</p>
<p>必须返回包含 Request 或 Item 对象的可迭代对象</p>
<ul>
<li>process_spider_exception(response, exception, spider)</li>
</ul>
<p>Spider 或 process_spider_input 方法抛出异常时调用</p>
<ul>
<li>process_start_requests(start_requests, spider)</li>
</ul>
<h4 id="13-6-Item-Pipeline"><a href="#13-6-Item-Pipeline" class="headerlink" title="13.6 Item Pipeline"></a>13.6 Item Pipeline</h4><p>参考使用 Item Pipeline</p>
<h4 id="爬取-360摄影美图"><a href="#爬取-360摄影美图" class="headerlink" title="爬取 360摄影美图"></a>爬取 360摄影美图</h4><h5 id="构造请求"><a href="#构造请求" class="headerlink" title="构造请求"></a>构造请求</h5><h5 id="MongoDB存储"><a href="#MongoDB存储" class="headerlink" title="MongoDB存储"></a>MongoDB存储</h5><h5 id="MySQL-存储"><a href="#MySQL-存储" class="headerlink" title="MySQL 存储"></a>MySQL 存储</h5><h5 id="Image-Pipeline"><a href="#Image-Pipeline" class="headerlink" title="Image Pipeline"></a>Image Pipeline</h5><p>Scrapy 提供了专门处理下载的 Pipeline，包括下载文件和图片，下载过程支持异步和多线程</p>
<p>官方文档地址 <a target="_blank" rel="noopener" href="https://doc.scrapy.org/en/latest/topics/media-pipeline.html">https://doc.scrapy.org/en/latest/topics/media-pipeline.html</a></p>
<p>首先定义文件存储的路径，需要定义一个 IMAGES_STORE 变量，在settings.py 添加代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IMAGES_STORE &#x3D; &#39;.&#x2F;images&#39;</span><br></pre></td></tr></table></figure>

<p>下载的图片都会保存到当前路径的 images 子文件夹下</p>
<p>内置的 ImagesPipeline 会默认读取 Item 的 image_urls 字段，并认为字段是一个列表形式，它会遍历 Item 的 image_urls 字段，然后取出每个 URL 进行图片下载</p>
<p>现在生成的 Item 的图片链接字段并不是 image_urls 字段表示的，也不是列表形式，而是单个 URL</p>
<p>所以为了实现下载，需要重新定义下载部分逻辑，即要自定义 ImagePipeline，继承自内置的 ImagesPipeline</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImagePipeline</span>(<span class="params">ImagesPipeline</span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">file_path</span>(<span class="params">self, request, response=<span class="literal">None</span>, info=<span class="literal">None</span></span>):</span></span><br><span class="line">      url = request.url</span><br><span class="line">      file_name = url.split(<span class="string">&#x27;/&#x27;</span>)[<span class="number">-1</span>]</span><br><span class="line">      <span class="keyword">return</span> file_name</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">item_completed</span>(<span class="params">self, results, item, info</span>):</span></span><br><span class="line">      image_paths = [x[<span class="string">&#x27;path&#x27;</span>] <span class="keyword">for</span> ok, x <span class="keyword">in</span> results <span class="keyword">if</span> ok]</span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">not</span> image_paths:</span><br><span class="line">          <span class="keyword">raise</span> DropItem(<span class="string">&#x27;Image Downloaded Failed&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> item</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">get_media_requests</span>(<span class="params">self, item, info</span>):</span></span><br><span class="line">      <span class="keyword">yield</span> Request(item[<span class="string">&#x27;url&#x27;</span>])</span><br></pre></td></tr></table></figure>

<ul>
<li>get_media_requests</li>
</ul>
<p>第一个参数 item 是爬取生成的 Item 对象，将它的 url 字段取出来，然后直接生成 Request对象，将此 Request 加入到调度队列，等待被调度，执行下载</p>
<ul>
<li>file_path</li>
</ul>
<p>这个方法用来返回保存的文件名，直接将图片链接最后一部分当作文件名即可，用 split 函数分割拼接并提取最后一部分</p>
<ul>
<li>item_completed</li>
</ul>
<p>它是单个 Item 完成下载时的处理方法，并不是每张图都会下载成功，需要分析下载结果剔除下载失败的图片，没下载成功就不需要保存 Item 到数据库</p>
<p>方法第一个参数 results 就是该 Item 对应下载结果，是一个列表形式，列表每一个元素是一个元组，其中包含了下载成功或失败的信息</p>
<p>这里遍历下载结果找出所有成功的下载列表。</p>
<h4 id="13-8-Scrapy-对接-Selenium"><a href="#13-8-Scrapy-对接-Selenium" class="headerlink" title="13.8 Scrapy 对接 Selenium"></a>13.8 Scrapy 对接 Selenium</h4><p>Scrapy 抓取页面的方式和 requests 库类似，都是直接模拟 HTTP 请求</p>
<p>前面抓取 JavaScript 渲染的页面有两种方式。一种是分析 Ajax 请求，找到对应的接口抓取，Scrapy 同样也可以用这种方法抓取。另一种是用 Selenium 或 Splash 模拟浏览器进行抓取，不需要关心页面后台发生的请求，也不需要分析渲染过程，只需要关心页面最终结果，即可见即可爬</p>
<h5 id="对接-Selenium"><a href="#对接-Selenium" class="headerlink" title="对接 Selenium"></a>对接 Selenium</h5><p>对接 Selenium 进行抓取，采用 Downloader Middleware 来实现，在 Middleware 里面的 process_request() 方法里对每个抓取请求进行处理，启动浏览器进行页面渲染，再将渲染后的结果构造一个 HtmlResponse 对象返回</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.common.exceptions <span class="keyword">import</span> TimeoutException</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"><span class="keyword">from</span> scrapy.http <span class="keyword">import</span> HtmlResponse</span><br><span class="line"><span class="keyword">from</span> logging <span class="keyword">import</span> getLogger</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SeleniumMiddleware</span>():</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, timeout=<span class="literal">None</span>, service_args=[]</span>):</span></span><br><span class="line">      self.logger = getLogger(__name__)</span><br><span class="line">      self.timeout = timeout</span><br><span class="line">      self.browser = webdriver.PhantomJS(service_args=service_args)</span><br><span class="line">      self.browser.set_window_size(<span class="number">1400</span>, <span class="number">700</span>)</span><br><span class="line">      self.browser.set_page_load_timeout(self.timeout)</span><br><span class="line">      self.wait = WebDriverWait(self.browser, self.timeout)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__del__</span>(<span class="params">self</span>):</span></span><br><span class="line">      self.browser.close()</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">process_request</span>(<span class="params">self, request, spider</span>):</span></span><br><span class="line">      <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">      用PhantomJS抓取页面</span></span><br><span class="line"><span class="string">      :param request: Request对象</span></span><br><span class="line"><span class="string">      :param spider: Spider对象</span></span><br><span class="line"><span class="string">      :return: HtmlResponse</span></span><br><span class="line"><span class="string">      &quot;&quot;&quot;</span></span><br><span class="line">      self.logger.debug(<span class="string">&#x27;PhantomJS is Starting&#x27;</span>)</span><br><span class="line">      page = request.meta.get(<span class="string">&#x27;page&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">      <span class="keyword">try</span>:</span><br><span class="line">          self.browser.get(request.url)</span><br><span class="line">          <span class="keyword">if</span> page &gt; <span class="number">1</span>:</span><br><span class="line">              <span class="built_in">input</span> = self.wait.until(</span><br><span class="line">                  EC.presence_of_element_located((By.CSS_SELECTOR, <span class="string">&#x27;#mainsrp-pager div.form &gt; input&#x27;</span>)))</span><br><span class="line">              submit = self.wait.until(</span><br><span class="line">                  EC.element_to_be_clickable((By.CSS_SELECTOR, <span class="string">&#x27;#mainsrp-pager div.form &gt; span.btn.J_Submit&#x27;</span>)))</span><br><span class="line">              <span class="built_in">input</span>.clear()</span><br><span class="line">              <span class="built_in">input</span>.send_keys(page)</span><br><span class="line">              submit.click()</span><br><span class="line">          self.wait.until(</span><br><span class="line">              EC.text_to_be_present_in_element((By.CSS_SELECTOR, <span class="string">&#x27;#mainsrp-pager li.item.active &gt; span&#x27;</span>), <span class="built_in">str</span>(page)))</span><br><span class="line">          self.wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, <span class="string">&#x27;.m-itemlist .items .item&#x27;</span>)))</span><br><span class="line">          <span class="keyword">return</span> HtmlResponse(url=request.url, body=self.browser.page_source, request=request, encoding=<span class="string">&#x27;utf-8&#x27;</span>,</span><br><span class="line">                              status=<span class="number">200</span>)</span><br><span class="line">      <span class="keyword">except</span> TimeoutException:</span><br><span class="line">          <span class="keyword">return</span> HtmlResponse(url=request.url, status=<span class="number">500</span>, request=request)</span><br><span class="line"></span><br><span class="line"><span class="meta">  @classmethod</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">from_crawler</span>(<span class="params">cls, crawler</span>):</span></span><br><span class="line">      <span class="keyword">return</span> cls(timeout=crawler.settings.get(<span class="string">&#x27;SELENIUM_TIMEOUT&#x27;</span>),</span><br><span class="line">                 service_args=crawler.settings.get(<span class="string">&#x27;PHANTOMJS_SERVICE_ARGS&#x27;</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>process_request() 方法中，通过 Request 的 meta 属性获取当前需要爬取的页码，调用 PhantomJS 对象的 get() 方法访问 Request 对应的 URL，相当于从 Request 对象里获取请求链接，然后再用 PhantomJS 加载，而不再用 Scrapy 里的 Downloader</p>
<h5 id="解析页面"><a href="#解析页面" class="headerlink" title="解析页面"></a>解析页面</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">	products = response.xpath(..)</span><br><span class="line">	...</span><br></pre></td></tr></table></figure>

<p>使用 XPath 进行解析，调用 response 变量的 xpath() 方法</p>
<h4 id="13-9-Scrapy-对接-Splash"><a href="#13-9-Scrapy-对接-Splash" class="headerlink" title="13.9 Scrapy 对接 Splash"></a>13.9 Scrapy 对接 Splash</h4><p>Splash 和 Scrapy 都支持异步处理</p>
<p>在 Selenium 的对接过程中，每个页面的渲染下载是在 Downloader Middleware 里完成的，所以整个过程是阻塞式的。Scrapy 会等待这个过程完成后再继续处理和调度其它请求，影响了爬取效率，因此使用 Splash 的爬取效率币 Selenium 高很多</p>
<h4 id="13-10-通用爬虫"><a href="#13-10-通用爬虫" class="headerlink" title="13.10 通用爬虫"></a>13.10 通用爬虫</h4><h5 id="CrawSpider"><a href="#CrawSpider" class="headerlink" title="CrawSpider"></a>CrawSpider</h5><p>官方文档 <a target="_blank" rel="noopener" href="https://docs.scrapy.org/en/latest/topics/spiders.html#crawlspider">https://docs.scrapy.org/en/latest/topics/spiders.html#crawlspider</a></p>
<p>Scrapy 提供的一个通用爬虫，在 Spider 里，可以指定一些爬取规则来实现页面的提取，这些爬取规则由一个专门 的数据结构 Rule 表示，Rule 里包含提取和跟进页面的配置，Spider 会根据 Rule 来确定当前页面中的哪些链接需要继续爬取、哪些页面的爬取结果需要用哪个方法解析</p>
<p>CrawlSpider 类继承自 Spider 类</p>
<p>rules：爬取规则属性，是包含一个或多个 Rule 对象的列表。每个 Rule 对爬取网站的动作都做了定义，CrawlSpider 会读取 rules 的每一个 Rule 并进行解析</p>
<p>parse_start_url()：是一个可重写的方法，当 start_urls 里对应的 Request 得到 Response 时，该方法被调用，会解析 Response 并必须返回 Item 对象或者 Request 对象</p>
<h6 id="Rule"><a href="#Rule" class="headerlink" title="Rule"></a>Rule</h6><p>定义页面的爬取逻辑</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">scrapy</span>.<span class="title">contrib</span>.<span class="title">spiders</span>.<span class="title">Rule</span>(<span class="params">link_extractor, callback=<span class="literal">None</span>, cb_kwargs=<span class="literal">None</span>, follow=<span class="literal">None</span>, process_links=<span class="literal">None</span>, process_request=<span class="literal">None</span></span>)</span></span><br></pre></td></tr></table></figure>

<p>link_extractor：LinkExtractor 对象，通过它，Spider 可以知道从爬取的页面中提取哪些链接，提取的链接会自动生成 Request，一般常用 LxmlLinkExtractor 对象作为参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LxmlLinkExtractor</span>(<span class="params">FilteringLinkExtractor</span>):</span></span><br><span class="line">  	<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  	allow 正则表达式或正则表达式列表，定义从当前页面提取出的链接哪些是符合要求的，只有符合要求的链接才会被跟进；deny 则相反</span></span><br><span class="line"><span class="string">  	allow_domains 定义了符合要求的域名，在此域名的链接才会被跟进生成新的Request；deny_domains相反</span></span><br><span class="line"><span class="string">  	restrict_xpaths 从当前页面中XPath匹配的区域提取链接，值是XPath表达式或XPath表达式列表</span></span><br><span class="line"><span class="string">  	restrict_css 从当前页面中CSS选择器匹配的区域提取链接，值是CSS选择器或CSS选择器列表</span></span><br><span class="line"><span class="string">  	&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        self,</span></span></span><br><span class="line"><span class="function"><span class="params">        allow=(<span class="params"></span>),</span></span></span><br><span class="line"><span class="function"><span class="params">        deny=(<span class="params"></span>),</span></span></span><br><span class="line"><span class="function"><span class="params">        allow_domains=(<span class="params"></span>),</span></span></span><br><span class="line"><span class="function"><span class="params">        deny_domains=(<span class="params"></span>),</span></span></span><br><span class="line"><span class="function"><span class="params">        restrict_xpaths=(<span class="params"></span>),</span></span></span><br><span class="line"><span class="function"><span class="params">        tags=(<span class="params"><span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;area&#x27;</span></span>),</span></span></span><br><span class="line"><span class="function"><span class="params">        attrs=(<span class="params"><span class="string">&#x27;href&#x27;</span>,</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">        canonicalize=<span class="literal">False</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        unique=<span class="literal">True</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        process_value=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        deny_extensions=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        restrict_css=(<span class="params"></span>),</span></span></span><br><span class="line"><span class="function"><span class="params">        strip=<span class="literal">True</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        restrict_text=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    </span>):</span></span><br></pre></td></tr></table></figure>

<p>callback：回调函数，每次从 link_extractor 中获取到链接时，该函数会被调用</p>
<p>避免使用 parse() 作为回调函数，由于 CrawlSpider 使用 parse() 方法来实现逻辑，如果 parse() 方法被覆盖了，CrawlSpider 将会运行失败</p>
<p>cb_kwargs：字典，它包含传递给回调函数的参数</p>
<p>follow：True 或 False，指定跟进规则从 Response 提取的链接是否需要跟进，如果 callback 为 None，follow 默认设置为 True，否则默认为 False</p>
<p>True，下一页的页面如果请求成功了就需要继续像上一个一样分析，代表继续跟进匹配分析</p>
<p>。。。</p>
<h6 id="Item-Loader"><a href="#Item-Loader" class="headerlink" title="Item Loader"></a>Item Loader</h6><p>提供一种便捷的机制帮助我们方便地提取 Item</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">scrapy</span>.<span class="title">loader</span>.<span class="title">ItemLoader</span>(<span class="params">[item, selector, response,] **kwargs</span>)</span></span><br><span class="line"><span class="class">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="class"><span class="title">item</span>:</span> Item对象，可以调用add_xpath()、add_css()、add_value()等方法来填充 Item对象</span><br><span class="line">selector: 是Selector对象，用来提取填充数据的选择器</span><br><span class="line">response: 是Response对象，用来使用构造选择器的Response</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>一个比较典型的Item Loader</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.loader <span class="keyword">import</span> ItemLoader</span><br><span class="line"><span class="keyword">from</span> project.items <span class="keyword">import</span> Product</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">loader = ItemLoader(item=Product(), response=response)</span><br><span class="line">loader.add_xpath(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;//div[@class=&quot;procuct_name&quot;]&#x27;</span>)</span><br><span class="line">loader.add_css(<span class="string">&#x27;stock&#x27;</span>, <span class="string">&#x27;p#stock&#x27;</span>)</span><br><span class="line">loader.add_value(<span class="string">&#x27;last_update&#x27;</span>, <span class="string">&#x27;today&#x27;</span>)</span><br><span class="line"><span class="keyword">return</span> loader.load_item()</span><br></pre></td></tr></table></figure>

<p>Item Loader 每个字段中都包含了一个 Input Processor(输入处理器) 和 一个 Output Processor(输出处理器)</p>
<p>InputProcessor 收到数据时立刻提取数据，保存到 ItemLoader 内，但不会分配给Item load_item 调用来生成 Item 对象。调用时会先调用  Output Processor 来处理之前收集到的数据，然后在存入 Item 中</p>
<p>一些内置 Processor</p>
<ul>
<li>Identity</li>
</ul>
<p>最简单的 Processor，不进行任何处理，直接返回原来的数据</p>
<ul>
<li>TakeFirst</li>
</ul>
<p>返回列表的第一个非空值，类似 extract_firs() 的功能，常用作 Output Processor</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.loader.processor <span class="keyword">import</span> TakeFirst</span><br><span class="line">processor = TakeFirst()</span><br><span class="line">print([<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>]) </span><br><span class="line"><span class="comment">#结果：输出 1</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Join</li>
</ul>
<p>相当于字符串的 join()方法，可以把列表拼合成字符串，字符串默认使用空格分隔</p>
<p>也可以通过参数更改默认分隔符</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.loader.processor <span class="keyword">import</span> Join</span><br><span class="line">processor = Join()</span><br><span class="line">print(processor([<span class="string">&#x27;one&#x27;</span>, <span class="string">&#x27;two&#x27;</span>, <span class="string">&#x27;three&#x27;</span>]))</span><br><span class="line"><span class="comment">#结果： one two three</span></span><br><span class="line">processor = Join(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line"><span class="comment">#结果： one,two,three</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Compose</li>
</ul>
<p>是用给定的多个函数的组合而构造的 Processor，每个输入值被传递到第一个函数，其输出再传递到第二个函数，依次类推，知道最后一个函数返回整个处理器的输出</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.loader.processor <span class="keyword">import</span> Compose</span><br><span class="line">processor = Compose(<span class="built_in">str</span>.upper, <span class="keyword">lambda</span> s: s.strip())</span><br><span class="line">print(processor(<span class="string">&#x27; hello world&#x27;</span>))</span><br><span class="line"><span class="comment">#结果：HELLO WORLD</span></span><br></pre></td></tr></table></figure>

<p>第一个参数 str.upper，第二个是一个匿名函数，strip() 方法去除头尾空白字符，Compose 会顺次调用两个参数</p>
<ul>
<li>MapCompose</li>
</ul>
<p>与 Compose 类似，MapCompose可以迭代处理一个列表输入值</p>
<p>被处理对象是一个可迭代对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.loader.processor <span class="keyword">import</span> MapCompose</span><br><span class="line">processor = MapCompose(<span class="built_in">str</span>.upper, <span class="keyword">lambda</span> s: s.strip())</span><br><span class="line">print(processor([<span class="string">&#x27;Hello&#x27;</span>, <span class="string">&#x27;world&#x27;</span>, <span class="string">&#x27;Python&#x27;</span>]))</span><br><span class="line"><span class="comment">#结果：[&#x27;HELLO&#x27;, &#x27;WORLD&#x27;, &#x27;PYTHON&#x27;]</span></span><br></pre></td></tr></table></figure>

<ul>
<li>SelectJmes</li>
</ul>
<p>SelectJmes 可以查询 JSON，传入 Key，返回查询所得到的 Value，要安装 jmespath 库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install jmespath</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.loader.processor <span class="keyword">import</span> SelectJmes</span><br><span class="line">processor = SeleJme(<span class="string">&#x27;foo&#x27;</span>)</span><br><span class="line">print(processor(&#123;<span class="string">&#x27;foo&#x27;</span>: <span class="string">&#x27;bar&#x27;</span>&#125;))</span><br><span class="line"><span class="comment">#结果：bar</span></span><br></pre></td></tr></table></figure>





<h5 id="爬取中华网科技类新闻"><a href="#爬取中华网科技类新闻" class="headerlink" title="爬取中华网科技类新闻"></a>爬取中华网科技类新闻</h5><p><a target="_blank" rel="noopener" href="https://tech.china.com/articles/">https://tech.china.com/articles/</a> 爬取新闻列表中所有分页的新闻详情，包括标题、正文、时间、来源</p>
<h6 id="新建项目"><a href="#新建项目" class="headerlink" title="新建项目"></a>新建项目</h6><p>新建 Scrapy 项目，名为 scrapyuniversal</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy startproject scrapyuniversal</span><br></pre></td></tr></table></figure>

<p>创建一个 CrawlSpider，需要先指定一个模板，看看哪些模板可用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">scrapy genspider -l</span><br><span class="line">#运行结果</span><br><span class="line">Available templates:</span><br><span class="line">  basic</span><br><span class="line">  crawl</span><br><span class="line">  csvfeed</span><br><span class="line">  xmlfeed</span><br></pre></td></tr></table></figure>

<p>创建 Spider 的时候默认使用了第一个模板 basic，要创建 CrawlSpider 选择 crawl 模板</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy genspider -t crawl china tech.china.com</span><br></pre></td></tr></table></figure>

<p>生成的 Spider 内容多了一个 rules，回调函数不再是 parse，而是 parse_item</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rules = (</span><br><span class="line">    Rule(LinkExtractor(allow=<span class="string">r&#x27;Items/&#x27;</span>), callback=<span class="string">&#x27;parse_item&#x27;</span>, follow=<span class="literal">True</span>),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h6 id="定义-Rule"><a href="#定义-Rule" class="headerlink" title="定义 Rule"></a>定义 Rule</h6><p>要实现新闻的爬取，需要做的就是定义好 Rule，然后实现解析函数</p>
<p>修改 start_urls </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start_urls = [<span class="string">&#x27;http://tech.china.com/articles/&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>Spider 爬取 start_urls 里的每一个链接，得到 Response 之后，Spider 就会根据 Rule 里来提取这个页面内的超链接，去生成进一步的 Request，接下来定义 Rule 来指定提取哪些链接</p>
<p>将新闻列表中每条新闻的详情链接提取出来</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;wntjItem item_defaultView clearfix&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;item_con&quot;</span> <span class="attr">style</span>=<span class="string">&quot;margin-left: 0px;&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;item-con-inner&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">&quot;tit&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://tech.china.com/article/20220224/202202241016344.html&quot;</span> <span class="attr">target</span>=<span class="string">&quot;_blank&quot;</span>&gt;</span>世界首台量子重力仪“走出实验室”，对学界、业界和国家安全等将具有深远影响<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;item_foot&quot;</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;time&quot;</span>&gt;</span>2022-02-24 05:59<span class="tag">&lt;/<span class="name">span</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;tag&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;item_num&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;s-nub&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以用 LinkExtractor 的 restrict_xpaths 属性来指定，之后 Spider 就会从这个区域提取所有超链接生成 Request。</p>
<p>但是每篇文章的导航中可能还有一些其它超链接标签，我们只需要新闻的超链接，真正新闻超链接路径都是以article开头的，用一个正则表达式将其匹配出来再赋值给 allow 即可，还需要指定一个回调函数 callback</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rules = (</span><br><span class="line">  Rule(LinkExtractor(allow=<span class="string">&#x27;article\/.*\.html&#x27;</span>, restrict_xpaths=<span class="string">&#x27;//[@id=&quot;rank-defList&quot;]//[@class=&quot;tit&quot;]&#x27;</span>), callback=<span class="string">&#x27;parse_item&#x27;</span>, follow=<span class="literal">True</span>),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>还要让当前页面实现分页功能，所以还需要提取下一页的链接</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;pages&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;a1&quot;</span>&gt;</span>12219条<span class="tag">&lt;/<span class="name">a</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://tech.china.com/articles/index.html&quot;</span> <span class="attr">class</span>=<span class="string">&quot;a1&quot;</span>&gt;</span>上一页<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span>&gt;</span>1<span class="tag">&lt;/<span class="name">span</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://tech.china.com/articles/index_2.html&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">a</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://tech.china.com/articles/index_9.html&quot;</span>&gt;</span>9<span class="tag">&lt;/<span class="name">a</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://tech.china.com/articles/index_10.html&quot;</span>&gt;</span>10<span class="tag">&lt;/<span class="name">a</span>&gt;</span> ..</span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://tech.china.com/articles/index_489.html&quot;</span>&gt;</span>489<span class="tag">&lt;/<span class="name">a</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://tech.china.com/articles/index_2.html&quot;</span> <span class="attr">class</span>=<span class="string">&quot;a1&quot;</span>&gt;</span>下一页<span class="tag">&lt;/<span class="name">a</span>&gt;</span>	</span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>再加一个 Rule</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rule(LinkExtractor(restrict_xpaths=<span class="string">&#x27;//div[@class=&quot;pages&quot;]//a[contains(., &quot;下一页&quot;)]&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>不需要像新闻详情页一样去提取页面详细信息，也就是不需要生成 Item，所以不需要加 callback 参数</p>
<p>接着运行代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy crawl china</span><br></pre></td></tr></table></figure>

<p>查看输出，实现了翻页和详情页的抓取了</p>
<h6 id="解析页面-1"><a href="#解析页面-1" class="headerlink" title="解析页面"></a>解析页面</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_item</span>(<span class="params">self, response</span>):</span></span><br><span class="line">    loader = ChinaLoader(item=NewsItem(), response=response)</span><br><span class="line">    loader.add_xpath(<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;//h1[@id=&quot;chan_newsTitle&quot;]/text()&#x27;</span>)</span><br><span class="line">    loader.add_value(<span class="string">&#x27;url&#x27;</span>, response.url)</span><br><span class="line">    loader.add_xpath(<span class="string">&#x27;text&#x27;</span>, <span class="string">&#x27;//div[@id=&quot;chan_newsDetail&quot;]/text()&#x27;</span>)</span><br><span class="line">    loader.add_xpath(<span class="string">&#x27;datetime&#x27;</span>, <span class="string">&#x27;//div[@id=&quot;chan_newsInfo&quot;]//*[@class=&quot;time&quot;]/text()&#x27;</span>,re=<span class="string">&#x27;(\d+-\d+-\d+\s\d+:\d+:\d+)&#x27;</span>)</span><br><span class="line">    loader.add_xpath(<span class="string">&#x27;source&#x27;</span>, <span class="string">&#x27;//div[@id=&quot;chan_newsInfo&quot;]//*[@class=&quot;source&quot;]/text()&#x27;</span>, re=<span class="string">&#x27;来源：(.*)&#x27;</span>)</span><br><span class="line">    loader.add_value(<span class="string">&#x27;website&#x27;</span>, <span class="string">&#x27;中华网&#x27;</span>)</span><br><span class="line">    <span class="keyword">yield</span> loader.load_item()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.loader <span class="keyword">import</span> ItemLoader</span><br><span class="line"><span class="keyword">from</span> scrapy.loader.processors <span class="keyword">import</span> TakeFirst, Join, Compose</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NewsLoader</span>(<span class="params">ItemLoader</span>):</span></span><br><span class="line">  default_output_processor = TakeFirst()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChinaLoader</span>(<span class="params">NewsLoader</span>):</span></span><br><span class="line">  text_out = Compose(Join(), <span class="keyword">lambda</span> s: s.strip()) <span class="comment">#把列表拼合成一个字符串</span></span><br><span class="line">  source_out = Compose(Join(), <span class="keyword">lambda</span> s: s.strip())</span><br></pre></td></tr></table></figure>

<h6 id="通用配置抽取"><a href="#通用配置抽取" class="headerlink" title="通用配置抽取"></a>通用配置抽取</h6><h4 id="13-11-Scrapyt"><a href="#13-11-Scrapyt" class="headerlink" title="13.11 Scrapyt"></a>13.11 Scrapyt</h4><p>Scrapyt 为 Scrapy 提供了一个调度的 HTTP 接口，有了它就不需要再执行 Scrapy 命令，而是通过请求一个 HTTP 接口即可调度 Scrapy 任务，如果项目是在远程服务器运行，可以利用它来启动项目</p>
<h5 id="GET-请求"><a href="#GET-请求" class="headerlink" title="GET 请求"></a>GET 请求</h5><p>支持如下参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">spider_name：Spider 名称</span></span><br><span class="line"><span class="string">url：爬取链接，如果传递了该参数，Scrapy会直接使用该URL生成Request，而直接忽略start_requests()方法和start_urls属性的定义</span></span><br><span class="line"><span class="string">callback：回调函数名称</span></span><br><span class="line"><span class="string">max_requests：最大请求数量，可选，如定义5，表示最多执行5次Request请求，其余会被忽略</span></span><br><span class="line"><span class="string">start_requests：是否要执行start_requests方法，布尔类型，可选，Scrapy项目中如果定义了start_requests方法，项目启动时会默认调用该方法，Scrapyrt中就不一样，默认不执行start_requests方法，如果要执行start_requests，设置为true</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>在项目目录下运行 Scrapyrt，默认服务运行在 9080 端口上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:9080&#x2F;crawl.json\?spider_name\&#x3D;china\&amp;url\&#x3D;http:&#x2F;&#x2F;tech.china.com&#x2F;articles&#x2F;</span><br></pre></td></tr></table></figure>

<p>会返回一个 JSON 格式，status 显示了爬取状态，items 部分是项目的爬取结果，stats 是爬取的统计情况，items_dropped 是被忽略的 Item 列表</p>
<h5 id="POST-请求"><a href="#POST-请求" class="headerlink" title="POST 请求"></a>POST 请求</h5><p>Request Body 必须是一个合法的JSON配置，JSON里面可以配置响应的参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">spider_name</span></span><br><span class="line"><span class="string">max_requests</span></span><br><span class="line"><span class="string">request: Request配置，JSON对象，必传参数，通过该参数可以定义Request的各个参数，必须指定url字段指定爬取链接,其它参数可选</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>JSON配置实例</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;request&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;http://quotes.toscrape.com/&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;callback&quot;</span>: <span class="string">&quot;parse&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dont_filter&quot;</span>: <span class="string">&quot;True&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;cookies&quot;</span>:&#123;</span><br><span class="line">      <span class="attr">&quot;foo&quot;</span>: <span class="string">&quot;bar&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;max_requests&quot;</span>:<span class="number">2</span>,</span><br><span class="line">  <span class="attr">&quot;spider_name&quot;</span>:quotes</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行下面命令传递该JSON配置并发起POST请求</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:9080&#x2F;crawl.json -d &#39;&#123;&quot;requests&quot;...JSON字符串&#125;&#39;</span><br></pre></td></tr></table></figure>

<h4 id="Scrapy对接Docker"><a href="#Scrapy对接Docker" class="headerlink" title="Scrapy对接Docker"></a>Scrapy对接Docker</h4><p>把 Scrapy 项目制作成一个 Docker 镜像，只要其它主机安装了 Docker，那么只要将镜像下载并运行即可，而不必担心环境问题或版本问题</p>
<h5 id="创建Dockerfile"><a href="#创建Dockerfile" class="headerlink" title="创建Dockerfile"></a>创建Dockerfile</h5><p>项目根目录下新建 requirements.txt，将整个项目依赖的 Python 环境包都列出来，如</p>
<p>如果库需要特定的版本，还可以指定版本号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">scrapy</span><br><span class="line">pymongo</span><br><span class="line">scrapy&gt;&#x3D;1.4.0</span><br><span class="line">pymongo&gt;&#x3D;3.4.0</span><br></pre></td></tr></table></figure>

<p>根目录下新建 Dockerfile 没有后缀，修改内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FROM python:3.8 </span><br><span class="line">ENV PATH &#x2F;usr&#x2F;local&#x2F;bin:$PATH</span><br><span class="line">ADD . &#x2F;code</span><br><span class="line">WORKDIR &#x2F;code</span><br><span class="line">RUN pip3.8 install -r requirements.txt</span><br><span class="line">CMD scrapy crawl china</span><br><span class="line">#第一行From代表使用 Docker 基础镜像，这里直接使用 python:3.8的镜像，在此基础上运行项目</span><br><span class="line">#第二行ENV是环境变量设置，增加&#x2F;usr&#x2F;local&#x2F;bin这个环境变量路径</span><br><span class="line">#第三行ADD是将本地的代码放置到虚拟容器中 .本地当前路径 &#x2F;code代表虚拟容器中的路径</span><br><span class="line">#第四行WORKDIR是指定工作目录，这里将刚添加的代码路径设置成工作路径</span><br><span class="line">#第五行RUN是执行某些命令来做一些环境准备工作</span><br><span class="line">#第六行CMD是容器启动命令，容器运行时，此命令会被执行</span><br></pre></td></tr></table></figure>

<h5 id="构建镜像"><a href="#构建镜像" class="headerlink" title="构建镜像"></a>构建镜像</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t china:latest .</span><br></pre></td></tr></table></figure>

<p>构建成功后，查看镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br><span class="line">#china latest 41c797934ce 2 minutes ago 768M</span><br></pre></td></tr></table></figure>

<h5 id="运行-1"><a href="#运行-1" class="headerlink" title="运行"></a>运行</h5><p>镜像可以本地测试运行，这样就利用此镜像新建并运行了一个 Docker 容器，运行效果完全一致</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run china</span><br></pre></td></tr></table></figure>

<h5 id="推送至-Docker-Hub"><a href="#推送至-Docker-Hub" class="headerlink" title="推送至 Docker Hub"></a>推送至 Docker Hub</h5><p>构建完成后，可以将镜像 Push 到 Docker 镜像托管平台，Docker Hub 或者私有的 Docker Registry 等，这样就可以从远程服务器下载镜像并运行了</p>
<p><a target="_blank" rel="noopener" href="https://hub.docker.com/">https://hub.docker.com</a> 注册账号，新建一个 Reponsitory，名为 quotes，比如用户名为 germey，那么此 Reponsitory 的地址就可以用 germey/quotes 来表示</p>
<p>打标签，推送镜像到 Docker Hub</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker tag quotes:latest germey&#x2F;quotes:latest</span><br><span class="line">docker push germey&#x2F;quotes</span><br></pre></td></tr></table></figure>

<p>如果我们想在其他的主机上运行这个镜像，主机上装好 Docker 后，运行命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run germey&#x2F;quotes</span><br></pre></td></tr></table></figure>

<p>会自动下载镜像，启动容器运行，不需要配置 Python 环境，不需要关系版本冲突的问题</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/19/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-pyspider%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/19/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-pyspider%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">Python3网络爬虫开发实战-pyspider框架使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-04-19 14:16:09 / 修改时间：17:56:05" itemprop="dateCreated datePublished" datetime="2022-04-19T14:16:09+08:00">2022-04-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>pyspider 官方文档 <a target="_blank" rel="noopener" href="http://docs.pyspider.org/">http://docs.pyspider.org/</a></p>
<h4 id="基本功能"><a href="#基本功能" class="headerlink" title="基本功能"></a>基本功能</h4><p>提供方便易用的WebUI系统，可视化编写和调试爬虫</p>
<p>提供爬取进度监控、爬取结果查看、爬虫项目管理等功能</p>
<p>支持多种后端数据库，如MySQL、MongoDB、Redis、SQLite</p>
<p>支持多种消息队列，如RabbitMQ、Beanstalk、Redis、Kombu</p>
<p>提供优先级控制、失败重试、定时抓取等功能</p>
<p>对接了 PhantomJS，可以抓取 JavaScript 渲染的页面</p>
<p>支持单机和分布式部署，支持 Docker 部署</p>
<p>pyspid 提供了 WebUI，爬虫的编写、调试都是在 WebUI 中进行的，如果要快速实现一个页面的抓取，使用pyspider</p>
<h5 id="pyspider-架构"><a href="#pyspider-架构" class="headerlink" title="pyspider 架构"></a>pyspider 架构</h5><p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-pyspider%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/WeChataffa8b62cf8bf792b16728f4f46c0065.png" alt="WeChataffa8b62cf8bf792b16728f4f46c0065"></p>
<p>每个 pyspider 项目对应一个 Python 脚本，脚本中定义了一个 Handler 类，它有一个 on_start() 方法，爬取首先调用 no_start() 方法生成最初的抓取任务，然后发送给 Scheduler 进行调度</p>
<p>Scheduler 将抓取任务分发给 Fetcher 进行抓取，Fetcher 执行并得到响应，随后将响应发送给 Processer</p>
<p>Processer 处理响应并提取出新的 URL 生成新的抓取任务，然后通过消息队列的方式通知 Scheduler 当前任务抓取执行情况，并将新生成的抓取任务发送给 Scheduler，如果生成了新的提取结果，则将其发送到结果队列等待 Result Worker 处理</p>
<p>Scheduler 接收到新的抓取任务，然后查询数据库，判断其如果是新的抓取任务或者是需要重试的任务就继续进行调度，然后将其发送回 Fetcher 进行抓取</p>
<p>不断重复以上工作，直到所有的任务都执行完毕，抓取结束</p>
<p>抓取结束后，程序会回调 on_finished() 方法</p>
<h4 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h4><h5 id="启动-pyspider"><a href="#启动-pyspider" class="headerlink" title="启动 pyspider"></a>启动 pyspider</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyspider all</span><br></pre></td></tr></table></figure>

<p>这样可以启动 pyspider 的所有组件，最后一行输出提示 WebUI 运行在 5000 端口上，输入 <a target="_blank" rel="noopener" href="http://localhost:5000/">http://localhost:5000</a> 可以看到 pyspider 的 WebUI 页面，可以用它来管理项目、编写代码、在线调试、监控任务</p>
<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-pyspider%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/WeChat941a660af574ca4e9a6f69c141140d7c.png" alt="WeChat941a660af574ca4e9a6f69c141140d7c"></p>
<h5 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h5><p>点击右边的 Create 按钮，弹出的浮窗输入项目名称和爬取的链接</p>
<p>接下来就看到 pyspider 项目编辑和调试页面</p>
<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-pyspider%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/WeChat3425c6583da1e0405c27d3f40dce8510.png" alt="WeChat3425c6583da1e0405c27d3f40dce8510"></p>
<p>左侧就是代码的调试页面，点击左侧右上角的 run 单步调试爬虫程序，左侧下半部分可以预览当前的爬取页面</p>
<p>右侧是代码编辑页面，可以直接编辑代码和保存代码，不需要借助 IDE</p>
<p>生成的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pyspider.libs.base_handler <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handler</span>(<span class="params">BaseHandler</span>):</span></span><br><span class="line">  crawl_config = &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">  @every(minutes=24 * 60)</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">on_start</span>(<span class="params">self</span>):</span></span><br><span class="line">    	<span class="comment">#新建爬取请求</span></span><br><span class="line">      <span class="comment">#（爬取URL，指定爬取成功解析方法）</span></span><br><span class="line">      self.crawl(<span class="string">&#x27;http://travel.qunar.com/travelbook/list.htm&#x27;</span>, callback=self.index_page)</span><br><span class="line"></span><br><span class="line"><span class="meta">  @config(age=10 * 24 * 60 * 60)</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">index_page</span>(<span class="params">self, response</span>):</span></span><br><span class="line">      <span class="keyword">for</span> each <span class="keyword">in</span> response.doc(<span class="string">&#x27;a[href^=&quot;http&quot;]&#x27;</span>).items():</span><br><span class="line">          self.crawl(each.attr.href, callback=self.detail_page)</span><br><span class="line"></span><br><span class="line"><span class="meta">  @config(priority=2)</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">detail_page</span>(<span class="params">self, response</span>):</span></span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">          <span class="string">&quot;url&quot;</span>: response.url,</span><br><span class="line">          <span class="string">&quot;title&quot;</span>: response.doc(<span class="string">&#x27;title&#x27;</span>).text(),</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>Handler 就是 pyspider 爬虫的主类，可以在这里定义爬取、解析、存储的逻辑，整个爬虫的功能只需要一个 Handler 即可完成</p>
<p>crawl_config：将项目所有爬取配置统一定义到这里，如 Headers、代理等，配置后全局生效</p>
<p>on_start()：爬取入口，初始的爬取请求在这里产生，通过 crawl() 方法即可新建一个爬取请求，第一个参数爬取 URL，第二个参数 callback，指定爬取成功后哪个方法进行解析</p>
<p>index_page()：接收 Response 参数，Response 对接了 pyquery，直接调用 doc() 方法传入相应的 CSS 选择器，就可以像 pyquery 一样解析此页面，上面代码默认 <code>a[href=^=&quot;http&quot;]</code> ，也就是说该方法解析了页面的所有链接，然后将链接遍历，再次调用 crawl() 方法生成新的爬取请求，同时指定 callback 为 detail_page 解析</p>
<p>detail_page()：同样接收 Response 作为参数，抓取的就是详情页的信息，就不会生成新的请求，只对 Response 对象解析，解析后以字典形式返回，也可以进行后序处理，如保存到数据库</p>
<h5 id="爬取首页"><a href="#爬取首页" class="headerlink" title="爬取首页"></a>爬取首页</h5><p>点击左栏右上角的 run 按钮，即可看到页面下方 follows 便会出现一个标注，其中包含数字 1，这代表有新的爬取请求产生</p>
<img src="Python3网络爬虫开发实战-pyspider框架使用/WeChata1afccc130dc604431124e411f736a1b.png" alt="WeChata1afccc130dc604431124e411f736a1b" style="zoom:80%;" />

<p>左栏左上角显示当前 run 的配置文件，callback 是 on_start，说明点击run 之后执行了 on_start 方法</p>
<p>on_start() 方法中，我们利用 crawl() 方法生成一个爬取请求，那下方的 follows 上数字 1 就代表这一个爬取请求</p>
<p>点击 follows 按钮，可以看到生成的爬取请求的链接，每个链接右侧有一个箭头按钮，点击该箭头可以对此链接进行爬取，也就是爬取攻略的首页内容</p>
<p>再点击下方的 web 按钮，即可羽然当前爬取结果的页面</p>
<p>点击 html 按钮可查看当前页面的源代码</p>
<p>上面 index_page() 方法中提取了所有的链接并生成了新的爬取请求，只需要攻略详情页面的链接就够了，这里修改提取链接时的 CSS选择器，</p>
<p>首页切换到 web 页面，找到攻略标题，点击下方 enable css selector helper，点击标题，可以看到标题外多了一个红框，上方出现了一个 CSS 选择器，这就是当前标题对应的 CSS 选择器</p>
<img src="Python3网络爬虫开发实战-pyspider框架使用/WeChat71c9e7d7b2716e5c496dc2dde6ef328a.png" alt="WeChat71c9e7d7b2716e5c496dc2dde6ef328a" style="zoom:80%;" />

<p>右侧代码选中要更改的区域，点击左栏上右箭头，上方出现的标题的 CSS选择器就会被替换到右侧的代码中</p>
<p>替换 CSS 选择器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> each <span class="keyword">in</span> response.doc(<span class="string">&#x27;li &gt; .tit &gt; a&#x27;</span>).items():</span><br></pre></td></tr></table></figure>

<p>重新点击左栏上右上角 run 按钮，即可重新执行 index_page() 方法。</p>
<p>此时 follows 就变成了 10 个，也就是说现在提取的只有当前页面的 10 个攻略</p>
<p>现在只有第一页的内容，还需要爬取后序页面，所以还需要一个爬取链接，即爬取下一页的攻略列表页面</p>
<p>再利用 crawl() 方法添加下一页的爬取请求，在index_page() 方法里面添加代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index_page</span>(<span class="params">self, response</span>):</span></span><br><span class="line">  <span class="built_in">next</span> = response.doc(<span class="string">&#x27;.next&#x27;</span>).attr.href</span><br><span class="line">  self.crawl(<span class="built_in">next</span>, callback=self.index_page)</span><br><span class="line">  <span class="keyword">for</span> each <span class="keyword">in</span> response.doc(<span class="string">&#x27;li &gt; .tit &gt; a&#x27;</span>).items():</span><br><span class="line">      self.crawl(each.attr.href, callback=self.detail_page)</span><br></pre></td></tr></table></figure>

<p>重新 run ，就可以看到 11 个爬取请求，follows 上显示 11</p>
<h5 id="爬取详情页"><a href="#爬取详情页" class="headerlink" title="爬取详情页"></a>爬取详情页</h5><p>任意选取一个详情页进入，点击请求中任意一个右箭头，执行详情页的爬取</p>
<img src="Python3网络爬虫开发实战-pyspider框架使用/WeChat75fbf9e380178eca4d6202777db75bb0.png" alt="WeChat75fbf9e380178eca4d6202777db75bb0" style="zoom:80%;" />

<p>切换到 web 页面预览效果，页面下拉，看到一些图片显示加载中，再查看源码，没有看到 img 节点</p>
<p>出现此现象的原因是 pyspider 默认发送 HTTP 请求，请求的 HTML 文档本身不包含 img 节点。但浏览器中我们看到了图片，这是因为这张图片是后期经过 JavaScript 出现的</p>
<p>pyspider 内部对接了 PhantomJS，只需要修改一个参数即可，添加 fetch_type</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index_page</span>(<span class="params">self, response</span>):</span></span><br><span class="line">  <span class="built_in">next</span> = response.doc(<span class="string">&#x27;.next&#x27;</span>).attr.href</span><br><span class="line">  self.crawl(<span class="built_in">next</span>, callback=self.index_page)</span><br><span class="line">  <span class="keyword">for</span> each <span class="keyword">in</span> response.doc(<span class="string">&#x27;li &gt; .tit &gt; a&#x27;</span>).items():</span><br><span class="line">      self.crawl(each.attr.href, callback=self.detail_page, fetch_type=<span class="string">&#x27;js&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>图片被渲染出来了，这就是启用了 PhantomJS 渲染后的结果，最后将详情中的信息提取出来</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">detail_page</span>(<span class="params">self, response</span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;url&#x27;</span>: response.url,</span><br><span class="line">        <span class="string">&#x27;title&#x27;</span>: response.doc(<span class="string">&#x27;#booktitle&#x27;</span>).text(),</span><br><span class="line">        <span class="string">&#x27;date&#x27;</span>: response.doc(<span class="string">&#x27;.when .data&#x27;</span>).text(),</span><br><span class="line">        <span class="string">&#x27;day&#x27;</span>: response.doc(<span class="string">&#x27;.howlong .data&#x27;</span>).text(),</span><br><span class="line">        <span class="string">&#x27;who&#x27;</span>: response.doc(<span class="string">&#x27;.who .data&#x27;</span>).text(),</span><br><span class="line">        <span class="string">&#x27;text&#x27;</span>: response.doc(<span class="string">&#x27;#b_panel_schedule&#x27;</span>).text(),</span><br><span class="line">        <span class="string">&#x27;image&#x27;</span>: response.doc(<span class="string">&#x27;.cover_img&#x27;</span>).attr.src,</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>左栏中输出了最终构造的字典信息</p>
<h5 id="启动爬虫"><a href="#启动爬虫" class="headerlink" title="启动爬虫"></a>启动爬虫</h5><p>返回爬虫主页面，将爬虫 status 设置成 DEBUG 或 RUNNING，点击右侧的 Run 按钮即可开始爬取</p>
<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-pyspider%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/WeChatab3cfe3bff369db2397e97e00e3ec0af.png" alt="WeChatab3cfe3bff369db2397e97e00e3ec0af"></p>
<p>最左侧可以定义项目的分组，方便管理</p>
<p>rate/burst 代表当前的爬取速率，rate 代表1秒发出多少个请求，burst 相当于流量控制中的令牌桶算法的令牌数，rate 和 burst 设置越大，爬取速率越快</p>
<p>process 中的 5m、1h、1d 指最近5分、1小时、1天内的请求情况，all 代表所有的请求情况</p>
<p>蓝色代表等待被执行的请求，绿色代表请求成功的请求，黄色代表请求失败后等待重试的请求，红色代表失败次数过多而被忽略的请求，这样可以知道爬取的进度和请求情况</p>
<p>点击 Active Tasks 可查看最近请求的详细情况</p>
<p>点击 Results 可查看所有爬取结果</p>
<h4 id="pyspider用法"><a href="#pyspider用法" class="headerlink" title="pyspider用法"></a>pyspider用法</h4><h5 id="pyspider-all-配置参数"><a href="#pyspider-all-配置参数" class="headerlink" title="pyspider all 配置参数"></a>pyspider all 配置参数</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pyspider [OPTIONS] COMMAND [ARGA]</span><br><span class="line">#OPTIONS 可选参数</span><br><span class="line">-c, --config FILENAME 指定配置文件名称</span><br><span class="line">--logging-config TEXT 日志配置文件名称 默认 pyspider&#x2F;pyspider&#x2F;logging.conf</span><br><span class="line">--debug 开启调试模式</span><br><span class="line">--queue-maxsize INTEGER 队列的最大长度 </span><br><span class="line">--taskdb TEXT taskdb的数据库连接字符串 默认 sqlite</span><br><span class="line">--rojectdb TEXT projectdb的数据库连接字符串 默认 sqlite</span><br><span class="line">--resultdb TEXT resultdb的数据库连接字符串 默认 sqlite</span><br><span class="line">--message-queue TEXT 消息队列连接字符串 默认 multiprocessing.Queue</span><br><span class="line">--phantomjs-proxy TEXT PhantomJS使用的代理 ip:port 形式</span><br><span class="line">--data-path TEXT 数据库存放路径</span><br><span class="line">--version pyspider的版本</span><br><span class="line">--help 显示帮助信息</span><br></pre></td></tr></table></figure>

<p>-c 可以指定配置文件名称是一个常用配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;taskdb&quot;: &quot;mysql+taskdb:&#x2F;&#x2F;username:password@host:port&#x2F;taskdb&quot;,</span><br><span class="line">	&quot;projectdb&quot;: &quot;mysql+projectdb:&#x2F;&#x2F;username:password@host:port&#x2F;projectdb&quot;,</span><br><span class="line">	&quot;resultdb&quot;: &quot;mysql+resultdb:&#x2F;&#x2F;username:password@host:port&#x2F;resultdb&quot;,</span><br><span class="line">	&quot;message_queue&quot;: &quot;amqp:&#x2F;&#x2F;username:password@host:port&#x2F;%2F&quot;,</span><br><span class="line">	&quot;webui&quot;:&#123;</span><br><span class="line">		&quot;username&quot;: &quot;some_name&quot;,</span><br><span class="line">		&quot;password&quot;: &quot;some_passwd&quot;,</span><br><span class="line">		&quot;need-auth&quot;: true</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果要配置 pyspider WebUI 的访问认证，可以新建一个pyspider.json</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;webui&quot;:&#123;</span><br><span class="line">		&quot;username&quot;: &quot;root&quot;,</span><br><span class="line">		&quot;password&quot;: &quot;123456&quot;,</span><br><span class="line">		&quot;need-auth&quot;: true</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样通过在启动时指定配置文件来配置 pyspider WebUI 的访问认证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyspider -c pyspider.json all</span><br></pre></td></tr></table></figure>

<p>运行之后再打开 <a target="_blank" rel="noopener" href="http://localhost:5000/">http://localhost:5000</a></p>
<p>也可以单独运行 pyspider 的某一个组件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#运行 Scheduler</span><br><span class="line">pyspider scheduler [OPTIONS]</span><br><span class="line">#运行 Fetcher</span><br><span class="line">pyspider fetcher [OPTIONS]</span><br><span class="line">#运行 Processor</span><br><span class="line">pyspider processor [OPTIONS]</span><br><span class="line">#运行 WebUI</span><br><span class="line">pyspider webui [OPTIONS]</span><br></pre></td></tr></table></figure>

<p>如果想要改变 WebUI运行端口为 5001</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyspider webui --port 5001</span><br></pre></td></tr></table></figure>

<p>或者配置到 JSON 文件中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;webui&quot;:&#123;&quot;port&quot;: 5001&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="crawl-方法"><a href="#crawl-方法" class="headerlink" title="crawl 方法"></a>crawl 方法</h5><p>callback 回调函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def on_start(self):</span><br><span class="line">	self.crawl(&#39;http:&#x2F;&#x2F;scrapy.org&#x2F;&#39;, callback&#x3D;self.index_page)</span><br></pre></td></tr></table></figure>

<p>index_page 方法的第一个参数是响应对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def index_page(self, response):</span><br><span class="line">	pass</span><br></pre></td></tr></table></figure>

<ul>
<li>age</li>
</ul>
<p>任务有效时间，如果某个任务在有效时间内且已经被执行，则它不会重复执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">def on_start(self):</span><br><span class="line">	self.crawl(&#39;http:&#x2F;&#x2F;www.example.org&#x2F;&#39;, callback&#x3D;self.callback,age&#x3D;10*24*60*60)</span><br><span class="line">或者</span><br><span class="line">@config(age&#x3D;10*24*60*60)</span><br><span class="line">def callback(self):</span><br><span class="line">	pass   </span><br><span class="line">默认有效期10天</span><br></pre></td></tr></table></figure>

<ul>
<li>priority</li>
</ul>
<p>爬取优先级，默认0，数值越大，对应的请求会优先被调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def index_page(self):</span><br><span class="line">	self.crawl(&#39;http:&#x2F;&#x2F;www.example.org&#x2F;page.html&#39;, callback&#x3D;self.index_page)</span><br><span class="line">	self.crawl(&#39;http:&#x2F;&#x2F;www.example.org&#x2F;123.html&#39;, callback&#x3D;self.index_page,priority&#x3D;1)</span><br><span class="line">第二个链接先调用</span><br></pre></td></tr></table></figure>

<ul>
<li>exetime</li>
</ul>
<p>设置定时任务，值是时间戳，默认0，立即执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">improt time</span><br><span class="line">def on_start(self):</span><br><span class="line">	self.crawl(&#39;http:&#x2F;&#x2F;www.example.org&#x2F;&#39;, callback&#x3D;self.callback,exetime&#x3D;time.time()+30*60)</span><br></pre></td></tr></table></figure>

<p>该任务30分钟后执行</p>
<ul>
<li>retries</li>
</ul>
<p>定义重试次数，默认 3</p>
<ul>
<li><p>itag</p>
</li>
<li><p>auto_recrawl</p>
</li>
<li><p>method</p>
</li>
<li><p>params</p>
</li>
<li><p>data</p>
</li>
<li><p>files</p>
</li>
<li><p>user_agent</p>
</li>
<li><p>headers</p>
</li>
<li><p>cookies</p>
</li>
<li><p>connect_timeout</p>
</li>
<li><p>timeout</p>
</li>
<li><p>allow_redirects</p>
</li>
<li><p>validate_cert</p>
</li>
<li><p>proxy</p>
</li>
<li><p>fetch_type</p>
</li>
<li><p>js_script</p>
</li>
<li><p>js_run_at</p>
</li>
<li><p>js_viewport_width/js_viewport_height</p>
</li>
<li><p>load_images</p>
</li>
<li><p>save</p>
</li>
<li><p>cancel</p>
</li>
<li><p>force_update</p>
</li>
</ul>
<h4 id="任务区分"><a href="#任务区分" class="headerlink" title="任务区分"></a>任务区分</h4><p>pyspider 判断两个任务是否是重复是使用任务对应的 URL 的MD5值作为任务的唯一 ID，ID相同，两个任务就会被判定为相同，其中一个就不会爬取</p>
<p>很多情况下请求的链接可能是同一个，但 POST 参数不同，这时可以重写 task_id() 方法，改变这个 ID 的计算方式来实现不同任务区分</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> pyspider.libs.utils <span class="keyword">import</span> md5string</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_taskid</span>(<span class="params">self, task</span>):</span></span><br><span class="line">  <span class="keyword">return</span> md5string(task[<span class="string">&#x27;url&#x27;</span>]+json.dumps(task[<span class="string">&#x27;fetch&#x27;</span>].get(<span class="string">&#x27;data&#x27;</span>, <span class="string">&#x27;&#x27;</span>)))</span><br></pre></td></tr></table></figure>

<p>重写了 get_taskid 方法，利用 URL 和 POST 的参数来生成 ID</p>
<h4 id="全局配置"><a href="#全局配置" class="headerlink" title="全局配置"></a>全局配置</h4><p>可以使用 craw_config 指定全局配置，配置中的参数会和 crawl() 方法创建任务时的参数合并，如要全局配置一个 Headers</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class Handler(BaseHandler):</span><br><span class="line">	crawl_config &#x3D; &#123;</span><br><span class="line">		&#39;headers&#39;: &#123;</span><br><span class="line">			&#39;User-Agent&#39;: &#39;GoogleBot&#39;,</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h4 id="定时爬取"><a href="#定时爬取" class="headerlink" title="定时爬取"></a>定时爬取</h4><p>可以通过 every 属性来设置爬取时间间隔</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@every(minutes=24*60)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_start</span>(<span class="params">self</span>):</span></span><br><span class="line">	<span class="keyword">for</span> url <span class="keyword">in</span> urllist:</span><br><span class="line">		self.crawl(url, callback=self.index_page)</span><br></pre></td></tr></table></figure>

<p>设置了每天执行一次爬取</p>
<p>上面提到了有效时间，有效时间内不会重复爬取，所以要把有效时间设置比重复时间更短，才可以实现定时爬取</p>
<p>将 age 设置小于定时时间</p>
<h4 id="项目状态"><a href="#项目状态" class="headerlink" title="项目状态"></a>项目状态</h4><p>TODO 刚被创建未实现状态</p>
<p>STOP 想停止某项目抓取，可将项目设置 STOP</p>
<p>CHECKING 正在运行的项目被修改后会变成 CHECKING 状态</p>
<p>DEBUG/RUNNING 这两个状态对项目运行没影响，设置任意一个项目都可以运行，用第二个可以区分项目是否测试通过</p>
<p>PAUSE 爬取过程中连续多次错误时，项目会自动设置为 PAUSE 状态，并等待一段时间后继续爬取</p>
<h4 id="删除项目"><a href="#删除项目" class="headerlink" title="删除项目"></a>删除项目</h4><p>将项目设置为 STOP，将分组名称设置为 delete，等待24小时，项目会自动删除</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/18/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-12App%E7%88%AC%E5%8F%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="简单记录下">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/18/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-12App%E7%88%AC%E5%8F%96/" class="post-title-link" itemprop="url">Python3网络爬虫开发实战-12App爬取</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-04-18 10:08:39" itemprop="dateCreated datePublished" datetime="2022-04-18T10:08:39+08:00">2022-04-18</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-07-17 09:15:57" itemprop="dateModified" datetime="2023-07-17T09:15:57+08:00">2023-07-17</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="11-2-mitmproxy-的使用"><a href="#11-2-mitmproxy-的使用" class="headerlink" title="11.2 mitmproxy 的使用"></a>11.2 mitmproxy 的使用</h4><p>官方文档 <a target="_blank" rel="noopener" href="https://docs.mitmproxy.org/stable/">https://docs.mitmproxy.org/stable/</a></p>
<p>中文文档及配置 <a target="_blank" rel="noopener" href="https://ptorch.com/news/269.html">https://ptorch.com/news/269.html</a></p>
<p>mitmproxy 是一个支持 HTTP 和 HTTPS 的抓包程序，是一个控制台形式的操作</p>
<p>有两个关联组件</p>
<p>mitmdump：是 mitmproxy 命令行接口，利用它对接 Python 脚本，实现监听后的处理</p>
<p>mitmweb：一个 Web 程序，通过它以清楚观察到 mitmproxy 捕获请求</p>
<p>mitmproxy 运行在 PC 上， mitmproxy 会在 PC 上的 8080 端口运行，然后开启一个代理服务，这个服务实际上是一个 HTTP/HTTPS 的代理</p>
<p>手机和PC在同一局域网内，设置代理为 mitmproxy 的代理地址，这样手机访问互联网时，流量包就会流经 mitmproxy，mitmproxy 再去转发这些数据包到真实的服务器，服务器返回数据包时再由 mitmproxy 转发回手机，这样 mitmproxy 就相当于起了中间人的作用。这个过程还可以对接 mitmdump，抓取到的 request  和 response 的内容都可以用 Python 处理</p>
<h5 id="设置代理"><a href="#设置代理" class="headerlink" title="设置代理"></a>设置代理</h5><p>启动 mitmproxy，之后会在 8080 端口上运行一个代理服务，右下角显示当前正在监听的端口</p>
<p>或者启动 mitmdump，也会监听 8080 端口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mitmproxy</span><br></pre></td></tr></table></figure>

<img src="Python3网络爬虫开发实战-12App爬取/WeChatbc9c4fbc9a77005d02a7b76380f4d96d.png" alt="WeChatbc9c4fbc9a77005d02a7b76380f4d96d" style="zoom:100%;" />



<h5 id="mitmproxy-使用"><a href="#mitmproxy-使用" class="headerlink" title="mitmproxy 使用"></a>mitmproxy 使用</h5><p>手机设置代理 端口号设置 8080</p>
<p>设置好之后，手机浏览请求，mitmproxy 页面便会呈现手机上的请求</p>
<img src="Python3网络爬虫开发实战-App爬取/WeChat3176183fed7aabb817d5cca64b557fea.png" alt="WeChat3176183fed7aabb817d5cca64b557fea" style="zoom:80%;" />

<p>键盘上下移动光标选择请求，敲击回车可以查看详情</p>
<img src="Python3网络爬虫开发实战-12App爬取/WeChatbdf3664c9d6af574beb50d4ba5ecbda0.png" alt="WeChatbdf3664c9d6af574beb50d4ba5ecbda0" style="zoom:80%;" />

<p>可以看到 3 个分栏，Request、Response、Detail，通过鼠标点击分栏或者 Tab 切换</p>
<h6 id="命令行编辑功能"><a href="#命令行编辑功能" class="headerlink" title="命令行编辑功能"></a>命令行编辑功能</h6><p>点击 e 进入编辑功能，跳出一个列表可以选择需要编辑选项</p>
<p>esc 关闭列表选项</p>
<p>如进入编辑请求参数界面，光标移动到需要修改地方，回车可编辑</p>
<p>敲击 a 可以增加一行，输入 Key、Value</p>
<p>再敲击 esc，q 键，返回之前的界面，可以看到请求的参数已修改</p>
<img src="Python3网络爬虫开发实战-12App爬取/WeChat4316a20d612a7c046a3338faa2f20b37.png" alt="WeChat4316a20d612a7c046a3338faa2f20b37" style="zoom:80%;" />

<p>敲击 r 发起修改后的请求</p>
<h5 id="mitmweb"><a href="#mitmweb" class="headerlink" title="mitmweb"></a>mitmweb</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mitmweb</span><br><span class="line">#提示</span><br><span class="line">Web server listening at http:&#x2F;&#x2F;127.0.0.1:8081&#x2F;</span><br><span class="line">Proxy server listening at http:&#x2F;&#x2F;*:8080</span><br></pre></td></tr></table></figure>

<p>打开链接 <a target="_blank" rel="noopener" href="http://127.0.0.1:8081/">http://127.0.0.1:8081/</a> 可以看到请求</p>
<h5 id="mitmdump"><a href="#mitmdump" class="headerlink" title="mitmdump"></a>mitmdump</h5><p>mitmdump 是 mitmproxy 的命令行接口，同时可以对接 Python 对请求进行处理</p>
<p>可以命令行启动 mitmproxy，并把截获的数据保存到文件中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mitmdump -w outfile #打开乱码</span><br></pre></td></tr></table></figure>

<p>如果设置设置代理报错<code> killed by block_global</code>， 添加参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mitmdump -w outfile --set block_global&#x3D;false</span><br></pre></td></tr></table></figure>





<p>还可以指定一个脚本来处理截获的数据，使用 -s 参数，脚本需要放在当前命令执行的目录下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mitmdump -s script.py</span><br></pre></td></tr></table></figure>

<p>脚本写入如下代码：定义了一个 request() 方法，参数为 flow，其实是一个 HTTPFlow 对象，通过 request 属性即可获取当前请求对象，然后打印输出请求头，将请求头修改成了 MitmProxy</p>
<p>手机端访问 <a target="_blank" rel="noopener" href="http://httpbin.org/get">http://httpbin.org/get</a> 测试，查看请求的相关数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request</span>(<span class="params">flow</span>):</span></span><br><span class="line">	flow.request.headers[<span class="string">&#x27;User-Agent&#x27;</span>] = <span class="string">&#x27;MitmProxy&#x27;</span></span><br><span class="line">	print(flow.request.headers)</span><br></pre></td></tr></table></figure>

<ul>
<li>静默模式</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mitmdump -q -s index.py</span><br></pre></td></tr></table></figure>





<h6 id="日志输出"><a href="#日志输出" class="headerlink" title="日志输出"></a>日志输出</h6><p>可以设定不同级别以不同颜色输出结果，显示到中断控制台上</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> ctx</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request</span>(<span class="params">flow</span>):</span></span><br><span class="line">	flow.request.headers[<span class="string">&#x27;User-Agent&#x27;</span>] = <span class="string">&#x27;MitmProxy&#x27;</span></span><br><span class="line">	ctx.log.info(<span class="built_in">str</span>(flow.request.headers))</span><br><span class="line">	ctx.log.warn(<span class="built_in">str</span>(flow.request.headers))</span><br><span class="line">	ctx.log.error(<span class="built_in">str</span>(flow.request.headers))</span><br><span class="line">	print(flow.request.headers)</span><br></pre></td></tr></table></figure>

<p>这里调用了 ctx 模块，它有一个 log 功能</p>
<h6 id="Request-请求"><a href="#Request-请求" class="headerlink" title="Request 请求"></a>Request 请求</h6><p>还可输出其它内容 headers、cookies 等</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> ctx</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request</span>(<span class="params">flow</span>):</span></span><br><span class="line">	request = flow.request</span><br><span class="line">	info = ctx.log.info</span><br><span class="line">	print(info(<span class="built_in">str</span>(request.headers)))</span><br><span class="line">	print(info(<span class="built_in">str</span>(request.cookies)))</span><br><span class="line">	print(info(<span class="built_in">str</span>(request.host)))</span><br><span class="line">	print(info(<span class="built_in">str</span>(request.method)))</span><br><span class="line">	print(info(<span class="built_in">str</span>(request.port)))</span><br><span class="line">	print(info(<span class="built_in">str</span>(request.scheme)))</span><br></pre></td></tr></table></figure>

<p>可以对属性修改 ，修改脚本如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request</span>(<span class="params">flow</span>):</span></span><br><span class="line">	url = <span class="string">&#x27;https://httpbin.org/get&#x27;</span></span><br><span class="line">	flow.request.url = url</span><br></pre></td></tr></table></figure>

<p>访问 <a target="_blank" rel="noopener" href="https://baidu.com/">https://baidu.com</a> 直接跳转到这里了 <a target="_blank" rel="noopener" href="https://httpbin.org/get">https://httpbin.org/get</a></p>
<p>Request 还有很多属性 参考 <a target="_blank" rel="noopener" href="http://docs.mitmproxy.org/en/latest/scripting/api.html">http://docs.mitmproxy.org/en/latest/scripting/api.html</a></p>
<h6 id="Response-响应"><a href="#Response-响应" class="headerlink" title="Response 响应"></a>Response 响应</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> ctx</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">response</span>(<span class="params">flow</span>):</span></span><br><span class="line">	response = flow.response</span><br><span class="line">	info = ctx.log.info</span><br><span class="line">	info(<span class="built_in">str</span>(response.status_code))</span><br><span class="line">	info(<span class="built_in">str</span>(response.headers))</span><br><span class="line">	info(<span class="built_in">str</span>(response.cookies))</span><br><span class="line">	info(<span class="built_in">str</span>(response.text))</span><br></pre></td></tr></table></figure>

<p>再访问 httpbin </p>
<ul>
<li>修改响应消息体-直接修改响应字段</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> ctx, http</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modify</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">response</span>(<span class="params">self, flow</span>):</span></span><br><span class="line">        <span class="keyword">if</span> flow.request.url.startswith(<span class="string">&quot;https://xxx.x.xxx.com.cn/activityInfo/getPrizeInfo==&quot;</span>):</span><br><span class="line">       		 //获取响应的json字符串，转成python对象进行解析和修改</span><br><span class="line">            response = json.loads(flow.response.get_text())</span><br><span class="line">            response[<span class="string">&#x27;limitCount&#x27;</span>] = <span class="number">1</span></span><br><span class="line">            //修改完成后，奖python对象转成json字符串，<span class="built_in">set</span>进请求的响应体重发送给客户端</span><br><span class="line">            flow.response.set_text(json.dumps(response))</span><br><span class="line">            ctx.log.info(<span class="string">&#x27;modify limitCount&#x27;</span>)</span><br><span class="line"> </span><br><span class="line"> addons = [</span><br><span class="line">	Modify()</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<ul>
<li>修改响应消息体-通过读取json文件的字符串返给客户端</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> ctx, http</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modify</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">response</span>(<span class="params">self, flow</span>):</span></span><br><span class="line">        <span class="keyword">if</span> flow.request.url.startswith(<span class="string">&quot;https://xxx.x.xxx.com.cn/activityInfo/getPrizeInfo==&quot;</span>):</span><br><span class="line">        	//读取文件，在当前文件路径下执行脚本，否则需要写文件的绝对路径；不然会找不到该json文件</span><br><span class="line">       		 <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;getStatus.json&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">       		 	//从json文件中读取数据成python对象</span><br><span class="line">                res = json.load(f)</span><br><span class="line">            //将读取的python对象转成json字符串发送给客户端</span><br><span class="line">            flow.response.set_text(json.dumps(res))</span><br><span class="line">            ctx.log.info(<span class="string">&quot;modify order status&quot;</span>)</span><br><span class="line"> </span><br><span class="line"> addons = [</span><br><span class="line">	Modify()</span><br><span class="line">]</span><br></pre></td></tr></table></figure>







<h6 id="拦截请求"><a href="#拦截请求" class="headerlink" title="拦截请求"></a>拦截请求</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> http, ctx</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Lock</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Filter</span>:</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, filter_info</span>):</span></span><br><span class="line">    self.log_info = <span class="string">&quot;&quot;</span></span><br><span class="line">    self.mutex = Lock()</span><br><span class="line">    self.filter_info = filter_info</span><br><span class="line">    self.response_file = <span class="literal">None</span></span><br><span class="line">    self.switch_on = <span class="literal">False</span></span><br><span class="line">    self.log_file = <span class="string">&quot;log.txt&quot;</span></span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">log</span>(<span class="params">self, info</span>) -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    self.log_info += <span class="string">f&quot;<span class="subst">&#123;info&#125;</span>\n\n&quot;</span></span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">write_log</span>(<span class="params">self, mode=<span class="string">&quot;w+&quot;</span></span>) -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    self.mutex.acquire()</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(self.log_file, mode) <span class="keyword">as</span> f:</span><br><span class="line">      f.write(self.log_info)</span><br><span class="line">    self.mutex.release()</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_target_flow</span>(<span class="params">self, flow: http.HTTPFlow</span>) -&gt; bool:</span></span><br><span class="line">    <span class="keyword">for</span> info <span class="keyword">in</span> self.filter_info:</span><br><span class="line">      <span class="keyword">if</span> info[<span class="string">&quot;str_in_url&quot;</span>] <span class="keyword">in</span> flow.request.url:</span><br><span class="line">        self.log_file = info[<span class="string">&quot;log_file&quot;</span>]</span><br><span class="line">        self.switch_on = info[<span class="string">&quot;switch_on&quot;</span>]</span><br><span class="line">        <span class="keyword">if</span> info[<span class="string">&quot;response_file&quot;</span>] != <span class="literal">None</span>:</span><br><span class="line">          self.response_file = info[<span class="string">&quot;response_file&quot;</span>]</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">modify_response</span>(<span class="params">self, flow: http.HTTPFlow</span>) -&gt; http.HTTPFlow:</span></span><br><span class="line">    <span class="keyword">if</span> self.switch_on <span class="keyword">and</span> self.response_file:</span><br><span class="line">      <span class="keyword">with</span> <span class="built_in">open</span>(self.response_file, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        flow.response.content = f.read().encode()</span><br><span class="line">    <span class="keyword">return</span> flow</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">request</span>(<span class="params">self, flow: http.HTTPFlow</span>) -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    <span class="keyword">if</span> self.is_target_flow(flow):</span><br><span class="line">      self.log_info = <span class="string">&quot;&quot;</span></span><br><span class="line">      self.log(<span class="string">f&quot;——METHOD——\n<span class="subst">&#123;flow.request.method&#125;</span>&quot;</span>)</span><br><span class="line">      self.log(<span class="string">f&quot;——HOST——\n<span class="subst">&#123;flow.request.pretty_host&#125;</span>&quot;</span>)</span><br><span class="line">      self.log(<span class="string">f&quot;——URL——\n<span class="subst">&#123;flow.request.pretty_url&#125;</span>&quot;</span>)</span><br><span class="line">      query = [i + <span class="string">&quot;:&quot;</span> + flow.request.query[i] + <span class="string">&quot;\n&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> flow.request.query]</span><br><span class="line">      self.log(<span class="string">f&quot;——QUERY STRING——\n<span class="subst">&#123;<span class="string">&#x27;&#x27;</span>.join(query)&#125;</span>&quot;</span>)</span><br><span class="line">      <span class="keyword">if</span> flow.request.urlencoded_form:</span><br><span class="line">        form = [i + <span class="string">&quot;:&quot;</span> + flow.request.urlencoded_form[i] + <span class="string">&quot;\n&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> flow.request.urlencoded_form]</span><br><span class="line">        self.log(<span class="string">f&quot;——FORM——\n<span class="subst">&#123;<span class="string">&#x27;&#x27;</span>.join(form)&#125;</span>&quot;</span>)</span><br><span class="line">      self.write_log()</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">response</span>(<span class="params">self, flow: http.HTTPFlow</span>) -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    <span class="keyword">if</span> self.is_target_flow(flow):</span><br><span class="line">      self.log_info = <span class="string">&quot;&quot;</span></span><br><span class="line">      self.log(<span class="string">f&quot;——RESPONSE before modified——\n<span class="subst">&#123;flow.response.content.decode()&#125;</span>&quot;</span>)</span><br><span class="line">      flow = self.modify_response(flow)</span><br><span class="line">      self.log(<span class="string">f&quot;——RESPONSE after modified——\n<span class="subst">&#123;flow.response.content.decode()&#125;</span>&quot;</span>)</span><br><span class="line">      self.write_log(mode=<span class="string">&quot;a&quot;</span>)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">filter_info = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;str_in_url&quot;</span>: <span class="string">&quot;getSimpleNews&quot;</span>,</span><br><span class="line">    <span class="string">&quot;log_file&quot;</span>: <span class="string">&quot;getSimpleNews_log.txt&quot;</span>,</span><br><span class="line">    <span class="string">&quot;switch_on&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">    <span class="string">&quot;response_file&quot;</span>: <span class="string">&quot;getSimpleNews_response.txt&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;str_in_url&quot;</span>: <span class="string">&quot;getQQNewsComment&quot;</span>,</span><br><span class="line">    <span class="string">&quot;log_file&quot;</span>: <span class="string">&quot;getQQNewsComment_log.txt&quot;</span>,</span><br><span class="line">    <span class="string">&quot;switch_on&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">    <span class="string">&quot;response_file&quot;</span>: <span class="literal">None</span>,</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line">addons = [</span><br><span class="line">  Filter(filter_info)</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="Script"><a href="#Script" class="headerlink" title="Script"></a>Script</h6><ol>
<li>可以定义 py 文件供 mitmproxy 加载，定义若干函数，这些函数实现 mitmproxy 提供的事件</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> http</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request</span>(<span class="params">self, flow:http.HTTPFlow</span>):</span></span><br><span class="line">	...</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>编写 py 文件供 mitmproxy 加载，文件定义 addons 数组，数组元素是一个类实例，这些类里面有若干函数，这些函数实现 mitmproxy 提供的事件</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mitmproxy.http</span><br><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> ctx</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span>:</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">    self.num = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request</span>(<span class="params">self, flow: mitmproxy.http.HTTPFlow</span>):</span></span><br><span class="line">    self.num = self.num + <span class="number">1</span></span><br><span class="line">    ctx.log.info(<span class="string">&quot;We&#x27;ve seen %d flows&quot;</span> % self.num)</span><br><span class="line"></span><br><span class="line">addons = [</span><br><span class="line">    Counter()</span><br><span class="line">]</span><br></pre></td></tr></table></figure>







<p>sniffer.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> http</span><br><span class="line"> </span><br><span class="line">password_key = [<span class="string">&quot;password&quot;</span>, <span class="string">&quot;pwd&quot;</span>, <span class="string">&quot;pass&quot;</span>, <span class="string">&quot;passwd&quot;</span>, <span class="string">&quot;mm&quot;</span>, <span class="string">&quot;passport&quot;</span>, <span class="string">&quot;auth&quot;</span>, <span class="string">&quot;key&quot;</span>, <span class="string">&quot;mima&quot;</span>]</span><br><span class="line">form_login_key = [<span class="string">&quot;check&quot;</span>, <span class="string">&quot;login&quot;</span>, <span class="string">&quot;verify&quot;</span>, <span class="string">&quot;account&quot;</span>, <span class="string">&quot;logon&quot;</span>, <span class="string">&quot;signin&quot;</span>, <span class="string">&quot;denglu&quot;</span>]</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sniffer</span>:</span></span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">request</span>(<span class="params">self, flow: http.HTTPFlow</span>):</span></span><br><span class="line">		request = flow.request</span><br><span class="line">		url = request.pretty_url</span><br><span class="line">		form_url = <span class="built_in">str</span>(request.urlencoded_form)</span><br><span class="line">		<span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">			<span class="keyword">if</span> self.any_match(form_login_key, url) <span class="keyword">or</span> self.any_match(password_key, form_url):</span><br><span class="line">				self.resolve(flow)</span><br><span class="line">                </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">any_match</span>(<span class="params">self, <span class="built_in">list</span>, <span class="built_in">str</span>: <span class="built_in">str</span></span>):</span></span><br><span class="line">		lower_str = <span class="built_in">str</span>.lower()</span><br><span class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">list</span>:</span><br><span class="line">			<span class="keyword">if</span> i <span class="keyword">in</span> lower_str:</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">resolve</span>(<span class="params">self, flow: http.HTTPFlow</span>):</span></span><br><span class="line">		request = flow.request</span><br><span class="line">		url = request.url</span><br><span class="line">		_from = <span class="built_in">str</span>(flow.client_conn.ip_address)</span><br><span class="line">		url_form = <span class="built_in">str</span>(request.urlencoded_form)</span><br><span class="line">		header = <span class="built_in">str</span>(request.headers)</span><br><span class="line"> </span><br><span class="line">		logging.info(<span class="string">&quot;url: %s \nheader: %s \nform: %s \nip_from: %s&quot;</span>, url, header, url_form, _from)</span><br></pre></td></tr></table></figure>

<p>addos.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sniffer <span class="keyword">import</span> Sniffer</span><br><span class="line"> </span><br><span class="line">addons = [</span><br><span class="line">	Sniffer()</span><br><span class="line">    <span class="comment"># YourSniffer()</span></span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>









<h4 id="远程主机抓包"><a href="#远程主机抓包" class="headerlink" title="远程主机抓包"></a>远程主机抓包</h4><p>linux 主机 CentOS8系统，安装好 mitmproxy </p>
<p>云主机安全组入方向添加8080端口，宝塔面板防火墙开放8080端口</p>
<p>启动 mitmdump</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mitmdump -w outfile --set block_global&#x3D;false</span><br></pre></td></tr></table></figure>

<p>可以看到抓取到的链接</p>
<p>指定脚本处理数据，如获取京东的 pt_key</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mitmdump -s main.py --set block_global&#x3D;false</span><br><span class="line">#</span><br><span class="line">mitmweb -s script1.py --set block_global&#x3D;false</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mitmproxy.net.http.request <span class="keyword">import</span> Request</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request</span>(<span class="params">flow</span>):</span></span><br><span class="line">    url = <span class="string">&#x27;https://mars.jd.com/log/sdk&#x27;</span></span><br><span class="line">    request = flow.request <span class="comment">#type: Request</span></span><br><span class="line">    <span class="keyword">if</span> request.url.startswith(url):</span><br><span class="line">        pt_key = request.cookies.get(<span class="string">&#x27;pt_key&#x27;</span>)</span><br><span class="line">        pt_pin = request.cookies.get(<span class="string">&#x27;pt_pin&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> pt_key <span class="keyword">and</span> pt_pin:</span><br><span class="line">            print(<span class="string">&#x27;接收到：pt_key=&#123;&#125;;pt_pin=&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(pt_key, pt_pin))</span><br></pre></td></tr></table></figure>





<h4 id="11-3-mitmdump-爬取“得到”APP电子书信息"><a href="#11-3-mitmdump-爬取“得到”APP电子书信息" class="headerlink" title="11.3 mitmdump 爬取“得到”APP电子书信息"></a>11.3 mitmdump 爬取“得到”APP电子书信息</h4><p>爬取得到APP电子书板块，新书上架电子书信息，保存到 MongoDB</p>
<p>运行 mitmdump</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mitmdup -s script.py</span><br></pre></td></tr></table></figure>

<p>script.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">response</span>(<span class="params">flow</span>):</span></span><br><span class="line">	print(<span class="string">&#x27;url:&#x27;</span>, flow.request.url)</span><br><span class="line">	print(<span class="string">&#x27;response:&#x27;</span>, flow.response.text)</span><br></pre></td></tr></table></figure>

<p>打印太多接口，不方便分析，改用 Charles 抓取数据</p>
<p>可以看到列表接口 <a target="_blank" rel="noopener" href="https://entree.igetget.com/ebook2/v1/ebook/list">https://entree.igetget.com/ebook2/v1/ebook/list</a></p>
<h5 id="数据抓取"><a href="#数据抓取" class="headerlink" title="数据抓取"></a>数据抓取</h5><p>对接口做过滤限制，抓取接口数据，提取结果中对应的字段</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> ctx</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">response</span>(<span class="params">flow</span>):</span></span><br><span class="line">	url = <span class="string">&#x27;https://entree.igetget.com/ebook2/v1/ebook/list&#x27;</span></span><br><span class="line">	requestUrl = flow.request.url <span class="comment">#type: str</span></span><br><span class="line">	<span class="keyword">if</span> requestUrl.startswith(url):</span><br><span class="line">		text = flow.response.text</span><br><span class="line">		data = json.loads(text)</span><br><span class="line">		books = data.get(<span class="string">&#x27;c&#x27;</span>).get(<span class="string">&#x27;list&#x27;</span>)</span><br><span class="line">		<span class="keyword">for</span> book <span class="keyword">in</span> books:</span><br><span class="line">			ctx.log.info(<span class="built_in">str</span>(book))</span><br></pre></td></tr></table></figure>

<p>可以看到控制台上输出电子书信息</p>
<h5 id="提取保存"><a href="#提取保存" class="headerlink" title="提取保存"></a>提取保存</h5><p>声明 MongoDB 数据库连接，提取信息插入数据库</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> ctx</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> pymongo</span><br><span class="line"></span><br><span class="line">client = pymongo.MongoClient()</span><br><span class="line">db = client[<span class="string">&#x27;igetget&#x27;</span>] <span class="comment">#相当于哪个数据库</span></span><br><span class="line">collection = db[<span class="string">&#x27;books&#x27;</span>] <span class="comment">#相当于哪个表</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">response</span>(<span class="params">flow</span>):</span></span><br><span class="line">	url = <span class="string">&#x27;https://entree.igetget.com/ebook2/v1/ebook/list&#x27;</span></span><br><span class="line">	requestUrl = flow.request.url <span class="comment">#type: str</span></span><br><span class="line">	<span class="keyword">if</span> requestUrl.startswith(url):</span><br><span class="line">		text = flow.response.text</span><br><span class="line">		data = json.loads(text)</span><br><span class="line">		books = data.get(<span class="string">&#x27;c&#x27;</span>).get(<span class="string">&#x27;list&#x27;</span>)</span><br><span class="line">		<span class="keyword">for</span> book <span class="keyword">in</span> books:</span><br><span class="line">			data = &#123;</span><br><span class="line">				<span class="string">&#x27;title&#x27;</span>: book.get(<span class="string">&#x27;operating_title&#x27;</span>),</span><br><span class="line">				<span class="string">&#x27;cover&#x27;</span>: book.get(<span class="string">&#x27;cover&#x27;</span>),</span><br><span class="line">				<span class="string">&#x27;summary&#x27;</span>: book.get(<span class="string">&#x27;other_share_summary&#x27;</span>),</span><br><span class="line">				<span class="string">&#x27;price&#x27;</span>: book.get(<span class="string">&#x27;price&#x27;</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			ctx.log.info(<span class="built_in">str</span>(book))</span><br><span class="line">			collection.insert(data)</span><br></pre></td></tr></table></figure>

<h4 id="11-4-Appium-使用"><a href="#11-4-Appium-使用" class="headerlink" title="11.4 Appium 使用"></a>11.4 Appium 使用</h4><p>Appium 是一个跨平台移动端自动化测试工具，可以模拟 APP 内部的各种操作，如点击、滑动、文本输入等，对 iOS 设备 Appium 使用 UIAutomation 来实现驱动，对 Android 来说，使用 UIAutomator 和 Selendroid 来实现驱动</p>
<p>Appium 相当于一个服务器，我们可以向 Appium 发送一些操作指令，Appium 就会根据不同的指令对移动设备进行驱动，完成不同的动作</p>
<img src="Python3网络爬虫开发实战-12App爬取/WeChatca0e02e38eb8e8ab9bcfa7bd8d363752.png" alt="WeChatca0e02e38eb8e8ab9bcfa7bd8d363752" style="zoom:50%;" />

<p>点击 Start Server 即可启动 Appium 的服务，相当于开启了一个 Appium 服务，可以通过 Appium 内置驱动或 Python 代码向 Appium 的服务发送一系列操作指令，Appium 就会根据不同的指令对移动设备进行驱动，完成不同的动作</p>
<h6 id="Appium内置驱动打开APP"><a href="#Appium内置驱动打开APP" class="headerlink" title="Appium内置驱动打开APP"></a>Appium内置驱动打开APP</h6><p>Appium 运行之后正在监听 4723 端口，我们可以向此端口对应的服务接口发送操作指令</p>
<p>Host设置127.0.0.1</p>
<p>打开 Appium Inspector</p>
<p>配置参数</p>
<p>Remote Path: /wd/hub</p>
<p>platformName: 品台名称 iOS 或 Android</p>
<p>deviceName：设备名称</p>
<p>bundleId：APP包名(下面截图改成 bundleId)</p>
<p>其它配置参数 <a target="_blank" rel="noopener" href="https://github.com/appium/appium/blob/master/docs/en/writing-running-appium/caps.md">https://github.com/appium/appium/blob/master/docs/en/writing-running-appium/caps.md</a></p>
<img src="Python3网络爬虫开发实战-12App爬取/3641650270925_.pic.jpg" alt="3641650270925_.pic" style="zoom: 67%;" />

<p>Start Session报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Failed to create session. An unknown server-side error occurred while processing the command. Original error: Unable to launch WebDriverAgent because of xcodebuild failure: xcodebuild failed with code 70 xcodebuild error message: . Make sure you follow the tutorial at https:&#x2F;&#x2F;github.com&#x2F;appium&#x2F;appium-xcuitest-driver&#x2F;blob&#x2F;master&#x2F;docs&#x2F;real-device-config.md. Try to remove the WebDriverAgentRunner application from the device if it is installed and reboot the device.</span><br></pre></td></tr></table></figure>

<p>进入 Appium 路径 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;Applications&#x2F;Appium Server GUI.app&#x2F;Contents&#x2F;Resources&#x2F;app&#x2F;node_modules&#x2F;appium&#x2F;node_modules&#x2F;appium-webdriveragent</span><br></pre></td></tr></table></figure>

<p>打开 WebDriverAgent 项目，选择 Targets-WebDriverAgentRunner 配置好证书 </p>
<p>Product - Test ，如果连接手机，会安装一个 WebDriverAgent app，启动后又回到桌面，控制台可以看到设备的IP地址 <a target="_blank" rel="noopener" href="http://10.1.253.120:8100/">http://10.1.253.120:8100</a> 加上/status 即 <a target="_blank" rel="noopener" href="http://10.1.253.120:8100/status%EF%BC%8C%E6%89%93%E5%BC%80%E6%B5%8F%E8%A7%88%E5%99%A8%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%87%BA%E7%8E%B0%E4%B8%80%E4%B8%B2">http://10.1.253.120:8100/status，打开浏览器，如果出现一串</a> JSON，说明 WDA 安装成功了，打开<a target="_blank" rel="noopener" href="http://10.1.253.120:8100/inspector">http://10.1.253.120:8100/inspector</a> 可以查看界面和元素信息</p>
<p>再次点击 StartSession</p>
<img src="Python3网络爬虫开发实战-12App爬取/3651650273841_.pic.jpg" alt="3651650273841_.pic" style="zoom:70%;" />

<p>左边显示APP界面，选中某个元素，中间就显示元素对应源代码，右栏显示元素的基本信息，如元素 id、class、text 等，以及可以执行的操作，如 Tap、Send Keys、Clear</p>
<p>还可以录制操作动作，窗口中操作的 APP行为都会被记录下来，Recorder 处可以自动生成对应语言的代码</p>
<img src="Python3网络爬虫开发实战-12App爬取/3661650274120_.pic.jpg" alt="3661650274120_.pic" style="zoom:80%;" />

<h6 id="Python代码驱动APP"><a href="#Python代码驱动APP" class="headerlink" title="Python代码驱动APP"></a>Python代码驱动APP</h6><p>代码中指定 Appium Server</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server = <span class="string">&#x27;http://localhost:4723/wd/hub&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这个 Server 在刚打开 Appium 的时候就已经开启了，是在 4723 端口上运行的</p>
<p>新建一个 Session，这类似点击 Appium 内置驱动的 Start Session 按钮相同的功能</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> appium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> WebDriverWait</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">	server = <span class="string">&#x27;http://localhost:4723/wd/hub&#x27;</span></span><br><span class="line">	desired_caps = &#123;</span><br><span class="line">		<span class="string">&#x27;platformName&#x27;</span>: <span class="string">&quot;iOS&quot;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:deviceName&#x27;</span>: <span class="string">&#x27;iPhoneq&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:bundleId&#x27;</span>: <span class="string">&#x27;com.SwiftDemo&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:udid&#x27;</span>: <span class="string">&#x27;4ce52917e9a0932f3c821e2418a03d2a993c5650&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:platformVersion&#x27;</span>: <span class="string">&#x27;14.5&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:xcodeSigningId&#x27;</span>: <span class="string">&#x27;iPhone Developer&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:xcodeOrgId&#x27;</span>: <span class="string">&#x27;C28X7H9ZW6&#x27;</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	driver = webdriver.Remote(server, desired_caps)</span><br></pre></td></tr></table></figure>

<p>运行后就启动 APP了 </p>
<p>查看刚才录制生成的Python代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">el1 = driver.find_element(by=AppiumBy.ACCESSIBILITY_ID, value=<span class="string">&quot;DelegateProxy&quot;</span>) el1.click() </span><br><span class="line">el2 = driver.find_element(by=AppiumBy.ACCESSIBILITY_ID, value=<span class="string">&quot;ImagePicker照片选择&quot;</span>) el2.click()</span><br></pre></td></tr></table></figure>

<p>修改</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> appium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">	server = <span class="string">&#x27;http://localhost:4723/wd/hub&#x27;</span></span><br><span class="line">	desired_caps = &#123;</span><br><span class="line">		<span class="string">&#x27;platformName&#x27;</span>: <span class="string">&quot;iOS&quot;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:deviceName&#x27;</span>: <span class="string">&#x27;iPhoneq&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:bundleId&#x27;</span>: <span class="string">&#x27;com.SwiftDemo&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:udid&#x27;</span>: <span class="string">&#x27;4ce52917e9a0932f3c821e2418a03d2a993c5650&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:platformVersion&#x27;</span>: <span class="string">&#x27;14.5&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:xcodeSigningId&#x27;</span>: <span class="string">&#x27;iPhone Developer&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:xcodeOrgId&#x27;</span>: <span class="string">&#x27;C28X7H9ZW6&#x27;</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	driver = webdriver.Remote(server, desired_caps)</span><br><span class="line">  <span class="comment">#获取元素时设置等待</span></span><br><span class="line">	wait = WebDriverWait(driver, <span class="number">30</span>)</span><br><span class="line">	ele1 = wait.until(EC.presence_of_element_located((By.ID, <span class="string">&#x27;DelegateProxy&#x27;</span>)))</span><br><span class="line">	ele1.click()</span><br><span class="line">	ele2 = wait.until(EC.presence_of_element_located((By.ID, <span class="string">&#x27;ImagePicker照片选择&#x27;</span>)))</span><br><span class="line">	ele2.click()</span><br></pre></td></tr></table></figure>

<h6 id="API"><a href="#API" class="headerlink" title="API"></a>API</h6><p>使用的Python库为 AppiumPythonClint <a target="_blank" rel="noopener" href="https://github.com/appium/python-client">https://github.com/appium/python-client</a> 此库继承自 Selenium</p>
<ul>
<li>初始化</li>
</ul>
<p>代码参数上面的</p>
<p>如果要打开的app没有先安装到手机上，也可以直接指定app的包路径</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app &#x3D; os.path.abspath(&#39;&#x2F;Users&#x2F;xx&#x2F;xx&#x2F;build&#x2F;Debug-iphoneos&#x2F;xx.app&#39;)</span><br></pre></td></tr></table></figure>

<ul>
<li>查找元素</li>
</ul>
<p>可以使用 Selenium 中通用的查找方法来查找元素</p>
<p>iOS 平台，可以使用 UIAutomation 来进行元素选择</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">el = self.driver.find_element_by_ios_uiautomation(<span class="string">&#x27;.elements()[0]&#x27;</span>)</span><br><span class="line">el = self.driver.find_element_by_ios_uiautomation(<span class="string">&#x27;.elements()&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>还可以使用 iOS Predicates 来进行元素选择</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">el = self.driver.find_element_by_ios_predicate(<span class="string">&#x27;wdName=&quot;Buttons&quot;&#x27;</span>)</span><br><span class="line">el = self.driver.find_element_by_ios_predicate(<span class="string">&#x27;wdName=&quot;SearchBar&quot; AND isWDDivisible == 1&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>也可使用 iOS Class Chain 来选择</p>
<p>此方法只适用于 XCUIText 驱动</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">el = self.driver.find_element_by_ios_class_chain(<span class="string">&#x27;XCUIElementTypeWindow/XCUIElementTypeButton[3]&#x27;</span>)</span><br><span class="line">el = self.driver.find_element_by_ios_class_chain(<span class="string">&#x27;XCUIElementTypeWindow/XCUIElementTypeButton&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>点击</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tap(self, positions, duration=<span class="literal">None</span>)</span><br><span class="line"><span class="comment">#positions 点击的位置组成的列表</span></span><br><span class="line"><span class="comment">#duration  点击持续时间</span></span><br><span class="line">tap([(<span class="number">100</span>,<span class="number">200</span>),(<span class="number">100</span>,<span class="number">60</span>)], <span class="number">500</span>) <span class="comment">#模拟点击屏幕的几个点</span></span><br></pre></td></tr></table></figure>

<p>对某个元素如按钮，可以直接调用 click() 模拟点击</p>
<ul>
<li>屏幕拖动</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">scroll(self, origin_el, destination_el)</span><br><span class="line"><span class="comment">#实现从元素 origin_el 滚动至 destination_el</span></span><br><span class="line"><span class="comment">#origin_el 被操作元素</span></span><br><span class="line"><span class="comment">#destination_el 目标元素</span></span><br><span class="line"></span><br><span class="line">swipe(self, start_x, start_y, end_X, end_Y, duration=<span class="literal">None</span>) <span class="comment">#从A点滑动到B点</span></span><br><span class="line"></span><br><span class="line">flick(self, start_x, start_y, end_X, end_Y) <span class="comment">#从A点快速滑动到B点</span></span><br></pre></td></tr></table></figure>

<ul>
<li>拖拽</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">drag_and_drop(self, origin_el, destination_el)</span><br><span class="line"><span class="comment">#实现从元素 origin_el 拖拽至 destination_el</span></span><br></pre></td></tr></table></figure>

<ul>
<li>文本输入</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set_text()</span><br></pre></td></tr></table></figure>

<ul>
<li>动作键</li>
</ul>
<p>与 Selenium 中的ActionChains 类似， Appi 中的 TouchAction 可支持的方法有 tap()、press()、long_press()、release()、move_to()、wait()、cancel() 等</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">el = self.driver.find_element_by_accessiblity_id</span><br><span class="line">action = TouchAction(self.driver)</span><br><span class="line">action.tap(el).perform</span><br></pre></td></tr></table></figure>

<p>选中一个元素，然后利用 TouchAction 实现点击操作</p>
<p>如果要拖动</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">els = self.driver.find_elements_by_class_name(<span class="string">&#x27;listView&#x27;</span>)</span><br><span class="line">a1 = TouchAction()</span><br><span class="line">a1.press(els[<span class="number">0</span>]).move_to(x=<span class="number">10</span>, y=<span class="number">0</span>).move_to(x=<span class="number">10</span>,y=<span class="number">-75</span>).move_to(x=<span class="number">10</span>,y=<span class="number">-100</span>).release()</span><br><span class="line">aw = TouchAction()</span><br><span class="line">a2.press(els[<span class="number">1</span>]).move_to(x=<span class="number">10</span>, y=<span class="number">0</span>).move_to(x=<span class="number">10</span>, y=<span class="number">-30</span>).move_to(x=<span class="number">10</span>, y=<span class="number">-600</span>).release()</span><br></pre></td></tr></table></figure>

<p>更多参考 <a target="_blank" rel="noopener" href="https://testerhome.com/topics/3711">https://testerhome.com/topics/3711</a></p>
<h4 id="11-5-Appium-爬取朋友圈"><a href="#11-5-Appium-爬取朋友圈" class="headerlink" title="11.5 Appium 爬取朋友圈"></a>11.5 Appium 爬取朋友圈</h4><p>代码 <a target="_blank" rel="noopener" href="https://github.com/Python3WebSpider/Moments">https://github.com/Python3WebSpider/Moments</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">FLICK_START_X = <span class="number">300</span></span><br><span class="line">FLICK_START_Y = <span class="number">300</span></span><br><span class="line">FLICK_DISTANCE = <span class="number">700</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#... 进入朋友圈页面 模拟上滑</span></span><br><span class="line"> self.driver.swipe(FLICK_START_X, FLICK_START_Y + FLICK_DISTANCE, FLICK_START_X, FLICK_START_Y)</span><br><span class="line"><span class="comment"># 遍历每条状态 获取数据保存</span></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 昵称</span></span><br><span class="line">        nickname = item.find_element_by_id(<span class="string">&#x27;com.tencent.mm:id/aig&#x27;</span>).get_attribute(<span class="string">&#x27;text&#x27;</span>)</span><br><span class="line">        <span class="comment"># 正文</span></span><br><span class="line">        content = item.find_element_by_id(<span class="string">&#x27;com.tencent.mm:id/cwm&#x27;</span>).get_attribute(<span class="string">&#x27;text&#x27;</span>)</span><br><span class="line"><span class="comment">#...</span></span><br></pre></td></tr></table></figure>





<p>使用终端代替Xcode</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 解锁keychain，以便可以正常的签名应用，</span><br><span class="line">PASSWORD&#x3D;&quot;replace-with-your-password&quot;</span><br><span class="line">security unlock-keychain -p $PASSWORD ~&#x2F;Library&#x2F;Keychains&#x2F;login.keychain</span><br><span class="line"></span><br><span class="line"># 获取设备的UDID</span><br><span class="line">UDID&#x3D;$(idevice_id -l | head -n1)</span><br><span class="line"></span><br><span class="line"># 运行测试</span><br><span class="line">xcodebuild -project WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner -destination &quot;id&#x3D;$UDID&quot; test</span><br></pre></td></tr></table></figure>



<h4 id="11-5-Appium-mitmdump爬取京东商品"><a href="#11-5-Appium-mitmdump爬取京东商品" class="headerlink" title="11.5 Appium+mitmdump爬取京东商品"></a>11.5 Appium+mitmdump爬取京东商品</h4><p>Charles 抓包分析数据</p>
<p>mitmdump 抓取解析数据保存</p>
<p>Appium驱动APP完成一系列动作</p>
<h4 id="报错问题"><a href="#报错问题" class="headerlink" title="报错问题"></a>报错问题</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A new session could not be created. Details: Appium&#39;s IosDriver does not support xcode version 13.3</span><br><span class="line">Apple has deprecated UIAutomation. Use the &quot;XCUITest&quot; automationName capability instead</span><br></pre></td></tr></table></figure>

<p>添加参数 automationName=XCUITest</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>





  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">daxun</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  <script src="/js/local-search.js"></script>















  








  

  

</body>
</html>
