<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"8.0.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>

  <meta name="description" content="ç®€å•è®°å½•ä¸‹">
<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="ç®€å•è®°å½•ä¸‹">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="daxun">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/2/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>Hexo</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Hexo</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">ç®€å•è®°å½•ä¸‹</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">daxun</p>
  <div class="site-description" itemprop="description">ç®€å•è®°å½•ä¸‹</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
        
          <span class="site-state-item-count">87</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



        </section>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">
      

      
    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/06/09/%E9%80%86%E5%90%91%E5%B7%A5%E5%85%B7-Dobby/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="ç®€å•è®°å½•ä¸‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/06/09/%E9%80%86%E5%90%91%E5%B7%A5%E5%85%B7-Dobby/" class="post-title-link" itemprop="url">é€†å‘å·¥å…·-Dobby</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>
      

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-06-09 10:52:34 / ä¿®æ”¹æ—¶é—´ï¼š16:02:48" itemprop="dateCreated datePublished" datetime="2022-06-09T10:52:34+08:00">2022-06-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%80%86%E5%90%91%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">é€†å‘å·¥å…·</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="Inline-Hook"><a href="#Inline-Hook" class="headerlink" title="Inline Hook"></a>Inline Hook</h4><p>ä¿®æ”¹å‡½æ•°çš„å‰ N å­—èŠ‚å†…å­˜ï¼Œä½¿å…¶è·³è½¬åˆ°è‡ªå·±ç¼–å†™çš„å‡½æ•°ï¼Œè¿™æ ·åŸå‡½æ•°çš„é€»è¾‘å°±è¢«æ–°å‡½æ•°æ¥ç®¡äº†ï¼ŒåŒæ—¶è¿˜åº”è¯¥ä¿å­˜åŸå‡½æ•°çš„å‰ N ä¸ªå­—èŠ‚ï¼Œä»¥ä¾¿åœ¨éœ€è¦æ—¶èƒ½æ­£ç¡®æ¢å¤åŸæ¥çš„æ±‡ç¼–ä»£ç ä»è€Œæ‰§è¡ŒåŸå§‹é€»è¾‘</p>
<h4 id="Dobby"><a href="#Dobby" class="headerlink" title="Dobby"></a>Dobby</h4><p>Dobbyï¼ˆåŸå HookZzï¼‰<a target="_blank" rel="noopener" href="https://github.com/jmpews/Dobby">https://github.com/jmpews/Dobby</a></p>
<h5 id="ç¼–è¯‘-Xcode-å·¥ç¨‹"><a href="#ç¼–è¯‘-Xcode-å·¥ç¨‹" class="headerlink" title="ç¼–è¯‘ Xcode å·¥ç¨‹"></a>ç¼–è¯‘ Xcode å·¥ç¨‹</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;jmpews&#x2F;Dobby.git --depth&#x3D;1</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯ä¸ªè·¨å¹³å°çš„ï¼Œéœ€è¦å°† cmake å°†å·¥ç¨‹ç¼–è¯‘æˆä¸º Xcode å·¥ç¨‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cd Dobby &amp;&amp; mkdir build_for_ios_arm64 &amp;&amp; cd build_for_ios_arm64</span><br><span class="line">cmake .. -G Xcode \</span><br><span class="line">-DCMAKE_TOOLCHAIN_FILE&#x3D;cmake&#x2F;ios.toolchain.cmake \</span><br><span class="line">-DPLATFORM&#x3D;OS64 -DARCHS&#x3D;&quot;arm64&quot; -DCMAKE_SYSTEM_PROCESSOR&#x3D;arm64 \</span><br><span class="line">-DENABLE_BITCODE&#x3D;0 -DENABLE_ARC&#x3D;0 -DENABLE_VISIBILITY&#x3D;1 -DDEPLOYMENT_TARGET&#x3D;9.3 \</span><br><span class="line">-DDynamicBinaryInstrument&#x3D;ON -DNearBranch&#x3D;ON -DPlugin.SymbolResolver&#x3D;ON -DPlugin.Darwin.HideLibrary&#x3D;ON -DPlugin.Darwin.ObjectiveC&#x3D;ON</span><br><span class="line"></span><br><span class="line">#github ä¸Šæ˜¯ä¸‹é¢çš„</span><br><span class="line">cd Dobby &amp;&amp; mkdir build_for_ios &amp;&amp; cd build_for_ios</span><br><span class="line">cmake .. -G Xcode -DCMAKE_SYSTEM_NAME&#x3D;iOS -DCMAKE_OSX_ARCHITECTURES&#x3D;arm64 -DCMAKE_SYSTEM_PROCESSOR&#x3D;arm64 -DCMAKE_OSX_DEPLOYMENT_TARGET&#x3D;9.3</span><br></pre></td></tr></table></figure>

<p>cmake ç¼–è¯‘åç”Ÿæˆä¸€ä¸ª Xcode å·¥ç¨‹</p>
<img src="é€†å‘å·¥å…·-Dobby/WeChat646a5d4c48c7a119b2d324b20ff968a3.png" alt="WeChat646a5d4c48c7a119b2d324b20ff968a3" style="zoom:80%;" />

<p>ç¼–è¯‘ DobbyX.framework</p>
<p><img src="/%E9%80%86%E5%90%91%E5%B7%A5%E5%85%B7-Dobby/WeChatc1fcfbfb83d8dd9daed4ac78a60cadbd.png" alt="WeChatc1fcfbfb83d8dd9daed4ac78a60cadbd"></p>
<h5 id="å¯¼å…¥-Framework"><a href="#å¯¼å…¥-Framework" class="headerlink" title="å¯¼å…¥ Framework"></a>å¯¼å…¥ Framework</h5><p>åˆ›å»ºæµ‹è¯•å·¥ç¨‹ testDobbyï¼Œå°† DobbyX.framework æ‹–å…¥å·¥ç¨‹</p>
<p>è¿è¡ŒåæŠ¥é”™</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dyld: Library not loaded: @rpath&#x2F;DobbyX.framework&#x2F;DobbyX</span><br><span class="line">  Referenced from: &#x2F;private&#x2F;var&#x2F;containers&#x2F;Bundle&#x2F;Application&#x2F;B6A97E11-656E-461B-93B0-A1D72E9313AB&#x2F;testDobby.app&#x2F;testDobby</span><br><span class="line">  Reason: image not found</span><br><span class="line">dyld: launch, loading dependent libraries</span><br><span class="line">DYLD_LIBRARY_PATH&#x3D;&#x2F;usr&#x2F;lib&#x2F;system&#x2F;introspection</span><br><span class="line">DYLD_INSERT_LIBRARIES&#x3D;&#x2F;Developer&#x2F;usr&#x2F;lib&#x2F;libBacktraceRecording.dylib:&#x2F;Developer&#x2F;usr&#x2F;lib&#x2F;libMainThreadChecker.dylib:&#x2F;Developer&#x2F;Library&#x2F;PrivateFrameworks&#x2F;DTDDISupport.framework&#x2F;libViewDebuggerSupport.dylib</span><br></pre></td></tr></table></figure>

<p>å°† Framework é¦–æ¬¡æ‹–å…¥å·¥ç¨‹ï¼ŒXcode ä¸ä¼šè‡ªåŠ¨å¸®ä½ æ‹·è´ï¼Œè¿è¡Œæ—¶ä¼šå‘ç° Framework æ²¡æœ‰æ‰“åŒ…è¿›å…¥ APP åŒ…ï¼Œé€ æˆ DYLD åŠ è½½æ—¶æ‰¾ä¸åˆ°åº“æŠ¥é”™ </p>
<p>TARGETS testDobby - Build Phasesï¼Œç‚¹å‡» + é€‰æ‹© New Copy Files Phase</p>
<p>Copy Files ä¸­ï¼ŒDestination é€‰æ‹© Frameworks</p>
<img src="é€†å‘å·¥å…·-Dobby/WeChat511e8790f7c557a95e07f4c3227c5f93.png" alt="WeChat511e8790f7c557a95e07f4c3227c5f93" style="zoom:80%;" />

<p>è¿è¡Œåæç¤º </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[*] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[*] Dobby</span><br><span class="line">[*] &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">[*] dobby in debug log mode, disable with cmake flag &quot;-DDOBBY_DEBUG&#x3D;OFF&quot;</span><br></pre></td></tr></table></figure>

<h5 id="Dobby-æ ¸å¿ƒå‡½æ•°"><a href="#Dobby-æ ¸å¿ƒå‡½æ•°" class="headerlink" title="Dobby æ ¸å¿ƒå‡½æ•°"></a>Dobby æ ¸å¿ƒå‡½æ•°</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">DobbyHook</span><span class="params">(<span class="keyword">void</span> *address, <span class="keyword">void</span> *replace_call, <span class="keyword">void</span> **origin_call)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#addressï¼šéœ€è¦ Hook çš„å‡½æ•°åœ°å€</span></span><br><span class="line">#replace_allï¼šæ–°å‡½æ•°åœ°å€</span><br><span class="line">#origin_callï¼šä¿ç•™åŸå§‹å‡½æ•°çš„æŒ‡é’ˆçš„åœ°å€</span><br></pre></td></tr></table></figure>

<h5 id="Dobby-ä½¿ç”¨"><a href="#Dobby-ä½¿ç”¨" class="headerlink" title="Dobby ä½¿ç”¨"></a>Dobby ä½¿ç”¨</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&lt;DobbyX/dobby.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//2.å®šä¹‰å‡½æ•°æŒ‡é’ˆï¼Œç”¨äºä¿å­˜è¢«æ›¿æ¢å‡½æ•°çš„åœ°å€</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> (*sum_p)(<span class="keyword">int</span> a, <span class="keyword">int</span> b);</span><br><span class="line"></span><br><span class="line"><span class="comment">//1.å®šä¹‰å°†è¦è¢« HOOK çš„å‡½æ•°</span></span><br><span class="line"><span class="keyword">int</span> sum(<span class="keyword">int</span> a, <span class="keyword">int</span> b) &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//3.å®šä¹‰æ–°å‡½æ•°ï¼Œç”¨æ­¤å‡½æ•°æ›¿æ¢å°†è¦HOOKçš„å‡½æ•°</span></span><br><span class="line"><span class="keyword">int</span> mySum(<span class="keyword">int</span> a, <span class="keyword">int</span> b) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;Sum: %d, ğŸºğŸº&quot;</span>, sum_p(a, b)); <span class="comment">//è°ƒç”¨åŸå‡½æ•°</span></span><br><span class="line">    <span class="keyword">return</span> a - b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">    [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line">  	<span class="comment">//4.è°ƒç”¨DobbyHookè¿›è¡Œå‡½æ•°çš„HOOK</span></span><br><span class="line">    DobbyHook(sum, mySum, (<span class="keyword">void</span> *)&amp;sum_p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)touchesBegan:(<span class="built_in">NSSet</span>&lt;<span class="built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="built_in">UIEvent</span> *)event &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;Sum: %d&quot;</span>, sum(<span class="number">10</span>, <span class="number">20</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#sumå‡½æ•°HOOKæˆåŠŸï¼Œå…ˆè¾“å‡ºåŸå§‹å‡½æ•°çš„æ‰§è¡Œç»“æœï¼Œå†è¾“å‡ºæ›¿æ¢å‡½æ•°çš„æ‰§è¡Œç»“æœ</span><br><span class="line">Sum: 30, ğŸºğŸº</span><br><span class="line">Sum: -10</span><br></pre></td></tr></table></figure>

<h5 id="HOOKå‡½æ•°åœ°å€"><a href="#HOOKå‡½æ•°åœ°å€" class="headerlink" title="HOOKå‡½æ•°åœ°å€"></a>HOOKå‡½æ•°åœ°å€</h5><p>é€†å‘å¼€å‘ä¸­ï¼Œåº”ç”¨ä¼šå‰¥ç¦»ç¬¦å·è¡¨ï¼Œæˆ‘ä»¬æ— æ³•è·å¾—ç¬¦å·åç§°ï¼Œæ‰€æœ‰ HOOK çš„ä¸€å®šæ˜¯åœ°å€</p>
<p>åº”ç”¨æ¯æ¬¡å¯åŠ¨æ—¶ï¼ŒASLR åç§»åœ°å€éƒ½ä¸ä¸€æ ·ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥ HOOK åœ°å€</p>
<p>å…ˆæ‰¾åˆ°å‡½æ•°åœ¨ MachO ä¸­çš„åç§»åœ°å€ï¼ŒåŠ ä¸Š PAGEZERO çš„ 0x100000000ï¼Œå†åŠ ä¸Šæœ¬æ¬¡å¯åŠ¨çš„ ASLR åç§»åœ°å€</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">&quot;Inject.h&quot;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;DobbyX/dobby.h&gt;</span></span></span><br><span class="line"><span class="meta">#import <span class="meta-string">&lt;mach-o/dyld.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Inject</span></span></span><br><span class="line"><span class="comment">//0x5F04 MachOä¸Šå‡½æ•°åç§»åœ°å€</span></span><br><span class="line"><span class="keyword">static</span> uintptr_t sumP = <span class="number">0x5F04</span> + <span class="number">0x100000000</span>;</span><br><span class="line"></span><br><span class="line">+(<span class="keyword">void</span>)load&#123;</span><br><span class="line">   sumP += _dyld_get_image_vmaddr_slide(<span class="number">0</span>); <span class="comment">//+ASLRåç§»åœ°å€</span></span><br><span class="line">   DobbyHook((<span class="keyword">void</span> *)sumP, mySum, (<span class="keyword">void</span> *)&amp;sum_p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> (*sum_p)(<span class="keyword">int</span> a,<span class="keyword">int</span> b);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> mySum(<span class="keyword">int</span> a,<span class="keyword">int</span> b) &#123;</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@&quot;Sumï¼š%dï¼ŒğŸºğŸºğŸºğŸºğŸº&quot;</span>,sum_p(a,b));</span><br><span class="line">   <span class="keyword">return</span> a - b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
































      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/30/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%8F%8D%E7%BC%96%E8%AF%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="ç®€å•è®°å½•ä¸‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/30/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%8F%8D%E7%BC%96%E8%AF%91/" class="post-title-link" itemprop="url">å¾®ä¿¡å°ç¨‹åºåç¼–è¯‘</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-05-30 17:13:02" itemprop="dateCreated datePublished" datetime="2022-05-30T17:13:02+08:00">2022-05-30</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-10-24 10:31:41" itemprop="dateModified" datetime="2022-10-24T10:31:41+08:00">2022-10-24</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903603484753927">å¾®ä¿¡å°ç¨‹åºåç¼–è¯‘å®æˆ˜ï¼ˆä¸€ï¼‰è§£åŒ…</a></p>
<h4 id="frida"><a href="#frida" class="headerlink" title="frida"></a>frida</h4><p>åˆ©ç”¨ frida-trace è·Ÿè¸ªç±»çš„æ‰€æœ‰æ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">frida-trace -U -f com.ss.iphone.ugc.Aweme -m &quot;-[AWEAwemeShareViewController *]&quot;</span><br></pre></td></tr></table></figure>

<h4 id="node-jså®‰è£…"><a href="#node-jså®‰è£…" class="headerlink" title="node.jså®‰è£…"></a>node.jså®‰è£…</h4><p><a target="_blank" rel="noopener" href="https://nodejs.org/en/">https://nodejs.org/en/</a> æˆ–è€…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ brew install node</span><br><span class="line"></span><br><span class="line">#ä¾èµ–å®‰è£…</span><br><span class="line">npm install uglify-es --save</span><br><span class="line">npm install esprima  --save</span><br><span class="line">npm install css-tree  --save</span><br><span class="line">npm install cssbeautify --save</span><br><span class="line">npm install vm2  --save</span><br><span class="line">npm install uglify-es  --save</span><br><span class="line">npm install js-beautify  --save</span><br><span class="line">npm install escodegen  --save</span><br><span class="line">npm install cheerio --save</span><br></pre></td></tr></table></figure>

<h4 id="wxapkg"><a href="#wxapkg" class="headerlink" title="wxapkg"></a>wxapkg</h4><p>å°ç¨‹åºæ˜¯ä»¥ wxapkg æ‹“å±•åçš„æ–‡ä»¶ï¼Œåœ¨å¾®ä¿¡æ²™ç›’ç›®å½•ä¸‹æœç´¢ wxapkg</p>
<p>iPhone è®¾å¤‡å¾®ä¿¡æ‰“å¼€å°ç¨‹åºï¼Œæ‰“å¼€å¾®ä¿¡æ²™ç›’ç›®å½•ï¼Œæœç´¢ wxapkg æ‰¾åˆ°æœ€æ–°æ—¶é—´çš„ wxapkg æ–‡ä»¶</p>
<p>å¯¼å‡ºæ‹·è´åˆ°ç”µè„‘</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;var&#x2F;mobile&#x2F;Containers&#x2F;Data&#x2F;Application&#x2F;3A176EEE-76AD-4424-8966-961834916101&#x2F;Library&#x2F;WechatPrivate&#x2F;0461325054f5668774d3cf52bc6ead7b&#x2F;WeApp&#x2F;LocalCache&#x2F;release&#x2F;wx48e51a643b3b85db</span><br></pre></td></tr></table></figure>

<ul>
<li>ä¹Ÿå¯ä»¥é€šè¿‡å®‰å“æ¨¡æ‹Ÿå™¨è·å–</li>
</ul>
<p>ç½‘æ˜“MuMuï¼Œå¼€å¯Rootæƒé™ï¼Œè¿›å…¥è®¾ç½®ä¸­å¿ƒï¼ŒåŸºæœ¬è®¾ç½®ï¼Œå‹¾é€‰å¼€å¯Rootæƒé™</p>
<p>å®‰è£…REæ–‡ä»¶ç®¡ç†å™¨å’Œå¾®ä¿¡ï¼Œæ‰“å¼€å¾®ä¿¡è¿›å…¥å°ç¨‹åº</p>
<p>REæ–‡ä»¶ç®¡ç†å™¨è¿›å…¥ </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;data&#x2F;data&#x2F;com.tencent.mm&#x2F;MicroMsg&#x2F;&#123;ä¸€ä¸²32ä½16è¿›åˆ¶å­—ç¬¦ä¸²&#125;&#x2F;appbrand&#x2F;pkg</span><br></pre></td></tr></table></figure>

<p>é•¿æŒ‰-å‹ç¼©æ‰€é€‰æ–‡ä»¶-å‘é€</p>
<h4 id="wxapkg-è§£åŒ…"><a href="#wxapkg-è§£åŒ…" class="headerlink" title="wxapkg è§£åŒ…"></a>wxapkg è§£åŒ…</h4><p>node.js è„šæœ¬è¿˜åŸå°ç¨‹åºæºç </p>
<p>è§£åŒ…è„šæœ¬  <a target="_blank" rel="noopener" href="https://github.com/larack8/wxappUnpacker">https://github.com/larack8/wxappUnpacker</a>  </p>
<p>åŠ ä¸ªä»£ç†è®¿é—®å¿«äº›  <a target="_blank" rel="noopener" href="https://gh.fakev.cn/larack8/wxappUnpacker">https://gh.fakev.cn/larack8/wxappUnpacker</a>  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#ä¸€é”®è§£åŒ…è¿˜åŸ</span><br><span class="line">#è‡ªåŠ¨å°† wxapkg æ–‡ä»¶è§£åŒ…ï¼Œå¹¶å°†åŒ…ä¸­ç›¸å…³çš„å·²è¢«ç¼–è¯‘&#x2F;æ··æ·†çš„æ–‡ä»¶è‡ªåŠ¨æ¢å¤åŸçŠ¶ï¼ˆåŒ…æ‹¬ç›®å½•ç»“æ„ï¼‰</span><br><span class="line">node .&#x2F;wuWxapkg.js &#x2F;Users&#x2F;xxx&#x2F;Desktop&#x2F;unpack&#x2F;10.wxapkg</span><br></pre></td></tr></table></figure>

<p>æœ€ååœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­ï¼Œæ–°å»ºç©ºç™½å°ç¨‹åºå·¥ç¨‹ï¼Œå°†è¿˜åŸåçš„ç›¸å…³ç›®å½•æ–‡ä»¶å¯¼å…¥å·¥ç¨‹ï¼Œå³å¯ç¼–è¯‘è¿è¡Œèµ·æ¥</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/21/ReactiveObjC%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="ç®€å•è®°å½•ä¸‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/21/ReactiveObjC%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">ReactiveObjCä½¿ç”¨</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-05-21 12:08:17" itemprop="dateCreated datePublished" datetime="2022-05-21T12:08:17+08:00">2022-05-21</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-09-14 15:26:42" itemprop="dateModified" datetime="2022-09-14T15:26:42+08:00">2022-09-14</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li>MVVM </li>
</ul>
<p>MVVM ä¸­ï¼Œview å’Œ view controller è”ç³»åœ¨ä¸€èµ·ï¼Œæˆ‘ä»¬æŠŠå®ƒä»¬è§†ä¸ºä¸€ä¸ªç»„ä»¶ï¼Œview å’Œ view controller ï¼Œéƒ½ä¸èƒ½ç›´æ¥å¼•ç”¨ modelï¼Œè€Œæ˜¯ç›´æ¥å¼•ç”¨è§†å›¾æ¨¡å‹ï¼ˆviewModelï¼‰viewModel æ˜¯ä¸€ä¸ªæ”¾ç½®ç”¨æˆ·è¾“å…¥éªŒè¯é€»è¾‘ï¼Œè§†å›¾æ˜¾ç¤ºé€»è¾‘ï¼Œå‘èµ·ç½‘ç»œè¯·æ±‚å’Œå…¶ä»–ä»£ç çš„åœ°æ–¹</p>
<p>view å¼•ç”¨ viewModelï¼Œä½†åè¿‡æ¥ä¸è¡Œï¼Œå³ä¸è¦åœ¨viewModel ä¸­å¼•å…¥ #import UIKit.hï¼Œä»»ä½•è§†å›¾çš„å¼•ç”¨éƒ½ä¸åº”è¯¥æ”¾åœ¨ viewModel ä¸­ã€‚viewModel å¼•ç”¨ modelï¼Œä½†åè¿‡æ¥ä¸è¡Œ</p>
<h4 id="1-MVVMç™»å½•"><a href="#1-MVVMç™»å½•" class="headerlink" title="1.MVVMç™»å½•"></a>1.MVVMç™»å½•</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">éœ€æ±‚ï¼š1.ç›‘å¬ä¸¤ä¸ªæ–‡æœ¬æ¡†çš„å†…å®¹ï¼Œæœ‰å†…å®¹æ‰å…è®¸æŒ‰é’®ç‚¹å‡»</span></span><br><span class="line"><span class="comment">     2.é»˜è®¤ç™»å½•è¯·æ±‚.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">ç”¨MVVMï¼šå®ç°ï¼Œä¹‹å‰ç•Œé¢çš„æ‰€æœ‰ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line"><span class="comment">åˆ†æï¼š1.ä¹‹å‰ç•Œé¢çš„æ‰€æœ‰ä¸šåŠ¡é€»è¾‘éƒ½äº¤ç»™æ§åˆ¶å™¨åšå¤„ç†</span></span><br><span class="line"><span class="comment">     2.åœ¨MVVMæ¶æ„ä¸­æŠŠæ§åˆ¶å™¨çš„ä¸šåŠ¡å…¨éƒ¨æ¬å»VMæ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªæ§åˆ¶å™¨å¯¹åº”ä¸€ä¸ªVMæ¨¡å‹.</span></span><br><span class="line"><span class="comment">æ­¥éª¤ï¼š</span></span><br><span class="line"><span class="comment">    1.åˆ›å»ºLoginViewModelç±»ï¼Œå¤„ç†ç™»å½•ç•Œé¢ä¸šåŠ¡é€»è¾‘.</span></span><br><span class="line"><span class="comment">    2.è¿™ä¸ªç±»é‡Œé¢åº”è¯¥ä¿å­˜ç€è´¦å·çš„ä¿¡æ¯ï¼Œåˆ›å»ºä¸€ä¸ªè´¦å·Accountæ¨¡å‹</span></span><br><span class="line"><span class="comment">    3.LoginViewModelåº”è¯¥ä¿å­˜ç€è´¦å·ä¿¡æ¯Accountæ¨¡å‹ã€‚</span></span><br><span class="line"><span class="comment">    4.éœ€è¦æ—¶åˆ»ç›‘å¬Accountæ¨¡å‹ä¸­çš„è´¦å·å’Œå¯†ç çš„æ”¹å˜ï¼Œæ€ä¹ˆç›‘å¬ï¼Ÿ</span></span><br><span class="line"><span class="comment">    5.åœ¨éRACå¼€å‘ä¸­ï¼Œéƒ½æ˜¯ä¹ æƒ¯èµ‹å€¼ï¼Œåœ¨RACå¼€å‘ä¸­ï¼Œéœ€è¦æ”¹å˜å¼€å‘æ€ç»´ï¼Œç”±èµ‹å€¼è½¬å˜ä¸ºç»‘å®šï¼Œå¯ä»¥åœ¨ä¸€å¼€å§‹åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå°±ç»™Accountæ¨¡å‹ä¸­çš„å±æ€§ç»‘å®šï¼Œå¹¶ä¸éœ€è¦é‡å†™setæ–¹æ³•ã€‚</span></span><br><span class="line"><span class="comment">    6.æ¯æ¬¡Accountæ¨¡å‹çš„å€¼æ”¹å˜ï¼Œå°±éœ€è¦åˆ¤æ–­æŒ‰é’®èƒ½å¦ç‚¹å‡»ï¼Œåœ¨VMæ¨¡å‹ä¸­åšå¤„ç†ï¼Œç»™å¤–ç•Œæä¾›ä¸€ä¸ªèƒ½å¦ç‚¹å‡»æŒ‰é’®çš„ä¿¡å·.</span></span><br><span class="line"><span class="comment">    7.è¿™ä¸ªç™»å½•ä¿¡å·éœ€è¦åˆ¤æ–­Accountä¸­è´¦å·å’Œå¯†ç æ˜¯å¦æœ‰å€¼ï¼Œç”¨KVOç›‘å¬è¿™ä¸¤ä¸ªå€¼çš„æ”¹å˜ï¼ŒæŠŠä»–ä»¬èšåˆæˆç™»å½•ä¿¡å·.</span></span><br><span class="line"><span class="comment">    8.ç›‘å¬æŒ‰é’®çš„ç‚¹å‡»ï¼Œç”±VMå¤„ç†ï¼Œåº”è¯¥ç»™VMå£°æ˜ä¸€ä¸ªRACCommandï¼Œä¸“é—¨å¤„ç†ç™»å½•ä¸šåŠ¡é€»è¾‘.</span></span><br><span class="line"><span class="comment">    9.æ‰§è¡Œå‘½ä»¤ï¼ŒæŠŠæ•°æ®åŒ…è£…æˆä¿¡å·ä¼ é€’å‡ºå»</span></span><br><span class="line"><span class="comment">    10.ç›‘å¬å‘½ä»¤ä¸­ä¿¡å·çš„æ•°æ®ä¼ é€’</span></span><br><span class="line"><span class="comment">    11.ç›‘å¬å‘½ä»¤çš„æ‰§è¡Œæ—¶åˆ»</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rac_textSignalåªæœ‰ç”¨æˆ·è¾“å…¥æ‰æœ‰æ•ˆï¼Œå¦‚æœåªæ˜¯ç›´æ¥èµ‹å€¼ </span><br><span class="line">eg:<span class="keyword">self</span>.inputView.phoneTextField.text = <span class="string">@&quot;xxxx&quot;</span>  <span class="keyword">self</span>.inputView.phoneTextField.rac_textSignal å°±ä¸ä¼šè§¦å‘çš„</span><br><span class="line">RAC(<span class="keyword">self</span>.viewModel , mobilePhone) = </span><br><span class="line">[RACSignal merge: @[RACObserve(<span class="keyword">self</span>.inputView.phoneTextField,text),</span><br><span class="line">     								<span class="keyword">self</span>.inputView.phoneTextField.rac_textSignal]];</span><br></pre></td></tr></table></figure>

<h5 id="æ§åˆ¶å™¨ä»£ç "><a href="#æ§åˆ¶å™¨ä»£ç " class="headerlink" title="æ§åˆ¶å™¨ä»£ç "></a>æ§åˆ¶å™¨ä»£ç </h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) LoginViewModel *loginViewModel;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) <span class="keyword">IBOutlet</span> <span class="built_in">UITextField</span> *accountField;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) <span class="keyword">IBOutlet</span> <span class="built_in">UITextField</span> *pwdField;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">weak</span>, <span class="keyword">nonatomic</span>) <span class="keyword">IBOutlet</span> <span class="built_in">UIButton</span> *loginBtn;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">- (LoginViewModel *)loginViewModel &#123;</span><br><span class="line">    <span class="keyword">if</span> (_loginViewModel == <span class="literal">nil</span>) &#123;</span><br><span class="line">        _loginViewModel = [[LoginViewModel alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _loginViewModel;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§†å›¾æ¨¡å‹ç»‘å®š</span></span><br><span class="line">- (<span class="keyword">void</span>)bindModel &#123;</span><br><span class="line">    <span class="comment">// ç»™æ¨¡å‹çš„å±æ€§ç»‘å®šä¿¡å·</span></span><br><span class="line">    <span class="comment">// åªè¦è´¦å·æ–‡æœ¬æ¡†ä¸€æ”¹å˜ï¼Œå°±ä¼šç»™accountèµ‹å€¼</span></span><br><span class="line">    RAC(<span class="keyword">self</span>.loginViewModel.account, account) = _accountField.rac_textSignal;</span><br><span class="line">    RAC(<span class="keyword">self</span>.loginViewModel.account, pwd) = _pwdField.rac_textSignal;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç»‘å®šç™»å½•æŒ‰é’®</span></span><br><span class="line">    RAC(<span class="keyword">self</span>.loginBtn,enabled) = <span class="keyword">self</span>.loginViewModel.enableLoginSignal;</span><br><span class="line">    </span><br><span class="line">   <span class="comment">// ç›‘å¬ç™»å½•æŒ‰é’®ç‚¹å‡»</span></span><br><span class="line">    [[_loginBtn rac_signalForControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">        <span class="comment">// æ‰§è¡Œç™»å½•äº‹ä»¶</span></span><br><span class="line">        [<span class="keyword">self</span>.loginViewModel.LoginCommand execute:<span class="literal">nil</span>];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="VMä»£ç "><a href="#VMä»£ç " class="headerlink" title="VMä»£ç "></a>VMä»£ç </h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">LoginViewModel</span> : <span class="title">NSObject</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) Account *account;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ˜¯å¦å…è®¸ç™»å½•çš„ä¿¡å·</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) RACSignal *enableLoginSignal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) RACCommand *LoginCommand;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">LoginViewModel</span></span></span><br><span class="line">- (Account *)account</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (_account == <span class="literal">nil</span>) &#123;</span><br><span class="line">        _account = [[Account alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _account;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">instancetype</span>)init</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> initialBind];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–ç»‘å®š</span></span><br><span class="line">- (<span class="keyword">void</span>)initialBind &#123;</span><br><span class="line">    <span class="comment">// ç›‘å¬è´¦å·çš„å±æ€§å€¼æ”¹å˜ï¼ŒæŠŠä»–ä»¬èšåˆæˆä¸€ä¸ªä¿¡å·ã€‚</span></span><br><span class="line">    _enableLoginSignal = [RACSignal combineLatest:@[RACObserve(<span class="keyword">self</span>.account, account),RACObserve(<span class="keyword">self</span>.account, pwd)] reduce:^<span class="keyword">id</span>(<span class="built_in">NSString</span> *account,<span class="built_in">NSString</span> *pwd)&#123;</span><br><span class="line">        <span class="keyword">return</span> @(account.length &amp;&amp; pwd.length);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¤„ç†ç™»å½•ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">    _LoginCommand = [[RACCommand alloc] initWithSignalBlock:^RACSignal *(<span class="keyword">id</span> input) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;ç‚¹å‡»äº†ç™»å½•&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">            <span class="comment">// æ¨¡ä»¿ç½‘ç»œå»¶è¿Ÿ</span></span><br><span class="line">            dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">0.5</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                [subscriber sendNext:<span class="string">@&quot;ç™»å½•æˆåŠŸ&quot;</span>];</span><br><span class="line">                <span class="comment">// æ•°æ®ä¼ é€å®Œæ¯•ï¼Œå¿…é¡»è°ƒç”¨å®Œæˆï¼Œå¦åˆ™å‘½ä»¤æ°¸è¿œå¤„äºæ‰§è¡ŒçŠ¶æ€</span></span><br><span class="line">                [subscriber sendCompleted];</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç›‘å¬ç™»å½•äº§ç”Ÿçš„æ•°æ®</span></span><br><span class="line">    [_LoginCommand.executionSignals.switchToLatest subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([x isEqualToString:<span class="string">@&quot;ç™»å½•æˆåŠŸ&quot;</span>]) &#123;</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;ç™»å½•æˆåŠŸ&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç›‘å¬ç™»å½•çŠ¶æ€</span></span><br><span class="line">    [[_LoginCommand.executing skip:<span class="number">1</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([x isEqualToNumber:@(<span class="literal">YES</span>)]) &#123;</span><br><span class="line">            <span class="comment">// æ­£åœ¨ç™»å½•ing... ç”¨è’™ç‰ˆæç¤º</span></span><br><span class="line">            [MBProgressHUD showMessage:<span class="string">@&quot;æ­£åœ¨ç™»å½•...&quot;</span>];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="comment">// ç™»å½•æˆåŠŸ éšè—è’™ç‰ˆ</span></span><br><span class="line">            [MBProgressHUD hideHUD];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-ç™»å½•"><a href="#2-ç™»å½•" class="headerlink" title="2.ç™»å½•"></a>2.ç™»å½•</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å°†ä¿¡å·è¾“å‡ºåº”ç”¨åˆ°å¯¹è±¡å±æ€§ä¸Š</span></span><br><span class="line">RAC(<span class="keyword">self</span>.passwordTextField, backgroundColor) =</span><br><span class="line">[validPasswordSignal</span><br><span class="line">    map:^<span class="keyword">id</span>(<span class="built_in">NSNumber</span> *passwordValid)&#123;</span><br><span class="line">      <span class="keyword">return</span>[passwordValid boolValue] ? [<span class="built_in">UIColor</span> clearColor]:[<span class="built_in">UIColor</span> yellowColor];</span><br><span class="line">&#125;];</span><br><span class="line"> </span><br><span class="line">RAC(<span class="keyword">self</span>.usernameTextField, backgroundColor) =</span><br><span class="line">[validUsernameSignal</span><br><span class="line">    map:^<span class="keyword">id</span>(<span class="built_in">NSNumber</span> *passwordValid)&#123;</span><br><span class="line">     <span class="keyword">return</span>[passwordValid boolValue] ? [<span class="built_in">UIColor</span> clearColor]:[<span class="built_in">UIColor</span> yellowColor];</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">//èšåˆä¿¡å·å†³å®šç™»å½•æŒ‰é’®æ˜¯å¦å¯ç”¨</span></span><br><span class="line">RACSignal *signUpActiveSignal =</span><br><span class="line">  [RACSignal combineLatest:@[validUsernameSignal, validPasswordSignal]</span><br><span class="line">                    reduce:^<span class="keyword">id</span>(<span class="built_in">NSNumber</span>*usernameValid, <span class="built_in">NSNumber</span> *passwordValid)&#123;</span><br><span class="line">                      <span class="keyword">return</span> @([usernameValid boolValue]&amp;&amp;[passwordValid boolValue]);</span><br><span class="line">                    &#125;];</span><br><span class="line">[signUpActiveSignal subscribeNext:^(<span class="built_in">NSNumber</span>*signupActive)&#123;</span><br><span class="line">   <span class="keyword">self</span>.signInButton.enabled =[signupActive boolValue];</span><br><span class="line"> &#125;];</span><br><span class="line"></span><br><span class="line">[[[[<span class="keyword">self</span>.signInButton</span><br><span class="line">   rac_signalForControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>]</span><br><span class="line">   doNext:^(<span class="keyword">id</span> x)&#123; <span class="comment">//é™„åŠ æ“ä½œ</span></span><br><span class="line">     <span class="keyword">self</span>.signInButton.enabled =<span class="literal">NO</span>;</span><br><span class="line">     <span class="keyword">self</span>.signInFailureText.hidden =<span class="literal">YES</span>;</span><br><span class="line">   &#125;]</span><br><span class="line">   flattenMap:^<span class="keyword">id</span>(<span class="keyword">id</span> x)&#123;</span><br><span class="line">     <span class="keyword">return</span>[<span class="keyword">self</span> signInSignal];</span><br><span class="line">   &#125;]</span><br><span class="line">   subscribeNext:^(<span class="built_in">NSNumber</span>*signedIn)&#123;</span><br><span class="line">     <span class="keyword">self</span>.signInButton.enabled =<span class="literal">YES</span>;</span><br><span class="line">     <span class="built_in">BOOL</span> success =[signedIn boolValue];</span><br><span class="line">     <span class="keyword">self</span>.signInFailureText.hidden = success;</span><br><span class="line">     <span class="keyword">if</span>(success)&#123;</span><br><span class="line">       [<span class="keyword">self</span> performSegueWithIdentifier:<span class="string">@&quot;signInSuccess&quot;</span> sender:<span class="keyword">self</span>];</span><br><span class="line">     &#125;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">- (RACSignal *)signInSignal &#123;</span><br><span class="line"><span class="keyword">return</span> [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber)&#123;</span><br><span class="line">   [<span class="keyword">self</span>.signInService </span><br><span class="line">     signInWithUsername:<span class="keyword">self</span>.usernameTextField.text</span><br><span class="line">               password:<span class="keyword">self</span>.passwordTextField.text</span><br><span class="line">               complete:^(<span class="built_in">BOOL</span> success)&#123;</span><br><span class="line">                    [subscriber sendNext:@(success)];</span><br><span class="line">                    [subscriber sendCompleted];</span><br><span class="line">     &#125;];</span><br><span class="line">   	 <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">  &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-MVVMç½‘ç»œè¯·æ±‚"><a href="#3-MVVMç½‘ç»œè¯·æ±‚" class="headerlink" title="3.MVVMç½‘ç»œè¯·æ±‚"></a>3.MVVMç½‘ç»œè¯·æ±‚</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">éœ€æ±‚ï¼šè¯·æ±‚è±†ç“£å›¾ä¹¦ä¿¡æ¯ï¼Œurl:https://api.douban.com/v2/book/search?q=åŸºç¡€</span></span><br><span class="line"><span class="comment">åˆ†æï¼šè¯·æ±‚ä¸€æ ·ï¼Œäº¤ç»™VMæ¨¡å‹ç®¡ç†</span></span><br><span class="line"><span class="comment">æ­¥éª¤:</span></span><br><span class="line"><span class="comment">    1.æ§åˆ¶å™¨æä¾›ä¸€ä¸ªè§†å›¾æ¨¡å‹ï¼ˆrequesViewModelï¼‰ï¼Œå¤„ç†ç•Œé¢çš„ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line"><span class="comment">    2.VMæä¾›ä¸€ä¸ªå‘½ä»¤ï¼Œå¤„ç†è¯·æ±‚ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line"><span class="comment">    3.åœ¨åˆ›å»ºå‘½ä»¤çš„blockä¸­ï¼Œä¼šæŠŠè¯·æ±‚åŒ…è£…æˆä¸€ä¸ªä¿¡å·ï¼Œç­‰è¯·æ±‚æˆåŠŸçš„æ—¶å€™ï¼Œå°±ä¼šæŠŠæ•°æ®ä¼ é€’å‡ºå»ã€‚</span></span><br><span class="line"><span class="comment">    4.è¯·æ±‚æ•°æ®æˆåŠŸï¼Œåº”è¯¥æŠŠå­—å…¸è½¬æ¢æˆæ¨¡å‹ï¼Œä¿å­˜åˆ°è§†å›¾æ¨¡å‹ä¸­ï¼Œæ§åˆ¶å™¨æƒ³ç”¨å°±ç›´æ¥ä»è§†å›¾æ¨¡å‹ä¸­è·å–ã€‚</span></span><br><span class="line"><span class="comment">    5.å‡è®¾æ§åˆ¶å™¨æƒ³å±•ç¤ºå†…å®¹åˆ°tableViewï¼Œç›´æ¥è®©è§†å›¾æ¨¡å‹æˆä¸ºtableViewçš„æ•°æ®æºï¼ŒæŠŠæ‰€æœ‰çš„ä¸šåŠ¡é€»è¾‘äº¤ç»™è§†å›¾æ¨¡å‹å»åšï¼Œè¿™æ ·æ§åˆ¶å™¨çš„ä»£ç å°±éå¸¸å°‘äº†ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h5 id="æ§åˆ¶å™¨ä»£ç -1"><a href="#æ§åˆ¶å™¨ä»£ç -1" class="headerlink" title="æ§åˆ¶å™¨ä»£ç "></a>æ§åˆ¶å™¨ä»£ç </h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> ()</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) <span class="built_in">UITableView</span> *tableView;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) RequestViewModel *requesViewModel;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">ViewController</span></span></span><br><span class="line">- (RequestViewModel *)requesViewModel &#123;</span><br><span class="line">    <span class="keyword">if</span> (_requesViewModel == <span class="literal">nil</span>) &#123;</span><br><span class="line">        _requesViewModel = [[RequestViewModel alloc] init];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _requesViewModel;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</span><br><span class="line">  [<span class="keyword">super</span> viewDidLoad];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆ›å»ºtableView</span></span><br><span class="line">  <span class="built_in">UITableView</span> *tableView = [[<span class="built_in">UITableView</span> alloc] initWithFrame:<span class="keyword">self</span>.view.bounds];</span><br><span class="line">  tableView.dataSource = <span class="keyword">self</span>.requesViewModel;</span><br><span class="line"></span><br><span class="line">  [<span class="keyword">self</span>.view addSubview:tableView];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ‰§è¡Œè¯·æ±‚</span></span><br><span class="line">  RACSignal *requesSiganl = [<span class="keyword">self</span>.requesViewModel.reuqesCommand execute:<span class="literal">nil</span>];</span><br><span class="line">   <span class="comment">// è·å–è¯·æ±‚çš„æ•°æ®</span></span><br><span class="line">    [requesSiganl subscribeNext:^(<span class="built_in">NSArray</span> *x) &#123;</span><br><span class="line">        <span class="keyword">self</span>.requesViewModel.models = x;</span><br><span class="line">        [<span class="keyword">self</span>.tableView reloadData]; </span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h5 id="VMä»£ç -1"><a href="#VMä»£ç -1" class="headerlink" title="VMä»£ç "></a>VMä»£ç </h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">RequestViewModel</span> : <span class="title">NSObject</span>&lt;<span class="title">UITableViewDataSource</span>&gt;</span></span><br><span class="line"><span class="comment">// è¯·æ±‚å‘½ä»¤</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) RACCommand *reuqesCommand;</span><br><span class="line"><span class="comment">//æ¨¡å‹æ•°ç»„</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) <span class="built_in">NSArray</span> *models;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">RequestViewModel</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> initialBind];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)initialBind &#123;</span><br><span class="line">    _reuqesCommand = [[RACCommand alloc] initWithSignalBlock:^RACSignal *(<span class="keyword">id</span> input) &#123;</span><br><span class="line">        </span><br><span class="line">        RACSignal *requestSignal = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">  </span><br><span class="line">            <span class="built_in">NSMutableDictionary</span> *parameters = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">            parameters[<span class="string">@&quot;q&quot;</span>] = <span class="string">@&quot;åŸºç¡€&quot;</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å‘é€è¯·æ±‚</span></span><br><span class="line">            [[AFHTTPRequestOperationManager manager] GET:<span class="string">@&quot;https://api.douban.com/v2/book/search&quot;</span> parameters:parameters success:^(AFHTTPRequestOperation *operation, <span class="keyword">id</span> responseObject) &#123;</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,responseObject);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// è¯·æ±‚æˆåŠŸè°ƒç”¨</span></span><br><span class="line">                <span class="comment">// æŠŠæ•°æ®ç”¨ä¿¡å·ä¼ é€’å‡ºå»</span></span><br><span class="line">                [subscriber sendNext:responseObject];</span><br><span class="line">                [subscriber sendCompleted];</span><br><span class="line"></span><br><span class="line">            &#125; failure:^(AFHTTPRequestOperation *operation, <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">                <span class="comment">// è¯·æ±‚å¤±è´¥è°ƒç”¨</span></span><br><span class="line">            &#125;];</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">        &#125;];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åœ¨è¿”å›æ•°æ®ä¿¡å·æ—¶ï¼ŒæŠŠæ•°æ®ä¸­çš„å­—å…¸æ˜ å°„æˆæ¨¡å‹ä¿¡å·ï¼Œä¼ é€’å‡ºå»</span></span><br><span class="line">        <span class="keyword">return</span> [requestSignal map:^<span class="keyword">id</span>(<span class="built_in">NSDictionary</span> *value) &#123;</span><br><span class="line">            <span class="built_in">NSMutableArray</span> *dictArr = value[<span class="string">@&quot;books&quot;</span>];</span><br><span class="line">            <span class="comment">// å­—å…¸è½¬æ¨¡å‹ï¼Œéå†å­—å…¸ä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œå…¨éƒ¨æ˜ å°„æˆæ¨¡å‹ï¼Œå¹¶ä¸”ç”Ÿæˆæ•°ç»„</span></span><br><span class="line">            <span class="built_in">NSArray</span> *modelArr = [[dictArr.rac_sequence map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">                <span class="keyword">return</span> [Book bookWithDict:value];</span><br><span class="line">            &#125;] array];</span><br><span class="line">            <span class="keyword">return</span> modelArr;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;];</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark - UITableViewDataSource</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSInteger</span>)tableView:(<span class="built_in">UITableView</span> *)tableView numberOfRowsInSection:(<span class="built_in">NSInteger</span>)section</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.models.count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UITableViewCell</span> *)tableView:(<span class="built_in">UITableView</span> *)tableView cellForRowAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSString</span> *ID = <span class="string">@&quot;cell&quot;</span>;</span><br><span class="line">    <span class="built_in">UITableViewCell</span> *cell = [tableView dequeueReusableCellWithIdentifier:ID];</span><br><span class="line">    <span class="keyword">if</span> (cell == <span class="literal">nil</span>) &#123;</span><br><span class="line">        cell = [[<span class="built_in">UITableViewCell</span> alloc] initWithStyle:<span class="built_in">UITableViewCellStyleSubtitle</span> reuseIdentifier:ID];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    Book *book = <span class="keyword">self</span>.models[indexPath.row];</span><br><span class="line">    cell.detailTextLabel.text = book.subtitle;</span><br><span class="line">    cell.textLabel.text = book.title;</span><br><span class="line">    <span class="keyword">return</span> cell;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h4 id="4-Cellå¤ç”¨é—®é¢˜"><a href="#4-Cellå¤ç”¨é—®é¢˜" class="headerlink" title="4.Cellå¤ç”¨é—®é¢˜"></a>4.Cellå¤ç”¨é—®é¢˜</h4><p> Cellå¤ç”¨æ—¶æ¸…ç†æ•°æ®ç»‘å®šæˆ–è€…äº‹ä»¶ç›‘å¬çš„é—®é¢˜</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">SUGoodsCell</span></span></span><br><span class="line">- (<span class="keyword">void</span>) awakeFromNib &#123;</span><br><span class="line">    [<span class="keyword">super</span> awakeFromNib];</span><br><span class="line">    RAC(<span class="keyword">self</span>.usernameLabel,  text) = RACObserve(<span class="keyword">self</span>,  viewModel.username);</span><br><span class="line">    RAC(<span class="keyword">self</span>.userIdLabel,  text) = RACObserve(<span class="keyword">self</span>,  viewModel.userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> æ³¨æ„viewModelå‡ºç°åœ¨RACObserveå®ä¸­é€—å·å³è¾¹ã€‚ è¿™äº› cell ç»ˆå°†è¢«é‡ç”¨ï¼Œæ–°çš„viewModelså°†ä¼šè¢«èµ‹å€¼ï¼Œå¦‚æœæˆ‘ä»¬ä¸å°† viewModelæ”¾åœ¨é€—å·å³è¾¹ï¼Œé‚£å°±ä¼šç›‘å¬viewModelå±æ€§çš„å˜åŒ–ç„¶åæ¯æ¬¡éƒ½è¦é‡æ–°è®¾ç½®ç»‘å®šï¼›å¦‚æœæ”¾åœ¨é€—å·å³è¾¹ï¼Œ RACObserveå°†ä¼šä¸ºæˆ‘ä»¬è´Ÿè´£è¿™äº›äº‹å„¿ï¼Œ å› æ­¤æˆ‘ä»¬åªéœ€è¦è®¾å®šä¸€æ¬¡ç»‘å®šå¹¶è®©Reactive Cocoaåšå‰©ä½™çš„éƒ¨åˆ†</p>
<p> å½“ç„¶ï¼ŒRACç»™UITableViewCellæä¾›äº†ä¸€ä¸ªæ–¹æ³•ï¼šrac_prepareForReuseSignalï¼Œå®ƒçš„ä½œç”¨æ˜¯å½“Cellå³å°†è¦è¢«é‡ç”¨æ—¶ï¼Œå‘Šè¯‰Cellã€‚æƒ³è±¡Cellä¸Šæœ‰å¤šä¸ªbuttonï¼ŒCellåœ¨åˆå§‹åŒ–æ—¶ç»™æ¯ä¸ªbuttonéƒ½addTarget:action:forControlEventsï¼Œè¢«é‡ç”¨æ—¶éœ€è¦å…ˆç§»é™¤è¿™äº›targetï¼Œä¸‹é¢è¿™æ®µä»£ç å°±å¯ä»¥å¾ˆæ–¹ä¾¿åœ°è§£å†³è¿™ä¸ªé—®é¢˜</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[[[<span class="keyword">self</span>.cancelButton</span><br><span class="line">    rac_signalForControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>]</span><br><span class="line">    takeUntil:<span class="keyword">self</span>.rac_prepareForReuseSignal]</span><br><span class="line">    subscribeNext:^(<span class="built_in">UIButton</span> *x) &#123;</span><br><span class="line">    <span class="comment">// do other things</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<ul>
<li>cell å¤ç”¨</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¤–ç•Œè®¢é˜…å¤„ç† </span></span><br><span class="line">cell.button.rx.tap .subscribe(onNext: &#123; () <span class="keyword">in</span> </span><br><span class="line">print(</span><br><span class="line">  <span class="string">&quot;ç‚¹å‡»äº† \(indexPath)&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line">.disposed(by: cell.disposeBag)</span><br><span class="line"> </span><br><span class="line"><span class="comment">// cellå†…éƒ¨å¤„ç† </span></span><br><span class="line">override func prepareForReuse() &#123;</span><br><span class="line">    <span class="keyword">super</span>.prepareForReuse() </span><br><span class="line">    <span class="comment">// é”€æ¯åƒåœ¾è¢‹é‡ç½®</span></span><br><span class="line">    disposeBag = DisposeBag()</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>



<h4 id="5-UITableView-MVVM-RAC"><a href="#5-UITableView-MVVM-RAC" class="headerlink" title="5.UITableView MVVM+RAC"></a>5.UITableView MVVM+RAC</h4><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/119559ac0961">https://www.jianshu.com/p/119559ac0961</a></p>
<p>viewModel ç»‘å®šæ•´ä¸ªè§†å›¾ï¼Œé€šè¿‡ viewModel è·å¾—åˆ—è¡¨ modelåï¼Œåˆ›å»º cellModelï¼ˆcelllçš„viewModelï¼‰ï¼Œæ¯ä¸ª cell ç»‘å®š cellModelï¼Œcell æ ¹æ®cellModelå˜åŒ–è€Œå˜åŒ–</p>
<img src="ReactiveObjCä½¿ç”¨/å›¾ç‰‡2.png" alt="å›¾ç‰‡2" style="zoom:67%;" />

<p>cellå•ç‹¬é…ç½®å¯¹åº”çš„cellviewmodel racç½‘ç»œè¯·æ±‚å›æ¥åï¼ŒæŠŠå®ä½“modelç”¨cellviewmodelè¿›è¡Œç»„è£…ï¼Œ</p>
<p>ä¸»viewmodelè¯·æ±‚æ•°æ® è§£ææˆ [model]</p>
<p>è½¬æ¢æˆ [cellViewModel]</p>
<p>!(cellåŠ äº†ä¸€å±‚viewmodel é¡¹ç›®å˜å¾—å¤æ‚äº†)</p>
<p>cellä¸­æœ‰ä¸ªcellVMæ¥ç®¡ç†cellä¸­è¦æ˜¾ç¤ºçš„æ•°æ®ï¼ŒcellVMæ¥è‡ªäºVCä¸­datasourceæ•°ç»„</p>
<p>ç½‘ç»œè¯·æ±‚å®Œæˆåå°†å­—å…¸-ã€‹æ¨¡å‹ å†é€šè¿‡æ¨¡å‹åˆå§‹åŒ–cellVM å†å°†cellVMæ”¾å…¥datasource</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RAC(_defaultLab, hidden) = [RACObserve(cellModel, idDefault) not];</span><br></pre></td></tr></table></figure>

<h4 id="6-ç½‘ç»œä¸‹å›¾å›¾ç‰‡å®ŒæˆæŒ‰é’®å¯ç‚¹å‡»"><a href="#6-ç½‘ç»œä¸‹å›¾å›¾ç‰‡å®ŒæˆæŒ‰é’®å¯ç‚¹å‡»" class="headerlink" title="6.ç½‘ç»œä¸‹å›¾å›¾ç‰‡å®ŒæˆæŒ‰é’®å¯ç‚¹å‡»"></a>6.ç½‘ç»œä¸‹å›¾å›¾ç‰‡å®ŒæˆæŒ‰é’®å¯ç‚¹å‡»</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">-(<span class="keyword">void</span>)btnAvliableWhenImgOK&#123;</span><br><span class="line">    <span class="comment">//  è§‚å¯Ÿimg æ˜¯å¦ä¿®æ”¹ï¼Œå¦‚æœä¿®æ”¹å°±ä¼šè§¦å‘</span></span><br><span class="line">    RACSignal * imagAvaibaleSignal = [RACObserve(<span class="keyword">self</span>, <span class="keyword">self</span>.imageView.image) map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">        <span class="keyword">return</span>  value ? @YES : @NO;</span><br><span class="line">    &#125;];    </span><br><span class="line">    [imagAvaibaleSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;xx =%@&quot;</span>,x);</span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="keyword">self</span>.shareBtn.rac_command = [[RACCommand alloc] initWithEnabled:imagAvaibaleSignal signalBlock:^RACSignal *(<span class="keyword">id</span> input) &#123;</span><br><span class="line">        <span class="comment">// do share logic</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;input =%@&quot;</span>,input);</span><br><span class="line">        <span class="keyword">return</span> [RACSignal empty];<span class="comment">// å¿…é¡»è¿”å›ä¸€ä¸ªä¿¡å·ï¼Œä¸èƒ½è¿”å›nil</span></span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="comment">// ä¸€ä¸ªcommand éœ€è¦execute æ‰èƒ½è§¦å‘æ‰§è¡Œ ä½†æ˜¯å’Œbtnç»‘å®šçš„commandä¸éœ€è¦</span></span><br><span class="line">    <span class="comment">//  [self.shareBtn.rac_command execute:@&quot;100&quot;];</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="7-tokenå¤±æ•ˆ"><a href="#7-tokenå¤±æ•ˆ" class="headerlink" title="7.tokenå¤±æ•ˆ"></a>7.tokenå¤±æ•ˆ</h4><p>token å¤±æ•ˆåæ•è· errorï¼Œé‡æ–°è¯·æ±‚ tokenï¼Œconcat æ‹¼æ¥ç»§ç»­ä¸Šä¸€æ¬¡è¯·æ±‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *requestSignal = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    <span class="comment">// suppose first time send request, access token is expired or invalid</span></span><br><span class="line">    <span class="comment">// and next time it is correct.</span></span><br><span class="line">    <span class="comment">// the block will be triggered twice.</span></span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">BOOL</span> isFirstTime = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">NSString</span> *url = <span class="string">@&quot;http://httpbin.org/ip&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (!isFirstTime) &#123;</span><br><span class="line">        url = <span class="string">@&quot;http://nonexists.com/error&quot;</span>;</span><br><span class="line">        isFirstTime = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;url:%@&quot;</span>, url);</span><br><span class="line">    [[AFHTTPRequestOperationManager manager] GET:url parameters:<span class="literal">nil</span> success:^(AFHTTPRequestOperation *operation, <span class="keyword">id</span> responseObject) &#123;</span><br><span class="line">        [subscriber sendNext:responseObject];</span><br><span class="line">        [subscriber sendCompleted];</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;subscriber sendcompleted&quot;</span>);</span><br><span class="line">    &#125; failure:^(AFHTTPRequestOperation *operation, <span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;subscriber send error&quot;</span>);</span><br><span class="line">        [subscriber sendError:error];</span><br><span class="line"></span><br><span class="line">    &#125;];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="keyword">self</span>.labelForName.text = <span class="string">@&quot;sending request...&quot;</span>;</span><br><span class="line"><span class="comment">//Subscribes to the returned signal when an error occurs.</span></span><br><span class="line"></span><br><span class="line">[[requestSignal catch:^RACSignal *(<span class="built_in">NSError</span> *error) &#123;<span class="comment">// requestSignal å‘é€error è§¦å‘ catch&#123;&#125;  catch ä¸­è¿”å›çš„signal å‘é€next åœ¨subcribeNextæ¥æ”¶åï¼Œå†è¿½åŠ ä¸€æ¬¡requestSignal</span></span><br><span class="line">    <span class="keyword">self</span>.labelForName.text = <span class="string">@&quot;oops, invalid access token&quot;</span>;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;catch ....&quot;</span>);</span><br><span class="line">    <span class="comment">// æ¨¡æ‹Ÿè·å–tokençš„è¯·æ±‚ï¼Œç„¶åconcat requestSignalï¼Œå†æ¬¡å‘é€ä¹‹å‰çš„è¯·æ±‚</span></span><br><span class="line">    <span class="keyword">return</span> [[RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        <span class="keyword">double</span> delayInSeconds = <span class="number">1.0</span>;</span><br><span class="line">        dispatch_time_t popTime = dispatch_time(DISPATCH_TIME_NOW, (int64_t)(delayInSeconds * <span class="built_in">NSEC_PER_SEC</span>));</span><br><span class="line">        dispatch_after(popTime, dispatch_get_main_queue(), ^(<span class="keyword">void</span>)&#123;</span><br><span class="line">            [subscriber sendNext:@YES];</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@&quot;subscriber sendNext...&quot;</span>);</span><br><span class="line">            [subscriber sendCompleted];</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;]concat:requestSignal];</span><br><span class="line">&#125;] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;next =%@&quot;</span>,x);</span><br><span class="line">    <span class="keyword">if</span> ([x isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">        <span class="keyword">self</span>.labelForName.text = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;result:%@&quot;</span>, x[<span class="string">@&quot;origin&quot;</span>]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125; completed:^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;completed&quot;</span>);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h4 id="8-Command-ç™»å½•"><a href="#8-Command-ç™»å½•" class="headerlink" title="8.Command ç™»å½•"></a>8.Command ç™»å½•</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">self</span>.loginCommand = [[RACCommand alloc] initWithSignalBlock:^RACSignal *(<span class="keyword">id</span> input) &#123;</span><br><span class="line">    <span class="comment">//æ¨¡æ‹Ÿlogin signal</span></span><br><span class="line">    <span class="keyword">return</span> [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        [subscriber sendNext:<span class="string">@&quot;1000&quot;</span>];</span><br><span class="line">        [subscriber sendCompleted];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// -executionSignals returns a signal that includes the signals returned from</span></span><br><span class="line"><span class="comment">// the above block, one for each time the command is executed.</span></span><br><span class="line">[<span class="keyword">self</span>.loginCommand.executionSignals subscribeNext:^(RACSignal *loginSignal) &#123;</span><br><span class="line">    <span class="comment">// Log a message whenever we log in successfully.</span></span><br><span class="line">    [loginSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;xxx  %@&quot;</span>,x);</span><br><span class="line">    &#125;];</span><br><span class="line">    [loginSignal subscribeCompleted:^&#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;Logged in successfully!&quot;</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// Executes the login command when the button is pressed. æŒ‰é’®ç‚¹å‡»è§¦å‘</span></span><br><span class="line"><span class="keyword">self</span>.shareBtn.rac_command = <span class="keyword">self</span>.loginCommand;</span><br></pre></td></tr></table></figure>

<h4 id="9-æœç´¢æ¡†æœç´¢"><a href="#9-æœç´¢æ¡†æœç´¢" class="headerlink" title="9.æœç´¢æ¡†æœç´¢"></a>9.æœç´¢æ¡†æœç´¢</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[[[[[[<span class="keyword">self</span>.textField.rac_textSignal throttle:<span class="number">1</span>]distinctUntilChanged]ignore:<span class="string">@&quot;&quot;</span>] map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;value =%@&quot;</span>,value);</span><br><span class="line">    <span class="keyword">return</span> [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        <span class="comment">//  network request</span></span><br><span class="line">        [subscriber sendNext:value];</span><br><span class="line">        [subscriber sendCompleted];</span><br><span class="line">        <span class="keyword">return</span> [RACDisposable disposableWithBlock:^&#123;</span><br><span class="line">            <span class="comment">//  cancel request</span></span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;] switchToLatest] subscribeNext:^(<span class="keyword">id</span> x) &#123;<span class="comment">// å¦‚æœä¸switchToLastest åˆ™è¿”å›ä¸€ä¸ªsignal</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;x = %@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h4 id="10-MVVM-RAC"><a href="#10-MVVM-RAC" class="headerlink" title="10.MVVM+RAC"></a>10.MVVM+RAC</h4><p>è·å–åˆ—è¡¨æ•°æ®</p>
<p>åœ¨ MVVM é‡Œï¼Œç½‘ç»œé€šä¿¡ç›¸å…³çš„æ“ä½œéƒ½æ˜¯ç”± viewModel æ¥å¤„ç†çš„ï¼Œæ‰€ä»¥åœ¨ ViewModel é‡Œå®šä¹‰ä¸€ä¸ª RACCommand</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*  è·å–æ•°æ®Command</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) RACCommand *fetchProductCommand;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åœ¨ViewModel çš„ init æ–¹æ³•å¯¹å®ƒè¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">_fetchProductCommand = [[RACCommand alloc]initWithSignalBlock:^RACSignal *(<span class="keyword">id</span> input) &#123;</span><br><span class="line">     <span class="keyword">return</span> [[[APIClient sharedClient]</span><br><span class="line">              fetchProductWithPageIndex:@(<span class="number">1</span>)]</span><br><span class="line">              takeUntil:<span class="keyword">self</span>.cancelCommand.executionSignals];</span><br><span class="line"> &#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">//è®¢é˜…Commandï¼Œè·å–æ•°æ®åèµ‹å€¼ç»™ items</span></span><br><span class="line">@weakify(<span class="keyword">self</span>);</span><br><span class="line">[[_fetchProductCommand.executionSignals switchToLatest] subscribeNext:^(ResponseData *response) &#123;</span><br><span class="line">    @strongify(<span class="keyword">self</span>);</span><br><span class="line">    <span class="keyword">if</span> (!response.success) &#123;</span><br><span class="line">        [<span class="keyword">self</span>.errors sendNext:response.error];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.items = [ProductListModel objectArrayWithKeyValuesArray:response.data];</span><br><span class="line">        <span class="keyword">self</span>.page = response.page;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<p>åœ¨ ViewController é‡Œï¼Œè®¢é˜… ViewModel çš„ itemsï¼Œæœ‰å˜åŒ–æ—¶ reload tableview</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[RACObserve(<span class="keyword">self</span>.viewModel, items) subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">     @strongify(<span class="keyword">self</span>);</span><br><span class="line">     [<span class="keyword">self</span>.table reloadData];</span><br><span class="line"> &#125;];</span><br></pre></td></tr></table></figure>

<p>tableView çš„ dataSource</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> mark - UITableViewDataSource</span></span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSInteger</span>)numberOfSectionsInTableView:(<span class="built_in">UITableView</span> *)tableView &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSInteger</span>)tableView:(<span class="built_in">UITableView</span> *)tableView numberOfRowsInSection:(<span class="built_in">NSInteger</span>)section &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.viewModel.items.count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">UITableViewCell</span> *)tableView:(<span class="built_in">UITableView</span> *)tableView cellForRowAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath &#123;</span><br><span class="line">    ProductListCell *cell = [tableView dequeueReusableCellWithIdentifier:<span class="string">@&quot;ProductListCell&quot;</span> forIndexPath:indexPath];</span><br><span class="line">    cell.viewModel = [<span class="keyword">self</span>.viewModel itemViewModelForIndex:indexPath.row];</span><br><span class="line">    <span class="keyword">return</span> cell;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UITableViewCell ä¸­</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)initWithCoder:(<span class="built_in">NSCoder</span> *)aDecoder &#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> initWithCoder:aDecoder];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        @weakify(<span class="keyword">self</span>);</span><br><span class="line">        [RACObserve(<span class="keyword">self</span>, viewModel) subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">            @strongify(<span class="keyword">self</span>);</span><br><span class="line">            <span class="keyword">self</span>.productNameLabel.text = <span class="keyword">self</span>.viewModel.ProductName;</span><br><span class="line">            <span class="keyword">self</span>.bankNameLabel.text = <span class="keyword">self</span>.viewModel.ProductBank;</span><br><span class="line">            <span class="keyword">self</span>.profitLabel.text = <span class="keyword">self</span>.viewModel.ProductProfit;</span><br><span class="line">            <span class="keyword">self</span>.saleStatusLabel.text = <span class="keyword">self</span>.viewModel.SaleStatusCn;</span><br><span class="line">            <span class="keyword">self</span>.productTermLabel.text = <span class="keyword">self</span>.viewModel.ProductTerm;</span><br><span class="line">            <span class="keyword">self</span>.productAmtLabel.text = <span class="keyword">self</span>.viewModel.ProductAmt;</span><br><span class="line">        &#125;];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="11-Error"><a href="#11-Error" class="headerlink" title="11.Error"></a>11.Error</h4><p>BaseViewModel</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">BaseViewModel</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) RACSubject *errors;</span><br></pre></td></tr></table></figure>

<p>ViewModel å¯¹ RACCommand çš„ errors è¿›è¡Œåˆå¹¶</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[[RACSignal merge:@[_fetchProductCommand.errors, <span class="keyword">self</span>.fetchMoreProductCommand.errors]] subscribe:<span class="keyword">self</span>.errors];</span><br></pre></td></tr></table></figure>

<p>RACCommannd åˆ¤æ–­æ˜¯å¦å‡ºç° error</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@weakify(<span class="keyword">self</span>);</span><br><span class="line">[[_fetchProductCommand.executionSignals switchToLatest] subscribeNext:^(ResponseData *response) &#123;</span><br><span class="line">   @strongify(<span class="keyword">self</span>);</span><br><span class="line">   <span class="keyword">if</span> (!response.success) &#123;</span><br><span class="line">       [<span class="keyword">self</span>.errors sendNext:response.error];</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="keyword">self</span>.items = [ProductListModel objectArrayWithKeyValuesArray:response.data];</span><br><span class="line">       <span class="keyword">self</span>.page = response.page;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<p>ViewController ä¸­å¯¹ errors è¿›è¡Œè®¢é˜… </p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[_viewModel.errors subscribeNext:^(<span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">   ResponseData *data = [ResponseData objectWithKeyValues:error.userInfo];</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@&quot;something error:%@&quot;</span>, data.keyValues);</span><br><span class="line">   <span class="comment">//<span class="doctag">TODO:</span> è¿™é‡Œå¯ä»¥é€‰æ‹©ä¸€ç§åˆé€‚çš„æ–¹å¼å°†é”™è¯¯ä¿¡æ¯å±•ç¤ºå‡ºæ¥</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h4 id="12-http-è¯·æ±‚-cancel"><a href="#12-http-è¯·æ±‚-cancel" class="headerlink" title="12.http è¯·æ±‚ cancel"></a>12.http è¯·æ±‚ cancel</h4><p>ViewModel ä¸­å®šä¹‰ä¸€ä¸ªè¡¨ç¤ºå–æ¶ˆHTTPè¯·æ±‚çš„ RACCommand</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>, <span class="keyword">readonly</span>) RACCommand *cancelCommand;</span><br><span class="line"></span><br><span class="line"> _fetchProductCommand = [[RACCommand alloc]initWithSignalBlock:^RACSignal *(<span class="keyword">id</span> input) &#123;</span><br><span class="line">   <span class="keyword">return</span> [[[APIClient sharedClient]</span><br><span class="line">            fetchProductWithPageIndex:@(<span class="number">1</span>)]</span><br><span class="line">            takeUntil:<span class="keyword">self</span>.cancelCommand.executionSignals];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

































<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/manji/p/4846591.html">ä¸€æ¬¡ MVVM+RACå®è·µ</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/e10e5ca413b7">ReactiveCocoaè¿›é˜¶ç¯‡</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/20/ReactiveObjC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="ç®€å•è®°å½•ä¸‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/20/ReactiveObjC/" class="post-title-link" itemprop="url">ReactiveObjC</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-05-20 14:15:08" itemprop="dateCreated datePublished" datetime="2022-05-20T14:15:08+08:00">2022-05-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-05-30 09:04:58" itemprop="dateModified" datetime="2022-05-30T09:04:58+08:00">2022-05-30</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="RACSignal"><a href="#RACSignal" class="headerlink" title="RACSignal"></a>RACSignal</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨æ­¥éª¤</span></span><br><span class="line"><span class="comment">// 1.åˆ›å»ºä¿¡å· + (RACSignal *)createSignal:(RACDisposable * (^)(id&lt;RACSubscriber&gt; subscriber))didSubscribe</span></span><br><span class="line"><span class="comment">// 2.è®¢é˜…ä¿¡å·,æ‰ä¼šæ¿€æ´»ä¿¡å·. - (RACDisposable *)subscribeNext:(void (^)(id x))nextBlock</span></span><br><span class="line"><span class="comment">// 3.å‘é€ä¿¡å· - (void)sendNext:(id)value</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RACSignalåº•å±‚å®ç°ï¼š</span></span><br><span class="line"><span class="comment">// 1.åˆ›å»ºä¿¡å·ï¼Œé¦–å…ˆæŠŠdidSubscribeä¿å­˜åˆ°ä¿¡å·ä¸­ï¼Œè¿˜ä¸ä¼šè§¦å‘ã€‚</span></span><br><span class="line"><span class="comment">// 2.å½“ä¿¡å·è¢«è®¢é˜…ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨signalçš„subscribeNext:nextBlock</span></span><br><span class="line"><span class="comment">// 2.2 subscribeNextå†…éƒ¨ä¼šåˆ›å»ºè®¢é˜…è€…subscriberï¼Œå¹¶ä¸”æŠŠnextBlockä¿å­˜åˆ°subscriberä¸­ã€‚</span></span><br><span class="line"><span class="comment">// 2.1 subscribeNextå†…éƒ¨ä¼šè°ƒç”¨siganlçš„didSubscribe</span></span><br><span class="line"><span class="comment">// 3.siganlçš„didSubscribeä¸­è°ƒç”¨[subscriber sendNext:@1];</span></span><br><span class="line"><span class="comment">// 3.1 sendNextåº•å±‚å…¶å®å°±æ˜¯æ‰§è¡Œsubscriberçš„nextBlock</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.åˆ›å»ºä¿¡å·</span></span><br><span class="line">RACSignal *signal = [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    <span class="comment">// blockè°ƒç”¨æ—¶åˆ»ï¼šæ¯å½“æœ‰è®¢é˜…è€…è®¢é˜…ä¿¡å·ï¼Œå°±ä¼šè°ƒç”¨block</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.å‘é€ä¿¡å·</span></span><br><span class="line">    [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¦‚æœä¸å†å‘é€æ•°æ®ï¼Œæœ€å¥½å‘é€ä¿¡å·å®Œæˆï¼Œå†…éƒ¨ä¼šè‡ªåŠ¨è°ƒç”¨[RACDisposable disposable]å–æ¶ˆè®¢é˜…ä¿¡å·</span></span><br><span class="line">    [subscriber sendCompleted];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [RACDisposable disposableWithBlock:^&#123;</span><br><span class="line">        <span class="comment">// blockè°ƒç”¨æ—¶åˆ»ï¼šå½“ä¿¡å·å‘é€å®Œæˆæˆ–è€…å‘é€é”™è¯¯ï¼Œå°±ä¼šè‡ªåŠ¨æ‰§è¡Œè¿™ä¸ªblock,å–æ¶ˆè®¢é˜…ä¿¡å·</span></span><br><span class="line">        <span class="comment">// æ‰§è¡Œå®ŒBlockåï¼Œå½“å‰ä¿¡å·å°±ä¸åœ¨è¢«è®¢é˜…äº†</span></span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;ä¿¡å·è¢«é”€æ¯&quot;</span>);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">//3.è®¢é˜…ä¿¡å·ï¼Œæ‰ä¼šæ¿€æ´»ä¿¡å·</span></span><br><span class="line">[signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="comment">//blockè°ƒç”¨æ—¶åˆ»ï¼šæ¯å½“æœ‰ä¿¡å·å‘å‡ºæ•°æ®ï¼Œå°±ä¼šè°ƒç”¨block</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;æ¥æ”¶åˆ°æ•°æ®ï¼š%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">ç»“æœï¼š</span></span><br><span class="line"><span class="comment">æ¥æ”¶åˆ°æ•°æ®ï¼š1</span></span><br><span class="line"><span class="comment">ä¿¡å·è¢«é”€æ¯</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h4 id="RacSubscribe"><a href="#RacSubscribe" class="headerlink" title="RacSubscribe"></a>RacSubscribe</h4><p>è¡¨ç¤ºè®¢é˜…è€…çš„æ„æ€ï¼Œç”¨äºå‘é€ä¿¡å·ï¼Œè¿™æ˜¯ä¸€ä¸ªåè®®ï¼Œä¸æ˜¯ä¸€ä¸ªç±»ï¼Œåªè¦éµå®ˆäº†è¿™ä¸ªåè®®ï¼Œå¹¶ä¸”å®ç°æ–¹æ³•æ‰èƒ½æˆä¸ºè®¢é˜…è€…ã€‚é€šè¿‡ create åˆ›å»ºçš„ä¿¡å·ï¼Œéƒ½æœ‰ä¸€ä¸ªè®¢é˜…è€…ï¼Œå¸®åŠ©å‘é€æ•°æ®</p>
<h4 id="RACDisposable"><a href="#RACDisposable" class="headerlink" title="RACDisposable"></a>RACDisposable</h4><p>ç”¨äºå–æ¶ˆè®¢é˜…æˆ–è€…æ¸…ç†èµ„æºï¼Œå½“ä¿¡å·å‘é€å®Œæˆæˆ–è€…å‘é€é”™è¯¯çš„æ—¶å€™ï¼Œå°±ä¼šè‡ªåŠ¨è§¦å‘å®ƒ</p>
<p>ä¸æƒ³ç›‘å¬æŸä¸ªä¿¡å·æ—¶ï¼Œå¯ä»¥é€šè¿‡å®ƒä¸»åŠ¨å–æ¶ˆè®¢é˜…ä¿¡å·</p>
<h4 id="RACSubject"><a href="#RACSubject" class="headerlink" title="RACSubject"></a>RACSubject</h4><p>ä¿¡å·æä¾›è€…ï¼Œè‡ªå·±å¯ä»¥å……å½“ä¿¡å·ï¼Œåˆèƒ½å‘é€ä¿¡å·</p>
<p>é€šå¸¸ç”¨æ¥ä»£æ›¿ä»£ç†ï¼Œæœ‰äº†å®ƒï¼Œå°±ä¸å¿…è¦å®šä¹‰ä»£ç†äº†</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨æ­¥éª¤</span></span><br><span class="line"><span class="comment">// 1.åˆ›å»ºä¿¡å· [RACSubject subject]ï¼Œè·ŸRACSiganlä¸ä¸€æ ·ï¼Œåˆ›å»ºä¿¡å·æ—¶æ²¡æœ‰blockã€‚</span></span><br><span class="line"><span class="comment">// 2.è®¢é˜…ä¿¡å· - (RACDisposable *)subscribeNext:(void (^)(id x))nextBlock</span></span><br><span class="line"><span class="comment">// 3.å‘é€ä¿¡å· sendNext:(id)value</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åº•å±‚å®ç°</span></span><br><span class="line"><span class="comment">// RACSubject:åº•å±‚å®ç°å’ŒRACSignalä¸ä¸€æ ·ã€‚</span></span><br><span class="line"><span class="comment">// 1.è°ƒç”¨subscribeNextè®¢é˜…ä¿¡å·ï¼Œåªæ˜¯æŠŠè®¢é˜…è€…ä¿å­˜èµ·æ¥ï¼Œå¹¶ä¸”è®¢é˜…è€…çš„nextBlockå·²ç»èµ‹å€¼äº†ã€‚</span></span><br><span class="line"><span class="comment">// 2.è°ƒç”¨sendNextå‘é€ä¿¡å·ï¼Œéå†åˆšåˆšä¿å­˜çš„æ‰€æœ‰è®¢é˜…è€…ï¼Œä¸€ä¸ªä¸€ä¸ªè°ƒç”¨è®¢é˜…è€…çš„nextBlock</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç®€å•ä½¿ç”¨</span></span><br><span class="line"><span class="comment">//1.åˆ›å»ºä¿¡å·</span></span><br><span class="line">RACSubject *subject = [RACSubject subject];</span><br><span class="line"><span class="comment">//2.è®¢é˜…ä¿¡å·</span></span><br><span class="line">[subject subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;ç¬¬ä¸€ä¸ªè®¢é˜…è€…%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line">[subject subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;ç¬¬äºŒä¸ªè®¢é˜…è€…%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">//3.å‘é€ä¿¡å·</span></span><br><span class="line">[subject sendNext:<span class="string">@&quot;1&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">ç»“æœ</span></span><br><span class="line"><span class="comment">ç¬¬ä¸€ä¸ªè®¢é˜…è€…1</span></span><br><span class="line"><span class="comment">ç¬¬äºŒä¸ªè®¢é˜…è€…1</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h5 id="RACSubject-æ›¿æ¢ä»£ç†"><a href="#RACSubject-æ›¿æ¢ä»£ç†" class="headerlink" title="RACSubject æ›¿æ¢ä»£ç†"></a>RACSubject æ›¿æ¢ä»£ç†</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// éœ€æ±‚:</span></span><br><span class="line"><span class="comment">// 1.ç»™å½“å‰æ§åˆ¶å™¨æ·»åŠ ä¸€ä¸ªæŒ‰é’®ï¼Œmodalåˆ°å¦ä¸€ä¸ªæ§åˆ¶å™¨ç•Œé¢</span></span><br><span class="line"><span class="comment">// 2.å¦ä¸€ä¸ªæ§åˆ¶å™¨viewä¸­æœ‰ä¸ªæŒ‰é’®ï¼Œç‚¹å‡»æŒ‰é’®ï¼Œé€šçŸ¥å½“å‰æ§åˆ¶å™¨</span></span><br><span class="line"></span><br><span class="line">æ­¥éª¤ä¸€ï¼šåœ¨ç¬¬äºŒä¸ªæ§åˆ¶å™¨.hï¼Œæ·»åŠ ä¸€ä¸ªRACSubjectä»£æ›¿ä»£ç†ã€‚</span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">TwoViewController</span> : <span class="title">UIViewController</span></span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) RACSubject *delegateSignal;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">æ­¥éª¤äºŒï¼šç›‘å¬ç¬¬äºŒä¸ªæ§åˆ¶å™¨æŒ‰é’®ç‚¹å‡»</span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">TwoViewController</span></span></span><br><span class="line">- (<span class="keyword">IBAction</span>)notice:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">   <span class="comment">// é€šçŸ¥ç¬¬ä¸€ä¸ªæ§åˆ¶å™¨ï¼Œå‘Šè¯‰å®ƒï¼ŒæŒ‰é’®è¢«ç‚¹äº†</span></span><br><span class="line">   <span class="comment">// é€šçŸ¥ä»£ç†</span></span><br><span class="line">   <span class="comment">// åˆ¤æ–­ä»£ç†ä¿¡å·æ˜¯å¦æœ‰å€¼</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">self</span>.delegateSignal) &#123;</span><br><span class="line">      <span class="comment">// æœ‰å€¼ï¼Œæ‰éœ€è¦é€šçŸ¥</span></span><br><span class="line">      [<span class="keyword">self</span>.delegateSignal sendNext:<span class="literal">nil</span>];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line">æ­¥éª¤ä¸‰ï¼šåœ¨ç¬¬ä¸€ä¸ªæ§åˆ¶å™¨ä¸­ï¼Œç›‘å¬è·³è½¬æŒ‰é’®ï¼Œç»™ç¬¬äºŒä¸ªæ§åˆ¶å™¨çš„ä»£ç†ä¿¡å·èµ‹å€¼ï¼Œå¹¶ä¸”ç›‘å¬.</span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">OneViewController</span> </span></span><br><span class="line">- (<span class="keyword">IBAction</span>)btnClick:(<span class="keyword">id</span>)sender &#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºç¬¬äºŒä¸ªæ§åˆ¶å™¨</span></span><br><span class="line">  TwoViewController *twoVc = [[TwoViewController alloc] init];</span><br><span class="line">  <span class="comment">// è®¾ç½®ä»£ç†ä¿¡å·</span></span><br><span class="line">  twoVc.delegateSignal = [RACSubject subject];</span><br><span class="line">  <span class="comment">// è®¢é˜…ä»£ç†ä¿¡å·</span></span><br><span class="line">  [twoVc.delegateSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">      <span class="built_in">NSLog</span>(<span class="string">@&quot;ç‚¹å‡»äº†é€šçŸ¥æŒ‰é’®&quot;</span>);</span><br><span class="line">  &#125;];</span><br><span class="line">  <span class="comment">// è·³è½¬åˆ°ç¬¬äºŒä¸ªæ§åˆ¶å™¨</span></span><br><span class="line">  [<span class="keyword">self</span> presentViewController:twoVc animated:<span class="literal">YES</span> completion:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h4 id="RACReplaySubject"><a href="#RACReplaySubject" class="headerlink" title="RACReplaySubject"></a>RACReplaySubject</h4><p>é‡å¤æä¾›ä¿¡å·ç±»ï¼ŒRACSubject çš„å­ç±»</p>
<p>åŒºåˆ«ï¼š</p>
<p>RACReplaySubject å¯ä»¥å…ˆå‘é€ä¿¡å·ï¼Œå†è®¢é˜…ä¿¡å·ã€‚RACSubject å°±ä¸å¯ä»¥</p>
<p>ä½¿ç”¨åœºæ™¯ï¼š</p>
<p>å¦‚æœä¸€ä¸ªä¿¡å·æ¯è¢«è®¢é˜…ä¸€æ¬¡ï¼Œå°±éœ€è¦æŠŠä¹‹å‰çš„å€¼é‡å¤å‘é€ä¸€éï¼Œä½¿ç”¨é‡å¤æä¾›ä¿¡å·ç±»</p>
<p>å¯ä»¥è®¾ç½® capacity æ•°é‡æ¥é™åˆ¶ç¼“å­˜çš„ value çš„æ•°é‡ï¼Œå³ç¼“å­˜æœ€æ–°çš„å‡ ä¸ªå€¼</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RACReplaySubjectä½¿ç”¨æ­¥éª¤:</span></span><br><span class="line"><span class="comment">// 1.åˆ›å»ºä¿¡å· [RACSubject subject]ï¼Œè·ŸRACSiganlä¸ä¸€æ ·ï¼Œåˆ›å»ºä¿¡å·æ—¶æ²¡æœ‰blockã€‚</span></span><br><span class="line"><span class="comment">// 2.å¯ä»¥å…ˆè®¢é˜…ä¿¡å·ï¼Œä¹Ÿå¯ä»¥å…ˆå‘é€ä¿¡å·ã€‚</span></span><br><span class="line"><span class="comment">// 2.1 è®¢é˜…ä¿¡å· - (RACDisposable *)subscribeNext:(void (^)(id x))nextBlock</span></span><br><span class="line"><span class="comment">// 2.2 å‘é€ä¿¡å· sendNext:(id)value</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RACReplaySubject:åº•å±‚å®ç°å’ŒRACSubjectä¸ä¸€æ ·ã€‚</span></span><br><span class="line"><span class="comment">// 1.è°ƒç”¨sendNextå‘é€ä¿¡å·ï¼ŒæŠŠå€¼ä¿å­˜èµ·æ¥ï¼Œç„¶åéå†åˆšåˆšä¿å­˜çš„æ‰€æœ‰è®¢é˜…è€…ï¼Œä¸€ä¸ªä¸€ä¸ªè°ƒç”¨è®¢é˜…è€…çš„nextBlockã€‚</span></span><br><span class="line"><span class="comment">// 2.è°ƒç”¨subscribeNextè®¢é˜…ä¿¡å·ï¼Œéå†ä¿å­˜çš„æ‰€æœ‰å€¼ï¼Œä¸€ä¸ªä¸€ä¸ªè°ƒç”¨è®¢é˜…è€…çš„nextBlock</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¦‚æœæƒ³å½“ä¸€ä¸ªä¿¡å·è¢«è®¢é˜…ï¼Œå°±é‡å¤æ’­æ”¾ä¹‹å‰æ‰€æœ‰å€¼ï¼Œéœ€è¦å…ˆå‘é€ä¿¡å·ï¼Œåœ¨è®¢é˜…ä¿¡å·ã€‚</span></span><br><span class="line"><span class="comment">// ä¹Ÿå°±æ˜¯å…ˆä¿å­˜å€¼ï¼Œåœ¨è®¢é˜…å€¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.åˆ›å»ºä¿¡å·</span></span><br><span class="line">RACReplaySubject *replaySubject = [RACReplaySubject subject];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.å‘é€ä¿¡å·</span></span><br><span class="line">[replaySubject sendNext:@<span class="number">1</span>];</span><br><span class="line">[replaySubject sendNext:@<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.è®¢é˜…ä¿¡å·</span></span><br><span class="line">[replaySubject subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@&quot;ç¬¬ä¸€ä¸ªè®¢é˜…è€…æ¥æ”¶åˆ°çš„æ•°æ®%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¢é˜…ä¿¡å·</span></span><br><span class="line">[replaySubject subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@&quot;ç¬¬äºŒä¸ªè®¢é˜…è€…æ¥æ”¶åˆ°çš„æ•°æ®%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">ç»“æœ</span></span><br><span class="line"><span class="comment">ç¬¬ä¸€ä¸ªè®¢é˜…è€…æ¥æ”¶åˆ°çš„æ•°æ®1</span></span><br><span class="line"><span class="comment">ç¬¬ä¸€ä¸ªè®¢é˜…è€…æ¥æ”¶åˆ°çš„æ•°æ®2</span></span><br><span class="line"><span class="comment">ç¬¬äºŒä¸ªè®¢é˜…è€…æ¥æ”¶åˆ°çš„æ•°æ®1</span></span><br><span class="line"><span class="comment">ç¬¬äºŒä¸ªè®¢é˜…è€…æ¥æ”¶åˆ°çš„æ•°æ®2</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h4 id="RACTuple"><a href="#RACTuple" class="headerlink" title="RACTuple"></a>RACTuple</h4><p>å…ƒç»„ç±»ï¼Œç±»ä¼¼ NSArrayï¼Œç”¨æ¥åŒ…è£…å€¼</p>
<h4 id="RACSequence"><a href="#RACSequence" class="headerlink" title="RACSequence"></a>RACSequence</h4><p>RAC ä¸­çš„é›†åˆç±»ï¼Œç”¨äºä»£æ›¿ NSArrayï¼ŒNSDictionary å¯ä»¥ä½¿ç”¨å®ƒæ¥å¿«é€Ÿéå†æ•°ç»„å’Œå­—å…¸</p>
<h5 id="éå†æ•°ç»„"><a href="#éå†æ•°ç»„" class="headerlink" title="éå†æ•°ç»„"></a>éå†æ•°ç»„</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.éå†æ•°ç»„</span></span><br><span class="line"><span class="built_in">NSArray</span> *numbers = @[@<span class="number">1</span>, @<span class="number">2</span>, @<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™é‡Œå…¶å®æ˜¯ä¸‰æ­¥</span></span><br><span class="line"><span class="comment">// ç¬¬ä¸€æ­¥: æŠŠæ•°ç»„è½¬æ¢æˆé›†åˆRACSequence numbers.rac_sequence</span></span><br><span class="line"><span class="comment">// ç¬¬äºŒæ­¥: æŠŠé›†åˆRACSequenceè½¬æ¢RACSignalä¿¡å·ç±»,numbers.rac_sequence.signal</span></span><br><span class="line"><span class="comment">// ç¬¬ä¸‰æ­¥: è®¢é˜…ä¿¡å·ï¼Œæ¿€æ´»ä¿¡å·ï¼Œä¼šè‡ªåŠ¨æŠŠé›†åˆä¸­çš„æ‰€æœ‰å€¼ï¼Œéå†å‡ºæ¥ã€‚</span></span><br><span class="line">[numbers.rac_sequence.signal subscribeNext:^(<span class="keyword">id</span>  _Nullable x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">ç»“æœ</span></span><br><span class="line"><span class="comment">1</span></span><br><span class="line"><span class="comment">2</span></span><br><span class="line"><span class="comment">3</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h5 id="éå†å­—å…¸"><a href="#éå†å­—å…¸" class="headerlink" title="éå†å­—å…¸"></a>éå†å­—å…¸</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2.éå†å­—å…¸,éå†å‡ºæ¥çš„é”®å€¼å¯¹ä¼šåŒ…è£…æˆRACTuple(å…ƒç»„å¯¹è±¡)</span></span><br><span class="line"><span class="built_in">NSDictionary</span> *dict = @&#123;<span class="string">@&quot;name&quot;</span>: <span class="string">@&quot;jack&quot;</span>, <span class="string">@&quot;age&quot;</span>: @<span class="number">18</span>&#125;;</span><br><span class="line">[dict.rac_sequence.signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">  <span class="comment">// è§£åŒ…å…ƒç»„ï¼Œä¼šæŠŠå…ƒç»„çš„å€¼ï¼ŒæŒ‰é¡ºåºç»™å‚æ•°é‡Œé¢çš„å˜é‡èµ‹å€¼</span></span><br><span class="line">  RACTupleUnpack(<span class="built_in">NSString</span> *key, <span class="built_in">NSString</span> *value) = x;</span><br><span class="line">  <span class="comment">// ç›¸å½“äºä»¥ä¸‹å†™æ³•</span></span><br><span class="line">  <span class="comment">//NSString *key = x[0];</span></span><br><span class="line">  <span class="comment">//NSString *value = x[1];</span></span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;%@ %@&quot;</span>, key, value);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="æ‹¼æ¥æ•°ç»„"><a href="#æ‹¼æ¥æ•°ç»„" class="headerlink" title="æ‹¼æ¥æ•°ç»„"></a>æ‹¼æ¥æ•°ç»„</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSArray</span> *arr1 = @[<span class="string">@&quot;1&quot;</span>, <span class="string">@&quot;2â€];</span></span><br><span class="line"><span class="string">NSArray *arr2 = @[@&quot;</span><span class="number">3</span><span class="string">&quot;, @&quot;</span><span class="number">4</span><span class="string">&quot;];</span></span><br><span class="line"><span class="string">NSArray *arr3 = @[arr1.rac_sequence, arr2.rac_sequence].rac_sequence.flatten.array;</span></span><br><span class="line"><span class="string">//arr3 ä¸¤ä¸ªæ•°ç»„ç›¸åŠ  1 2 3 4</span></span><br></pre></td></tr></table></figure>

<h5 id="å­—å…¸è½¬æ¨¡å‹"><a href="#å­—å…¸è½¬æ¨¡å‹" class="headerlink" title="å­—å…¸è½¬æ¨¡å‹"></a>å­—å…¸è½¬æ¨¡å‹</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 3.1 OCå†™æ³•</span></span><br><span class="line"><span class="built_in">NSString</span> *filePath = [[<span class="built_in">NSBundle</span> mainBundle] pathForResource:<span class="string">@&quot;flags.plist&quot;</span> ofType:<span class="literal">nil</span>];</span><br><span class="line"><span class="built_in">NSArray</span> *dictArr = [<span class="built_in">NSArray</span> arrayWithContentsOfFile:filePath];</span><br><span class="line"><span class="built_in">NSMutableArray</span> *items = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">NSDictionary</span> *dict <span class="keyword">in</span> dictArr) &#123;</span><br><span class="line">    FlagItem *item = [FlagItem flagWithDict:dict];</span><br><span class="line">    [items addObject:item];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.2 RACå†™æ³•</span></span><br><span class="line"><span class="built_in">NSString</span> *filePath = [[<span class="built_in">NSBundle</span> mainBundle] pathForResource:<span class="string">@&quot;flags.plist&quot;</span> ofType:<span class="literal">nil</span>];</span><br><span class="line"><span class="built_in">NSArray</span> *dictArr = [<span class="built_in">NSArray</span> arrayWithContentsOfFile:filePath];</span><br><span class="line"><span class="built_in">NSMutableArray</span> *flags = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">_flags = flags;</span><br><span class="line"><span class="comment">// rac_sequenceæ³¨æ„ç‚¹ï¼šè°ƒç”¨subscribeNextï¼Œå¹¶ä¸ä¼šé©¬ä¸Šæ‰§è¡ŒnextBlockï¼Œè€Œæ˜¯ä¼šç­‰ä¸€ä¼šã€‚</span></span><br><span class="line">[dictArr.rac_sequence.signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="comment">// è¿ç”¨RACéå†å­—å…¸ï¼Œxï¼šå­—å…¸</span></span><br><span class="line">    FlagItem *item = [FlagItem flagWithDict:x];</span><br><span class="line">    [flags addObject:item];</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 3.3 RACé«˜çº§å†™æ³•:</span></span><br><span class="line"><span class="built_in">NSString</span> *filePath = [[<span class="built_in">NSBundle</span> mainBundle] pathForResource:<span class="string">@&quot;flags.plist&quot;</span> ofType:<span class="literal">nil</span>];</span><br><span class="line"><span class="built_in">NSArray</span> *dictArr = [<span class="built_in">NSArray</span> arrayWithContentsOfFile:filePath];</span><br><span class="line"><span class="comment">// map:æ˜ å°„çš„æ„æ€ï¼Œç›®çš„ï¼šæŠŠåŸå§‹å€¼valueæ˜ å°„æˆä¸€ä¸ªæ–°å€¼</span></span><br><span class="line"><span class="comment">// array: æŠŠé›†åˆè½¬æ¢æˆæ•°ç»„</span></span><br><span class="line"><span class="comment">// åº•å±‚å®ç°ï¼šå½“ä¿¡å·è¢«è®¢é˜…ï¼Œä¼šéå†é›†åˆä¸­çš„åŸå§‹å€¼ï¼Œæ˜ å°„æˆæ–°å€¼ï¼Œå¹¶ä¸”ä¿å­˜åˆ°æ–°çš„æ•°ç»„é‡Œã€‚</span></span><br><span class="line"><span class="built_in">NSArray</span> *flags = [[dictArr.rac_sequence map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</span><br><span class="line">    <span class="keyword">return</span> [FlagItem flagWithDict:value];</span><br><span class="line">&#125;] array];</span><br></pre></td></tr></table></figure>

<h4 id="RACCommand"><a href="#RACCommand" class="headerlink" title="RACCommand"></a>RACCommand</h4><p>RAC ä¸­ç”¨äºå¤„ç†äº‹ä»¶çš„ç±»ï¼Œå¯ä»¥æŠŠäº‹ä»¶å¦‚ä½•å¤„ç†ï¼Œäº‹ä»¶ä¸­çš„æ•°æ®å¦‚ä½•ä¼ é€’ï¼ŒåŒ…è£…åˆ°è¿™ä¸ªç±»ä¸­ï¼Œå¯ä»¥æ–¹ä¾¿çš„ç›‘æ§äº‹ä»¶çš„æ•´ä¸ªè¿‡ç¨‹</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸€ã€RACCommandä½¿ç”¨æ­¥éª¤:</span></span><br><span class="line"><span class="comment">// 1.åˆ›å»ºå‘½ä»¤ initWithSignalBlock:(RACSignal * (^)(id input))signalBlock</span></span><br><span class="line"><span class="comment">// 2.åœ¨signalBlockä¸­ï¼Œåˆ›å»ºRACSignalï¼Œå¹¶ä¸”ä½œä¸ºsignalBlockçš„è¿”å›å€¼</span></span><br><span class="line"><span class="comment">// 3.æ‰§è¡Œå‘½ä»¤ - (RACSignal *)execute:(id)input</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// äºŒã€RACCommandä½¿ç”¨æ³¨æ„:</span></span><br><span class="line"><span class="comment">// 1.signalBlockå¿…é¡»è¦è¿”å›ä¸€ä¸ªä¿¡å·ï¼Œä¸èƒ½ä¼ nil.</span></span><br><span class="line"><span class="comment">// 2.å¦‚æœä¸æƒ³è¦ä¼ é€’ä¿¡å·ï¼Œç›´æ¥åˆ›å»ºç©ºçš„ä¿¡å·[RACSignal empty];</span></span><br><span class="line"><span class="comment">// 3.RACCommandä¸­ä¿¡å·å¦‚æœæ•°æ®ä¼ é€’å®Œï¼Œå¿…é¡»è°ƒç”¨[subscriber sendCompleted]ï¼Œè¿™æ—¶å‘½ä»¤æ‰ä¼šæ‰§è¡Œå®Œæ¯•ï¼Œå¦åˆ™æ°¸è¿œå¤„äºæ‰§è¡Œä¸­ã€‚</span></span><br><span class="line"><span class="comment">// 4.RACCommandéœ€è¦è¢«å¼ºå¼•ç”¨ï¼Œå¦åˆ™æ¥æ”¶ä¸åˆ°RACCommandä¸­çš„ä¿¡å·ï¼Œå› æ­¤RACCommandä¸­çš„ä¿¡å·æ˜¯å»¶è¿Ÿå‘é€çš„</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸‰ã€RACCommandè®¾è®¡æ€æƒ³ï¼šå†…éƒ¨signalBlockä¸ºä»€ä¹ˆè¦è¿”å›ä¸€ä¸ªä¿¡å·ï¼Œè¿™ä¸ªä¿¡å·æœ‰ä»€ä¹ˆç”¨ã€‚</span></span><br><span class="line"><span class="comment">// 1.åœ¨RACå¼€å‘ä¸­ï¼Œé€šå¸¸ä¼šæŠŠç½‘ç»œè¯·æ±‚å°è£…åˆ°RACCommandï¼Œç›´æ¥æ‰§è¡ŒæŸä¸ªRACCommandå°±èƒ½å‘é€è¯·æ±‚ã€‚</span></span><br><span class="line"><span class="comment">// 2.å½“RACCommandå†…éƒ¨è¯·æ±‚åˆ°æ•°æ®çš„æ—¶å€™ï¼Œéœ€è¦æŠŠè¯·æ±‚çš„æ•°æ®ä¼ é€’ç»™å¤–ç•Œï¼Œè¿™æ—¶å€™å°±éœ€è¦é€šè¿‡signalBlockè¿”å›çš„ä¿¡å·ä¼ é€’äº†</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å››ã€å¦‚ä½•æ‹¿åˆ°RACCommandä¸­è¿”å›ä¿¡å·å‘å‡ºçš„æ•°æ®ã€‚</span></span><br><span class="line"><span class="comment">// 1.RACCommandæœ‰ä¸ªæ‰§è¡Œä¿¡å·æºexecutionSignalsï¼Œè¿™ä¸ªæ˜¯signal of signals(ä¿¡å·çš„ä¿¡å·),æ„æ€æ˜¯ä¿¡å·å‘å‡ºçš„æ•°æ®æ˜¯ä¿¡å·ï¼Œä¸æ˜¯æ™®é€šçš„ç±»å‹ã€‚</span></span><br><span class="line"><span class="comment">// 2.è®¢é˜…executionSignalså°±èƒ½æ‹¿åˆ°RACCommandä¸­è¿”å›çš„ä¿¡å·ï¼Œç„¶åè®¢é˜…signalBlockè¿”å›çš„ä¿¡å·ï¼Œå°±èƒ½è·å–å‘å‡ºçš„å€¼ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// äº”ã€ç›‘å¬å½“å‰å‘½ä»¤æ˜¯å¦æ­£åœ¨æ‰§è¡Œexecuting</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å…­ã€ä½¿ç”¨åœºæ™¯,ç›‘å¬æŒ‰é’®ç‚¹å‡»ï¼Œç½‘ç»œè¯·æ±‚</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1.åˆ›å»ºå‘½ä»¤</span></span><br><span class="line">RACCommand *command = [[RACCommand alloc] initWithSignalBlock:^RACSignal * (<span class="keyword">id</span> input) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;æ‰§è¡Œå‘½ä»¤&quot;</span>);</span><br><span class="line">    <span class="comment">// 2.åˆ›å»ºä¿¡å·,ç”¨æ¥ä¼ é€’æ•°æ®</span></span><br><span class="line">    <span class="keyword">return</span> [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        [subscriber sendNext:<span class="string">@&quot;è¯·æ±‚æ•°æ®&quot;</span>];</span><br><span class="line">        <span class="comment">// æ³¨æ„ï¼šæ•°æ®ä¼ é€’å®Œï¼Œæœ€å¥½è°ƒç”¨sendCompletedï¼Œè¿™æ—¶å‘½ä»¤æ‰æ‰§è¡Œå®Œæ¯•</span></span><br><span class="line">        [subscriber sendCompleted];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// å¼ºå¼•ç”¨å‘½ä»¤ï¼Œä¸è¦è¢«é”€æ¯ï¼Œå¦åˆ™æ¥æ”¶ä¸åˆ°æ•°æ®</span></span><br><span class="line">_command = command;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.è®¢é˜…RACCommandä¸­çš„ä¿¡å·</span></span><br><span class="line">[command.executionSignals subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    [x subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, x);</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// RACé«˜çº§ç”¨æ³•</span></span><br><span class="line"><span class="comment">// switchToLatest:ç”¨äºsignal of signalsï¼Œè·å–signal of signalså‘å‡ºçš„æœ€æ–°ä¿¡å·,ä¹Ÿå°±æ˜¯å¯ä»¥ç›´æ¥æ‹¿åˆ°RACCommandä¸­çš„ä¿¡å·</span></span><br><span class="line">[command.executionSignals.switchToLatest subscribeNext:^(<span class="keyword">id</span>  _Nullable x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">[[command.executing skip:<span class="number">1</span>] subscribeNext:^(<span class="built_in">NSNumber</span> * x) &#123;</span><br><span class="line">    <span class="keyword">if</span> ([x boolValue] == <span class="literal">YES</span>) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;æ­£åœ¨æ‰§è¡Œ&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@&quot;æ‰§è¡Œå®Œæˆ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5.æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">[command execute:@<span class="number">1</span>];</span><br></pre></td></tr></table></figure>

<h4 id="RACMulticastConnection"><a href="#RACMulticastConnection" class="headerlink" title="RACMulticastConnection"></a>RACMulticastConnection</h4><p>ç”¨äºå½“ä¸€ä¸ªä¿¡å·ï¼Œè¢«å¤šæ¬¡è®¢é˜…æ—¶ï¼Œä¸ºäº†ä¿è¯åˆ›å»ºä¿¡å·æ—¶ï¼Œé¿å…å¤šæ¬¡è°ƒç”¨åˆ›å»ºä¿¡å·ä¸­çš„ blockï¼Œé€ æˆå‰¯ä½œç”¨ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªç±»å‹å¤„ç†</p>
<p>è§£å†³é‡å¤è¯·æ±‚çš„é—®é¢˜</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// RACMulticastConnectionä½¿ç”¨æ­¥éª¤:</span></span><br><span class="line"><span class="comment">// 1.åˆ›å»ºä¿¡å· + (RACSignal *)createSignal:(RACDisposable * (^)(id&lt;RACSubscriber&gt; subscriber))didSubscribe</span></span><br><span class="line"><span class="comment">// 2.åˆ›å»ºè¿æ¥ RACMulticastConnection *connect = [signal publish];</span></span><br><span class="line"><span class="comment">// 3.è®¢é˜…ä¿¡å·,æ³¨æ„ï¼šè®¢é˜…çš„ä¸å†æ˜¯ä¹‹å‰çš„ä¿¡å·ï¼Œè€Œæ˜¯è¿æ¥çš„ä¿¡å·ã€‚ [connect.signal subscribeNext:nextBlock]</span></span><br><span class="line"><span class="comment">// 4.è¿æ¥ [connect connect]</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// RACMulticastConnectionåº•å±‚åŸç†:</span></span><br><span class="line"><span class="comment">// 1.åˆ›å»ºconnectï¼Œconnect.sourceSignal -&gt; RACSignal(åŸå§‹ä¿¡å·)  connect.signal -&gt; RACSubject</span></span><br><span class="line"><span class="comment">// 2.è®¢é˜…connect.signalï¼Œä¼šè°ƒç”¨RACSubjectçš„subscribeNextï¼Œåˆ›å»ºè®¢é˜…è€…ï¼Œè€Œä¸”æŠŠè®¢é˜…è€…ä¿å­˜èµ·æ¥ï¼Œä¸ä¼šæ‰§è¡Œblockã€‚</span></span><br><span class="line"><span class="comment">// 3.[connect connect]å†…éƒ¨ä¼šè®¢é˜…RACSignal(åŸå§‹ä¿¡å·)ï¼Œå¹¶ä¸”è®¢é˜…è€…æ˜¯RACSubject</span></span><br><span class="line"><span class="comment">// 3.1.è®¢é˜…åŸå§‹ä¿¡å·ï¼Œå°±ä¼šè°ƒç”¨åŸå§‹ä¿¡å·ä¸­çš„didSubscribe</span></span><br><span class="line"><span class="comment">// 3.2 didSubscribeï¼Œæ‹¿åˆ°è®¢é˜…è€…è°ƒç”¨sendNextï¼Œå…¶å®æ˜¯è°ƒç”¨RACSubjectçš„sendNext</span></span><br><span class="line"><span class="comment">// 4.RACSubjectçš„sendNext,ä¼šéå†RACSubjectæ‰€æœ‰è®¢é˜…è€…å‘é€ä¿¡å·ã€‚</span></span><br><span class="line"><span class="comment">// 4.1 å› ä¸ºåˆšåˆšç¬¬äºŒæ­¥ï¼Œéƒ½æ˜¯åœ¨è®¢é˜…RACSubjectï¼Œå› æ­¤ä¼šæ‹¿åˆ°ç¬¬äºŒæ­¥æ‰€æœ‰çš„è®¢é˜…è€…ï¼Œè°ƒç”¨ä»–ä»¬çš„nextBlock</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// éœ€æ±‚ï¼šå‡è®¾åœ¨ä¸€ä¸ªä¿¡å·ä¸­å‘é€è¯·æ±‚ï¼Œæ¯æ¬¡è®¢é˜…ä¸€æ¬¡éƒ½ä¼šå‘é€è¯·æ±‚ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´å¤šæ¬¡è¯·æ±‚ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1.åˆ›å»ºè¯·æ±‚ä¿¡å·</span></span><br><span class="line">RACSignal *signal1 = [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;å‘é€è¯·æ±‚&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// 2.è®¢é˜…ä¿¡å·</span></span><br><span class="line">[signal1 subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;æ¥æ”¶æ•°æ®&quot;</span>);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// 2.è®¢é˜…ä¿¡å·</span></span><br><span class="line">[signal1 subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;æ¥æ”¶æ•°æ®&quot;</span>);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">è¿è¡Œç»“æœï¼Œä¼šæ‰§è¡Œä¸¤éå‘é€è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡è®¢é˜…éƒ½ä¼šå‘é€ä¸€æ¬¡è¯·æ±‚</span></span><br><span class="line"><span class="comment">å‘é€è¯·æ±‚</span></span><br><span class="line"><span class="comment">å‘é€è¯·æ±‚</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è§£å†³ï¼šä½¿ç”¨RACMulticastConnectionå°±èƒ½è§£å†³.</span></span><br><span class="line"><span class="comment">// 1.åˆ›å»ºè¯·æ±‚ä¿¡å·</span></span><br><span class="line">RACSignal *signal = [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;å‘é€è¯·æ±‚&quot;</span>);</span><br><span class="line">    [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">RACMulticastConnection *connect = [signal publish];</span><br><span class="line"><span class="comment">// 2.è®¢é˜…ä¿¡å·</span></span><br><span class="line">[connect.signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;è®¢é˜…è€…ä¸€ä¿¡å·%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// 2.è®¢é˜…ä¿¡å·</span></span><br><span class="line">[connect.signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;è®¢é˜…è€…äºŒä¿¡å·%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line">[connect connect];</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">å‘é€è¯·æ±‚</span></span><br><span class="line"><span class="comment">è®¢é˜…è€…ä¸€ä¿¡å·1</span></span><br><span class="line"><span class="comment">è®¢é˜…è€…äºŒä¿¡å·1</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h4 id="RACScheduler"><a href="#RACScheduler" class="headerlink" title="RACScheduler"></a>RACScheduler</h4><p>RAC ä¸­çš„é˜Ÿåˆ—ï¼Œç”¨ GCD å°è£…çš„</p>
<h4 id="RACUnit"><a href="#RACUnit" class="headerlink" title="RACUnit"></a>RACUnit</h4><p>è¡¨ç¤º stream ä¸åŒ…å«æœ‰æ„ä¹‰çš„å€¼ï¼Œå¯ä»¥ç†è§£ä¸º nil</p>
<h4 id="RACEvent"><a href="#RACEvent" class="headerlink" title="RACEvent"></a>RACEvent</h4><p>æŠŠæ•°æ®åŒ…è£…æˆä¿¡å·äº‹ä»¶ï¼ˆsignal eventï¼‰</p>
<h4 id="å¸¸è§ç”¨æ³•"><a href="#å¸¸è§ç”¨æ³•" class="headerlink" title="å¸¸è§ç”¨æ³•"></a>å¸¸è§ç”¨æ³•</h4><h5 id="ä»£æ›¿ä»£ç†"><a href="#ä»£æ›¿ä»£ç†" class="headerlink" title="ä»£æ›¿ä»£ç†"></a>ä»£æ›¿ä»£ç†</h5><p>rac_signalForSelectorï¼šç”¨äºä»£æ›¿ä»£ç†</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// éœ€æ±‚ï¼šè‡ªå®šä¹‰redView,ç›‘å¬çº¢è‰²viewä¸­æŒ‰é’®ç‚¹å‡»</span></span><br><span class="line"><span class="comment">// ä¹‹å‰éƒ½æ˜¯éœ€è¦é€šè¿‡ä»£ç†ç›‘å¬ï¼Œç»™çº¢è‰²Viewæ·»åŠ ä¸€ä¸ªä»£ç†å±æ€§ï¼Œç‚¹å‡»æŒ‰é’®çš„æ—¶å€™ï¼Œé€šçŸ¥ä»£ç†åšäº‹æƒ…</span></span><br><span class="line"><span class="comment">// rac_signalForSelector:æŠŠè°ƒç”¨æŸä¸ªå¯¹è±¡çš„æ–¹æ³•çš„ä¿¡æ¯è½¬æ¢æˆä¿¡å·ï¼Œå°±è¦è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå°±ä¼šå‘é€ä¿¡å·ã€‚</span></span><br><span class="line"><span class="comment">// è¿™é‡Œè¡¨ç¤ºåªè¦redVè°ƒç”¨btnClick:,å°±ä¼šå‘å‡ºä¿¡å·ï¼Œè®¢é˜…å°±å¥½äº†ã€‚</span></span><br><span class="line"></span><br><span class="line">[[redView rac_signalForSelector:<span class="keyword">@selector</span>(btnAction:)] subscribeNext:^(RACTuple *x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;çº¢è‰²æŒ‰é’®ç‚¹å‡»&quot;</span>);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="keyword">self</span> rac_signalForSelector:<span class="keyword">@selector</span>(scrollViewDidScroll:) fromProtocol:<span class="class"><span class="keyword">@protocol</span>(<span class="title">UIScrollViewDelegate</span>)] <span class="title">subscribeNext</span>:^(<span class="title">RACTuple</span> *<span class="title">tuple</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>



<h5 id="ä»£æ›¿KVO"><a href="#ä»£æ›¿KVO" class="headerlink" title="ä»£æ›¿KVO"></a>ä»£æ›¿KVO</h5><p>rac_valuesAndChangesForKeyPathï¼šç”¨äºç›‘å¬æŸä¸ªå¯¹è±¡çš„å±æ€§æ”¹å˜</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æŠŠç›‘å¬redVçš„centerå±æ€§æ”¹å˜è½¬æ¢æˆä¿¡å·ï¼Œåªè¦å€¼æ”¹å˜å°±ä¼šå‘é€ä¿¡å·</span></span><br><span class="line"><span class="comment">// observer:å¯ä»¥ä¼ å…¥nil</span></span><br><span class="line">[[redView rac_valuesAndChangesForKeyPath:<span class="string">@&quot;center&quot;</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> observer:<span class="literal">nil</span>] subscribeNext:^(RACTwoTuple&lt;<span class="keyword">id</span>,<span class="built_in">NSDictionary</span> *&gt; *x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="ç›‘å¬äº‹ä»¶"><a href="#ç›‘å¬äº‹ä»¶" class="headerlink" title="ç›‘å¬äº‹ä»¶"></a>ç›‘å¬äº‹ä»¶</h5><p>rac_signalForControlEventsï¼šç”¨äºç›‘å¬æŸä¸ªäº‹ä»¶</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æŠŠæŒ‰é’®ç‚¹å‡»äº‹ä»¶è½¬æ¢ä¸ºä¿¡å·ï¼Œç‚¹å‡»æŒ‰é’®ï¼Œå°±ä¼šå‘é€ä¿¡å·</span></span><br><span class="line">[[<span class="keyword">self</span>.btn rac_signalForControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>] subscribeNext:^(<span class="built_in">UIControl</span> *x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;æŒ‰é’®è¢«ç‚¹å‡»&quot;</span>);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="ä»£æ›¿é€šçŸ¥"><a href="#ä»£æ›¿é€šçŸ¥" class="headerlink" title="ä»£æ›¿é€šçŸ¥"></a>ä»£æ›¿é€šçŸ¥</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æŠŠç›‘å¬åˆ°çš„é€šçŸ¥è½¬æ¢ä¿¡å·</span></span><br><span class="line">[[[<span class="built_in">NSNotificationCenter</span> defaultCenter] rac_addObserverForName:<span class="built_in">UIKeyboardWillShowNotification</span> object:<span class="literal">nil</span>] subscribeNext:^(<span class="built_in">NSNotification</span> *x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;é”®ç›˜å¼¹å‡º&quot;</span>);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="ç›‘å¬æ–‡æœ¬æ¡†æ–‡å­—æ”¹å˜"><a href="#ç›‘å¬æ–‡æœ¬æ¡†æ–‡å­—æ”¹å˜" class="headerlink" title="ç›‘å¬æ–‡æœ¬æ¡†æ–‡å­—æ”¹å˜"></a>ç›‘å¬æ–‡æœ¬æ¡†æ–‡å­—æ”¹å˜</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 5.ç›‘å¬æ–‡æœ¬æ¡†çš„æ–‡å­—æ”¹å˜</span></span><br><span class="line">[_textField.rac_textSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@&quot;æ–‡å­—æ”¹å˜äº†%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="å¤šæ¬¡è¯·æ±‚ï¼Œéƒ½è·å–åˆ°æ•°æ®æ‰å±•ç¤ºç•Œé¢"><a href="#å¤šæ¬¡è¯·æ±‚ï¼Œéƒ½è·å–åˆ°æ•°æ®æ‰å±•ç¤ºç•Œé¢" class="headerlink" title="å¤šæ¬¡è¯·æ±‚ï¼Œéƒ½è·å–åˆ°æ•°æ®æ‰å±•ç¤ºç•Œé¢"></a>å¤šæ¬¡è¯·æ±‚ï¼Œéƒ½è·å–åˆ°æ•°æ®æ‰å±•ç¤ºç•Œé¢</h5><p><code>rac_liftSelector:withSignalsFromArray:Signals</code> ï¼šå½“ä¼ å…¥çš„Signals(ä¿¡å·æ•°ç»„)ï¼Œæ¯ä¸€ä¸ªsignaléƒ½è‡³å°‘sendNextè¿‡ä¸€æ¬¡ï¼Œå°±ä¼šå»è§¦å‘ç¬¬ä¸€ä¸ªselectorå‚æ•°çš„æ–¹æ³•</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 6.å¤„ç†å¤šä¸ªè¯·æ±‚ï¼Œéƒ½è¿”å›ç»“æœçš„æ—¶å€™ï¼Œç»Ÿä¸€åšå¤„ç†.</span></span><br><span class="line">RACSignal *request1 = [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:<span class="string">@&quot;å‘é€è¯·æ±‚1&quot;</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line">RACSignal *request2 = [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:<span class="string">@&quot;å‘é€è¯·æ±‚2&quot;</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// ä½¿ç”¨æ³¨æ„ï¼šå‡ ä¸ªä¿¡å·ï¼Œå‚æ•°ä¸€çš„æ–¹æ³•å°±å‡ ä¸ªå‚æ•°ï¼Œæ¯ä¸ªå‚æ•°å¯¹åº”ä¿¡å·å‘å‡ºçš„æ•°æ®ã€‚</span></span><br><span class="line">[<span class="keyword">self</span> rac_liftSelector:<span class="keyword">@selector</span>(updateUIWithR1:r2:) withSignalsFromArray:@[request1, request2]];</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)updateUIWithR1:(<span class="keyword">id</span>)data1 r2:(<span class="keyword">id</span>)data2 &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;æ›´æ–°UI %@ %@&quot;</span>, data1, data2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å¸¸è§å®"><a href="#å¸¸è§å®" class="headerlink" title="å¸¸è§å®"></a>å¸¸è§å®</h4><ul>
<li>RAC(TARGET, â€¦)</li>
</ul>
<p>ç»™æŸä¸ªå¯¹è±¡ç»‘å®šå±æ€§</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åªè¦æ–‡æœ¬æ¡†æ–‡å­—æ”¹å˜ï¼Œå°±ä¼šä¿®æ”¹labelçš„æ–‡å­—</span></span><br><span class="line">RAC(<span class="keyword">self</span>.labelView,text) = _textField.rac_textSignal;</span><br></pre></td></tr></table></figure>

<ul>
<li>RACObserve(TARGET, KEYPATH)</li>
</ul>
<p>ç›‘å¬æŸä¸ªå¯¹è±¡çš„æŸä¸ªå±æ€§ï¼Œè¿”å›çš„æ˜¯ä¿¡å·</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[RACObserve(<span class="keyword">self</span>.view, center) subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<ul>
<li>@weakify(Obj)å’Œ@strongify(Obj)</li>
</ul>
<p>éœ€è¦è‡ªå·±æ‰‹åŠ¨å¯¼å…¥ RACEXTScope.h æ‰å¯ä½¿ç”¨</p>
<ul>
<li>RACTuplePack</li>
</ul>
<p>æŠŠæ•°æ®åŒ…è£…æˆ RACTupleï¼ˆå…ƒç»„ç±»ï¼‰</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RACTuple *tuple = RACTuplePack(@<span class="number">1</span>, @<span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>RACTupleUnpack</li>
</ul>
<p>æŠŠ RACTupleï¼ˆå…ƒç»„ç±»ï¼‰è§£åŒ…æˆå¯¹åº”æ•°æ®</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RACTuple *tuple = RACTuplePack(<span class="string">@&quot;jack&quot;</span>, @<span class="number">20</span>);</span><br><span class="line">RACTupleUnpack(<span class="built_in">NSString</span> *name, <span class="built_in">NSNumber</span> *age) = tuple;</span><br></pre></td></tr></table></figure>

<h4 id="å¸¸è§æ“ä½œæ–¹æ³•"><a href="#å¸¸è§æ“ä½œæ–¹æ³•" class="headerlink" title="å¸¸è§æ“ä½œæ–¹æ³•"></a>å¸¸è§æ“ä½œæ–¹æ³•</h4><p>RACå¼€å‘ï¼Œåº”è¯¥æŠŠé‡å¿ƒæ”¾åœ¨ç»‘å®šï¼Œä¹Ÿå°±æ˜¯å¯ä»¥åœ¨åˆ›å»ºä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œå°±ç»‘å®šå¥½ä»¥åæƒ³è¦åšçš„äº‹æƒ…ï¼Œè€Œä¸æ˜¯ç­‰èµ‹å€¼ä¹‹ååœ¨å»åšäº‹æƒ…</p>
<p>åˆ—å¦‚ï¼šæŠŠæ•°æ®å±•ç¤ºåˆ°æ§ä»¶ä¸Šï¼Œä¹‹å‰éƒ½æ˜¯é‡å†™æ§ä»¶çš„setModelæ–¹æ³•ï¼Œç”¨RACå°±å¯ä»¥åœ¨ä¸€å¼€å§‹åˆ›å»ºæ§ä»¶çš„æ—¶å€™ï¼Œå°±ç»‘å®šå¥½æ•°æ®</p>
<h5 id="æ˜ å°„-flattenMap-Map"><a href="#æ˜ å°„-flattenMap-Map" class="headerlink" title="æ˜ å°„ flattenMap Map"></a>æ˜ å°„ flattenMap Map</h5><p>ç”¨äºæŠŠæºä¿¡å·å†…å®¹æ˜ å°„æˆæ–°çš„å†…å®¹</p>
<ul>
<li>flattenMap</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// flattenMapä½œç”¨:æŠŠæºä¿¡å·çš„å†…å®¹æ˜ å°„æˆä¸€ä¸ªæ–°çš„ä¿¡å·ï¼Œä¿¡å·å¯ä»¥æ˜¯ä»»æ„ç±»å‹</span></span><br><span class="line"></span><br><span class="line">[[_textField.rac_textSignal flattenMap:^__kindof RACSignal * (<span class="built_in">NSString</span> *value) &#123;</span><br><span class="line">    <span class="comment">// è¿”å›å€¼ï¼šç»‘å®šä¿¡å·çš„å†…å®¹.</span></span><br><span class="line">    <span class="keyword">return</span> [RACReturnSignal <span class="keyword">return</span>:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;è¾“å‡º:%@&quot;</span>, value]];</span><br><span class="line">&#125;] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<ul>
<li>Map</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç›‘å¬æ–‡æœ¬æ¡†çš„å†…å®¹æ”¹å˜ï¼ŒæŠŠç»“æ„é‡æ–°æ˜ å°„æˆä¸€ä¸ªæ–°å€¼</span></span><br><span class="line"></span><br><span class="line">[[_textField.rac_textSignal map:^<span class="keyword">id</span> (<span class="built_in">NSString</span> * value) &#123;</span><br><span class="line">  	<span class="comment">// è¿”å›å€¼ï¼šå°±æ˜¯å¤„ç†å®Œæºä¿¡å·çš„å†…å®¹ã€‚</span></span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;è¾“å‡º:%@&quot;</span>, value];</span><br><span class="line">&#125;] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<ul>
<li>åŒºåˆ«</li>
</ul>
<p>flattenMap ä¸­çš„ block è¿”å›ä¿¡å·</p>
<p>Map ä¸­çš„ block è¿”å›å¯¹è±¡</p>
<p>signal of signal ç”¨ flattenMap</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">RACSubject *signalOfSignals = [RACSubject subject];</span><br><span class="line">RACSubject *signal = [RACSubject subject];</span><br><span class="line"></span><br><span class="line">[[signalOfSignals flattenMap:^__kindof RACSignal * (<span class="keyword">id</span> value) &#123;</span><br><span class="line">    <span class="comment">// å½“signalOfsignalsçš„signalså‘å‡ºä¿¡å·æ‰ä¼šè°ƒç”¨</span></span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="comment">// åªæœ‰signalOfsignalsçš„signalå‘å‡ºä¿¡å·æ‰ä¼šè°ƒç”¨ï¼Œ</span></span><br><span class="line">    <span class="comment">// å› ä¸ºå†…éƒ¨è®¢é˜…äº†bindBlockä¸­è¿”å›çš„ä¿¡å·ï¼Œä¹Ÿå°±æ˜¯flattenMapè¿”å›çš„ä¿¡å·ã€‚</span></span><br><span class="line">    <span class="comment">// ä¹Ÿå°±æ˜¯flattenMapè¿”å›çš„ä¿¡å·å‘å‡ºå†…å®¹ï¼Œæ‰ä¼šè°ƒç”¨ã€‚</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@aaa&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// ä¿¡å·çš„ä¿¡å·å‘é€ä¿¡å·</span></span><br><span class="line">[signalOfSignals sendNext:signal];</span><br><span class="line"><span class="comment">// ä¿¡å·å‘é€å†…å®¹</span></span><br><span class="line">[signal sendNext:@<span class="number">1</span>];</span><br></pre></td></tr></table></figure>

<h5 id="ç»„åˆ-concat"><a href="#ç»„åˆ-concat" class="headerlink" title="ç»„åˆ concat"></a>ç»„åˆ concat</h5><p>æŒ‰ä¸€å®šé¡ºåºæ‹¼æ¥ä¿¡å·ï¼Œå½“å¤šä¸ªä¿¡å·å‘å‡ºçš„æ—¶å€™ï¼Œæœ‰é¡ºåºçš„æ¥æ”¶ä¿¡å·</p>
<p>å‰é¢ä¿¡å·å‘é€å®Œæˆï¼Œåé¢ä¿¡å·æ‰è¢«æ¿€æ´»</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *signalA = [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">    [subscriber sendCompleted];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line">RACSignal *signalB = [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt;  subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:@<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// æŠŠsignalAæ‹¼æ¥åˆ°signalBåï¼ŒsignalAå‘é€å®Œæˆï¼ŒsignalBæ‰ä¼šè¢«æ¿€æ´»</span></span><br><span class="line">RACSignal *concatSignal = [signalA concat:signalB];</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»¥ååªéœ€è¦é¢å¯¹æ‹¼æ¥ä¿¡å·å¼€å‘ã€‚</span></span><br><span class="line"><span class="comment">// è®¢é˜…æ‹¼æ¥çš„ä¿¡å·ï¼Œä¸éœ€è¦å•ç‹¬è®¢é˜…signalAï¼ŒsignalB</span></span><br><span class="line"><span class="comment">// å†…éƒ¨ä¼šè‡ªåŠ¨è®¢é˜…ã€‚</span></span><br><span class="line"><span class="comment">// æ³¨æ„ï¼šç¬¬ä¸€ä¸ªä¿¡å·å¿…é¡»å‘é€å®Œæˆï¼Œç¬¬äºŒä¸ªä¿¡å·æ‰ä¼šè¢«æ¿€æ´»</span></span><br><span class="line">[concatSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">1</span></span><br><span class="line"><span class="comment">2</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *concatSignal =  [[signalA concat:signalC] concat:signalB]; </span><br><span class="line"><span class="comment">//æˆ–è€…</span></span><br><span class="line">RACSignal *concatSignal =  [RACSignal concat:@[signalA,signalC,signalB] ];</span><br></pre></td></tr></table></figure>

<h5 id="then"><a href="#then" class="headerlink" title="then"></a>then</h5><p>ç”¨äºè¿æ¥ä¸¤ä¸ªä¿¡å·ï¼Œå½“ç¬¬ä¸€ä¸ªä¿¡å·å®Œæˆï¼Œæ‰ä¼šè¿æ¥ then è¿”å›çš„ä¿¡å·</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ³¨æ„ä½¿ç”¨thenï¼Œä¹‹å‰ä¿¡å·çš„å€¼ä¼šè¢«å¿½ç•¥æ‰.</span></span><br><span class="line"><span class="comment">// åº•å±‚å®ç°ï¼š1ã€å…ˆè¿‡æ»¤æ‰ä¹‹å‰çš„ä¿¡å·å‘å‡ºçš„å€¼ã€‚2.ä½¿ç”¨concatè¿æ¥thenè¿”å›çš„ä¿¡å·</span></span><br><span class="line">[[[RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">    [subscriber sendCompleted];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;] then:^RACSignal *&#123;</span><br><span class="line">    <span class="keyword">return</span> [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">        [subscriber sendNext:@<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="comment">// åªèƒ½æ¥æ”¶åˆ°ç¬¬äºŒä¸ªä¿¡å·çš„å€¼ï¼Œä¹Ÿå°±æ˜¯thenè¿”å›ä¿¡å·çš„å€¼ 2</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="merge"><a href="#merge" class="headerlink" title="merge"></a>merge</h5><p>æŠŠå¤šä¸ªä¿¡å·åˆå¹¶ä¸ºä¸€ä¸ªä¿¡å·ï¼Œä»»ä½•ä¸€ä¸ªä¿¡å·æœ‰æ–°å€¼çš„æ—¶å€™å°±ä¼šè°ƒç”¨</p>
<p> ä¸€ä¸ªé¡µé¢nä¸ªè¯·æ±‚ æ‹¿åˆ°å“ªä¸ªæ•°æ®å°±æ˜¾ç¤ºå“ªä¸ªæ•°æ® å¯ä»¥æ²¡æœ‰é¡ºåº</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åº•å±‚å®ç°ï¼š</span></span><br><span class="line"><span class="comment">// 1.åˆå¹¶ä¿¡å·è¢«è®¢é˜…çš„æ—¶å€™ï¼Œå°±ä¼šéå†æ‰€æœ‰ä¿¡å·ï¼Œå¹¶ä¸”å‘å‡ºè¿™äº›ä¿¡å·ã€‚</span></span><br><span class="line"><span class="comment">// 2.æ¯å‘å‡ºä¸€ä¸ªä¿¡å·ï¼Œè¿™ä¸ªä¿¡å·å°±ä¼šè¢«è®¢é˜…</span></span><br><span class="line"><span class="comment">// 3.ä¹Ÿå°±æ˜¯åˆå¹¶ä¿¡å·ä¸€è¢«è®¢é˜…ï¼Œå°±ä¼šè®¢é˜…é‡Œé¢æ‰€æœ‰çš„ä¿¡å·ã€‚</span></span><br><span class="line"><span class="comment">// 4.åªè¦æœ‰ä¸€ä¸ªä¿¡å·è¢«å‘å‡ºå°±ä¼šè¢«ç›‘å¬</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *signalA = [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line">RACSignal *signalB = [RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt;  subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:@<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">// åˆå¹¶ä¿¡å·,ä»»ä½•ä¸€ä¸ªä¿¡å·å‘é€æ•°æ®ï¼Œéƒ½èƒ½ç›‘å¬åˆ°</span></span><br><span class="line">RACSignal *mergeSignal = [signalA merge:signalB];</span><br><span class="line"></span><br><span class="line">[mergeSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="zipWith"><a href="#zipWith" class="headerlink" title="zipWith"></a>zipWith</h5><p>æŠŠä¸¤ä¸ªä¿¡å·å‹ç¼©æˆä¸€ä¸ªä¿¡å·ï¼Œåªæœ‰å½“ä¸¤ä¸ªä¿¡å·åŒæ—¶å‘å‡ºä¿¡å·å†…å®¹æ—¶ï¼Œå¹¶ä¸”æŠŠä¸¤ä¸ªä¿¡å·çš„å†…å®¹åˆå¹¶æˆä¸€ä¸ªå…ƒç»„ï¼Œæ‰ä¼šè§¦å‘å‹ç¼©æµçš„ next äº‹ä»¶</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åº•å±‚å®ç°:</span></span><br><span class="line"><span class="comment">// 1.å®šä¹‰å‹ç¼©ä¿¡å·ï¼Œå†…éƒ¨å°±ä¼šè‡ªåŠ¨è®¢é˜…signalAï¼ŒsignalB</span></span><br><span class="line"><span class="comment">// 2.æ¯å½“signalAæˆ–è€…signalBå‘å‡ºä¿¡å·ï¼Œå°±ä¼šåˆ¤æ–­signalAï¼ŒsignalBæœ‰æ²¡æœ‰å‘å‡ºä¸ªä¿¡å·ï¼Œæœ‰å°±ä¼šæŠŠæœ€è¿‘å‘å‡ºçš„ä¿¡å·éƒ½åŒ…è£…æˆå…ƒç»„å‘å‡º</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *signalA = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">   [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">RACSignal *signalB = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">   [subscriber sendNext:@<span class="number">2</span>];</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‹ç¼©ä¿¡å·Aï¼Œä¿¡å·B</span></span><br><span class="line">RACSignal *zipSignal = [signalA zipWith:signalB];</span><br><span class="line">[zipSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">&lt;RACTwoTuple:0xxx&gt;(1,2)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h5 id="combineLatest"><a href="#combineLatest" class="headerlink" title="combineLatest"></a>combineLatest</h5><p>å°†å¤šä¸ªä¿¡å·åˆå¹¶èµ·æ¥ï¼Œå¹¶ä¸”æ‹¿åˆ°å„ä¸ªä¿¡å·çš„æœ€æ–°å€¼ï¼Œå¿…é¡»æ¯ä¸ªåˆå¹¶çš„ signal è‡³å°‘éƒ½æœ‰è¿‡ä¸€æ¬¡ sendNextï¼Œæ‰ä¼šè§¦å‘åˆå¹¶çš„ä¿¡å·</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åº•å±‚å®ç°ï¼š</span></span><br><span class="line"><span class="comment">// 1.å½“ç»„åˆä¿¡å·è¢«è®¢é˜…ï¼Œå†…éƒ¨ä¼šè‡ªåŠ¨è®¢é˜…signalAï¼ŒsignalB,å¿…é¡»ä¸¤ä¸ªä¿¡å·éƒ½å‘å‡ºå†…å®¹ï¼Œæ‰ä¼šè¢«è§¦å‘ã€‚</span></span><br><span class="line"><span class="comment">// 2.å¹¶ä¸”æŠŠä¸¤ä¸ªä¿¡å·ç»„åˆæˆå…ƒç»„å‘å‡ºã€‚</span></span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *signalA = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">   [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">RACSignal *signalB = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">   [subscriber sendNext:@<span class="number">2</span>];</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŠŠä¸¤ä¸ªä¿¡å·ç»„åˆæˆä¸€ä¸ªä¿¡å·,è·Ÿzipä¸€æ ·ï¼Œæ²¡ä»€ä¹ˆåŒºåˆ«</span></span><br><span class="line">RACSignal *combineSignal = [signalA combineLatest:signalB];</span><br><span class="line">[combineSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">   <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">&lt;RACTwoTuple:0xxx&gt;(1,2)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h5 id="reduce"><a href="#reduce" class="headerlink" title="reduce"></a>reduce</h5><p>ç”¨äºä¿¡å·å‘å‡ºçš„å†…å®¹æ˜¯å…ƒç»„ï¼ŒæŠŠä¿¡å·å‘å‡ºå…ƒç»„çš„å€¼èšåˆæˆä¸€ä¸ªå€¼</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *signalA = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">   [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line">RACSignal *signalB = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">   [subscriber sendNext:@<span class="number">2</span>];</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// èšåˆ</span></span><br><span class="line"><span class="comment">// å¸¸è§çš„ç”¨æ³•ï¼Œï¼ˆå…ˆç»„åˆåœ¨èšåˆï¼‰ã€‚combineLatest:(id&lt;NSFastEnumeration&gt;)signals reduce:(id (^)())reduceBlock</span></span><br><span class="line"><span class="comment">// reduceä¸­çš„blockç®€ä»‹:</span></span><br><span class="line"><span class="comment">// reduceblcokä¸­çš„å‚æ•°ï¼Œæœ‰å¤šå°‘ä¿¡å·ç»„åˆï¼Œreduceblcokå°±æœ‰å¤šå°‘å‚æ•°ï¼Œæ¯ä¸ªå‚æ•°å°±æ˜¯ä¹‹å‰ä¿¡å·å‘å‡ºçš„å†…å®¹</span></span><br><span class="line"><span class="comment">// reduceblcokçš„è¿”å›å€¼ï¼šèšåˆä¿¡å·ä¹‹åçš„å†…å®¹</span></span><br><span class="line">RACSignal *reduceSignal = [RACSignal combineLatest:@[signalA, signalB] reduce:^<span class="keyword">id</span>(<span class="built_in">NSNumber</span> *num1 ,<span class="built_in">NSNumber</span> *num2)&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@&quot;%@ %@&quot;</span>,num1,num2];</span><br><span class="line">&#125;];</span><br><span class="line">[reduceSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="è¿‡æ»¤-filter"><a href="#è¿‡æ»¤-filter" class="headerlink" title="è¿‡æ»¤ filter"></a>è¿‡æ»¤ filter</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¯æ¬¡ä¿¡å·å‘å‡ºï¼Œä¼šå…ˆæ‰§è¡Œè¿‡æ»¤æ¡ä»¶åˆ¤æ–­.</span></span><br><span class="line">[_textField.rac_textSignal filter:^<span class="built_in">BOOL</span>(<span class="built_in">NSString</span> *value) &#123;</span><br><span class="line">    <span class="keyword">return</span> value.length &gt; <span class="number">3</span>;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="ignore"><a href="#ignore" class="headerlink" title="ignore"></a>ignore</h5><p>å¿½ç•¥å®ŒæŸäº›å€¼çš„ä¿¡å·</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å†…éƒ¨è°ƒç”¨filterè¿‡æ»¤ï¼Œå¿½ç•¥æ‰ignoreçš„å€¼</span></span><br><span class="line">[[_textField.rac_textSignal ignore:<span class="string">@&quot;1&quot;</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="startWith"><a href="#startWith" class="headerlink" title="startWith"></a>startWith</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åœ¨å¼€å§‹å‰æ·»åŠ æ•°æ® æ‰“å° hello world 1 2 3 4</span></span><br><span class="line">RACSignal *signal = @[@<span class="number">1</span>,@<span class="number">2</span>,@<span class="number">3</span>,@<span class="number">4</span>].rac_sequence.signal;</span><br><span class="line">RACSignal *signal2 = [signal startWith:<span class="string">@&quot;hello world&quot;</span>];</span><br><span class="line">[signal2 subscribeNext:^(<span class="keyword">id</span>  _Nullable x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="distinctUntilChanged"><a href="#distinctUntilChanged" class="headerlink" title="distinctUntilChanged"></a>distinctUntilChanged</h5><p>å½“ä¸Šä¸€æ¬¡çš„å€¼å’Œå½“å‰çš„å€¼æœ‰æ˜æ˜¾å˜åŒ–å°±ä¼šå‘å‡ºä¿¡å·ï¼Œå¦åˆ™è¢«å¿½ç•¥æ‰</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿‡æ»¤ï¼Œå½“ä¸Šä¸€æ¬¡å’Œå½“å‰çš„å€¼ä¸ä¸€æ ·ï¼Œå°±ä¼šå‘å‡ºå†…å®¹ã€‚</span></span><br><span class="line"><span class="comment">// åœ¨å¼€å‘ä¸­ï¼Œåˆ·æ–°UIç»å¸¸ä½¿ç”¨ï¼Œåªæœ‰ä¸¤æ¬¡æ•°æ®ä¸ä¸€æ ·æ‰éœ€è¦åˆ·æ–°</span></span><br><span class="line">[[_textField.rac_textSignal distinctUntilChanged] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="take"><a href="#take" class="headerlink" title="take"></a>take</h5><p>ä»å¼€å§‹ä¸€å…±å– N æ¬¡çš„ä¿¡å·</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1ã€åˆ›å»ºä¿¡å·</span></span><br><span class="line">RACSubject *signal = [RACSubject subject];</span><br><span class="line"><span class="comment">// 2ã€å¤„ç†ä¿¡å·ï¼Œè®¢é˜…ä¿¡å·</span></span><br><span class="line">[[signal take:<span class="number">1</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.å‘é€ä¿¡å·</span></span><br><span class="line">[signal sendNext:@<span class="number">1</span>];</span><br><span class="line">[signal sendNext:@<span class="number">2</span>];</span><br></pre></td></tr></table></figure>

<h5 id="takeLast"><a href="#takeLast" class="headerlink" title="takeLast"></a>takeLast</h5><p>å–æœ€å N æ¬¡çš„ä¿¡å·ï¼Œå‰ææ¡ä»¶ï¼Œè®¢é˜…è€…å¿…é¡»è°ƒç”¨å®Œæˆ</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1ã€åˆ›å»ºä¿¡å·</span></span><br><span class="line">RACSubject *signal = [RACSubject subject];</span><br><span class="line"><span class="comment">// 2ã€å¤„ç†ä¿¡å·ï¼Œè®¢é˜…ä¿¡å·</span></span><br><span class="line">[[signal takeLast:<span class="number">1</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.å‘é€ä¿¡å·</span></span><br><span class="line">[signal sendNext:@<span class="number">1</span>];</span><br><span class="line">[signal sendNext:@<span class="number">2</span>];</span><br><span class="line">[signal sendCompleted];</span><br></pre></td></tr></table></figure>

<h5 id="takeUntil"><a href="#takeUntil" class="headerlink" title="takeUntil"></a>takeUntil</h5><p>è·å–ä¿¡å·å€¼ç›´åˆ°æŸä¸ªä¿¡å·æ‰§è¡Œå®Œæˆ</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç›‘å¬æ–‡æœ¬æ¡†çš„æ”¹å˜ç›´åˆ°å½“å‰å¯¹è±¡è¢«é”€æ¯</span></span><br><span class="line">[_textField.rac_textSignal takeUntil:<span class="keyword">self</span>.rac_willDeallocSignal];</span><br></pre></td></tr></table></figure>

<h5 id="skip"><a href="#skip" class="headerlink" title="skip"></a>skip</h5><p>è·³è¿‡å‡ ä¸ªä¿¡å·</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¡¨ç¤ºè¾“å…¥ç¬¬ä¸€æ¬¡ï¼Œä¸ä¼šè¢«ç›‘å¬åˆ°ï¼Œè·³è¿‡ç¬¬ä¸€æ¬¡å‘å‡ºçš„ä¿¡å·</span></span><br><span class="line">[[_textField.rac_textSignal skip:<span class="number">1</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="switchToLatest"><a href="#switchToLatest" class="headerlink" title="switchToLatest"></a>switchToLatest</h5><p>ç”¨äº signalOfSignalsï¼ˆä¿¡å·çš„ä¿¡å·ï¼‰ï¼Œæœ‰æ—¶å€™ä¿¡å·ä¹Ÿä¼šå‘å‡ºä¿¡å·ï¼Œè·å– signalOfSignals å‘é€çš„æœ€æ–°ä¿¡å·</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">RACSubject *signalOfSignals = [RACSubject subject];</span><br><span class="line">RACSubject *signal = [RACSubject subject];</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–ä¿¡å·ä¸­ä¿¡å·æœ€è¿‘å‘å‡ºä¿¡å·ï¼Œè®¢é˜…æœ€è¿‘å‘å‡ºçš„ä¿¡å·ã€‚</span></span><br><span class="line"><span class="comment">// æ³¨æ„switchToLatestï¼šåªèƒ½ç”¨äºä¿¡å·ä¸­çš„ä¿¡å·</span></span><br><span class="line">[signalOfSignals.switchToLatest subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br><span class="line">[signalOfSignals sendNext:signal];</span><br><span class="line">[signal sendNext:@<span class="number">1</span>];</span><br></pre></td></tr></table></figure>

<h5 id="ifThenElse"><a href="#ifThenElse" class="headerlink" title="ifThenElse"></a>ifThenElse</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *signalA = @[@<span class="number">1</span>, @<span class="number">2</span>, @<span class="number">3</span>].rac_sequence.signal;</span><br><span class="line">RACSignal *signalB = @[<span class="string">@&quot;a&quot;</span>, <span class="string">@&quot;b&quot;</span>, <span class="string">@&quot;c&quot;</span>].rac_sequence.signal;</span><br><span class="line">RACSubject *subject = [RACSubject subject];</span><br><span class="line">[[RACSignal <span class="keyword">if</span>:subject then:signalA <span class="keyword">else</span>:signalB] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line">[subject sendNext:@<span class="number">1</span>];</span><br><span class="line">dispatch_after(dispatch_time(DISPATCH_TIME_NOW, <span class="number">2</span>), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">    [subject sendNext:@<span class="number">0</span>];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h5 id="doNextï¼ŒdoCompleted"><a href="#doNextï¼ŒdoCompleted" class="headerlink" title="doNextï¼ŒdoCompleted"></a>doNextï¼ŒdoCompleted</h5><p>doNext æ‰§è¡Œ Next ä¹‹å‰ï¼Œä¼šå…ˆæ‰§è¡Œè¿™ä¸ª block</p>
<p>doCompleted æ‰§è¡Œ sendCompleted ä¹‹å‰ï¼Œä¼šå…ˆæ‰§è¡Œè¿™ä¸ª block</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> [[[[RACSignal createSignal:^RACDisposable * (<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">    [subscriber sendCompleted];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;] doNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;doNext&quot;</span>);</span><br><span class="line">&#125;] doCompleted:^&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;doCompleted&quot;</span>);</span><br><span class="line">&#125;] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">doNext</span></span><br><span class="line"><span class="comment">1</span></span><br><span class="line"><span class="comment">doCompleted</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h5 id="çº¿ç¨‹"><a href="#çº¿ç¨‹" class="headerlink" title="çº¿ç¨‹"></a>çº¿ç¨‹</h5><p>deliverOnï¼šå†…å®¹ä¼ é€’åˆ‡æ¢åˆ°æŒ‡å®šçº¿ç¨‹ä¸­ï¼Œå‰¯ä½œç”¨åœ¨åŸæ¥çº¿ç¨‹ä¸­ï¼ŒæŠŠåœ¨åˆ›å»ºä¿¡å·æ—¶ block ä¸­çš„ä»£ç ç§°ä¹‹ä¸ºå‰¯ä½œç”¨</p>
<p>subscribeOnï¼šå†…å®¹ä¼ é€’å’Œå‰¯ä½œç”¨éƒ½ä¼šåˆ‡æ¢åˆ°æŒ‡å®šçº¿ç¨‹ä¸­</p>
<h5 id="timeout"><a href="#timeout" class="headerlink" title="timeout"></a>timeout</h5><p>è¶…æ—¶ï¼Œè®©ä¸€ä¸ªä¿¡å·åœ¨ä¸€å®šæ—¶é—´åè‡ªåŠ¨æŠ¥é”™</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *signal = [[RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;] timeout:<span class="number">1</span> onScheduler:[RACScheduler currentScheduler]];</span><br><span class="line"></span><br><span class="line">[signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125; error:^(<span class="built_in">NSError</span> *error) &#123;</span><br><span class="line">    <span class="comment">// 1ç§’åä¼šè‡ªåŠ¨è°ƒç”¨</span></span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,error);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="interval"><a href="#interval" class="headerlink" title="interval"></a>interval</h5><p>å®šæ—¶ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´å‘å‡ºä¿¡å·</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[[RACSignal interval:<span class="number">1</span> onScheduler:[RACScheduler currentScheduler]] subscribeNext:^(<span class="keyword">id</span> x) &#123;   </span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="delay"><a href="#delay" class="headerlink" title="delay"></a>delay</h5><p>å»¶è¿Ÿå‘é€ next</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RACSignal *signal = [[[RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;] delay:<span class="number">2</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="retry"><a href="#retry" class="headerlink" title="retry"></a>retry</h5><p>é‡è¯•ï¼Œåªè¦å¤±è´¥ï¼Œå°±ä¼šé‡æ–°æ‰§è¡Œåˆ›å»ºä¿¡å·ä¸­çš„ blockï¼Œç›´åˆ°æˆåŠŸ</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">__block <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">[[[RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">  <span class="keyword">if</span> (i == <span class="number">10</span>) &#123;</span><br><span class="line">      [subscriber sendNext:@<span class="number">1</span>];</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="built_in">NSLog</span>(<span class="string">@&quot;æ¥æ”¶åˆ°é”™è¯¯&quot;</span>);</span><br><span class="line">      [subscriber sendError:<span class="literal">nil</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  i++;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;] retry] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">  <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125; error:^(<span class="built_in">NSError</span> *error) &#123;</span><br><span class="line"></span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>

<h5 id="replay"><a href="#replay" class="headerlink" title="replay"></a>replay</h5><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zz-vv/p/4834042.html">replayã€replayLastã€replayLazily</a></p>
<p>å¯¹äºæ™®é€šçš„ä¿¡å·ï¼Œæ¯æ¬¡è®¢é˜…éƒ½ä¼šå¯¼è‡´ä¿¡å·ä¸­çš„ä»£ç è¢«æ‰§è¡Œä¸€éï¼ˆblockä¸­çš„ä»£ç ï¼‰</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">__block <span class="keyword">int</span> num = <span class="number">0</span>;</span><br><span class="line">RACSignal *signal = [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</span><br><span class="line">    num ++;</span><br><span class="line">    [subscriber sendNext:@(num)];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;];</span><br><span class="line">[signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;s1:%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line">[signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;s2:%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line">[signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;s3:%@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">s1:1</span></span><br><span class="line"><span class="comment">s2:2</span></span><br><span class="line"><span class="comment">s3:3</span></span><br><span class="line"><span class="comment">block ä¸­çš„ä»£ç è¢«æ‰§è¡Œäº†3æ¬¡</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>replay è¿”å›ä¸€ä¸ªæ–°çš„ä¿¡å·ï¼Œæºä¿¡å·è¢«è®¢é˜…æ—¶ï¼Œä¼šç«‹å³å‘é€è®¢é˜…è€…å…¨éƒ¨å†å²çš„å€¼ï¼Œä¸ä¼šé‡å¤æ‰§è¡Œæºä¿¡å·ä¸­çš„è®¢é˜…ä»£ç ï¼Œè®¢é˜…è€…è¿˜å°†æ¥æ”¶æœªæ¥å‘é€è¿‡å»çš„å€¼</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ¼”ç¤ºï¼šæ¯ä¸ªæ–°æ·»åŠ çš„è®¢é˜…è€…æ¥æ”¶åˆ°ä¿¡å·ä¸­å…¨éƒ¨çš„å€¼ï¼ˆä¸ç®¡ä¹‹å‰è¿˜æ˜¯å°†æ¥å‘å‡ºçš„å€¼ï¼‰</span></span><br><span class="line">RACSubject *letters = [RACSubject subject];</span><br><span class="line">RACSignal *signal = [letters replay]; </span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;Subscribe S1&quot;</span>);</span><br><span class="line">[signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;S1: %@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;Send A&quot;</span>);</span><br><span class="line">[letters sendNext:<span class="string">@&quot;A&quot;</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;Send B&quot;</span>);</span><br><span class="line">[letters sendNext:<span class="string">@&quot;B&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;Subscribe S2&quot;</span>);</span><br><span class="line">[signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;S2: %@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;Send C&quot;</span>);</span><br><span class="line">[letters sendNext:<span class="string">@&quot;C&quot;</span>];</span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;Send D&quot;</span>);</span><br><span class="line">[letters sendNext:<span class="string">@&quot;D&quot;</span>];</span><br><span class="line"></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@&quot;Subscribe S3&quot;</span>);</span><br><span class="line">[signal subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;S3: %@&quot;</span>, x);</span><br><span class="line">&#125;];</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Subscribe S1   </span></span><br><span class="line"><span class="comment">Send A   </span></span><br><span class="line"><span class="comment">S1: A</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">Send B</span></span><br><span class="line"><span class="comment">S1: B</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">Subscribe S2</span></span><br><span class="line"><span class="comment">S2: A</span></span><br><span class="line"><span class="comment">S2: B //å‘é€å†å²å€¼</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">Send C</span></span><br><span class="line"><span class="comment">S1: C</span></span><br><span class="line"><span class="comment">S2: C</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">Send D</span></span><br><span class="line"><span class="comment">S1: D</span></span><br><span class="line"><span class="comment">S2: D</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">Subscribe S3</span></span><br><span class="line"><span class="comment">S3: A</span></span><br><span class="line"><span class="comment">S3: B</span></span><br><span class="line"><span class="comment">S3: C</span></span><br><span class="line"><span class="comment">S3: D //å‘é€å†å²å€¼</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h5 id="replayLast"><a href="#replayLast" class="headerlink" title="replayLast"></a>replayLast</h5><p>è¿”å›ä¸€ä¸ªæ–°çš„ä¿¡å·ï¼Œæºä¿¡å·è¢«è®¢é˜…æ—¶ï¼Œä¼šç«‹å³å‘é€ç»™è®¢é˜…è€…æœ€æ–°çš„å€¼ï¼Œä¸ä¼šé‡å¤æ‰§è¡Œæºä¿¡å·ä¸­çš„è®¢é˜…ä»£ç ï¼Œè®¢é˜…è€…è¿˜å°†æ¥æ”¶æœªæ¥å‘é€è¿‡å»çš„å€¼</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Subscribe S1</span><br><span class="line">Send A</span><br><span class="line">S1: A</span><br><span class="line"> </span><br><span class="line">Send B</span><br><span class="line">S1: B</span><br><span class="line"> </span><br><span class="line">Subscribe S2</span><br><span class="line">S2: B <span class="comment">//æ¥æ”¶æœ€æ–°å€¼</span></span><br><span class="line"> </span><br><span class="line">Send C</span><br><span class="line">S1: C</span><br><span class="line">S2: C</span><br><span class="line"> </span><br><span class="line">Send D</span><br><span class="line">S1: D</span><br><span class="line">S2: D</span><br><span class="line"> </span><br><span class="line">Subscribe S3</span><br><span class="line">S3: D</span><br></pre></td></tr></table></figure>





<h5 id="throttle"><a href="#throttle" class="headerlink" title="throttle"></a>throttle</h5><p>å½“æŸä¸ªä¿¡å·å‘é€æ¯”è¾ƒé¢‘ç¹æ—¶ï¼Œå¯ä»¥ä½¿ç”¨èŠ‚æµï¼Œåœ¨æŸä¸€æ®µæ—¶é—´ä¸å‘é€ä¿¡å·å†…å®¹ï¼Œè¿‡äº†ä¸€æ®µæ—¶é—´è·å–ä¿¡å·çš„æœ€æ–°å†…å®¹å‘å‡º</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">RACSubject *signal = [RACSubject subject];</span><br><span class="line">_signal = signal;</span><br><span class="line"></span><br><span class="line"><span class="comment">// èŠ‚æµï¼Œåœ¨ä¸€å®šæ—¶é—´ï¼ˆ1ç§’ï¼‰å†…ï¼Œä¸æ¥æ”¶ä»»ä½•ä¿¡å·å†…å®¹ï¼Œè¿‡äº†è¿™ä¸ªæ—¶é—´ï¼ˆ1ç§’ï¼‰è·å–æœ€åå‘é€çš„ä¿¡å·å†…å®¹å‘å‡ºã€‚</span></span><br><span class="line">[[signal throttle:<span class="number">1</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@&quot;%@&quot;</span>,x);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>





<p> <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/ceebb496c226">RACèµ„æºå¸–</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/87ef6720a096">ReactiveCocoaåŸºç¡€ç¯‡</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/e10e5ca413b7">ReactiveCocoaè¿›é˜¶ç¯‡</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/06/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-6%E5%BC%82%E6%AD%A5%E7%88%AC%E8%99%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="ç®€å•è®°å½•ä¸‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/06/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-6%E5%BC%82%E6%AD%A5%E7%88%AC%E8%99%AB/" class="post-title-link" itemprop="url">Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-6å¼‚æ­¥çˆ¬è™«</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-05-06 22:57:27" itemprop="dateCreated datePublished" datetime="2022-05-06T22:57:27+08:00">2022-05-06</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-10-09 08:57:19" itemprop="dateModified" datetime="2022-10-09T08:57:19+08:00">2022-10-09</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li>event_loopï¼šäº‹ä»¶å¾ªç¯ï¼Œç›¸å½“äºä¸€ä¸ªæ— é™å¾ªç¯ï¼Œå¯ä»¥æŠŠä¸€äº›å‡½æ•°æ³¨å†Œåˆ°è¿™ä¸ªäº‹ä»¶å¾ªç¯ä¸Šï¼Œå½“æ»¡è¶³å‘ç”Ÿæ¡ä»¶çš„æ—¶å€™ï¼Œå°±è°ƒç”¨å¯¹åº”çš„å¤„ç†æ–¹æ³•</li>
<li>coroutineï¼šåç¨‹ï¼Œå¯ä»¥å°†åç¨‹å¯¹è±¡æ³¨å†Œåˆ°äº‹ä»¶å¾ªç¯ä¸­ï¼Œå®ƒä¼šè¢«äº‹ä»¶å¾ªç¯è°ƒç”¨ã€‚å¯ä»¥ä½¿ç”¨ async å…³é”®å­—æ¥å®šä¹‰ä¸€ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨è°ƒç”¨æ—¶ä¸ä¼šç«‹å³è¢«æ‰§è¡Œï¼Œè€Œæ˜¯ä¼šè¿”å›ä¸€ä¸ªåç¨‹å¯¹è±¡</li>
<li>taskï¼šä»»åŠ¡ï¼Œè¿™æ˜¯å¯¹åç¨‹å¯¹è±¡çš„è¿›ä¸€æ­¥å°è£…ï¼ŒåŒ…å«åç¨‹å¯¹è±¡çš„å„ä¸ªçŠ¶æ€</li>
<li>futureï¼šä»£è¡¨å°†æ¥æ‰§è¡Œæˆ–è€…æ²¡æœ‰æ‰§è¡Œçš„ä»»åŠ¡çš„ç»“æœï¼Œå®é™…ä¸Šå’Œ task æ²¡æœ‰æœ¬è´¨çš„åŒºåˆ«</li>
</ul>
<h4 id="å®šä¹‰åç¨‹"><a href="#å®šä¹‰åç¨‹" class="headerlink" title="å®šä¹‰åç¨‹"></a>å®šä¹‰åç¨‹</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">execute</span>(<span class="params">x</span>):</span></span><br><span class="line">    print(<span class="string">&#x27;Number&#x27;</span>, x)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    print(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    coroutine = execute(<span class="number">1</span>) <span class="comment">#æ–¹æ³•æ²¡æœ‰ç«‹å³æ‰§è¡Œï¼Œè¿”å›åç¨‹å¯¹è±¡</span></span><br><span class="line">    print(<span class="string">&#x27;After calling execute&#x27;</span>)</span><br><span class="line">    loop = asyncio.get_event_loop() <span class="comment">#åˆ›å»ºäº‹ä»¶å¾ªç¯</span></span><br><span class="line">    loop.run_until_complete(coroutine)<span class="comment">#å°†åç¨‹å¯¹è±¡æ³¨å†Œåˆ°äº‹ä»¶å¾ªç¯</span></span><br><span class="line">    print(<span class="string">&#x27;After calling loop&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">After calling execute</span></span><br><span class="line"><span class="string">Number 1</span></span><br><span class="line"><span class="string">After calling loop</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>å¼•å…¥ asyncio åŒ…ï¼Œè¿™æ ·æ‰èƒ½ä½¿ç”¨ async å’Œ await å…³é”®å­—</p>
<p>ç›´æ¥è°ƒç”¨ execute æ–¹æ³•å¹¶æ²¡æœ‰ç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªåç¨‹å¯¹è±¡</p>
<p>ä¹‹åè°ƒç”¨ get_event_loop æ–¹æ³•åˆ›å»ºä¸€ä¸ªäº‹ä»¶å¾ªç¯ loopï¼Œè°ƒç”¨ loop å¯¹è±¡çš„ run_until_complete æ–¹æ³•å°†åç¨‹å¯¹è±¡æ³¨å†Œåˆ°äº‹ä»¶å¾ªç¯ä¸­ï¼Œæ¥ç€å¯åŠ¨</p>
<p>async å®šä¹‰çš„æ–¹æ³•ä¼šå˜æˆä¸€ä¸ªæ— æ³•ç›´æ¥æ‰§è¡Œçš„åç¨‹å¯¹è±¡ï¼Œå¿…é¡»å°†æ­¤å¯¹è±¡æ³¨å†Œåˆ°äº‹ä»¶å¾ªç¯ä¸­æ‰å¯ä»¥æ‰§è¡Œ</p>
<p>å‰é¢æåˆ° task æ˜¯å¯¹åç¨‹çš„è¿›ä¸€æ­¥å°è£…ï¼Œæ¯”åç¨‹å¤šäº†è¿è¡ŒçŠ¶æ€ï¼Œå¦‚ runningã€finishedï¼Œå¯ä»¥åˆ©ç”¨è¿™äº›çŠ¶æ€è·å–åç¨‹æ‰§è¡Œæƒ…å†µ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">coroutine = execute(<span class="number">1</span>)</span><br><span class="line">print(<span class="string">&#x27;After calling execute&#x27;</span>)</span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">task = loop.create_task(coroutine) <span class="comment">#å°†åç¨‹å¯¹è±¡è½¬åŒ–ä¸ºtaskå¯¹è±¡ï¼</span></span><br><span class="line">print(<span class="string">&#x27;Task:&#x27;</span>, task)</span><br><span class="line">loop.run_until_complete(task)</span><br><span class="line">print(<span class="string">&#x27;Task:&#x27;</span>, task)</span><br><span class="line">print(<span class="string">&#x27;After calling loop&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">After calling execute</span></span><br><span class="line"><span class="string">Task: &lt;Task pending name=&#x27;Task-1&#x27; coro=&lt;execute() running at xxx&gt;&gt;</span></span><br><span class="line"><span class="string">Number 1</span></span><br><span class="line"><span class="string">Task: &lt;Task finished name=&#x27;Task-1&#x27; coro=&lt;execute() done, defined at xxx&gt;</span></span><br><span class="line"><span class="string">After calling loop</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>å®šä¹‰ task çš„å¦ä¸€ç§æ–¹å¼ï¼Œç›´æ¥è°ƒç”¨ asyncio åŒ…çš„ ensure_future æ–¹æ³•ï¼Œè¿”å›ä¹Ÿæ˜¯ task å¯¹è±¡</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">task = asyncio.ensure_future(coroutine)</span><br><span class="line">loop.run_until_complete(task)</span><br></pre></td></tr></table></figure>

<h4 id="ç»‘å®šå›è°ƒ"><a href="#ç»‘å®šå›è°ƒ" class="headerlink" title="ç»‘å®šå›è°ƒ"></a>ç»‘å®šå›è°ƒ</h4><p>ä¸ºæŸä¸ª task å¯¹è±¡ç»‘å®šä¸€ä¸ªå›è°ƒæ–¹æ³•    </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">request</span>():</span></span><br><span class="line">    url = <span class="string">&#x27;https://www.baidu.com&#x27;</span></span><br><span class="line">    status = requests.get(url)</span><br><span class="line">    <span class="keyword">return</span> status</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">callback</span>(<span class="params">task</span>):</span></span><br><span class="line">    print(<span class="string">&#x27;Status:&#x27;</span>, task.result())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    print(<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    coroutine = request()</span><br><span class="line">    task = asyncio.ensure_future(coroutine)<span class="comment">#å®šä¹‰task</span></span><br><span class="line">    task.add_done_callback(callback) <span class="comment">#å›è°ƒæ–¹æ³•</span></span><br><span class="line">    print(<span class="string">&#x27;Task:&#x27;</span>, task)</span><br><span class="line"></span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    loop.run_until_complete(task)<span class="comment">#æ³¨å†Œåˆ°äº‹ä»¶å¾ªç¯æ‰èƒ½æ‰§è¡Œ</span></span><br><span class="line">    print(<span class="string">&#x27;Task:&#x27;</span>, task)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">Task: &lt;Task pending name=&#x27;Task-1&#x27; coro=&lt;request() running at xxx cb=[callback() xx&gt;</span></span><br><span class="line"><span class="string">Status: &lt;Response [200]&gt;</span></span><br><span class="line"><span class="string">Task: &lt;Task finished name=&#x27;Task-1&#x27; coro=&lt;request() done, defined at xx result=&lt;Response [200]&gt;&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>task æ‰§è¡Œå®Œæ¯•åï¼Œå°±å¯ä»¥è°ƒç”¨ callback æ–¹æ³•äº†ï¼ŒåŒæ—¶ task å¯¹è±¡è¿˜ä¼šä½œä¸ºå‚æ•°ä¼ é€’ç»™ callback æ–¹æ³•ï¼Œè°ƒç”¨ task å¯¹è±¡çš„ result æ–¹æ³•å°±å¯ä»¥è·å–è¿”å›ç»“æœ</p>
<p>è¿™é‡Œä¸ä½¿ç”¨å›è°ƒæ–¹æ³•ï¼Œåœ¨ task è¿è¡Œå®Œæ¯•åï¼Œä¹Ÿå¯ç›´æ¥è°ƒç”¨ task.result() æ–¹æ³•è·å–ç»“æœ</p>
<h4 id="å¤šä»»åŠ¡åç¨‹"><a href="#å¤šä»»åŠ¡åç¨‹" class="headerlink" title="å¤šä»»åŠ¡åç¨‹"></a>å¤šä»»åŠ¡åç¨‹</h4><p>å¦‚æœæƒ³æ‰§è¡Œå¤šæ¬¡è¯·æ±‚ï¼Œä½¿ç”¨ asyncio åŒ…ä¸­çš„ wait æ–¹æ³•æ‰§è¡Œ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tasks = [asyncio.ensure_future(request()) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)]</span><br><span class="line">loop = asyncio.get_event_loop()</span><br><span class="line">loop.run_until_complete(asyncio.wait(tasks))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> task <span class="keyword">in</span> tasks:</span><br><span class="line">    print(<span class="string">&#x27;Task Result:&#x27;</span>, task.result())</span><br><span class="line"><span class="comment">#5ä¸ªä»»åŠ¡è¢«é¡ºæ¬¡æ‰§è¡Œ</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œ for å¾ªç¯åˆ›å»º 5 ä¸ª taskï¼Œç»„æˆä¸€ä¸ªåˆ—è¡¨ï¼Œåˆ—è¡¨å…ˆä¼ ç»™ asyncio åŒ…çš„ wait æ–¹æ³•ï¼Œå†å°†å…¶æ³¨å†Œåˆ°äº‹ä»¶å¾ªç¯ï¼Œå°±å¯ä»¥å‘èµ· 5 å“¥ä»»åŠ¡äº†</p>
<h4 id="åç¨‹å®ç°"><a href="#åç¨‹å®ç°" class="headerlink" title="åç¨‹å®ç°"></a>åç¨‹å®ç°</h4><p>å½“é‡åˆ°éœ€è¦ç­‰å¾…çš„æƒ…å†µæ—¶ï¼Œç¨‹åºå¯ä»¥æš‚æ—¶æŒ‚èµ·ï¼Œè½¬è€Œæ‰§è¡Œå…¶ä»–æ“ä½œï¼Œä»è€Œé¿å…å› ä¸€ç›´ç­‰å¾…ä¸€ä¸ªç¨‹åºè€Œè€—è´¹è¿‡å¤šçš„æ—¶é—´ï¼Œèƒ½å¤Ÿå……åˆ†åˆ©ç”¨èµ„æº</p>
<p>è¦å®ç°å¼‚æ­¥å¤„ç†ï¼Œå…ˆå¾—æœ‰æŒ‚èµ·æ“ä½œï¼Œå½“ä¸€ä¸ªä»»åŠ¡éœ€è¦ç­‰å¾… IO ç»“æœçš„æ—¶å€™ï¼Œå¯ä»¥æŒ‚èµ·å½“å‰ä»»åŠ¡ï¼Œè½¬è€Œæ‰§è¡Œå…¶å®ƒä»»åŠ¡</p>
<ul>
<li>await å…³é”®å­—</li>
</ul>
<p>å¯ä»¥å°†è€—æ—¶ç­‰å¾…çš„æ“ä½œæŒ‚èµ·ï¼Œè®©å‡ºæ§åˆ¶æƒã€‚å¦‚æœåç¨‹åœ¨æ‰§è¡Œçš„æ—¶å€™é‡åˆ° awaitï¼Œäº‹ä»¶å¾ªç¯å°±ä¼šå°†åç¨‹æŒ‚èµ·ï¼Œè½¬è€Œæ‰§è¡Œåˆ«çš„åç¨‹ï¼Œç›´åˆ°å…¶å®ƒåç¨‹æŒ‚èµ·æˆ–æ‰§è¡Œå®Œæ¯•</p>
<ul>
<li>await åé¢çš„å¯¹è±¡å¿…é¡»æ˜¯å¦‚ä¸‹æ ¼å¼ä¹‹ä¸€ï¼š</li>
</ul>
<p>ä¸€ä¸ªåŸç”Ÿçš„åç¨‹å¯¹è±¡ï¼›</p>
<p>ä¸€ä¸ªç”± types.coroutineä¿®é¥°çš„ç”Ÿæˆå™¨ï¼Œè¿™ä¸ªç”Ÿæˆå™¨å¯ä»¥è¿”å›åç¨‹å¯¹è±¡ï¼›</p>
<p>ä¸€ä¸ªåŒ…å« <code>__await__</code> æ–¹æ³•çš„å¯¹è±¡è¿”å›ä¸€ä¸ªè¿­ä»£å™¨</p>
<h4 id="ä½¿ç”¨-aiohttp"><a href="#ä½¿ç”¨-aiohttp" class="headerlink" title="ä½¿ç”¨ aiohttp"></a>ä½¿ç”¨ aiohttp</h4><p>aiohttp æ˜¯ä¸€ä¸ªæ”¯æŒå¼‚æ­¥è¯·æ±‚çš„åº“ï¼Œå’Œ asyncio é…åˆä½¿ç”¨ï¼Œå¯ä»¥éå¸¸æ–¹ä¾¿çš„å®ç°å¼‚æ­¥è¯·æ±‚æ“ä½œ</p>
<p>å®˜æ–¹æ–‡æ¡£é“¾æ¥ <a target="_blank" rel="noopener" href="https://aiohttp.readthedocs.io/">https://aiohttp.readthedocs.io/</a> </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">url</span>):</span></span><br><span class="line">    session = aiohttp.ClientSession()</span><br><span class="line">    response = <span class="keyword">await</span> session.get(url)</span><br><span class="line">    <span class="keyword">await</span> response.text()</span><br><span class="line">    <span class="keyword">await</span> session.close()</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">request</span>():</span></span><br><span class="line">    url = <span class="string">&#x27;https://www.baidu.com&#x27;</span></span><br><span class="line">    print(<span class="string">&#x27;waiting for&#x27;</span>, url)</span><br><span class="line">    response = <span class="keyword">await</span> get(url)</span><br><span class="line">    print(<span class="string">&#x27;get response from&#x27;</span>, url, <span class="string">&#x27;response:&#x27;</span>, response)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  tasks = [asyncio.ensure_future(request()) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)]</span><br><span class="line">  loop = asyncio.get_event_loop()</span><br><span class="line">  loop.run_until_complete(asyncio.wait(tasks))</span><br></pre></td></tr></table></figure>

<p>å½“é‡åˆ°é˜»å¡å¼æ“ä½œï¼ˆawaitï¼‰æ—¶ï¼Œtask è¢«æŒ‚èµ·ï¼Œäº‹ä»¶å¾ªç¯ä¼šå¯»æ‰¾å½“å‰æœªè¢«æŒ‚èµ·çš„åç¨‹ç»§ç»­æ‰§è¡Œï¼Œåˆ°ç¬¬10ä¸ªtaskï¼Œå…¨éƒ¨ task éƒ½è¢«æŒ‚èµ·äº†ï¼Œåªå¥½ç­‰å¾…ï¼Œè¯·æ±‚5ç§’åå‡ ä¸ªè¯·æ±‚å‡ ä¹åŒæ—¶æœ‰äº†å“åº”ï¼Œç„¶åå‡ ä¸ª task ä¹Ÿè¢«å”¤é†’æ¥ç€æ‰§è¡Œï¼Œå¹¶è¾“å‡ºç»“æœ</p>
<h4 id="aiohttp-çš„ä½¿ç”¨"><a href="#aiohttp-çš„ä½¿ç”¨" class="headerlink" title="aiohttp çš„ä½¿ç”¨"></a>aiohttp çš„ä½¿ç”¨</h4><p>aiohttp å®˜æ–¹æ–‡æ¡£ <a target="_blank" rel="noopener" href="https://docs.aiohtto.org/">https://docs.aiohtto.org</a></p>
<p>aiohttp æ˜¯ä¸€ä¸ªåŸºäº asyncio çš„å¼‚æ­¥ HTTP ç½‘ç»œæ¨¡å—ï¼Œæ—¢æä¾›äº†æœåŠ¡ç«¯ï¼Œåˆæä¾›äº†å®¢æˆ·ç«¯ã€‚ç”¨æœåŠ¡ç«¯å¯ä»¥æ­å»ºä¸€ä¸ªæ”¯æŒå¼‚æ­¥å¤„ç†çš„æœåŠ¡å™¨ï¼Œè¿™ä¸ªæœåŠ¡å™¨å°±æ˜¯ç”¨æ¥å¤„ç†è¯·æ±‚å¹¶è¿”å›å“åº”çš„ï¼Œç±»ä¼¼ Djangoã€Flaskã€Tornado ç­‰ä¸€äº› Web æœåŠ¡å™¨ã€‚è€Œå®¢æˆ·ç«¯å¯ä»¥ç”¨æ¥å‘èµ·è¯·æ±‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"></span><br><span class="line"><span class="comment">#æ¯ä¸ªå¼‚æ­¥æ–¹æ³•å‰éƒ½éœ€è¦åŠ  async æ¥ä¿®é¥°</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">fetch</span>(<span class="params">session, url</span>):</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> response:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">await</span> response.text(), response.status</span><br><span class="line"><span class="comment">#response.text()è¿”å›åç¨‹éœ€è¦åŠ await</span></span><br><span class="line">      </span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        html, status = <span class="keyword">await</span> fetch(session, <span class="string">&#x27;https://cuiqingcai.com&#x27;</span>)</span><br><span class="line">        print(<span class="string">f&#x27;html:<span class="subst">&#123;html[:<span class="number">100</span>]&#125;</span>...&#x27;</span>)</span><br><span class="line">        print(<span class="string">f&#x27;status: <span class="subst">&#123;status&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    loop.run_until_complete(main())</span><br></pre></td></tr></table></figure>

<p>with as å‰åŒæ ·éœ€è¦ async æ¥ä¿®é¥°ï¼Œpython ä¸­ï¼Œwith as è¯­å¥ç”¨äºå£°æ˜ä¸€ä¸ªä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œèƒ½å¤Ÿå¸®æˆ‘ä»¬è‡ªåŠ¨åˆ†é…å’Œé‡Šæ”¾èµ„æºï¼Œ<u>å¼‚æ­¥æ–¹æ³•ä¸­ï¼Œwith as å‰åŠ  async ä»£è¡¨å£°æ˜ä¸€ä¸ªæ”¯æŒå¼‚æ­¥çš„ä¸Šä¸‹æ–‡ç®¡ç†å™¨</u></p>
<p>å¯¹äºä¸€äº›è¿”å›åç¨‹çš„æ“ä½œï¼Œå‰é¢éœ€è¦åŠ  await æ¥ä¿®é¥°ã€‚è¿”å›çš„æ˜¯åç¨‹å¯¹è±¡ï¼Œå‰é¢å°±è¦åŠ  awaitï¼Œresponse è°ƒç”¨ text æ–¹æ³•è¿”å›çš„æ˜¯åç¨‹å¯¹è±¡ï¼Œå‰é¢éœ€è¦åŠ  awiatï¼Œè€ŒçŠ¶æ€ç è¿”å›çš„å°±æ˜¯ä¸€ä¸ªæ•°å€¼ï¼Œä¸éœ€è¦åŠ  awaitï¼Œçœ‹å¯¹åº”è¿”å›ç±»å‹å†³å®šåŠ ä¸åŠ  await</p>
<p>Python 3.7 åå¯ä»¥ä½¿ç”¨ <code>asyncio.run(main())</code> ä»£æ›¿æœ€åçš„å¯åŠ¨æ“ä½œï¼Œä¸éœ€è¦æ˜¾å¼å£°æ˜äº‹ä»¶å¾ªç¯</p>
<h5 id="URL-å‚æ•°è®¾ç½®"><a href="#URL-å‚æ•°è®¾ç½®" class="headerlink" title="URL å‚æ•°è®¾ç½®"></a>URL å‚æ•°è®¾ç½®</h5><p>å‚æ•°è®¾ç½®å€ŸåŠ© params å‚æ•°ï¼Œä¼ å…¥å­—å…¸</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    params = &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;germey&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">25</span>&#125;</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> session.get(<span class="string">&#x27;https://www.httpbin.org/get&#x27;</span>, params=params) <span class="keyword">as</span> response:</span><br><span class="line">            print(<span class="keyword">await</span> response.text())</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    asyncio.get_event_loop().run_until_complete(main())</span><br></pre></td></tr></table></figure>

<h5 id="å…¶å®ƒè¯·æ±‚ç±»å‹"><a href="#å…¶å®ƒè¯·æ±‚ç±»å‹" class="headerlink" title="å…¶å®ƒè¯·æ±‚ç±»å‹"></a>å…¶å®ƒè¯·æ±‚ç±»å‹</h5><p>aiohttp è¿˜æ”¯æŒå…¶å®ƒè¯·æ±‚ç±»å‹ï¼ŒPOSTã€PUTã€DELETE ç­‰</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">session.post(<span class="string">&#x27;http://xxx&#x27;</span>, data=<span class="string">b&#x27;data&#x27;</span>)</span><br><span class="line">session.put(<span class="string">&#x27;http://xxx&#x27;</span>)</span><br><span class="line">session.delete(<span class="string">&#x27;http://xxx&#x27;</span>)</span><br><span class="line">session.options(<span class="string">&#x27;http://xxx&#x27;</span>)</span><br><span class="line">session.head(<span class="string">&#x27;http://xxx&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="POST-è¯·æ±‚"><a href="#POST-è¯·æ±‚" class="headerlink" title="POST è¯·æ±‚"></a>POST è¯·æ±‚</h5><p>å¯¹äº POST è¡¨å•æäº¤ Content-Type ä¸º application/x-www-form-urlencoded</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">data = &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;germey&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">25</span>&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">with</span> session.post(<span class="string">&#x27;https://www.httpbin.org/post&#x27;</span>, data=data) <span class="keyword">as</span> response:</span><br></pre></td></tr></table></figure>

<p>å¯¹äº POST JSONï¼ŒContent-Type ä¸º application/json</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">data = &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;germey&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">25</span>&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">with</span> session.post(<span class="string">&#x27;https://www.httpbin.org/post&#x27;</span>, json=data) <span class="keyword">as</span> response:</span><br></pre></td></tr></table></figure>

<h5 id="å“åº”"><a href="#å“åº”" class="headerlink" title="å“åº”"></a>å“åº”</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">print(<span class="string">&#x27;status:&#x27;</span>, response.status)</span><br><span class="line">print(<span class="string">&#x27;headers:&#x27;</span>, response.headers)</span><br><span class="line">print(<span class="string">&#x27;body:&#x27;</span>, <span class="keyword">await</span> response.text())</span><br><span class="line">print(<span class="string">&#x27;bytes:&#x27;</span>, <span class="keyword">await</span> response.read())</span><br><span class="line">print(<span class="string">&#x27;json:&#x27;</span>, <span class="keyword">await</span> response.json())</span><br></pre></td></tr></table></figure>

<p>è¿”å›çš„æ˜¯ä¸€ä¸ªåç¨‹å¯¹è±¡éœ€è¦åŠ  awaitã€‚å…·ä½“æŸ¥çœ‹ aiohttp çš„ API</p>
<p>é“¾æ¥ <a target="_blank" rel="noopener" href="https://docs.aiohttp.org/en/stable/client_reference.html">https://docs.aiohttp.org/en/stable/client_reference.html</a></p>
<h5 id="è¶…æ—¶è®¾ç½®"><a href="#è¶…æ—¶è®¾ç½®" class="headerlink" title="è¶…æ—¶è®¾ç½®"></a>è¶…æ—¶è®¾ç½®</h5><p>å€ŸåŠ© ClientTimeout å¯¹è±¡è®¾ç½®è¶…æ—¶ï¼Œä¾‹å¦‚è®¾ç½® 1 ç§’çš„è¶…æ—¶æ—¶é—´ï¼Œè¶…æ—¶ä¼šæŠ›å‡º TimeoutError å¼‚å¸¸ï¼Œç±»å‹ä¸º asyncio.TimeoutError</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    data = &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;germey&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">25</span>&#125;</span><br><span class="line">    timeout = aiohttp.ClientTimeout(total=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession(timeout=timeout) <span class="keyword">as</span> session:</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>ClientTimeout è¿˜æœ‰å…¶ä»–å‚æ•°ï¼Œconnectã€socket_connect ç­‰</p>
<p><a target="_blank" rel="noopener" href="https://docs.aiohttp.org/en/stable/client_quickstart.html#timeouts">https://docs.aiohttp.org/en/stable/client_quickstart.html#timeouts</a></p>
<h5 id="å¹¶å‘é™åˆ¶"><a href="#å¹¶å‘é™åˆ¶" class="headerlink" title="å¹¶å‘é™åˆ¶"></a>å¹¶å‘é™åˆ¶</h5><p>asyncio çš„ Semaphore æ¥æ§åˆ¶å¹¶å‘é‡</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">CONCURRENCY = <span class="number">5</span></span><br><span class="line">URL = <span class="string">&#x27;https://www.baidu.com&#x27;</span></span><br><span class="line"></span><br><span class="line">semaphore = asyncio.Semaphore(CONCURRENCY) <span class="comment">#åˆ›å»ºä¿¡å·é‡å¯¹è±¡</span></span><br><span class="line">session = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">scripe_api</span>():</span></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> semaphore:<span class="comment">#1</span></span><br><span class="line">        print(<span class="string">&#x27;scrapping:&#x27;</span>, URL)</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> session.get(URL) <span class="keyword">as</span> response:</span><br><span class="line">            <span class="keyword">await</span> asyncio.sleep(<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">await</span> response.text()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    <span class="keyword">global</span> session;</span><br><span class="line">    session = aiohttp.ClientSession()</span><br><span class="line">    scripe_index_tasks = [asyncio.ensure_future(scripe_api()) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>)]</span><br><span class="line">    <span class="keyword">await</span> asyncio.gather(*scripe_index_tasks)<span class="comment">#2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    asyncio.get_event_loop().run_until_complete(main())</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºä¿¡å·é‡å¯¹è±¡ï¼Œä½¿ç”¨ï¼šæŠŠ semaphore ç›´æ¥æ”¾ç½®åœ¨å¯¹åº”çš„çˆ¬å–æ–¹æ³•é‡Œï¼Œä½¿ç”¨ async with è¯­å¥å°† semaphore ä½œä¸ºä¸Šä¸‹æ–‡å¯¹è±¡å³å¯ã€‚è¿™æ ·ä¿¡å·é‡ä¾¿å¯ä»¥æ§åˆ¶è¿›å…¥çˆ¬å–çš„æœ€å¤§åç¨‹æ•°é‡</p>
<p>main æ–¹æ³•é‡Œå£°æ˜äº† 1000 ä¸ª taskï¼Œä¼ é€’ç»™ gather æ–¹æ³•è¿è¡Œ</p>
<h4 id="aiohttp-å¼‚æ­¥çˆ¬å–å®æˆ˜"><a href="#aiohttp-å¼‚æ­¥çˆ¬å–å®æˆ˜" class="headerlink" title="aiohttp å¼‚æ­¥çˆ¬å–å®æˆ˜"></a>aiohttp å¼‚æ­¥çˆ¬å–å®æˆ˜</h4>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/28/Airtest/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="ç®€å•è®°å½•ä¸‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/28/Airtest/" class="post-title-link" itemprop="url">Airtest</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-04-28 16:05:12" itemprop="dateCreated datePublished" datetime="2022-04-28T16:05:12+08:00">2022-04-28</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-04-29 11:05:58" itemprop="dateModified" datetime="2022-04-29T11:05:58+08:00">2022-04-29</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://airtest.netease.com/changelog.html">AirtestIDE ä¸‹è½½</a> </p>
<p><a target="_blank" rel="noopener" href="https://airtest.doc.io.netease.com/tutorial/1_quick_start_guide/">å®˜ç½‘Airetest Project Docs</a></p>
<p>AiretestIDE ä¸€ä¸ªè·¨å¹³å°çš„UIè‡ªåŠ¨åŒ–æµ‹è¯•ç¼–è¾‘å™¨ï¼Œé€‚ç”¨æ¸¸æˆå’ŒAPP</p>
<p>è‡ªåŠ¨åŒ–å½•åˆ¶è„šæœ¬ã€ä¸€é”®å›æ”¾ã€æŠ¥å‘ŠæŸ¥çœ‹ï¼›æ”¯æŒåŸºäºå›¾åƒè¯†åˆ«çš„ Airtest æ¡†æ¶ï¼›æ”¯æŒåŸºäºUIæ§ä»¶æœç´¢çš„Pocoæ¡†æ¶</p>
<h4 id="è¿æ¥è®¾å¤‡"><a href="#è¿æ¥è®¾å¤‡" class="headerlink" title="è¿æ¥è®¾å¤‡"></a>è¿æ¥è®¾å¤‡</h4><ul>
<li>è¿æ¥ iOS æ‰‹æœº</li>
</ul>
<p>æ‰‹æœºé€šç”¨-å¼€å‘è€…-Enable UI Automation éœ€è¦å¼€å¯</p>
<p>éœ€è¦å®‰è£… Xcode çš„ Mac ç”µè„‘</p>
<p><a target="_blank" rel="noopener" href="https://github.com/AirtestProject/IOS-Tagent">iOS-Tagent</a> åŸºäº facebook çš„ WebDriverAgent é¡¹ç›®ä¸Šè¿›è¡Œå¼€å‘çš„</p>
<p>å¯ä»¥ä½¿ç”¨ Appium çš„ WebDriverAgent å·¥å…·æ¥éƒ¨ç½²iOSçœŸæœºï¼Œä¹Ÿå¯ä½¿ç”¨ Airtest ä¸‹çš„ iOS-Tagent å·¥å…·æ¥éƒ¨ç½²çœŸæœº</p>
<p>Appium çš„ WebDriverAgent å·¥å…·å®‰è£… <a target="_blank" rel="noopener" href="https://testerhome.com/topics/7220">https://testerhome.com/topics/7220</a></p>
<p>Facebook çš„ WebDriverAgent å·¥å…·å®‰è£… <a target="_blank" rel="noopener" href="https://testerhome.com/topics/10463">https://testerhome.com/topics/10463</a></p>
<p>ä¸‹è½½  iOS-Tagent é¡¹ç›®</p>
<p>Scheme-&gt;WebDriverAgentRunner-&gt;é€‰æ‹©è®¾å¤‡</p>
<p>product -&gt; Test æŠ¥é”™ </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Building for iOS, but the embedded framework &#39;CocoaAsyncSocket.framework&#39; was built for iOS + iOS Simulator.</span><br><span class="line">Building for iOS, but the linked and embedded framework &#39;WebDriverAgentLib.framework&#39; was built for iOS + iOS Simulator.</span><br></pre></td></tr></table></figure>

<p>è§£å†³ï¼šé€‰æ‹© WebDriverAgentRunner Target -&gt; Build Setting -&gt; Build Options -&gt; Validate Workspace è®¾ç½®ä¸º YES</p>
<p>éœ€è¦ libimobiledevice</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">brew install libimobiledevice</span><br><span class="line">#ç«¯å£è½¬å‘ ç¬¬ä¸€ä¸ªæ˜¯macç«¯å£ ç¬¬äºŒä¸ªæ˜¯iPhoneç«¯å£</span><br><span class="line">#ä¼šå°†iPhoneä¸Š8100çš„æ•°æ®è½¬å‘åˆ°macçš„8100ç«¯å£ä¸Š</span><br><span class="line">iproxy 8100 8100</span><br></pre></td></tr></table></figure>

<p>è®¿é—®åœ°å€ <a target="_blank" rel="noopener" href="http://127.0.0.1:8100/status">http://127.0.0.1:8100/status</a> å¯ä»¥çœ‹åˆ°è¿”å›çš„è®¾å¤‡ä¿¡æ¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;value&quot; : &#123;</span><br><span class="line">    &quot;state&quot; : &quot;success&quot;,</span><br><span class="line">    &quot;os&quot; : &#123;</span><br><span class="line">      &quot;name&quot; : &quot;iOS&quot;,</span><br><span class="line">      &quot;version&quot; : &quot;13.1.3&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;ios&quot; : &#123;</span><br><span class="line">      &quot;simulatorVersion&quot; : &quot;13.1.3&quot;,</span><br><span class="line">      &quot;ip&quot; : &quot;10.1.253.216&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;build&quot; : &#123;</span><br><span class="line">      &quot;time&quot; : &quot;Dec 22 2020 14:54:08&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sessionId&quot; : null,</span><br><span class="line">  &quot;status&quot; : 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è®¿é—® <a target="_blank" rel="noopener" href="http://127.0.0.1:8100/inspector">http://127.0.0.1:8100/inspector</a> å¯ä»¥çœ‹è®¾å¤‡ç•Œé¢ï¼Œä½†æ˜¯æŠ¥é”™äº†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;value&quot; : &#123;</span><br><span class="line">    &quot;error&quot; : &quot;unknown command&quot;,</span><br><span class="line">    &quot;message&quot; : &quot;Unhandled endpoint: \&#x2F;inspector -- http:\&#x2F;\&#x2F;127.0.0.1:8100\&#x2F; with parameters &#123;\n wildcards &#x3D; (\ninspector\n);\n&#125;&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;sessionId&quot; : null,</span><br><span class="line">  &quot;status&quot; : 6</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰“å¼€ AirtestIDEï¼Œè¿æ¥ <a target="_blank" rel="noopener" href="http://127.0.0.1:8100/">http://127.0.0.1:8100</a> è¿æ¥ä¸ä¸Š</p>
<p>Xcodeæ§åˆ¶å°æŠ¥é”™</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-[XCUIScreen screenshotDataForQuality:rect:error:]: unrecognized selector sent to instance 0x28070ffc0</span><br></pre></td></tr></table></figure>

<p>é‡æ–°ä¸‹è½½xcodeé¡¹ç›® <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1FCZ-FPQSqYmiGc5QjdjUew">https://pan.baidu.com/s/1FCZ-FPQSqYmiGc5QjdjUew</a>  nk77 å¯ä»¥è¿æ¥ä¸Š</p>
<p>å·¦ä¸Šè§’ + å·ï¼Œæ–°å»ºä¸€ä¸ª Airtest Project</p>
<img src="Airtest/WeChat74e3de483b997363ebd9b50d174b58cc.png" alt="WeChat74e3de483b997363ebd9b50d174b58cc" style="zoom:67%;" /> 

<p>è‡ªåŠ¨ç”Ÿæˆåˆå§‹åŒ–ä»£ç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># -*- encoding&#x3D;utf8 -*-</span><br><span class="line">__author__ &#x3D; &quot;midland_whk&quot;</span><br><span class="line">from airtest.core.api import *</span><br><span class="line">auto_setup(__file__)</span><br></pre></td></tr></table></figure>

<p>è¾…åŠ©çª—ä¸­ç‚¹å‡» touchï¼Œè¿™æ—¶å¯ä»¥åœ¨å³ä¾§è®¾å¤‡ç•Œé¢æ‹–åŠ¨æ¡†æŸ±æƒ³è¦ç‚¹å‡»çš„åŒºåŸŸï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆä¸€è¡Œç‚¹å‡»ä»£ç </p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/26/%E8%AE%B0%E5%BD%95%E4%B8%8B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="ç®€å•è®°å½•ä¸‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/26/%E8%AE%B0%E5%BD%95%E4%B8%8B2/" class="post-title-link" itemprop="url">è®°å½•ä¸‹2</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-04-26 09:13:55" itemprop="dateCreated datePublished" datetime="2022-04-26T09:13:55+08:00">2022-04-26</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-05-20 10:45:03" itemprop="dateModified" datetime="2022-05-20T10:45:03+08:00">2022-05-20</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          è¾“å…¥å¯†ç 
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/04/26/%E8%AE%B0%E5%BD%95%E4%B8%8B2/#more" rel="contents">
                é˜…è¯»å…¨æ–‡ &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/25/%E8%AE%B0%E5%BD%95%E4%B8%8B1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="ç®€å•è®°å½•ä¸‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/25/%E8%AE%B0%E5%BD%95%E4%B8%8B1/" class="post-title-link" itemprop="url">è®°å½•ä¸‹1</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-04-25 10:36:44" itemprop="dateCreated datePublished" datetime="2022-04-25T10:36:44+08:00">2022-04-25</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-09-14 15:26:42" itemprop="dateModified" datetime="2022-09-14T15:26:42+08:00">2022-09-14</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          è¾“å…¥å¯†ç 
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2022/04/25/%E8%AE%B0%E5%BD%95%E4%B8%8B1/#more" rel="contents">
                é˜…è¯»å…¨æ–‡ &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/23/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-%E5%88%86%E5%B8%83%E5%BC%8F%E7%88%AC%E8%99%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="ç®€å•è®°å½•ä¸‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/23/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-%E5%88%86%E5%B8%83%E5%BC%8F%E7%88%AC%E8%99%AB/" class="post-title-link" itemprop="url">Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-åˆ†å¸ƒå¼çˆ¬è™«</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-04-23 10:35:41" itemprop="dateCreated datePublished" datetime="2022-04-23T10:35:41+08:00">2022-04-23</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-04-24 09:30:18" itemprop="dateModified" datetime="2022-04-24T09:30:18+08:00">2022-04-24</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>åˆ†å¸ƒå¼çˆ¬è™«å°†å¤šå°ä¸»æœºç»„åˆèµ·æ¥ï¼Œå…±åŒå®Œæˆä¸€ä¸ªçˆ¬å–ä»»åŠ¡</p>
<p>Scrapy-Redis åº“æä¾›äº† Scrapy åˆ†å¸ƒå¼çš„é˜Ÿåˆ—ã€è°ƒåº¦å™¨ã€å»é‡ç­‰åŠŸèƒ½</p>
<h4 id="14-3-Scrapy-åˆ†å¸ƒå¼å®ç°"><a href="#14-3-Scrapy-åˆ†å¸ƒå¼å®ç°" class="headerlink" title="14.3 Scrapy åˆ†å¸ƒå¼å®ç°"></a>14.3 Scrapy åˆ†å¸ƒå¼å®ç°</h4><p>åˆ©ç”¨ Scrapy-Redis æ¥å®ç°åˆ†å¸ƒå¼å¯¹æ¥</p>
<h5 id="æ­å»º-Redis-æœåŠ¡å™¨"><a href="#æ­å»º-Redis-æœåŠ¡å™¨" class="headerlink" title="æ­å»º Redis æœåŠ¡å™¨"></a>æ­å»º Redis æœåŠ¡å™¨</h5><p>è¦å®ç°åˆ†å¸ƒå¼éƒ¨ç½²ï¼Œå¤šå°ä¸»æœºéœ€è¦å…±äº«çˆ¬å–é˜Ÿåˆ—å’Œå»é‡é›†åˆï¼Œè€Œè¿™ä¸¤éƒ¨åˆ†å†…å®¹æ˜¯å­˜äº Redis æ•°æ®åº“ä¸­çš„ï¼Œéœ€è¦æ­å»ºä¸€ä¸ªå¯å…¬ç½‘è®¿é—®çš„ Redis æœåŠ¡å™¨</p>
<p>æ¨èä½¿ç”¨ Linux æœåŠ¡å™¨ï¼Œå¯ä»¥è´­ä¹°é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ã€Azureç­‰æä¾›çš„äº‘ä¸»æœºï¼Œä¸€èˆ¬éƒ½ä¼šé…æœ‰å…¬ç½‘ IP</p>
<p>é˜¿é‡Œäº‘ã€è…¾è®¯äº‘çš„æœåŠ¡å™¨éœ€è¦é…ç½®å®‰å…¨ç»„æ”¾é€š Redis è¿è¡Œç«¯å£æ‰å¯ä»¥è¿œç¨‹è®¿é—®</p>
<h5 id="é…ç½®-Scrapy-Redis"><a href="#é…ç½®-Scrapy-Redis" class="headerlink" title="é…ç½® Scrapy-Redis"></a>é…ç½® Scrapy-Redis</h5><ul>
<li>æ ¸å¿ƒé…ç½®</li>
</ul>
<p>å°†è°ƒåº¦å™¨çš„ç±»å’Œå»é‡çš„ç±»æ›¿æ¢ä¸º Scrapy-Redis æä¾›çš„ç±»ï¼Œsettings.py é‡Œæ·»åŠ é…ç½®</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SCHEDULER &#x3D; &quot;scrapy_redis.scheduler.Scheduler&quot;</span><br><span class="line">DUPEFILTER_CLASS &#x3D; &quot;scrapy_redis.dupefilter.RFPDupeFilter&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>Redis è¿æ¥é…ç½®</li>
</ul>
<p>æ–¹å¼ä¸€ï¼šé€šè¿‡è¿æ¥å­—ç¬¦ä¸²é…ç½®</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">redis://[:password]@host:port/db</span><br><span class="line">rediss://[:password]@host:port/db</span><br><span class="line">unix://[:password]@/path/to/socket.sock?db=db</span><br><span class="line"><span class="comment">#å¦‚ redis://:foobared@127.2.34.25:6379</span></span><br></pre></td></tr></table></figure>

<p>ä¸­æ‹¬å·ä»£è¡¨æ­¤é€‰é¡¹å¯æœ‰å¯æ—  dbæ˜¯æ•°æ®åº“ä»£å·ï¼Œé»˜è®¤å€¼ 0</p>
<p>settings.py é‡Œé…ç½®ä¸º REDIS_URL å˜é‡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">REDIS_URL &#x3D; &#39;redis:&#x2F;&#x2F;:foobared@127.2.34.25:6379&#39;</span><br></pre></td></tr></table></figure>

<p>æ–¹å¼äºŒï¼šæ˜¯åˆ†é¡¹å•ç‹¬é…ç½®ï¼Œ settings.py ä¸­é…ç½®</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">REDIS_HOST &#x3D; &#39;127.2.34.25&#39;</span><br><span class="line">REDIS_PORT &#x3D; &#39;6379&#39;</span><br><span class="line">REDIS_PASSWORD &#x3D; &#39;foobared&#39;</span><br></pre></td></tr></table></figure>

<h5 id="é…ç½®è°ƒåº¦é˜Ÿåˆ—"><a href="#é…ç½®è°ƒåº¦é˜Ÿåˆ—" class="headerlink" title="é…ç½®è°ƒåº¦é˜Ÿåˆ—"></a>é…ç½®è°ƒåº¦é˜Ÿåˆ—</h5><p>æ­¤é…ç½®å¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨ PriorityQueueï¼Œå¦‚æœæƒ³æ›´æ”¹é…ç½®ï¼Œå¯æœ‰é…ç½® SCHEDULER_QUEUE_CLASS å˜é‡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SCHEDULER_QUEUE_CLASS &#x3D; &#39;scrapy_redis.queue.PriorityQueue&#39;</span><br><span class="line">SCHEDULER_QUEUE_CLASS &#x3D; &#39;scrapy_redis.queue.FifoQueue&#39;</span><br><span class="line">SCHEDULER_QUEUE_CLASS &#x3D; &#39;scrapy_redis.queue.LifoQueue&#39;</span><br></pre></td></tr></table></figure>

<p>ä»»é€‰ä¸€é…ç½®ï¼Œå³å¯åˆ‡æ¢çˆ¬å–é˜Ÿåˆ—çš„å­˜å‚¨æ–¹å¼</p>
<h5 id="é…ç½®æŒä¹…åŒ–"><a href="#é…ç½®æŒä¹…åŒ–" class="headerlink" title="é…ç½®æŒä¹…åŒ–"></a>é…ç½®æŒä¹…åŒ–</h5><p>å¯é€‰é…ç½®ï¼Œé»˜è®¤ Falseã€‚Scrapy-Redis é»˜è®¤ä¼šåœ¨çˆ¬å–å…¨éƒ¨å®Œæˆæ¸…ç©ºçˆ¬å–é˜Ÿåˆ—å’Œå»é‡æŒ‡çº¹é›†åˆ</p>
<p>å¦‚æœä¸æƒ³è‡ªåŠ¨æ¸…ç©ºçˆ¬å–é˜Ÿåˆ—å’Œå»é‡æŒ‡çº¹é›†åˆï¼Œå¯ä»¥å¢åŠ é…ç½®</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SCHEDULER_PERSIST &#x3D; True</span><br></pre></td></tr></table></figure>

<h5 id="é…ç½®é‡çˆ¬"><a href="#é…ç½®é‡çˆ¬" class="headerlink" title="é…ç½®é‡çˆ¬"></a>é…ç½®é‡çˆ¬</h5><p>å¯é€‰é…ç½®ï¼Œé»˜è®¤ Falseï¼Œå¦‚æœé…ç½®äº†æŒä¹…åŒ–æˆ–è€…å¼ºåˆ¶ä¸­æ–­äº†çˆ¬è™«ï¼Œé‚£ä¹ˆçˆ¬å–é˜Ÿåˆ—å’ŒæŒ‡çº¹é›†åˆä¸ä¼šè¢«æ¸…ç©ºï¼Œçˆ¬è™«é‡å¯ä¹‹åå°±ä¼šæ¥ä¸Šæ¬¡çˆ¬å–ï¼Œå¦‚æœæƒ³é‡æ–°çˆ¬å–</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SCHEDULER_FLUSH_ON_START &#x3D; True</span><br></pre></td></tr></table></figure>

<p>åˆ†å¸ƒå¼çˆ¬å–ä¸å¸¸ç”¨æ­¤é…ç½®</p>
<h5 id="Pipeline-é…ç½®"><a href="#Pipeline-é…ç½®" class="headerlink" title="Pipeline é…ç½®"></a>Pipeline é…ç½®</h5><p>å¯é€‰é…ç½®ï¼Œé»˜è®¤ä¸å¯åŠ¨</p>
<h5 id="é…ç½®å­˜å‚¨ç›®æ ‡"><a href="#é…ç½®å­˜å‚¨ç›®æ ‡" class="headerlink" title="é…ç½®å­˜å‚¨ç›®æ ‡"></a>é…ç½®å­˜å‚¨ç›®æ ‡</h5><p>æœ€å¥½å°†å­˜å‚¨ç›®æ ‡å­˜åˆ°åŒä¸€åœ°æ–¹ï¼Œå¯ä»¥åœ¨æœåŠ¡å™¨ä¸Šæ­å»ºä¸€ä¸ª MongoDB æœåŠ¡ï¼Œæˆ–è€…è´­ä¹° MongoDB æ•°æ®å­˜å‚¨æœåŠ¡</p>
<p>è¿™é‡Œä½¿ç”¨æœåŠ¡å™¨ä¸Šæ­å»ºçš„ MongoDB æœåŠ¡ ï¼ŒIP120.27.34.25 ç”¨æˆ·å admin å¯†ç  admin123</p>
<p>ä¿®æ”¹ MONGO_URI </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MONGO_URI &#x3D; &#39;mongodb:&#x2F;&#x2F;admin:admin123@120.27.34.25:27017&#39;</span><br></pre></td></tr></table></figure>

<h5 id="è¿è¡Œ"><a href="#è¿è¡Œ" class="headerlink" title="è¿è¡Œ"></a>è¿è¡Œ</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy crawl weibocn</span><br></pre></td></tr></table></figure>

<p>æ¯å°ä¸»æœºå¯åŠ¨äº†æ­¤å‘½ä»¤ä¹‹åï¼Œå°±ä¼šä»é…ç½®çš„ Redis æ•°æ®åº“ä¸­è°ƒåº¦ Requestï¼Œåšåˆ°çˆ¬å–é˜Ÿåˆ—å…±äº«å’ŒæŒ‡çº¹é›†åˆå…±äº«ï¼Œæ¯å°ä¸»æœºå ç”¨å„è‡ªçš„å®½å¸¦å’Œå¤„ç†å™¨ï¼Œä¸ä¼šäº’ç›¸å½±å“</p>
<h4 id="14-5-Bloom-Filter-å¯¹æ¥"><a href="#14-5-Bloom-Filter-å¯¹æ¥" class="headerlink" title="14.5 Bloom Filter å¯¹æ¥"></a>14.5 Bloom Filter å¯¹æ¥</h4><p>å¸ƒéš†è¿‡æ»¤å™¨ï¼Œç”¨æ¥æ£€æµ‹ä¸€ä¸ªå…ƒç´ æ˜¯å¦åœ¨ä¸€ä¸ªé›†åˆä¸­</p>
<h5 id="å¯¹æ¥-Scrapy-Redis"><a href="#å¯¹æ¥-Scrapy-Redis" class="headerlink" title="å¯¹æ¥ Scrapy-Redis"></a>å¯¹æ¥ Scrapy-Redis</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install scrapy-redis-bloomfilter</span><br></pre></td></tr></table></figure>

<p>é…ç½®</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å»é‡ç±»ï¼Œè¦ä½¿ç”¨Bloom Filter æ›¿æ¢ DUPEFILTER_CLASS</span></span><br><span class="line">DUPEFILTER_CLASS = <span class="string">&#x27;scrapy_redis_bloomfilter.dupefilter.RFPDupeFilter&#x27;</span></span><br><span class="line"><span class="comment">#æ•£åˆ—å‡½æ•°çš„ä¸ªæ•° é»˜è®¤ 6</span></span><br><span class="line">BLOOMFILTER_HASH_NUMBER = <span class="number">6</span></span><br><span class="line"><span class="comment">#Bloom Filter çš„bitå‚æ•° é»˜è®¤30 å ç”¨128Mç©ºé—´ï¼Œå»é‡é‡çº§1äº¿</span></span><br><span class="line">BLOOMFILTER_BIT = <span class="number">30</span></span><br></pre></td></tr></table></figure>



<h4 id="åˆ†å¸ƒå¼çˆ¬è™«éƒ¨ç½²"><a href="#åˆ†å¸ƒå¼çˆ¬è™«éƒ¨ç½²" class="headerlink" title="åˆ†å¸ƒå¼çˆ¬è™«éƒ¨ç½²"></a>åˆ†å¸ƒå¼çˆ¬è™«éƒ¨ç½²</h4><h4 id="15-1-Scrapyd-åˆ†å¸ƒå¼éƒ¨ç½²"><a href="#15-1-Scrapyd-åˆ†å¸ƒå¼éƒ¨ç½²" class="headerlink" title="15.1 Scrapyd åˆ†å¸ƒå¼éƒ¨ç½²"></a>15.1 Scrapyd åˆ†å¸ƒå¼éƒ¨ç½²</h4><p>Scrapyd è¿è¡Œ Scrapy çˆ¬è™«çš„æœåŠ¡ç¨‹åºï¼Œæä¾›ä¸€ç³»åˆ— HTTP æ¥å£å¸®åŠ©éƒ¨ç½²ã€å¯åŠ¨ã€åœæ­¢ã€åˆ é™¤çˆ¬è™«ç¨‹åº</p>
<h5 id="Scrapyd"><a href="#Scrapyd" class="headerlink" title="Scrapyd"></a>Scrapyd</h5><h5 id="Scrapyd-API"><a href="#Scrapyd-API" class="headerlink" title="Scrapyd API"></a>Scrapyd API</h5><h4 id="15-2-Scrapyd-Client"><a href="#15-2-Scrapyd-Client" class="headerlink" title="15.2 Scrapyd-Client"></a>15.2 Scrapyd-Client</h4><p>Scrapyd-Client ä¸ºäº†æ–¹ä¾¿ Scrapy é¡¹ç›®çš„éƒ¨ç½²ï¼Œæä¾›äº†ä¸¤ä¸ªåŠŸèƒ½</p>
<p>å°†é¡¹ç›®æ‰“åŒ…æˆ Eggæ–‡ä»¶</p>
<p>å°†æ‰“åŒ…ç”Ÿæˆçš„Eggæ–‡ä»¶é€šè¿‡ addversion.json æ¥å£éƒ¨ç½²åˆ° Scrapyd ä¸Š</p>
<h5 id="Scrapyd-Client-éƒ¨ç½²"><a href="#Scrapyd-Client-éƒ¨ç½²" class="headerlink" title="Scrapyd-Client éƒ¨ç½²"></a>Scrapyd-Client éƒ¨ç½²</h5><h4 id="15-3-Scrapyd-å¯¹æ¥-Docker"><a href="#15-3-Scrapyd-å¯¹æ¥-Docker" class="headerlink" title="15.3 Scrapyd å¯¹æ¥ Docker"></a>15.3 Scrapyd å¯¹æ¥ Docker</h4><p>å°† Scrapyd æ‰“åŒ…æˆä¸€ä¸ª Docker é•œåƒï¼Œé‚£ä¹ˆåœ¨æœåŠ¡å™¨ä¸Šåªéœ€è¦æ‰§è¡Œ Docker å‘½ä»¤å°±å¯ä»¥å¯åŠ¨ Scrapyd æœåŠ¡ï¼Œå°±ä¸ç”¨å…³å¿ƒ Python ç¯å¢ƒé—®é¢˜ï¼Œä¹Ÿä¸éœ€è¦æ‹…å¿ƒç‰ˆæœ¬å†²çªé—®é¢˜</p>
<h4 id="15-4-Scrapyd-æ‰¹é‡éƒ¨ç½²"><a href="#15-4-Scrapyd-æ‰¹é‡éƒ¨ç½²" class="headerlink" title="15.4 Scrapyd æ‰¹é‡éƒ¨ç½²"></a>15.4 Scrapyd æ‰¹é‡éƒ¨ç½²</h4>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/21/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-9%E4%BB%A3%E7%90%86%E7%9A%84%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="ç®€å•è®°å½•ä¸‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/21/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-9%E4%BB%A3%E7%90%86%E7%9A%84%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-9ä»£ç†çš„ä½¿ç”¨</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-04-21 09:15:06" itemprop="dateCreated datePublished" datetime="2022-04-21T09:15:06+08:00">2022-04-21</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-10-17 09:01:44" itemprop="dateModified" datetime="2022-10-17T09:01:44+08:00">2022-10-17</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>å¦‚æœæœ¬æœºæœ‰ç›¸å…³ä»£ç†è½¯ä»¶çš„è¯ï¼Œè½¯ä»¶ä¸€èˆ¬ä¼šåœ¨æœ¬æœºåˆ›å»º HTTP æˆ– SOCKS ä»£ç†æœåŠ¡</p>
<p>åªè¦è®¾ç½®äº†ä»£ç†ï¼Œå°±å¯ä»¥æˆåŠŸå°†æœ¬æœº IP åˆ‡æ¢åˆ°ä»£ç†è½¯ä»¶è¿æ¥çš„æœåŠ¡å™¨çš„ IP äº†</p>
<p>è®¾ç½®ä»£ç†åæµ‹è¯•ç½‘å€ <a target="_blank" rel="noopener" href="http://httpbin.org/get">http://httpbin.org/get</a></p>
<h4 id="9-1-ä»£ç†è®¾ç½®"><a href="#9-1-ä»£ç†è®¾ç½®" class="headerlink" title="9.1 ä»£ç†è®¾ç½®"></a>9.1 ä»£ç†è®¾ç½®</h4><h5 id="urllib"><a href="#urllib" class="headerlink" title="urllib"></a>urllib</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.error <span class="keyword">import</span> URLError</span><br><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> ProxyHandler, build_opener</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  proxy = <span class="string">&#x27;183.172.236.158:10080&#x27;</span></span><br><span class="line">  proxy_handler = ProxyHandler(&#123;</span><br><span class="line">      <span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;http://&#x27;</span> + proxy,</span><br><span class="line">      <span class="string">&#x27;https&#x27;</span>: <span class="string">&#x27;https://&#x27;</span> + proxy</span><br><span class="line">  &#125;)</span><br><span class="line">  opener = build_opener(proxy_handler)</span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">      response = opener.<span class="built_in">open</span>(<span class="string">&#x27;http://httpbin.org/get&#x27;</span>)</span><br><span class="line">      print(response.read().decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">  <span class="keyword">except</span> URLError <span class="keyword">as</span> e:</span><br><span class="line">      print(e.reason)</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ ProxyHandler è®¾ç½®ä»£ç†</p>
<p>ç»“æœï¼Œorigin å­—æ®µæ ‡æ˜äº†å®¢æˆ·ç«¯çš„ IP</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;args&quot;: &#123;&#125;, </span><br><span class="line">  &quot;headers&quot;: &#123;</span><br><span class="line">    &quot;Accept-Encoding&quot;: &quot;identity&quot;, </span><br><span class="line">    &quot;Host&quot;: &quot;httpbin.org&quot;, </span><br><span class="line">    &quot;User-Agent&quot;: &quot;Python-urllib&#x2F;3.8&quot;, </span><br><span class="line">    &quot;X-Amzn-Trace-Id&quot;: &quot;Root&#x3D;1-6260b354-5d0a11da29ddab260babe279&quot;</span><br><span class="line">  &#125;, </span><br><span class="line">  &quot;origin&quot;: &quot;183.172.236.158&quot;, </span><br><span class="line">  &quot;url&quot;: &quot;http:&#x2F;&#x2F;httpbin.org&#x2F;get&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ˜¯éœ€è¦è®¤è¯çš„ä»£ç†ï¼Œåªéœ€è¦åœ¨ä»£ç†å‰é¢åŠ å…¥ä»£ç†è®¤è¯çš„ç”¨æˆ·åå’Œå¯†ç å³å¯ï¼Œå°†ä¸Šé¢çš„ proxy å˜é‡æ”¹æˆ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy &#x3D; &#39;username:password@183.172.236.158:10080&#39;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä»£ç†æ˜¯ SOCKS5 ç±»å‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.error <span class="keyword">import</span> URLError</span><br><span class="line"><span class="keyword">import</span> socks</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line">socks.set_default_proxy(socks.SOCKS5, <span class="string">&#x27;183.172.236.158&#x27;</span>, <span class="string">&#x27;10080&#x27;</span>)</span><br><span class="line">socket.socket = socks.socksocket</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = request.urlopen(<span class="string">&#x27;http://httpbin.org/get&#x27;</span>)</span><br><span class="line">    print(response.read().decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"><span class="keyword">except</span> URLError <span class="keyword">as</span> e:</span><br><span class="line">    print(e.reason)</span><br></pre></td></tr></table></figure>

<p>æ­¤å¤„éœ€è¦ä¸€ä¸ª socks æ¨¡å—</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install PySocks</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæœ¬åœ°æœ‰ä¸€ä¸ª SOCKS5ä»£ç†ï¼Œè¿è¡Œåœ¨ 10080 ç«¯å£ï¼Œè¿è¡ŒæˆåŠŸå’Œä¸Šé¢æ˜¯ä¸€æ ·çš„</p>
<h5 id="requests"><a href="#requests" class="headerlink" title="requests"></a>requests</h5><p>åªéœ€è¦ä¼ å…¥ proxies å³å¯</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">proxy = <span class="string">&#x27;183.172.236.158:10080&#x27;</span></span><br><span class="line"><span class="comment">#å¦‚æœéœ€è¦è®¤è¯ï¼Œæ”¹æˆ proxy = &#x27;username:password@183.172.236.158:10080&#x27;</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;http://&#x27;</span> + proxy,</span><br><span class="line">    <span class="string">&#x27;https&#x27;</span>: <span class="string">&#x27;https://&#x27;</span> + proxy</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = requests.get(<span class="string">&#x27;http://httpbin.org/get&#x27;</span>, proxies=proxies)</span><br><span class="line">    print(response.text)</span><br><span class="line"><span class="keyword">except</span> requests.exceptions.ConnectionError <span class="keyword">as</span> e:</span><br><span class="line">    print(<span class="string">&#x27;Error&#x27;</span>, e.args)</span><br></pre></td></tr></table></figure>

<p>å¦‚æœéœ€è¦ä½¿ç”¨ SOCKS5ä»£ç†ï¼Œå°† proxies æ”¹æˆ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">proxy = <span class="string">&#x27;183.172.236.158:10080&#x27;</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;socks5&#x27;</span> + proxy,</span><br><span class="line">    <span class="string">&#x27;https&#x27;</span>: <span class="string">&#x27;socks5&#x27;</span> + proxy</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>éœ€è¦é¢å¤–å®‰è£…ä¸€ä¸ªæ¨¡å—ï¼Œå«ä½œ requests[socks]</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install &#39;requests[socks]&#39;</span><br></pre></td></tr></table></figure>

<p>è¿˜æœ‰ä¸€ç§è®¾ç½®æ–¹å¼ï¼Œå’Œ urllib ä¸­çš„æ–¹æ³•ç›¸åŒï¼Œç›¸æ¯”ç¬¬ä¸€ç§æ–¹æ³•ï¼Œæ­¤æ–¹æ³•æ˜¯å…¨å±€è®¾ç½®çš„</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> socks</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">socks.set_default_proxy(socks.SOCKS5, <span class="string">&#x27;183.172.236.158&#x27;</span>, <span class="string">&#x27;10080&#x27;</span>)</span><br><span class="line">socket.socket = socks.socksocket</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = requests.get(<span class="string">&#x27;http://httpbin.org/get&#x27;</span>)</span><br><span class="line">    print(response.read().decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"><span class="keyword">except</span> URLError <span class="keyword">as</span> e:</span><br><span class="line">    print(e.reason)</span><br></pre></td></tr></table></figure>

<h5 id="httpx"><a href="#httpx" class="headerlink" title="httpx"></a>httpx</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> httpx</span><br><span class="line">proxy = <span class="string">&#x27;127.0.0.1:7890&#x27;</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">&#x27;http://&#x27;</span>: <span class="string">&#x27;http://&#x27;</span> + proxy,</span><br><span class="line">    <span class="string">&#x27;https://&#x27;</span>: <span class="string">&#x27;https://&#x27;</span> + proxy</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">with</span> httpx.Client(proxies=proxies) <span class="keyword">as</span> client:</span><br><span class="line">  response = client.get(<span class="string">&#x27;https://www.httpbin.org/get&#x27;</span>)</span><br><span class="line">  print(response.text)</span><br></pre></td></tr></table></figure>



<h5 id="Selenium"><a href="#Selenium" class="headerlink" title="Selenium"></a>Selenium</h5><p>Chromeã€PhantomJS</p>
<h6 id="Chrome"><a href="#Chrome" class="headerlink" title="Chrome"></a>Chrome</h6><p>é€šè¿‡ ChromeOptions æ¥è®¾ç½®ä»£ç†ï¼Œåˆ›å»º Chrome å¯¹è±¡ä½¿ç”¨ options å‚æ•°ä¼ é€’å³å¯</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">proxy = <span class="string">&#x27;101.132.189.87:9090&#x27;</span></span><br><span class="line">chrome_options = webdriver.ChromeOptions()</span><br><span class="line">chrome_options.add_argument(<span class="string">&#x27;--proxy-server=http://&#x27;</span> + proxy)</span><br><span class="line">browser = webdriver.Chrome(options=options)</span><br><span class="line">browser.get(<span class="string">&#x27;http://httpbin.org/get&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ˜¯è®¤è¯ä»£ç†ï¼Œè®¾ç½®ä¼šæ¯”è¾ƒéº»çƒ¦</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.chrome.options <span class="keyword">import</span> Options</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"></span><br><span class="line">ip = <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">port = <span class="number">9743</span></span><br><span class="line">username = <span class="string">&#x27;foo&#x27;</span></span><br><span class="line">password = <span class="string">&#x27;bar&#x27;</span></span><br><span class="line"></span><br><span class="line">manifest_json = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">    &quot;version&quot;: &quot;1.0.0&quot;,</span></span><br><span class="line"><span class="string">    &quot;manifest_version&quot;: 2,</span></span><br><span class="line"><span class="string">    &quot;name&quot;: &quot;Chrome Proxy&quot;,</span></span><br><span class="line"><span class="string">    &quot;permissions&quot;: [</span></span><br><span class="line"><span class="string">        &quot;proxy&quot;,</span></span><br><span class="line"><span class="string">        &quot;tabs&quot;,</span></span><br><span class="line"><span class="string">        &quot;unlimitedStorage&quot;,</span></span><br><span class="line"><span class="string">        &quot;storage&quot;,</span></span><br><span class="line"><span class="string">        &quot;&lt;all_urls&gt;&quot;,</span></span><br><span class="line"><span class="string">        &quot;webRequest&quot;,</span></span><br><span class="line"><span class="string">        &quot;webRequestBlocking&quot;</span></span><br><span class="line"><span class="string">    ],</span></span><br><span class="line"><span class="string">    &quot;background&quot;: &#123;</span></span><br><span class="line"><span class="string">        &quot;scripts&quot;: [&quot;background.js&quot;]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">background_js = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">var config = &#123;</span></span><br><span class="line"><span class="string">        mode: &quot;fixed_servers&quot;,</span></span><br><span class="line"><span class="string">        rules: &#123;</span></span><br><span class="line"><span class="string">          singleProxy: &#123;</span></span><br><span class="line"><span class="string">            scheme: &quot;http&quot;,</span></span><br><span class="line"><span class="string">            host: &quot;%(ip)s&quot;,</span></span><br><span class="line"><span class="string">            port: %(port)s</span></span><br><span class="line"><span class="string">          &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">chrome.proxy.settings.set(&#123;value: config, scope: &quot;regular&quot;&#125;, function() &#123;&#125;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">function callbackFn(details) &#123;</span></span><br><span class="line"><span class="string">    return &#123;</span></span><br><span class="line"><span class="string">        authCredentials: &#123;</span></span><br><span class="line"><span class="string">            username: &quot;%(username)s&quot;,</span></span><br><span class="line"><span class="string">            password: &quot;%(password)s&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">chrome.webRequest.onAuthRequired.addListener(</span></span><br><span class="line"><span class="string">            callbackFn,</span></span><br><span class="line"><span class="string">            &#123;urls: [&quot;&lt;all_urls&gt;&quot;]&#125;,</span></span><br><span class="line"><span class="string">            [&#x27;blocking&#x27;]</span></span><br><span class="line"><span class="string">)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span> % &#123;<span class="string">&#x27;ip&#x27;</span>: ip, <span class="string">&#x27;port&#x27;</span>: port, <span class="string">&#x27;username&#x27;</span>: username, <span class="string">&#x27;password&#x27;</span>: password&#125;</span><br><span class="line"></span><br><span class="line">plugin_file = <span class="string">&#x27;proxy_auth_plugin.zip&#x27;</span></span><br><span class="line"><span class="keyword">with</span> zipfile.ZipFile(plugin_file, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> zp:</span><br><span class="line">    zp.writestr(<span class="string">&quot;manifest.json&quot;</span>, manifest_json)</span><br><span class="line">    zp.writestr(<span class="string">&quot;background.js&quot;</span>, background_js)</span><br><span class="line">chrome_options = Options()</span><br><span class="line">chrome_options.add_argument(<span class="string">&quot;--start-maximized&quot;</span>)</span><br><span class="line">chrome_options.add_extension(plugin_file)</span><br><span class="line">browser = webdriver.Chrome(chrome_options=chrome_options)</span><br><span class="line">browser.get(<span class="string">&#x27;http://httpbin.org/get&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>éœ€è¦åˆ›å»º manifest.json é…ç½®æ–‡ä»¶å’Œ background.js è„šæœ¬æ¥è®¾ç½®ä»£ç†ï¼Œè¿è¡Œä»£ç åä¼šç”Ÿæˆä¸€ä¸ª proxy_auth_plugin.zip æ–‡ä»¶æ¥ä¿å­˜å½“å‰é…ç½®</p>
<h6 id="PhantomJS"><a href="#PhantomJS" class="headerlink" title="PhantomJS"></a>PhantomJS</h6><p><del>è®¾ç½®ä»£ç†å¯ä»¥å€ŸåŠ© service_args å‚æ•°ï¼Œä¹Ÿå°±æ˜¯å‘½ä»¤è¡Œå‚æ•°</del></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">module &#39;selenium.webdriver&#39; has no attribute &#39;PhantomJS&#39;</span><br></pre></td></tr></table></figure>

<p>ä¸æ”¯æŒäº†</p>
<h5 id="aiohttp-ä»£ç†è®¾ç½®"><a href="#aiohttp-ä»£ç†è®¾ç½®" class="headerlink" title="aiohttp ä»£ç†è®¾ç½®"></a>aiohttp ä»£ç†è®¾ç½®</h5><h5 id="Pyppeteerä»£ç†è®¾ç½®"><a href="#Pyppeteerä»£ç†è®¾ç½®" class="headerlink" title="Pyppeteerä»£ç†è®¾ç½®"></a>Pyppeteerä»£ç†è®¾ç½®</h5><h5 id="Playwrightä»£ç†è®¾ç½®"><a href="#Playwrightä»£ç†è®¾ç½®" class="headerlink" title="Playwrightä»£ç†è®¾ç½®"></a>Playwrightä»£ç†è®¾ç½®</h5><h4 id="9-2-ä»£ç†æ± çš„ç»´æŠ¤"><a href="#9-2-ä»£ç†æ± çš„ç»´æŠ¤" class="headerlink" title="9.2 ä»£ç†æ± çš„ç»´æŠ¤"></a>9.2 ä»£ç†æ± çš„ç»´æŠ¤</h4><h5 id="å­˜å‚¨æ¨¡å—"><a href="#å­˜å‚¨æ¨¡å—" class="headerlink" title="å­˜å‚¨æ¨¡å—"></a>å­˜å‚¨æ¨¡å—</h5><p>å­˜å‚¨æŠ“å–ä¸‹æ¥çš„ä»£ç†ï¼Œè¿™é‡Œç”¨ Redis çš„æœ‰åºé›†åˆï¼Œé›†åˆä¸­æ¯ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯ä¸é‡å¤çš„</p>
<h5 id="è·å–æ¨¡å—"><a href="#è·å–æ¨¡å—" class="headerlink" title="è·å–æ¨¡å—"></a>è·å–æ¨¡å—</h5><p>éœ€è¦å®šæ—¶åœ¨å„å¤§ä»£ç†ç½‘ç«™æŠ“å–ä»£ç†</p>
<h5 id="æ£€æµ‹æ¨¡å—"><a href="#æ£€æµ‹æ¨¡å—" class="headerlink" title="æ£€æµ‹æ¨¡å—"></a>æ£€æµ‹æ¨¡å—</h5><p>éœ€è¦å®šæ—¶æ£€æµ‹æ•°æ®åº“ä¸­çš„ä»£ç†</p>
<p>ä½¿ç”¨å¼‚æ­¥è¯·æ±‚åº“ aiohttp æ¥è¿›è¡Œæ£€æµ‹</p>
<h5 id="æ¥å£æ¨¡å—"><a href="#æ¥å£æ¨¡å—" class="headerlink" title="æ¥å£æ¨¡å—"></a>æ¥å£æ¨¡å—</h5><p>ç”¨ API æ¥æä¾›å¯¹å¤–æœåŠ¡çš„æ¥å£</p>
<p>ä¸ºäº†ä½¿ä»£ç†æ± å¯ä»¥ä½œä¸ºä¸€ä¸ªç‹¬ç«‹æœåŠ¡è¿è¡Œï¼Œæœ€å¥½å¢åŠ ä¸€ä¸ªæ¥å£æ¨¡å—ï¼Œå¹¶ä»¥ WebAPIçš„å½¢å¼æš´éœ²å¯ç”¨ä»£ç†</p>
<h5 id="è°ƒåº¦æ¨¡å—"><a href="#è°ƒåº¦æ¨¡å—" class="headerlink" title="è°ƒåº¦æ¨¡å—"></a>è°ƒåº¦æ¨¡å—</h5><p>è°ƒç”¨ä¸Šé¢å®šä¹‰çš„æ¨¡å—ï¼Œå°†ä¸Šé¢æ¨¡å—é€šè¿‡å¤šè¿›ç¨‹çš„å½¢å¼è¿è¡Œèµ·æ¥</p>
<h4 id="9-3-ä»˜è´¹ä»£ç†"><a href="#9-3-ä»˜è´¹ä»£ç†" class="headerlink" title="9.3 ä»˜è´¹ä»£ç†"></a>9.3 ä»˜è´¹ä»£ç†</h4><p>è®¯ä»£ç† <a target="_blank" rel="noopener" href="http://www.xdaili.cn/">http://www.xdaili.cn</a></p>
<p>é˜¿å¸ƒäº‘ä»£ç† <a target="_blank" rel="noopener" href="https://www.abuyun.com/">https://www.abuyun.com</a></p>
<h4 id="9-4-ADSLæ‹¨å·ä»£ç†"><a href="#9-4-ADSLæ‹¨å·ä»£ç†" class="headerlink" title="9.4 ADSLæ‹¨å·ä»£ç†"></a>9.4 ADSLæ‹¨å·ä»£ç†</h4><p>ADSL é€šè¿‡æ‹¨å·çš„æ–¹å¼ä¸Šç½‘ï¼Œéœ€è¦è¾“å…¥ ADSL è´¦å·å’Œå¯†ç ï¼Œæ¯æ¬¡æ‹¨å·å°±æ›´æ¢ä¸€ä¸ª IPï¼Œå¦‚æœå°† ADSL ä¸»æœºä½œä¸ºä»£ç†ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´ä¸»æœºæ‹¨å·å°±æ¢ä¸€ä¸ª IPï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆé˜²æ­¢ IP è¢«å°ï¼Œä¸»æœºç¨³å®šæ€§å¥½ï¼Œä»£ç†å“åº”é€Ÿåº¦å¾ˆå¿«</p>
<h5 id="è´­ä¹°ä¸»æœº"><a href="#è´­ä¹°ä¸»æœº" class="headerlink" title="è´­ä¹°ä¸»æœº"></a>è´­ä¹°ä¸»æœº</h5><p>è´­ä¹°åŠ¨æ€æ‹¨å· VPS ä¸»æœº</p>
<p>é˜¿æ–¯äº‘ <a target="_blank" rel="noopener" href="https://asiyun.cn/">https://asiyun.cn</a></p>
<p>äº‘ç«‹æ–¹ <a target="_blank" rel="noopener" href="http://www.yunlifang.cn/dynamicvps.asp">http://www.yunlifang.cn/dynamicvps.asp</a></p>
<p>å»ºè®®é€‰æ‹©ç”µä¿¡çº¿è·¯ï¼Œå¯ä»¥è‡ªè¡Œé€‰æ‹©ä¸»æœºé…ç½®</p>
<p>æ¨èå®‰è£… CentOS 7 Linux ç³»ç»Ÿ</p>
<p>æ‰¾åˆ°è¿œç¨‹ç®¡ç†é¢æ¿-è¿œç¨‹è¿æ¥ç”¨æˆ·åå’Œå¯†ç ï¼Œä¹Ÿå°±æ˜¯ SSH è¿œç¨‹è¿æ¥æœåŠ¡å™¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh root@xxx.xx.xx.xx -p xxx</span><br></pre></td></tr></table></figure>

<p>è¾“å…¥ç®¡ç†å¯†ç ï¼Œå°±å¯ä»¥è¿æ¥ä¸Šè¿œç¨‹æœåŠ¡å™¨äº†</p>
<p>è¿›å…¥åæœ‰ä¸ªå¯ç”¨çš„è„šæœ¬æ–‡ä»¶ ppp.shï¼Œè¿™æ˜¯æ‹¨å·åˆå§‹åŒ–çš„è„šæœ¬</p>
<p>è¿è¡Œ ppp.sh è„šæœ¬ï¼Œè¾“å…¥ç”¨æˆ·åã€å¯†ç ç­‰å¾…å®ƒçš„é…ç½®å®Œæˆ</p>
<p>è¾“å…¥æ‹¨å·å‘½ä»¤ </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adsl-start</span><br></pre></td></tr></table></figure>

<p>è¿è¡ŒæˆåŠŸåå°±å¯ä»¥å»è¯• ping å¤–ç½‘äº†</p>
<p>åœæ­¢æ‹¨å·</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adsl-stop</span><br></pre></td></tr></table></figure>

<p>é˜¿æ–¯äº‘æ‹¨å·å‘½ä»¤ </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pppoe-start</span><br><span class="line">pppoe-stor</span><br></pre></td></tr></table></figure>



<p>æ–­çº¿é‡æ’­çš„å‘½ä»¤å°±æ˜¯ä¸¤ä¸ªå‘½ä»¤ç»„åˆèµ·æ¥ï¼Œæ¯æ¬¡æ‹¨å·ï¼Œifconfig æŸ¥çœ‹ä¸»æœº IPï¼Œå‘ç°ä¸»æœº IP ä¸€ç›´åœ¨å˜åŒ–</p>
<h5 id="è®¾ç½®ä»£ç†æœåŠ¡å™¨"><a href="#è®¾ç½®ä»£ç†æœåŠ¡å™¨" class="headerlink" title="è®¾ç½®ä»£ç†æœåŠ¡å™¨"></a>è®¾ç½®ä»£ç†æœåŠ¡å™¨</h5><p>Linux ä¸‹æ­å»º HTTP ä»£ç†æœåŠ¡å™¨ï¼Œæ¨è TinyProxy å’Œ Squid</p>
<h6 id="TinyProxy"><a href="#TinyProxy" class="headerlink" title="TinyProxy"></a>TinyProxy</h6><p>è¿™é‡Œä»¥ TinyProxy ä¸ºä¾‹</p>
<ul>
<li>å®‰è£… TinyProxy</li>
</ul>
<p>CentOS ç³»ç»Ÿä½¿ç”¨ yum æ¥å®‰è£…ï¼Œå…¶å®ƒç³»ç»Ÿå¦‚ Ubuntuï¼Œå¯ä»¥é€‰æ‹© apt-get ç­‰å‘½ä»¤å®‰è£…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y epel-release</span><br><span class="line">yum update -y</span><br><span class="line">yum install -y tinyproxy</span><br></pre></td></tr></table></figure>

<ul>
<li>é…ç½® TinyProxy</li>
</ul>
<p>TinyProxy å®‰è£…å®Œæˆåè¿˜è¦é…ç½®ä¸€ä¸‹æ‰å¯ä»¥ç”¨ä½œä»£ç†æœåŠ¡å™¨ï¼Œéœ€è¦ç¼–è¾‘é…ç½®æ–‡ä»¶</p>
<p>/etc/tinyproxy/tinyproxy.conf</p>
<p><code>Port 8888</code>  è¿™é‡Œå¯ä»¥è®¾ç½®ä»£ç†çš„ç«¯å£ï¼Œé»˜è®¤ 8888</p>
<p>ç»§ç»­æ‰¾åˆ°ä»£ç   <code>Allow 127.0.0.1</code> è¿™è¡Œä»£ç è¡¨ç¤ºè¢«å…è®¸è¿æ¥çš„ä¸»æœº IPï¼Œå¦‚æœå¸Œæœ›è¿æ¥ä»»ä½•ä¸»æœºï¼Œè¿™è¡Œä»£ç æ³¨é‡Šå³å¯ï¼Œè¿™é‡Œé€‰æ‹©æ³¨é‡Šï¼Œä¹Ÿå°±æ˜¯ä»»ä½•ä¸»æœºéƒ½å¯ä»¥ä½¿ç”¨è¿™å°ä¸»æœºä½œä¸ºä»£ç†æœåŠ¡å™¨</p>
<p>è®¾ç½®å®Œæˆåé‡å¯ TinyProxy å³å¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable tinyproxy.service</span><br><span class="line">systemctl restart tinyproxy.service</span><br></pre></td></tr></table></figure>

<p>é˜²ç«å¢™å¼€æ”¾è¯¥ç«¯å£</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT -p tcp --dport 8888 -j ACCEPT</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæƒ³ç›´æ¥å…³é—­é˜²ç«å¢™ä¹Ÿå¯ä»¥</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld.service</span><br></pre></td></tr></table></figure>

<ul>
<li>éªŒè¯ TinyProxy</li>
</ul>
<p>å…ˆç”¨ ifconfig æŸ¥çœ‹å½“å‰ä¸»æœºçš„ IPï¼Œæ¯”å¦‚è¿™ä¸»æœºæ‹¨å· IP ä¸º 112.88.118.212</p>
<p>å…¶å®ƒä¸»æœºè¿è¡Œæµ‹è¯•ä¸‹</p>
<p>ç”¨ curl å‘½ä»¤è®¾ç½®ä»£ç†è¯·æ±‚ï¼Œæ£€æµ‹ä»£ç†æ˜¯å¦ç”Ÿæ•ˆ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -x 112.88.118.212:8888 httpbin.org&#x2F;get</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæœ‰æ­£å¸¸çš„ç»“æœè¾“å‡ºï¼Œå¹¶ä¸” origin çš„å€¼ä¸ºä»£ç† IP å°±è¯æ˜ TinyProxy è®¾ç½®æˆåŠŸäº†</p>
<h6 id="Squid"><a href="#Squid" class="headerlink" title="Squid"></a>Squid</h6><p>å®‰è£… Squid</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo yum -y update</span><br><span class="line">yum -y install squid</span><br><span class="line"></span><br><span class="line">systemctl start squid  #å¯åŠ¨Squid</span><br><span class="line">systemctl enable squid #å¼€æœºè‡ªåŠ¨å¯åŠ¨</span><br><span class="line">systemctl status squid #æŸ¥çœ‹è¿è¡ŒçŠ¶æ€</span><br></pre></td></tr></table></figure>

<p>é»˜è®¤ Squid è¿è¡Œåœ¨ 3128 ç«¯å£</p>
<ul>
<li>å¼€å¯å…è®¸å¤–ç½‘è®¿é—®</li>
</ul>
<p>ä¿®æ”¹  <code>/etc/squid/squid.conf</code></p>
<p>å…è®¸å…¬ç½‘è®¿é—®ï¼Œå°† <code>http_access deny all</code> ä¿®æ”¹ä¸º <code>http_access allow all</code></p>
<p>è¿˜éœ€è¦åœ¨é…ç½®æ–‡ä»¶çš„å¼€å¤´ acl é…ç½®çš„éƒ¨åˆ†æ·»åŠ è¯¥è¡Œå†…å®¹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">acl all src 0.0.0.0&#x2F;0</span><br></pre></td></tr></table></figure>

<p>è¿˜å¯ä»¥å°† Squid é…ç½®æˆé«˜åº¦åŒ¿åä»£ç†ï¼Œè¿™æ ·ç›®æ ‡ç½‘ç«™å°±æ— æ³•ä»é€šè¿‡ä¸€äº›å‚æ•°å¦‚ X-Forward-For æ¥å¾—çŸ¥çˆ¬è™«æœºæœ¬èº«çš„ IP äº†ï¼Œé…ç½®æ–‡ä»¶æ·»åŠ </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request_header_access Via deny all</span><br><span class="line">request_header_access X-Forwarded-For deny all</span><br></pre></td></tr></table></figure>

<p>äº‘ä¸»æœºå‚å•†å¯èƒ½é»˜è®¤å°ç¦äº† Squid çš„ 3128 ç«¯å£ï¼Œæ›´æ¢ç«¯å£</p>
<p><code>http_port 3128</code> ä¿®æ”¹ä¸º <code>http_port 3328</code></p>
<p>ä¿®æ”¹å®Œé…ç½®åä¿å­˜ï¼Œé‡å¯ Squid </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart squid</span><br></pre></td></tr></table></figure>

<p>è¿˜éœ€è¦å®å¡”é¢æ¿æˆ–è€…å‘½ä»¤å¼€æ”¾3328é˜²ç«å¢™ç«¯å£</p>
<p>äº‘ä¸»æœºä¸Šè¿è¡Œ curl å‘½ä»¤æµ‹è¯• Squid çš„ä»£ç†æ•ˆæœ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -x http:&#x2F;&#x2F;127.0.0.1:3328 https:&#x2F;&#x2F;httpbin.org&#x2F;get</span><br><span class="line">ifconfig</span><br></pre></td></tr></table></figure>

<p>è¿”å› origin å­—æ®µ IP 106.45.104.166 å’Œ ifconfig è¿”å›çš„äº‘ä¸»æœº IP ä¸€è‡´</p>
<p>æœ¬æœºè¿è¡Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -x http:&#x2F;&#x2F;106.45.104.166:3328 https:&#x2F;&#x2F;httpbin.org&#x2F;get</span><br></pre></td></tr></table></figure>

<p>è¿”å›ç»“æœçœ‹åˆ° origin å­—æ®µè¿”å›åœ°å€å°±æ˜¯äº‘ä¸»æœº IPåœ°å€äº†</p>
<h5 id="å­˜å‚¨æ¨¡å—-1"><a href="#å­˜å‚¨æ¨¡å—-1" class="headerlink" title="å­˜å‚¨æ¨¡å—"></a>å­˜å‚¨æ¨¡å—</h5><p>é…ç½®ä¸€ä¸ªå¯ä»¥å…¬ç½‘è®¿é—®çš„ Redis æ•°æ®åº“ï¼Œäº‘ä¸»æœºå¯ä»¥å°†è‡ªå·±çš„ä»£ç†å­˜å‚¨åˆ°å¯¹åº”çš„ Redis æ•°æ®åº“ä¸­</p>
<p>äº‘ä¸»æœºè¦è¿›è¡Œ Redis æ•°æ®åº“çš„æ“ä½œï¼Œå¯ä»¥ä½¿ç”¨ Python å®ç°ï¼Œå…ˆåœ¨äº‘ä¸»æœºä¸Šè£… Python</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install python3</span><br></pre></td></tr></table></figure>

<p>è‡ªåŠ¨æ‹¨å·ã€è¿æ¥ Redis æ•°æ®åº“ã€è·å–æœ¬æœºä»£ç†ã€è®¾ç½® Redis æ•°æ®åº“çš„æ“ä½œ</p>
<p>ä½¿ç”¨ adslproxy åŒ…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install adslproxy</span><br></pre></td></tr></table></figure>

<p>å®‰è£…å®Œæˆåä½¿ç”¨ export è®¾ç½®ç¯å¢ƒå˜é‡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">export REDIS_HOST&#x3D;&lt;Redisæ•°æ®åº“çš„åœ°å€&gt;</span><br><span class="line">export REDIS_PORT&#x3D;&lt;Redisæ•°æ®åº“çš„ç«¯å£&gt;</span><br><span class="line">export REDIS_PASSWORD&#x3D;&lt;Redisæ•°æ®åº“çš„å¯†ç &gt;</span><br><span class="line">export PROXY_PORT&#x3D;&lt;æ‹¨å·äº‘ä¸»æœºé…ç½®çš„ä»£ç†ç«¯å£&gt;</span><br><span class="line">export DIAL_BASH&#x3D;&lt;æ‹¨å·è„šæœ¬&gt; #pppoe-stop;pppoe-start</span><br><span class="line">export DIAL_IFNAME&#x3D;&lt;ç½‘å¡åç§°&gt; #ppp0</span><br><span class="line">export CLIENT_NAME&#x3D;&lt;äº‘ä¸»æœºçš„å”¯ä¸€æ ‡è¯†&gt;</span><br><span class="line">export DIAL_CYCLE&#x3D;&lt;æ‹¨å·é—´éš”&gt;</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œ <code>adslproxy send</code> æ‹¨å·</p>
<h5 id="æ‹¨å·æ¨¡å—"><a href="#æ‹¨å·æ¨¡å—" class="headerlink" title="æ‹¨å·æ¨¡å—"></a>æ‹¨å·æ¨¡å—</h5><p>å®šæ—¶æ‹¨å·</p>
<p>åªéœ€è¦åœ¨æ‹¨å·ä¸»æœºä¸Šè¿è¡Œå®šæ—¶è„šæœ¬ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´æ‹¨å·ä¸€æ¬¡ï¼Œæ›´æ–° IPï¼Œç„¶åå°† IP åœ¨ Redis  æ•£åˆ—è¡¨ä¸­æ›´æ–°å³å¯</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯è·å–IPï¼Œè·å–æ‹¨å·åçš„ IPï¼Œåªéœ€è¦ ifconfig å‘½ä»¤ï¼Œè§£æå‡ºå¯¹åº”ç½‘å¡çš„ IP</p>
<p>è·å– IP ä¹‹åï¼Œè¿˜éœ€è¦è¿›è¡Œæœ‰æ•ˆæ€§æ£€æµ‹ã€‚æ‹¨å·ä¸»æœºå¯ä»¥è‡ªå·±æ£€æµ‹ï¼Œæ¯”å¦‚å¯ä»¥åˆ©ç”¨ requests è®¾ç½®è‡ªèº«çš„ä»£ç†è¯·æ±‚å¤–ç½‘ï¼Œå¦‚æœæˆåŠŸï¼Œé‚£ä¹ˆè¯æ˜ä»£ç†å¯ç”¨ï¼Œç„¶åå†ä¿®æ”¹ Redis æ•£åˆ—è¡¨ï¼Œæ›´æ–°ä»£ç†</p>
<p>æ‹¨å·åä¸»æœºæ˜¯ç¦»çº¿çŠ¶æ€ï¼ŒRedis æ•£åˆ—è¡¨ä¸­è¿˜å­˜ç•™ä¸Šæ¬¡çš„ä»£ç†ï¼Œè¿™ä»£ç†æ˜¯æ— æ³•ä½¿ç”¨çš„ï¼Œæ¯å°ä¸»æœºåœ¨æ‹¨å·ä¹‹å‰è¿˜éœ€è¦å°†è‡ªèº«çš„ä»£ç†ä» Redis æ•£åˆ—è¡¨ä¸­ç§»é™¤</p>
<h5 id="æ¥å£æ¨¡å—-1"><a href="#æ¥å£æ¨¡å—-1" class="headerlink" title="æ¥å£æ¨¡å—"></a>æ¥å£æ¨¡å—</h5><p>åˆ©ç”¨ Tornado çš„Serveræ¨¡å—æ­å»º Web æ¥å£æœåŠ¡</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/19/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-Scrapy%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="ç®€å•è®°å½•ä¸‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/19/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-Scrapy%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-Scrapyæ¡†æ¶ä½¿ç”¨</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-04-19 22:00:23" itemprop="dateCreated datePublished" datetime="2022-04-19T22:00:23+08:00">2022-04-19</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-04-24 09:30:18" itemprop="dateModified" datetime="2022-04-24T09:30:18+08:00">2022-04-24</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Scrapy åŠŸèƒ½éå¸¸å¼ºå¤§ï¼Œçˆ¬å–æ•ˆç‡é«˜ï¼Œç›¸å…³æ‰©å±•ç»„ä»¶å¤šï¼Œå¯é…ç½®å’Œå¯æ‰©å±•ç¨‹åº¦éå¸¸é«˜ï¼Œå‡ ä¹å¯ä»¥åº”å¯¹æ‰€æœ‰åçˆ¬ç½‘ç«™ï¼Œæ˜¯ç›®å‰Pythonä¸­ä½¿ç”¨æœ€å¹¿æ³›çš„çˆ¬è™«æ¡†æ¶</p>
<p>å®˜æ–¹æ–‡æ¡£ <a target="_blank" rel="noopener" href="https://doc.scrapy.org/en/latest/index.html">https://doc.scrapy.org/en/latest/index.html</a></p>
<h4 id="Scrapy"><a href="#Scrapy" class="headerlink" title="Scrapy"></a>Scrapy</h4><h5 id="åˆ›å»ºé¡¹ç›®"><a href="#åˆ›å»ºé¡¹ç›®" class="headerlink" title="åˆ›å»ºé¡¹ç›®"></a>åˆ›å»ºé¡¹ç›®</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy startproject tutorial</span><br></pre></td></tr></table></figure>

<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-Scrapy%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/WeChatf2beb120c54835739c5d7653fc0fc630.png" alt="WeChatf2beb120c54835739c5d7653fc0fc630"></p>
<p>scrapy.cfgï¼šScrapy é¡¹ç›®çš„é…ç½®æ–‡ä»¶ï¼Œå®šä¹‰äº†é¡¹ç›®é…ç½®æ–‡ä»¶è·¯å¾„ã€éƒ¨ç½²ç›¸å…³ä¿¡æ¯ç­‰å†…å®¹ï¼ŒScrapy éƒ¨ç½²æ—¶çš„é…ç½®æ–‡ä»¶</p>
<p>items.pyï¼šå®šä¹‰ Item æ•°æ®ç»“æ„ï¼Œæ‰€æœ‰çš„ Item çš„å®šä¹‰éƒ½å¯ä»¥æ”¾è¿™é‡Œï¼Œå®šä¹‰çˆ¬å–çš„æ•°æ®ç»“æ„</p>
<p>pipelines.pyï¼šå®šä¹‰ Item Pipeline çš„å®ç°ï¼Œæ‰€æœ‰ Item Pipeline çš„å®ç°éƒ½å¯ä»¥æ”¾è¿™é‡Œï¼Œå®šä¹‰æ•°æ®ç®¡é“</p>
<p>settings.pyï¼šå®šä¹‰é¡¹ç›®çš„å…¨å±€é…ç½®ï¼Œé…ç½®æ–‡ä»¶</p>
<p>middlewares.pyï¼šå®šä¹‰ Spider Middlewares å’Œ Downloader Middlewares çš„å®ç°ï¼Œçˆ¬å–æ—¶çš„ä¸­é—´ä»¶</p>
<p>spidersï¼šå…¶å†…åŒ…å«ä¸€ä¸ªä¸ª Spider çš„å®ç°ï¼Œæ¯ä¸ª Spider éƒ½æœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œæ”¾ç½® Spiders çš„æ–‡ä»¶å¤¹</p>
<h5 id="åˆ›å»º-Spider"><a href="#åˆ›å»º-Spider" class="headerlink" title="åˆ›å»º Spider"></a>åˆ›å»º Spider</h5><p>Spider æ˜¯è‡ªå·±å®šä¹‰çš„ç±»ï¼ŒScrapy ç”¨å®ƒæ¥ä»ç½‘é¡µæŠ“å–å†…å®¹ï¼Œå¹¶è§£ææŠ“å–çš„ç»“æœï¼Œä¸è¿‡è¿™ä¸ªç±»å¿…é¡»ç»§æ‰¿ Scrapy æä¾›çš„ Spider ç±» scrapy.Spiderï¼Œè¿˜è¦å®šä¹‰ Spider çš„åç§°å’Œèµ·å§‹è¯·æ±‚ï¼Œä»¥åŠæ€æ ·å¤„ç†çˆ¬å–åçš„ç»“æœçš„æ–¹æ³•</p>
<p>å‘½ä»¤è¡Œåˆ›å»ºä¸€ä¸ª Spiderï¼Œç”Ÿæˆ Quotes è¿™ä¸ª Spider</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd tutorial</span><br><span class="line">scrapy genspider quotes quotes.toscrape.com</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œ genspider å‘½ä»¤ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ Spider åç§°ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ç½‘ç«™åŸŸå</p>
<p>æ‰§è¡Œå®Œæ¯•åï¼Œspiders æ–‡ä»¶å¤¹ä¸­å¤šäº†ä¸€ä¸ª quotes.py</p>
<p>å†…å®¹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QuotesSpider</span>(<span class="params">scrapy.Spider</span>):</span></span><br><span class="line">    name = <span class="string">&#x27;quotes&#x27;</span></span><br><span class="line">    allowed_domains = [<span class="string">&#x27;quotes.toscrape.com&#x27;</span>]</span><br><span class="line">    start_urls = [<span class="string">&#x27;http://quotes.toscrape.com/&#x27;</span>]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>name æ¯ä¸ªé¡¹ç›®å”¯ä¸€çš„åå­—ï¼ŒåŒºåˆ†ä¸åŒçš„Spider</p>
<p>allowed_domains å…è®¸çˆ¬å–çš„åŸŸåï¼Œå¦‚æœåˆå§‹æˆ–åç»­çš„è¯·æ±‚é“¾æ¥ä¸åœ¨è¿™ä¸ªåŸŸåä¸‹çš„ï¼Œåˆ™è¯·æ±‚é“¾æ¥ä¼šè¢«è¿‡æ»¤</p>
<p>start_urlsï¼ŒåŒ…å«äº†Spideråœ¨å¯åŠ¨æ—¶çˆ¬å–çš„urlåˆ—è¡¨ï¼Œåˆå§‹è¯·æ±‚æ˜¯ç”±å®ƒæ¥å®šä¹‰çš„</p>
<p>parse æ˜¯ Spider çš„ä¸€ä¸ªæ–¹æ³•ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè¢«è°ƒç”¨æ—¶ start_urls é‡Œé¢çš„é“¾æ¥æ„æˆçš„è¯·æ±‚å®Œæˆä¸‹è½½æ‰§è¡Œåï¼Œè¿”å›çš„å“åº”ä¼šä½œä¸ºå”¯ä¸€çš„å‚æ•°ä¼ é€’ç»™è¿™ä¸ªå‡½æ•°ï¼Œè¯¥æ–¹æ³•è§£æè¿”å›çš„å“åº”ã€æå–æ•°æ®æˆ–è€…è¿›ä¸€æ­¥ç”Ÿæˆè¦å¤„ç†çš„è¯·æ±‚</p>
<h5 id="åˆ›å»º-Item"><a href="#åˆ›å»º-Item" class="headerlink" title="åˆ›å»º Item"></a>åˆ›å»º Item</h5><p>Item æ˜¯ä¿å­˜çˆ¬å–æ•°æ®çš„å®¹å™¨ï¼Œä½¿ç”¨æ–¹æ³•å’Œå­—å…¸ç±»ä¼¼</p>
<p>åˆ›å»º Item éœ€è¦ç»§æ‰¿ scrapy.Item ç±»ï¼Œå¹¶ä¸”å®šä¹‰ç±»å‹ä¸º scrapy.Field çš„å­—æ®µ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QuoteItem</span>(<span class="params">scrapy.Item</span>):</span></span><br><span class="line">    <span class="comment"># define the fields for your item here like:</span></span><br><span class="line">    text = scrapy.Field()</span><br><span class="line">    author = scrapy.Field()</span><br><span class="line">    tags = scrapy.Field()</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h5 id="è§£æ-Response"><a href="#è§£æ-Response" class="headerlink" title="è§£æ Response"></a>è§£æ Response</h5><p>parse() æ–¹æ³•çš„å‚æ•° response æ˜¯ start_urls é‡Œé¢çš„é“¾æ¥çˆ¬å–åçš„ç»“æœï¼Œæ‰€ä»¥åœ¨ parse() æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å¯¹ response å˜é‡åŒ…å«çš„å†…å®¹è¿›è¡Œè§£æ</p>
<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-Scrapy%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/WeChatb6f074004233d523d5e359e02e4ffb4e.png" alt="WeChatb6f074004233d523d5e359e02e4ffb4e"></p>
<p>ç½‘é¡µç»“æ„ä¸­æ¯ä¸€é¡µéƒ½æœ‰å¤šä¸ª class ä¸º quote çš„åŒºå—ï¼Œæ¯ä¸ªåŒºå—éƒ½åŒ…å« textã€authorã€tagsï¼Œéœ€è¦å…ˆæ‰¾å‡ºæ‰€æœ‰çš„ quoteï¼Œç„¶åæå–æ¯ä¸€ä¸ª quote ä¸­çš„å†…å®¹</p>
<p>æå–æ–¹å¼å¯ä»¥æ˜¯ CSS é€‰æ‹©å™¨æˆ–XPath é€‰æ‹©å™¨</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;quote&quot;</span> <span class="attr">itemscope</span>=<span class="string">&quot;&quot;</span> <span class="attr">itemtype</span>=<span class="string">&quot;http://schema.org/CreativeWork&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;text&quot;</span> <span class="attr">itemprop</span>=<span class="string">&quot;text&quot;</span>&gt;</span>â€œThe world as we have ....â€<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>by <span class="tag">&lt;<span class="name">small</span> <span class="attr">class</span>=<span class="string">&quot;author&quot;</span> <span class="attr">itemprop</span>=<span class="string">&quot;author&quot;</span>&gt;</span>Albert Einstein<span class="tag">&lt;/<span class="name">small</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/author/Albert-Einstein&quot;</span>&gt;</span>(about)<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;tags&quot;</span>&gt;</span></span><br><span class="line">        Tags:</span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">class</span>=<span class="string">&quot;keywords&quot;</span> <span class="attr">itemprop</span>=<span class="string">&quot;keywords&quot;</span> <span class="attr">content</span>=<span class="string">&quot;change,deep-thoughts,thinking,world&quot;</span>&gt;</span> </span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;tag&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/tag/change/page/1/&quot;</span>&gt;</span>change<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;tag&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/tag/deep-thoughts/page/1/&quot;</span>&gt;</span>deep-thoughts<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;tag&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/tag/thinking/page/1/&quot;</span>&gt;</span>thinking<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;tag&quot;</span> <span class="attr">href</span>=<span class="string">&quot;/tag/world/page/1/&quot;</span>&gt;</span>world<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">    quotes = response.css(<span class="string">&#x27;.quote&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> quote <span class="keyword">in</span> quotes:</span><br><span class="line">        text = quote.css(<span class="string">&#x27;.text::text&#x27;</span>).extract_first()</span><br><span class="line">        autnor = quote.css(<span class="string">&#x27;.author::text&#x27;</span>).extract_first()</span><br><span class="line">        tags = quote.css(<span class="string">&#x27;.tags .tag::text&#x27;</span>).extract()</span><br></pre></td></tr></table></figure>

<p>å…ˆåˆ©ç”¨é€‰æ‹©å™¨é€‰å–æ‰€æœ‰çš„ quoteï¼Œå¹¶å°†å…¶èµ‹å€¼ä¸º quotes å˜é‡ï¼Œç„¶ååˆ©ç”¨ for å¾ªç¯å¯¹æ¯ä¸ª quote éå†ï¼Œè§£ææ¯ä¸ª quote å†…å®¹</p>
<p>å¯¹ text æ¥è¯´ï¼Œå®ƒçš„ class ä¸º textï¼Œæ‰€ä»¥ç”¨ .text é€‰æ‹©å™¨æ¥é€‰å–ï¼Œè¿™ä¸ªç»“æœå®é™…ä¸Šæ˜¯æ•´ä¸ªå¸¦æœ‰æ ‡ç­¾çš„èŠ‚ç‚¹ï¼Œè¦è·å–æ­£æ–‡å†…å®¹ï¼Œå¯ä»¥åŠ  ::text æ¥è·å–ï¼Œè¿™æ—¶çš„ç»“æœæ˜¯é•¿åº¦ä¸º 1 çš„åˆ—è¡¨ï¼Œæ‰€ä»¥è¦ç”¨ extract_first() æ–¹æ³•æ¥è·å–ç¬¬ä¸€ä¸ªå…ƒç´ ï¼›å¯¹ tags æ¥è¯´ï¼Œç”±äºæˆ‘ä»¬è¦è·å–æ‰€æœ‰çš„æ ‡ç­¾ï¼Œæ‰€ä»¥ç”¨ extract() æ–¹æ³•è·å–æ•´ä¸ªåˆ—è¡¨å³å¯</p>
<h5 id="ä½¿ç”¨-Item"><a href="#ä½¿ç”¨-Item" class="headerlink" title="ä½¿ç”¨ Item"></a>ä½¿ç”¨ Item</h5><p>è§£æç»“æœèµ‹å€¼ Item çš„æ¯ä¸€ä¸ªå­—æ®µ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> tutorial.items <span class="keyword">import</span> QuoteItem</span><br><span class="line">...</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">      quotes = response.css(<span class="string">&#x27;.quote&#x27;</span>)</span><br><span class="line">      <span class="keyword">for</span> quote <span class="keyword">in</span> quotes:</span><br><span class="line">          item = QuoteItem()</span><br><span class="line">          item[<span class="string">&#x27;text&#x27;</span>] = quote.css(<span class="string">&#x27;.text::text&#x27;</span>).extract_first()</span><br><span class="line">          item[<span class="string">&#x27;autnor&#x27;</span>] = quote.css(<span class="string">&#x27;.author::text&#x27;</span>).extract_first()</span><br><span class="line">          item[<span class="string">&#x27;tags&#x27;</span>] = quote.css(<span class="string">&#x27;.tags .tag::text&#x27;</span>).extract()</span><br><span class="line">          <span class="keyword">yield</span> item</span><br></pre></td></tr></table></figure>

<h5 id="åç»­-Request"><a href="#åç»­-Request" class="headerlink" title="åç»­ Request"></a>åç»­ Request</h5><p>ä¸Šé¢æ“ä½œå®ç°äº†ä»åˆå§‹é¡µé¢æŠ“å–å†…å®¹ï¼Œä¸‹ä¸€é¡µçš„å†…å®¹éœ€è¦ä»å½“å‰é¡µé¢ä¸­æ‰¾åˆ°ä¿¡æ¯æ¥ç”Ÿæˆä¸‹ä¸€ä¸ªè¯·æ±‚</p>
<p>æ‹‰å–é¡µé¢åˆ°åº•éƒ¨æœ‰ä¸ª Next æŒ‰é’®ï¼ŒæŸ¥çœ‹æºç ï¼Œå®ƒçš„é“¾æ¥æ˜¯ /page/2/ å…¨é“¾æ¥æ˜¯ <a target="_blank" rel="noopener" href="http://quotes.toscrape.com/page/2">http://quotes.toscrape.com/page/2</a> ï¼Œé€šè¿‡è¿™ä¸ªé“¾æ¥å¯ä»¥æ„é€ ä¸‹ä¸€ä¸ªè¯·æ±‚</p>
<p>æ„é€ è¯·æ±‚æ—¶éœ€è¦ç”¨åˆ° scrapy.Requestï¼Œä¼ é€’ä¸¤ä¸ªå‚æ•° url å’Œ callback</p>
<p>urlï¼šè¯·æ±‚é“¾æ¥</p>
<p>callbackï¼šå›è°ƒå‡½æ•°ï¼Œä¼šå°†è¯·æ±‚çš„å“åº”ä½œä¸ºå‚æ•°ä¼ é€’ç»™è¿™ä¸ªå›è°ƒå‡½æ•°ï¼Œå›è°ƒå‡½æ•°è¿›è¡Œè§£ææˆ–ç”Ÿæˆä¸‹ä¸€ä¸ªè¯·æ±‚</p>
<p>ä¿®æ”¹åå®Œæ•´ Spider ç±»</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">from</span> tutorial.items <span class="keyword">import</span> QuoteItem</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QuotesSpider</span>(<span class="params">scrapy.Spider</span>):</span></span><br><span class="line">  name = <span class="string">&#x27;quotes&#x27;</span></span><br><span class="line">  allowed_domains = [<span class="string">&#x27;quotes.toscrape.com&#x27;</span>]</span><br><span class="line">  start_urls = [<span class="string">&#x27;http://quotes.toscrape.com/&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">      quotes = response.css(<span class="string">&#x27;.quote&#x27;</span>)</span><br><span class="line">      <span class="keyword">for</span> quote <span class="keyword">in</span> quotes:</span><br><span class="line">          item = QuoteItem()</span><br><span class="line">          item[<span class="string">&#x27;text&#x27;</span>] = quote.css(<span class="string">&#x27;.text::text&#x27;</span>).extract_first()</span><br><span class="line">          item[<span class="string">&#x27;autnor&#x27;</span>] = quote.css(<span class="string">&#x27;.author::text&#x27;</span>).extract_first()</span><br><span class="line">          item[<span class="string">&#x27;tags&#x27;</span>] = quote.css(<span class="string">&#x27;.tags .tag::text&#x27;</span>).extract()</span><br><span class="line">          <span class="keyword">yield</span> item</span><br><span class="line">      <span class="comment">#åˆ©ç”¨é€‰æ‹©å™¨ç”Ÿæˆä¸‹ä¸€é¡µçš„è¯·æ±‚</span></span><br><span class="line">      <span class="built_in">next</span> = response.css(<span class="string">&#x27;.pager .next a::attr(&quot;href&quot;)&#x27;</span>).extract_first()</span><br><span class="line">      <span class="comment">#urljoin()æ–¹æ³•å¯ä»¥å°†ç›¸å¯¹URLæ„é€ æˆä¸€ä¸ªç»å¯¹çš„URL</span></span><br><span class="line">      url = response.urljoin(<span class="built_in">next</span>)</span><br><span class="line">      <span class="comment">#è¿”å›ä¸‹ä¸€é¡µè¯·æ±‚</span></span><br><span class="line">      <span class="keyword">yield</span>  scrapy.Request(url=url, callback=self.parse)</span><br></pre></td></tr></table></figure>

<h5 id="è¿è¡Œ"><a href="#è¿è¡Œ" class="headerlink" title="è¿è¡Œ"></a>è¿è¡Œ</h5><p>è¿›å…¥ç›®å½•è¿è¡Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy crawl quotes</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œå Scrapy è¾“å‡ºå½“å‰çš„ç‰ˆæœ¬å·åŠæ­£åœ¨å¯åŠ¨é¡¹ç›®åç§°ã€settings.py  ä¸­ä¸€äº›é‡å†™åçš„é…ç½®ã€Middlewaresã€Pipelines</p>
<p>æ¥ä¸‹æ¥å°±è¾“å‡ºå„ä¸ªé¡µé¢çš„æŠ“å–ç»“æœäº†</p>
<p>æœ€åè¾“å‡ºæ•´ä¸ªæŠ“å–è¿‡ç¨‹çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œè¯·æ±‚å­—èŠ‚æ•°ã€è¯·æ±‚æ¬¡æ•°ã€å“åº”æ¬¡æ•°ã€å®ŒæˆåŸå› ç­‰</p>
<h5 id="ä¿å­˜åˆ°æ–‡ä»¶"><a href="#ä¿å­˜åˆ°æ–‡ä»¶" class="headerlink" title="ä¿å­˜åˆ°æ–‡ä»¶"></a>ä¿å­˜åˆ°æ–‡ä»¶</h5><p>Scrapy æä¾›çš„ Feed Exports å¯ä»¥å°†ç»“æœè¾“å‡ºï¼Œå¦‚æƒ³å°†ä¸Šé¢ç»“æœä¿å­˜æˆ JSON æ–‡ä»¶</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy crawl quotes -o quotes.json</span><br></pre></td></tr></table></figure>

<p>è¿˜å¯ä»¥æ¯ä¸€ä¸ª Item è¾“å‡ºä¸€è¡Œ JSONï¼Œè¾“å‡ºåç¼€ä¸º jlï¼Œä¸º jsonline çš„ç¼©å†™</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scrapy crawl quotes -o quotes.jl</span><br><span class="line">æˆ–è€… </span><br><span class="line">scrapy crawl quotes -o quotes.jsonline</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºæ ¼å¼è¿˜æ”¯æŒå¾ˆå¤šç§ï¼Œå¦‚ csvã€xmlã€pickleã€marshal ç­‰ï¼Œè¿˜æ”¯æŒ ftpã€s3ç­‰è¿œç¨‹è¾“å‡ºï¼Œè¿˜å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ ItemExporter æ¥å®ç°å…¶ä»–çš„è¾“å‡º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">scrapy crawl quotes -o quotes.csv</span><br><span class="line">scrapy crawl quotes -o quotes.xml</span><br><span class="line">scrapy crawl quotes -o quotes.pickle</span><br><span class="line">scrapy crawl quotes -o quotes.marshal</span><br><span class="line">scrapy crawl quotes -o ftp:&#x2F;&#x2F;user:pass@ftp.example.com&#x2F;path&#x2F;to&#x2F;quotes.csv</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ Scrapy æä¾›çš„ FeedExportsï¼Œå¯ä»¥è½»æ¾çš„è¾“å‡ºæŠ“å–ç»“æœåˆ°æ–‡ä»¶ï¼Œæƒ³è¦æ›´å¤æ‚çš„è¾“å‡ºï¼Œå¦‚è¾“å‡ºåˆ°æ•°æ®åº“ï¼Œå¯ä»¥ä½¿ç”¨ ItemPileline æ¥å®Œæˆ</p>
<h5 id="ä½¿ç”¨-Item-Pipeline"><a href="#ä½¿ç”¨-Item-Pipeline" class="headerlink" title="ä½¿ç”¨ Item Pipeline"></a>ä½¿ç”¨ Item Pipeline</h5><p>Item Pipeline ä¸ºé¡¹ç›®ç®¡é“ï¼ŒItem ç”Ÿæˆåï¼Œå®ƒä¼šè‡ªåŠ¨è¢«é€åˆ° Item Pipeline è¿›è¡Œå¤„ç†ï¼Œå¸¸ç”¨ Item Pipeline æ¥åšå¦‚ä¸‹æ“ä½œ</p>
<p>æ¸…ç† HTML æ•°æ®ã€éªŒè¯çˆ¬å–æ•°æ®ï¼Œæ£€æŸ¥çˆ¬å–å­—æ®µã€æŸ¥é‡å¹¶ä¸¢å¼ƒé‡å¤å†…å®¹ã€å°†çˆ¬å–ç»“æœä¿å­˜åˆ°æ•°æ®åº“</p>
<p>è¦å®ç° Item Pipelineï¼Œåªéœ€è¦å®šä¹‰ä¸€ä¸ªç±»å¹¶å®ç° process_item() æ–¹æ³•ï¼Œå¯ç”¨ Item Pipeline åï¼ŒItem Pipeline ä¼šè‡ªåŠ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œprocess_item() æ–¹æ³•å¿…é¡»è¿”å›åŒ…å«æ•°æ®çš„å­—å…¸æˆ– Item å¯¹è±¡æˆ–è€…æŠ›å‡º DropItem å¼‚å¸¸</p>
<p>process_item() æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªå‚æ•°æ˜¯ itemï¼Œæ¯æ¬¡ Spider ç”Ÿæˆçš„ Item éƒ½ä¼šä½œä¸ºå‚æ•°ä¼ é€’è¿‡æ¥ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ Spiderï¼Œå°±æ˜¯ Spider çš„å®ä¾‹</p>
<p>å®ç° Item Pipelineï¼Œç­›æ‰ text é•¿åº¦å¤§äº 50 çš„Itemï¼Œå¹¶å°†ç»“æœä¿å­˜åˆ° MongoDB</p>
<p>ä¿®æ”¹é¡¹ç›®é‡Œçš„ pipelines.py æ–‡ä»¶</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.exceptions <span class="keyword">import</span> DropItem</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextPipeline</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">      self.limit = <span class="number">50</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">process_item</span>(<span class="params">self, item, spider</span>):</span></span><br><span class="line">      <span class="keyword">if</span> item[<span class="string">&#x27;text&#x27;</span>]:</span><br><span class="line">          <span class="keyword">if</span> <span class="built_in">len</span>(item[<span class="string">&#x27;text&#x27;</span>] &gt; self.limit):</span><br><span class="line">              <span class="comment">#æˆªæ–­åæ‹¼çœç•¥å·è¿”å›</span></span><br><span class="line">              item[<span class="string">&#x27;text&#x27;</span>] = item[<span class="string">&#x27;text&#x27;</span>][<span class="number">0</span>:self.limit].rstrip() + <span class="string">&#x27;...&#x27;</span></span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">          <span class="keyword">return</span> DropItem(<span class="string">&#x27;Missing Text&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥å°†å¤„ç†åçš„ item å­˜å…¥ MongoDBï¼Œå®šä¹‰å¦å¤–ä¸€ä¸ª Pipelineï¼ŒMongoPipeline</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymongo</span><br><span class="line"><span class="keyword">from</span> scrapy.exceptions <span class="keyword">import</span> DropItem</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MongoPipeline</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, mongo_uri, mongo_db</span>):</span></span><br><span class="line">      self.mongo_uri = mongo_uri</span><br><span class="line">      self.mongo_db = mongo_db</span><br><span class="line"><span class="meta">  @classmethod</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">from_crawler</span>(<span class="params">cls, crawler</span>):</span></span><br><span class="line">      <span class="keyword">return</span> cls(</span><br><span class="line">          mongo_uri=crawler.settings.get(<span class="string">&#x27;MONGO_URI&#x27;</span>),</span><br><span class="line">          mongo_db=crawler.settings.get(<span class="string">&#x27;MONGODB_DATABASE&#x27;</span>)</span><br><span class="line">      )</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">open_spider</span>(<span class="params">self, spider</span>):</span></span><br><span class="line">      self.cline = pymongo.MongoClient(self.mongo_uri)</span><br><span class="line">      self.db = self.cline[self.mongo_db]</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">process_item</span>(<span class="params">self, item, spider</span>):</span></span><br><span class="line">      name = item.__class__.__name__</span><br><span class="line">      self.db[name].insert(<span class="built_in">dict</span>(item))</span><br><span class="line">      <span class="keyword">return</span> item</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">close_spider</span>(<span class="params">self, spider</span>):</span></span><br><span class="line">      self.cline.close()</span><br></pre></td></tr></table></figure>

<p>MongoPipeline å®ç°äº†å¦å¤–å‡ ä¸ªæ–¹æ³•</p>
<p>from_crawlerï¼šæ˜¯ä¸€ä¸ªç±»æ–¹æ³•ï¼Œç”¨ @classmethod æ ‡è¯†ï¼Œæ˜¯ä¸€ç§ä¾èµ–æ³¨å…¥çš„æ–¹å¼ï¼Œå‚æ•°æ˜¯ crawlerï¼Œé€šè¿‡ crawler å¯ä»¥æ‹¿åˆ°å…¨å±€é…ç½®çš„æ¯ä¸ªé…ç½®ä¿¡æ¯ï¼Œå…¨å±€é…ç½® settings.py å®šä¹‰äº† MongoDB è¿æ¥éœ€è¦çš„åœ°å€å’Œæ•°æ®åº“åç§°ï¼Œæ‹¿åˆ°é…ç½®ä¿¡æ¯è¿”å›ç±»å¯¹è±¡å³å¯ï¼Œè¿™æ–¹æ³•ä¸»è¦ç”¨æ¥è·å– setting.py ä¸­çš„é…ç½®</p>
<p>open_spiderï¼šå½“ Spider å¼€å¯æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•è¢«è°ƒç”¨ï¼Œä¸Šé¢ç¨‹åºä¸­ä¸»è¦è¿›è¡Œäº†ä¸€äº›åˆå§‹åŒ–æ“ä½œ</p>
<p>close_spiderï¼šå½“ Spider å…³é—­æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•è¢«è°ƒç”¨ï¼Œä¸Šé¢ç¨‹åºä¸­å°†æ•°æ®åº“è¿æ¥å…³é—­</p>
<p>process_item() æ–¹æ³•åˆ™æ‰§è¡Œäº†æ•°æ®åº“æ’å…¥æ“ä½œ</p>
<p>å®šä¹‰å¥½äº† TextPipeline å’Œ MongoPipeline ä¸¤ä¸ªç±»åï¼Œéœ€è¦åœ¨ settings.py ä¸­ä½¿ç”¨ä»–ä»¬ï¼ŒMongoDB çš„è¿æ¥ä¿¡æ¯è¿˜éœ€è¦å®šä¹‰</p>
<p>settings.py ä¸­åŠ å…¥</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">TIME_PIPELINES = &#123;</span><br><span class="line">	<span class="string">&#x27;tutorial.pipelines.TextPipeline&#x27;</span>: <span class="number">300</span>,</span><br><span class="line">	<span class="string">&#x27;tutorial.pipelines.MongoPipeline&#x27;</span>: <span class="number">400</span></span><br><span class="line">&#125;</span><br><span class="line">MONGO_URI = <span class="string">&#x27;localhost&#x27;</span></span><br><span class="line">MONGO_DB = <span class="string">&#x27;tutorial&#x27;</span></span><br></pre></td></tr></table></figure>

<p>èµ‹å€¼ TIME_PIPELINES å­—å…¸ï¼Œé”®åæ˜¯ Pipeline çš„ç±»åç§°ï¼Œé”®å€¼æ˜¯è°ƒç”¨ä¼˜å…ˆçº§ï¼Œæ˜¯ä¸€ä¸ªæ•°å­—ï¼Œæ•°å­—è¶Šå°åˆ™å¯¹åº” Pipeline è¶Šå…ˆè¢«è°ƒç”¨</p>
<p>é‡æ–°æ‰§è¡Œçˆ¬å–</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy crawl quotes</span><br></pre></td></tr></table></figure>

<h4 id="13-3-Selecotr-ç”¨æ³•"><a href="#13-3-Selecotr-ç”¨æ³•" class="headerlink" title="13.3 Selecotr ç”¨æ³•"></a>13.3 Selecotr ç”¨æ³•</h4><p>Scrapy è¿˜æä¾›äº†è‡ªå·±çš„æ•°æ®æå–æ–¹æ³•ï¼Œå³ Selectorï¼ŒSelector æ˜¯åŸºäº lxml æ¥æ„å»ºçš„ï¼Œæ”¯æŒ XPath é€‰æ‹©å™¨ã€CSS é€‰æ‹©å™¨ä»¥åŠæ­£åˆ™è¡¨è¾¾å¼</p>
<h5 id="ç›´æ¥ä½¿ç”¨"><a href="#ç›´æ¥ä½¿ç”¨" class="headerlink" title="ç›´æ¥ä½¿ç”¨"></a>ç›´æ¥ä½¿ç”¨</h5><p>Selector æ˜¯ä¸€ä¸ªå¯ä»¥ç‹¬ç«‹ä½¿ç”¨çš„æ¨¡å—ï¼Œå¯ä»¥åˆ©ç”¨ Selector æ¥æ„å»ºä¸€ä¸ªé€‰æ‹©å™¨å¯¹è±¡ï¼Œç„¶åè°ƒç”¨å®ƒçš„ç›¸å…³æ–¹æ³• å¦‚</p>
<p>xpath()ã€css() ç­‰æ¥æå–æ•°æ®</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy <span class="keyword">import</span> Selector</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  body = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  &lt;html&gt;</span></span><br><span class="line"><span class="string">      &lt;head&gt;</span></span><br><span class="line"><span class="string">          &lt;title&gt;Hello World&lt;/title&gt;</span></span><br><span class="line"><span class="string">      &lt;/head&gt;</span></span><br><span class="line"><span class="string">  &lt;/html&gt;</span></span><br><span class="line"><span class="string">  &#x27;&#x27;&#x27;</span></span><br><span class="line">  selector = Selector(text=body)</span><br><span class="line">  title = selector.xpath(<span class="string">&#x27;//title/text()&#x27;</span>).extract_first()</span><br><span class="line">  title1 = selector.xpath(<span class="string">&#x27;//title/text()&#x27;</span>).extract()</span><br><span class="line">  title2 = selector.xpath(<span class="string">&#x27;//title/text()&#x27;</span>)</span><br><span class="line">  print(title)</span><br><span class="line">  print(title1)</span><br><span class="line">  print(title2)</span><br><span class="line"><span class="comment">#Hello World</span></span><br><span class="line"><span class="comment">#[&#x27;Hello World&#x27;]</span></span><br><span class="line"><span class="comment">#[&lt;Selector xpath=&#x27;//title/text()&#x27; data=&#x27;Hello World&#x27;&gt;]</span></span><br></pre></td></tr></table></figure>

<h5 id="Scrapy-shell"><a href="#Scrapy-shell" class="headerlink" title="Scrapy shell"></a>Scrapy shell</h5><p>å€ŸåŠ© Scrapy shell æ¥æ¨¡æ‹Ÿ Scrapy è¯·æ±‚çš„è¿‡ç¨‹ ï¼Œè®²è§£ç›¸å…³çš„æå–æ–¹æ³•</p>
<p>å®˜æ–¹æ–‡æ¡£çš„æ ·ä¾‹æ¥åšæ¼”ç¤º <a target="_blank" rel="noopener" href="https://docs.scrapy.org/en/latest/_static/selectors-sample1.html">https://docs.scrapy.org/en/latest/_static/selectors-sample1.html</a></p>
<p>å¼€å¯ Scrapy shell</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy shell https:&#x2F;&#x2F;docs.scrapy.org&#x2F;en&#x2F;latest&#x2F;_static&#x2F;selectors-sample1.html</span><br></pre></td></tr></table></figure>

<p>å°±è¿›å…¥ Scrapy shell æ¨¡å¼ï¼Œè¿™è¿‡ç¨‹å…¶å®æ˜¯ Scrapy å‘èµ·äº†ä¸€æ¬¡è¯·æ±‚ï¼Œè¯·æ±‚çš„URLå°±æ˜¯å‘½ä»¤è¡Œä¸‹è¾“å…¥çš„ URLï¼Œç„¶åæŠŠä¸€äº›å¯æ“ä½œçš„å˜é‡ä¼ é€’ç»™æˆ‘ä»¬ï¼Œå¦‚requestã€response ç­‰</p>
<img src="Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-Scrapyæ¡†æ¶ä½¿ç”¨/WeChatae25474d863d90da3fe12abbc4a54da0.png" alt="WeChatae25474d863d90da3fe12abbc4a54da0" style="zoom:80%;" />

<p>å¯ä»¥åœ¨å‘½ä»¤æ¨¡å¼ä¸‹è¾“å…¥å‘½ä»¤è°ƒç”¨å¯¹è±¡çš„ä¸€äº›æ“ä½œæ–¹æ³•ï¼Œå›è½¦ä¹‹åå®æ—¶æ˜¾ç¤ºç»“æœ</p>
<p>æŸ¥çœ‹é¡µé¢æºç </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">&#x27;http://example.com/&#x27;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Example website<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&#x27;images&#x27;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;image1.html&#x27;</span>&gt;</span>Name: My image 1 <span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;image1_thumb.jpg&#x27;</span> /&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;image2.html&#x27;</span>&gt;</span>Name: My image 2 <span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;image2_thumb.jpg&#x27;</span> /&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;image3.html&#x27;</span>&gt;</span>Name: My image 3 <span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;image3_thumb.jpg&#x27;</span> /&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;image4.html&#x27;</span>&gt;</span>Name: My image 4 <span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;image4_thumb.jpg&#x27;</span> /&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;image5.html&#x27;</span>&gt;</span>Name: My image 5 <span class="tag">&lt;<span class="name">br</span> /&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#x27;image5_thumb.jpg&#x27;</span> /&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="XPath-é€‰æ‹©å™¨"><a href="#XPath-é€‰æ‹©å™¨" class="headerlink" title="XPath é€‰æ‹©å™¨"></a>XPath é€‰æ‹©å™¨</h5><p>è¿›å…¥ Scrapy shell ä¹‹åï¼Œæ“ä½œ response è¿™ä¸ªå˜é‡æ¥è¿›è¡Œåˆ†æ</p>
<p>response æœ‰ä¸€ä¸ªå±æ€§ selectorï¼Œè°ƒç”¨ response.selector è¿”å›çš„å†…å®¹å°±ç›¸å½“äºç”¨ response çš„body æ„é€ äº†ä¸€ä¸ª Selector å¯¹è±¡ï¼Œé€šè¿‡è¿™ä¸ª Selector å¯¹è±¡å¯ä»¥è°ƒç”¨è§£ææ–¹æ³•å¦‚ xpath()ã€css() ç­‰</p>
<ul>
<li>æŸ¥è¯¢åµŒå¥—æŸ¥è¯¢</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#ä»htmlæå–aèŠ‚ç‚¹</span><br><span class="line">&gt;&gt;&gt; result &#x3D; response.selector.xpath(&#39;&#x2F;&#x2F;a&#39;)</span><br><span class="line">&gt;&gt;&gt; result</span><br><span class="line">[&lt;Selector xpath&#x3D;&#39;&#x2F;&#x2F;a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image1.html&quot;&gt;Name: My image ...&#39;&gt;, </span><br><span class="line">&lt;Selector xpath&#x3D;&#39;&#x2F;&#x2F;a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image2.html&quot;&gt;Name: My image ...&#39;&gt;, </span><br><span class="line">&lt;Selector xpath&#x3D;&#39;&#x2F;&#x2F;a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image3.html&quot;&gt;Name: My image ...&#39;&gt;, </span><br><span class="line">&lt;Selector xpath&#x3D;&#39;&#x2F;&#x2F;a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image4.html&quot;&gt;Name: My image ...&#39;&gt;, </span><br><span class="line">&lt;Selector xpath&#x3D;&#39;&#x2F;&#x2F;a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image5.html&quot;&gt;Name: My image ...&#39;&gt;]</span><br><span class="line">#ä»aèŠ‚ç‚¹æå–imgèŠ‚ç‚¹</span><br><span class="line">&gt;&gt;&gt; result.xpath(&#39;.&#x2F;img&#39;)</span><br></pre></td></tr></table></figure>

<p>é€‰æ‹©å™¨å‰é¢åŠ  . (ç‚¹)ï¼Œä»£è¡¨æå–å…ƒç´ å†…éƒ¨çš„æ•°æ®ï¼Œæ²¡æœ‰åŠ ç‚¹åˆ™ä»£è¡¨ä»æ ¹èŠ‚ç‚¹å¼€å§‹æå–</p>
<ul>
<li>æå–å†…å®¹</li>
</ul>
<p>Scrapy æä¾›äº†ä¸¤ä¸ªä½¿ç”¨çš„å¿«æ·æ–¹æ³• </p>
<p>response.xpath() å’Œ response.css() åŠŸèƒ½ç­‰åŒäº response.selector.xpath() å’Œ response.selector.css()</p>
<p>ç°åœ¨å¾—åˆ°çš„æ˜¯ SelectorList ç±»å‹çš„å˜é‡ï¼Œè¯¥å˜é‡æ˜¯ç”± Selector å¯¹è±¡ç»„æˆçš„åˆ—è¡¨ï¼Œå¯ä»¥ç”¨ç´¢å¼•å•ç‹¬æå–å…¶ä¸­æŸä¸ª Selector å…ƒç´ </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; result[0]</span><br><span class="line">&lt;Selector xpath&#x3D;&#39;&#x2F;&#x2F;a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image1.html&quot;&gt;Name: My image ...&#39;&gt;</span><br></pre></td></tr></table></figure>

<p>æå–å†…å®¹ extract() æ–¹æ³•</p>
<p>åŠ ä¸€å±‚ /text() å°±å¯ä»¥è·å–èŠ‚ç‚¹çš„å†…éƒ¨æ–‡æœ¬ï¼Œæˆ–è€…åŠ ä¸€å±‚ /@href å°±å¯è·å–èŠ‚ç‚¹çš„ href å±æ€§ï¼Œ@ç¬¦å·åé¢å°±æ˜¯è¦è·å–çš„å±æ€§åç§°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; result.extract()</span><br><span class="line">&gt;&gt;&gt; response.xpath(&#39;&#x2F;&#x2F;a&#x2F;text()&#39;).extract()</span><br></pre></td></tr></table></figure>

<ul>
<li>æå–å•ä¸ªå…ƒç´  extract_first() ä¸ç”¨æ‹…å¿ƒæ•°ç»„è¶Šç•Œé—®é¢˜</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#å°†ç¬¬ä¸€ä¸ªåŒ¹é…ç»“æœå–å‡ºæ¥ extract_first()</span><br><span class="line">&gt;&gt;&gt; result.xpath(&#39;&#x2F;&#x2F;a[@href&#x3D;&quot;image1.html&quot;]&#x2F;text()&#39;).extract_first()</span><br></pre></td></tr></table></figure>

<ul>
<li>æå–ä¸åˆ°ä½¿ç”¨é»˜è®¤å€¼</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; result.xpath(&#39;&#x2F;&#x2F;a[@href&#x3D;&quot;image1.html&quot;]&#x2F;text()&#39;).extract_first(&#39;Default Image&#39;)</span><br><span class="line">#é»˜è®¤å€¼ Default Image</span><br></pre></td></tr></table></figure>

<h5 id="CSS-é€‰æ‹©å™¨"><a href="#CSS-é€‰æ‹©å™¨" class="headerlink" title="CSS é€‰æ‹©å™¨"></a>CSS é€‰æ‹©å™¨</h5><p>é€‰å– a èŠ‚ç‚¹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; response.css(&#39;a&#39;)</span><br><span class="line">[&lt;Selector xpath&#x3D;&#39;descendant-or-self::a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image1.html&quot;&gt;Name: My image ...&#39;&gt;, &lt;Selector xpath&#x3D;&#39;descendant-or-self::a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image2.html&quot;&gt;Name: My image ...&#39;&gt;, &lt;Selector xpath&#x3D;&#39;descendant-or-self::a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image3.html&quot;&gt;Name: My image ...&#39;&gt;, &lt;Selector xpath&#x3D;&#39;descendant-or-self::a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image4.html&quot;&gt;Name: My image ...&#39;&gt;, &lt;Selector xpath&#x3D;&#39;descendant-or-self::a&#39; data&#x3D;&#39;&lt;a href&#x3D;&quot;image5.html&quot;&gt;Name: My image ...&#39;&gt;]</span><br><span class="line">&gt;&gt;&gt; response.css(&#39;a&#39;).extract()</span><br><span class="line">&gt;&gt;&gt; response.css(&#39;a&#39;).extract_first()</span><br></pre></td></tr></table></figure>

<ul>
<li>å±æ€§é€‰æ‹©å’ŒåµŒå¥—é€‰æ‹©</li>
</ul>
<p>æŸ¥æ‰¾ a èŠ‚ç‚¹å†…éƒ¨ img èŠ‚ç‚¹ï¼Œåªéœ€è¦åŠ ä¸€ä¸ªç©ºæ ¼å’Œimg å³å¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; response.css(&#39;a[href&#x3D;&quot;image1.html&quot;]&#39;).extract()</span><br><span class="line">[&#39;&lt;a href&#x3D;&quot;image1.html&quot;&gt;Name: My image 1 &lt;br&gt;&lt;img src&#x3D;&quot;image1_thumb.jpg&quot;&gt;&lt;&#x2F;a&gt;&#39;]</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; response.css(&#39;a[href&#x3D;&quot;image1.html&quot;] img&#39;).extract()</span><br><span class="line">[&#39;&lt;img src&#x3D;&quot;image1_thumb.jpg&quot;&gt;&#39;]</span><br></pre></td></tr></table></figure>

<ul>
<li>èŠ‚ç‚¹å†…éƒ¨æ–‡æœ¬å’Œå±æ€§è·å–</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; response.css(&#39;a[href&#x3D;&quot;image1.html&quot;]::text&#39;).extract_first()</span><br><span class="line">&#39;Name: My image 1 &#39;</span><br><span class="line">&gt;&gt;&gt; response.css(&#39;a[href&#x3D;&quot;image1.html&quot;] img::attr(src)&#39;).extract_first()</span><br><span class="line">&#39;image1_thumb.jpg&#39;</span><br></pre></td></tr></table></figure>

<p>è·å–æ–‡æœ¬å’Œå±æ€§è¦ç”¨ ::text å’Œ ::attr() çš„å†™æ³•</p>
<ul>
<li>CSS é€‰æ‹©å™¨ XPath é€‰æ‹©å™¨åµŒå¥—ä½¿ç”¨</li>
</ul>
<p>è·å–æ‰€æœ‰ img èŠ‚ç‚¹çš„ src å±æ€§</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; response.xpath(&#39;&#x2F;&#x2F;a&#39;).css(&#39;img&#39;).xpath(&#39;@src&#39;).extract()</span><br><span class="line">[&#39;image1_thumb.jpg&#39;, &#39;image2_thumb.jpg&#39;, &#39;image3_thumb.jpg&#39;, &#39;image4_thumb.jpg&#39;, &#39;image5_thumb.jpg&#39;]</span><br></pre></td></tr></table></figure>

<h5 id="æ­£åˆ™åŒ¹é…"><a href="#æ­£åˆ™åŒ¹é…" class="headerlink" title="æ­£åˆ™åŒ¹é…"></a>æ­£åˆ™åŒ¹é…</h5><p>Scrapy è¿˜æ”¯æŒæ­£åˆ™åŒ¹é…</p>
<p>a èŠ‚ç‚¹ä¸­æ–‡æœ¬ç±»ä¼¼äº Name: My image 1ï¼Œç°åœ¨æå– Name: åé¢å†…å®¹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; response.xpath(&#39;&#x2F;&#x2F;a&#x2F;text()&#39;).re(&#39;Name:\s(.*)&#39;)</span><br><span class="line">[&#39;My image 1 &#39;, &#39;My image 2 &#39;, &#39;My image 3 &#39;, &#39;My image 4 &#39;, &#39;My image 5 &#39;]</span><br></pre></td></tr></table></figure>

<p>ç»™ re() æ–¹æ³•ä¼ ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œ(.*) å°±æ˜¯è¦åŒ¹é…çš„å†…å®¹</p>
<p>åŒæ—¶å­˜åœ¨ä¸¤ä¸ªåˆ†ç»„ï¼Œç»“æœä¼šæŒ‰åºè¾“å‡º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; response.xpath(&#39;&#x2F;&#x2F;a&#x2F;text()&#39;).re(&#39;(.*?)\s(.*)&#39;)</span><br><span class="line">[&#39;Name:&#39;, &#39;My image 1 &#39;, &#39;Name:&#39;, &#39;My image 2 &#39;, &#39;Name:&#39;, &#39;My image 3 &#39;, &#39;Name:&#39;, &#39;My image 4 &#39;, &#39;Name:&#39;, &#39;My image 5 &#39;]</span><br></pre></td></tr></table></figure>

<p>ç±»ä¼¼ extract_first() æ–¹æ³• re_first() æ–¹æ³•å¯ä»¥é€‰æ‹©åˆ—è¡¨ç¬¬ä¸€ä¸ªå…ƒç´ </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; response.xpath(&#39;&#x2F;&#x2F;a&#x2F;text()&#39;).re_first(&#39;Name:\s(.*)&#39;)</span><br><span class="line">&#39;My image 1 &#39;</span><br></pre></td></tr></table></figure>

<p>response å¯¹è±¡ä¸èƒ½ç›´æ¥è°ƒç”¨ re() å’Œ re_first() ï¼Œå¦‚æœæƒ³è¦å¯¹å…¨æ–‡è¿›è¡Œæ­£åˆ™åŒ¹é…ï¼Œå¯ä»¥å…ˆè°ƒç”¨ xpath() æ–¹æ³•å†æ­£åˆ™åŒ¹é…</p>
<h4 id="13-4-Spider-ç”¨æ³•"><a href="#13-4-Spider-ç”¨æ³•" class="headerlink" title="13.4 Spider ç”¨æ³•"></a>13.4 Spider ç”¨æ³•</h4><h5 id="Spider-ç±»"><a href="#Spider-ç±»" class="headerlink" title="Spider ç±»"></a>Spider ç±»</h5><p>å®šä¹‰çš„ Spider æ˜¯ç»§æ‰¿è‡ª scrapy.spiders.Spider</p>
<p>scrapy.spiders.Spider ç±»æä¾›äº† start_requests() æ–¹æ³•çš„é»˜è®¤å®ç°ï¼Œè¯»å–å¹¶è¯·æ±‚ start_urls å±æ€§ï¼Œå¹¶æ ¹æ®è¿”å›çš„ç»“æœè°ƒç”¨ parse() æ–¹æ³•è§£æç»“æœã€‚</p>
<p>nameï¼šçˆ¬è™«åç§°ï¼Œä¸€èˆ¬ä»¥ç½‘ç«™åŸŸååç§°æ¥å‘½åï¼ŒSpider çˆ¬å– mywebsite.comï¼Œå‘½åä¸º mywebsite</p>
<p>allow_domainsï¼šå…è®¸çˆ¬å–çš„åŸŸåï¼Œæ˜¯å¯é€‰é…ç½®ï¼Œä¸åœ¨æ­¤èŒƒå›´çš„é“¾æ¥ä¸ä¼šè¢«è·Ÿè¿›çˆ¬å–</p>
<p>start_urlsï¼šèµ·å§‹ URL åˆ—è¡¨ï¼Œæ²¡æœ‰å®ç° start_requests() æ–¹æ³•æ—¶ï¼Œé»˜è®¤ä¼šä»è¿™ä¸ªåˆ—è¡¨å¼€å§‹æŠ“å–</p>
<p>custom_settingsï¼šä¸€ä¸ªå­—å…¸ï¼Œä¸“å±æœ¬ Spider çš„é…ç½®ï¼Œä¼šè¦†ç›–å…¨å±€çš„è®¾ç½®ï¼Œæ­¤è®¾ç½®å¿…é¡»åœ¨åˆå§‹åŒ–å‰è¢«æ›´æ–°ï¼Œå¿…é¡»å®šä¹‰æˆç±»å˜é‡</p>
<p>crawlerï¼šæ˜¯ç”± from_crawler() æ–¹æ³•è®¾ç½®çš„ï¼Œä»£è¡¨æœ¬ Spider ç±»å¯¹åº”çš„ Crawler å¯¹è±¡ï¼ŒCrawler å¯¹è±¡åŒ…å«äº†å¾ˆå¤šé¡¹ç›®ç»„ä»¶ï¼Œåˆ©ç”¨å®ƒå¯ä»¥è·å–é¡¹ç›®ä¸€äº›é…ç½®ä¿¡æ¯ï¼Œæœ€å¸¸è§çš„è·å–é¡¹ç›®çš„è®¾ç½®ä¿¡æ¯ï¼Œå³ settings</p>
<p>settingsï¼šä¸€ä¸ªSettings å¯¹è±¡ï¼Œåˆ©ç”¨å®ƒå¯ä»¥ç›´æ¥è·å–é¡¹ç›®å…¨å±€è®¾ç½®å˜é‡</p>
<ul>
<li>start_requests()</li>
</ul>
<p>æ­¤æ–¹æ³•ç”¨äºç”Ÿæˆåˆå§‹è¯·æ±‚ï¼Œå¿…é¡»è¿”å›ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ã€‚æ­¤æ–¹æ³•ä¼šé»˜è®¤ä½¿ç”¨ start_urls é‡Œé¢çš„URL æ¥æ„é€  Requestï¼Œè€Œä¸” Request æ˜¯ GETè¯·æ±‚æ–¹å¼ï¼Œå¦‚æœæƒ³åœ¨å¯åŠ¨æ—¶ä»¥ POST æ–¹å¼è®¿é—®æŸä¸ªç«™ç‚¹ï¼Œå¯ä»¥ç›´æ¥é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œå‘é€ POST è¯·æ±‚æ—¶ä½¿ç”¨ FormRequest</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImagesSpider</span>(<span class="params">Spider</span>):</span></span><br><span class="line">  name = <span class="string">&#x27;images&#x27;</span></span><br><span class="line">  allowed_domains = [<span class="string">&#x27;images.so.com&#x27;</span>]</span><br><span class="line">  start_urls = [<span class="string">&#x27;http://images.so.com/&#x27;</span>]</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">start_requests</span>(<span class="params">self</span>):</span></span><br><span class="line">      data = &#123;<span class="string">&#x27;ch&#x27;</span>: <span class="string">&#x27;photography&#x27;</span>, <span class="string">&#x27;listtype&#x27;</span>: <span class="string">&#x27;new&#x27;</span>&#125;</span><br><span class="line">      base_url = <span class="string">&#x27;https://image.so.com/zjl?&#x27;</span></span><br><span class="line">      <span class="keyword">for</span> page <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, self.settings.get(<span class="string">&#x27;MAX_PAGE&#x27;</span>) + <span class="number">1</span>):</span><br><span class="line">          data[<span class="string">&#x27;sn&#x27;</span>] = page * <span class="number">30</span></span><br><span class="line">          <span class="comment">#åˆ©ç”¨urlencode()æ–¹æ³•å°†å­—å…¸è½¬åŒ–ä¸ºURLçš„GETå‚æ•°</span></span><br><span class="line">          params = urlencode(data)</span><br><span class="line">          url = base_url + params</span><br><span class="line">          <span class="keyword">yield</span> Request(url, self.parse)</span><br></pre></td></tr></table></figure>

<ul>
<li>parse()</li>
</ul>
<p>å½“ Response æ²¡æŒ‡å®šå›è°ƒå‡½æ•°æ—¶ï¼Œè¯¥æ–¹æ³•è¢«è°ƒç”¨ï¼Œè´Ÿè´£å¤„ç† Responseï¼Œå¤„ç†è¿”å›ç»“æœï¼Œå¹¶ä»ä¸­æå–æƒ³è¦çš„æ•°æ®å’Œä¸‹ä¸€æ­¥è¯·æ±‚ã€‚éœ€è¦è¿”å›ä¸€ä¸ªåŒ…å« Request æˆ– Item çš„å¯è¿­ä»£å¯¹è±¡</p>
<p>close()ï¼šå½“ Spider å…³é—­æ—¶ï¼Œè¯¥æ–¹æ³•è¢«è°ƒç”¨ï¼Œè¿™é‡Œä¸€èˆ¬ä¼šå®šä¹‰é‡Šæ”¾èµ„æºçš„ä¸€äº›æ“ä½œ</p>
<h4 id="13-5-Downloader-Middleware"><a href="#13-5-Downloader-Middleware" class="headerlink" title="13.5 Downloader Middleware"></a>13.5 Downloader Middleware</h4><p>ä¸‹è½½ä¸­é—´ä»¶ï¼Œå¤„äº Scrapy çš„ Request å’Œ Response ä¹‹é—´çš„å¤„ç†æ¨¡å—</p>
<p>Scheduler ä»é˜Ÿåˆ—ä¸­æ‹¿å‡ºä¸€ä¸ª Request å‘é€ç»™ Downloader æ‰§è¡Œä¸‹è½½ï¼Œè¿™è¿‡ç¨‹ä¼šç»è¿‡ Downloader Middlewares çš„å¤„ç†</p>
<p>å½“ Downloader å°† Request ä¸‹è½½å®Œæˆå¾—åˆ°çš„ Response è¿”å›ç»™ Spider æ—¶ä¼šå†æ¬¡ç»è¿‡  Downloader Middlewares å¤„ç†</p>
<p>ä¿®æ”¹ User-Agentã€å¤„ç†é‡å®šå‘ã€è®¾ç½®ä»£ç†ã€å¤±è´¥é‡è¯•ã€è®¾ç½®Cookiesç­‰åŠŸèƒ½éƒ½éœ€è¦å€ŸåŠ©  Downloader Middlewares å®ç°</p>
<p>Scrapy å·²ç»æä¾›äº†è®¸å¤š  Downloader Middlewaresï¼Œæ¯”å¦‚å¤±è´¥é‡è¯•ã€è‡ªåŠ¨é‡å®šå‘ç­‰åŠŸèƒ½çš„ Middlewareï¼Œè¢« DOWNLOADER_MIDDLEWARES_BASE å˜é‡å®šä¹‰ï¼Œæ˜¯ä¸€ä¸ªå­—å…¸æ ¼å¼</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&#39;scrapy.downloadermiddlewares.robotstxt.RobotsTxtMiddleware&#39;: 100</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é”®å€¼æ˜¯ ä¼˜å…ˆçº§ï¼Œæ•°å­—è¶Šå°ä¼šè¢«ä¼˜å…ˆè°ƒç”¨</p>
<p>Scrapy æä¾›äº†ä¸€ä¸ªè®¾ç½®å˜é‡ DOWNLOADER_MIDDLEWARESï¼Œç›´æ¥ä¿®æ”¹è¿™ä¸ªå˜é‡å°±å¯ä»¥æ·»åŠ è‡ªå·±å®šä¹‰çš„  Downloader Middlewares</p>
<h5 id="æ ¸å¿ƒæ–¹æ³•"><a href="#æ ¸å¿ƒæ–¹æ³•" class="headerlink" title="æ ¸å¿ƒæ–¹æ³•"></a>æ ¸å¿ƒæ–¹æ³•</h5><p>æ¯ä¸ª  Downloader Middlewares éƒ½å®šä¹‰äº†ä¸€ä¸ªæˆ–å¤šä¸ªæ–¹æ³•çš„ç±»ï¼Œæ ¸å¿ƒæ–¹æ³•ä¸‰ä¸ª</p>
<p>process_request(request, spider)</p>
<p>process_response(request, response, spider)</p>
<p>process_exception(request, exception, spider)</p>
<p>åªéœ€è¦å®ç°ä¸€ä¸ªæ–¹æ³•ï¼Œå°±å¯ä»¥å®šä¹‰ä¸€ä¸ª Downloader Middlewares </p>
<ul>
<li>process_request(request, spider)</li>
</ul>
<p>Request è¢« Scrapy å¼•æ“è°ƒåº¦ç»™Downloaderä¹‹å‰ï¼Œä¼šè¢«è°ƒç”¨</p>
<p>å¯ä»¥ç”¨ process_request å¯¹ Request æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚è¿”å›å€¼å¿…é¡»ä¸º Noneã€Responseå¯¹è±¡ã€Request å¯¹è±¡ä¹‹ä¸€ï¼Œæˆ–è€…æŠ›å‡º IgnoreRequest å¼‚å¸¸</p>
<ul>
<li>process_response(request, response, spider)</li>
</ul>
<p>Downloader æ‰§è¡Œ Request ä¸‹è½½ä¹‹åï¼Œä¼šå¾—åˆ°å¯¹åº”çš„ Responseï¼ŒScrapy å¼•æ“ä¾¿ä¼šå°† Response å‘é€ç»™ Spider è¿›è¡Œè§£æã€‚å‘é€ä¹‹å‰ï¼Œå¯ä»¥ç”¨ process_response æ–¹æ³•å¯¹ Response è¿›è¡Œå¤„ç†ã€‚è¿”å›å€¼å¿…é¡»ä¸º Noneã€Responseå¯¹è±¡ã€Request å¯¹è±¡ä¹‹ä¸€ï¼Œæˆ–è€…æŠ›å‡º IgnoreRequest å¼‚å¸¸</p>
<ul>
<li>process_exception(request, exception, spider)</li>
</ul>
<p>Downloader æˆ– process_rqeuest() æ–¹æ³•æŠ›å‡ºå¼‚å¸¸æ—¶è¢«è°ƒç”¨</p>
<h5 id="å®æˆ˜"><a href="#å®æˆ˜" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h5><p>æ–°å»ºé¡¹ç›®</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy startproject scrapydownloadertest</span><br></pre></td></tr></table></figure>

<p>è¿›å…¥é¡¹ç›®æ–°å»º Spiderï¼Œ åä¸º httpbin</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd scrapydownloadertest</span><br><span class="line">scrapy genspider httpbin httpbin.org</span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹å†…å®¹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpbinSpider</span>(<span class="params">scrapy.Spider</span>):</span></span><br><span class="line">  name = <span class="string">&#x27;httpbin&#x27;</span></span><br><span class="line">  allowed_domains = [<span class="string">&#x27;httpbin.org&#x27;</span>]</span><br><span class="line">  start_urls = [<span class="string">&#x27;http://httpbin.org/get&#x27;</span>]</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">      self.logger.debug(response.text)</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œ  <code>scrapy crawl httpbin</code></p>
<p>è¿è¡Œç»“æœåŒ…å« Scrapy å‘é€çš„ Request ä¿¡æ¯ </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> DEBUG: &#123;</span><br><span class="line">  &quot;args&quot;: &#123;&#125;,</span><br><span class="line">  &quot;headers&quot;: &#123;</span><br><span class="line">    &quot;Accept&quot;: &quot;text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8&quot;,</span><br><span class="line">    &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;,</span><br><span class="line">    &quot;Accept-Language&quot;: &quot;en&quot;,</span><br><span class="line">    &quot;Host&quot;: &quot;httpbin.org&quot;,</span><br><span class="line">    &quot;User-Agent&quot;: &quot;Scrapy&#x2F;2.4.1 (+https:&#x2F;&#x2F;scrapy.org)&quot;,</span><br><span class="line">    &quot;X-Amzn-Trace-Id&quot;: &quot;Root&#x3D;1-625fa44b-7de6f90f1696c8d44ba334ab&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;origin&quot;: &quot;14.155.91.98&quot;,</span><br><span class="line">  &quot;url&quot;: &quot;http:&#x2F;&#x2F;httpbin.org&#x2F;get&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ä¿®æ”¹ User-Agent ä¸¤ç§æ–¹å¼</li>
</ul>
<p>ç¬¬ä¸€ç§ä¿®æ”¹ settings é‡Œçš„ USER_AGENT å˜é‡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">USERAGENT &#x3D; &#39;xxxx&#39;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæƒ³è®¾ç½®æ›´çµæ´»ï¼Œæ¯”å¦‚éšæœº User-Agentï¼Œéœ€è¦å€ŸåŠ© Downloader Middleware</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomUserAgentMiddleware</span>():</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">      self.user_agents = [</span><br><span class="line">          <span class="string">&#x27;xxx1&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;xxx2&#x27;</span>,</span><br><span class="line">      ]</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">process_request</span>(<span class="params">self, request, spider</span>):</span></span><br><span class="line">      request.headers[<span class="string">&#x27;User-Agent&#x27;</span>] = random.choice(self.user_agents)</span><br></pre></td></tr></table></figure>

<p>è¦ä½¿è¿™ä¸ª Downloader Middleware ç”Ÿæ•ˆè¿˜è¦å»è°ƒç”¨å®ƒï¼Œåœ¨ settings.py ä¸­ï¼Œå°† DOWNLOADER_MIDDLEWARES å–æ¶ˆæ³¨é‡Š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DOWNLOADER_MIDDLEWARES = &#123;</span><br><span class="line"><span class="string">&#x27;scrapydownloadertest.middlewares.RandomUserAgentMiddleware&#x27;</span>: <span class="number">543</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†æ¬¡è¿è¡Œå‘ç° User-Agent è¢«ä¿®æ”¹äº† </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">DEBUG: &#123;</span><br><span class="line">  &quot;args&quot;: &#123;&#125;,</span><br><span class="line">  &quot;headers&quot;: &#123;</span><br><span class="line">    &quot;Accept&quot;: &quot;text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,*&#x2F;*;q&#x3D;0.8&quot;,</span><br><span class="line">    &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;,</span><br><span class="line">    &quot;Accept-Language&quot;: &quot;en&quot;,</span><br><span class="line">    &quot;Host&quot;: &quot;httpbin.org&quot;,</span><br><span class="line">    &quot;User-Agent&quot;: &quot;xxx2&quot;,</span><br><span class="line">    &quot;X-Amzn-Trace-Id&quot;: &quot;Root&#x3D;1-625fa838-4f44d9361feb25107824c407&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;origin&quot;: &quot;14.155.91.98&quot;,</span><br><span class="line">  &quot;url&quot;: &quot;http:&#x2F;&#x2F;httpbin.org&#x2F;get&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ä¿®æ”¹å“åº”</li>
</ul>
<p>RandomUserAgentMiddleware ä¸­æ·»åŠ  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">process_response</span>(<span class="params">self, response, spider</span>):</span></span><br><span class="line">    response.status = <span class="number">201</span></span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>

<p>å† Spider çš„ parse() æ–¹æ³•æ·»åŠ è¾“å‡º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.logger.debug(&#39;Status code:&#39; + str(response.status))</span><br></pre></td></tr></table></figure>

<h4 id="13-6-Spider-Middleware"><a href="#13-6-Spider-Middleware" class="headerlink" title="13.6 Spider Middleware"></a>13.6 Spider Middleware</h4><p>Spider Middleware ä¸‰ä¸ªä½œç”¨</p>
<p>Response å‘é€ç»™ Spider ä¹‹å‰å¯¹ Response è¿›è¡Œå¤„ç†</p>
<p>Request å‘é€ç»™ Scheduler ä¹‹å‰å¯¹ Request è¿›è¡Œå¤„ç†</p>
<p>Item å‘é€ç»™ Item Pipeline ä¹‹å‰å¯¹ Item è¿›è¡Œå¤„ç†</p>
<p>Scrapy å·²ç»æä¾›äº†è®¸å¤š Spider Middlewareï¼Œè¢« SPIDER_MIDDLEWARES_BASE å˜é‡å®šä¹‰</p>
<p>Spider Middleware 4ä¸ªæ ¸å¿ƒæ–¹æ³•ï¼Œåªéœ€è¦å®ç°å…¶ä¸­ä¸€ä¸ªæ–¹æ³•å°±å¯ä»¥å®šä¹‰ä¸€ä¸ª Spider Middleware</p>
<ul>
<li>process_spider_input(response, spider)</li>
</ul>
<p>Response è¢« Spider Middleware å¤„ç†æ—¶è¢«è°ƒç”¨</p>
<p>è¿”å› None æˆ–è€…æŠ›å‡ºå¼‚å¸¸</p>
<ul>
<li>process_spider_output(response, result, spider)</li>
</ul>
<p>å½“ Spider å¤„ç† Response è¿”å›ç»“æœæ—¶è¢«è°ƒç”¨</p>
<p>å¿…é¡»è¿”å›åŒ…å« Request æˆ– Item å¯¹è±¡çš„å¯è¿­ä»£å¯¹è±¡</p>
<ul>
<li>process_spider_exception(response, exception, spider)</li>
</ul>
<p>Spider æˆ– process_spider_input æ–¹æ³•æŠ›å‡ºå¼‚å¸¸æ—¶è°ƒç”¨</p>
<ul>
<li>process_start_requests(start_requests, spider)</li>
</ul>
<h4 id="13-6-Item-Pipeline"><a href="#13-6-Item-Pipeline" class="headerlink" title="13.6 Item Pipeline"></a>13.6 Item Pipeline</h4><p>å‚è€ƒä½¿ç”¨ Item Pipeline</p>
<h4 id="çˆ¬å–-360æ‘„å½±ç¾å›¾"><a href="#çˆ¬å–-360æ‘„å½±ç¾å›¾" class="headerlink" title="çˆ¬å– 360æ‘„å½±ç¾å›¾"></a>çˆ¬å– 360æ‘„å½±ç¾å›¾</h4><h5 id="æ„é€ è¯·æ±‚"><a href="#æ„é€ è¯·æ±‚" class="headerlink" title="æ„é€ è¯·æ±‚"></a>æ„é€ è¯·æ±‚</h5><h5 id="MongoDBå­˜å‚¨"><a href="#MongoDBå­˜å‚¨" class="headerlink" title="MongoDBå­˜å‚¨"></a>MongoDBå­˜å‚¨</h5><h5 id="MySQL-å­˜å‚¨"><a href="#MySQL-å­˜å‚¨" class="headerlink" title="MySQL å­˜å‚¨"></a>MySQL å­˜å‚¨</h5><h5 id="Image-Pipeline"><a href="#Image-Pipeline" class="headerlink" title="Image Pipeline"></a>Image Pipeline</h5><p>Scrapy æä¾›äº†ä¸“é—¨å¤„ç†ä¸‹è½½çš„ Pipelineï¼ŒåŒ…æ‹¬ä¸‹è½½æ–‡ä»¶å’Œå›¾ç‰‡ï¼Œä¸‹è½½è¿‡ç¨‹æ”¯æŒå¼‚æ­¥å’Œå¤šçº¿ç¨‹</p>
<p>å®˜æ–¹æ–‡æ¡£åœ°å€ <a target="_blank" rel="noopener" href="https://doc.scrapy.org/en/latest/topics/media-pipeline.html">https://doc.scrapy.org/en/latest/topics/media-pipeline.html</a></p>
<p>é¦–å…ˆå®šä¹‰æ–‡ä»¶å­˜å‚¨çš„è·¯å¾„ï¼Œéœ€è¦å®šä¹‰ä¸€ä¸ª IMAGES_STORE å˜é‡ï¼Œåœ¨settings.py æ·»åŠ ä»£ç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IMAGES_STORE &#x3D; &#39;.&#x2F;images&#39;</span><br></pre></td></tr></table></figure>

<p>ä¸‹è½½çš„å›¾ç‰‡éƒ½ä¼šä¿å­˜åˆ°å½“å‰è·¯å¾„çš„ images å­æ–‡ä»¶å¤¹ä¸‹</p>
<p>å†…ç½®çš„ ImagesPipeline ä¼šé»˜è®¤è¯»å– Item çš„ image_urls å­—æ®µï¼Œå¹¶è®¤ä¸ºå­—æ®µæ˜¯ä¸€ä¸ªåˆ—è¡¨å½¢å¼ï¼Œå®ƒä¼šéå† Item çš„ image_urls å­—æ®µï¼Œç„¶åå–å‡ºæ¯ä¸ª URL è¿›è¡Œå›¾ç‰‡ä¸‹è½½</p>
<p>ç°åœ¨ç”Ÿæˆçš„ Item çš„å›¾ç‰‡é“¾æ¥å­—æ®µå¹¶ä¸æ˜¯ image_urls å­—æ®µè¡¨ç¤ºçš„ï¼Œä¹Ÿä¸æ˜¯åˆ—è¡¨å½¢å¼ï¼Œè€Œæ˜¯å•ä¸ª URL</p>
<p>æ‰€ä»¥ä¸ºäº†å®ç°ä¸‹è½½ï¼Œéœ€è¦é‡æ–°å®šä¹‰ä¸‹è½½éƒ¨åˆ†é€»è¾‘ï¼Œå³è¦è‡ªå®šä¹‰ ImagePipelineï¼Œç»§æ‰¿è‡ªå†…ç½®çš„ ImagesPipeline</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImagePipeline</span>(<span class="params">ImagesPipeline</span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">file_path</span>(<span class="params">self, request, response=<span class="literal">None</span>, info=<span class="literal">None</span></span>):</span></span><br><span class="line">      url = request.url</span><br><span class="line">      file_name = url.split(<span class="string">&#x27;/&#x27;</span>)[<span class="number">-1</span>]</span><br><span class="line">      <span class="keyword">return</span> file_name</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">item_completed</span>(<span class="params">self, results, item, info</span>):</span></span><br><span class="line">      image_paths = [x[<span class="string">&#x27;path&#x27;</span>] <span class="keyword">for</span> ok, x <span class="keyword">in</span> results <span class="keyword">if</span> ok]</span><br><span class="line">      <span class="keyword">if</span> <span class="keyword">not</span> image_paths:</span><br><span class="line">          <span class="keyword">raise</span> DropItem(<span class="string">&#x27;Image Downloaded Failed&#x27;</span>)</span><br><span class="line">      <span class="keyword">return</span> item</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">get_media_requests</span>(<span class="params">self, item, info</span>):</span></span><br><span class="line">      <span class="keyword">yield</span> Request(item[<span class="string">&#x27;url&#x27;</span>])</span><br></pre></td></tr></table></figure>

<ul>
<li>get_media_requests</li>
</ul>
<p>ç¬¬ä¸€ä¸ªå‚æ•° item æ˜¯çˆ¬å–ç”Ÿæˆçš„ Item å¯¹è±¡ï¼Œå°†å®ƒçš„ url å­—æ®µå–å‡ºæ¥ï¼Œç„¶åç›´æ¥ç”Ÿæˆ Requestå¯¹è±¡ï¼Œå°†æ­¤ Request åŠ å…¥åˆ°è°ƒåº¦é˜Ÿåˆ—ï¼Œç­‰å¾…è¢«è°ƒåº¦ï¼Œæ‰§è¡Œä¸‹è½½</p>
<ul>
<li>file_path</li>
</ul>
<p>è¿™ä¸ªæ–¹æ³•ç”¨æ¥è¿”å›ä¿å­˜çš„æ–‡ä»¶åï¼Œç›´æ¥å°†å›¾ç‰‡é“¾æ¥æœ€åä¸€éƒ¨åˆ†å½“ä½œæ–‡ä»¶åå³å¯ï¼Œç”¨ split å‡½æ•°åˆ†å‰²æ‹¼æ¥å¹¶æå–æœ€åä¸€éƒ¨åˆ†</p>
<ul>
<li>item_completed</li>
</ul>
<p>å®ƒæ˜¯å•ä¸ª Item å®Œæˆä¸‹è½½æ—¶çš„å¤„ç†æ–¹æ³•ï¼Œå¹¶ä¸æ˜¯æ¯å¼ å›¾éƒ½ä¼šä¸‹è½½æˆåŠŸï¼Œéœ€è¦åˆ†æä¸‹è½½ç»“æœå‰”é™¤ä¸‹è½½å¤±è´¥çš„å›¾ç‰‡ï¼Œæ²¡ä¸‹è½½æˆåŠŸå°±ä¸éœ€è¦ä¿å­˜ Item åˆ°æ•°æ®åº“</p>
<p>æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•° results å°±æ˜¯è¯¥ Item å¯¹åº”ä¸‹è½½ç»“æœï¼Œæ˜¯ä¸€ä¸ªåˆ—è¡¨å½¢å¼ï¼Œåˆ—è¡¨æ¯ä¸€ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªå…ƒç»„ï¼Œå…¶ä¸­åŒ…å«äº†ä¸‹è½½æˆåŠŸæˆ–å¤±è´¥çš„ä¿¡æ¯</p>
<p>è¿™é‡Œéå†ä¸‹è½½ç»“æœæ‰¾å‡ºæ‰€æœ‰æˆåŠŸçš„ä¸‹è½½åˆ—è¡¨ã€‚</p>
<h4 id="13-8-Scrapy-å¯¹æ¥-Selenium"><a href="#13-8-Scrapy-å¯¹æ¥-Selenium" class="headerlink" title="13.8 Scrapy å¯¹æ¥ Selenium"></a>13.8 Scrapy å¯¹æ¥ Selenium</h4><p>Scrapy æŠ“å–é¡µé¢çš„æ–¹å¼å’Œ requests åº“ç±»ä¼¼ï¼Œéƒ½æ˜¯ç›´æ¥æ¨¡æ‹Ÿ HTTP è¯·æ±‚</p>
<p>å‰é¢æŠ“å– JavaScript æ¸²æŸ“çš„é¡µé¢æœ‰ä¸¤ç§æ–¹å¼ã€‚ä¸€ç§æ˜¯åˆ†æ Ajax è¯·æ±‚ï¼Œæ‰¾åˆ°å¯¹åº”çš„æ¥å£æŠ“å–ï¼ŒScrapy åŒæ ·ä¹Ÿå¯ä»¥ç”¨è¿™ç§æ–¹æ³•æŠ“å–ã€‚å¦ä¸€ç§æ˜¯ç”¨ Selenium æˆ– Splash æ¨¡æ‹Ÿæµè§ˆå™¨è¿›è¡ŒæŠ“å–ï¼Œä¸éœ€è¦å…³å¿ƒé¡µé¢åå°å‘ç”Ÿçš„è¯·æ±‚ï¼Œä¹Ÿä¸éœ€è¦åˆ†ææ¸²æŸ“è¿‡ç¨‹ï¼Œåªéœ€è¦å…³å¿ƒé¡µé¢æœ€ç»ˆç»“æœï¼Œå³å¯è§å³å¯çˆ¬</p>
<h5 id="å¯¹æ¥-Selenium"><a href="#å¯¹æ¥-Selenium" class="headerlink" title="å¯¹æ¥ Selenium"></a>å¯¹æ¥ Selenium</h5><p>å¯¹æ¥ Selenium è¿›è¡ŒæŠ“å–ï¼Œé‡‡ç”¨ Downloader Middleware æ¥å®ç°ï¼Œåœ¨ Middleware é‡Œé¢çš„ process_request() æ–¹æ³•é‡Œå¯¹æ¯ä¸ªæŠ“å–è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œå¯åŠ¨æµè§ˆå™¨è¿›è¡Œé¡µé¢æ¸²æŸ“ï¼Œå†å°†æ¸²æŸ“åçš„ç»“æœæ„é€ ä¸€ä¸ª HtmlResponse å¯¹è±¡è¿”å›</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.common.exceptions <span class="keyword">import</span> TimeoutException</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"><span class="keyword">from</span> scrapy.http <span class="keyword">import</span> HtmlResponse</span><br><span class="line"><span class="keyword">from</span> logging <span class="keyword">import</span> getLogger</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SeleniumMiddleware</span>():</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, timeout=<span class="literal">None</span>, service_args=[]</span>):</span></span><br><span class="line">      self.logger = getLogger(__name__)</span><br><span class="line">      self.timeout = timeout</span><br><span class="line">      self.browser = webdriver.PhantomJS(service_args=service_args)</span><br><span class="line">      self.browser.set_window_size(<span class="number">1400</span>, <span class="number">700</span>)</span><br><span class="line">      self.browser.set_page_load_timeout(self.timeout)</span><br><span class="line">      self.wait = WebDriverWait(self.browser, self.timeout)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__del__</span>(<span class="params">self</span>):</span></span><br><span class="line">      self.browser.close()</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">process_request</span>(<span class="params">self, request, spider</span>):</span></span><br><span class="line">      <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">      ç”¨PhantomJSæŠ“å–é¡µé¢</span></span><br><span class="line"><span class="string">      :param request: Requestå¯¹è±¡</span></span><br><span class="line"><span class="string">      :param spider: Spiderå¯¹è±¡</span></span><br><span class="line"><span class="string">      :return: HtmlResponse</span></span><br><span class="line"><span class="string">      &quot;&quot;&quot;</span></span><br><span class="line">      self.logger.debug(<span class="string">&#x27;PhantomJS is Starting&#x27;</span>)</span><br><span class="line">      page = request.meta.get(<span class="string">&#x27;page&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">      <span class="keyword">try</span>:</span><br><span class="line">          self.browser.get(request.url)</span><br><span class="line">          <span class="keyword">if</span> page &gt; <span class="number">1</span>:</span><br><span class="line">              <span class="built_in">input</span> = self.wait.until(</span><br><span class="line">                  EC.presence_of_element_located((By.CSS_SELECTOR, <span class="string">&#x27;#mainsrp-pager div.form &gt; input&#x27;</span>)))</span><br><span class="line">              submit = self.wait.until(</span><br><span class="line">                  EC.element_to_be_clickable((By.CSS_SELECTOR, <span class="string">&#x27;#mainsrp-pager div.form &gt; span.btn.J_Submit&#x27;</span>)))</span><br><span class="line">              <span class="built_in">input</span>.clear()</span><br><span class="line">              <span class="built_in">input</span>.send_keys(page)</span><br><span class="line">              submit.click()</span><br><span class="line">          self.wait.until(</span><br><span class="line">              EC.text_to_be_present_in_element((By.CSS_SELECTOR, <span class="string">&#x27;#mainsrp-pager li.item.active &gt; span&#x27;</span>), <span class="built_in">str</span>(page)))</span><br><span class="line">          self.wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, <span class="string">&#x27;.m-itemlist .items .item&#x27;</span>)))</span><br><span class="line">          <span class="keyword">return</span> HtmlResponse(url=request.url, body=self.browser.page_source, request=request, encoding=<span class="string">&#x27;utf-8&#x27;</span>,</span><br><span class="line">                              status=<span class="number">200</span>)</span><br><span class="line">      <span class="keyword">except</span> TimeoutException:</span><br><span class="line">          <span class="keyword">return</span> HtmlResponse(url=request.url, status=<span class="number">500</span>, request=request)</span><br><span class="line"></span><br><span class="line"><span class="meta">  @classmethod</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">from_crawler</span>(<span class="params">cls, crawler</span>):</span></span><br><span class="line">      <span class="keyword">return</span> cls(timeout=crawler.settings.get(<span class="string">&#x27;SELENIUM_TIMEOUT&#x27;</span>),</span><br><span class="line">                 service_args=crawler.settings.get(<span class="string">&#x27;PHANTOMJS_SERVICE_ARGS&#x27;</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>process_request() æ–¹æ³•ä¸­ï¼Œé€šè¿‡ Request çš„ meta å±æ€§è·å–å½“å‰éœ€è¦çˆ¬å–çš„é¡µç ï¼Œè°ƒç”¨ PhantomJS å¯¹è±¡çš„ get() æ–¹æ³•è®¿é—® Request å¯¹åº”çš„ URLï¼Œç›¸å½“äºä» Request å¯¹è±¡é‡Œè·å–è¯·æ±‚é“¾æ¥ï¼Œç„¶åå†ç”¨ PhantomJS åŠ è½½ï¼Œè€Œä¸å†ç”¨ Scrapy é‡Œçš„ Downloader</p>
<h5 id="è§£æé¡µé¢"><a href="#è§£æé¡µé¢" class="headerlink" title="è§£æé¡µé¢"></a>è§£æé¡µé¢</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">	products = response.xpath(..)</span><br><span class="line">	...</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ XPath è¿›è¡Œè§£æï¼Œè°ƒç”¨ response å˜é‡çš„ xpath() æ–¹æ³•</p>
<h4 id="13-9-Scrapy-å¯¹æ¥-Splash"><a href="#13-9-Scrapy-å¯¹æ¥-Splash" class="headerlink" title="13.9 Scrapy å¯¹æ¥ Splash"></a>13.9 Scrapy å¯¹æ¥ Splash</h4><p>Splash å’Œ Scrapy éƒ½æ”¯æŒå¼‚æ­¥å¤„ç†</p>
<p>åœ¨ Selenium çš„å¯¹æ¥è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªé¡µé¢çš„æ¸²æŸ“ä¸‹è½½æ˜¯åœ¨ Downloader Middleware é‡Œå®Œæˆçš„ï¼Œæ‰€ä»¥æ•´ä¸ªè¿‡ç¨‹æ˜¯é˜»å¡å¼çš„ã€‚Scrapy ä¼šç­‰å¾…è¿™ä¸ªè¿‡ç¨‹å®Œæˆåå†ç»§ç»­å¤„ç†å’Œè°ƒåº¦å…¶å®ƒè¯·æ±‚ï¼Œå½±å“äº†çˆ¬å–æ•ˆç‡ï¼Œå› æ­¤ä½¿ç”¨ Splash çš„çˆ¬å–æ•ˆç‡å¸ Selenium é«˜å¾ˆå¤š</p>
<h4 id="13-10-é€šç”¨çˆ¬è™«"><a href="#13-10-é€šç”¨çˆ¬è™«" class="headerlink" title="13.10 é€šç”¨çˆ¬è™«"></a>13.10 é€šç”¨çˆ¬è™«</h4><h5 id="CrawSpider"><a href="#CrawSpider" class="headerlink" title="CrawSpider"></a>CrawSpider</h5><p>å®˜æ–¹æ–‡æ¡£ <a target="_blank" rel="noopener" href="https://docs.scrapy.org/en/latest/topics/spiders.html#crawlspider">https://docs.scrapy.org/en/latest/topics/spiders.html#crawlspider</a></p>
<p>Scrapy æä¾›çš„ä¸€ä¸ªé€šç”¨çˆ¬è™«ï¼Œåœ¨ Spider é‡Œï¼Œå¯ä»¥æŒ‡å®šä¸€äº›çˆ¬å–è§„åˆ™æ¥å®ç°é¡µé¢çš„æå–ï¼Œè¿™äº›çˆ¬å–è§„åˆ™ç”±ä¸€ä¸ªä¸“é—¨ çš„æ•°æ®ç»“æ„ Rule è¡¨ç¤ºï¼ŒRule é‡ŒåŒ…å«æå–å’Œè·Ÿè¿›é¡µé¢çš„é…ç½®ï¼ŒSpider ä¼šæ ¹æ® Rule æ¥ç¡®å®šå½“å‰é¡µé¢ä¸­çš„å“ªäº›é“¾æ¥éœ€è¦ç»§ç»­çˆ¬å–ã€å“ªäº›é¡µé¢çš„çˆ¬å–ç»“æœéœ€è¦ç”¨å“ªä¸ªæ–¹æ³•è§£æ</p>
<p>CrawlSpider ç±»ç»§æ‰¿è‡ª Spider ç±»</p>
<p>rulesï¼šçˆ¬å–è§„åˆ™å±æ€§ï¼Œæ˜¯åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ª Rule å¯¹è±¡çš„åˆ—è¡¨ã€‚æ¯ä¸ª Rule å¯¹çˆ¬å–ç½‘ç«™çš„åŠ¨ä½œéƒ½åšäº†å®šä¹‰ï¼ŒCrawlSpider ä¼šè¯»å– rules çš„æ¯ä¸€ä¸ª Rule å¹¶è¿›è¡Œè§£æ</p>
<p>parse_start_url()ï¼šæ˜¯ä¸€ä¸ªå¯é‡å†™çš„æ–¹æ³•ï¼Œå½“ start_urls é‡Œå¯¹åº”çš„ Request å¾—åˆ° Response æ—¶ï¼Œè¯¥æ–¹æ³•è¢«è°ƒç”¨ï¼Œä¼šè§£æ Response å¹¶å¿…é¡»è¿”å› Item å¯¹è±¡æˆ–è€… Request å¯¹è±¡</p>
<h6 id="Rule"><a href="#Rule" class="headerlink" title="Rule"></a>Rule</h6><p>å®šä¹‰é¡µé¢çš„çˆ¬å–é€»è¾‘</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">scrapy</span>.<span class="title">contrib</span>.<span class="title">spiders</span>.<span class="title">Rule</span>(<span class="params">link_extractor, callback=<span class="literal">None</span>, cb_kwargs=<span class="literal">None</span>, follow=<span class="literal">None</span>, process_links=<span class="literal">None</span>, process_request=<span class="literal">None</span></span>)</span></span><br></pre></td></tr></table></figure>

<p>link_extractorï¼šLinkExtractor å¯¹è±¡ï¼Œé€šè¿‡å®ƒï¼ŒSpider å¯ä»¥çŸ¥é“ä»çˆ¬å–çš„é¡µé¢ä¸­æå–å“ªäº›é“¾æ¥ï¼Œæå–çš„é“¾æ¥ä¼šè‡ªåŠ¨ç”Ÿæˆ Requestï¼Œä¸€èˆ¬å¸¸ç”¨ LxmlLinkExtractor å¯¹è±¡ä½œä¸ºå‚æ•°</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LxmlLinkExtractor</span>(<span class="params">FilteringLinkExtractor</span>):</span></span><br><span class="line">  	<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  	allow æ­£åˆ™è¡¨è¾¾å¼æˆ–æ­£åˆ™è¡¨è¾¾å¼åˆ—è¡¨ï¼Œå®šä¹‰ä»å½“å‰é¡µé¢æå–å‡ºçš„é“¾æ¥å“ªäº›æ˜¯ç¬¦åˆè¦æ±‚çš„ï¼Œåªæœ‰ç¬¦åˆè¦æ±‚çš„é“¾æ¥æ‰ä¼šè¢«è·Ÿè¿›ï¼›deny åˆ™ç›¸å</span></span><br><span class="line"><span class="string">  	allow_domains å®šä¹‰äº†ç¬¦åˆè¦æ±‚çš„åŸŸåï¼Œåœ¨æ­¤åŸŸåçš„é“¾æ¥æ‰ä¼šè¢«è·Ÿè¿›ç”Ÿæˆæ–°çš„Requestï¼›deny_domainsç›¸å</span></span><br><span class="line"><span class="string">  	restrict_xpaths ä»å½“å‰é¡µé¢ä¸­XPathåŒ¹é…çš„åŒºåŸŸæå–é“¾æ¥ï¼Œå€¼æ˜¯XPathè¡¨è¾¾å¼æˆ–XPathè¡¨è¾¾å¼åˆ—è¡¨</span></span><br><span class="line"><span class="string">  	restrict_css ä»å½“å‰é¡µé¢ä¸­CSSé€‰æ‹©å™¨åŒ¹é…çš„åŒºåŸŸæå–é“¾æ¥ï¼Œå€¼æ˜¯CSSé€‰æ‹©å™¨æˆ–CSSé€‰æ‹©å™¨åˆ—è¡¨</span></span><br><span class="line"><span class="string">  	&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        self,</span></span></span><br><span class="line"><span class="function"><span class="params">        allow=(<span class="params"></span>),</span></span></span><br><span class="line"><span class="function"><span class="params">        deny=(<span class="params"></span>),</span></span></span><br><span class="line"><span class="function"><span class="params">        allow_domains=(<span class="params"></span>),</span></span></span><br><span class="line"><span class="function"><span class="params">        deny_domains=(<span class="params"></span>),</span></span></span><br><span class="line"><span class="function"><span class="params">        restrict_xpaths=(<span class="params"></span>),</span></span></span><br><span class="line"><span class="function"><span class="params">        tags=(<span class="params"><span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;area&#x27;</span></span>),</span></span></span><br><span class="line"><span class="function"><span class="params">        attrs=(<span class="params"><span class="string">&#x27;href&#x27;</span>,</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">        canonicalize=<span class="literal">False</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        unique=<span class="literal">True</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        process_value=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        deny_extensions=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        restrict_css=(<span class="params"></span>),</span></span></span><br><span class="line"><span class="function"><span class="params">        strip=<span class="literal">True</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">        restrict_text=<span class="literal">None</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">    </span>):</span></span><br></pre></td></tr></table></figure>

<p>callbackï¼šå›è°ƒå‡½æ•°ï¼Œæ¯æ¬¡ä» link_extractor ä¸­è·å–åˆ°é“¾æ¥æ—¶ï¼Œè¯¥å‡½æ•°ä¼šè¢«è°ƒç”¨</p>
<p>é¿å…ä½¿ç”¨ parse() ä½œä¸ºå›è°ƒå‡½æ•°ï¼Œç”±äº CrawlSpider ä½¿ç”¨ parse() æ–¹æ³•æ¥å®ç°é€»è¾‘ï¼Œå¦‚æœ parse() æ–¹æ³•è¢«è¦†ç›–äº†ï¼ŒCrawlSpider å°†ä¼šè¿è¡Œå¤±è´¥</p>
<p>cb_kwargsï¼šå­—å…¸ï¼Œå®ƒåŒ…å«ä¼ é€’ç»™å›è°ƒå‡½æ•°çš„å‚æ•°</p>
<p>followï¼šTrue æˆ– Falseï¼ŒæŒ‡å®šè·Ÿè¿›è§„åˆ™ä» Response æå–çš„é“¾æ¥æ˜¯å¦éœ€è¦è·Ÿè¿›ï¼Œå¦‚æœ callback ä¸º Noneï¼Œfollow é»˜è®¤è®¾ç½®ä¸º Trueï¼Œå¦åˆ™é»˜è®¤ä¸º False</p>
<p>Trueï¼Œä¸‹ä¸€é¡µçš„é¡µé¢å¦‚æœè¯·æ±‚æˆåŠŸäº†å°±éœ€è¦ç»§ç»­åƒä¸Šä¸€ä¸ªä¸€æ ·åˆ†æï¼Œä»£è¡¨ç»§ç»­è·Ÿè¿›åŒ¹é…åˆ†æ</p>
<p>ã€‚ã€‚ã€‚</p>
<h6 id="Item-Loader"><a href="#Item-Loader" class="headerlink" title="Item Loader"></a>Item Loader</h6><p>æä¾›ä¸€ç§ä¾¿æ·çš„æœºåˆ¶å¸®åŠ©æˆ‘ä»¬æ–¹ä¾¿åœ°æå– Item</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">scrapy</span>.<span class="title">loader</span>.<span class="title">ItemLoader</span>(<span class="params">[item, selector, response,] **kwargs</span>)</span></span><br><span class="line"><span class="class">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="class"><span class="title">item</span>:</span> Itemå¯¹è±¡ï¼Œå¯ä»¥è°ƒç”¨add_xpath()ã€add_css()ã€add_value()ç­‰æ–¹æ³•æ¥å¡«å…… Itemå¯¹è±¡</span><br><span class="line">selector: æ˜¯Selectorå¯¹è±¡ï¼Œç”¨æ¥æå–å¡«å……æ•°æ®çš„é€‰æ‹©å™¨</span><br><span class="line">response: æ˜¯Responseå¯¹è±¡ï¼Œç”¨æ¥ä½¿ç”¨æ„é€ é€‰æ‹©å™¨çš„Response</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>ä¸€ä¸ªæ¯”è¾ƒå…¸å‹çš„Item Loader</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.loader <span class="keyword">import</span> ItemLoader</span><br><span class="line"><span class="keyword">from</span> project.items <span class="keyword">import</span> Product</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">self, response</span>):</span></span><br><span class="line">loader = ItemLoader(item=Product(), response=response)</span><br><span class="line">loader.add_xpath(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;//div[@class=&quot;procuct_name&quot;]&#x27;</span>)</span><br><span class="line">loader.add_css(<span class="string">&#x27;stock&#x27;</span>, <span class="string">&#x27;p#stock&#x27;</span>)</span><br><span class="line">loader.add_value(<span class="string">&#x27;last_update&#x27;</span>, <span class="string">&#x27;today&#x27;</span>)</span><br><span class="line"><span class="keyword">return</span> loader.load_item()</span><br></pre></td></tr></table></figure>

<p>Item Loader æ¯ä¸ªå­—æ®µä¸­éƒ½åŒ…å«äº†ä¸€ä¸ª Input Processor(è¾“å…¥å¤„ç†å™¨) å’Œ ä¸€ä¸ª Output Processor(è¾“å‡ºå¤„ç†å™¨)</p>
<p>InputProcessor æ”¶åˆ°æ•°æ®æ—¶ç«‹åˆ»æå–æ•°æ®ï¼Œä¿å­˜åˆ° ItemLoader å†…ï¼Œä½†ä¸ä¼šåˆ†é…ç»™Item load_item è°ƒç”¨æ¥ç”Ÿæˆ Item å¯¹è±¡ã€‚è°ƒç”¨æ—¶ä¼šå…ˆè°ƒç”¨  Output Processor æ¥å¤„ç†ä¹‹å‰æ”¶é›†åˆ°çš„æ•°æ®ï¼Œç„¶ååœ¨å­˜å…¥ Item ä¸­</p>
<p>ä¸€äº›å†…ç½® Processor</p>
<ul>
<li>Identity</li>
</ul>
<p>æœ€ç®€å•çš„ Processorï¼Œä¸è¿›è¡Œä»»ä½•å¤„ç†ï¼Œç›´æ¥è¿”å›åŸæ¥çš„æ•°æ®</p>
<ul>
<li>TakeFirst</li>
</ul>
<p>è¿”å›åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªéç©ºå€¼ï¼Œç±»ä¼¼ extract_firs() çš„åŠŸèƒ½ï¼Œå¸¸ç”¨ä½œ Output Processor</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.loader.processor <span class="keyword">import</span> TakeFirst</span><br><span class="line">processor = TakeFirst()</span><br><span class="line">print([<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>]) </span><br><span class="line"><span class="comment">#ç»“æœï¼šè¾“å‡º 1</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Join</li>
</ul>
<p>ç›¸å½“äºå­—ç¬¦ä¸²çš„ join()æ–¹æ³•ï¼Œå¯ä»¥æŠŠåˆ—è¡¨æ‹¼åˆæˆå­—ç¬¦ä¸²ï¼Œå­—ç¬¦ä¸²é»˜è®¤ä½¿ç”¨ç©ºæ ¼åˆ†éš”</p>
<p>ä¹Ÿå¯ä»¥é€šè¿‡å‚æ•°æ›´æ”¹é»˜è®¤åˆ†éš”ç¬¦</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.loader.processor <span class="keyword">import</span> Join</span><br><span class="line">processor = Join()</span><br><span class="line">print(processor([<span class="string">&#x27;one&#x27;</span>, <span class="string">&#x27;two&#x27;</span>, <span class="string">&#x27;three&#x27;</span>]))</span><br><span class="line"><span class="comment">#ç»“æœï¼š one two three</span></span><br><span class="line">processor = Join(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line"><span class="comment">#ç»“æœï¼š one,two,three</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Compose</li>
</ul>
<p>æ˜¯ç”¨ç»™å®šçš„å¤šä¸ªå‡½æ•°çš„ç»„åˆè€Œæ„é€ çš„ Processorï¼Œæ¯ä¸ªè¾“å…¥å€¼è¢«ä¼ é€’åˆ°ç¬¬ä¸€ä¸ªå‡½æ•°ï¼Œå…¶è¾“å‡ºå†ä¼ é€’åˆ°ç¬¬äºŒä¸ªå‡½æ•°ï¼Œä¾æ¬¡ç±»æ¨ï¼ŒçŸ¥é“æœ€åä¸€ä¸ªå‡½æ•°è¿”å›æ•´ä¸ªå¤„ç†å™¨çš„è¾“å‡º</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.loader.processor <span class="keyword">import</span> Compose</span><br><span class="line">processor = Compose(<span class="built_in">str</span>.upper, <span class="keyword">lambda</span> s: s.strip())</span><br><span class="line">print(processor(<span class="string">&#x27; hello world&#x27;</span>))</span><br><span class="line"><span class="comment">#ç»“æœï¼šHELLO WORLD</span></span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸€ä¸ªå‚æ•° str.upperï¼Œç¬¬äºŒä¸ªæ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œstrip() æ–¹æ³•å»é™¤å¤´å°¾ç©ºç™½å­—ç¬¦ï¼ŒCompose ä¼šé¡ºæ¬¡è°ƒç”¨ä¸¤ä¸ªå‚æ•°</p>
<ul>
<li>MapCompose</li>
</ul>
<p>ä¸ Compose ç±»ä¼¼ï¼ŒMapComposeå¯ä»¥è¿­ä»£å¤„ç†ä¸€ä¸ªåˆ—è¡¨è¾“å…¥å€¼</p>
<p>è¢«å¤„ç†å¯¹è±¡æ˜¯ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.loader.processor <span class="keyword">import</span> MapCompose</span><br><span class="line">processor = MapCompose(<span class="built_in">str</span>.upper, <span class="keyword">lambda</span> s: s.strip())</span><br><span class="line">print(processor([<span class="string">&#x27;Hello&#x27;</span>, <span class="string">&#x27;world&#x27;</span>, <span class="string">&#x27;Python&#x27;</span>]))</span><br><span class="line"><span class="comment">#ç»“æœï¼š[&#x27;HELLO&#x27;, &#x27;WORLD&#x27;, &#x27;PYTHON&#x27;]</span></span><br></pre></td></tr></table></figure>

<ul>
<li>SelectJmes</li>
</ul>
<p>SelectJmes å¯ä»¥æŸ¥è¯¢ JSONï¼Œä¼ å…¥ Keyï¼Œè¿”å›æŸ¥è¯¢æ‰€å¾—åˆ°çš„ Valueï¼Œè¦å®‰è£… jmespath åº“</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install jmespath</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.loader.processor <span class="keyword">import</span> SelectJmes</span><br><span class="line">processor = SeleJme(<span class="string">&#x27;foo&#x27;</span>)</span><br><span class="line">print(processor(&#123;<span class="string">&#x27;foo&#x27;</span>: <span class="string">&#x27;bar&#x27;</span>&#125;))</span><br><span class="line"><span class="comment">#ç»“æœï¼šbar</span></span><br></pre></td></tr></table></figure>





<h5 id="çˆ¬å–ä¸­åç½‘ç§‘æŠ€ç±»æ–°é—»"><a href="#çˆ¬å–ä¸­åç½‘ç§‘æŠ€ç±»æ–°é—»" class="headerlink" title="çˆ¬å–ä¸­åç½‘ç§‘æŠ€ç±»æ–°é—»"></a>çˆ¬å–ä¸­åç½‘ç§‘æŠ€ç±»æ–°é—»</h5><p><a target="_blank" rel="noopener" href="https://tech.china.com/articles/">https://tech.china.com/articles/</a> çˆ¬å–æ–°é—»åˆ—è¡¨ä¸­æ‰€æœ‰åˆ†é¡µçš„æ–°é—»è¯¦æƒ…ï¼ŒåŒ…æ‹¬æ ‡é¢˜ã€æ­£æ–‡ã€æ—¶é—´ã€æ¥æº</p>
<h6 id="æ–°å»ºé¡¹ç›®"><a href="#æ–°å»ºé¡¹ç›®" class="headerlink" title="æ–°å»ºé¡¹ç›®"></a>æ–°å»ºé¡¹ç›®</h6><p>æ–°å»º Scrapy é¡¹ç›®ï¼Œåä¸º scrapyuniversal</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy startproject scrapyuniversal</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºä¸€ä¸ª CrawlSpiderï¼Œéœ€è¦å…ˆæŒ‡å®šä¸€ä¸ªæ¨¡æ¿ï¼Œçœ‹çœ‹å“ªäº›æ¨¡æ¿å¯ç”¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">scrapy genspider -l</span><br><span class="line">#è¿è¡Œç»“æœ</span><br><span class="line">Available templates:</span><br><span class="line">  basic</span><br><span class="line">  crawl</span><br><span class="line">  csvfeed</span><br><span class="line">  xmlfeed</span><br></pre></td></tr></table></figure>

<p>åˆ›å»º Spider çš„æ—¶å€™é»˜è®¤ä½¿ç”¨äº†ç¬¬ä¸€ä¸ªæ¨¡æ¿ basicï¼Œè¦åˆ›å»º CrawlSpider é€‰æ‹© crawl æ¨¡æ¿</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy genspider -t crawl china tech.china.com</span><br></pre></td></tr></table></figure>

<p>ç”Ÿæˆçš„ Spider å†…å®¹å¤šäº†ä¸€ä¸ª rulesï¼Œå›è°ƒå‡½æ•°ä¸å†æ˜¯ parseï¼Œè€Œæ˜¯ parse_item</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rules = (</span><br><span class="line">    Rule(LinkExtractor(allow=<span class="string">r&#x27;Items/&#x27;</span>), callback=<span class="string">&#x27;parse_item&#x27;</span>, follow=<span class="literal">True</span>),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h6 id="å®šä¹‰-Rule"><a href="#å®šä¹‰-Rule" class="headerlink" title="å®šä¹‰ Rule"></a>å®šä¹‰ Rule</h6><p>è¦å®ç°æ–°é—»çš„çˆ¬å–ï¼Œéœ€è¦åšçš„å°±æ˜¯å®šä¹‰å¥½ Ruleï¼Œç„¶åå®ç°è§£æå‡½æ•°</p>
<p>ä¿®æ”¹ start_urls </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start_urls = [<span class="string">&#x27;http://tech.china.com/articles/&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>Spider çˆ¬å– start_urls é‡Œçš„æ¯ä¸€ä¸ªé“¾æ¥ï¼Œå¾—åˆ° Response ä¹‹åï¼ŒSpider å°±ä¼šæ ¹æ® Rule é‡Œæ¥æå–è¿™ä¸ªé¡µé¢å†…çš„è¶…é“¾æ¥ï¼Œå»ç”Ÿæˆè¿›ä¸€æ­¥çš„ Requestï¼Œæ¥ä¸‹æ¥å®šä¹‰ Rule æ¥æŒ‡å®šæå–å“ªäº›é“¾æ¥</p>
<p>å°†æ–°é—»åˆ—è¡¨ä¸­æ¯æ¡æ–°é—»çš„è¯¦æƒ…é“¾æ¥æå–å‡ºæ¥</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;wntjItem item_defaultView clearfix&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;item_con&quot;</span> <span class="attr">style</span>=<span class="string">&quot;margin-left: 0px;&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;item-con-inner&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span> <span class="attr">class</span>=<span class="string">&quot;tit&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://tech.china.com/article/20220224/202202241016344.html&quot;</span> <span class="attr">target</span>=<span class="string">&quot;_blank&quot;</span>&gt;</span>ä¸–ç•Œé¦–å°é‡å­é‡åŠ›ä»ªâ€œèµ°å‡ºå®éªŒå®¤â€ï¼Œå¯¹å­¦ç•Œã€ä¸šç•Œå’Œå›½å®¶å®‰å…¨ç­‰å°†å…·æœ‰æ·±è¿œå½±å“<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;item_foot&quot;</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;time&quot;</span>&gt;</span>2022-02-24 05:59<span class="tag">&lt;/<span class="name">span</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;tag&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span> <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;item_num&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;s-nub&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥ç”¨ LinkExtractor çš„ restrict_xpaths å±æ€§æ¥æŒ‡å®šï¼Œä¹‹å Spider å°±ä¼šä»è¿™ä¸ªåŒºåŸŸæå–æ‰€æœ‰è¶…é“¾æ¥ç”Ÿæˆ Requestã€‚</p>
<p>ä½†æ˜¯æ¯ç¯‡æ–‡ç« çš„å¯¼èˆªä¸­å¯èƒ½è¿˜æœ‰ä¸€äº›å…¶å®ƒè¶…é“¾æ¥æ ‡ç­¾ï¼Œæˆ‘ä»¬åªéœ€è¦æ–°é—»çš„è¶…é“¾æ¥ï¼ŒçœŸæ­£æ–°é—»è¶…é“¾æ¥è·¯å¾„éƒ½æ˜¯ä»¥articleå¼€å¤´çš„ï¼Œç”¨ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼å°†å…¶åŒ¹é…å‡ºæ¥å†èµ‹å€¼ç»™ allow å³å¯ï¼Œè¿˜éœ€è¦æŒ‡å®šä¸€ä¸ªå›è°ƒå‡½æ•° callback</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rules = (</span><br><span class="line">  Rule(LinkExtractor(allow=<span class="string">&#x27;article\/.*\.html&#x27;</span>, restrict_xpaths=<span class="string">&#x27;//[@id=&quot;rank-defList&quot;]//[@class=&quot;tit&quot;]&#x27;</span>), callback=<span class="string">&#x27;parse_item&#x27;</span>, follow=<span class="literal">True</span>),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>è¿˜è¦è®©å½“å‰é¡µé¢å®ç°åˆ†é¡µåŠŸèƒ½ï¼Œæ‰€ä»¥è¿˜éœ€è¦æå–ä¸‹ä¸€é¡µçš„é“¾æ¥</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;pages&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;a1&quot;</span>&gt;</span>12219æ¡<span class="tag">&lt;/<span class="name">a</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://tech.china.com/articles/index.html&quot;</span> <span class="attr">class</span>=<span class="string">&quot;a1&quot;</span>&gt;</span>ä¸Šä¸€é¡µ<span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;<span class="name">span</span>&gt;</span>1<span class="tag">&lt;/<span class="name">span</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://tech.china.com/articles/index_2.html&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">a</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://tech.china.com/articles/index_9.html&quot;</span>&gt;</span>9<span class="tag">&lt;/<span class="name">a</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://tech.china.com/articles/index_10.html&quot;</span>&gt;</span>10<span class="tag">&lt;/<span class="name">a</span>&gt;</span> ..</span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://tech.china.com/articles/index_489.html&quot;</span>&gt;</span>489<span class="tag">&lt;/<span class="name">a</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://tech.china.com/articles/index_2.html&quot;</span> <span class="attr">class</span>=<span class="string">&quot;a1&quot;</span>&gt;</span>ä¸‹ä¸€é¡µ<span class="tag">&lt;/<span class="name">a</span>&gt;</span>	</span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>å†åŠ ä¸€ä¸ª Rule</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rule(LinkExtractor(restrict_xpaths=<span class="string">&#x27;//div[@class=&quot;pages&quot;]//a[contains(., &quot;ä¸‹ä¸€é¡µ&quot;)]&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>ä¸éœ€è¦åƒæ–°é—»è¯¦æƒ…é¡µä¸€æ ·å»æå–é¡µé¢è¯¦ç»†ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯ä¸éœ€è¦ç”Ÿæˆ Itemï¼Œæ‰€ä»¥ä¸éœ€è¦åŠ  callback å‚æ•°</p>
<p>æ¥ç€è¿è¡Œä»£ç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapy crawl china</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹è¾“å‡ºï¼Œå®ç°äº†ç¿»é¡µå’Œè¯¦æƒ…é¡µçš„æŠ“å–äº†</p>
<h6 id="è§£æé¡µé¢-1"><a href="#è§£æé¡µé¢-1" class="headerlink" title="è§£æé¡µé¢"></a>è§£æé¡µé¢</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_item</span>(<span class="params">self, response</span>):</span></span><br><span class="line">    loader = ChinaLoader(item=NewsItem(), response=response)</span><br><span class="line">    loader.add_xpath(<span class="string">&#x27;title&#x27;</span>, <span class="string">&#x27;//h1[@id=&quot;chan_newsTitle&quot;]/text()&#x27;</span>)</span><br><span class="line">    loader.add_value(<span class="string">&#x27;url&#x27;</span>, response.url)</span><br><span class="line">    loader.add_xpath(<span class="string">&#x27;text&#x27;</span>, <span class="string">&#x27;//div[@id=&quot;chan_newsDetail&quot;]/text()&#x27;</span>)</span><br><span class="line">    loader.add_xpath(<span class="string">&#x27;datetime&#x27;</span>, <span class="string">&#x27;//div[@id=&quot;chan_newsInfo&quot;]//*[@class=&quot;time&quot;]/text()&#x27;</span>,re=<span class="string">&#x27;(\d+-\d+-\d+\s\d+:\d+:\d+)&#x27;</span>)</span><br><span class="line">    loader.add_xpath(<span class="string">&#x27;source&#x27;</span>, <span class="string">&#x27;//div[@id=&quot;chan_newsInfo&quot;]//*[@class=&quot;source&quot;]/text()&#x27;</span>, re=<span class="string">&#x27;æ¥æºï¼š(.*)&#x27;</span>)</span><br><span class="line">    loader.add_value(<span class="string">&#x27;website&#x27;</span>, <span class="string">&#x27;ä¸­åç½‘&#x27;</span>)</span><br><span class="line">    <span class="keyword">yield</span> loader.load_item()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.loader <span class="keyword">import</span> ItemLoader</span><br><span class="line"><span class="keyword">from</span> scrapy.loader.processors <span class="keyword">import</span> TakeFirst, Join, Compose</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NewsLoader</span>(<span class="params">ItemLoader</span>):</span></span><br><span class="line">  default_output_processor = TakeFirst()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChinaLoader</span>(<span class="params">NewsLoader</span>):</span></span><br><span class="line">  text_out = Compose(Join(), <span class="keyword">lambda</span> s: s.strip()) <span class="comment">#æŠŠåˆ—è¡¨æ‹¼åˆæˆä¸€ä¸ªå­—ç¬¦ä¸²</span></span><br><span class="line">  source_out = Compose(Join(), <span class="keyword">lambda</span> s: s.strip())</span><br></pre></td></tr></table></figure>

<h6 id="é€šç”¨é…ç½®æŠ½å–"><a href="#é€šç”¨é…ç½®æŠ½å–" class="headerlink" title="é€šç”¨é…ç½®æŠ½å–"></a>é€šç”¨é…ç½®æŠ½å–</h6><h4 id="13-11-Scrapyt"><a href="#13-11-Scrapyt" class="headerlink" title="13.11 Scrapyt"></a>13.11 Scrapyt</h4><p>Scrapyt ä¸º Scrapy æä¾›äº†ä¸€ä¸ªè°ƒåº¦çš„ HTTP æ¥å£ï¼Œæœ‰äº†å®ƒå°±ä¸éœ€è¦å†æ‰§è¡Œ Scrapy å‘½ä»¤ï¼Œè€Œæ˜¯é€šè¿‡è¯·æ±‚ä¸€ä¸ª HTTP æ¥å£å³å¯è°ƒåº¦ Scrapy ä»»åŠ¡ï¼Œå¦‚æœé¡¹ç›®æ˜¯åœ¨è¿œç¨‹æœåŠ¡å™¨è¿è¡Œï¼Œå¯ä»¥åˆ©ç”¨å®ƒæ¥å¯åŠ¨é¡¹ç›®</p>
<h5 id="GET-è¯·æ±‚"><a href="#GET-è¯·æ±‚" class="headerlink" title="GET è¯·æ±‚"></a>GET è¯·æ±‚</h5><p>æ”¯æŒå¦‚ä¸‹å‚æ•°</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">spider_nameï¼šSpider åç§°</span></span><br><span class="line"><span class="string">urlï¼šçˆ¬å–é“¾æ¥ï¼Œå¦‚æœä¼ é€’äº†è¯¥å‚æ•°ï¼ŒScrapyä¼šç›´æ¥ä½¿ç”¨è¯¥URLç”ŸæˆRequestï¼Œè€Œç›´æ¥å¿½ç•¥start_requests()æ–¹æ³•å’Œstart_urlså±æ€§çš„å®šä¹‰</span></span><br><span class="line"><span class="string">callbackï¼šå›è°ƒå‡½æ•°åç§°</span></span><br><span class="line"><span class="string">max_requestsï¼šæœ€å¤§è¯·æ±‚æ•°é‡ï¼Œå¯é€‰ï¼Œå¦‚å®šä¹‰5ï¼Œè¡¨ç¤ºæœ€å¤šæ‰§è¡Œ5æ¬¡Requestè¯·æ±‚ï¼Œå…¶ä½™ä¼šè¢«å¿½ç•¥</span></span><br><span class="line"><span class="string">start_requestsï¼šæ˜¯å¦è¦æ‰§è¡Œstart_requestsæ–¹æ³•ï¼Œå¸ƒå°”ç±»å‹ï¼Œå¯é€‰ï¼ŒScrapyé¡¹ç›®ä¸­å¦‚æœå®šä¹‰äº†start_requestsæ–¹æ³•ï¼Œé¡¹ç›®å¯åŠ¨æ—¶ä¼šé»˜è®¤è°ƒç”¨è¯¥æ–¹æ³•ï¼ŒScrapyrtä¸­å°±ä¸ä¸€æ ·ï¼Œé»˜è®¤ä¸æ‰§è¡Œstart_requestsæ–¹æ³•ï¼Œå¦‚æœè¦æ‰§è¡Œstart_requestsï¼Œè®¾ç½®ä¸ºtrue</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>åœ¨é¡¹ç›®ç›®å½•ä¸‹è¿è¡Œ Scrapyrtï¼Œé»˜è®¤æœåŠ¡è¿è¡Œåœ¨ 9080 ç«¯å£ä¸Š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:9080&#x2F;crawl.json\?spider_name\&#x3D;china\&amp;url\&#x3D;http:&#x2F;&#x2F;tech.china.com&#x2F;articles&#x2F;</span><br></pre></td></tr></table></figure>

<p>ä¼šè¿”å›ä¸€ä¸ª JSON æ ¼å¼ï¼Œstatus æ˜¾ç¤ºäº†çˆ¬å–çŠ¶æ€ï¼Œitems éƒ¨åˆ†æ˜¯é¡¹ç›®çš„çˆ¬å–ç»“æœï¼Œstats æ˜¯çˆ¬å–çš„ç»Ÿè®¡æƒ…å†µï¼Œitems_dropped æ˜¯è¢«å¿½ç•¥çš„ Item åˆ—è¡¨</p>
<h5 id="POST-è¯·æ±‚"><a href="#POST-è¯·æ±‚" class="headerlink" title="POST è¯·æ±‚"></a>POST è¯·æ±‚</h5><p>Request Body å¿…é¡»æ˜¯ä¸€ä¸ªåˆæ³•çš„JSONé…ç½®ï¼ŒJSONé‡Œé¢å¯ä»¥é…ç½®å“åº”çš„å‚æ•°</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">spider_name</span></span><br><span class="line"><span class="string">max_requests</span></span><br><span class="line"><span class="string">request: Requesté…ç½®ï¼ŒJSONå¯¹è±¡ï¼Œå¿…ä¼ å‚æ•°ï¼Œé€šè¿‡è¯¥å‚æ•°å¯ä»¥å®šä¹‰Requestçš„å„ä¸ªå‚æ•°ï¼Œå¿…é¡»æŒ‡å®šurlå­—æ®µæŒ‡å®šçˆ¬å–é“¾æ¥,å…¶å®ƒå‚æ•°å¯é€‰</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>JSONé…ç½®å®ä¾‹</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;request&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;http://quotes.toscrape.com/&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;callback&quot;</span>: <span class="string">&quot;parse&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dont_filter&quot;</span>: <span class="string">&quot;True&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;cookies&quot;</span>:&#123;</span><br><span class="line">      <span class="attr">&quot;foo&quot;</span>: <span class="string">&quot;bar&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;max_requests&quot;</span>:<span class="number">2</span>,</span><br><span class="line">  <span class="attr">&quot;spider_name&quot;</span>:quotes</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œä¸‹é¢å‘½ä»¤ä¼ é€’è¯¥JSONé…ç½®å¹¶å‘èµ·POSTè¯·æ±‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;localhost:9080&#x2F;crawl.json -d &#39;&#123;&quot;requests&quot;...JSONå­—ç¬¦ä¸²&#125;&#39;</span><br></pre></td></tr></table></figure>

<h4 id="Scrapyå¯¹æ¥Docker"><a href="#Scrapyå¯¹æ¥Docker" class="headerlink" title="Scrapyå¯¹æ¥Docker"></a>Scrapyå¯¹æ¥Docker</h4><p>æŠŠ Scrapy é¡¹ç›®åˆ¶ä½œæˆä¸€ä¸ª Docker é•œåƒï¼Œåªè¦å…¶å®ƒä¸»æœºå®‰è£…äº† Dockerï¼Œé‚£ä¹ˆåªè¦å°†é•œåƒä¸‹è½½å¹¶è¿è¡Œå³å¯ï¼Œè€Œä¸å¿…æ‹…å¿ƒç¯å¢ƒé—®é¢˜æˆ–ç‰ˆæœ¬é—®é¢˜</p>
<h5 id="åˆ›å»ºDockerfile"><a href="#åˆ›å»ºDockerfile" class="headerlink" title="åˆ›å»ºDockerfile"></a>åˆ›å»ºDockerfile</h5><p>é¡¹ç›®æ ¹ç›®å½•ä¸‹æ–°å»º requirements.txtï¼Œå°†æ•´ä¸ªé¡¹ç›®ä¾èµ–çš„ Python ç¯å¢ƒåŒ…éƒ½åˆ—å‡ºæ¥ï¼Œå¦‚</p>
<p>å¦‚æœåº“éœ€è¦ç‰¹å®šçš„ç‰ˆæœ¬ï¼Œè¿˜å¯ä»¥æŒ‡å®šç‰ˆæœ¬å·</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">scrapy</span><br><span class="line">pymongo</span><br><span class="line">scrapy&gt;&#x3D;1.4.0</span><br><span class="line">pymongo&gt;&#x3D;3.4.0</span><br></pre></td></tr></table></figure>

<p>æ ¹ç›®å½•ä¸‹æ–°å»º Dockerfile æ²¡æœ‰åç¼€ï¼Œä¿®æ”¹å†…å®¹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FROM python:3.8 </span><br><span class="line">ENV PATH &#x2F;usr&#x2F;local&#x2F;bin:$PATH</span><br><span class="line">ADD . &#x2F;code</span><br><span class="line">WORKDIR &#x2F;code</span><br><span class="line">RUN pip3.8 install -r requirements.txt</span><br><span class="line">CMD scrapy crawl china</span><br><span class="line">#ç¬¬ä¸€è¡ŒFromä»£è¡¨ä½¿ç”¨ Docker åŸºç¡€é•œåƒï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨ python:3.8çš„é•œåƒï¼Œåœ¨æ­¤åŸºç¡€ä¸Šè¿è¡Œé¡¹ç›®</span><br><span class="line">#ç¬¬äºŒè¡ŒENVæ˜¯ç¯å¢ƒå˜é‡è®¾ç½®ï¼Œå¢åŠ &#x2F;usr&#x2F;local&#x2F;binè¿™ä¸ªç¯å¢ƒå˜é‡è·¯å¾„</span><br><span class="line">#ç¬¬ä¸‰è¡ŒADDæ˜¯å°†æœ¬åœ°çš„ä»£ç æ”¾ç½®åˆ°è™šæ‹Ÿå®¹å™¨ä¸­ .æœ¬åœ°å½“å‰è·¯å¾„ &#x2F;codeä»£è¡¨è™šæ‹Ÿå®¹å™¨ä¸­çš„è·¯å¾„</span><br><span class="line">#ç¬¬å››è¡ŒWORKDIRæ˜¯æŒ‡å®šå·¥ä½œç›®å½•ï¼Œè¿™é‡Œå°†åˆšæ·»åŠ çš„ä»£ç è·¯å¾„è®¾ç½®æˆå·¥ä½œè·¯å¾„</span><br><span class="line">#ç¬¬äº”è¡ŒRUNæ˜¯æ‰§è¡ŒæŸäº›å‘½ä»¤æ¥åšä¸€äº›ç¯å¢ƒå‡†å¤‡å·¥ä½œ</span><br><span class="line">#ç¬¬å…­è¡ŒCMDæ˜¯å®¹å™¨å¯åŠ¨å‘½ä»¤ï¼Œå®¹å™¨è¿è¡Œæ—¶ï¼Œæ­¤å‘½ä»¤ä¼šè¢«æ‰§è¡Œ</span><br></pre></td></tr></table></figure>

<h5 id="æ„å»ºé•œåƒ"><a href="#æ„å»ºé•œåƒ" class="headerlink" title="æ„å»ºé•œåƒ"></a>æ„å»ºé•œåƒ</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t china:latest .</span><br></pre></td></tr></table></figure>

<p>æ„å»ºæˆåŠŸåï¼ŒæŸ¥çœ‹é•œåƒ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br><span class="line">#china latest 41c797934ce 2 minutes ago 768M</span><br></pre></td></tr></table></figure>

<h5 id="è¿è¡Œ-1"><a href="#è¿è¡Œ-1" class="headerlink" title="è¿è¡Œ"></a>è¿è¡Œ</h5><p>é•œåƒå¯ä»¥æœ¬åœ°æµ‹è¯•è¿è¡Œï¼Œè¿™æ ·å°±åˆ©ç”¨æ­¤é•œåƒæ–°å»ºå¹¶è¿è¡Œäº†ä¸€ä¸ª Docker å®¹å™¨ï¼Œè¿è¡Œæ•ˆæœå®Œå…¨ä¸€è‡´</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run china</span><br></pre></td></tr></table></figure>

<h5 id="æ¨é€è‡³-Docker-Hub"><a href="#æ¨é€è‡³-Docker-Hub" class="headerlink" title="æ¨é€è‡³ Docker Hub"></a>æ¨é€è‡³ Docker Hub</h5><p>æ„å»ºå®Œæˆåï¼Œå¯ä»¥å°†é•œåƒ Push åˆ° Docker é•œåƒæ‰˜ç®¡å¹³å°ï¼ŒDocker Hub æˆ–è€…ç§æœ‰çš„ Docker Registry ç­‰ï¼Œè¿™æ ·å°±å¯ä»¥ä»è¿œç¨‹æœåŠ¡å™¨ä¸‹è½½é•œåƒå¹¶è¿è¡Œäº†</p>
<p><a target="_blank" rel="noopener" href="https://hub.docker.com/">https://hub.docker.com</a> æ³¨å†Œè´¦å·ï¼Œæ–°å»ºä¸€ä¸ª Reponsitoryï¼Œåä¸º quotesï¼Œæ¯”å¦‚ç”¨æˆ·åä¸º germeyï¼Œé‚£ä¹ˆæ­¤ Reponsitory çš„åœ°å€å°±å¯ä»¥ç”¨ germey/quotes æ¥è¡¨ç¤º</p>
<p>æ‰“æ ‡ç­¾ï¼Œæ¨é€é•œåƒåˆ° Docker Hub</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker tag quotes:latest germey&#x2F;quotes:latest</span><br><span class="line">docker push germey&#x2F;quotes</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæˆ‘ä»¬æƒ³åœ¨å…¶ä»–çš„ä¸»æœºä¸Šè¿è¡Œè¿™ä¸ªé•œåƒï¼Œä¸»æœºä¸Šè£…å¥½ Docker åï¼Œè¿è¡Œå‘½ä»¤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run germey&#x2F;quotes</span><br></pre></td></tr></table></figure>

<p>ä¼šè‡ªåŠ¨ä¸‹è½½é•œåƒï¼Œå¯åŠ¨å®¹å™¨è¿è¡Œï¼Œä¸éœ€è¦é…ç½® Python ç¯å¢ƒï¼Œä¸éœ€è¦å…³ç³»ç‰ˆæœ¬å†²çªçš„é—®é¢˜</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/19/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-pyspider%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="ç®€å•è®°å½•ä¸‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/19/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-pyspider%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-pyspideræ¡†æ¶ä½¿ç”¨</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>
      

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-04-19 14:16:09 / ä¿®æ”¹æ—¶é—´ï¼š17:56:05" itemprop="dateCreated datePublished" datetime="2022-04-19T14:16:09+08:00">2022-04-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>pyspider å®˜æ–¹æ–‡æ¡£ <a target="_blank" rel="noopener" href="http://docs.pyspider.org/">http://docs.pyspider.org/</a></p>
<h4 id="åŸºæœ¬åŠŸèƒ½"><a href="#åŸºæœ¬åŠŸèƒ½" class="headerlink" title="åŸºæœ¬åŠŸèƒ½"></a>åŸºæœ¬åŠŸèƒ½</h4><p>æä¾›æ–¹ä¾¿æ˜“ç”¨çš„WebUIç³»ç»Ÿï¼Œå¯è§†åŒ–ç¼–å†™å’Œè°ƒè¯•çˆ¬è™«</p>
<p>æä¾›çˆ¬å–è¿›åº¦ç›‘æ§ã€çˆ¬å–ç»“æœæŸ¥çœ‹ã€çˆ¬è™«é¡¹ç›®ç®¡ç†ç­‰åŠŸèƒ½</p>
<p>æ”¯æŒå¤šç§åç«¯æ•°æ®åº“ï¼Œå¦‚MySQLã€MongoDBã€Redisã€SQLite</p>
<p>æ”¯æŒå¤šç§æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¦‚RabbitMQã€Beanstalkã€Redisã€Kombu</p>
<p>æä¾›ä¼˜å…ˆçº§æ§åˆ¶ã€å¤±è´¥é‡è¯•ã€å®šæ—¶æŠ“å–ç­‰åŠŸèƒ½</p>
<p>å¯¹æ¥äº† PhantomJSï¼Œå¯ä»¥æŠ“å– JavaScript æ¸²æŸ“çš„é¡µé¢</p>
<p>æ”¯æŒå•æœºå’Œåˆ†å¸ƒå¼éƒ¨ç½²ï¼Œæ”¯æŒ Docker éƒ¨ç½²</p>
<p>pyspid æä¾›äº† WebUIï¼Œçˆ¬è™«çš„ç¼–å†™ã€è°ƒè¯•éƒ½æ˜¯åœ¨ WebUI ä¸­è¿›è¡Œçš„ï¼Œå¦‚æœè¦å¿«é€Ÿå®ç°ä¸€ä¸ªé¡µé¢çš„æŠ“å–ï¼Œä½¿ç”¨pyspider</p>
<h5 id="pyspider-æ¶æ„"><a href="#pyspider-æ¶æ„" class="headerlink" title="pyspider æ¶æ„"></a>pyspider æ¶æ„</h5><p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-pyspider%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/WeChataffa8b62cf8bf792b16728f4f46c0065.png" alt="WeChataffa8b62cf8bf792b16728f4f46c0065"></p>
<p>æ¯ä¸ª pyspider é¡¹ç›®å¯¹åº”ä¸€ä¸ª Python è„šæœ¬ï¼Œè„šæœ¬ä¸­å®šä¹‰äº†ä¸€ä¸ª Handler ç±»ï¼Œå®ƒæœ‰ä¸€ä¸ª on_start() æ–¹æ³•ï¼Œçˆ¬å–é¦–å…ˆè°ƒç”¨ no_start() æ–¹æ³•ç”Ÿæˆæœ€åˆçš„æŠ“å–ä»»åŠ¡ï¼Œç„¶åå‘é€ç»™ Scheduler è¿›è¡Œè°ƒåº¦</p>
<p>Scheduler å°†æŠ“å–ä»»åŠ¡åˆ†å‘ç»™ Fetcher è¿›è¡ŒæŠ“å–ï¼ŒFetcher æ‰§è¡Œå¹¶å¾—åˆ°å“åº”ï¼Œéšåå°†å“åº”å‘é€ç»™ Processer</p>
<p>Processer å¤„ç†å“åº”å¹¶æå–å‡ºæ–°çš„ URL ç”Ÿæˆæ–°çš„æŠ“å–ä»»åŠ¡ï¼Œç„¶åé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—çš„æ–¹å¼é€šçŸ¥ Scheduler å½“å‰ä»»åŠ¡æŠ“å–æ‰§è¡Œæƒ…å†µï¼Œå¹¶å°†æ–°ç”Ÿæˆçš„æŠ“å–ä»»åŠ¡å‘é€ç»™ Schedulerï¼Œå¦‚æœç”Ÿæˆäº†æ–°çš„æå–ç»“æœï¼Œåˆ™å°†å…¶å‘é€åˆ°ç»“æœé˜Ÿåˆ—ç­‰å¾… Result Worker å¤„ç†</p>
<p>Scheduler æ¥æ”¶åˆ°æ–°çš„æŠ“å–ä»»åŠ¡ï¼Œç„¶åæŸ¥è¯¢æ•°æ®åº“ï¼Œåˆ¤æ–­å…¶å¦‚æœæ˜¯æ–°çš„æŠ“å–ä»»åŠ¡æˆ–è€…æ˜¯éœ€è¦é‡è¯•çš„ä»»åŠ¡å°±ç»§ç»­è¿›è¡Œè°ƒåº¦ï¼Œç„¶åå°†å…¶å‘é€å› Fetcher è¿›è¡ŒæŠ“å–</p>
<p>ä¸æ–­é‡å¤ä»¥ä¸Šå·¥ä½œï¼Œç›´åˆ°æ‰€æœ‰çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•ï¼ŒæŠ“å–ç»“æŸ</p>
<p>æŠ“å–ç»“æŸåï¼Œç¨‹åºä¼šå›è°ƒ on_finished() æ–¹æ³•</p>
<h4 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h4><h5 id="å¯åŠ¨-pyspider"><a href="#å¯åŠ¨-pyspider" class="headerlink" title="å¯åŠ¨ pyspider"></a>å¯åŠ¨ pyspider</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyspider all</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å¯ä»¥å¯åŠ¨ pyspider çš„æ‰€æœ‰ç»„ä»¶ï¼Œæœ€åä¸€è¡Œè¾“å‡ºæç¤º WebUI è¿è¡Œåœ¨ 5000 ç«¯å£ä¸Šï¼Œè¾“å…¥ <a target="_blank" rel="noopener" href="http://localhost:5000/">http://localhost:5000</a> å¯ä»¥çœ‹åˆ° pyspider çš„ WebUI é¡µé¢ï¼Œå¯ä»¥ç”¨å®ƒæ¥ç®¡ç†é¡¹ç›®ã€ç¼–å†™ä»£ç ã€åœ¨çº¿è°ƒè¯•ã€ç›‘æ§ä»»åŠ¡</p>
<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-pyspider%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/WeChat941a660af574ca4e9a6f69c141140d7c.png" alt="WeChat941a660af574ca4e9a6f69c141140d7c"></p>
<h5 id="åˆ›å»ºé¡¹ç›®"><a href="#åˆ›å»ºé¡¹ç›®" class="headerlink" title="åˆ›å»ºé¡¹ç›®"></a>åˆ›å»ºé¡¹ç›®</h5><p>ç‚¹å‡»å³è¾¹çš„ Create æŒ‰é’®ï¼Œå¼¹å‡ºçš„æµ®çª—è¾“å…¥é¡¹ç›®åç§°å’Œçˆ¬å–çš„é“¾æ¥</p>
<p>æ¥ä¸‹æ¥å°±çœ‹åˆ° pyspider é¡¹ç›®ç¼–è¾‘å’Œè°ƒè¯•é¡µé¢</p>
<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-pyspider%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/WeChat3425c6583da1e0405c27d3f40dce8510.png" alt="WeChat3425c6583da1e0405c27d3f40dce8510"></p>
<p>å·¦ä¾§å°±æ˜¯ä»£ç çš„è°ƒè¯•é¡µé¢ï¼Œç‚¹å‡»å·¦ä¾§å³ä¸Šè§’çš„ run å•æ­¥è°ƒè¯•çˆ¬è™«ç¨‹åºï¼Œå·¦ä¾§ä¸‹åŠéƒ¨åˆ†å¯ä»¥é¢„è§ˆå½“å‰çš„çˆ¬å–é¡µé¢</p>
<p>å³ä¾§æ˜¯ä»£ç ç¼–è¾‘é¡µé¢ï¼Œå¯ä»¥ç›´æ¥ç¼–è¾‘ä»£ç å’Œä¿å­˜ä»£ç ï¼Œä¸éœ€è¦å€ŸåŠ© IDE</p>
<p>ç”Ÿæˆçš„ä»£ç </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pyspider.libs.base_handler <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handler</span>(<span class="params">BaseHandler</span>):</span></span><br><span class="line">  crawl_config = &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">  @every(minutes=24 * 60)</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">on_start</span>(<span class="params">self</span>):</span></span><br><span class="line">    	<span class="comment">#æ–°å»ºçˆ¬å–è¯·æ±‚</span></span><br><span class="line">      <span class="comment">#ï¼ˆçˆ¬å–URLï¼ŒæŒ‡å®šçˆ¬å–æˆåŠŸè§£ææ–¹æ³•ï¼‰</span></span><br><span class="line">      self.crawl(<span class="string">&#x27;http://travel.qunar.com/travelbook/list.htm&#x27;</span>, callback=self.index_page)</span><br><span class="line"></span><br><span class="line"><span class="meta">  @config(age=10 * 24 * 60 * 60)</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">index_page</span>(<span class="params">self, response</span>):</span></span><br><span class="line">      <span class="keyword">for</span> each <span class="keyword">in</span> response.doc(<span class="string">&#x27;a[href^=&quot;http&quot;]&#x27;</span>).items():</span><br><span class="line">          self.crawl(each.attr.href, callback=self.detail_page)</span><br><span class="line"></span><br><span class="line"><span class="meta">  @config(priority=2)</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">detail_page</span>(<span class="params">self, response</span>):</span></span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">          <span class="string">&quot;url&quot;</span>: response.url,</span><br><span class="line">          <span class="string">&quot;title&quot;</span>: response.doc(<span class="string">&#x27;title&#x27;</span>).text(),</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>Handler å°±æ˜¯ pyspider çˆ¬è™«çš„ä¸»ç±»ï¼Œå¯ä»¥åœ¨è¿™é‡Œå®šä¹‰çˆ¬å–ã€è§£æã€å­˜å‚¨çš„é€»è¾‘ï¼Œæ•´ä¸ªçˆ¬è™«çš„åŠŸèƒ½åªéœ€è¦ä¸€ä¸ª Handler å³å¯å®Œæˆ</p>
<p>crawl_configï¼šå°†é¡¹ç›®æ‰€æœ‰çˆ¬å–é…ç½®ç»Ÿä¸€å®šä¹‰åˆ°è¿™é‡Œï¼Œå¦‚ Headersã€ä»£ç†ç­‰ï¼Œé…ç½®åå…¨å±€ç”Ÿæ•ˆ</p>
<p>on_start()ï¼šçˆ¬å–å…¥å£ï¼Œåˆå§‹çš„çˆ¬å–è¯·æ±‚åœ¨è¿™é‡Œäº§ç”Ÿï¼Œé€šè¿‡ crawl() æ–¹æ³•å³å¯æ–°å»ºä¸€ä¸ªçˆ¬å–è¯·æ±‚ï¼Œç¬¬ä¸€ä¸ªå‚æ•°çˆ¬å– URLï¼Œç¬¬äºŒä¸ªå‚æ•° callbackï¼ŒæŒ‡å®šçˆ¬å–æˆåŠŸåå“ªä¸ªæ–¹æ³•è¿›è¡Œè§£æ</p>
<p>index_page()ï¼šæ¥æ”¶ Response å‚æ•°ï¼ŒResponse å¯¹æ¥äº† pyqueryï¼Œç›´æ¥è°ƒç”¨ doc() æ–¹æ³•ä¼ å…¥ç›¸åº”çš„ CSS é€‰æ‹©å™¨ï¼Œå°±å¯ä»¥åƒ pyquery ä¸€æ ·è§£ææ­¤é¡µé¢ï¼Œä¸Šé¢ä»£ç é»˜è®¤ <code>a[href=^=&quot;http&quot;]</code> ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥æ–¹æ³•è§£æäº†é¡µé¢çš„æ‰€æœ‰é“¾æ¥ï¼Œç„¶åå°†é“¾æ¥éå†ï¼Œå†æ¬¡è°ƒç”¨ crawl() æ–¹æ³•ç”Ÿæˆæ–°çš„çˆ¬å–è¯·æ±‚ï¼ŒåŒæ—¶æŒ‡å®š callback ä¸º detail_page è§£æ</p>
<p>detail_page()ï¼šåŒæ ·æ¥æ”¶ Response ä½œä¸ºå‚æ•°ï¼ŒæŠ“å–çš„å°±æ˜¯è¯¦æƒ…é¡µçš„ä¿¡æ¯ï¼Œå°±ä¸ä¼šç”Ÿæˆæ–°çš„è¯·æ±‚ï¼Œåªå¯¹ Response å¯¹è±¡è§£æï¼Œè§£æåä»¥å­—å…¸å½¢å¼è¿”å›ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œååºå¤„ç†ï¼Œå¦‚ä¿å­˜åˆ°æ•°æ®åº“</p>
<h5 id="çˆ¬å–é¦–é¡µ"><a href="#çˆ¬å–é¦–é¡µ" class="headerlink" title="çˆ¬å–é¦–é¡µ"></a>çˆ¬å–é¦–é¡µ</h5><p>ç‚¹å‡»å·¦æ å³ä¸Šè§’çš„ run æŒ‰é’®ï¼Œå³å¯çœ‹åˆ°é¡µé¢ä¸‹æ–¹ follows ä¾¿ä¼šå‡ºç°ä¸€ä¸ªæ ‡æ³¨ï¼Œå…¶ä¸­åŒ…å«æ•°å­— 1ï¼Œè¿™ä»£è¡¨æœ‰æ–°çš„çˆ¬å–è¯·æ±‚äº§ç”Ÿ</p>
<img src="Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-pyspideræ¡†æ¶ä½¿ç”¨/WeChata1afccc130dc604431124e411f736a1b.png" alt="WeChata1afccc130dc604431124e411f736a1b" style="zoom:80%;" />

<p>å·¦æ å·¦ä¸Šè§’æ˜¾ç¤ºå½“å‰ run çš„é…ç½®æ–‡ä»¶ï¼Œcallback æ˜¯ on_startï¼Œè¯´æ˜ç‚¹å‡»run ä¹‹åæ‰§è¡Œäº† on_start æ–¹æ³•</p>
<p>on_start() æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬åˆ©ç”¨ crawl() æ–¹æ³•ç”Ÿæˆä¸€ä¸ªçˆ¬å–è¯·æ±‚ï¼Œé‚£ä¸‹æ–¹çš„ follows ä¸Šæ•°å­— 1 å°±ä»£è¡¨è¿™ä¸€ä¸ªçˆ¬å–è¯·æ±‚</p>
<p>ç‚¹å‡» follows æŒ‰é’®ï¼Œå¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„çˆ¬å–è¯·æ±‚çš„é“¾æ¥ï¼Œæ¯ä¸ªé“¾æ¥å³ä¾§æœ‰ä¸€ä¸ªç®­å¤´æŒ‰é’®ï¼Œç‚¹å‡»è¯¥ç®­å¤´å¯ä»¥å¯¹æ­¤é“¾æ¥è¿›è¡Œçˆ¬å–ï¼Œä¹Ÿå°±æ˜¯çˆ¬å–æ”»ç•¥çš„é¦–é¡µå†…å®¹</p>
<p>å†ç‚¹å‡»ä¸‹æ–¹çš„ web æŒ‰é’®ï¼Œå³å¯ç¾½ç„¶å½“å‰çˆ¬å–ç»“æœçš„é¡µé¢</p>
<p>ç‚¹å‡» html æŒ‰é’®å¯æŸ¥çœ‹å½“å‰é¡µé¢çš„æºä»£ç </p>
<p>ä¸Šé¢ index_page() æ–¹æ³•ä¸­æå–äº†æ‰€æœ‰çš„é“¾æ¥å¹¶ç”Ÿæˆäº†æ–°çš„çˆ¬å–è¯·æ±‚ï¼Œåªéœ€è¦æ”»ç•¥è¯¦æƒ…é¡µé¢çš„é“¾æ¥å°±å¤Ÿäº†ï¼Œè¿™é‡Œä¿®æ”¹æå–é“¾æ¥æ—¶çš„ CSSé€‰æ‹©å™¨ï¼Œ</p>
<p>é¦–é¡µåˆ‡æ¢åˆ° web é¡µé¢ï¼Œæ‰¾åˆ°æ”»ç•¥æ ‡é¢˜ï¼Œç‚¹å‡»ä¸‹æ–¹ enable css selector helperï¼Œç‚¹å‡»æ ‡é¢˜ï¼Œå¯ä»¥çœ‹åˆ°æ ‡é¢˜å¤–å¤šäº†ä¸€ä¸ªçº¢æ¡†ï¼Œä¸Šæ–¹å‡ºç°äº†ä¸€ä¸ª CSS é€‰æ‹©å™¨ï¼Œè¿™å°±æ˜¯å½“å‰æ ‡é¢˜å¯¹åº”çš„ CSS é€‰æ‹©å™¨</p>
<img src="Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-pyspideræ¡†æ¶ä½¿ç”¨/WeChat71c9e7d7b2716e5c496dc2dde6ef328a.png" alt="WeChat71c9e7d7b2716e5c496dc2dde6ef328a" style="zoom:80%;" />

<p>å³ä¾§ä»£ç é€‰ä¸­è¦æ›´æ”¹çš„åŒºåŸŸï¼Œç‚¹å‡»å·¦æ ä¸Šå³ç®­å¤´ï¼Œä¸Šæ–¹å‡ºç°çš„æ ‡é¢˜çš„ CSSé€‰æ‹©å™¨å°±ä¼šè¢«æ›¿æ¢åˆ°å³ä¾§çš„ä»£ç ä¸­</p>
<p>æ›¿æ¢ CSS é€‰æ‹©å™¨</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> each <span class="keyword">in</span> response.doc(<span class="string">&#x27;li &gt; .tit &gt; a&#x27;</span>).items():</span><br></pre></td></tr></table></figure>

<p>é‡æ–°ç‚¹å‡»å·¦æ ä¸Šå³ä¸Šè§’ run æŒ‰é’®ï¼Œå³å¯é‡æ–°æ‰§è¡Œ index_page() æ–¹æ³•ã€‚</p>
<p>æ­¤æ—¶ follows å°±å˜æˆäº† 10 ä¸ªï¼Œä¹Ÿå°±æ˜¯è¯´ç°åœ¨æå–çš„åªæœ‰å½“å‰é¡µé¢çš„ 10 ä¸ªæ”»ç•¥</p>
<p>ç°åœ¨åªæœ‰ç¬¬ä¸€é¡µçš„å†…å®¹ï¼Œè¿˜éœ€è¦çˆ¬å–ååºé¡µé¢ï¼Œæ‰€ä»¥è¿˜éœ€è¦ä¸€ä¸ªçˆ¬å–é“¾æ¥ï¼Œå³çˆ¬å–ä¸‹ä¸€é¡µçš„æ”»ç•¥åˆ—è¡¨é¡µé¢</p>
<p>å†åˆ©ç”¨ crawl() æ–¹æ³•æ·»åŠ ä¸‹ä¸€é¡µçš„çˆ¬å–è¯·æ±‚ï¼Œåœ¨index_page() æ–¹æ³•é‡Œé¢æ·»åŠ ä»£ç </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index_page</span>(<span class="params">self, response</span>):</span></span><br><span class="line">  <span class="built_in">next</span> = response.doc(<span class="string">&#x27;.next&#x27;</span>).attr.href</span><br><span class="line">  self.crawl(<span class="built_in">next</span>, callback=self.index_page)</span><br><span class="line">  <span class="keyword">for</span> each <span class="keyword">in</span> response.doc(<span class="string">&#x27;li &gt; .tit &gt; a&#x27;</span>).items():</span><br><span class="line">      self.crawl(each.attr.href, callback=self.detail_page)</span><br></pre></td></tr></table></figure>

<p>é‡æ–° run ï¼Œå°±å¯ä»¥çœ‹åˆ° 11 ä¸ªçˆ¬å–è¯·æ±‚ï¼Œfollows ä¸Šæ˜¾ç¤º 11</p>
<h5 id="çˆ¬å–è¯¦æƒ…é¡µ"><a href="#çˆ¬å–è¯¦æƒ…é¡µ" class="headerlink" title="çˆ¬å–è¯¦æƒ…é¡µ"></a>çˆ¬å–è¯¦æƒ…é¡µ</h5><p>ä»»æ„é€‰å–ä¸€ä¸ªè¯¦æƒ…é¡µè¿›å…¥ï¼Œç‚¹å‡»è¯·æ±‚ä¸­ä»»æ„ä¸€ä¸ªå³ç®­å¤´ï¼Œæ‰§è¡Œè¯¦æƒ…é¡µçš„çˆ¬å–</p>
<img src="Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-pyspideræ¡†æ¶ä½¿ç”¨/WeChat75fbf9e380178eca4d6202777db75bb0.png" alt="WeChat75fbf9e380178eca4d6202777db75bb0" style="zoom:80%;" />

<p>åˆ‡æ¢åˆ° web é¡µé¢é¢„è§ˆæ•ˆæœï¼Œé¡µé¢ä¸‹æ‹‰ï¼Œçœ‹åˆ°ä¸€äº›å›¾ç‰‡æ˜¾ç¤ºåŠ è½½ä¸­ï¼Œå†æŸ¥çœ‹æºç ï¼Œæ²¡æœ‰çœ‹åˆ° img èŠ‚ç‚¹</p>
<p>å‡ºç°æ­¤ç°è±¡çš„åŸå› æ˜¯ pyspider é»˜è®¤å‘é€ HTTP è¯·æ±‚ï¼Œè¯·æ±‚çš„ HTML æ–‡æ¡£æœ¬èº«ä¸åŒ…å« img èŠ‚ç‚¹ã€‚ä½†æµè§ˆå™¨ä¸­æˆ‘ä»¬çœ‹åˆ°äº†å›¾ç‰‡ï¼Œè¿™æ˜¯å› ä¸ºè¿™å¼ å›¾ç‰‡æ˜¯åæœŸç»è¿‡ JavaScript å‡ºç°çš„</p>
<p>pyspider å†…éƒ¨å¯¹æ¥äº† PhantomJSï¼Œåªéœ€è¦ä¿®æ”¹ä¸€ä¸ªå‚æ•°å³å¯ï¼Œæ·»åŠ  fetch_type</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index_page</span>(<span class="params">self, response</span>):</span></span><br><span class="line">  <span class="built_in">next</span> = response.doc(<span class="string">&#x27;.next&#x27;</span>).attr.href</span><br><span class="line">  self.crawl(<span class="built_in">next</span>, callback=self.index_page)</span><br><span class="line">  <span class="keyword">for</span> each <span class="keyword">in</span> response.doc(<span class="string">&#x27;li &gt; .tit &gt; a&#x27;</span>).items():</span><br><span class="line">      self.crawl(each.attr.href, callback=self.detail_page, fetch_type=<span class="string">&#x27;js&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>å›¾ç‰‡è¢«æ¸²æŸ“å‡ºæ¥äº†ï¼Œè¿™å°±æ˜¯å¯ç”¨äº† PhantomJS æ¸²æŸ“åçš„ç»“æœï¼Œæœ€åå°†è¯¦æƒ…ä¸­çš„ä¿¡æ¯æå–å‡ºæ¥</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">detail_page</span>(<span class="params">self, response</span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;url&#x27;</span>: response.url,</span><br><span class="line">        <span class="string">&#x27;title&#x27;</span>: response.doc(<span class="string">&#x27;#booktitle&#x27;</span>).text(),</span><br><span class="line">        <span class="string">&#x27;date&#x27;</span>: response.doc(<span class="string">&#x27;.when .data&#x27;</span>).text(),</span><br><span class="line">        <span class="string">&#x27;day&#x27;</span>: response.doc(<span class="string">&#x27;.howlong .data&#x27;</span>).text(),</span><br><span class="line">        <span class="string">&#x27;who&#x27;</span>: response.doc(<span class="string">&#x27;.who .data&#x27;</span>).text(),</span><br><span class="line">        <span class="string">&#x27;text&#x27;</span>: response.doc(<span class="string">&#x27;#b_panel_schedule&#x27;</span>).text(),</span><br><span class="line">        <span class="string">&#x27;image&#x27;</span>: response.doc(<span class="string">&#x27;.cover_img&#x27;</span>).attr.src,</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>å·¦æ ä¸­è¾“å‡ºäº†æœ€ç»ˆæ„é€ çš„å­—å…¸ä¿¡æ¯</p>
<h5 id="å¯åŠ¨çˆ¬è™«"><a href="#å¯åŠ¨çˆ¬è™«" class="headerlink" title="å¯åŠ¨çˆ¬è™«"></a>å¯åŠ¨çˆ¬è™«</h5><p>è¿”å›çˆ¬è™«ä¸»é¡µé¢ï¼Œå°†çˆ¬è™« status è®¾ç½®æˆ DEBUG æˆ– RUNNINGï¼Œç‚¹å‡»å³ä¾§çš„ Run æŒ‰é’®å³å¯å¼€å§‹çˆ¬å–</p>
<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-pyspider%E6%A1%86%E6%9E%B6%E4%BD%BF%E7%94%A8/WeChatab3cfe3bff369db2397e97e00e3ec0af.png" alt="WeChatab3cfe3bff369db2397e97e00e3ec0af"></p>
<p>æœ€å·¦ä¾§å¯ä»¥å®šä¹‰é¡¹ç›®çš„åˆ†ç»„ï¼Œæ–¹ä¾¿ç®¡ç†</p>
<p>rate/burst ä»£è¡¨å½“å‰çš„çˆ¬å–é€Ÿç‡ï¼Œrate ä»£è¡¨1ç§’å‘å‡ºå¤šå°‘ä¸ªè¯·æ±‚ï¼Œburst ç›¸å½“äºæµé‡æ§åˆ¶ä¸­çš„ä»¤ç‰Œæ¡¶ç®—æ³•çš„ä»¤ç‰Œæ•°ï¼Œrate å’Œ burst è®¾ç½®è¶Šå¤§ï¼Œçˆ¬å–é€Ÿç‡è¶Šå¿«</p>
<p>process ä¸­çš„ 5mã€1hã€1d æŒ‡æœ€è¿‘5åˆ†ã€1å°æ—¶ã€1å¤©å†…çš„è¯·æ±‚æƒ…å†µï¼Œall ä»£è¡¨æ‰€æœ‰çš„è¯·æ±‚æƒ…å†µ</p>
<p>è“è‰²ä»£è¡¨ç­‰å¾…è¢«æ‰§è¡Œçš„è¯·æ±‚ï¼Œç»¿è‰²ä»£è¡¨è¯·æ±‚æˆåŠŸçš„è¯·æ±‚ï¼Œé»„è‰²ä»£è¡¨è¯·æ±‚å¤±è´¥åç­‰å¾…é‡è¯•çš„è¯·æ±‚ï¼Œçº¢è‰²ä»£è¡¨å¤±è´¥æ¬¡æ•°è¿‡å¤šè€Œè¢«å¿½ç•¥çš„è¯·æ±‚ï¼Œè¿™æ ·å¯ä»¥çŸ¥é“çˆ¬å–çš„è¿›åº¦å’Œè¯·æ±‚æƒ…å†µ</p>
<p>ç‚¹å‡» Active Tasks å¯æŸ¥çœ‹æœ€è¿‘è¯·æ±‚çš„è¯¦ç»†æƒ…å†µ</p>
<p>ç‚¹å‡» Results å¯æŸ¥çœ‹æ‰€æœ‰çˆ¬å–ç»“æœ</p>
<h4 id="pyspiderç”¨æ³•"><a href="#pyspiderç”¨æ³•" class="headerlink" title="pyspiderç”¨æ³•"></a>pyspiderç”¨æ³•</h4><h5 id="pyspider-all-é…ç½®å‚æ•°"><a href="#pyspider-all-é…ç½®å‚æ•°" class="headerlink" title="pyspider all é…ç½®å‚æ•°"></a>pyspider all é…ç½®å‚æ•°</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pyspider [OPTIONS] COMMAND [ARGA]</span><br><span class="line">#OPTIONS å¯é€‰å‚æ•°</span><br><span class="line">-c, --config FILENAME æŒ‡å®šé…ç½®æ–‡ä»¶åç§°</span><br><span class="line">--logging-config TEXT æ—¥å¿—é…ç½®æ–‡ä»¶åç§° é»˜è®¤ pyspider&#x2F;pyspider&#x2F;logging.conf</span><br><span class="line">--debug å¼€å¯è°ƒè¯•æ¨¡å¼</span><br><span class="line">--queue-maxsize INTEGER é˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ </span><br><span class="line">--taskdb TEXT taskdbçš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸² é»˜è®¤ sqlite</span><br><span class="line">--rojectdb TEXT projectdbçš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸² é»˜è®¤ sqlite</span><br><span class="line">--resultdb TEXT resultdbçš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸² é»˜è®¤ sqlite</span><br><span class="line">--message-queue TEXT æ¶ˆæ¯é˜Ÿåˆ—è¿æ¥å­—ç¬¦ä¸² é»˜è®¤ multiprocessing.Queue</span><br><span class="line">--phantomjs-proxy TEXT PhantomJSä½¿ç”¨çš„ä»£ç† ip:port å½¢å¼</span><br><span class="line">--data-path TEXT æ•°æ®åº“å­˜æ”¾è·¯å¾„</span><br><span class="line">--version pyspiderçš„ç‰ˆæœ¬</span><br><span class="line">--help æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯</span><br></pre></td></tr></table></figure>

<p>-c å¯ä»¥æŒ‡å®šé…ç½®æ–‡ä»¶åç§°æ˜¯ä¸€ä¸ªå¸¸ç”¨é…ç½®</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;taskdb&quot;: &quot;mysql+taskdb:&#x2F;&#x2F;username:password@host:port&#x2F;taskdb&quot;,</span><br><span class="line">	&quot;projectdb&quot;: &quot;mysql+projectdb:&#x2F;&#x2F;username:password@host:port&#x2F;projectdb&quot;,</span><br><span class="line">	&quot;resultdb&quot;: &quot;mysql+resultdb:&#x2F;&#x2F;username:password@host:port&#x2F;resultdb&quot;,</span><br><span class="line">	&quot;message_queue&quot;: &quot;amqp:&#x2F;&#x2F;username:password@host:port&#x2F;%2F&quot;,</span><br><span class="line">	&quot;webui&quot;:&#123;</span><br><span class="line">		&quot;username&quot;: &quot;some_name&quot;,</span><br><span class="line">		&quot;password&quot;: &quot;some_passwd&quot;,</span><br><span class="line">		&quot;need-auth&quot;: true</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœè¦é…ç½® pyspider WebUI çš„è®¿é—®è®¤è¯ï¼Œå¯ä»¥æ–°å»ºä¸€ä¸ªpyspider.json</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;webui&quot;:&#123;</span><br><span class="line">		&quot;username&quot;: &quot;root&quot;,</span><br><span class="line">		&quot;password&quot;: &quot;123456&quot;,</span><br><span class="line">		&quot;need-auth&quot;: true</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·é€šè¿‡åœ¨å¯åŠ¨æ—¶æŒ‡å®šé…ç½®æ–‡ä»¶æ¥é…ç½® pyspider WebUI çš„è®¿é—®è®¤è¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyspider -c pyspider.json all</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œä¹‹åå†æ‰“å¼€ <a target="_blank" rel="noopener" href="http://localhost:5000/">http://localhost:5000</a></p>
<p>ä¹Ÿå¯ä»¥å•ç‹¬è¿è¡Œ pyspider çš„æŸä¸€ä¸ªç»„ä»¶</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#è¿è¡Œ Scheduler</span><br><span class="line">pyspider scheduler [OPTIONS]</span><br><span class="line">#è¿è¡Œ Fetcher</span><br><span class="line">pyspider fetcher [OPTIONS]</span><br><span class="line">#è¿è¡Œ Processor</span><br><span class="line">pyspider processor [OPTIONS]</span><br><span class="line">#è¿è¡Œ WebUI</span><br><span class="line">pyspider webui [OPTIONS]</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæƒ³è¦æ”¹å˜ WebUIè¿è¡Œç«¯å£ä¸º 5001</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pyspider webui --port 5001</span><br></pre></td></tr></table></figure>

<p>æˆ–è€…é…ç½®åˆ° JSON æ–‡ä»¶ä¸­</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;webui&quot;:&#123;&quot;port&quot;: 5001&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="crawl-æ–¹æ³•"><a href="#crawl-æ–¹æ³•" class="headerlink" title="crawl æ–¹æ³•"></a>crawl æ–¹æ³•</h5><p>callback å›è°ƒå‡½æ•°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def on_start(self):</span><br><span class="line">	self.crawl(&#39;http:&#x2F;&#x2F;scrapy.org&#x2F;&#39;, callback&#x3D;self.index_page)</span><br></pre></td></tr></table></figure>

<p>index_page æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å“åº”å¯¹è±¡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def index_page(self, response):</span><br><span class="line">	pass</span><br></pre></td></tr></table></figure>

<ul>
<li>age</li>
</ul>
<p>ä»»åŠ¡æœ‰æ•ˆæ—¶é—´ï¼Œå¦‚æœæŸä¸ªä»»åŠ¡åœ¨æœ‰æ•ˆæ—¶é—´å†…ä¸”å·²ç»è¢«æ‰§è¡Œï¼Œåˆ™å®ƒä¸ä¼šé‡å¤æ‰§è¡Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">def on_start(self):</span><br><span class="line">	self.crawl(&#39;http:&#x2F;&#x2F;www.example.org&#x2F;&#39;, callback&#x3D;self.callback,age&#x3D;10*24*60*60)</span><br><span class="line">æˆ–è€…</span><br><span class="line">@config(age&#x3D;10*24*60*60)</span><br><span class="line">def callback(self):</span><br><span class="line">	pass   </span><br><span class="line">é»˜è®¤æœ‰æ•ˆæœŸ10å¤©</span><br></pre></td></tr></table></figure>

<ul>
<li>priority</li>
</ul>
<p>çˆ¬å–ä¼˜å…ˆçº§ï¼Œé»˜è®¤0ï¼Œæ•°å€¼è¶Šå¤§ï¼Œå¯¹åº”çš„è¯·æ±‚ä¼šä¼˜å…ˆè¢«è°ƒç”¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def index_page(self):</span><br><span class="line">	self.crawl(&#39;http:&#x2F;&#x2F;www.example.org&#x2F;page.html&#39;, callback&#x3D;self.index_page)</span><br><span class="line">	self.crawl(&#39;http:&#x2F;&#x2F;www.example.org&#x2F;123.html&#39;, callback&#x3D;self.index_page,priority&#x3D;1)</span><br><span class="line">ç¬¬äºŒä¸ªé“¾æ¥å…ˆè°ƒç”¨</span><br></pre></td></tr></table></figure>

<ul>
<li>exetime</li>
</ul>
<p>è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼Œå€¼æ˜¯æ—¶é—´æˆ³ï¼Œé»˜è®¤0ï¼Œç«‹å³æ‰§è¡Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">improt time</span><br><span class="line">def on_start(self):</span><br><span class="line">	self.crawl(&#39;http:&#x2F;&#x2F;www.example.org&#x2F;&#39;, callback&#x3D;self.callback,exetime&#x3D;time.time()+30*60)</span><br></pre></td></tr></table></figure>

<p>è¯¥ä»»åŠ¡30åˆ†é’Ÿåæ‰§è¡Œ</p>
<ul>
<li>retries</li>
</ul>
<p>å®šä¹‰é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤ 3</p>
<ul>
<li><p>itag</p>
</li>
<li><p>auto_recrawl</p>
</li>
<li><p>method</p>
</li>
<li><p>params</p>
</li>
<li><p>data</p>
</li>
<li><p>files</p>
</li>
<li><p>user_agent</p>
</li>
<li><p>headers</p>
</li>
<li><p>cookies</p>
</li>
<li><p>connect_timeout</p>
</li>
<li><p>timeout</p>
</li>
<li><p>allow_redirects</p>
</li>
<li><p>validate_cert</p>
</li>
<li><p>proxy</p>
</li>
<li><p>fetch_type</p>
</li>
<li><p>js_script</p>
</li>
<li><p>js_run_at</p>
</li>
<li><p>js_viewport_width/js_viewport_height</p>
</li>
<li><p>load_images</p>
</li>
<li><p>save</p>
</li>
<li><p>cancel</p>
</li>
<li><p>force_update</p>
</li>
</ul>
<h4 id="ä»»åŠ¡åŒºåˆ†"><a href="#ä»»åŠ¡åŒºåˆ†" class="headerlink" title="ä»»åŠ¡åŒºåˆ†"></a>ä»»åŠ¡åŒºåˆ†</h4><p>pyspider åˆ¤æ–­ä¸¤ä¸ªä»»åŠ¡æ˜¯å¦æ˜¯é‡å¤æ˜¯ä½¿ç”¨ä»»åŠ¡å¯¹åº”çš„ URL çš„MD5å€¼ä½œä¸ºä»»åŠ¡çš„å”¯ä¸€ IDï¼ŒIDç›¸åŒï¼Œä¸¤ä¸ªä»»åŠ¡å°±ä¼šè¢«åˆ¤å®šä¸ºç›¸åŒï¼Œå…¶ä¸­ä¸€ä¸ªå°±ä¸ä¼šçˆ¬å–</p>
<p>å¾ˆå¤šæƒ…å†µä¸‹è¯·æ±‚çš„é“¾æ¥å¯èƒ½æ˜¯åŒä¸€ä¸ªï¼Œä½† POST å‚æ•°ä¸åŒï¼Œè¿™æ—¶å¯ä»¥é‡å†™ task_id() æ–¹æ³•ï¼Œæ”¹å˜è¿™ä¸ª ID çš„è®¡ç®—æ–¹å¼æ¥å®ç°ä¸åŒä»»åŠ¡åŒºåˆ†</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> pyspider.libs.utils <span class="keyword">import</span> md5string</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_taskid</span>(<span class="params">self, task</span>):</span></span><br><span class="line">  <span class="keyword">return</span> md5string(task[<span class="string">&#x27;url&#x27;</span>]+json.dumps(task[<span class="string">&#x27;fetch&#x27;</span>].get(<span class="string">&#x27;data&#x27;</span>, <span class="string">&#x27;&#x27;</span>)))</span><br></pre></td></tr></table></figure>

<p>é‡å†™äº† get_taskid æ–¹æ³•ï¼Œåˆ©ç”¨ URL å’Œ POST çš„å‚æ•°æ¥ç”Ÿæˆ ID</p>
<h4 id="å…¨å±€é…ç½®"><a href="#å…¨å±€é…ç½®" class="headerlink" title="å…¨å±€é…ç½®"></a>å…¨å±€é…ç½®</h4><p>å¯ä»¥ä½¿ç”¨ craw_config æŒ‡å®šå…¨å±€é…ç½®ï¼Œé…ç½®ä¸­çš„å‚æ•°ä¼šå’Œ crawl() æ–¹æ³•åˆ›å»ºä»»åŠ¡æ—¶çš„å‚æ•°åˆå¹¶ï¼Œå¦‚è¦å…¨å±€é…ç½®ä¸€ä¸ª Headers</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class Handler(BaseHandler):</span><br><span class="line">	crawl_config &#x3D; &#123;</span><br><span class="line">		&#39;headers&#39;: &#123;</span><br><span class="line">			&#39;User-Agent&#39;: &#39;GoogleBot&#39;,</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å®šæ—¶çˆ¬å–"><a href="#å®šæ—¶çˆ¬å–" class="headerlink" title="å®šæ—¶çˆ¬å–"></a>å®šæ—¶çˆ¬å–</h4><p>å¯ä»¥é€šè¿‡ every å±æ€§æ¥è®¾ç½®çˆ¬å–æ—¶é—´é—´éš”</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@every(minutes=24*60)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_start</span>(<span class="params">self</span>):</span></span><br><span class="line">	<span class="keyword">for</span> url <span class="keyword">in</span> urllist:</span><br><span class="line">		self.crawl(url, callback=self.index_page)</span><br></pre></td></tr></table></figure>

<p>è®¾ç½®äº†æ¯å¤©æ‰§è¡Œä¸€æ¬¡çˆ¬å–</p>
<p>ä¸Šé¢æåˆ°äº†æœ‰æ•ˆæ—¶é—´ï¼Œæœ‰æ•ˆæ—¶é—´å†…ä¸ä¼šé‡å¤çˆ¬å–ï¼Œæ‰€ä»¥è¦æŠŠæœ‰æ•ˆæ—¶é—´è®¾ç½®æ¯”é‡å¤æ—¶é—´æ›´çŸ­ï¼Œæ‰å¯ä»¥å®ç°å®šæ—¶çˆ¬å–</p>
<p>å°† age è®¾ç½®å°äºå®šæ—¶æ—¶é—´</p>
<h4 id="é¡¹ç›®çŠ¶æ€"><a href="#é¡¹ç›®çŠ¶æ€" class="headerlink" title="é¡¹ç›®çŠ¶æ€"></a>é¡¹ç›®çŠ¶æ€</h4><p>TODO åˆšè¢«åˆ›å»ºæœªå®ç°çŠ¶æ€</p>
<p>STOP æƒ³åœæ­¢æŸé¡¹ç›®æŠ“å–ï¼Œå¯å°†é¡¹ç›®è®¾ç½® STOP</p>
<p>CHECKING æ­£åœ¨è¿è¡Œçš„é¡¹ç›®è¢«ä¿®æ”¹åä¼šå˜æˆ CHECKING çŠ¶æ€</p>
<p>DEBUG/RUNNING è¿™ä¸¤ä¸ªçŠ¶æ€å¯¹é¡¹ç›®è¿è¡Œæ²¡å½±å“ï¼Œè®¾ç½®ä»»æ„ä¸€ä¸ªé¡¹ç›®éƒ½å¯ä»¥è¿è¡Œï¼Œç”¨ç¬¬äºŒä¸ªå¯ä»¥åŒºåˆ†é¡¹ç›®æ˜¯å¦æµ‹è¯•é€šè¿‡</p>
<p>PAUSE çˆ¬å–è¿‡ç¨‹ä¸­è¿ç»­å¤šæ¬¡é”™è¯¯æ—¶ï¼Œé¡¹ç›®ä¼šè‡ªåŠ¨è®¾ç½®ä¸º PAUSE çŠ¶æ€ï¼Œå¹¶ç­‰å¾…ä¸€æ®µæ—¶é—´åç»§ç»­çˆ¬å–</p>
<h4 id="åˆ é™¤é¡¹ç›®"><a href="#åˆ é™¤é¡¹ç›®" class="headerlink" title="åˆ é™¤é¡¹ç›®"></a>åˆ é™¤é¡¹ç›®</h4><p>å°†é¡¹ç›®è®¾ç½®ä¸º STOPï¼Œå°†åˆ†ç»„åç§°è®¾ç½®ä¸º deleteï¼Œç­‰å¾…24å°æ—¶ï¼Œé¡¹ç›®ä¼šè‡ªåŠ¨åˆ é™¤</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/18/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-12App%E7%88%AC%E5%8F%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="ç®€å•è®°å½•ä¸‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/18/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-12App%E7%88%AC%E5%8F%96/" class="post-title-link" itemprop="url">Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-12Appçˆ¬å–</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-04-18 10:08:39" itemprop="dateCreated datePublished" datetime="2022-04-18T10:08:39+08:00">2022-04-18</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-10-17 09:01:44" itemprop="dateModified" datetime="2022-10-17T09:01:44+08:00">2022-10-17</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="11-2-mitmproxy-çš„ä½¿ç”¨"><a href="#11-2-mitmproxy-çš„ä½¿ç”¨" class="headerlink" title="11.2 mitmproxy çš„ä½¿ç”¨"></a>11.2 mitmproxy çš„ä½¿ç”¨</h4><p>å®˜æ–¹æ–‡æ¡£ <a target="_blank" rel="noopener" href="https://docs.mitmproxy.org/stable/">https://docs.mitmproxy.org/stable/</a></p>
<p>ä¸­æ–‡æ–‡æ¡£åŠé…ç½® <a target="_blank" rel="noopener" href="https://ptorch.com/news/269.html">https://ptorch.com/news/269.html</a></p>
<p>mitmproxy æ˜¯ä¸€ä¸ªæ”¯æŒ HTTP å’Œ HTTPS çš„æŠ“åŒ…ç¨‹åºï¼Œæ˜¯ä¸€ä¸ªæ§åˆ¶å°å½¢å¼çš„æ“ä½œ</p>
<p>æœ‰ä¸¤ä¸ªå…³è”ç»„ä»¶</p>
<p>mitmdumpï¼šæ˜¯ mitmproxy å‘½ä»¤è¡Œæ¥å£ï¼Œåˆ©ç”¨å®ƒå¯¹æ¥ Python è„šæœ¬ï¼Œå®ç°ç›‘å¬åçš„å¤„ç†</p>
<p>mitmwebï¼šä¸€ä¸ª Web ç¨‹åºï¼Œé€šè¿‡å®ƒä»¥æ¸…æ¥šè§‚å¯Ÿåˆ° mitmproxy æ•è·è¯·æ±‚</p>
<p>mitmproxy è¿è¡Œåœ¨ PC ä¸Šï¼Œ mitmproxy ä¼šåœ¨ PC ä¸Šçš„ 8080 ç«¯å£è¿è¡Œï¼Œç„¶åå¼€å¯ä¸€ä¸ªä»£ç†æœåŠ¡ï¼Œè¿™ä¸ªæœåŠ¡å®é™…ä¸Šæ˜¯ä¸€ä¸ª HTTP/HTTPS çš„ä»£ç†</p>
<p>æ‰‹æœºå’ŒPCåœ¨åŒä¸€å±€åŸŸç½‘å†…ï¼Œè®¾ç½®ä»£ç†ä¸º mitmproxy çš„ä»£ç†åœ°å€ï¼Œè¿™æ ·æ‰‹æœºè®¿é—®äº’è”ç½‘æ—¶ï¼Œæµé‡åŒ…å°±ä¼šæµç» mitmproxyï¼Œmitmproxy å†å»è½¬å‘è¿™äº›æ•°æ®åŒ…åˆ°çœŸå®çš„æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨è¿”å›æ•°æ®åŒ…æ—¶å†ç”± mitmproxy è½¬å‘å›æ‰‹æœºï¼Œè¿™æ · mitmproxy å°±ç›¸å½“äºèµ·äº†ä¸­é—´äººçš„ä½œç”¨ã€‚è¿™ä¸ªè¿‡ç¨‹è¿˜å¯ä»¥å¯¹æ¥ mitmdumpï¼ŒæŠ“å–åˆ°çš„ request  å’Œ response çš„å†…å®¹éƒ½å¯ä»¥ç”¨ Python å¤„ç†</p>
<h5 id="è®¾ç½®ä»£ç†"><a href="#è®¾ç½®ä»£ç†" class="headerlink" title="è®¾ç½®ä»£ç†"></a>è®¾ç½®ä»£ç†</h5><p>å¯åŠ¨ mitmproxyï¼Œä¹‹åä¼šåœ¨ 8080 ç«¯å£ä¸Šè¿è¡Œä¸€ä¸ªä»£ç†æœåŠ¡ï¼Œå³ä¸‹è§’æ˜¾ç¤ºå½“å‰æ­£åœ¨ç›‘å¬çš„ç«¯å£</p>
<p>æˆ–è€…å¯åŠ¨ mitmdumpï¼Œä¹Ÿä¼šç›‘å¬ 8080 ç«¯å£</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mitmproxy</span><br></pre></td></tr></table></figure>

<img src="Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-12Appçˆ¬å–/WeChatbc9c4fbc9a77005d02a7b76380f4d96d.png" alt="WeChatbc9c4fbc9a77005d02a7b76380f4d96d" style="zoom:100%;" />



<h5 id="mitmproxy-ä½¿ç”¨"><a href="#mitmproxy-ä½¿ç”¨" class="headerlink" title="mitmproxy ä½¿ç”¨"></a>mitmproxy ä½¿ç”¨</h5><p>æ‰‹æœºè®¾ç½®ä»£ç† ç«¯å£å·è®¾ç½® 8080</p>
<p>è®¾ç½®å¥½ä¹‹åï¼Œæ‰‹æœºæµè§ˆè¯·æ±‚ï¼Œmitmproxy é¡µé¢ä¾¿ä¼šå‘ˆç°æ‰‹æœºä¸Šçš„è¯·æ±‚</p>
<img src="Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-Appçˆ¬å–/WeChat3176183fed7aabb817d5cca64b557fea.png" alt="WeChat3176183fed7aabb817d5cca64b557fea" style="zoom:80%;" />

<p>é”®ç›˜ä¸Šä¸‹ç§»åŠ¨å…‰æ ‡é€‰æ‹©è¯·æ±‚ï¼Œæ•²å‡»å›è½¦å¯ä»¥æŸ¥çœ‹è¯¦æƒ…</p>
<img src="Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-12Appçˆ¬å–/WeChatbdf3664c9d6af574beb50d4ba5ecbda0.png" alt="WeChatbdf3664c9d6af574beb50d4ba5ecbda0" style="zoom:80%;" />

<p>å¯ä»¥çœ‹åˆ° 3 ä¸ªåˆ†æ ï¼ŒRequestã€Responseã€Detailï¼Œé€šè¿‡é¼ æ ‡ç‚¹å‡»åˆ†æ æˆ–è€… Tab åˆ‡æ¢</p>
<h6 id="å‘½ä»¤è¡Œç¼–è¾‘åŠŸèƒ½"><a href="#å‘½ä»¤è¡Œç¼–è¾‘åŠŸèƒ½" class="headerlink" title="å‘½ä»¤è¡Œç¼–è¾‘åŠŸèƒ½"></a>å‘½ä»¤è¡Œç¼–è¾‘åŠŸèƒ½</h6><p>ç‚¹å‡» e è¿›å…¥ç¼–è¾‘åŠŸèƒ½ï¼Œè·³å‡ºä¸€ä¸ªåˆ—è¡¨å¯ä»¥é€‰æ‹©éœ€è¦ç¼–è¾‘é€‰é¡¹</p>
<p>esc å…³é—­åˆ—è¡¨é€‰é¡¹</p>
<p>å¦‚è¿›å…¥ç¼–è¾‘è¯·æ±‚å‚æ•°ç•Œé¢ï¼Œå…‰æ ‡ç§»åŠ¨åˆ°éœ€è¦ä¿®æ”¹åœ°æ–¹ï¼Œå›è½¦å¯ç¼–è¾‘</p>
<p>æ•²å‡» a å¯ä»¥å¢åŠ ä¸€è¡Œï¼Œè¾“å…¥ Keyã€Value</p>
<p>å†æ•²å‡» escï¼Œq é”®ï¼Œè¿”å›ä¹‹å‰çš„ç•Œé¢ï¼Œå¯ä»¥çœ‹åˆ°è¯·æ±‚çš„å‚æ•°å·²ä¿®æ”¹</p>
<img src="Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-12Appçˆ¬å–/WeChat4316a20d612a7c046a3338faa2f20b37.png" alt="WeChat4316a20d612a7c046a3338faa2f20b37" style="zoom:80%;" />

<p>æ•²å‡» r å‘èµ·ä¿®æ”¹åçš„è¯·æ±‚</p>
<h5 id="mitmweb"><a href="#mitmweb" class="headerlink" title="mitmweb"></a>mitmweb</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mitmweb</span><br><span class="line">#æç¤º</span><br><span class="line">Web server listening at http:&#x2F;&#x2F;127.0.0.1:8081&#x2F;</span><br><span class="line">Proxy server listening at http:&#x2F;&#x2F;*:8080</span><br></pre></td></tr></table></figure>

<p>æ‰“å¼€é“¾æ¥ <a target="_blank" rel="noopener" href="http://127.0.0.1:8081/">http://127.0.0.1:8081/</a> å¯ä»¥çœ‹åˆ°è¯·æ±‚</p>
<h5 id="mitmdump"><a href="#mitmdump" class="headerlink" title="mitmdump"></a>mitmdump</h5><p>mitmdump æ˜¯ mitmproxy çš„å‘½ä»¤è¡Œæ¥å£ï¼ŒåŒæ—¶å¯ä»¥å¯¹æ¥ Python å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†</p>
<p>å¯ä»¥å‘½ä»¤è¡Œå¯åŠ¨ mitmproxyï¼Œå¹¶æŠŠæˆªè·çš„æ•°æ®ä¿å­˜åˆ°æ–‡ä»¶ä¸­</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mitmdump -w outfile #æ‰“å¼€ä¹±ç </span><br></pre></td></tr></table></figure>

<p>å¦‚æœè®¾ç½®è®¾ç½®ä»£ç†æŠ¥é”™<code> killed by block_global</code>ï¼Œ æ·»åŠ å‚æ•°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mitmdump -w outfile --set block_global&#x3D;false</span><br></pre></td></tr></table></figure>





<p>è¿˜å¯ä»¥æŒ‡å®šä¸€ä¸ªè„šæœ¬æ¥å¤„ç†æˆªè·çš„æ•°æ®ï¼Œä½¿ç”¨ -s å‚æ•°ï¼Œè„šæœ¬éœ€è¦æ”¾åœ¨å½“å‰å‘½ä»¤æ‰§è¡Œçš„ç›®å½•ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mitmdump -s script.py</span><br></pre></td></tr></table></figure>

<p>è„šæœ¬å†™å…¥å¦‚ä¸‹ä»£ç ï¼šå®šä¹‰äº†ä¸€ä¸ª request() æ–¹æ³•ï¼Œå‚æ•°ä¸º flowï¼Œå…¶å®æ˜¯ä¸€ä¸ª HTTPFlow å¯¹è±¡ï¼Œé€šè¿‡ request å±æ€§å³å¯è·å–å½“å‰è¯·æ±‚å¯¹è±¡ï¼Œç„¶åæ‰“å°è¾“å‡ºè¯·æ±‚å¤´ï¼Œå°†è¯·æ±‚å¤´ä¿®æ”¹æˆäº† MitmProxy</p>
<p>æ‰‹æœºç«¯è®¿é—® <a target="_blank" rel="noopener" href="http://httpbin.org/get">http://httpbin.org/get</a> æµ‹è¯•ï¼ŒæŸ¥çœ‹è¯·æ±‚çš„ç›¸å…³æ•°æ®</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request</span>(<span class="params">flow</span>):</span></span><br><span class="line">	flow.request.headers[<span class="string">&#x27;User-Agent&#x27;</span>] = <span class="string">&#x27;MitmProxy&#x27;</span></span><br><span class="line">	print(flow.request.headers)</span><br></pre></td></tr></table></figure>

<ul>
<li>é™é»˜æ¨¡å¼</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mitmdump -q -s index.py</span><br></pre></td></tr></table></figure>





<h6 id="æ—¥å¿—è¾“å‡º"><a href="#æ—¥å¿—è¾“å‡º" class="headerlink" title="æ—¥å¿—è¾“å‡º"></a>æ—¥å¿—è¾“å‡º</h6><p>å¯ä»¥è®¾å®šä¸åŒçº§åˆ«ä»¥ä¸åŒé¢œè‰²è¾“å‡ºç»“æœï¼Œæ˜¾ç¤ºåˆ°ä¸­æ–­æ§åˆ¶å°ä¸Š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> ctx</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request</span>(<span class="params">flow</span>):</span></span><br><span class="line">	flow.request.headers[<span class="string">&#x27;User-Agent&#x27;</span>] = <span class="string">&#x27;MitmProxy&#x27;</span></span><br><span class="line">	ctx.log.info(<span class="built_in">str</span>(flow.request.headers))</span><br><span class="line">	ctx.log.warn(<span class="built_in">str</span>(flow.request.headers))</span><br><span class="line">	ctx.log.error(<span class="built_in">str</span>(flow.request.headers))</span><br><span class="line">	print(flow.request.headers)</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œè°ƒç”¨äº† ctx æ¨¡å—ï¼Œå®ƒæœ‰ä¸€ä¸ª log åŠŸèƒ½</p>
<h6 id="Request-è¯·æ±‚"><a href="#Request-è¯·æ±‚" class="headerlink" title="Request è¯·æ±‚"></a>Request è¯·æ±‚</h6><p>è¿˜å¯è¾“å‡ºå…¶å®ƒå†…å®¹ headersã€cookies ç­‰</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> ctx</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request</span>(<span class="params">flow</span>):</span></span><br><span class="line">	request = flow.request</span><br><span class="line">	info = ctx.log.info</span><br><span class="line">	print(info(<span class="built_in">str</span>(request.headers)))</span><br><span class="line">	print(info(<span class="built_in">str</span>(request.cookies)))</span><br><span class="line">	print(info(<span class="built_in">str</span>(request.host)))</span><br><span class="line">	print(info(<span class="built_in">str</span>(request.method)))</span><br><span class="line">	print(info(<span class="built_in">str</span>(request.port)))</span><br><span class="line">	print(info(<span class="built_in">str</span>(request.scheme)))</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å¯¹å±æ€§ä¿®æ”¹ ï¼Œä¿®æ”¹è„šæœ¬å¦‚ä¸‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request</span>(<span class="params">flow</span>):</span></span><br><span class="line">	url = <span class="string">&#x27;https://httpbin.org/get&#x27;</span></span><br><span class="line">	flow.request.url = url</span><br></pre></td></tr></table></figure>

<p>è®¿é—® <a target="_blank" rel="noopener" href="https://baidu.com/">https://baidu.com</a> ç›´æ¥è·³è½¬åˆ°è¿™é‡Œäº† <a target="_blank" rel="noopener" href="https://httpbin.org/get">https://httpbin.org/get</a></p>
<p>Request è¿˜æœ‰å¾ˆå¤šå±æ€§ å‚è€ƒ <a target="_blank" rel="noopener" href="http://docs.mitmproxy.org/en/latest/scripting/api.html">http://docs.mitmproxy.org/en/latest/scripting/api.html</a></p>
<h6 id="Response-å“åº”"><a href="#Response-å“åº”" class="headerlink" title="Response å“åº”"></a>Response å“åº”</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> ctx</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">response</span>(<span class="params">flow</span>):</span></span><br><span class="line">	response = flow.response</span><br><span class="line">	info = ctx.log.info</span><br><span class="line">	info(<span class="built_in">str</span>(response.status_code))</span><br><span class="line">	info(<span class="built_in">str</span>(response.headers))</span><br><span class="line">	info(<span class="built_in">str</span>(response.cookies))</span><br><span class="line">	info(<span class="built_in">str</span>(response.text))</span><br></pre></td></tr></table></figure>

<p>å†è®¿é—® httpbin </p>
<ul>
<li>ä¿®æ”¹å“åº”æ¶ˆæ¯ä½“-ç›´æ¥ä¿®æ”¹å“åº”å­—æ®µ</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> ctx, http</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modify</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">response</span>(<span class="params">self, flow</span>):</span></span><br><span class="line">        <span class="keyword">if</span> flow.request.url.startswith(<span class="string">&quot;https://xxx.x.xxx.com.cn/activityInfo/getPrizeInfo==&quot;</span>):</span><br><span class="line">       		 //è·å–å“åº”çš„jsonå­—ç¬¦ä¸²ï¼Œè½¬æˆpythonå¯¹è±¡è¿›è¡Œè§£æå’Œä¿®æ”¹</span><br><span class="line">            response = json.loads(flow.response.get_text())</span><br><span class="line">            response[<span class="string">&#x27;limitCount&#x27;</span>] = <span class="number">1</span></span><br><span class="line">            //ä¿®æ”¹å®Œæˆåï¼Œå¥–pythonå¯¹è±¡è½¬æˆjsonå­—ç¬¦ä¸²ï¼Œ<span class="built_in">set</span>è¿›è¯·æ±‚çš„å“åº”ä½“é‡å‘é€ç»™å®¢æˆ·ç«¯</span><br><span class="line">            flow.response.set_text(json.dumps(response))</span><br><span class="line">            ctx.log.info(<span class="string">&#x27;modify limitCount&#x27;</span>)</span><br><span class="line"> </span><br><span class="line"> addons = [</span><br><span class="line">	Modify()</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<ul>
<li>ä¿®æ”¹å“åº”æ¶ˆæ¯ä½“-é€šè¿‡è¯»å–jsonæ–‡ä»¶çš„å­—ç¬¦ä¸²è¿”ç»™å®¢æˆ·ç«¯</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> ctx, http</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Modify</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">response</span>(<span class="params">self, flow</span>):</span></span><br><span class="line">        <span class="keyword">if</span> flow.request.url.startswith(<span class="string">&quot;https://xxx.x.xxx.com.cn/activityInfo/getPrizeInfo==&quot;</span>):</span><br><span class="line">        	//è¯»å–æ–‡ä»¶ï¼Œåœ¨å½“å‰æ–‡ä»¶è·¯å¾„ä¸‹æ‰§è¡Œè„šæœ¬ï¼Œå¦åˆ™éœ€è¦å†™æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ï¼›ä¸ç„¶ä¼šæ‰¾ä¸åˆ°è¯¥jsonæ–‡ä»¶</span><br><span class="line">       		 <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;getStatus.json&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">       		 	//ä»jsonæ–‡ä»¶ä¸­è¯»å–æ•°æ®æˆpythonå¯¹è±¡</span><br><span class="line">                res = json.load(f)</span><br><span class="line">            //å°†è¯»å–çš„pythonå¯¹è±¡è½¬æˆjsonå­—ç¬¦ä¸²å‘é€ç»™å®¢æˆ·ç«¯</span><br><span class="line">            flow.response.set_text(json.dumps(res))</span><br><span class="line">            ctx.log.info(<span class="string">&quot;modify order status&quot;</span>)</span><br><span class="line"> </span><br><span class="line"> addons = [</span><br><span class="line">	Modify()</span><br><span class="line">]</span><br></pre></td></tr></table></figure>







<h6 id="æ‹¦æˆªè¯·æ±‚"><a href="#æ‹¦æˆªè¯·æ±‚" class="headerlink" title="æ‹¦æˆªè¯·æ±‚"></a>æ‹¦æˆªè¯·æ±‚</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> http, ctx</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Lock</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Filter</span>:</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, filter_info</span>):</span></span><br><span class="line">    self.log_info = <span class="string">&quot;&quot;</span></span><br><span class="line">    self.mutex = Lock()</span><br><span class="line">    self.filter_info = filter_info</span><br><span class="line">    self.response_file = <span class="literal">None</span></span><br><span class="line">    self.switch_on = <span class="literal">False</span></span><br><span class="line">    self.log_file = <span class="string">&quot;log.txt&quot;</span></span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">log</span>(<span class="params">self, info</span>) -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    self.log_info += <span class="string">f&quot;<span class="subst">&#123;info&#125;</span>\n\n&quot;</span></span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">write_log</span>(<span class="params">self, mode=<span class="string">&quot;w+&quot;</span></span>) -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    self.mutex.acquire()</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(self.log_file, mode) <span class="keyword">as</span> f:</span><br><span class="line">      f.write(self.log_info)</span><br><span class="line">    self.mutex.release()</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_target_flow</span>(<span class="params">self, flow: http.HTTPFlow</span>) -&gt; bool:</span></span><br><span class="line">    <span class="keyword">for</span> info <span class="keyword">in</span> self.filter_info:</span><br><span class="line">      <span class="keyword">if</span> info[<span class="string">&quot;str_in_url&quot;</span>] <span class="keyword">in</span> flow.request.url:</span><br><span class="line">        self.log_file = info[<span class="string">&quot;log_file&quot;</span>]</span><br><span class="line">        self.switch_on = info[<span class="string">&quot;switch_on&quot;</span>]</span><br><span class="line">        <span class="keyword">if</span> info[<span class="string">&quot;response_file&quot;</span>] != <span class="literal">None</span>:</span><br><span class="line">          self.response_file = info[<span class="string">&quot;response_file&quot;</span>]</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">modify_response</span>(<span class="params">self, flow: http.HTTPFlow</span>) -&gt; http.HTTPFlow:</span></span><br><span class="line">    <span class="keyword">if</span> self.switch_on <span class="keyword">and</span> self.response_file:</span><br><span class="line">      <span class="keyword">with</span> <span class="built_in">open</span>(self.response_file, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        flow.response.content = f.read().encode()</span><br><span class="line">    <span class="keyword">return</span> flow</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">request</span>(<span class="params">self, flow: http.HTTPFlow</span>) -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    <span class="keyword">if</span> self.is_target_flow(flow):</span><br><span class="line">      self.log_info = <span class="string">&quot;&quot;</span></span><br><span class="line">      self.log(<span class="string">f&quot;â€”â€”METHODâ€”â€”\n<span class="subst">&#123;flow.request.method&#125;</span>&quot;</span>)</span><br><span class="line">      self.log(<span class="string">f&quot;â€”â€”HOSTâ€”â€”\n<span class="subst">&#123;flow.request.pretty_host&#125;</span>&quot;</span>)</span><br><span class="line">      self.log(<span class="string">f&quot;â€”â€”URLâ€”â€”\n<span class="subst">&#123;flow.request.pretty_url&#125;</span>&quot;</span>)</span><br><span class="line">      query = [i + <span class="string">&quot;:&quot;</span> + flow.request.query[i] + <span class="string">&quot;\n&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> flow.request.query]</span><br><span class="line">      self.log(<span class="string">f&quot;â€”â€”QUERY STRINGâ€”â€”\n<span class="subst">&#123;<span class="string">&#x27;&#x27;</span>.join(query)&#125;</span>&quot;</span>)</span><br><span class="line">      <span class="keyword">if</span> flow.request.urlencoded_form:</span><br><span class="line">        form = [i + <span class="string">&quot;:&quot;</span> + flow.request.urlencoded_form[i] + <span class="string">&quot;\n&quot;</span> <span class="keyword">for</span> i <span class="keyword">in</span> flow.request.urlencoded_form]</span><br><span class="line">        self.log(<span class="string">f&quot;â€”â€”FORMâ€”â€”\n<span class="subst">&#123;<span class="string">&#x27;&#x27;</span>.join(form)&#125;</span>&quot;</span>)</span><br><span class="line">      self.write_log()</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">response</span>(<span class="params">self, flow: http.HTTPFlow</span>) -&gt; <span class="keyword">None</span>:</span></span><br><span class="line">    <span class="keyword">if</span> self.is_target_flow(flow):</span><br><span class="line">      self.log_info = <span class="string">&quot;&quot;</span></span><br><span class="line">      self.log(<span class="string">f&quot;â€”â€”RESPONSE before modifiedâ€”â€”\n<span class="subst">&#123;flow.response.content.decode()&#125;</span>&quot;</span>)</span><br><span class="line">      flow = self.modify_response(flow)</span><br><span class="line">      self.log(<span class="string">f&quot;â€”â€”RESPONSE after modifiedâ€”â€”\n<span class="subst">&#123;flow.response.content.decode()&#125;</span>&quot;</span>)</span><br><span class="line">      self.write_log(mode=<span class="string">&quot;a&quot;</span>)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">filter_info = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;str_in_url&quot;</span>: <span class="string">&quot;getSimpleNews&quot;</span>,</span><br><span class="line">    <span class="string">&quot;log_file&quot;</span>: <span class="string">&quot;getSimpleNews_log.txt&quot;</span>,</span><br><span class="line">    <span class="string">&quot;switch_on&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">    <span class="string">&quot;response_file&quot;</span>: <span class="string">&quot;getSimpleNews_response.txt&quot;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="string">&quot;str_in_url&quot;</span>: <span class="string">&quot;getQQNewsComment&quot;</span>,</span><br><span class="line">    <span class="string">&quot;log_file&quot;</span>: <span class="string">&quot;getQQNewsComment_log.txt&quot;</span>,</span><br><span class="line">    <span class="string">&quot;switch_on&quot;</span>: <span class="literal">True</span>,</span><br><span class="line">    <span class="string">&quot;response_file&quot;</span>: <span class="literal">None</span>,</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line">addons = [</span><br><span class="line">  Filter(filter_info)</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="Script"><a href="#Script" class="headerlink" title="Script"></a>Script</h6><ol>
<li>å¯ä»¥å®šä¹‰ py æ–‡ä»¶ä¾› mitmproxy åŠ è½½ï¼Œå®šä¹‰è‹¥å¹²å‡½æ•°ï¼Œè¿™äº›å‡½æ•°å®ç° mitmproxy æä¾›çš„äº‹ä»¶</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> http</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request</span>(<span class="params">self, flow:http.HTTPFlow</span>):</span></span><br><span class="line">	...</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ç¼–å†™ py æ–‡ä»¶ä¾› mitmproxy åŠ è½½ï¼Œæ–‡ä»¶å®šä¹‰ addons æ•°ç»„ï¼Œæ•°ç»„å…ƒç´ æ˜¯ä¸€ä¸ªç±»å®ä¾‹ï¼Œè¿™äº›ç±»é‡Œé¢æœ‰è‹¥å¹²å‡½æ•°ï¼Œè¿™äº›å‡½æ•°å®ç° mitmproxy æä¾›çš„äº‹ä»¶</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> mitmproxy.http</span><br><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> ctx</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Counter</span>:</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">    self.num = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request</span>(<span class="params">self, flow: mitmproxy.http.HTTPFlow</span>):</span></span><br><span class="line">    self.num = self.num + <span class="number">1</span></span><br><span class="line">    ctx.log.info(<span class="string">&quot;We&#x27;ve seen %d flows&quot;</span> % self.num)</span><br><span class="line"></span><br><span class="line">addons = [</span><br><span class="line">    Counter()</span><br><span class="line">]</span><br></pre></td></tr></table></figure>







<p>sniffer.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> http</span><br><span class="line"> </span><br><span class="line">password_key = [<span class="string">&quot;password&quot;</span>, <span class="string">&quot;pwd&quot;</span>, <span class="string">&quot;pass&quot;</span>, <span class="string">&quot;passwd&quot;</span>, <span class="string">&quot;mm&quot;</span>, <span class="string">&quot;passport&quot;</span>, <span class="string">&quot;auth&quot;</span>, <span class="string">&quot;key&quot;</span>, <span class="string">&quot;mima&quot;</span>]</span><br><span class="line">form_login_key = [<span class="string">&quot;check&quot;</span>, <span class="string">&quot;login&quot;</span>, <span class="string">&quot;verify&quot;</span>, <span class="string">&quot;account&quot;</span>, <span class="string">&quot;logon&quot;</span>, <span class="string">&quot;signin&quot;</span>, <span class="string">&quot;denglu&quot;</span>]</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sniffer</span>:</span></span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">request</span>(<span class="params">self, flow: http.HTTPFlow</span>):</span></span><br><span class="line">		request = flow.request</span><br><span class="line">		url = request.pretty_url</span><br><span class="line">		form_url = <span class="built_in">str</span>(request.urlencoded_form)</span><br><span class="line">		<span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">			<span class="keyword">if</span> self.any_match(form_login_key, url) <span class="keyword">or</span> self.any_match(password_key, form_url):</span><br><span class="line">				self.resolve(flow)</span><br><span class="line">                </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">any_match</span>(<span class="params">self, <span class="built_in">list</span>, <span class="built_in">str</span>: <span class="built_in">str</span></span>):</span></span><br><span class="line">		lower_str = <span class="built_in">str</span>.lower()</span><br><span class="line">		<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">list</span>:</span><br><span class="line">			<span class="keyword">if</span> i <span class="keyword">in</span> lower_str:</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"> </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">resolve</span>(<span class="params">self, flow: http.HTTPFlow</span>):</span></span><br><span class="line">		request = flow.request</span><br><span class="line">		url = request.url</span><br><span class="line">		_from = <span class="built_in">str</span>(flow.client_conn.ip_address)</span><br><span class="line">		url_form = <span class="built_in">str</span>(request.urlencoded_form)</span><br><span class="line">		header = <span class="built_in">str</span>(request.headers)</span><br><span class="line"> </span><br><span class="line">		logging.info(<span class="string">&quot;url: %s \nheader: %s \nform: %s \nip_from: %s&quot;</span>, url, header, url_form, _from)</span><br></pre></td></tr></table></figure>

<p>addos.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sniffer <span class="keyword">import</span> Sniffer</span><br><span class="line"> </span><br><span class="line">addons = [</span><br><span class="line">	Sniffer()</span><br><span class="line">    <span class="comment"># YourSniffer()</span></span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>









<h4 id="è¿œç¨‹ä¸»æœºæŠ“åŒ…"><a href="#è¿œç¨‹ä¸»æœºæŠ“åŒ…" class="headerlink" title="è¿œç¨‹ä¸»æœºæŠ“åŒ…"></a>è¿œç¨‹ä¸»æœºæŠ“åŒ…</h4><p>linux ä¸»æœº CentOS8ç³»ç»Ÿï¼Œå®‰è£…å¥½ mitmproxy </p>
<p>äº‘ä¸»æœºå®‰å…¨ç»„å…¥æ–¹å‘æ·»åŠ 8080ç«¯å£ï¼Œå®å¡”é¢æ¿é˜²ç«å¢™å¼€æ”¾8080ç«¯å£</p>
<p>å¯åŠ¨ mitmdump</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mitmdump -w outfile --set block_global&#x3D;false</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°æŠ“å–åˆ°çš„é“¾æ¥</p>
<p>æŒ‡å®šè„šæœ¬å¤„ç†æ•°æ®ï¼Œå¦‚è·å–äº¬ä¸œçš„ pt_key</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mitmdump -s main.py --set block_global&#x3D;false</span><br><span class="line">#</span><br><span class="line">mitmweb -s script1.py --set block_global&#x3D;false</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mitmproxy.net.http.request <span class="keyword">import</span> Request</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">request</span>(<span class="params">flow</span>):</span></span><br><span class="line">    url = <span class="string">&#x27;https://mars.jd.com/log/sdk&#x27;</span></span><br><span class="line">    request = flow.request <span class="comment">#type: Request</span></span><br><span class="line">    <span class="keyword">if</span> request.url.startswith(url):</span><br><span class="line">        pt_key = request.cookies.get(<span class="string">&#x27;pt_key&#x27;</span>)</span><br><span class="line">        pt_pin = request.cookies.get(<span class="string">&#x27;pt_pin&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> pt_key <span class="keyword">and</span> pt_pin:</span><br><span class="line">            print(<span class="string">&#x27;æ¥æ”¶åˆ°ï¼špt_key=&#123;&#125;;pt_pin=&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(pt_key, pt_pin))</span><br></pre></td></tr></table></figure>





<h4 id="11-3-mitmdump-çˆ¬å–â€œå¾—åˆ°â€APPç”µå­ä¹¦ä¿¡æ¯"><a href="#11-3-mitmdump-çˆ¬å–â€œå¾—åˆ°â€APPç”µå­ä¹¦ä¿¡æ¯" class="headerlink" title="11.3 mitmdump çˆ¬å–â€œå¾—åˆ°â€APPç”µå­ä¹¦ä¿¡æ¯"></a>11.3 mitmdump çˆ¬å–â€œå¾—åˆ°â€APPç”µå­ä¹¦ä¿¡æ¯</h4><p>çˆ¬å–å¾—åˆ°APPç”µå­ä¹¦æ¿å—ï¼Œæ–°ä¹¦ä¸Šæ¶ç”µå­ä¹¦ä¿¡æ¯ï¼Œä¿å­˜åˆ° MongoDB</p>
<p>è¿è¡Œ mitmdump</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mitmdup -s script.py</span><br></pre></td></tr></table></figure>

<p>script.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">response</span>(<span class="params">flow</span>):</span></span><br><span class="line">	print(<span class="string">&#x27;url:&#x27;</span>, flow.request.url)</span><br><span class="line">	print(<span class="string">&#x27;response:&#x27;</span>, flow.response.text)</span><br></pre></td></tr></table></figure>

<p>æ‰“å°å¤ªå¤šæ¥å£ï¼Œä¸æ–¹ä¾¿åˆ†æï¼Œæ”¹ç”¨ Charles æŠ“å–æ•°æ®</p>
<p>å¯ä»¥çœ‹åˆ°åˆ—è¡¨æ¥å£ <a target="_blank" rel="noopener" href="https://entree.igetget.com/ebook2/v1/ebook/list">https://entree.igetget.com/ebook2/v1/ebook/list</a></p>
<h5 id="æ•°æ®æŠ“å–"><a href="#æ•°æ®æŠ“å–" class="headerlink" title="æ•°æ®æŠ“å–"></a>æ•°æ®æŠ“å–</h5><p>å¯¹æ¥å£åšè¿‡æ»¤é™åˆ¶ï¼ŒæŠ“å–æ¥å£æ•°æ®ï¼Œæå–ç»“æœä¸­å¯¹åº”çš„å­—æ®µ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> ctx</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">response</span>(<span class="params">flow</span>):</span></span><br><span class="line">	url = <span class="string">&#x27;https://entree.igetget.com/ebook2/v1/ebook/list&#x27;</span></span><br><span class="line">	requestUrl = flow.request.url <span class="comment">#type: str</span></span><br><span class="line">	<span class="keyword">if</span> requestUrl.startswith(url):</span><br><span class="line">		text = flow.response.text</span><br><span class="line">		data = json.loads(text)</span><br><span class="line">		books = data.get(<span class="string">&#x27;c&#x27;</span>).get(<span class="string">&#x27;list&#x27;</span>)</span><br><span class="line">		<span class="keyword">for</span> book <span class="keyword">in</span> books:</span><br><span class="line">			ctx.log.info(<span class="built_in">str</span>(book))</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°æ§åˆ¶å°ä¸Šè¾“å‡ºç”µå­ä¹¦ä¿¡æ¯</p>
<h5 id="æå–ä¿å­˜"><a href="#æå–ä¿å­˜" class="headerlink" title="æå–ä¿å­˜"></a>æå–ä¿å­˜</h5><p>å£°æ˜ MongoDB æ•°æ®åº“è¿æ¥ï¼Œæå–ä¿¡æ¯æ’å…¥æ•°æ®åº“</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> mitmproxy <span class="keyword">import</span> ctx</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> pymongo</span><br><span class="line"></span><br><span class="line">client = pymongo.MongoClient()</span><br><span class="line">db = client[<span class="string">&#x27;igetget&#x27;</span>] <span class="comment">#ç›¸å½“äºå“ªä¸ªæ•°æ®åº“</span></span><br><span class="line">collection = db[<span class="string">&#x27;books&#x27;</span>] <span class="comment">#ç›¸å½“äºå“ªä¸ªè¡¨</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">response</span>(<span class="params">flow</span>):</span></span><br><span class="line">	url = <span class="string">&#x27;https://entree.igetget.com/ebook2/v1/ebook/list&#x27;</span></span><br><span class="line">	requestUrl = flow.request.url <span class="comment">#type: str</span></span><br><span class="line">	<span class="keyword">if</span> requestUrl.startswith(url):</span><br><span class="line">		text = flow.response.text</span><br><span class="line">		data = json.loads(text)</span><br><span class="line">		books = data.get(<span class="string">&#x27;c&#x27;</span>).get(<span class="string">&#x27;list&#x27;</span>)</span><br><span class="line">		<span class="keyword">for</span> book <span class="keyword">in</span> books:</span><br><span class="line">			data = &#123;</span><br><span class="line">				<span class="string">&#x27;title&#x27;</span>: book.get(<span class="string">&#x27;operating_title&#x27;</span>),</span><br><span class="line">				<span class="string">&#x27;cover&#x27;</span>: book.get(<span class="string">&#x27;cover&#x27;</span>),</span><br><span class="line">				<span class="string">&#x27;summary&#x27;</span>: book.get(<span class="string">&#x27;other_share_summary&#x27;</span>),</span><br><span class="line">				<span class="string">&#x27;price&#x27;</span>: book.get(<span class="string">&#x27;price&#x27;</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			ctx.log.info(<span class="built_in">str</span>(book))</span><br><span class="line">			collection.insert(data)</span><br></pre></td></tr></table></figure>

<h4 id="11-4-Appium-ä½¿ç”¨"><a href="#11-4-Appium-ä½¿ç”¨" class="headerlink" title="11.4 Appium ä½¿ç”¨"></a>11.4 Appium ä½¿ç”¨</h4><p>Appium æ˜¯ä¸€ä¸ªè·¨å¹³å°ç§»åŠ¨ç«¯è‡ªåŠ¨åŒ–æµ‹è¯•å·¥å…·ï¼Œå¯ä»¥æ¨¡æ‹Ÿ APP å†…éƒ¨çš„å„ç§æ“ä½œï¼Œå¦‚ç‚¹å‡»ã€æ»‘åŠ¨ã€æ–‡æœ¬è¾“å…¥ç­‰ï¼Œå¯¹ iOS è®¾å¤‡ Appium ä½¿ç”¨ UIAutomation æ¥å®ç°é©±åŠ¨ï¼Œå¯¹ Android æ¥è¯´ï¼Œä½¿ç”¨ UIAutomator å’Œ Selendroid æ¥å®ç°é©±åŠ¨</p>
<p>Appium ç›¸å½“äºä¸€ä¸ªæœåŠ¡å™¨ï¼Œæˆ‘ä»¬å¯ä»¥å‘ Appium å‘é€ä¸€äº›æ“ä½œæŒ‡ä»¤ï¼ŒAppium å°±ä¼šæ ¹æ®ä¸åŒçš„æŒ‡ä»¤å¯¹ç§»åŠ¨è®¾å¤‡è¿›è¡Œé©±åŠ¨ï¼Œå®Œæˆä¸åŒçš„åŠ¨ä½œ</p>
<img src="Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-12Appçˆ¬å–/WeChatca0e02e38eb8e8ab9bcfa7bd8d363752.png" alt="WeChatca0e02e38eb8e8ab9bcfa7bd8d363752" style="zoom:50%;" />

<p>ç‚¹å‡» Start Server å³å¯å¯åŠ¨ Appium çš„æœåŠ¡ï¼Œç›¸å½“äºå¼€å¯äº†ä¸€ä¸ª Appium æœåŠ¡ï¼Œå¯ä»¥é€šè¿‡ Appium å†…ç½®é©±åŠ¨æˆ– Python ä»£ç å‘ Appium çš„æœåŠ¡å‘é€ä¸€ç³»åˆ—æ“ä½œæŒ‡ä»¤ï¼ŒAppium å°±ä¼šæ ¹æ®ä¸åŒçš„æŒ‡ä»¤å¯¹ç§»åŠ¨è®¾å¤‡è¿›è¡Œé©±åŠ¨ï¼Œå®Œæˆä¸åŒçš„åŠ¨ä½œ</p>
<h6 id="Appiumå†…ç½®é©±åŠ¨æ‰“å¼€APP"><a href="#Appiumå†…ç½®é©±åŠ¨æ‰“å¼€APP" class="headerlink" title="Appiumå†…ç½®é©±åŠ¨æ‰“å¼€APP"></a>Appiumå†…ç½®é©±åŠ¨æ‰“å¼€APP</h6><p>Appium è¿è¡Œä¹‹åæ­£åœ¨ç›‘å¬ 4723 ç«¯å£ï¼Œæˆ‘ä»¬å¯ä»¥å‘æ­¤ç«¯å£å¯¹åº”çš„æœåŠ¡æ¥å£å‘é€æ“ä½œæŒ‡ä»¤</p>
<p>Hostè®¾ç½®127.0.0.1</p>
<p>æ‰“å¼€ Appium Inspector</p>
<p>é…ç½®å‚æ•°</p>
<p>Remote Path: /wd/hub</p>
<p>platformName: å“å°åç§° iOS æˆ– Android</p>
<p>deviceNameï¼šè®¾å¤‡åç§°</p>
<p>bundleIdï¼šAPPåŒ…å(ä¸‹é¢æˆªå›¾æ”¹æˆ bundleId)</p>
<p>å…¶å®ƒé…ç½®å‚æ•° <a target="_blank" rel="noopener" href="https://github.com/appium/appium/blob/master/docs/en/writing-running-appium/caps.md">https://github.com/appium/appium/blob/master/docs/en/writing-running-appium/caps.md</a></p>
<img src="Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-12Appçˆ¬å–/3641650270925_.pic.jpg" alt="3641650270925_.pic" style="zoom: 67%;" />

<p>Start SessionæŠ¥é”™</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Failed to create session. An unknown server-side error occurred while processing the command. Original error: Unable to launch WebDriverAgent because of xcodebuild failure: xcodebuild failed with code 70 xcodebuild error message: . Make sure you follow the tutorial at https:&#x2F;&#x2F;github.com&#x2F;appium&#x2F;appium-xcuitest-driver&#x2F;blob&#x2F;master&#x2F;docs&#x2F;real-device-config.md. Try to remove the WebDriverAgentRunner application from the device if it is installed and reboot the device.</span><br></pre></td></tr></table></figure>

<p>è¿›å…¥ Appium è·¯å¾„ </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;Applications&#x2F;Appium Server GUI.app&#x2F;Contents&#x2F;Resources&#x2F;app&#x2F;node_modules&#x2F;appium&#x2F;node_modules&#x2F;appium-webdriveragent</span><br></pre></td></tr></table></figure>

<p>æ‰“å¼€ WebDriverAgent é¡¹ç›®ï¼Œé€‰æ‹© Targets-WebDriverAgentRunner é…ç½®å¥½è¯ä¹¦ </p>
<p>Product - Test ï¼Œå¦‚æœè¿æ¥æ‰‹æœºï¼Œä¼šå®‰è£…ä¸€ä¸ª WebDriverAgent appï¼Œå¯åŠ¨ååˆå›åˆ°æ¡Œé¢ï¼Œæ§åˆ¶å°å¯ä»¥çœ‹åˆ°è®¾å¤‡çš„IPåœ°å€ <a target="_blank" rel="noopener" href="http://10.1.253.120:8100/">http://10.1.253.120:8100</a> åŠ ä¸Š/status å³ <a target="_blank" rel="noopener" href="http://10.1.253.120:8100/status%EF%BC%8C%E6%89%93%E5%BC%80%E6%B5%8F%E8%A7%88%E5%99%A8%EF%BC%8C%E5%A6%82%E6%9E%9C%E5%87%BA%E7%8E%B0%E4%B8%80%E4%B8%B2">http://10.1.253.120:8100/statusï¼Œæ‰“å¼€æµè§ˆå™¨ï¼Œå¦‚æœå‡ºç°ä¸€ä¸²</a> JSONï¼Œè¯´æ˜ WDA å®‰è£…æˆåŠŸäº†ï¼Œæ‰“å¼€<a target="_blank" rel="noopener" href="http://10.1.253.120:8100/inspector">http://10.1.253.120:8100/inspector</a> å¯ä»¥æŸ¥çœ‹ç•Œé¢å’Œå…ƒç´ ä¿¡æ¯</p>
<p>å†æ¬¡ç‚¹å‡» StartSession</p>
<img src="Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-12Appçˆ¬å–/3651650273841_.pic.jpg" alt="3651650273841_.pic" style="zoom:70%;" />

<p>å·¦è¾¹æ˜¾ç¤ºAPPç•Œé¢ï¼Œé€‰ä¸­æŸä¸ªå…ƒç´ ï¼Œä¸­é—´å°±æ˜¾ç¤ºå…ƒç´ å¯¹åº”æºä»£ç ï¼Œå³æ æ˜¾ç¤ºå…ƒç´ çš„åŸºæœ¬ä¿¡æ¯ï¼Œå¦‚å…ƒç´  idã€classã€text ç­‰ï¼Œä»¥åŠå¯ä»¥æ‰§è¡Œçš„æ“ä½œï¼Œå¦‚ Tapã€Send Keysã€Clear</p>
<p>è¿˜å¯ä»¥å½•åˆ¶æ“ä½œåŠ¨ä½œï¼Œçª—å£ä¸­æ“ä½œçš„ APPè¡Œä¸ºéƒ½ä¼šè¢«è®°å½•ä¸‹æ¥ï¼ŒRecorder å¤„å¯ä»¥è‡ªåŠ¨ç”Ÿæˆå¯¹åº”è¯­è¨€çš„ä»£ç </p>
<img src="Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-12Appçˆ¬å–/3661650274120_.pic.jpg" alt="3661650274120_.pic" style="zoom:80%;" />

<h6 id="Pythonä»£ç é©±åŠ¨APP"><a href="#Pythonä»£ç é©±åŠ¨APP" class="headerlink" title="Pythonä»£ç é©±åŠ¨APP"></a>Pythonä»£ç é©±åŠ¨APP</h6><p>ä»£ç ä¸­æŒ‡å®š Appium Server</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server = <span class="string">&#x27;http://localhost:4723/wd/hub&#x27;</span></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ª Server åœ¨åˆšæ‰“å¼€ Appium çš„æ—¶å€™å°±å·²ç»å¼€å¯äº†ï¼Œæ˜¯åœ¨ 4723 ç«¯å£ä¸Šè¿è¡Œçš„</p>
<p>æ–°å»ºä¸€ä¸ª Sessionï¼Œè¿™ç±»ä¼¼ç‚¹å‡» Appium å†…ç½®é©±åŠ¨çš„ Start Session æŒ‰é’®ç›¸åŒçš„åŠŸèƒ½</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> appium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> WebDriverWait</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">	server = <span class="string">&#x27;http://localhost:4723/wd/hub&#x27;</span></span><br><span class="line">	desired_caps = &#123;</span><br><span class="line">		<span class="string">&#x27;platformName&#x27;</span>: <span class="string">&quot;iOS&quot;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:deviceName&#x27;</span>: <span class="string">&#x27;iPhoneq&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:bundleId&#x27;</span>: <span class="string">&#x27;com.SwiftDemo&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:udid&#x27;</span>: <span class="string">&#x27;4ce52917e9a0932f3c821e2418a03d2a993c5650&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:platformVersion&#x27;</span>: <span class="string">&#x27;14.5&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:xcodeSigningId&#x27;</span>: <span class="string">&#x27;iPhone Developer&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:xcodeOrgId&#x27;</span>: <span class="string">&#x27;C28X7H9ZW6&#x27;</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	driver = webdriver.Remote(server, desired_caps)</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œåå°±å¯åŠ¨ APPäº† </p>
<p>æŸ¥çœ‹åˆšæ‰å½•åˆ¶ç”Ÿæˆçš„Pythonä»£ç </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">el1 = driver.find_element(by=AppiumBy.ACCESSIBILITY_ID, value=<span class="string">&quot;DelegateProxy&quot;</span>) el1.click() </span><br><span class="line">el2 = driver.find_element(by=AppiumBy.ACCESSIBILITY_ID, value=<span class="string">&quot;ImagePickerç…§ç‰‡é€‰æ‹©&quot;</span>) el2.click()</span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> appium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">	server = <span class="string">&#x27;http://localhost:4723/wd/hub&#x27;</span></span><br><span class="line">	desired_caps = &#123;</span><br><span class="line">		<span class="string">&#x27;platformName&#x27;</span>: <span class="string">&quot;iOS&quot;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:deviceName&#x27;</span>: <span class="string">&#x27;iPhoneq&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:bundleId&#x27;</span>: <span class="string">&#x27;com.SwiftDemo&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:udid&#x27;</span>: <span class="string">&#x27;4ce52917e9a0932f3c821e2418a03d2a993c5650&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:platformVersion&#x27;</span>: <span class="string">&#x27;14.5&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:xcodeSigningId&#x27;</span>: <span class="string">&#x27;iPhone Developer&#x27;</span>,</span><br><span class="line">		<span class="string">&#x27;appium:xcodeOrgId&#x27;</span>: <span class="string">&#x27;C28X7H9ZW6&#x27;</span>,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	driver = webdriver.Remote(server, desired_caps)</span><br><span class="line">  <span class="comment">#è·å–å…ƒç´ æ—¶è®¾ç½®ç­‰å¾…</span></span><br><span class="line">	wait = WebDriverWait(driver, <span class="number">30</span>)</span><br><span class="line">	ele1 = wait.until(EC.presence_of_element_located((By.ID, <span class="string">&#x27;DelegateProxy&#x27;</span>)))</span><br><span class="line">	ele1.click()</span><br><span class="line">	ele2 = wait.until(EC.presence_of_element_located((By.ID, <span class="string">&#x27;ImagePickerç…§ç‰‡é€‰æ‹©&#x27;</span>)))</span><br><span class="line">	ele2.click()</span><br></pre></td></tr></table></figure>

<h6 id="API"><a href="#API" class="headerlink" title="API"></a>API</h6><p>ä½¿ç”¨çš„Pythonåº“ä¸º AppiumPythonClint <a target="_blank" rel="noopener" href="https://github.com/appium/python-client">https://github.com/appium/python-client</a> æ­¤åº“ç»§æ‰¿è‡ª Selenium</p>
<ul>
<li>åˆå§‹åŒ–</li>
</ul>
<p>ä»£ç å‚æ•°ä¸Šé¢çš„</p>
<p>å¦‚æœè¦æ‰“å¼€çš„appæ²¡æœ‰å…ˆå®‰è£…åˆ°æ‰‹æœºä¸Šï¼Œä¹Ÿå¯ä»¥ç›´æ¥æŒ‡å®šappçš„åŒ…è·¯å¾„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app &#x3D; os.path.abspath(&#39;&#x2F;Users&#x2F;xx&#x2F;xx&#x2F;build&#x2F;Debug-iphoneos&#x2F;xx.app&#39;)</span><br></pre></td></tr></table></figure>

<ul>
<li>æŸ¥æ‰¾å…ƒç´ </li>
</ul>
<p>å¯ä»¥ä½¿ç”¨ Selenium ä¸­é€šç”¨çš„æŸ¥æ‰¾æ–¹æ³•æ¥æŸ¥æ‰¾å…ƒç´ </p>
<p>iOS å¹³å°ï¼Œå¯ä»¥ä½¿ç”¨ UIAutomation æ¥è¿›è¡Œå…ƒç´ é€‰æ‹©</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">el = self.driver.find_element_by_ios_uiautomation(<span class="string">&#x27;.elements()[0]&#x27;</span>)</span><br><span class="line">el = self.driver.find_element_by_ios_uiautomation(<span class="string">&#x27;.elements()&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>è¿˜å¯ä»¥ä½¿ç”¨ iOS Predicates æ¥è¿›è¡Œå…ƒç´ é€‰æ‹©</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">el = self.driver.find_element_by_ios_predicate(<span class="string">&#x27;wdName=&quot;Buttons&quot;&#x27;</span>)</span><br><span class="line">el = self.driver.find_element_by_ios_predicate(<span class="string">&#x27;wdName=&quot;SearchBar&quot; AND isWDDivisible == 1&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ä½¿ç”¨ iOS Class Chain æ¥é€‰æ‹©</p>
<p>æ­¤æ–¹æ³•åªé€‚ç”¨äº XCUIText é©±åŠ¨</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">el = self.driver.find_element_by_ios_class_chain(<span class="string">&#x27;XCUIElementTypeWindow/XCUIElementTypeButton[3]&#x27;</span>)</span><br><span class="line">el = self.driver.find_element_by_ios_class_chain(<span class="string">&#x27;XCUIElementTypeWindow/XCUIElementTypeButton&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>ç‚¹å‡»</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tap(self, positions, duration=<span class="literal">None</span>)</span><br><span class="line"><span class="comment">#positions ç‚¹å‡»çš„ä½ç½®ç»„æˆçš„åˆ—è¡¨</span></span><br><span class="line"><span class="comment">#duration  ç‚¹å‡»æŒç»­æ—¶é—´</span></span><br><span class="line">tap([(<span class="number">100</span>,<span class="number">200</span>),(<span class="number">100</span>,<span class="number">60</span>)], <span class="number">500</span>) <span class="comment">#æ¨¡æ‹Ÿç‚¹å‡»å±å¹•çš„å‡ ä¸ªç‚¹</span></span><br></pre></td></tr></table></figure>

<p>å¯¹æŸä¸ªå…ƒç´ å¦‚æŒ‰é’®ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ click() æ¨¡æ‹Ÿç‚¹å‡»</p>
<ul>
<li>å±å¹•æ‹–åŠ¨</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">scroll(self, origin_el, destination_el)</span><br><span class="line"><span class="comment">#å®ç°ä»å…ƒç´  origin_el æ»šåŠ¨è‡³ destination_el</span></span><br><span class="line"><span class="comment">#origin_el è¢«æ“ä½œå…ƒç´ </span></span><br><span class="line"><span class="comment">#destination_el ç›®æ ‡å…ƒç´ </span></span><br><span class="line"></span><br><span class="line">swipe(self, start_x, start_y, end_X, end_Y, duration=<span class="literal">None</span>) <span class="comment">#ä»Aç‚¹æ»‘åŠ¨åˆ°Bç‚¹</span></span><br><span class="line"></span><br><span class="line">flick(self, start_x, start_y, end_X, end_Y) <span class="comment">#ä»Aç‚¹å¿«é€Ÿæ»‘åŠ¨åˆ°Bç‚¹</span></span><br></pre></td></tr></table></figure>

<ul>
<li>æ‹–æ‹½</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">drag_and_drop(self, origin_el, destination_el)</span><br><span class="line"><span class="comment">#å®ç°ä»å…ƒç´  origin_el æ‹–æ‹½è‡³ destination_el</span></span><br></pre></td></tr></table></figure>

<ul>
<li>æ–‡æœ¬è¾“å…¥</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set_text()</span><br></pre></td></tr></table></figure>

<ul>
<li>åŠ¨ä½œé”®</li>
</ul>
<p>ä¸ Selenium ä¸­çš„ActionChains ç±»ä¼¼ï¼Œ Appi ä¸­çš„ TouchAction å¯æ”¯æŒçš„æ–¹æ³•æœ‰ tap()ã€press()ã€long_press()ã€release()ã€move_to()ã€wait()ã€cancel() ç­‰</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">el = self.driver.find_element_by_accessiblity_id</span><br><span class="line">action = TouchAction(self.driver)</span><br><span class="line">action.tap(el).perform</span><br></pre></td></tr></table></figure>

<p>é€‰ä¸­ä¸€ä¸ªå…ƒç´ ï¼Œç„¶ååˆ©ç”¨ TouchAction å®ç°ç‚¹å‡»æ“ä½œ</p>
<p>å¦‚æœè¦æ‹–åŠ¨</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">els = self.driver.find_elements_by_class_name(<span class="string">&#x27;listView&#x27;</span>)</span><br><span class="line">a1 = TouchAction()</span><br><span class="line">a1.press(els[<span class="number">0</span>]).move_to(x=<span class="number">10</span>, y=<span class="number">0</span>).move_to(x=<span class="number">10</span>,y=<span class="number">-75</span>).move_to(x=<span class="number">10</span>,y=<span class="number">-100</span>).release()</span><br><span class="line">aw = TouchAction()</span><br><span class="line">a2.press(els[<span class="number">1</span>]).move_to(x=<span class="number">10</span>, y=<span class="number">0</span>).move_to(x=<span class="number">10</span>, y=<span class="number">-30</span>).move_to(x=<span class="number">10</span>, y=<span class="number">-600</span>).release()</span><br></pre></td></tr></table></figure>

<p>æ›´å¤šå‚è€ƒ <a target="_blank" rel="noopener" href="https://testerhome.com/topics/3711">https://testerhome.com/topics/3711</a></p>
<h4 id="11-5-Appium-çˆ¬å–æœ‹å‹åœˆ"><a href="#11-5-Appium-çˆ¬å–æœ‹å‹åœˆ" class="headerlink" title="11.5 Appium çˆ¬å–æœ‹å‹åœˆ"></a>11.5 Appium çˆ¬å–æœ‹å‹åœˆ</h4><p>ä»£ç  <a target="_blank" rel="noopener" href="https://github.com/Python3WebSpider/Moments">https://github.com/Python3WebSpider/Moments</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">FLICK_START_X = <span class="number">300</span></span><br><span class="line">FLICK_START_Y = <span class="number">300</span></span><br><span class="line">FLICK_DISTANCE = <span class="number">700</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#... è¿›å…¥æœ‹å‹åœˆé¡µé¢ æ¨¡æ‹Ÿä¸Šæ»‘</span></span><br><span class="line"> self.driver.swipe(FLICK_START_X, FLICK_START_Y + FLICK_DISTANCE, FLICK_START_X, FLICK_START_Y)</span><br><span class="line"><span class="comment"># éå†æ¯æ¡çŠ¶æ€ è·å–æ•°æ®ä¿å­˜</span></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># æ˜µç§°</span></span><br><span class="line">        nickname = item.find_element_by_id(<span class="string">&#x27;com.tencent.mm:id/aig&#x27;</span>).get_attribute(<span class="string">&#x27;text&#x27;</span>)</span><br><span class="line">        <span class="comment"># æ­£æ–‡</span></span><br><span class="line">        content = item.find_element_by_id(<span class="string">&#x27;com.tencent.mm:id/cwm&#x27;</span>).get_attribute(<span class="string">&#x27;text&#x27;</span>)</span><br><span class="line"><span class="comment">#...</span></span><br></pre></td></tr></table></figure>





<p>ä½¿ç”¨ç»ˆç«¯ä»£æ›¿Xcode</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># è§£é”keychainï¼Œä»¥ä¾¿å¯ä»¥æ­£å¸¸çš„ç­¾ååº”ç”¨ï¼Œ</span><br><span class="line">PASSWORD&#x3D;&quot;replace-with-your-password&quot;</span><br><span class="line">security unlock-keychain -p $PASSWORD ~&#x2F;Library&#x2F;Keychains&#x2F;login.keychain</span><br><span class="line"></span><br><span class="line"># è·å–è®¾å¤‡çš„UDID</span><br><span class="line">UDID&#x3D;$(idevice_id -l | head -n1)</span><br><span class="line"></span><br><span class="line"># è¿è¡Œæµ‹è¯•</span><br><span class="line">xcodebuild -project WebDriverAgent.xcodeproj -scheme WebDriverAgentRunner -destination &quot;id&#x3D;$UDID&quot; test</span><br></pre></td></tr></table></figure>



<h4 id="11-5-Appium-mitmdumpçˆ¬å–äº¬ä¸œå•†å“"><a href="#11-5-Appium-mitmdumpçˆ¬å–äº¬ä¸œå•†å“" class="headerlink" title="11.5 Appium+mitmdumpçˆ¬å–äº¬ä¸œå•†å“"></a>11.5 Appium+mitmdumpçˆ¬å–äº¬ä¸œå•†å“</h4><p>Charles æŠ“åŒ…åˆ†ææ•°æ®</p>
<p>mitmdump æŠ“å–è§£ææ•°æ®ä¿å­˜</p>
<p>Appiumé©±åŠ¨APPå®Œæˆä¸€ç³»åˆ—åŠ¨ä½œ</p>
<h4 id="æŠ¥é”™é—®é¢˜"><a href="#æŠ¥é”™é—®é¢˜" class="headerlink" title="æŠ¥é”™é—®é¢˜"></a>æŠ¥é”™é—®é¢˜</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A new session could not be created. Details: Appium&#39;s IosDriver does not support xcode version 13.3</span><br><span class="line">Apple has deprecated UIAutomation. Use the &quot;XCUITest&quot; automationName capability instead</span><br></pre></td></tr></table></figure>

<p>æ·»åŠ å‚æ•° automationName=XCUITest</p>
<h4 id="11-6-Airtest"><a href="#11-6-Airtest" class="headerlink" title="11.6 Airtest"></a>11.6 Airtest</h4><p>è‡ªåŠ¨åŒ–æµ‹è¯•å·¥å…·</p>
<p>airtest å®˜æ–¹æ–‡æ¡£ <a target="_blank" rel="noopener" href="https://airtest.readthedocs.io/zh_CN/latest/index.html">https://airtest.readthedocs.io/zh_CN/latest/index.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/15/opencv/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="ç®€å•è®°å½•ä¸‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/15/opencv/" class="post-title-link" itemprop="url">opencv</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>
      

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-04-15 11:10:46 / ä¿®æ”¹æ—¶é—´ï¼š12:18:16" itemprop="dateCreated datePublished" datetime="2022-04-15T11:10:46+08:00">2022-04-15</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install opencv-python</span><br></pre></td></tr></table></figure>



<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">from</span> numpy <span class="keyword">import</span> ndarray</span><br><span class="line">bg_img = cv2.imread(<span class="string">&#x27;shot2.png&#x27;</span>) <span class="comment">#è¯»å–å›¾ç‰‡</span></span><br><span class="line"><span class="comment">#imgCanny = cv2.Canny(img,threshold1,threshold2)</span></span><br><span class="line">bg_edge = cv2.Canny(bg_img, <span class="number">100</span>, <span class="number">200</span>) <span class="comment">#è¯†åˆ«å›¾ç‰‡è¾¹ç¼˜ å¾—åˆ°å›¾ç‰‡è¾¹ç¼˜çš„ç°åº¦å›¾</span></span><br><span class="line">bg_pic = cv2.cvtColor(bg_edge, cv2.COLOR_GRAY2RGB) <span class="comment">#å°†å›¾ç‰‡è½¬æ¢ä¸ºRBGæ ¼å¼</span></span><br><span class="line">imgGray = cv2.cvtColor(img,cv2.COLOR_BGR2GRAY) <span class="comment">#å°†å›¾åƒè½¬æ¢ä¸ºç°åº¦å›¾åƒ</span></span><br></pre></td></tr></table></figure>



<h5 id="è¯»å†™æ˜¾ç¤ºå›¾åƒ"><a href="#è¯»å†™æ˜¾ç¤ºå›¾åƒ" class="headerlink" title="è¯»å†™æ˜¾ç¤ºå›¾åƒ"></a>è¯»å†™æ˜¾ç¤ºå›¾åƒ</h5><ul>
<li>imread()</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">img = cv2.imread(<span class="string">&quot;PATH_TO_IMAGE.jpg/png&quot;</span>)</span><br><span class="line">img = imread(<span class="string">&quot;images/dog0.jpg&quot;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>imshow()</li>
</ul>
<p>ä¸¤ä¸ªè¾“å…¥ï¼Œä¸€ä¸ªæ˜¯å›¾åƒçª—å£çš„åå­—å³titleï¼Œä¸€ä¸ªæ˜¯æ‰€å±•ç¤ºå›¾åƒçš„åƒç´ çŸ©é˜µ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cv2.imshow(<span class="string">&#x27;gray_scale&#x27;</span>, gray_scale)</span><br><span class="line"><span class="comment">#gray_scale çŸ©é˜µçš„æ•°æ®ç±»å‹æ˜¯ np.uint8ï¼Œæµ®ç‚¹æ•°ç±»å‹ä¼šæœ‰æ˜¾ç¤ºå¼‚å¸¸æƒ…å†µ</span></span><br><span class="line"><span class="comment">#åŒæ—¶éœ€è¦åœ¨è¯­å¥ååŠ ä¸Š</span></span><br><span class="line">cv2.waitKey(<span class="number">0</span>)</span><br><span class="line"><span class="comment">#åœ¨æ—¶é—´kï¼ˆå•ä½msï¼‰å†…ï¼Œç­‰å¾…ç”¨æˆ·æŒ‰é”®ï¼ˆä¾‹å¦‚å…³é—­å›¾åƒçª—å£ï¼‰è§¦å‘ï¼Œå¦‚æœæ²¡æœ‰è§¦å‘äº‹ä»¶ï¼Œåˆ™è·³å‡ºç­‰å¾…</span></span><br><span class="line"><span class="comment">#k=0ï¼Œåˆ™æ— é™ç­‰å¾…è§¦å‘äº‹ä»¶</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">img = cv2.imread(<span class="string">&#x27;shot2.png&#x27;</span>, flags=<span class="number">0</span>) <span class="comment">#flag=0è¯»å–ä¸ºç°åº¦å›¾åƒ flag=1è¯»å–ä¸ºå½©è‰²å›¾åƒRGB</span></span><br><span class="line">cv2.imshow(<span class="string">&#x27;demo&#x27;</span>, img)</span><br><span class="line">cv2.waitKey(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>imwrite()</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cv2.imwrite(FILENAME, IMAGE)</span></span><br><span class="line">cv2.imwrite(<span class="string">&#x27;images/img&#x27;</span>,img)</span><br></pre></td></tr></table></figure>

<h5 id="è°ƒæ•´å¤§å°å’Œè£å‰ªå›¾åƒ"><a href="#è°ƒæ•´å¤§å°å’Œè£å‰ªå›¾åƒ" class="headerlink" title="è°ƒæ•´å¤§å°å’Œè£å‰ªå›¾åƒ"></a>è°ƒæ•´å¤§å°å’Œè£å‰ªå›¾åƒ</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">img = cv2.imread(<span class="string">&#x27;shot2.png&#x27;</span>, flags=<span class="number">0</span>) <span class="comment"># type: ndarray</span></span><br><span class="line">print(img.shape) <span class="comment"># (164, 290)</span></span><br><span class="line"></span><br><span class="line">imgResize1 = cv2.resize(img, (<span class="number">100</span>, <span class="number">100</span>))</span><br><span class="line">imgResize2 = cv2.resize(img, (<span class="number">1024</span>, <span class="number">1024</span>))</span><br><span class="line"></span><br><span class="line">cv2.imshow(<span class="string">&#x27;Image&#x27;</span>, img)</span><br><span class="line">cv2.imshow(<span class="string">&#x27;Image Resize2&#x27;</span>, imgResize1)</span><br><span class="line">cv2.imshow(<span class="string">&#x27;Image Resize2&#x27;</span>, imgResize2)</span><br><span class="line">cv2.waitKey(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>ä¸æƒ³å¯¹å®½é«˜è¿›è¡Œç¡¬ç¼–ç ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å½¢çŠ¶ï¼Œç„¶åç”¨ç´¢å¼•å¢åŠ å®½é«˜</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">img = cv2.imread(<span class="string">&#x27;shot2.png&#x27;</span>, flags=<span class="number">0</span>) <span class="comment"># type: ndarray</span></span><br><span class="line">print(img.shape)</span><br><span class="line">shape = img.shape</span><br><span class="line">imgResize1 = cv2.resize(img, (shape[<span class="number">0</span>] // <span class="number">2</span>, shape[<span class="number">1</span>] // <span class="number">2</span>))  <span class="comment">##Decrease size</span></span><br><span class="line">imgResize2 = cv2.resize(img, (shape[<span class="number">0</span>] * <span class="number">2</span>, shape[<span class="number">1</span>] * <span class="number">2</span>))  <span class="comment">##Increase size</span></span><br><span class="line">cv2.imshow(<span class="string">&quot;Image Resize&quot;</span>, imgResize1)</span><br><span class="line">cv2.imshow(<span class="string">&quot;Image Increase size&quot;</span>, imgResize2)</span><br><span class="line">cv2.waitKey(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>è£å‰ªå›¾åƒ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#retval = img[y:y+h, x:x+w]</span></span><br><span class="line"><span class="comment"># img nparray å¤šç»´æ•°ç»„</span></span><br><span class="line"><span class="comment"># x,y å·¦ä¸Šè§’åæ ‡å€¼</span></span><br><span class="line"><span class="comment"># w,h å®½åº¦ã€é«˜åº¦</span></span><br><span class="line">img = cv2.imread(<span class="string">&#x27;shot2.png&#x27;</span>, flags=<span class="number">1</span>) <span class="comment"># type: ndarray</span></span><br><span class="line">print(img.shape)<span class="comment">#(164, 290, 3)</span></span><br><span class="line">imgCropped = img[<span class="number">0</span>:<span class="number">100</span>, <span class="number">50</span>:<span class="number">100</span>]</span><br><span class="line"></span><br><span class="line">cv2.imshow(<span class="string">&#x27;image&#x27;</span>, img)</span><br><span class="line">cv2.imshow(<span class="string">&#x27;cropped&#x27;</span>, imgCropped)</span><br><span class="line">print(imgCropped.shape)<span class="comment">#(100, 50, 3)</span></span><br><span class="line">cv2.waitKey(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h5 id="ç»˜åˆ¶å‡ ä½•å›¾å½¢"><a href="#ç»˜åˆ¶å‡ ä½•å›¾å½¢" class="headerlink" title="ç»˜åˆ¶å‡ ä½•å›¾å½¢"></a>ç»˜åˆ¶å‡ ä½•å›¾å½¢</h5><ul>
<li>ç»˜åˆ¶çŸ©å½¢</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cv.rectangle(img,leftupper,rightdown,color,thickness)</span></span><br><span class="line"><span class="comment">#img:è¦ç»˜åˆ¶çŸ©å½¢çš„å›¾åƒ</span></span><br><span class="line"><span class="comment">#Leftupper, rightdown: çŸ©å½¢çš„å·¦ä¸Šè§’å’Œå³ä¸‹è§’åæ ‡</span></span><br><span class="line"><span class="comment">#color: çº¿æ¡çš„é¢œè‰²</span></span><br><span class="line"><span class="comment">#Thickness: çº¿æ¡å®½åº¦</span></span><br><span class="line">img_copy = img.copy()</span><br><span class="line"><span class="comment"># Draw a rectangle</span></span><br><span class="line">cv2.rectangle(img_copy, pt1 = (<span class="number">800</span>, <span class="number">470</span>), pt2 =(<span class="number">980</span>, <span class="number">530</span>),</span><br><span class="line">             color = (<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>), thickness = <span class="number">5</span>)</span><br><span class="line">plt.imshow(img_copy)</span><br></pre></td></tr></table></figure>

<h5 id="è½®å»“"><a href="#è½®å»“" class="headerlink" title="è½®å»“"></a>è½®å»“</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">img = cv2.imread(<span class="string">&#x27;shot1.png&#x27;</span>, flags=<span class="number">1</span>) <span class="comment"># type: ndarray</span></span><br><span class="line">gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)</span><br><span class="line">ret, thresh = cv2.threshold(gray, <span class="number">127</span>, <span class="number">255</span>, cv2.THRESH_BINARY)</span><br><span class="line">contours, hierachy = cv2.findContours(thresh, cv2.RETR_TREE, cv2.CHAIN_APPROX_NONE)</span><br><span class="line">draw_img = img.copy()</span><br><span class="line">res = cv2.drawContours(draw_img, contours, <span class="number">-1</span>, (<span class="number">0</span>,<span class="number">0</span>,<span class="number">255</span>), <span class="number">2</span>) <span class="comment">#ç»˜åˆ¶è½®å»“</span></span><br><span class="line">cv2.imshow(<span class="string">&#x27;res&#x27;</span>, res)</span><br><span class="line">cv2.imshow(<span class="string">&#x27;image&#x27;</span>, img)</span><br><span class="line">cv2.waitKey(<span class="number">0</span>)</span><br><span class="line">cv2.destroyAllWindows()</span><br></pre></td></tr></table></figure>



<h6 id="ç°åº¦å›¾"><a href="#ç°åº¦å›¾" class="headerlink" title="ç°åº¦å›¾"></a>ç°åº¦å›¾</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">img_gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY) <span class="comment">#ç°åº¦å›¾</span></span><br></pre></td></tr></table></figure>

<h6 id="å›¾åƒé˜ˆå€¼"><a href="#å›¾åƒé˜ˆå€¼" class="headerlink" title="å›¾åƒé˜ˆå€¼"></a>å›¾åƒé˜ˆå€¼</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">ret, dst = cv2.threshold(src, thresh, maxval, <span class="built_in">type</span>)</span><br><span class="line"><span class="comment">#src è¾“å…¥å›¾ï¼Œåªèƒ½è¾“å…¥å•é€šé“å›¾ï¼Œé€šå¸¸æ¥è¯´ä¸ºç°åº¦å›¾</span></span><br><span class="line"><span class="comment">#dst è¾“å‡ºå›¾</span></span><br><span class="line"><span class="comment">#thresh é˜ˆå€¼</span></span><br><span class="line"><span class="comment">#maxval å½“åƒç´ å€¼è¶…è¿‡äº†é˜ˆå€¼ï¼ˆæˆ–è€…å°äºé˜ˆå€¼ï¼Œæ ¹æ®typeæ¥å†³å®šï¼‰ï¼Œæ‰€èµ‹äºˆçš„å€¼</span></span><br><span class="line"><span class="comment">#type </span></span><br><span class="line"><span class="comment">#cv2.THRESH_TOZEROï¼›cv2.THRESH_TOZERO_INV</span></span><br><span class="line"><span class="comment">#cv2.THRESH_BINARY è¶…è¿‡é˜ˆå€¼éƒ¨åˆ†å–maxvalï¼ˆæœ€å¤§å€¼ï¼‰ï¼Œå¦åˆ™å–0</span></span><br><span class="line"><span class="comment">#cv2.THRESH_BINARY_INV THRESH_BINARYçš„åè½¬</span></span><br><span class="line"><span class="comment">#cv2.THRESH_TRUNC å¤§äºé˜ˆå€¼éƒ¨åˆ†è®¾ä¸ºé˜ˆå€¼ï¼Œå¦åˆ™ä¸å˜</span></span><br><span class="line"><span class="comment">#cv2.THRESH_TOZERO å¤§äºé˜ˆå€¼éƒ¨åˆ†ä¸æ”¹å˜ï¼Œå¦åˆ™è®¾ä¸º0</span></span><br><span class="line"><span class="comment">#cv2.THRESH_TOZERO_INV THRESH_TOZEROçš„åè½¬</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt <span class="comment"># python ç»˜å›¾å·¥å…·</span></span><br><span class="line"></span><br><span class="line">img = cv2.imread(<span class="string">&#x27;shot1.png&#x27;</span>, flags=<span class="number">1</span>) <span class="comment"># type: ndarray</span></span><br><span class="line"></span><br><span class="line">img_gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY) <span class="comment">#ç°åº¦å›¾</span></span><br><span class="line">ret, thresh1 = cv2.threshold(img_gray, <span class="number">127</span>, <span class="number">255</span>, cv2.THRESH_BINARY)</span><br><span class="line">ret, thresh2 = cv2.threshold(img_gray, <span class="number">127</span>, <span class="number">255</span>, cv2.THRESH_BINARY_INV)</span><br><span class="line">ret, thresh3 = cv2.threshold(img_gray, <span class="number">127</span>, <span class="number">255</span>, cv2.THRESH_TRUNC)</span><br><span class="line">ret, thresh4 = cv2.threshold(img_gray, <span class="number">127</span>, <span class="number">255</span>, cv2.THRESH_TOZERO)</span><br><span class="line">ret, thresh5 = cv2.threshold(img_gray, <span class="number">127</span>, <span class="number">255</span>, cv2.THRESH_TOZERO_INV)</span><br><span class="line"></span><br><span class="line">titles = [<span class="string">&#x27;Original Image&#x27;</span>, <span class="string">&#x27;BINARY&#x27;</span>, <span class="string">&#x27;BINARY_INV&#x27;</span>, <span class="string">&#x27;TRUNC&#x27;</span>, <span class="string">&#x27;TOZERO&#x27;</span>, <span class="string">&#x27;TOZERO_INV&#x27;</span>]</span><br><span class="line">images = [img, thresh1, thresh2, thresh3, thresh4, thresh5]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    plt.subplot(<span class="number">2</span>, <span class="number">3</span>, i + <span class="number">1</span>), plt.imshow(images[i], <span class="string">&#x27;gray&#x27;</span>)</span><br><span class="line">    plt.title(titles[i])</span><br><span class="line">    plt.xticks([]), plt.yticks([])</span><br><span class="line">plt.show()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<img src="opencv/WeChatccfd9ec187d01b4329b4ce667c160300.png" alt="WeChatccfd9ec187d01b4329b4ce667c160300" style="zoom:70%;" />














































      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/14/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-8%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="ç®€å•è®°å½•ä¸‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/14/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-8%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/" class="post-title-link" itemprop="url">Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-8éªŒè¯ç è¯†åˆ«</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-04-14 16:00:17" itemprop="dateCreated datePublished" datetime="2022-04-14T16:00:17+08:00">2022-04-14</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-10-09 08:57:19" itemprop="dateModified" datetime="2022-10-09T08:57:19+08:00">2022-10-09</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="8-éªŒè¯ç è¯†åˆ«"><a href="#8-éªŒè¯ç è¯†åˆ«" class="headerlink" title="8. éªŒè¯ç è¯†åˆ«"></a>8. éªŒè¯ç è¯†åˆ«</h4><p>è¯†åˆ«éªŒè¯ç éœ€è¦ tesserocr åº“</p>
<p>è¿˜éœ€è¦å®‰è£… Seleniumã€Pillowã€NumPyã€retrying åº“ï¼Œç”¨æ¥æ¨¡æ‹Ÿç™»å½•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install selenium pillow numpy retrying</span><br></pre></td></tr></table></figure>





<h5 id="8-1-å›¾å½¢éªŒè¯ç è¯†åˆ«"><a href="#8-1-å›¾å½¢éªŒè¯ç è¯†åˆ«" class="headerlink" title="8.1 å›¾å½¢éªŒè¯ç è¯†åˆ«"></a>8.1 å›¾å½¢éªŒè¯ç è¯†åˆ«</h5><p>ä¸­å›½çŸ¥ç½‘çš„æ³¨å†Œé¡µé¢æœ‰å›¾å½¢éªŒè¯ç  <a target="_blank" rel="noopener" href="http://my.cnki.net/elibregister/commonRegister.aspx">http://my.cnki.net/elibregister/commonRegister.aspx</a></p>
<p>æ–°æ ‡ç­¾æ‰“å¼€å›¾å½¢éªŒè¯ç  <a target="_blank" rel="noopener" href="http://my.cnki.net/elibregister/CheckCode.aspx">http://my.cnki.net/elibregister/CheckCode.aspx</a> ä¿å­˜åˆ°æœ¬åœ°å‘½åä¸º code.jpg</p>
<p>æ¡ˆä¾‹ç½‘ç«™ <a target="_blank" rel="noopener" href="https://captcha7.scrape.center/">https://captcha7.scrape.center/</a> </p>
<h6 id="è¯†åˆ«æµ‹è¯•"><a href="#è¯†åˆ«æµ‹è¯•" class="headerlink" title="è¯†åˆ«æµ‹è¯•"></a>è¯†åˆ«æµ‹è¯•</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tesserocr</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  image = Image.<span class="built_in">open</span>(<span class="string">&#x27;code.jpg&#x27;</span>)</span><br><span class="line">  result = tesserocr.image_to_text(image)</span><br><span class="line">  print(result)</span><br></pre></td></tr></table></figure>

<p>æ–°å»º Image å¯¹è±¡ï¼Œè°ƒç”¨ tesserocr çš„ image_to_text æ–¹æ³•ï¼Œä¼ å…¥ Image å¯¹è±¡å³å¯å®Œæˆè¯†åˆ«ï¼Œè½¬æ¢æˆæ–‡æœ¬</p>
<p>è¿˜æœ‰ä¸ªç®€å•çš„æ–¹æ³•ï¼Œç›´æ¥å°†å›¾ç‰‡æ–‡ä»¶è½¬ä¸ºå­—ç¬¦ä¸²</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(tesserocr.file_to_text(<span class="string">&#x27;code.jpg&#x27;</span>))</span><br></pre></td></tr></table></figure>

<img src="Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-8éªŒè¯ç è¯†åˆ«/WeChat05c8c73a3a3040aeed742174d56d4712.png" alt="WeChat05c8c73a3a3040aeed742174d56d4712" style="zoom:60%;" />

<h6 id="éªŒè¯ç å¤„ç†"><a href="#éªŒè¯ç å¤„ç†" class="headerlink" title="éªŒè¯ç å¤„ç†"></a>éªŒè¯ç å¤„ç†</h6><p>æœ‰äº›éªŒè¯ç ä¸Šæœ‰å¤šä½™çº¿æ¡å¹²æ‰°å›¾ç‰‡çš„è¯†åˆ«ï¼Œè¿™ç§æƒ…å†µéœ€è¦åšä¸€äº›é¢å¤–çš„å¤„ç†ï¼Œå¦‚è½¬ç°åº¦ã€äºŒå€¼åŒ–ç­‰æ“ä½œ</p>
<p>å›¾ç‰‡é‡Œé‚£äº›é€ æˆå¹²æ‰°çš„ç‚¹ï¼Œé¢œè‰²å¤§å¤šæ¯”æ–‡æœ¬çš„é¢œè‰²æ›´æµ…ï¼Œå› æ­¤å¯ä»¥é€šè¿‡é¢œè‰²å°†é€ æˆå¹²æ‰°çš„ç‚¹æ’é™¤æ‰</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">image = Image.<span class="built_in">open</span>(<span class="string">&#x27;code.png&#x27;</span>)</span><br><span class="line">print(np.array(image).shape)</span><br><span class="line">print(image.mode)</span><br><span class="line"><span class="comment">#ç»“æœ</span></span><br><span class="line">(<span class="number">38</span>, <span class="number">112</span>, <span class="number">4</span>)</span><br><span class="line">RGBA <span class="comment">#æœ‰é€æ˜é€šé“çš„çœŸå½©è‰²</span></span><br></pre></td></tr></table></figure>

<p>ä»ç»“æœå¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªå›¾ç‰‡å…¶å®æ˜¯ä¸€ä¸ªä¸‰ç»´æ•°ç»„</p>
<p>38 å’Œ 112 ä»£è¡¨å›¾ç‰‡çš„é«˜å’Œå®½ï¼Œ4 æ˜¯æ¯ä¸ªåƒç´ ç‚¹çš„è¡¨ç¤ºå‘é‡</p>
<p>4 è¡¨ç¤ºæœ€åä¸€ç»´æ˜¯ä¸€ä¸ªé•¿åº¦ä¸º4çš„æ•°ç»„ï¼Œåˆ†åˆ«ä»£è¡¨ Rã€Gã€Bã€Aï¼Œå³ä¸€ä¸ªåƒç´ ç‚¹ç”± 4 ä¸ªæ•°å­—è¡¨ç¤ºã€‚å¦‚æœ image.mode æ˜¯ RGBï¼Œè¿™ä¸ªå€¼å°±æ˜¯ 3</p>
<ul>
<li>modeï¼š</li>
</ul>
<p>å®šä¹‰äº†å›¾ç‰‡ç±»å‹å’Œåƒç´ çš„ä½å®½ï¼Œä¸€å…±æœ‰ 9 ç§ç±»å‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1ï¼šåƒç´ ç”¨ 1 ä½è¡¨ç¤ºï¼ŒPython ä¸­è¡¨ç¤ºä¸º True æˆ– Falseï¼Œå³äºŒå€¼åŒ–</span><br><span class="line">Lï¼šåƒç´ ç”¨ 8 ä½è¡¨ç¤ºï¼Œå–å€¼ 0~255ï¼Œè¡¨ç¤ºç°åº¦å›¾åƒï¼Œæ•°å€¼è¶Šå°ï¼Œé¢œè‰²è¶Šé»‘</span><br><span class="line">Pï¼šåƒç´ ç”¨ 8 ä½è¡¨ç¤ºï¼Œå³è°ƒè‰²æ¿æ•°æ®</span><br><span class="line">RBGï¼šåƒç´ ç”¨ 3x8 ä½è¡¨ç¤ºï¼Œå³çœŸå½©è‰²ï¼›</span><br><span class="line">RGBAï¼šåƒç´ ç”¨ 4x8 ä½è¡¨ç¤ºï¼Œå³æœ‰é€æ˜é€šé“çš„çœŸå½©è‰²</span><br><span class="line">CMYK: åƒç´ ç”¨ 4x8 ä½è¡¨ç¤ºï¼Œå³å°åˆ·å››è‰²æ¨¡å¼</span><br><span class="line">YCbCrï¼šåƒç´ ç”¨ 3x8 ä½è¡¨ç¤ºï¼Œå³å½©è‰²è§†é¢‘æ ¼å¼</span><br><span class="line">Iï¼šåƒç´ ç”¨ 32 ä½æ•´å‹è¡¨ç¤º</span><br><span class="line">Fï¼šåƒç´ ç”¨ 32 ä½æµ®ç‚¹å‹è¡¨ç¤º</span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†æ–¹ä¾¿å¤„ç†ï¼Œå¯ä»¥æŠŠ RGBA è½¬ä¸ºæ›´ç®€å•çš„ Lï¼Œå³æŠŠå›¾ç‰‡è½¬åŒ–ä¸ºç°åº¦å›¾åƒï¼Œå›¾ç‰‡å¯¹è±¡çš„ convert æ–¹æ³•ä¸­ä¼ å…¥ L å³å¯</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">image = image.convert(<span class="string">&#x27;L&#x27;</span>) <span class="comment">#å°†å›¾åƒè½¬åŒ–ä¸ºç°åº¦å›¾åƒ</span></span><br><span class="line">image = image.convert(<span class="string">&#x27;1&#x27;</span>) <span class="comment">#å°†å›¾åƒäºŒå€¼åŒ–å¤„ç†</span></span><br><span class="line">image.show()</span><br></pre></td></tr></table></figure>

<ul>
<li>å°†å›¾ç‰‡è½¬åŒ–ä¸ºç°åº¦å›¾åƒï¼Œå†æ ¹æ®é˜ˆå€¼åˆ é™¤å›¾ç‰‡ä¸­çš„å¹²æ‰°ç‚¹</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">image = Image.<span class="built_in">open</span>(<span class="string">&#x27;code.png&#x27;</span>)</span><br><span class="line">image = image.convert(<span class="string">&#x27;L&#x27;</span>) <span class="comment">#è½¬åŒ–ä¸ºç°åº¦å›¾åƒ</span></span><br><span class="line">threshold = <span class="number">50</span> <span class="comment">#ç°åº¦çš„é˜ˆå€¼</span></span><br><span class="line">array = np.array(image) <span class="comment">#å°†å›¾ç‰‡è½¬åŒ–ä¸º NumPy æ•°ç»„</span></span><br><span class="line">array = np.where(array &gt; threshold, <span class="number">255</span>, <span class="number">0</span>) <span class="comment">#å¤§äºé˜ˆå€¼çš„å›¾ç‰‡åƒç´ è®¾ä¸º255ç™½è‰²ï¼Œå¦åˆ™å°äºè®¾é»‘è‰²</span></span><br><span class="line">image = Image.fromarray(array.astype(<span class="string">&#x27;uint8&#x27;</span>)) <span class="comment">#Numpyæ•°ç»„è½¬Image</span></span><br><span class="line">image.show()</span><br></pre></td></tr></table></figure>

<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-8%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/WeChatb4e68e7e53ab397fa08b0b2a70230d24.png" alt="WeChatb4e68e7e53ab397fa08b0b2a70230d24"></p>
<p>å°†å˜é‡ threshold è®¾ç½®ä¸º 50ï¼Œä»£è¡¨ç°åº¦çš„é˜ˆå€¼ï¼Œæ¥ç€å°†å›¾ç‰‡è½¬åŒ–ä¸º NumPy æ•°ç»„ï¼Œåˆ©ç”¨ NumPy çš„ where æ–¹æ³•å¯¹æ•°ç»„è¿›è¡Œç­›é€‰å’Œå¤„ç†ï¼ŒæŒ‡å®šå¤§äºé˜ˆå€¼çš„å›¾ç‰‡åƒç´ è®¾ç½®ä¸º 255ï¼Œè¡¨ç¤ºç™½è‰²ï¼Œå¦åˆ™è®¾ç½®ä¸º0ï¼Œè¡¨ç¤ºé»‘è‰²</p>
<p>å¤„ç†è¿‡åå¹²æ‰°ç‚¹ä¸è§äº†ï¼Œå›¾ç‰‡å˜æˆé»‘ç™½åˆ†æ˜</p>
<p>åˆ©ç”¨ Image å¯¹è±¡çš„ convert() æ–¹æ³•ä¼ å…¥å‚æ•° Lï¼Œå³å¯å°†å›¾ç‰‡è½¬åŒ–ä¸ºç°åº¦å›¾åƒ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">image = Image.<span class="built_in">open</span>(<span class="string">&#x27;code.jpg&#x27;</span>)</span><br><span class="line">image = image.convert(<span class="string">&#x27;L&#x27;</span>)</span><br><span class="line">image.show()</span><br></pre></td></tr></table></figure>

<img src="Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-8éªŒè¯ç è¯†åˆ«/WeChat502e6f6ba61943c5b6c39e8bc4d5c4f6.png" alt="WeChat502e6f6ba61943c5b6c39e8bc4d5c4f6" style="zoom:50%;" />

<p>ä¼ å…¥ 1 å³å¯å°†å›¾ç‰‡è¿›è¡ŒäºŒå€¼åŒ–å¤„ç†</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">image = image.convert(<span class="string">&#x27;1&#x27;</span>)</span><br></pre></td></tr></table></figure>

<img src="Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-8éªŒè¯ç è¯†åˆ«/WeChata596e46fadb12785691911910ffddb8e.png" alt="WeChata596e46fadb12785691911910ffddb8e" style="zoom:50%;" />

<p>è¿˜å¯ä»¥æŒ‡å®šäºŒå€¼åŒ–çš„é˜ˆå€¼ï¼Œé»˜è®¤é˜ˆå€¼127</p>
<p>ä¸èƒ½ç›´æ¥è½¬åŒ–åŸå›¾ï¼Œè¦å°†åŸå›¾å…ˆè½¬åŒ–ä¸ºç°åº¦å›¾åƒï¼Œç„¶åå†æŒ‡å®šäºŒå€¼åŒ–é˜ˆå€¼ï¼Œä¸‹é¢æŒ‡å®š100ï¼ŒèƒŒæ™¯è¢«å»æ‰äº†éƒ¨åˆ†ä¼šå˜å¾—é»‘ç™½åˆ†æ˜</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">image = Image.<span class="built_in">open</span>(<span class="string">&#x27;code.jpg&#x27;</span>)</span><br><span class="line">image = image.convert(<span class="string">&#x27;L&#x27;</span>)</span><br><span class="line">table = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">    <span class="keyword">if</span> i &lt; <span class="number">100</span>:</span><br><span class="line">        table.append(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        table.append(<span class="number">1</span>)</span><br><span class="line">image = image.point(table, <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">image.show()</span><br></pre></td></tr></table></figure>

<img src="Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-8éªŒè¯ç è¯†åˆ«/WeChat506046716da1f482080b704db38e3f6f.png" alt="WeChat506046716da1f482080b704db38e3f6f" style="zoom:60%;" />

<p>é’ˆå¯¹ä¸€äº›æœ‰å¹²æ‰°çš„å›¾ç‰‡ï¼Œå¯ä»¥åšä¸€äº›ç°åº¦å’ŒäºŒå€¼åŒ–å¤„ç†ï¼Œå¯ä»¥æé«˜å›¾ç‰‡è¯†åˆ«çš„æ­£ç¡®ç‡</p>
<h5 id="8-2è¯†åˆ«å®æˆ˜"><a href="#8-2è¯†åˆ«å®æˆ˜" class="headerlink" title="8.2è¯†åˆ«å®æˆ˜"></a>8.2è¯†åˆ«å®æˆ˜</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> tesserocr</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> retrying <span class="keyword">import</span> retry</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.wait <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> selenium.common.exceptions <span class="keyword">import</span> TimeoutException</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¯¹éªŒè¯ç å›¾ç‰‡åšå»å™ªå¤„ç†</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">preprocess</span>(<span class="params">image</span>):</span></span><br><span class="line">    image = image.convert(<span class="string">&#x27;L&#x27;</span>)</span><br><span class="line">    array = np.array(image)</span><br><span class="line">    array = np.where(array &gt; <span class="number">50</span>, <span class="number">255</span>, <span class="number">0</span>)</span><br><span class="line">    image = Image.fromarray(array.astype(<span class="string">&#x27;uint8&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> image</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#1æ‰“å¼€æ¡ˆä¾‹ç½‘ç«™</span></span><br><span class="line"><span class="comment">#2æ‰¾åˆ°ç”¨æˆ·åã€å¯†ç è¾“å…¥æ¡†ï¼Œè¾“å…¥</span></span><br><span class="line"><span class="comment">#3æ‰¾åˆ°å¹¶æˆªå–éªŒè¯ç å›¾ç‰‡ï¼Œè½¬åŒ–ä¸ºå›¾ç‰‡å¯¹è±¡</span></span><br><span class="line"><span class="comment">#4é¢„å¤„ç†éªŒè¯ç ï¼Œå»é™¤å™ªå£°</span></span><br><span class="line"><span class="comment">#5è¯†åˆ«éªŒè¯ç ï¼Œå¾—åˆ°è¯†åˆ«ç»“æœ</span></span><br><span class="line"><span class="comment">#6å»é™¤è¯†åˆ«ç»“æœä¸­ä¸€äº›éå­—æ¯ç¬¦å’Œæ•°å­—ç¬¦</span></span><br><span class="line"><span class="comment">#7æ‰¾åˆ°éªŒè¯ç è¾“å…¥æ¡†ï¼Œè¾“å…¥éªŒè¯ç </span></span><br><span class="line"><span class="comment">#8ç‚¹å‡»ç™»å½•æŒ‰é’®</span></span><br><span class="line"><span class="comment">#9ç­‰å¾…ç™»å½•æˆåŠŸå­—æ ·å‡ºç°ï¼Œå¦‚æœå‡ºç°è¯æ˜éªŒè¯ç è¯†åˆ«æ­£ç¡®ï¼Œå¦åˆ™é‡å¤ä»¥ä¸Šæ­¥éª¤é‡è¯•</span></span><br><span class="line">  </span><br><span class="line"><span class="meta">@retry(stop_max_attempt_number=10, retry_on_result=lambda x: x is False)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>():</span></span><br><span class="line">    browser.get(<span class="string">&#x27;https://captcha7.scrape.center/&#x27;</span>)</span><br><span class="line">    browser.find_element_by_css_selector(<span class="string">&#x27;.username input[type=&quot;text&quot;]&#x27;</span>).send_keys(<span class="string">&#x27;admin&#x27;</span>)</span><br><span class="line">    browser.find_element_by_css_selector(<span class="string">&#x27;.password input[type=&quot;password&quot;]&#x27;</span>).send_keys(<span class="string">&#x27;admin&#x27;</span>)</span><br><span class="line">    captcha = browser.find_element_by_css_selector(<span class="string">&#x27;#captcha&#x27;</span>)</span><br><span class="line">    image = Image.<span class="built_in">open</span>(BytesIO(captcha.screenshot_as_png))</span><br><span class="line">    image = preprocess(image)</span><br><span class="line">    captcha = tesserocr.image_to_text(image)</span><br><span class="line">    captcha = re.sub(<span class="string">&#x27;[^A-Za-z0-9]&#x27;</span>, <span class="string">&#x27;&#x27;</span>, captcha)</span><br><span class="line">    browser.find_element_by_css_selector(<span class="string">&#x27;.captcha input[type=&quot;text&quot;]&#x27;</span>).send_keys(captcha)</span><br><span class="line">    browser.find_element_by_css_selector(<span class="string">&#x27;.login&#x27;</span>).click()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        WebDriverWait(browser, <span class="number">10</span>).until(EC.presence_of_element_located((By.XPATH, <span class="string">&#x27;//h2[contains(., &quot;ç™»å½•æˆåŠŸ&quot;)]&#x27;</span>)))</span><br><span class="line">        time.sleep(<span class="number">10</span>)</span><br><span class="line">        browser.close()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> TimeoutException:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    browser = webdriver.Chrome()</span><br><span class="line">    login()</span><br></pre></td></tr></table></figure>

<p>ç”¨åˆ°äº† retrying æ¥æŒ‡å®šé‡è¯•æ¡ä»¶å’Œé‡è¯•æ¬¡æ•°ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">lambda</span> x: x <span class="keyword">is</span> <span class="literal">False</span></span><br><span class="line"><span class="comment">#ç›¸å½“äº</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span>(<span class="params">x</span>):</span></span><br><span class="line">  <span class="keyword">return</span> x <span class="keyword">is</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>





<h5 id="8-3-æ»‘åŠ¨éªŒè¯ç è¯†åˆ«"><a href="#8-3-æ»‘åŠ¨éªŒè¯ç è¯†åˆ«" class="headerlink" title="8.3 æ»‘åŠ¨éªŒè¯ç è¯†åˆ«"></a>8.3 æ»‘åŠ¨éªŒè¯ç è¯†åˆ«</h5><p>æ‹–åŠ¨æ‹¼åˆæ»‘å—çš„éªŒè¯ç </p>
<p>å¯ä»¥å’ŒåŸå›¾å¯¹æ¯”æ£€æµ‹çš„æ–¹å¼æ¥è¯†åˆ«ç¼ºå£ä½ç½®</p>
<p>åŒæ—¶è·å–ä¸¤å¼ å›¾ç‰‡ï¼Œè®¾å®šä¸€ä¸ªå¯¹æ¯”é˜ˆå€¼ï¼Œç„¶åéå†ä¸¤å¼ å›¾ç‰‡ï¼Œæ‰¾å‡ºç›¸åŒä½ç½®åƒç´  RGB å·®è·è¶…è¿‡æ­¤é˜ˆå€¼çš„åƒç´ ç‚¹ï¼Œæ­¤åƒç´ ç‚¹çš„ä½ç½®å°±æ˜¯ç¼ºå£çš„ä½ç½®</p>
<h6 id="æ¨¡æ‹Ÿç‚¹å‡»"><a href="#æ¨¡æ‹Ÿç‚¹å‡»" class="headerlink" title="æ¨¡æ‹Ÿç‚¹å‡»"></a>æ¨¡æ‹Ÿç‚¹å‡»</h6><p>å¤´æ¡ç™»å½•é¡µé¢æµ‹è¯•</p>
<p>å®‰å±…å®¢ç™»å½•é¡µé¢æµ‹è¯• <a target="_blank" rel="noopener" href="https://m.anjuke.com/member/login/?from=m_yhzx_dltx">https://m.anjuke.com/member/login/?from=m_yhzx_dltx</a></p>
<p>å¤´æ¡çš„æ»‘åŠ¨ç¼ºå£æ˜¯å•ç‹¬ä¸€å¼ å›¾ç‰‡ï¼Œå¤§å°ä¸ºç¼ºå£å¤§å°</p>
<p>å®‰å±…å®¢æ»‘åŠ¨ç¼ºå£å¸¦èƒŒæ™¯</p>
<p>æ¨¡æ‹Ÿè¾“å…¥æ‰‹æœºå·ç‚¹å‡»éªŒè¯ç </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.remote.webelement <span class="keyword">import</span> WebElement</span><br><span class="line"></span><br><span class="line">browser = webdriver.Chrome()</span><br><span class="line">wait = WebDriverWait(browser, <span class="number">20</span>)</span><br><span class="line">mobile = <span class="string">&#x27;xxxxxxxx&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_phone_input</span>():</span></span><br><span class="line">  phone_input = wait.until(EC.presence_of_element_located((By.ID, <span class="string">&#x27;dynamicPhone&#x27;</span>))) <span class="comment"># type: WebElement</span></span><br><span class="line">  phone_input.send_keys(mobile)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_code_button</span>():</span></span><br><span class="line">  button = wait.until(EC.element_to_be_clickable((By.ID, <span class="string">&#x27;dynamicVerifiCodeText&#x27;</span>))) <span class="comment"># type: WebElement</span></span><br><span class="line">  button.click()</span><br></pre></td></tr></table></figure>

<h6 id="è¯†åˆ«ç¼ºå£"><a href="#è¯†åˆ«ç¼ºå£" class="headerlink" title="è¯†åˆ«ç¼ºå£"></a>è¯†åˆ«ç¼ºå£</h6><h6 id="å›¾ç‰‡æˆªå–"><a href="#å›¾ç‰‡æˆªå–" class="headerlink" title="å›¾ç‰‡æˆªå–"></a>å›¾ç‰‡æˆªå–</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">img = wait.until(EC.presence_of_element_located((By.CLASS_NAME, <span class="string">&#x27;dvc-captcha__puzzleImg&#x27;</span>))) <span class="comment">#type: WebElement</span></span><br><span class="line">img.screenshot(<span class="string">&#x27;img1.png&#x27;</span>)</span><br><span class="line">shot2 = img.screenshot_as_png</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;img2.png&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(shot2)</span><br></pre></td></tr></table></figure>

<h5 id="8-4-ä½¿ç”¨OpenCVè¯†åˆ«æ»‘åŠ¨éªŒè¯ç ç¼ºå£"><a href="#8-4-ä½¿ç”¨OpenCVè¯†åˆ«æ»‘åŠ¨éªŒè¯ç ç¼ºå£" class="headerlink" title="8.4 ä½¿ç”¨OpenCVè¯†åˆ«æ»‘åŠ¨éªŒè¯ç ç¼ºå£"></a>8.4 ä½¿ç”¨OpenCVè¯†åˆ«æ»‘åŠ¨éªŒè¯ç ç¼ºå£</h5><p>æµ‹è¯•åœ°å€ <a target="_blank" rel="noopener" href="https://captcha1.scrape.center/">https://captcha1.scrape.center</a></p>
<p>å®‰è£…åº“</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install python-opencv</span><br></pre></td></tr></table></figure>

<p>æ­¥éª¤</p>
<ol>
<li><p>å¯¹éªŒè¯ç å›¾ç‰‡è¿›è¡Œé«˜æ–¯æ¨¡ç³Šæ»¤æ³¢å¤„ç†ï¼Œæ¶ˆé™¤éƒ¨åˆ†å™ªå£°å¹²æ‰°</p>
</li>
<li><p>åˆ©ç”¨è¾¹ç¼˜æ£€æµ‹ç®—æ³•ï¼Œé€šè¿‡è°ƒæ•´ç›¸åº”é˜ˆå€¼è¯†åˆ«å‡ºéªŒè¯ç å›¾ç‰‡ä¸­æ»‘å—çš„è¾¹ç¼˜</p>
</li>
<li><p>åŸºäºä¸Šä¸€æ­¥å¾—åˆ°çš„è¾¹ç¼˜è½®å»“ä¿¡æ¯ï¼Œå¯¹æ¯”é¢ç§¯ã€ä½ç½®ã€å‘¨é•¿ç­‰ç‰¹å¾ç­›é€‰å‡ºæœ€å¯èƒ½çš„è½®å»“</p>
</li>
</ol>
<h6 id="é«˜æ–¯æ»¤æ³¢"><a href="#é«˜æ–¯æ»¤æ³¢" class="headerlink" title="é«˜æ–¯æ»¤æ³¢"></a>é«˜æ–¯æ»¤æ³¢</h6><p>é«˜æ–¯æ»¤æ³¢ç”¨æ¥å»é™¤å›¾ç‰‡ä¸­çš„ä¸€äº›å™ªå£°ï¼Œå‡å°‘å™ªå£°å¹²æ‰°ï¼Œå…¶å®å°±æ˜¯æŠŠå›¾ç‰‡æ¨¡ç³ŠåŒ–ï¼Œä¸ºä¸‹ä¸€æ­¥çš„è¾¹ç¼˜æ£€æµ‹åšå¥½é“ºå«</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#srcï¼šéœ€è¦å¤„ç†çš„å›¾ç‰‡</span></span><br><span class="line"><span class="comment">#ksizeï¼šé«˜æ–¯æ»¤æ³¢å¤„ç†æ‰€ç”¨çš„é«˜æ–¯å†…æ ¸å¤§å°ï¼Œéœ€è¦ä¼ å…¥ä¸€ä¸ªå…ƒç»„ï¼ŒåŒ…å«xå’Œyä¸¤ä¸ªå…ƒç´ </span></span><br><span class="line"><span class="comment">#sigmaYï¼šé«˜æ–¯å†…æ ¸å‡½æ•°åœ¨Xæ–¹å‘ä¸Šçš„æ ‡å‡†åå·®</span></span><br><span class="line"><span class="comment">#sigmaY: é«˜æ–¯å†…æ ¸å‡½æ•°åœ¨yæ–¹å‘ä¸Šçš„æ ‡å‡†åå·®</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GaussianBlur</span>(<span class="params">src, ksize, sigmaX,dst=<span class="literal">None</span>, sigmaY=<span class="literal">None</span>, borderType=<span class="literal">None</span></span>)</span></span><br></pre></td></tr></table></figure>

<p>ksize å’Œ sigmaX æ˜¯å¿…ä¼ å‚æ•°ï¼Œæ¡ˆä¾‹ ksize å¯ä»¥å–ä½œ (5,5)ï¼ŒsigmaX å–ä½œ 0</p>
<p>ç»è¿‡é«˜æ–¯æ»¤æ³¢åï¼Œå›¾ç‰‡ä¼šå˜æ¨¡ç³Š</p>
<h6 id="è¾¹ç¼˜æ£€æµ‹"><a href="#è¾¹ç¼˜æ£€æµ‹" class="headerlink" title="è¾¹ç¼˜æ£€æµ‹"></a>è¾¹ç¼˜æ£€æµ‹</h6><p>ç”±äºéªŒè¯ç å›¾ç‰‡é‡Œçš„ç›®æ ‡ç¼ºå£é€šå¸¸å…·æœ‰æ¯”è¾ƒæ˜æ˜¾çš„è¾¹ç¼˜ï¼Œæ‰€ä»¥å€ŸåŠ©ä¸€äº›è¾¹ç¼˜æ£€æµ‹ç®—æ³•ï¼Œå†åŠ ä¸Šè°ƒæ•´é˜ˆå€¼æ˜¯å¯ä»¥æ‰¾å‡ºç¼ºå£ä½ç½®çš„</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#imageï¼šéœ€è¦å¤„ç†çš„å›¾ç‰‡</span></span><br><span class="line"><span class="comment">#threshold1ï¼šé˜ˆå€¼ï¼Œæœ€å°åˆ¤å®šä¸´ç•Œç‚¹</span></span><br><span class="line"><span class="comment">#threshold2ï¼šé˜ˆå€¼ï¼Œæœ€å¤§åˆ¤å®šä¸´ç•Œç‚¹</span></span><br><span class="line"><span class="comment">#apertureSizeï¼šç”¨äºæŸ¥æ‰¾å›¾ç‰‡æ¸å˜çš„ç´¢è´å°”å†…æ ¸çš„å¤§å°</span></span><br><span class="line"><span class="comment">#L2gradientï¼šç”¨äºæŸ¥æ‰¾æ¢¯åº¦å¹…åº¦çš„ç­‰å¼</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Canny</span>(<span class="params">image, threshold1, threshold2, edges=<span class="literal">None</span>,apertureSize=<span class="literal">None</span>,L2gradient=<span class="literal">None</span></span>)</span></span><br></pre></td></tr></table></figure>

<p>é€šå¸¸åªéœ€è®¾ç½® threshold1, threshold2 çš„å€¼ï¼Œæ•°å€¼å¤§å°è§†å…·ä½“å›¾ç‰‡è€Œå®šï¼Œè¿™é‡Œå¯ä»¥å–200å’Œ450ï¼Œè¾¹ç¼˜æ£€æµ‹ç®—æ³•å¤„ç†åï¼Œä¼šä¿ç•™ä¸€äº›æ¯”è¾ƒæ˜æ˜¾çš„è¾¹ç¼˜ä¿¡æ¯</p>
<h6 id="è½®å»“æå–"><a href="#è½®å»“æå–" class="headerlink" title="è½®å»“æå–"></a>è½®å»“æå–</h6><p>è¿›è¡Œè¾¹ç¼˜æ£€æµ‹åå¤„ç†åï¼Œå¯ä»¥çœ‹åˆ°å›¾ç‰‡ä¸­ä¼šä¿ç•™æ¯”è¾ƒæ˜æ˜¾çš„è¾¹ç¼˜ä¿¡æ¯ï¼Œä¸‹ä¸€æ­¥å¯ä»¥åˆ©ç”¨ OpenCV æŠ€æœ¯æå–è¾¹ç¼˜è½®å»“</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#imageï¼šéœ€è¦å¤„ç†çš„å›¾ç‰‡</span></span><br><span class="line"><span class="comment">#modeï¼šç”¨äºå®šä¹‰è½®å»“çš„æ£€ç´¢æ¨¡å¼</span></span><br><span class="line"><span class="comment">#methodï¼šç”¨äºå®šä¹‰è½®å»“çš„è¿‘ä¼¼æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">findContours</span>(<span class="params">image,mode,method,contours=<span class="literal">None</span>,hierarch=<span class="literal">None</span>,offset=<span class="literal">None</span></span>)</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå°† mode è®¾ç½®ä¸º RETR_CCOMPï¼Œå°† method è®¾ç½®ä¸º CHAIN_APPROX_SIMPLE</p>
<h6 id="å¤–æ¥çŸ©å½¢"><a href="#å¤–æ¥çŸ©å½¢" class="headerlink" title="å¤–æ¥çŸ©å½¢"></a>å¤–æ¥çŸ©å½¢</h6><p>æå–åˆ°è¾¹ç¼˜è½®å»“åï¼Œå¯ä»¥è®¡ç®—å‡ºè½®å»“çš„å¤–æ¥çŸ©å½¢ï¼Œä»¥ä¾¿æˆ‘ä»¬æ ¹æ®é¢ç§¯å’Œå‘¨é•¿ç­‰å‚æ•°åˆ¤æ–­æå–åˆ°çš„è½®å»“æ˜¯ä¸æ˜¯ç›®æ ‡ç¼ºå£çš„è½®å»“</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#arrayï¼šå¯ä»¥æ˜¯ä¸€ä¸ªç°åº¦å›¾æˆ–è€…2Dç‚¹é›†</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">boundingRect</span>(<span class="params">array</span>)</span></span><br></pre></td></tr></table></figure>

<h6 id="è½®å»“é¢ç§¯"><a href="#è½®å»“é¢ç§¯" class="headerlink" title="è½®å»“é¢ç§¯"></a>è½®å»“é¢ç§¯</h6><p>è·å–åˆ°å„ä¸ªè½®å»“çš„å¤–æ¥çŸ©å½¢åï¼Œå¯ä»¥æ ¹æ®é¢ç§¯å’Œå‘¨é•¿ç­›é€‰ç¼ºå£æ‰€åœ¨ä½ç½®</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#contourï¼šè½®å»“ä¿¡æ¯</span></span><br><span class="line"><span class="comment">#orientedï¼šæ–¹å‘æ ‡è¯†ç¬¦ï¼Œé»˜è®¤å€¼Falseï¼Œé¢ç§¯ä»¥ç»å¯¹å€¼å½¢å¼è¿”å›ï¼›è‹¥å–Trueï¼Œæ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªå¸¦ç¬¦å·çš„é¢ç§¯å€¼ï¼Œæ­£è´Ÿå–å†³äºè½®å»“æ–¹å‘ï¼ˆé¡ºæ—¶é’ˆæˆ–é€†æ—¶é’ˆï¼‰</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">contourArea</span>(<span class="params">contour, oriented=<span class="literal">None</span></span>)</span></span><br></pre></td></tr></table></figure>

<h6 id="è½®å»“å‘¨é•¿"><a href="#è½®å»“å‘¨é•¿" class="headerlink" title="è½®å»“å‘¨é•¿"></a>è½®å»“å‘¨é•¿</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#curveï¼šè½®å»“ä¿¡æ¯</span></span><br><span class="line"><span class="comment">#closedï¼šè½®å»“æ˜¯å¦å°é—­</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">arcLength</span>(<span class="params">curve, closed</span>)</span></span><br></pre></td></tr></table></figure>

<h6 id="ç¼ºå£è¯†åˆ«"><a href="#ç¼ºå£è¯†åˆ«" class="headerlink" title="ç¼ºå£è¯†åˆ«"></a>ç¼ºå£è¯†åˆ«</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"></span><br><span class="line">GAUSSIAN_BLUR_KERNEL_SIZE = (<span class="number">5</span>, <span class="number">5</span>)</span><br><span class="line">GAUSSIAN_BLUR_SIGMA_X = <span class="number">0</span></span><br><span class="line">CANNY_THRESHOLD1 = <span class="number">200</span></span><br><span class="line">CANNY_THRESHOLD2 = <span class="number">450</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#é«˜æ–¯æ»¤æ³¢å¤„ç†</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_gaussian_blur_image</span>(<span class="params">image</span>):</span></span><br><span class="line">    <span class="keyword">return</span> cv2.GaussianBlur(image, GAUSSIAN_BLUR_KERNEL_SIZE, GAUSSIAN_BLUR_SIGMA_X)</span><br><span class="line"></span><br><span class="line"><span class="comment">#è¾¹ç¼˜æ£€æµ‹å¤„ç†</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_canny_image</span>(<span class="params">image</span>):</span></span><br><span class="line">    <span class="keyword">return</span> cv2.Canny(image, CANNY_THRESHOLD1, CANNY_THRESHOLD2)</span><br><span class="line"></span><br><span class="line"><span class="comment">#æå–è½®å»“ä¿¡æ¯</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_contours</span>(<span class="params">image</span>):</span></span><br><span class="line">    contours, _ = cv2.findContours(image, cv2.RETR_CCOMP, cv2.CHAIN_APPROX_SIMPLE)</span><br><span class="line">    <span class="keyword">return</span> contours</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_contour_area_threshold</span>(<span class="params">image_width, image_height</span>):</span></span><br><span class="line">    contour_area_min = (image_width * <span class="number">0.15</span>) * (image_height * <span class="number">0.25</span>) * <span class="number">0.8</span></span><br><span class="line">    contour_area_max = (image_width * <span class="number">0.15</span>) * (image_height * <span class="number">0.25</span>) * <span class="number">1.2</span></span><br><span class="line">    <span class="keyword">return</span> contour_area_min, contour_area_max</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_arc_length_threshold</span>(<span class="params">image_width, image_height</span>):</span></span><br><span class="line">    arc_length_min = ((image_width * <span class="number">0.15</span>) + (image_height * <span class="number">0.25</span>)) * <span class="number">2</span> * <span class="number">0.8</span></span><br><span class="line">    arc_length_max = ((image_width * <span class="number">0.15</span>) + (image_height * <span class="number">0.25</span>)) * <span class="number">2</span> * <span class="number">1.2</span></span><br><span class="line">    <span class="keyword">return</span> arc_length_min, arc_length_max</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_offset_threshold</span>(<span class="params">image_width</span>):</span></span><br><span class="line">    offset_min = <span class="number">0.2</span> * image_width</span><br><span class="line">    offset_max = <span class="number">0.85</span> * image_width</span><br><span class="line">    <span class="keyword">return</span> offset_min, offset_max</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    image_raw = cv2.imread(<span class="string">&#x27;captcha.png&#x27;</span>) <span class="comment">#è¯»å–åŸå§‹å›¾ç‰‡</span></span><br><span class="line">    image_height, image_width, _ = image_raw.shape <span class="comment">#è·å–å®½é«˜</span></span><br><span class="line">    image_gaussian_blur = get_gaussian_blur_image(image_raw)<span class="comment">#é«˜æ–¯æ»¤æ³¢å¤„ç†</span></span><br><span class="line">    image_canny = get_canny_image(image_gaussian_blur) <span class="comment">#è¾¹ç¼˜æ£€æµ‹å¤„ç†</span></span><br><span class="line">    contours = get_contours(image_canny) <span class="comment">#æå–è½®å»“ä¿¡æ¯</span></span><br><span class="line">    cv2.imwrite(<span class="string">&#x27;image_canny.png&#x27;</span>, image_canny)</span><br><span class="line">    cv2.imwrite(<span class="string">&#x27;image_gaussian_blur.png&#x27;</span>, image_gaussian_blur)</span><br><span class="line">    contour_area_min, contour_area_max = get_contour_area_threshold(image_width, image_height)</span><br><span class="line">    arc_length_min, arc_length_max = get_arc_length_threshold(image_width, image_height)</span><br><span class="line">    offset_min, offset_max = get_offset_threshold(image_width)</span><br><span class="line">    offset = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> contour <span class="keyword">in</span> contours:</span><br><span class="line">        x, y, w, h = cv2.boundingRect(contour)</span><br><span class="line">        <span class="keyword">if</span> contour_area_min &lt; cv2.contourArea(contour) &lt; contour_area_max <span class="keyword">and</span> \</span><br><span class="line">                arc_length_min &lt; cv2.arcLength(contour, <span class="literal">True</span>) &lt; arc_length_max <span class="keyword">and</span> \</span><br><span class="line">                offset_min &lt; x &lt; offset_max:</span><br><span class="line">            cv2.rectangle(image_raw, (x, y), (x + w, y + h), (<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), <span class="number">2</span>)</span><br><span class="line">            offset = x</span><br><span class="line">    cv2.imwrite(<span class="string">&#x27;image_label.png&#x27;</span>, image_raw)</span><br><span class="line">    print(<span class="string">&#x27;offset&#x27;</span>, offset)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>



<h5 id="8-5-å¤´æ¡éªŒè¯ç è¯†åˆ«"><a href="#8-5-å¤´æ¡éªŒè¯ç è¯†åˆ«" class="headerlink" title="8.5 å¤´æ¡éªŒè¯ç è¯†åˆ«"></a>8.5 å¤´æ¡éªŒè¯ç è¯†åˆ«</h5><p>æ¨¡æ‹Ÿç‚¹å‡»æ˜¾ç¤ºæ»‘åŠ¨éªŒè¯ç </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> numpy</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> selenium <span class="keyword">import</span> webdriver</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.remote.webelement <span class="keyword">import</span> WebElement</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">from</span> numpy <span class="keyword">import</span> ndarray</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver <span class="keyword">import</span> ActionChains</span><br><span class="line"></span><br><span class="line">browser = webdriver.Chrome()</span><br><span class="line">wait = WebDriverWait(browser, <span class="number">20</span>)</span><br><span class="line">mobile = <span class="string">&#x27;186xxxx&#x27;</span></span><br><span class="line"></span><br><span class="line">browser.get(<span class="string">&#x27;https://www.toutiao.com&#x27;</span>)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">button = wait.until(EC.presence_of_element_located((By.XPATH, <span class="string">&#x27;//*[@id=&quot;root&quot;]/div/div[5]/div[2]/div[1]/div/a&#x27;</span>))) <span class="comment"># type: WebElement</span></span><br><span class="line">button.click()</span><br><span class="line"><span class="built_in">input</span> = wait.until(EC.presence_of_element_located((By.XPATH, <span class="string">&#x27;//*[@id=&quot;login_modal_ele&quot;]/div/article/article/div[1]/div[1]/div[2]/article/div[1]/div/input&#x27;</span>))) <span class="comment"># type: WebElement</span></span><br><span class="line"><span class="built_in">input</span>.send_keys(mobile)</span><br><span class="line">code = browser.find_element_by_xpath(<span class="string">&#x27;//*[@id=&quot;login_modal_ele&quot;]/div/article/article/div[1]/div[1]/div[2]/article/div[2]/div/span&#x27;</span>) <span class="comment"># type: WebElement</span></span><br><span class="line">code.click()</span><br></pre></td></tr></table></figure>

<p>è·å–éªŒè¯ç å›¾ç‰‡ï¼Œä¿å­˜åˆ°æœ¬åœ°</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">onload_save_img</span>(<span class="params">url, name</span>):</span></span><br><span class="line">  <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  ä¸‹è½½é“¾æ¥å›¾ç‰‡</span></span><br><span class="line"><span class="string">  :param url: å›¾ç‰‡é“¾æ¥</span></span><br><span class="line"><span class="string">  :param name: ä¿å­˜å›¾ç‰‡åå­—</span></span><br><span class="line"><span class="string">  :return:</span></span><br><span class="line"><span class="string">  &#x27;&#x27;&#x27;</span></span><br><span class="line">  r = requests.get(url)</span><br><span class="line">  <span class="keyword">with</span> <span class="built_in">open</span>(name, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">      f.write(r.content)</span><br><span class="line"></span><br><span class="line"><span class="comment">#è·å–éªŒè¯ç å›¾ç‰‡</span></span><br><span class="line">slider_elem = wait.until(EC.presence_of_element_located((By.XPATH, <span class="string">&#x27;//*[@id=&quot;captcha_container&quot;]/div/div[2]/img[2]&#x27;</span>))) <span class="comment"># type: WebElement</span></span><br><span class="line">bk_elem = wait.until(EC.presence_of_element_located((By.XPATH, <span class="string">&#x27;//*[@id=&quot;captcha-verify-image&quot;]&#x27;</span>))) <span class="comment"># type: WebElement</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¿å­˜å›¾ç‰‡</span></span><br><span class="line">onload_save_img(slider_elem.get_attribute(<span class="string">&#x27;src&#x27;</span>), <span class="string">&#x27;slider_elem.jpg&#x27;</span>)</span><br><span class="line">onload_save_img(bk_elem.get_attribute(<span class="string">&#x27;src&#x27;</span>), <span class="string">&#x27;bk_elem.jpg&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¯ä»¥è·å–ä¿å­˜å›¾ç‰‡å®½é«˜</span></span><br><span class="line"><span class="comment">#ç¼ºå£å®½é«˜</span></span><br><span class="line"><span class="comment">#width, height = slider_pic.shape[::-1]  # å–å®½åº¦å’Œé«˜åº¦ -1 é€šé“</span></span><br></pre></td></tr></table></figure>

<img src="Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-8éªŒè¯ç è¯†åˆ«/bk_elem.jpg" alt="bk_elem" style="zoom:50%;" />

<img src="Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-8éªŒè¯ç è¯†åˆ«/slider_elem.jpg" alt="slider_elem" style="zoom:67%;" />

<p>è¯»å–ç°åº¦å›¾ç‰‡</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¯»å–ç°åº¦å›¾ç‰‡ 0ç°åº¦å›¾ç‰‡ 1RBGå›¾ç‰‡</span></span><br><span class="line">slider_pic = cv2.imread(<span class="string">&#x27;slider_elem.jpg&#x27;</span>, <span class="number">0</span>)  <span class="comment"># type: ndarray</span></span><br><span class="line">bk_pic = cv2.imread(<span class="string">&#x27;bk_elem.jpg&#x27;</span>, <span class="number">0</span>)  <span class="comment"># type: ndarray</span></span><br></pre></td></tr></table></figure>

<img src="Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-8éªŒè¯ç è¯†åˆ«/bk_resize.jpg" alt="bk_resize" style="zoom:80%;" />

<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-8%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/slider_resize.jpg" alt="slider_resize"></p>
<p>å°†ä¿å­˜å›¾ç‰‡è¿›è¡Œç¼©æ”¾å¤„ç†ï¼Œç¼©æ”¾åˆ°ç½‘é¡µä¸Šç¼ºå£å›¾å’ŒèƒŒæ™¯å›¾å¤§å°</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è·å–ç¼ºå£yå€¼ è®¡ç®—ç¼©æ”¾å®½é«˜</span></span><br><span class="line">slider_resize_y = slider_elem.location.get(<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">slider_resize_w, slider_resize_h = (slider_elem.size.get(<span class="string">&#x27;width&#x27;</span>), slider_elem.size.get(<span class="string">&#x27;height&#x27;</span>))</span><br><span class="line">bk_resize_y = bk_elem.location.get(<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">bk_resize_w, bk_resize_h = (bk_elem.size.get(<span class="string">&#x27;width&#x27;</span>), bk_elem.size.get(<span class="string">&#x27;height&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#å¯¹å›¾ç‰‡ç¼©æ”¾å¤„ç†åé‡æ–°ä¿å­˜</span></span><br><span class="line">slider_resize = cv2.resize(slider_pic, (slider_resize_w, slider_resize_h))</span><br><span class="line">bk_resize = cv2.resize(bk_pic, (bk_resize_w, bk_resize_h))</span><br><span class="line">cv2.imwrite(<span class="string">&#x27;slider_resize.jpg&#x27;</span>, slider_resize)</span><br><span class="line">cv2.imwrite(<span class="string">&#x27;bk_resize.jpg&#x27;</span>, bk_resize)</span><br></pre></td></tr></table></figure>

<p>å°†èƒŒæ™¯å›¾ä¸Šç¼ºå£ä¸Šä¸‹éƒ¨åˆ†è£å‰ªå¤„ç†æ–¹ä¾¿è¯†åˆ«</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#è£å‰ªæ–¹æ³• retval = img[y:y+h, x:x+w]  x,y å·¦ä¸Šè§’åæ ‡å€¼ w,h å®½åº¦ã€é«˜åº¦</span></span><br><span class="line"><span class="comment">#è£å‰ªä¸­é—´éƒ¨åˆ† (0,43,340,68)</span></span><br><span class="line">x,y,w,h = [<span class="number">0</span>, slider_resize_y-bk_resize_y, bk_resize_w, slider_resize_h]</span><br><span class="line">bk_cutimg = bk_resize[y:y+h, x:x+w]</span><br><span class="line"></span><br><span class="line"> cv2.imwrite(<span class="string">&#x27;bk_cutimg.jpg&#x27;</span>, bk_cutimg)</span><br></pre></td></tr></table></figure>

<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-8%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/bk_cutimg.jpg" alt="bk_cutimg"></p>
<p>æ¶ˆé™¤å™ªå£°ï¼Œè¾¹ç¼˜è¯†åˆ«</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">canny</span>(<span class="params">image</span>):</span></span><br><span class="line">  <span class="comment">#é«˜æ–¯æ»¤æ³¢ æ¶ˆé™¤å™ªå£°å¹²æ‰°</span></span><br><span class="line">  image = cv2.GaussianBlur(image, (<span class="number">3</span>,<span class="number">3</span>), <span class="number">0</span>)</span><br><span class="line">  <span class="comment">#è¾¹ç¼˜è¯†åˆ«</span></span><br><span class="line">  <span class="keyword">return</span> cv2.Canny(image, <span class="number">50</span>, <span class="number">150</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¯»å–æ»‘å—å›¾</span></span><br><span class="line">slider_pic = cv2.imread(<span class="string">&#x27;slider_resize.jpg&#x27;</span>)</span><br><span class="line"><span class="comment"># è¯»å–èƒŒæ™¯å›¾</span></span><br><span class="line">bk_cutimg = cv2.imread(<span class="string">&#x27;bk_cutimg.jpg&#x27;</span>)</span><br><span class="line"></span><br><span class="line">slider_pic = canny(slider_pic)</span><br><span class="line">bk_cutimg = canny(bk_cutimg)</span><br><span class="line"></span><br><span class="line">cv2.imwrite(<span class="string">&#x27;canny_slider.jpg&#x27;</span>, slider_pic)</span><br><span class="line">cv2.imwrite(<span class="string">&#x27;canny_bk.jpg&#x27;</span>, bk_cutimg)</span><br></pre></td></tr></table></figure>

<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-8%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/canny_bk.jpg" alt="canny_bk"></p>
<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-8%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/canny_slider.jpg" alt="canny_slider"></p>
<p>æ¨¡æ¿åŒ¹é…ï¼Œå°†åŒ¹é…çš„ç¼ºå£ä½ç½®ç»˜åˆ¶å‡ºæ¥</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æ¨¡æ¿åŒ¹é…</span></span><br><span class="line"><span class="comment"># æ¯”è¾ƒä¸¤å¼ å›¾çš„é‡å åŒºåŸŸ</span></span><br><span class="line">result = cv2.matchTemplate(bk_cutimg, slider_pic, cv2.TM_CCORR_NORMED)  <span class="comment"># type: ndarray</span></span><br><span class="line">top, left = np.unravel_index(result.argmax(), result.shape)</span><br><span class="line">print(<span class="string">&#x27;æ»‘å—ç¼ºå£ä½ç½®&#x27;</span>, left, top, slider_resize_w, slider_resize_h)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»˜åˆ¶ç¼ºå£çŸ©å½¢</span></span><br><span class="line">img_draw = bk_cutimg.copy()</span><br><span class="line">cv2.rectangle(img_draw, pt1=(left, top), pt2=(left + slider_resize_w, top + slider_resize_h), color=(<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>), thickness=<span class="number">5</span>)</span><br><span class="line">cv2.imwrite(<span class="string">&#x27;img_draw.png&#x27;</span>, img_draw)</span><br></pre></td></tr></table></figure>

<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-8%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB/img_draw.png" alt="img_draw"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ç­‰å¾…æ‹–åŠ¨æ»‘å—æ˜¾ç¤º</span></span><br><span class="line">slider = wait.until(EC.presence_of_element_located((By.XPATH, <span class="string">&#x27;//*[@id=&quot;secsdk-captcha-drag-wrapper&quot;]/div[2]&#x27;</span>)))  <span class="comment"># type: WebElement</span></span><br></pre></td></tr></table></figure>

<p>æ ¹æ®ç¼ºå£ä½ç½®ï¼Œç”Ÿæˆç§»åŠ¨è½¨è¿¹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_track</span>(<span class="params">distance</span>):</span></span><br><span class="line">  print(<span class="string">&#x27;distance=&#x27;</span>, distance)</span><br><span class="line">  <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">  æ ¹æ®åç§»é‡è·å–ç§»åŠ¨è½¨è¿¹</span></span><br><span class="line"><span class="string">  :param distance: åç§»é‡</span></span><br><span class="line"><span class="string">  :return: ç§»åŠ¨è½¨è¿¹</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  rate = <span class="number">0.6</span></span><br><span class="line">  t = <span class="number">0.2</span></span><br><span class="line">  v = <span class="number">0</span></span><br><span class="line">  tracks = []</span><br><span class="line">  mid = rate * distance</span><br><span class="line">  s = <span class="number">0</span></span><br><span class="line">  <span class="keyword">while</span> s &lt; distance:</span><br><span class="line">      v0 = v</span><br><span class="line">      <span class="keyword">if</span> s &lt; mid:</span><br><span class="line">          a = <span class="number">20</span></span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">          a = <span class="number">-3</span></span><br><span class="line">      s0 = v0 * t + <span class="number">0.5</span> * a * t * t</span><br><span class="line">      v = v0 + a + t</span><br><span class="line">      tracks.append(<span class="built_in">round</span>(s0))</span><br><span class="line">      s += s0</span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">sum</span>(tracks) != distance:</span><br><span class="line">      tracks.append(distance-<span class="built_in">sum</span>(tracks))</span><br><span class="line">  <span class="keyword">return</span> tracks</span><br></pre></td></tr></table></figure>

<p>æ¨¡æ‹Ÿæ‹–åŠ¨æ»‘å—</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">shake_mouse</span>():</span></span><br><span class="line">  ActionChains(browser).move_by_offset(xoffset=<span class="number">-2</span>,yoffset=<span class="number">0</span>).perform()</span><br><span class="line">  ActionChains(browser).move_by_offset(xoffset=<span class="number">2</span>,yoffset=<span class="number">0</span>).perform()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">move_to_gap</span>(<span class="params">slider, tracks</span>):</span></span><br><span class="line">  <span class="comment"># back_tracks = [-1, -1, -2, -2, -3, -2, -2, -1, -1]</span></span><br><span class="line">  ActionChains(browser).click_and_hold(slider).perform()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> x <span class="keyword">in</span> tracks:</span><br><span class="line">      ActionChains(browser).move_by_offset(xoffset=x,yoffset=<span class="number">0</span>).perform()</span><br><span class="line">  sleep(<span class="number">0.5</span>)</span><br><span class="line">  <span class="comment"># for x in back_tracks:</span></span><br><span class="line">  <span class="comment">#     ActionChains(browser).move_by_offset(xoffset=x,yoffset=0).perform()</span></span><br><span class="line">  shake_mouse()</span><br><span class="line">  sleep(<span class="number">0.5</span>)</span><br><span class="line">  ActionChains(browser).release().perform()</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tracks = get_track(left) <span class="comment"># type: list</span></span><br><span class="line">tracks = <span class="built_in">list</span>(<span class="built_in">filter</span>(<span class="keyword">lambda</span> x: x != <span class="number">0</span>, tracks))</span><br><span class="line">move_to_gap(slider, tracks)</span><br></pre></td></tr></table></figure>



<ul>
<li>ä¿å­˜å›¾ç‰‡çš„æ–¹å¼</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">captcha = browser.find_element_by_css_selectro(<span class="string">&#x27;#captcha&#x27;</span>)</span><br><span class="line">image = Image.<span class="built_in">open</span>(BytesIO(captcha.screenshot_as_png))</span><br></pre></td></tr></table></figure>

<p>ç›´æ¥ä¿å­˜å›¾ç‰‡</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">captcha.screenshot(<span class="string">&#x27;xx.png&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="8-6-ä½¿ç”¨æ·±åº¦å­¦ä¹ è¯†åˆ«å›¾å½¢éªŒè¯ç "><a href="#8-6-ä½¿ç”¨æ·±åº¦å­¦ä¹ è¯†åˆ«å›¾å½¢éªŒè¯ç " class="headerlink" title="8.6 ä½¿ç”¨æ·±åº¦å­¦ä¹ è¯†åˆ«å›¾å½¢éªŒè¯ç "></a>8.6 ä½¿ç”¨æ·±åº¦å­¦ä¹ è¯†åˆ«å›¾å½¢éªŒè¯ç </h5><p>æ·±åº¦å­¦ä¹ æ¡†æ¶ PyTorch</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install torch torchvision</span><br></pre></td></tr></table></figure>

<h5 id="8-7-ä½¿ç”¨æ·±åº¦å­¦ä¹ è¯†åˆ«æ»‘åŠ¨éªŒè¯ç ç¼ºå£"><a href="#8-7-ä½¿ç”¨æ·±åº¦å­¦ä¹ è¯†åˆ«æ»‘åŠ¨éªŒè¯ç ç¼ºå£" class="headerlink" title="8.7 ä½¿ç”¨æ·±åº¦å­¦ä¹ è¯†åˆ«æ»‘åŠ¨éªŒè¯ç ç¼ºå£"></a>8.7 ä½¿ç”¨æ·±åº¦å­¦ä¹ è¯†åˆ«æ»‘åŠ¨éªŒè¯ç ç¼ºå£</h5><h5 id="8-8-æ‰“ç å¹³å°è¯†åˆ«éªŒè¯ç "><a href="#8-8-æ‰“ç å¹³å°è¯†åˆ«éªŒè¯ç " class="headerlink" title="8.8 æ‰“ç å¹³å°è¯†åˆ«éªŒè¯ç "></a>8.8 æ‰“ç å¹³å°è¯†åˆ«éªŒè¯ç </h5><h5 id="8-9-æ‰‹æœºéªŒè¯ç çš„è‡ªåŠ¨åŒ–å¤„ç†"><a href="#8-9-æ‰‹æœºéªŒè¯ç çš„è‡ªåŠ¨åŒ–å¤„ç†" class="headerlink" title="8.9 æ‰‹æœºéªŒè¯ç çš„è‡ªåŠ¨åŒ–å¤„ç†"></a>8.9 æ‰‹æœºéªŒè¯ç çš„è‡ªåŠ¨åŒ–å¤„ç†</h5><p>Flask å†™ä¸€ä¸ª APIï¼Œä»£ç ä¿å­˜ä¸º server.py è¿è¡Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 server.py</span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œå¯ä»¥ç”¨ Ngrok å·¥å…·å°†è¯¥æœåŠ¡æš´éœ²åˆ°å…¬ç½‘</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngrok http 500</span><br></pre></td></tr></table></figure>

<p>Ngrok å¯ä»¥æ–¹ä¾¿åœ°å°†ä»»ä½•éå…¬ç½‘çš„æœåŠ¡æš´éœ²åˆ°å…¬ç½‘è®¿é—®ï¼Œå¹¶é…ç½®ç‰¹å®šçš„äºŒçº§ä¸´æ—¶äºŒçº§åŸŸåï¼Œä½†ä¸€ä¸ªåŸŸåæœ‰æ—¶é•¿é™åˆ¶ï¼Œæ‰€ä»¥é€šå¸¸ä»…ä¾›æµ‹è¯•ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://gnrok.com/">https://gnrok.com</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/14/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-%E7%88%AC%E5%8F%96%E4%BB%8A%E6%97%A5%E5%A4%B4%E6%9D%A1%E8%A1%97%E6%8B%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="ç®€å•è®°å½•ä¸‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/14/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-%E7%88%AC%E5%8F%96%E4%BB%8A%E6%97%A5%E5%A4%B4%E6%9D%A1%E8%A1%97%E6%8B%8D/" class="post-title-link" itemprop="url">Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-çˆ¬å–ä»Šæ—¥å¤´æ¡è¡—æ‹</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>
      

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-04-14 10:36:51 / ä¿®æ”¹æ—¶é—´ï¼š15:52:30" itemprop="dateCreated datePublished" datetime="2022-04-14T10:36:51+08:00">2022-04-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h5 id="6-4-çˆ¬å–ä»Šæ—¥å¤´æ¡è¡—æ‹ç¾å›¾"><a href="#6-4-çˆ¬å–ä»Šæ—¥å¤´æ¡è¡—æ‹ç¾å›¾" class="headerlink" title="6.4 çˆ¬å–ä»Šæ—¥å¤´æ¡è¡—æ‹ç¾å›¾"></a>6.4 çˆ¬å–ä»Šæ—¥å¤´æ¡è¡—æ‹ç¾å›¾</h5><h6 id="æŠ“å–åˆ†æ"><a href="#æŠ“å–åˆ†æ" class="headerlink" title="æŠ“å–åˆ†æ"></a>æŠ“å–åˆ†æ</h6><p>æ‰“å¼€ä»Šæ—¥å¤´æ¡é¦–é¡µ <a target="_blank" rel="noopener" href="http://www.toutiao.com/">http://www.toutiao.com/</a>  æœç´¢è¡—æ‹</p>
<p>æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ŒæŸ¥çœ‹æ‰€æœ‰çš„ç½‘ç»œè¯·æ±‚ï¼Œå‘ç°é¡µé¢è¿”å›æ•°æ®ä¸æ˜¯ç”± Ajax åŠ è½½çš„ï¼Œæ˜¯ HTML ç±»å‹ï¼Œè¯·æ±‚é“¾æ¥ </p>
<p><code>https://so.toutiao.com/search?dvpf=pc&amp;source=input&amp;keyword=è¡—æ‹&amp;page_num=0&amp;pd=synthesis</code></p>
<p><img src="/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-%E7%88%AC%E5%8F%96%E4%BB%8A%E6%97%A5%E5%A4%B4%E6%9D%A1%E8%A1%97%E6%8B%8D/WeChat49f883417f3f8bd97ec5880e80066787.png" alt="WeChat49f883417f3f8bd97ec5880e80066787"></p>
<p>ç°åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºæœ‰è¡—æ‹-è§†é¢‘ï¼Œè¡—æ‹-å›¾ç‰‡ï¼Œè¡—æ‹è®¨è®ºï¼Œå…¶ä½™æ˜¾ç¤ºçš„å¯ä»¥æŒ‰åˆ†ç»„æ˜¾ç¤ºï¼Œæ¯ç»„æœ‰æ ‡é¢˜å’Œä¸€äº›å›¾ç‰‡</p>
<p>ç°åœ¨éœ€è¦æŠ“å–çš„å°±æ˜¯åˆ†ç»„æ ‡é¢˜å’Œåˆ†ç»„ä¸‹çš„å›¾ç‰‡</p>
<p>å…ˆè·å–æ¯é¡µåˆ—è¡¨æ•°æ®</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_page</span>(<span class="params">page_num</span>):</span></span><br><span class="line">  <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  è·å–æ¯é¡µåˆ—è¡¨æ•°æ®</span></span><br><span class="line"><span class="string">  :return: åˆ—è¡¨htmlæ•°æ®</span></span><br><span class="line"><span class="string">  &#x27;&#x27;&#x27;</span></span><br><span class="line">  params = &#123;</span><br><span class="line">      <span class="string">&#x27;source&#x27;</span>: <span class="string">&#x27;input&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;dvpf&#x27;</span>: <span class="string">&#x27;pc&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;keyword&#x27;</span>: <span class="string">&#x27;è¡—æ‹&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;page_num&#x27;</span>: page_num,</span><br><span class="line">      <span class="string">&#x27;pd&#x27;</span>: <span class="string">&#x27;synthesis&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">  url = <span class="string">&#x27;https://so.toutiao.com/search?&#x27;</span> + urlencode(params)</span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">      r = requests.get(url, headers=headers)</span><br><span class="line">      <span class="keyword">if</span> r.status_code == <span class="number">200</span>:</span><br><span class="line">          <span class="keyword">return</span> r.text</span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">          print(<span class="string">&#x27;request get_page error&#x27;</span>)</span><br><span class="line">  <span class="keyword">except</span> requests.ConnectionError:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<p>æ¥ç€ä»è¿”å›çš„ html æå–åˆ—è¡¨æ–‡ç« é“¾æ¥ï¼Œé€šè¿‡æ­£åˆ™æå–</p>
<p>ç½‘ç«™ç‚¹å‡»æŸ¥çœ‹æ¯æ¡æ–‡ç« çš„é“¾æ¥æ˜¯è¿™ç§çš„</p>
<p> <a target="_blank" rel="noopener" href="https://www.toutiao.com/article/7031340137846030856/?channel=&amp;source=search_tab">https://www.toutiao.com/article/7031340137846030856/?channel=&amp;source=search_tab</a></p>
<p>æŸ¥çœ‹åˆ—è¡¨è¿”å›çš„ html å¹¶æ²¡æœ‰æ‰¾åˆ°å®Œæ•´çš„æ–‡ç« é“¾æ¥ï¼Œéœ€è¦è‡ªå·±æ‹¼æ¥</p>
<p>æ­£åˆ™æå–åˆ—è¡¨ group_idï¼Œæ‹¼æˆå®Œæ•´æ–‡ç« é“¾æ¥</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_page</span>(<span class="params">html</span>):</span></span><br><span class="line">  <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  é€šè¿‡æ­£åˆ™æå–ä¸€é¡µåˆ—è¡¨æ•°æ®</span></span><br><span class="line"><span class="string">  &#x27;&#x27;&#x27;</span></span><br><span class="line">  pattern = re.<span class="built_in">compile</span>(<span class="string">&#x27;&lt;script type=application/json.*?(&#123;&quot;data&quot;:.*?&#125;&#125;&#125;)&lt;/script&gt;&#x27;</span>, re.S)</span><br><span class="line"></span><br><span class="line">  results = re.findall(pattern, html)</span><br><span class="line">  <span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">      listItem = &#123;&#125;</span><br><span class="line">      <span class="built_in">dict</span> = json.loads(result)</span><br><span class="line">      group_id = <span class="built_in">dict</span>.get(<span class="string">&#x27;data&#x27;</span>).get(<span class="string">&#x27;group_id&#x27;</span>)</span><br><span class="line">      title = <span class="built_in">dict</span>.get(<span class="string">&#x27;data&#x27;</span>).get(<span class="string">&#x27;title&#x27;</span>)</span><br><span class="line">      <span class="keyword">if</span> group_id != <span class="literal">None</span> <span class="keyword">and</span> title != <span class="literal">None</span>:</span><br><span class="line">          listItem[<span class="string">&#x27;title&#x27;</span>] = title</span><br><span class="line">          listItem[<span class="string">&#x27;group_id&#x27;</span>] = group_id</span><br><span class="line">          <span class="keyword">yield</span> listItem <span class="comment">#è¿”å›ç”Ÿæˆå™¨</span></span><br></pre></td></tr></table></figure>

<p>è¿›å…¥æ–‡ç« è·å–å“åº”é¡µé¢</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_article</span>(<span class="params">group_id</span>):</span></span><br><span class="line">  <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  è·å–æ–‡ç« html</span></span><br><span class="line"><span class="string">  :return: æ–‡ç« html</span></span><br><span class="line"><span class="string">  &#x27;&#x27;&#x27;</span></span><br><span class="line">  params = &#123;</span><br><span class="line">      <span class="string">&#x27;channel&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;source&#x27;</span>: <span class="string">&#x27;search_tab&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">  url = <span class="string">&#x27;https://www.toutiao.com/article/&#x27;</span> + group_id</span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">      r = requests.get(url=url, params=params, headers=headers)</span><br><span class="line">      <span class="keyword">if</span> r.status_code == <span class="number">200</span>:</span><br><span class="line">          <span class="keyword">return</span> r.text</span><br><span class="line">  <span class="keyword">except</span> requests.ConnectionError <span class="keyword">as</span> e:</span><br><span class="line">      print(<span class="string">&#x27;Error:&#x27;</span>, e.args)</span><br></pre></td></tr></table></figure>

<p>è§£ææ–‡ç« é¡µé¢ï¼Œæå–éœ€è¦ä¿å­˜çš„å›¾ç‰‡é“¾æ¥</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_article</span>(<span class="params">html</span>):</span></span><br><span class="line">  <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  æå–å›¾ç‰‡æ•°æ®</span></span><br><span class="line"><span class="string">  :return: è¿”å›å›¾ç‰‡åˆ—è¡¨</span></span><br><span class="line"><span class="string">  &#x27;&#x27;&#x27;</span></span><br><span class="line">  pattern = re.<span class="built_in">compile</span>(<span class="string">&#x27;&lt;div class=&quot;pgc-img&quot;&gt;.*?src=&quot;(.*?)&quot;.*?alt=&quot;(.*?)&quot;&#x27;</span>, re.S)</span><br><span class="line">  results = re.findall(pattern, html)</span><br><span class="line">  images = []</span><br><span class="line">  <span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">      image = &#123;&#125;</span><br><span class="line">      image[<span class="string">&#x27;url&#x27;</span>] = result[<span class="number">0</span>]</span><br><span class="line">      image[<span class="string">&#x27;title&#x27;</span>] = result[<span class="number">1</span>]</span><br><span class="line">      images.append(image)</span><br><span class="line">  <span class="keyword">return</span> images</span><br></pre></td></tr></table></figure>

<p>ä¿å­˜å›¾ç‰‡</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_image</span>(<span class="params">image</span>):</span></span><br><span class="line">  <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  ä¿å­˜å›¾ç‰‡</span></span><br><span class="line"><span class="string">  :param image: å›¾ç‰‡å¯¹è±¡&#123;title:xx,url:xx&#125;</span></span><br><span class="line"><span class="string">  &#x27;&#x27;&#x27;</span></span><br><span class="line">  image_path = <span class="string">&#x27;img&#x27;</span> + os.path.sep + image.get(<span class="string">&#x27;title&#x27;</span>)</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(image_path):</span><br><span class="line">      os.makedirs(image_path) <span class="comment"># ç”Ÿæˆç›®å½•æ–‡ä»¶å¤¹</span></span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">      resp = requests.get(image.get(<span class="string">&#x27;url&#x27;</span>))</span><br><span class="line">      <span class="keyword">if</span> resp.status_code == <span class="number">200</span>:</span><br><span class="line">          file_path = image_path + os.path.sep + <span class="string">&#x27;&#123;file_name&#125;.&#123;file_suffix&#125;&#x27;</span>.<span class="built_in">format</span>(</span><br><span class="line">              file_name=md5(resp.content).hexdigest(), <span class="comment">#ä½¿ç”¨å›¾ç‰‡md5å€¼ä½œä¸ºå›¾ç‰‡å</span></span><br><span class="line">              file_suffix=<span class="string">&#x27;jpg&#x27;</span></span><br><span class="line">          )</span><br><span class="line">          <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(file_path):</span><br><span class="line">              <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                  f.write(resp.content)</span><br><span class="line">              print(<span class="string">&#x27;Downloaded image path is %s&#x27;</span> % file_path)</span><br><span class="line">          <span class="keyword">else</span>:</span><br><span class="line">              print(<span class="string">&#x27;Already Downloaded&#x27;</span>, file_path)</span><br><span class="line">  <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">      print(e, <span class="string">&#x27;none123&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>æ ¹æ® image çš„ title æ¥åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œç„¶åè¯·æ±‚å›¾ç‰‡é“¾æ¥ï¼Œè·å–å›¾ç‰‡çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œä»¥äºŒè¿›åˆ¶å½¢å¼å†™å…¥æ–‡ä»¶ï¼Œå›¾ç‰‡çš„åç§°å¯ä»¥ä½¿ç”¨å…¶å†…å®¹çš„MD5å€¼ï¼Œè¿™æ ·å¯ä»¥å»é™¤é‡å¤</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlencode</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;Cookie&#x27;</span>: <span class="string">&#x27;msToken=fftEubI251GAmJDZSNTUKj927FcCDPj7RE_XHLi_NMtm-cHnBx-iBxBVo4mygLcZI-dEjePff5pZeXl4c7mLta0KX2SDDPiTEslhfNOw0iNz; ttwid=1|xqpvNtm5D6xFmuFjl3WTtk_jkA4ybMYfqHLzIzKmi2Y|1649864470|16944aed776db4b21fa0d03d6e09c237023b5fc301a3df68c81d5ef03b17c355;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.75 Safari/537.36&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  list_html = get_page(<span class="number">0</span>)  <span class="comment"># è·å–åˆ—è¡¨html</span></span><br><span class="line">  list_items = parse_page(list_html)  <span class="comment"># è·å–æ–‡ç« åˆ—è¡¨</span></span><br><span class="line">  <span class="keyword">for</span> list_item <span class="keyword">in</span> list_items:</span><br><span class="line">      print(list_item)</span><br><span class="line">      article_html = get_article(list_item.get(<span class="string">&#x27;group_id&#x27;</span>))  <span class="comment"># æ–‡ç« html</span></span><br><span class="line">      images = parse_article(article_html)  <span class="comment"># æå–å›¾ç‰‡æ•°æ®</span></span><br><span class="line">      <span class="keyword">for</span> image <span class="keyword">in</span> images:</span><br><span class="line">          save_image(image)</span><br></pre></td></tr></table></figure>



<p>ä¹¦ä¸Šè¿˜æœ‰å¤šçº¿ç¨‹ä¸‹è½½ï¼Œä½œè€…æœ€æ–°ä»£ç ç»™å»æ‰äº†ï¼šä¸ç”¨Poolå¤šè¿›ç¨‹æ˜¯å› ä¸ºç›®å‰è¿˜æ²¡æœ‰åŠæ³•å®ç°è·¨è¿›ç¨‹å…±äº«Cookies</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#åˆ©ç”¨å¤šçº¿ç¨‹çš„çº¿ç¨‹æ± ï¼Œè°ƒç”¨å…¶ map() æ–¹æ³•å®ç°å¤šçº¿ç¨‹ä¸‹è½½</span></span><br><span class="line"><span class="keyword">from</span> multiprocessing.pool <span class="keyword">import</span> Pool</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">offset</span>):</span></span><br><span class="line">  print(<span class="string">&quot;xx&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  pool = Pool()</span><br><span class="line">  GROUP_START = <span class="number">1</span></span><br><span class="line">  GROUP_END = <span class="number">20</span></span><br><span class="line">  groups = ([x * <span class="number">20</span> <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(GROUP_START, GROUP_END + <span class="number">1</span>)])</span><br><span class="line">  pool.<span class="built_in">map</span>(main,groups)</span><br><span class="line">  pool.close()</span><br><span class="line">  pool.join()</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/13/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-5Ajax%E6%95%B0%E6%8D%AE%E7%88%AC%E5%8F%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="ç®€å•è®°å½•ä¸‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/13/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-5Ajax%E6%95%B0%E6%8D%AE%E7%88%AC%E5%8F%96/" class="post-title-link" itemprop="url">Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-5Ajaxæ•°æ®çˆ¬å–</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-04-13 17:40:19" itemprop="dateCreated datePublished" datetime="2022-04-13T17:40:19+08:00">2022-04-13</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-10-09 08:57:19" itemprop="dateModified" datetime="2022-10-09T08:57:19+08:00">2022-10-09</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="5-Ajax-æ•°æ®çˆ¬å–"><a href="#5-Ajax-æ•°æ®çˆ¬å–" class="headerlink" title="5. Ajax æ•°æ®çˆ¬å–"></a>5. Ajax æ•°æ®çˆ¬å–</h4><p>æœ‰äº›ç½‘é¡µåŸå§‹çš„ HTML æ–‡æ¡£ä¸ä¼šåŒ…å«ä»»ä½•æ•°æ®ï¼Œæ•°æ®éƒ½æ˜¯é€šè¿‡ Ajax ç»Ÿä¸€åŠ è½½åå†å‘ˆç°å‡ºæ¥ã€‚</p>
<p>é‡åˆ°è¿™ç§é¡µé¢ï¼Œç›´æ¥åˆ©ç”¨ requests ç­‰åº“æ¥æŠ“å–åŸå§‹é¡µé¢ï¼Œæ˜¯æ— æ³•è·å–åˆ°æœ‰æ•ˆæ•°æ®çš„</p>
<p>Ajax æ˜¯åˆ©ç”¨ JavaScript åœ¨ä¿è¯é¡µé¢ä¸è¢«åˆ·æ–°ã€é¡µé¢é“¾æ¥ä¸æ”¹å˜çš„æƒ…å†µä¸‹ä¸æœåŠ¡å™¨äº¤æ¢æ•°æ®å¹¶æ›´æ–°éƒ¨åˆ†ç½‘é¡µçš„æŠ€æœ¯</p>
<p>ä¾‹å­ï¼šå¦‚å¾®åšé¡µé¢ï¼Œåˆ†é¡µåŠ è½½å¾®åšå†…å®¹ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯ Ajax åŠ è½½çš„è¿‡ç¨‹ï¼Œé¡µé¢å¹¶æ²¡æœ‰åˆ·æ–°ï¼Œç½‘é¡µå´å¤šäº†æ–°çš„å†…å®¹</p>
<h5 id="5-2-Ajax-åˆ†ææ–¹æ³•"><a href="#5-2-Ajax-åˆ†ææ–¹æ³•" class="headerlink" title="5.2 Ajax åˆ†ææ–¹æ³•"></a>5.2 Ajax åˆ†ææ–¹æ³•</h5><ol>
<li>æŸ¥çœ‹è¯·æ±‚</li>
</ol>
<p>Chrome æ‰“å¼€å¾®åšé“¾æ¥ <a target="_blank" rel="noopener" href="https://m.weibo.cn/u/2830678474">https://m.weibo.cn/u/2830678474</a></p>
<p>é¡µé¢ä¸­é¼ æ ‡å³é”®é€‰æ‹©æ£€æŸ¥é€‰é¡¹ï¼Œå¼¹å‡ºå¼€å‘è€…å·¥å…·</p>
<p>åˆ‡æ¢åˆ° Network é€‰é¡¹å¡ï¼Œé‡æ–°åˆ·æ–°é¡µé¢ï¼Œå‡ºç°éå¸¸å¤šçš„æ¡ç›®</p>
<p>Ajax å…¶å®æ˜¯ç‰¹æ®Šçš„è¯·æ±‚ç±»å‹ï¼Œå«ä½œ xhr</p>
<p>æ‰¾åˆ° Type ä¸º xhr çš„å°±æ˜¯ Ajax è¯·æ±‚ï¼Œç‚¹å‡»è¯·æ±‚æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼ŒRequest Headers ä¸­æœ‰ä¸€ä¸ªä¿¡æ¯ä¸º X-Requested-With:XMLHttpRequestï¼Œè¿™å°±æ ‡è®°äº†æ­¤è¯·æ±‚æ˜¯ Ajax è¯·æ±‚</p>
<ol start="2">
<li>è¿‡æ»¤è¯·æ±‚</li>
</ol>
<p>Chrome å¼€å‘è€…å·¥å…·ç­›é€‰ç‚¹å‡» XHR ç­›é€‰å‡ºæ‰€æœ‰ Ajax è¯·æ±‚</p>
<h5 id="5-3-Ajax-ç»“æœæå–"><a href="#5-3-Ajax-ç»“æœæå–" class="headerlink" title="5.3 Ajax ç»“æœæå–"></a>5.3 Ajax ç»“æœæå–</h5><p>æ¨¡æ‹Ÿ Ajax è¯·æ±‚ï¼Œå°†å‰10é¡µå¾®åšçˆ¬å–ä¸‹æ¥</p>
<p>ä»£ç åœ°å€ <a target="_blank" rel="noopener" href="https://github.com/Python3WebSpider/WeiboList">https://github.com/Python3WebSpider/WeiboList</a></p>
<p>æŸ¥çœ‹è¯·æ±‚é“¾æ¥</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ç¬¬ä¸€é¡µ</span><br><span class="line">https://m.weibo.cn/api/container/getIndex?type=uid&amp;value=2830678474&amp;containerid=1076032830678474</span><br><span class="line">ç¬¬ä¸€é¡µè¿”å›æ•°æ®</span><br><span class="line">...</span><br><span class="line"><span class="string">&quot;cardlistInfo&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;containerid&quot;</span>: <span class="string">&quot;1076032830678474&quot;</span>,</span><br><span class="line">    <span class="string">&quot;v_p&quot;</span>: <span class="number">42</span>,</span><br><span class="line">    <span class="string">&quot;show_style&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;total&quot;</span>: <span class="number">2488</span>,</span><br><span class="line">    <span class="string">&quot;since_id&quot;</span>: <span class="number">4751617833832728</span></span><br><span class="line">&#125;</span><br><span class="line">ç¬¬äºŒé¡µ</span><br><span class="line"> https://m.weibo.cn/api/container/getIndex?type=uid&amp;value=2830678474&amp;containerid=1076032830678474&amp;since_id=4755918556758808</span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒé¡µçš„ since_id è¯·æ±‚å‚æ•°æ˜¯ç¬¬ä¸€é¡µè¿”å›çš„</p>
<p>éœ€è¦æŠŠç¬¬ä¸€é¡µè¿”å›æ•°æ®ä¸­çš„ since_id ä¿å­˜ï¼Œåœ¨è¯·æ±‚ç¬¬äºŒé¡µçš„æ—¶å€™ä½¿ç”¨</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pyquery <span class="keyword">import</span> PyQuery <span class="keyword">as</span> pq</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> pymongo <span class="keyword">import</span> MongoClient</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">since_id = <span class="string">&#x27;&#x27;</span></span><br><span class="line">client = MongoClient()</span><br><span class="line">db = client[<span class="string">&#x27;weibo&#x27;</span>]</span><br><span class="line">collection = db[<span class="string">&#x27;weibo&#x27;</span>]</span><br><span class="line">max_page = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_to_mongo</span>(<span class="params"><span class="built_in">dict</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> collection.insert_one(<span class="built_in">dict</span>):</span><br><span class="line">        print(<span class="string">&#x27;Save to Mongo&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_to_local</span>(<span class="params"><span class="built_in">dict</span></span>):</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;weibo.json&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        file.write(json.dumps(<span class="built_in">dict</span>, indent=<span class="number">2</span>, ensure_ascii=<span class="literal">False</span>))</span><br><span class="line">        file.write(<span class="string">&#x27;\n&#x27;</span> + <span class="string">&#x27;=&#x27;</span> * <span class="number">50</span> + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_page</span>(<span class="params">json</span>):</span></span><br><span class="line">    <span class="keyword">if</span> json:</span><br><span class="line">        items = json.get(<span class="string">&#x27;data&#x27;</span>).get(<span class="string">&#x27;cards&#x27;</span>)</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">            item = item.get(<span class="string">&#x27;mblog&#x27;</span>)</span><br><span class="line">            weibo = &#123;&#125;</span><br><span class="line">            weibo[<span class="string">&#x27;id&#x27;</span>] = item.get(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">            weibo[<span class="string">&#x27;text&#x27;</span>] = pq(item.get(<span class="string">&#x27;text&#x27;</span>)).text()<span class="comment">#å»é™¤HTMLæ ‡ç­¾</span></span><br><span class="line">            weibo[<span class="string">&#x27;attitudes&#x27;</span>] = item.get(<span class="string">&#x27;attitudes_count&#x27;</span>)</span><br><span class="line">            weibo[<span class="string">&#x27;comments&#x27;</span>] = item.get(<span class="string">&#x27;comments_count&#x27;</span>)</span><br><span class="line">            weibo[<span class="string">&#x27;reposts&#x27;</span>] = item.get(<span class="string">&#x27;reposts_count&#x27;</span>)</span><br><span class="line">            <span class="keyword">yield</span> weibo <span class="comment">#å°†weiboä»¥generatorè¿”å›</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_page</span>():</span></span><br><span class="line">    <span class="keyword">global</span> since_id <span class="comment"># å£°æ˜å…¨å±€å˜é‡</span></span><br><span class="line">    base_url = <span class="string">&#x27;https://m.weibo.cn/api/container/getIndex?type=uid&amp;value=2830678474&amp;containerid=1076032830678474&#x27;</span></span><br><span class="line">    params = &#123;</span><br><span class="line">        <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;uid&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;value&#x27;</span>: <span class="string">&#x27;2830678474&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;containerid&#x27;</span>: <span class="string">&#x27;1076032830678474&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> since_id != <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        params[<span class="string">&#x27;since_id&#x27;</span>] = since_id</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.75 Safari/537.36&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    result = requests.get(base_url, params=params, headers=headers)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> result.status_code == <span class="number">200</span>:</span><br><span class="line">            jsonRes = result.json()</span><br><span class="line">            info = jsonRes.get(<span class="string">&#x27;data&#x27;</span>).get(<span class="string">&#x27;cardlistInfo&#x27;</span>)</span><br><span class="line">            since_id = info[<span class="string">&#x27;since_id&#x27;</span>]</span><br><span class="line">            <span class="keyword">return</span> jsonRes</span><br><span class="line">    <span class="keyword">except</span> requests.ConnectionError <span class="keyword">as</span> e:</span><br><span class="line">        print(e.args)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(max_page):</span><br><span class="line">        data = get_page()</span><br><span class="line">        results = parse_page(data)</span><br><span class="line">        <span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">            save_to_mongo(result)</span><br><span class="line">            <span class="comment"># print(type(result),result)</span></span><br><span class="line">            <span class="comment"># save_to_local(result) #ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶</span></span><br></pre></td></tr></table></figure>

<p>ä¿å­˜æ•°æ®åˆ°æœ¬åœ°</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_to_local</span>(<span class="params"><span class="built_in">dict</span></span>):</span></span><br><span class="line">  <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;weibo.json&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">      file.write(json.dumps(<span class="built_in">dict</span>, indent=<span class="number">2</span>, ensure_ascii=<span class="literal">False</span>))</span><br><span class="line">      file.write(<span class="string">&#x27;\n&#x27;</span> + <span class="string">&#x27;=&#x27;</span> * <span class="number">50</span> + <span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>ä¿å­˜æ•°æ®åˆ°MongoDB</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_to_mongo</span>(<span class="params"><span class="built_in">dict</span></span>):</span></span><br><span class="line">  <span class="keyword">if</span> collection.insert_one(<span class="built_in">dict</span>):</span><br><span class="line">      print(<span class="string">&#x27;Save to Mongo&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h5 id="5-4-åˆ†æ-Ajax-çˆ¬å–ä»Šæ—¥å¤´æ¡è¡—æ‹ç¾å›¾"><a href="#5-4-åˆ†æ-Ajax-çˆ¬å–ä»Šæ—¥å¤´æ¡è¡—æ‹ç¾å›¾" class="headerlink" title="5.4 åˆ†æ Ajax çˆ¬å–ä»Šæ—¥å¤´æ¡è¡—æ‹ç¾å›¾"></a>5.4 åˆ†æ Ajax çˆ¬å–ä»Šæ—¥å¤´æ¡è¡—æ‹ç¾å›¾</h5><p>é“¾æ¥æœ‰å˜åŠ¨ï¼ŒæŸ¥çœ‹æœ€æ–°ä»£ç  <a target="_blank" rel="noopener" href="https://github.com/Python3WebSpider/Jiepai">https://github.com/Python3WebSpider/Jiepai</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/12/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-4%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="ç®€å•è®°å½•ä¸‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/12/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-4%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8/" class="post-title-link" itemprop="url">Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-æ•°æ®å­˜å‚¨</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-04-12 10:56:35" itemprop="dateCreated datePublished" datetime="2022-04-12T10:56:35+08:00">2022-04-12</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-10-09 08:57:19" itemprop="dateModified" datetime="2022-10-09T08:57:19+08:00">2022-10-09</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="4-æ–‡ä»¶å­˜å‚¨"><a href="#4-æ–‡ä»¶å­˜å‚¨" class="headerlink" title="4 æ–‡ä»¶å­˜å‚¨"></a>4 æ–‡ä»¶å­˜å‚¨</h4><h4 id="4-1-TXT-æ–‡æœ¬å­˜å‚¨"><a href="#4-1-TXT-æ–‡æœ¬å­˜å‚¨" class="headerlink" title="4.1 TXT æ–‡æœ¬å­˜å‚¨"></a>4.1 TXT æ–‡æœ¬å­˜å‚¨</h4><p>ä¿å­˜çŸ¥ä¹ä¸Šè¿‘æœŸçƒ­ç‚¹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pyquery <span class="keyword">import</span> PyQuery <span class="keyword">as</span> pq</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&#x27;https://www.zhihu.com/explore&#x27;</span></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.0 Safari/605.1.15&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">html = requests.get(url, headers=headers).text</span><br><span class="line">doc = pq(html)</span><br><span class="line"><span class="comment"># items = doc(&#x27;.css-4cffwv&#x27;)</span></span><br><span class="line">items = doc(<span class="string">&#x27;.css-4cffwv .css-vurnku .css-1as7ang&#x27;</span>).items()</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">    topic = item(<span class="string">&#x27;.css-1g4zjtl a&#x27;</span>).text()</span><br><span class="line">    des = item(<span class="string">&#x27;.css-13jrecd&#x27;</span>).text()</span><br><span class="line">    file = <span class="built_in">open</span>(<span class="string">&#x27;explore.txt&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    file.write(<span class="string">&#x27;\n&#x27;</span>.join([topic, des]))</span><br><span class="line">    file.write(<span class="string">&#x27;\n&#x27;</span> + <span class="string">&#x27;=&#x27;</span> * <span class="number">50</span> + <span class="string">&#x27;\n&#x27;</span> )</span><br><span class="line">    file.close()</span><br></pre></td></tr></table></figure>

<p>open ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºä¿å­˜æ–‡ä»¶åç§°ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸º a ä»£è¡¨è¿½åŠ æ–¹å¼å†™å…¥åˆ°æ–‡æœ¬</p>
<p>å†™å…¥å®Œæˆåéœ€è¦è°ƒç”¨ close æ–¹æ³•å…³é—­æ–‡ä»¶å¯¹è±¡</p>
<h5 id="æ‰“å¼€æ–¹å¼"><a href="#æ‰“å¼€æ–¹å¼" class="headerlink" title="æ‰“å¼€æ–¹å¼"></a>æ‰“å¼€æ–¹å¼</h5><table>
<thead>
<tr>
<th>æ‰“å¼€æ–¹å¼</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>r</td>
<td>åªè¯»æ–¹å¼æ‰“å¼€ï¼Œæ–‡ä»¶æŒ‡é’ˆæ”¾åœ¨æ–‡ä»¶å¼€å¤´</td>
</tr>
<tr>
<td>rb</td>
<td>ä»¥äºŒè¿›åˆ¶åªè¯»æ–¹å¼æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶æŒ‡é’ˆæ”¾åœ¨æ–‡ä»¶å¼€å¤´</td>
</tr>
<tr>
<td>r+</td>
<td>ä»¥è¯»å†™æ–¹å¼æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶æŒ‡é’ˆæ”¾åœ¨æ–‡ä»¶å¼€å¤´</td>
</tr>
<tr>
<td>rb+</td>
<td>ä»¥äºŒè¿›åˆ¶è¯»å†™æ–¹å¼æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶æŒ‡é’ˆæ”¾åœ¨æ–‡ä»¶å¼€å¤´</td>
</tr>
<tr>
<td>w</td>
<td>ä»¥å†™å…¥æ–¹å¼æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶å·²å­˜åœ¨ä¼šè¦†ç›–ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º</td>
</tr>
<tr>
<td>wb</td>
<td>ä»¥äºŒè¿›åˆ¶å†™å…¥æ–¹å¼æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶å·²å­˜åœ¨ä¼šè¦†ç›–ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º</td>
</tr>
<tr>
<td>w+</td>
<td>ä»¥è¯»å†™å…¥æ–¹å¼æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶å·²å­˜åœ¨ä¼šè¦†ç›–ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º</td>
</tr>
<tr>
<td>wb+</td>
<td>ä»¥äºŒè¿›åˆ¶è¯»å†™æ–¹å¼æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶å·²å­˜åœ¨ä¼šè¦†ç›–ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º</td>
</tr>
<tr>
<td>a</td>
<td>ä»¥è¿½åŠ æ–¹å¼æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶å·²å­˜åœ¨æ–°å†…å®¹å†™å…¥å·²æœ‰å†…å®¹ä¹‹åï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º</td>
</tr>
<tr>
<td>ab</td>
<td>ä»¥äºŒè¿›åˆ¶è¿½åŠ æ–¹å¼æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶å·²å­˜åœ¨æ–°å†…å®¹å†™å…¥å·²æœ‰å†…å®¹ä¹‹åï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º</td>
</tr>
<tr>
<td>a+</td>
<td>ä»¥è¯»å†™æ–¹å¼æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œæ–‡ä»¶å·²å­˜åœ¨æ–°å†…å®¹å†™å…¥å·²æœ‰å†…å®¹ä¹‹åï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º</td>
</tr>
<tr>
<td>ab+</td>
<td></td>
</tr>
</tbody></table>
<h5 id="ç®€åŒ–å†™æ³•"><a href="#ç®€åŒ–å†™æ³•" class="headerlink" title="ç®€åŒ–å†™æ³•"></a>ç®€åŒ–å†™æ³•</h5><p>with as è¯­æ³•ï¼Œwith æ§åˆ¶å—ç»“æŸæ—¶ï¼Œæ–‡ä»¶ä¼šè‡ªåŠ¨å…³é—­ï¼Œä¸éœ€è¦è°ƒç”¨ close</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;explore.txt&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    file.write(<span class="string">&#x27;\n&#x27;</span>.join([topic, des]))</span><br><span class="line">    file.write(<span class="string">&#x27;\n&#x27;</span> + <span class="string">&#x27;=&#x27;</span> * <span class="number">50</span> + <span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="4-2-JSON-æ–‡ä»¶å­˜å‚¨"><a href="#4-2-JSON-æ–‡ä»¶å­˜å‚¨" class="headerlink" title="4.2 JSON æ–‡ä»¶å­˜å‚¨"></a>4.2 JSON æ–‡ä»¶å­˜å‚¨</h4><h5 id="è¯»å–-JSON"><a href="#è¯»å–-JSON" class="headerlink" title="è¯»å– JSON"></a>è¯»å– JSON</h5><p>å¯ä»¥è°ƒç”¨ JSON åº“çš„ loads() æ–¹æ³•å°† JSON æ–‡æœ¬å­—ç¬¦ä¸²è½¬ä¸º JSON å¯¹è±¡ï¼Œé€šè¿‡ dumps() å°† JSON å¯¹è±¡è½¬ä¸ºæ–‡æœ¬å­—ç¬¦ä¸²</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="built_in">str</span> = <span class="string">&#x27;[&#123;&quot;name&quot;: &quot;Bob&quot;&#125;,&#123;&quot;gender&quot;: &quot;male&quot;&#125;]&#x27;</span></span><br><span class="line">data = json.loads(<span class="built_in">str</span>)</span><br><span class="line">print(data)</span><br><span class="line"><span class="comment">#è½¬æˆJSONå°±å¯ä»¥ç”¨ç´¢å¼•è·å–å†…å®¹äº†</span></span><br><span class="line">data[<span class="number">0</span>][<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">data[<span class="number">0</span>].get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">data[<span class="number">0</span>].get(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;jack&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>è·å–é”®å€¼æ¨èä½¿ç”¨ get æ–¹æ³•ï¼Œå¦‚æœé”®åä¸å­˜åœ¨ä¸ä¼šæŠ¥é”™ï¼Œè¿”å›Noneï¼Œget æ–¹æ³•è¿˜å¯ä»¥ä¼ å…¥ç¬¬äºŒä¸ªå‚æ•°ï¼ˆé»˜è®¤å€¼ï¼‰</p>
<p>ä¸‹é¢å®ç°ä» JSON æ–‡æœ¬ä¸­è¯»å–å†…å®¹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;data.json&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">  <span class="built_in">str</span> = file.read()</span><br><span class="line">  data = json.loads(<span class="built_in">str</span>)</span><br><span class="line">  print(data)</span><br></pre></td></tr></table></figure>

<p>æ›´ç®€ä¾¿çš„å†™æ³•ï¼Œç›´æ¥ä½¿ç”¨ load æ–¹æ³•ä¼ å…¥æ–‡ä»¶æ“ä½œå¯¹è±¡</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line">data = json.load(<span class="built_in">open</span>(<span class="string">&#x27;data.json&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">print(data)</span><br></pre></td></tr></table></figure>

<h5 id="è¾“å‡ºJSON"><a href="#è¾“å‡ºJSON" class="headerlink" title="è¾“å‡ºJSON"></a>è¾“å‡ºJSON</h5><p>å°†JSONå¯¹è±¡è½¬ä¸ºå­—ç¬¦ä¸²ï¼Œå†™å…¥æ–‡æœ¬</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">data = [&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Bob&#x27;</span>&#125;, &#123;<span class="string">&#x27;gender&#x27;</span>: <span class="string">&#x27;male&#x27;</span>&#125;]</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;data.json&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">  file.write(json.dumps(data))</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæƒ³ä¿å­˜JSONæ ¼å¼ï¼Œå†åŠ ä¸€ä¸ªå‚æ•° indentï¼Œä»£è¡¨ç¼©è¿›å­—ç¬¦ä¸ªæ•°</p>
<p>è¾“å‡ºä¸­æ–‡ï¼ŒåŠ å‚æ•° ensure_ascii ä¸º False</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file.write(json.dumps(data, indent=<span class="number">2</span>, ensure_ascii=<span class="literal">False</span>))</span><br></pre></td></tr></table></figure>

<p>ç±»æ¯” loads å’Œ load æ–¹æ³•ï¼Œdumps åŒæ ·ä¹Ÿæœ‰ dump æ–¹æ³•ï¼Œå¯ä»¥ç›´æ¥å°† JSON å¯¹è±¡å…¨éƒ¨å†™å…¥æ–‡ä»¶</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">json.dump(data, <span class="built_in">open</span>(<span class="string">&#x27;data.json&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>), indent=<span class="number">2</span>, ensure_ascii=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>



<h4 id="4-3-CSV-æ–‡ä»¶å­˜å‚¨"><a href="#4-3-CSV-æ–‡ä»¶å­˜å‚¨" class="headerlink" title="4.3 CSV æ–‡ä»¶å­˜å‚¨"></a>4.3 CSV æ–‡ä»¶å­˜å‚¨</h4><p>é€—å·åˆ†éš”å€¼æˆ–å­—ç¬¦åˆ†éš”å€¼ï¼Œæ–‡ä»¶ä»¥çº¯æ–‡æœ¬å½¢å¼å­˜å‚¨è¡¨æ ¼æ•°æ®</p>
<h5 id="å†™å…¥"><a href="#å†™å…¥" class="headerlink" title="å†™å…¥"></a>å†™å…¥</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;data.csv&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> csvfile:</span><br><span class="line">    writer = csv.writer(csvfile)</span><br><span class="line">    writer.writerow([<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;age&#x27;</span>])</span><br><span class="line">    writer.writerow([<span class="string">&#x27;10001&#x27;</span>, <span class="string">&#x27;Mike&#x27;</span>, <span class="string">&#x27;20&#x27;</span>])</span><br><span class="line">    writer.writerow([<span class="string">&#x27;10002&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;21&#x27;</span>])</span><br><span class="line">    writer.writerow([<span class="string">&#x27;10003&#x27;</span>, <span class="string">&#x27;Jack&#x27;</span>, <span class="string">&#x27;22&#x27;</span>])</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆæ‰“å¼€ data.csv æ–‡ä»¶ï¼Œæ¨¡å¼ä¸º w å†™å…¥ï¼Œè°ƒç”¨ csv åº“çš„ writer æ–¹æ³•åˆå§‹åŒ–å†™å…¥å¯¹è±¡ï¼Œè°ƒç”¨ writerow() æ–¹æ³•ä¼ å…¥å†™å…¥çš„æ¯è¡Œæ•°æ®</p>
<p>ä»¥æ–‡æœ¬æ–¹å¼æ‰“å¼€ï¼Œå†™å…¥çš„æ–‡æœ¬é»˜è®¤ä»¥é€—å·åˆ†éš”</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">id</span>,name,age</span><br><span class="line"><span class="number">10001</span>,Mike,<span class="number">20</span></span><br><span class="line"><span class="number">10002</span>,Bob,<span class="number">21</span></span><br><span class="line"><span class="number">10003</span>,Jack,<span class="number">22</span></span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ä»¥ç”¨ Excel æ‰“å¼€ï¼Œæ¯ä¸ªå€¼å¯¹åº”ä¸€ä¸ªå•å…ƒæ ¼</p>
<p>å¯ä»¥æŒ‡å®šåˆ†éš”ç¬¦å·</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">writer = csv.writer(csvfile,delimiter=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line"><span class="comment">#æ–‡æœ¬æ–¹å¼æ‰“å¼€</span></span><br><span class="line"><span class="built_in">id</span> name age</span><br><span class="line"><span class="number">10001</span> Mike <span class="number">20</span></span><br><span class="line"><span class="number">10002</span> Bob <span class="number">21</span></span><br><span class="line"><span class="number">10003</span> Jack <span class="number">22</span></span><br></pre></td></tr></table></figure>

<p>Excel æ‰“å¼€åªæœ‰ä¸€ä¸ªå•å…ƒæ ¼æ˜¾ç¤ºæ‰€æœ‰å€¼äº†</p>
<p>writerrows() å†™å…¥å¤šè¡Œï¼Œå‚æ•°éœ€è¦äºŒç»´åˆ—è¡¨</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">writer = csv.writer(csvfile)</span><br><span class="line">writer.writerow([<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;age&#x27;</span>])</span><br><span class="line">writer.writerows([[<span class="string">&#x27;10001&#x27;</span>, <span class="string">&#x27;Mike&#x27;</span>, <span class="string">&#x27;20&#x27;</span>],[<span class="string">&#x27;10002&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;21&#x27;</span>],[<span class="string">&#x27;10003&#x27;</span>, <span class="string">&#x27;Jack&#x27;</span>, <span class="string">&#x27;22&#x27;</span>]])</span><br></pre></td></tr></table></figure>

<ul>
<li>å­—å…¸çš„å†™å…¥æ–¹å¼</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;data.csv&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> csvfile:</span><br><span class="line">    fieldnames = [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;age&#x27;</span>]</span><br><span class="line">    writer = csv.DictWriter(csvfile, fieldnames=fieldnames)</span><br><span class="line">    writer.writeheader() <span class="comment">#å†™å…¥å¤´ä¿¡æ¯</span></span><br><span class="line">    writer.writerow(&#123;<span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;10001&#x27;</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Mike&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">20</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>å¦‚æœè¦å†™å…¥ä¸­æ–‡å†…å®¹ï¼Œéœ€è¦ç»™ open å‚æ•°æŒ‡å®šç¼–ç æ ¼å¼</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;data.csv&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>pandas åº“å†™å…¥cvs</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">data = [</span><br><span class="line">  &#123;<span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;10001&#x27;</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Mkie&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">20</span>&#125;,</span><br><span class="line">  &#123;<span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;10002&#x27;</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">22</span>&#125;,</span><br><span class="line">]</span><br><span class="line">df = pd.DataFrame(data)</span><br><span class="line">df.to_csv(<span class="string">&#x27;data.csv&#x27;</span>, index=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>df çš„ to_csv æ–¹æ³•ä¹Ÿå¯å°†æ•°æ®ä¿å­˜ä¸º CSV æ–‡ä»¶</p>
<h5 id="è¯»å–"><a href="#è¯»å–" class="headerlink" title="è¯»å–"></a>è¯»å–</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;data.csv&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> csvfile:</span><br><span class="line">    reader = csv.reader(csvfile)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> reader:</span><br><span class="line">        print(row)</span><br></pre></td></tr></table></figure>

<p>æ„é€  Reader å¯¹è±¡ï¼Œéå†è¾“å‡ºæ¯è¡Œå†…å®¹ï¼Œæ¯è¡Œéƒ½æ˜¯ä¸€ä¸ªåˆ—è¡¨å½¢å¼</p>
<ul>
<li>pandas åº“è¯»å– cvs</li>
</ul>
<p>åˆ©ç”¨ read_csv æ–¹æ³•å°†æ•°æ®ä» csv ä¸­è¯»å–å‡ºæ¥</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">df = pd.read_csv(<span class="string">&#x27;data.csv&#x27;</span>)</span><br><span class="line">print(df)</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæŒ‡å‘è¯»å–æ–‡ä»¶é‡Œé¢çš„æ•°æ®ï¼Œå¯ä»¥æŠŠ df å†è¿›ä¸€æ­¥è½¬åŒ–ä¸ºåˆ—è¡¨æˆ–è€…å…ƒç»„</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data = df.values.tolist()</span><br></pre></td></tr></table></figure>

<p>ç›´æ¥å¯¹ df è¿›è¡Œé€è¡Œéå†ï¼ŒåŒæ ·èƒ½å¾—åˆ°åˆ—è¡¨ç±»å‹çš„ç»“æœ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">df = pd.read_csv(<span class="string">&#x27;data.csv&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> index, row <span class="keyword">in</span> df.iterrows():</span><br><span class="line">  print(row.tolist())</span><br></pre></td></tr></table></figure>





<h4 id="å…³ç³»å‹æ•°æ®åº“å­˜å‚¨"><a href="#å…³ç³»å‹æ•°æ®åº“å­˜å‚¨" class="headerlink" title="å…³ç³»å‹æ•°æ®åº“å­˜å‚¨"></a>å…³ç³»å‹æ•°æ®åº“å­˜å‚¨</h4><p>åŸºäºå…³ç³»æ¨¡å‹çš„æ•°æ®åº“ï¼Œå…³ç³»æ¨¡å‹æ˜¯é€šè¿‡äºŒç»´è¡¨æ¥ä¿å­˜çš„ï¼Œå­˜å‚¨æ–¹å¼æ˜¯è¡Œåˆ—ç»„æˆçš„è¡¨</p>
<h4 id="4-4-MySQL-å­˜å‚¨"><a href="#4-4-MySQL-å­˜å‚¨" class="headerlink" title="4.4 MySQL å­˜å‚¨"></a>4.4 MySQL å­˜å‚¨</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line">db = pymysql.connect(host=<span class="string">&#x27;localhost&#x27;</span>,user=<span class="string">&#x27;root&#x27;</span>,password=<span class="string">&#x27;12345678&#x27;</span>,port=<span class="number">3306</span>)</span><br><span class="line">cursor = db.cursor()</span><br><span class="line">cursor.execute(<span class="string">&#x27;SELECT VERSION()&#x27;</span>)</span><br><span class="line">data = cursor.fetchone() //è·å–ç¬¬ä¸€æ¡æ•°æ®</span><br><span class="line">print(<span class="string">&#x27;Database version:&#x27;</span>, data)</span><br><span class="line">cursor.execute(<span class="string">&#x27;CREATE DATABASE spiders DEFAULT CHARACTER SET utf8&#x27;</span>)</span><br><span class="line">db.close()</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ PyMySQL çš„ connect() æ–¹æ³•å£°æ˜ä¸€ä¸ª MySQL è¿æ¥å¯¹è±¡ dbï¼Œç«¯å£é»˜è®¤ 3306</p>
<p>è¿æ¥æˆåŠŸåéœ€è¦è°ƒç”¨ cursor è·å¾— MySQL çš„æ“ä½œæ¸¸æ ‡ï¼Œåˆ©ç”¨æ¸¸æ ‡æ¥æ‰§è¡Œ SQLè¯­å¥ï¼Œç›´æ¥ç”¨ execute() æ–¹æ³•æ¥æ‰§è¡Œ</p>
<p>fetchone æ–¹æ³•æ¥è·å¾—ç¬¬ä¸€æ¡æ•°æ®</p>
<p>ç¬¬äºŒå¥åˆ›å»ºæ•°æ®åº“çš„æ“ä½œï¼Œæ•°æ®åº“å spidersï¼Œé»˜è®¤ç¼–ç  UTF-8</p>
<p>ç»ˆç«¯ç™»å½•æ•°æ®åº“ mysql -uroot -p</p>
<p>show databases; æŸ¥è¯¢åˆ›å»ºæˆåŠŸçš„æ•°æ®åº“</p>
<h5 id="åˆ›å»ºè¡¨"><a href="#åˆ›å»ºè¡¨" class="headerlink" title="åˆ›å»ºè¡¨"></a>åˆ›å»ºè¡¨</h5><p>åˆ›å»ºäº†æ•°æ®åº“åï¼Œè¿æ¥æ—¶éœ€è¦é¢å¤–å‚æ•° db</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db = pymysql.connect(host=<span class="string">&#x27;localhost&#x27;</span>,user=<span class="string">&#x27;root&#x27;</span>,password=<span class="string">&#x27;12345678&#x27;</span>,port=<span class="number">3306</span>,db=<span class="string">&#x27;spiders&#x27;</span>)</span><br><span class="line">cursor = db.cursor()</span><br><span class="line">sql = <span class="string">&#x27;CREATE TABLE IF NOT EXISTS students (id VARCHAR(255) NOT NULL, name VARCHAR(255) NOT NULL, age INT NOT NULL, PRIMARY KEY (id))&#x27;</span></span><br><span class="line">cursor.execute(sql)</span><br><span class="line">db.close()</span><br></pre></td></tr></table></figure>

<h5 id="æ’å…¥æ•°æ®"><a href="#æ’å…¥æ•°æ®" class="headerlink" title="æ’å…¥æ•°æ®"></a>æ’å…¥æ•°æ®</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">id</span> = <span class="string">&#x27;20120001&#x27;</span></span><br><span class="line">user = <span class="string">&#x27;Bob&#x27;</span></span><br><span class="line">age = <span class="number">20</span></span><br><span class="line">db = pymysql.connect(host=<span class="string">&#x27;localhost&#x27;</span>,user=<span class="string">&#x27;root&#x27;</span>,password=<span class="string">&#x27;12345678&#x27;</span>,port=<span class="number">3306</span>,db=<span class="string">&#x27;spiders&#x27;</span>)</span><br><span class="line">cursor = db.cursor()</span><br><span class="line">sql = <span class="string">&#x27;INSERT INTO students(id, name, age) values(%s, %s, %s)&#x27;</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    cursor.execute(sql, (<span class="built_in">id</span>, user, age))</span><br><span class="line">    db.commit()<span class="comment">#æ’å…¥ã€æ›´æ–°ã€åˆ é™¤ éƒ½éœ€è¦commit</span></span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    db.rollback()<span class="comment">#æ‰§è¡Œå¤±è´¥å›æ»š</span></span><br><span class="line">db.close()</span><br></pre></td></tr></table></figure>

<p>ä¼˜åŒ–æ’å…¥æ–¹æ³•</p>
<p>å®ç°ä¼ å…¥ä¸€ä¸ªå­—å…¸æ¥æ’å…¥æ•°æ®çš„æ–¹æ³•ï¼Œè¿™æ ·å¢åŠ å­—æ®µåå°±ä¸éœ€è¦å»ä¿®æ”¹SQLè¯­å¥å’Œæ’å…¥æ“ä½œ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">db = pymysql.connect(host=<span class="string">&#x27;localhost&#x27;</span>, user=<span class="string">&#x27;root&#x27;</span>, password=<span class="string">&#x27;12345678&#x27;</span>, port=<span class="number">3306</span>, db=<span class="string">&#x27;spiders&#x27;</span>)</span><br><span class="line">cursor = db.cursor()</span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;20120003&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Bob1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;age&#x27;</span>: <span class="number">20</span></span><br><span class="line">&#125;</span><br><span class="line">table = <span class="string">&#x27;students&#x27;</span></span><br><span class="line">keys = <span class="string">&#x27;,&#x27;</span>.join(data.keys()) <span class="comment">#id,user,age</span></span><br><span class="line">values = <span class="string">&#x27;,&#x27;</span>.join([<span class="string">&#x27;%s&#x27;</span>] * <span class="built_in">len</span>(data))</span><br><span class="line">sql = <span class="string">f&#x27;INSERT INTO <span class="subst">&#123;table&#125;</span>(<span class="subst">&#123;keys&#125;</span>) VALUES(<span class="subst">&#123;values&#125;</span>)&#x27;</span>.<span class="built_in">format</span>(table=table, keys=keys, values=values)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">if</span> cursor.execute(sql, <span class="built_in">tuple</span>(data.values())):</span><br><span class="line">        print(<span class="string">&#x27;Success&#x27;</span>)</span><br><span class="line">        db.commit()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    db.rollback()</span><br><span class="line">    print(<span class="string">&#x27;Failed&#x27;</span>)</span><br><span class="line">db.close()</span><br></pre></td></tr></table></figure>

<h5 id="æ›´æ–°æ•°æ®"><a href="#æ›´æ–°æ•°æ®" class="headerlink" title="æ›´æ–°æ•°æ®"></a>æ›´æ–°æ•°æ®</h5><p>å¦‚æœæ•°æ®å­˜åœ¨ï¼Œåˆ™æ›´æ–°æ•°æ®ï¼Œå¦‚æœæ•°æ®ä¸å­˜åœ¨ï¼Œåˆ™æ’å…¥æ•°æ®</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">db = pymysql.connect(host=<span class="string">&#x27;localhost&#x27;</span>, user=<span class="string">&#x27;root&#x27;</span>, password=<span class="string">&#x27;12345678&#x27;</span>, port=<span class="number">3306</span>, db=<span class="string">&#x27;spiders&#x27;</span>)</span><br><span class="line">cursor = db.cursor()</span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;20120003&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Bob1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;age&#x27;</span>: <span class="number">24</span></span><br><span class="line">&#125;</span><br><span class="line">table = <span class="string">&#x27;students&#x27;</span></span><br><span class="line">keys = <span class="string">&#x27;,&#x27;</span>.join(data.keys()) <span class="comment">#id,user,age</span></span><br><span class="line">values = <span class="string">&#x27;,&#x27;</span>.join([<span class="string">&#x27;%s&#x27;</span>] * <span class="built_in">len</span>(data))</span><br><span class="line">sql = <span class="string">f&#x27;INSERT INTO <span class="subst">&#123;table&#125;</span>(<span class="subst">&#123;keys&#125;</span>) VALUES (<span class="subst">&#123;values&#125;</span>) ON DUPLICATE KEY UPDATE&#x27;</span>.<span class="built_in">format</span>(table=table,keys=keys,values=values)</span><br><span class="line">update = <span class="string">&#x27;,&#x27;</span>.join([<span class="string">&quot; &#123;key&#125; = %s&quot;</span>.<span class="built_in">format</span>(key = key) <span class="keyword">for</span> key <span class="keyword">in</span> data])</span><br><span class="line">sql+=update</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">if</span> cursor.execute(sql, <span class="built_in">tuple</span>(data.values())*<span class="number">2</span>):</span><br><span class="line">        print(<span class="string">&#x27;Success&#x27;</span>)</span><br><span class="line">        db.commit()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    db.rollback()</span><br><span class="line">    print(<span class="string">&#x27;Failed&#x27;</span>)</span><br><span class="line">db.close()</span><br><span class="line"><span class="comment">#INSERT INTO students(id,name,age) VALUES (%s,%s,%s) ON DUPLICATE KEY UPDATEid = %s,name = %s,age = %s</span></span><br></pre></td></tr></table></figure>

<p>ON DUPLICATE KEY UPDATE ä¸»é”®å·²å­˜åœ¨å°±æ‰§è¡Œæ›´æ–°æ“ä½œ</p>
<h5 id="åˆ é™¤æ•°æ®"><a href="#åˆ é™¤æ•°æ®" class="headerlink" title="åˆ é™¤æ•°æ®"></a>åˆ é™¤æ•°æ®</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db = pymysql.connect(host=<span class="string">&#x27;localhost&#x27;</span>, user=<span class="string">&#x27;root&#x27;</span>, password=<span class="string">&#x27;12345678&#x27;</span>, port=<span class="number">3306</span>, db=<span class="string">&#x27;spiders&#x27;</span>)</span><br><span class="line">cursor = db.cursor()</span><br><span class="line">table = <span class="string">&#x27;students&#x27;</span></span><br><span class="line">condition = <span class="string">&#x27;age &gt; 22&#x27;</span></span><br><span class="line">sql = <span class="string">f&#x27;DELETE FROM <span class="subst">&#123;table&#125;</span> WHERE <span class="subst">&#123;condition&#125;</span>&#x27;</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    cursor.execute(sql)</span><br><span class="line">    db.commit()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    db.rollback()</span><br><span class="line">db.close()</span><br></pre></td></tr></table></figure>

<h5 id="æŸ¥è¯¢æ•°æ®"><a href="#æŸ¥è¯¢æ•°æ®" class="headerlink" title="æŸ¥è¯¢æ•°æ®"></a>æŸ¥è¯¢æ•°æ®</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">db = pymysql.connect(host=<span class="string">&#x27;localhost&#x27;</span>, user=<span class="string">&#x27;root&#x27;</span>, password=<span class="string">&#x27;12345678&#x27;</span>, port=<span class="number">3306</span>, db=<span class="string">&#x27;spiders&#x27;</span>)</span><br><span class="line">cursor = db.cursor()</span><br><span class="line">sql = <span class="string">&#x27;SELECT * FROM students WHERE age &gt; 18&#x27;</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    cursor.execute(sql)</span><br><span class="line">    print(<span class="string">&#x27;Count:&#x27;</span>, cursor.rowcount) <span class="comment">#æŸ¥è¯¢ç»“æœæ¡æ•° æ€»å…±2æ¡</span></span><br><span class="line">    one = cursor.fetchone() </span><br><span class="line">    print(<span class="string">&#x27;One:&#x27;</span>, one) <span class="comment">#è·å–ç»“æœç¬¬ä¸€æ¡</span></span><br><span class="line">    results = cursor.fetchall() <span class="comment">#è·å–åˆ°å‰©ä¸‹çš„1æ¡ æŒ‰æŒ‡é’ˆåç§»æŸ¥æ‰¾çš„ fetchone å·²å–äº†ä¸€æ¡</span></span><br><span class="line">    print(<span class="string">&#x27;Result Type:&#x27;</span>, <span class="built_in">type</span>(results))</span><br><span class="line">    print(<span class="string">&#x27;Results:&#x27;</span>, results)</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> results:</span><br><span class="line">        print(row)</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    db.rollback()</span><br><span class="line">db.close()</span><br><span class="line"><span class="comment">#ç»“æœ</span></span><br><span class="line">Count: <span class="number">2</span></span><br><span class="line">One: (<span class="string">&#x27;20120001&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>, <span class="number">20</span>)</span><br><span class="line">Result Type: &lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">tuple</span>&#x27;&gt;</span></span><br><span class="line"><span class="class"><span class="title">Results</span>:</span> ((<span class="string">&#x27;20120002&#x27;</span>, <span class="string">&#x27;Jack&#x27;</span>, <span class="number">22</span>),)</span><br><span class="line">(<span class="string">&#x27;20120002&#x27;</span>, <span class="string">&#x27;Jack&#x27;</span>, <span class="number">22</span>)</span><br></pre></td></tr></table></figure>

<p>è¿˜å¯ä»¥ç”¨ while å¾ªç¯åŠ  fetchone æ–¹æ³•è·å–æ‰€æœ‰æ•°æ®</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">row = cursor.fetchone()</span><br><span class="line"><span class="keyword">while</span> row:</span><br><span class="line">  print(<span class="string">&#x27;Row:&#x27;</span>, row)</span><br><span class="line">  row = cursor.fetchone()<span class="comment">#æ¯å¾ªç¯ä¸€æ¬¡ æŒ‡é’ˆå°±ä¼šåç§»ä¸€æ¡æ•°æ®</span></span><br></pre></td></tr></table></figure>

<h4 id="éå…³ç³»å‹æ•°æ®åº“"><a href="#éå…³ç³»å‹æ•°æ®åº“" class="headerlink" title="éå…³ç³»å‹æ•°æ®åº“"></a>éå…³ç³»å‹æ•°æ®åº“</h4><p>åŸºäºé”®å€¼å¯¹çš„ï¼Œæ•°æ®ä¹‹é—´æ²¡æœ‰è€¦åˆæ€§ï¼Œæ€§èƒ½é«˜</p>
<p>æ–‡æ¡£å‹æ•°æ®åº“ï¼šMongoDB</p>
<p>é”®å€¼å­˜å‚¨æ•°æ®åº“ï¼šRedisã€Oracle BDB</p>
<h4 id="4-5-MongoDB-å­˜å‚¨"><a href="#4-5-MongoDB-å­˜å‚¨" class="headerlink" title="4.5 MongoDB å­˜å‚¨"></a>4.5 MongoDB å­˜å‚¨</h4><p>åŸºäºåˆ†å¸ƒå¼æ–‡ä»¶å­˜å‚¨çš„å¼€æºæ•°æ®åº“ç³»ç»Ÿï¼Œå†…å®¹å­˜å‚¨å½¢å¼ç±»ä¼¼ JSON å¯¹è±¡ï¼Œå­—æ®µå€¼å¯ä»¥åŒ…å«å…¶å®ƒæ–‡æ¡£ã€æ•°ç»„åŠæ–‡æ¡£æ•°ç»„</p>
<h5 id="è¿æ¥-MongoDB"><a href="#è¿æ¥-MongoDB" class="headerlink" title="è¿æ¥ MongoDB"></a>è¿æ¥ MongoDB</h5><p>ä½¿ç”¨ PyMongo åº“é‡Œçš„ MongoClientï¼Œç¬¬ä¸€ä¸ªå‚æ•°åœ°å€ hostï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºç«¯å£é»˜è®¤27017</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymongo</span><br><span class="line">client = pymongo.MongoClient(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">27017</span>)</span><br><span class="line"><span class="comment">#ç¬¬ä¸€ä¸ªå‚æ•°hostè¿˜å¯ä¼ å…¥MongoDBçš„è¿æ¥å­—ç¬¦ä¸²ï¼Œä»¥mongodbå¼€å¤´</span></span><br><span class="line">client = MongoClient(<span class="string">&#x27;mongodb://localhost:27017/&#x27;</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymongo <span class="keyword">import</span> MongoClient</span><br><span class="line">client = MongoClient(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">27017</span>)</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å°±åˆ›å»º MongoDB çš„è¿æ¥å¯¹è±¡äº†</p>
<h5 id="æŒ‡å®šæ•°æ®åº“"><a href="#æŒ‡å®šæ•°æ®åº“" class="headerlink" title="æŒ‡å®šæ•°æ®åº“"></a>æŒ‡å®šæ•°æ®åº“</h5><p>æŒ‡å®šæ“ä½œå“ªä¸ªæ•°æ®åº“</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db = client.test <span class="comment">#è°ƒç”¨clientçš„testå³å¯è¿”å›testæ•°æ®åº“</span></span><br><span class="line"><span class="comment">#ä¹Ÿå¯ä»¥</span></span><br><span class="line">db = client[<span class="string">&#x27;test&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h5 id="æŒ‡å®šé›†åˆ"><a href="#æŒ‡å®šé›†åˆ" class="headerlink" title="æŒ‡å®šé›†åˆ"></a>æŒ‡å®šé›†åˆ</h5><p>MongoDBçš„æ¯ä¸ªæ•°æ®åº“åˆåŒ…å«è®¸å¤šé›†åˆï¼Œç±»ä¼¼å…³ç³»å‹æ•°æ®åº“ä¸­çš„è¡¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">collection &#x3D; db.students</span><br><span class="line">collection &#x3D; db[&#39;students&#39;]</span><br></pre></td></tr></table></figure>

<h5 id="æ’å…¥æ•°æ®-1"><a href="#æ’å…¥æ•°æ®-1" class="headerlink" title="æ’å…¥æ•°æ®"></a>æ’å…¥æ•°æ®</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">student1 = &#123;</span><br><span class="line">    <span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;2017002&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Bob2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;age&#x27;</span>: <span class="number">20</span>,</span><br><span class="line">    <span class="string">&#x27;gender&#x27;</span>: <span class="string">&#x27;male&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">student2 = &#123;</span><br><span class="line">    <span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;2017003&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Bob3&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;age&#x27;</span>: <span class="number">20</span>,</span><br><span class="line">    <span class="string">&#x27;gender&#x27;</span>: <span class="string">&#x27;male&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">client = pymongo.MongoClient(host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">27017</span>)</span><br><span class="line">db = client.tests</span><br><span class="line">collection = db.students</span><br><span class="line">result = collection.insert_one(student1) <span class="comment">#å•æ¡æ’å…¥</span></span><br><span class="line">result = collection.insert_many([student1, student2]) <span class="comment">#å¤šæ¡æ’å…¥</span></span><br><span class="line">print(result)</span><br><span class="line">print(result.inserted_ids)</span><br></pre></td></tr></table></figure>

<p>MongoDB ä¸­æ¯æ¡æ•°æ®éƒ½æœ‰ä¸€ä¸ª _id å±æ€§ä½œä¸ºå”¯ä¸€æ ‡è¯†ï¼Œå¦‚æœæ²¡æœ‰æ˜¾å¼æŒ‡æ˜è¯¥å±æ€§ï¼Œé‚£ä¹ˆ MongoDB ä¼šè‡ªåŠ¨äº§ç”Ÿä¸€ä¸ª ObjectId ç±»å‹çš„ _id å±æ€§</p>
<h5 id="æŸ¥è¯¢"><a href="#æŸ¥è¯¢" class="headerlink" title="æŸ¥è¯¢"></a>æŸ¥è¯¢</h5><p>find_one()</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">result = collection.find_one(&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Bob&#x27;</span>&#125;) <span class="comment">#æŸ¥è¯¢nameä¸ºBobçš„æ•°æ®</span></span><br><span class="line">print(result)</span><br><span class="line"><span class="comment">#ç»“æœ</span></span><br><span class="line">&#123;<span class="string">&#x27;_id&#x27;</span>: ObjectId(<span class="string">&#x27;62554aac23dcb7329838bd6b&#x27;</span>), <span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;2017001&#x27;</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Bob&#x27;</span>, <span class="string">&#x27;age&#x27;</span>: <span class="number">20</span>, <span class="string">&#x27;gender&#x27;</span>: <span class="string">&#x27;male&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>å¤šäº†ä¸ª_idå±æ€§ ï¼Œä¹Ÿå¯è·Ÿè¿› ObjectIdæ¥æŸ¥è¯¢ï¼Œå¦‚æœæŸ¥è¯¢ç»“æœä¸å­˜åœ¨è¿”å› None</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bson.objectid <span class="keyword">import</span> ObjectId</span><br><span class="line">result = collection.find_one(&#123;<span class="string">&#x27;_id&#x27;</span>: ObjectId(<span class="string">&#x27;62554aac23dcb7329838bd6b&#x27;</span>)&#125;)</span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>

<p>find()</p>
<p>å¤šæ¡æ•°æ®æŸ¥è¯¢ find() è¿”å›ä¸€ä¸ªç”Ÿæˆå™¨</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">result = collection.find(&#123;<span class="string">&#x27;age&#x27;</span>: <span class="number">20</span>&#125;)<span class="comment">#æŸ¥è¯¢å¹´é¾„20æ•°æ®</span></span><br><span class="line">result = collection.find(&#123;<span class="string">&#x27;age&#x27;</span>: &#123;<span class="string">&#x27;$gt&#x27;</span>: <span class="number">20</span>&#125;&#125;) <span class="comment">#å¹´é¾„å¤§äº20æ•°æ®</span></span><br></pre></td></tr></table></figure>

<ul>
<li>æ¯”è¾ƒç¬¦å·</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$lt å°äº $gtå¤§äº $lteå°äºç­‰äº $gteå¤§äºç­‰äº $neä¸ç­‰äº $in åœ¨èŒƒå›´å†… $nin ä¸åœ¨èŒƒå›´å†…</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&#x27;age&#x27;</span>: &#123;<span class="string">&#x27;$in&#x27;</span>: [<span class="number">20</span>, <span class="number">33</span>]&#125;&#125;</span><br><span class="line">&#123;<span class="string">&#x27;age&#x27;</span>: &#123;<span class="string">&#x27;$nin&#x27;</span>: [<span class="number">20</span>, <span class="number">33</span>]&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>è¿˜å¯è¿›è¡Œæ­£åˆ™åŒ¹é…æŸ¥è¯¢ï¼Œå¦‚ ä»¥Må¼€å¤´çš„å­¦ç”Ÿæ•°æ®</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = connection.find(&#123;<span class="string">&#x27;name&#x27;</span>: &#123;<span class="string">&#x27;$regex&#x27;</span>: <span class="string">&#x27;^M.*&#x27;</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#$regex åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼ </span></span><br><span class="line">&#123;<span class="string">&#x27;name&#x27;</span>: &#123;<span class="string">&#x27;$regex&#x27;</span>: <span class="string">&#x27;^M.*&#x27;</span>&#125;&#125;</span><br><span class="line"><span class="comment">#$exists å±æ€§æ˜¯å¦å­˜åœ¨ </span></span><br><span class="line">&#123;<span class="string">&#x27;name&#x27;</span>: &#123;<span class="string">&#x27;$exists&#x27;</span>: <span class="string">&#x27;True&#x27;</span>&#125;&#125;</span><br><span class="line"><span class="comment">#$type ç±»å‹åˆ¤æ–­</span></span><br><span class="line">&#123;<span class="string">&#x27;name&#x27;</span>: &#123;<span class="string">&#x27;$type&#x27;</span>: <span class="string">&#x27;int&#x27;</span>&#125;&#125;</span><br><span class="line"><span class="comment">#$mod æ•°å­—æ¨¡æ“ä½œ</span></span><br><span class="line">&#123;<span class="string">&#x27;name&#x27;</span>: &#123;<span class="string">&#x27;$mod&#x27;</span>: [<span class="number">5</span>, <span class="number">0</span>]&#125;&#125;</span><br><span class="line"><span class="comment">#$text æ–‡æœ¬æŸ¥è¯¢</span></span><br><span class="line">&#123;<span class="string">&#x27;name&#x27;</span>: &#123;<span class="string">&#x27;$text&#x27;</span>: <span class="string">&#x27;Mike&#x27;</span>&#125;&#125; <span class="comment">#textç±»å‹çš„å±æ€§ä¸­åŒ…å«Mikeå­—ç¬¦ä¸²</span></span><br><span class="line"><span class="comment">#$where é«˜çº§æ¡ä»¶æŸ¥è¯¢ </span></span><br><span class="line">&#123;<span class="string">&#x27;name&#x27;</span>: &#123;<span class="string">&#x27;$where&#x27;</span>: <span class="string">&#x27;^M.*&#x27;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>æ›´è¯¦ç»† <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/operator/query">https://docs.mongodb.com/manual/reference/operator/query</a></p>
<h5 id="è®¡æ•°"><a href="#è®¡æ•°" class="headerlink" title="è®¡æ•°"></a>è®¡æ•°</h5><p>ç»Ÿè®¡æŸ¥è¯¢ç»“æœæœ‰å¤šå°‘æ¡ï¼Œcount()</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">count = collection.find().count()</span><br><span class="line"><span class="comment">#æˆ–è€…ç»Ÿè®¡ç¬¦åˆæŸä¸ªæ¡ä»¶çš„æ•°æ®</span></span><br><span class="line">count = collection.find(&#123;<span class="string">&#x27;age&#x27;</span>: <span class="number">20</span>&#125;).count</span><br></pre></td></tr></table></figure>

<h5 id="æ’åº"><a href="#æ’åº" class="headerlink" title="æ’åº"></a>æ’åº</h5><p>sort() æ–¹æ³•ï¼Œå…¶ä¸­ä¼ å…¥æ’åºçš„å­—æ®µåŠå‡é™åºæ ‡å¿—å³å¯</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">results = collection.find().sort(<span class="string">&#x27;name&#x27;</span>, pymongo.ASCENDING)</span><br><span class="line">print([result[<span class="string">&#x27;name&#x27;</span>] <span class="keyword">for</span> result <span class="keyword">in</span> results])</span><br><span class="line"><span class="comment">#é™åº pymongo.DESCENDING</span></span><br></pre></td></tr></table></figure>

<h5 id="åç§»"><a href="#åç§»" class="headerlink" title="åç§»"></a>åç§»</h5><p>åªæƒ³å–æŸå‡ ä¸ªå…ƒç´ ï¼Œåˆ©ç”¨ skip() æ–¹æ³•åç§»å‡ ä¸ªä½ç½®ï¼Œæ¯”å¦‚åç§» 2 å°±å¿½ç•¥å‰ä¸¤ä¸ªå…ƒç´ ï¼Œå¾—åˆ°ç¬¬3ä¸ªå…ƒç´ </p>
<p>è¿˜å¯åˆ©ç”¨ limit() æ–¹æ³•é™åˆ¶è¿”å›ä¸ªæ•°</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">results = collection.find().sort(<span class="string">&#x27;name&#x27;</span>, pymongo.ASCENDING).skip(<span class="number">2</span>)</span><br><span class="line">results = collection.find().sort(<span class="string">&#x27;name&#x27;</span>, pymongo.ASCENDING).skip(<span class="number">2</span>).limit(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<h5 id="æ›´æ–°"><a href="#æ›´æ–°" class="headerlink" title="æ›´æ–°"></a>æ›´æ–°</h5><p>update() æ–¹æ³•ï¼ŒæŒ‡å®šæ›´æ–°çš„æ¡ä»¶å’Œæ›´æ–°åçš„æ•°æ®å³å¯</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">collection = &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Kevin&#x27;</span>&#125;</span><br><span class="line">student = collection.find_one(condition)</span><br><span class="line">student[<span class="string">&#x27;age&#x27;</span>] = <span class="number">25</span></span><br><span class="line">result = collection.update(collection, student)</span><br><span class="line">print(result) <span class="comment">#&#123;&#x27;ok&#x27;:1,&#x27;nModified&#x27;: 1,&#x27;n&#x27;:1,&#x27;updateExisting&#x27;: True&#125;</span></span><br><span class="line"><span class="comment">#å…ˆå°†æ•°æ®æŸ¥è¯¢å‡ºæ¥ï¼Œä¿®æ”¹å¹´é¾„ï¼Œè°ƒç”¨updateæ›´æ–°</span></span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ç”¨ $set æ“ä½œç¬¦æ›´æ–°</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = collection.update(condition, &#123;<span class="string">&#x27;$set&#x27;</span>: student&#125;)</span><br></pre></td></tr></table></figure>

<p>å®˜æ–¹æ¨èä½¿ç”¨ update_noe å’Œ update_many æ–¹æ³•å¤„ç†å•æ¡å’Œå¤šæ¡æ•°æ®æ›´æ–°ï¼Œç¬¬äºŒä¸ªå‚æ•°éœ€è¦ä¼  <code>&#123;&#39;$set&#39;: student&#125;</code> å½¢å¼æ•°æ®</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">result = collection.update_one(condition, &#123;<span class="string">&#x27;$set&#x27;</span>: student&#125;)</span><br><span class="line">print(result.matched_count, result.modified_count) </span><br></pre></td></tr></table></figure>

<p>æŒ‡å®šæŸ¥è¯¢æ¡ä»¶ä¸ºageå¤§äº20ï¼Œæ›´æ–°æ¡ä»¶æ˜¯ageåŠ 1ï¼Œå°±æ˜¯å¯¹ç¬¬ä¸€æ¡ç¬¦åˆæ¡ä»¶çš„å­¦ç”Ÿæ•°æ®ageåŠ 1</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">condition = &#123;<span class="string">&#x27;age&#x27;</span>: &#123;<span class="string">&#x27;$gt&#x27;</span>:<span class="number">20</span>&#125;&#125;</span><br><span class="line">result = collection.update_one(condition, &#123;<span class="string">&#x27;$inc&#x27;</span>: &#123;<span class="string">&#x27;age&#x27;</span>:<span class="number">1</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>upsert å‚æ•°</li>
</ul>
<p>upsert è®¾ç½® Trueï¼Œå°±å¯ä»¥å®ç°å­˜åœ¨å³æ›´æ–°ï¼Œä¸å­˜åœ¨å³æ’å…¥çš„åŠŸèƒ½ï¼Œæ›´æ–°æ—¶ä¼šå‚ç…§ç¬¬ä¸€ä¸ªå‚æ•°è®¾ç½®çš„ name å­—æ®µ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">save_data</span>(<span class="params">data</span>):</span></span><br><span class="line">	collection.update_one(&#123;</span><br><span class="line">		<span class="string">&#x27;name&#x27;</span>: data.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">	&#125;,&#123;<span class="string">&#x27;$set&#x27;</span>: data&#125;, upsert: <span class="literal">True</span>)</span><br></pre></td></tr></table></figure>



<h5 id="åˆ é™¤"><a href="#åˆ é™¤" class="headerlink" title="åˆ é™¤"></a>åˆ é™¤</h5><p>delete_one()ã€ delete_many()</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">result = collection.delete_one(&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Kevin&#x27;</span>&#125;)</span><br><span class="line">result = collection.delete_many(<span class="string">&#x27;age&#x27;</span>: &#123;<span class="string">&#x27;$lt&#x27;</span>: <span class="number">25</span>&#125;)</span><br><span class="line">print(result.delete_count) <span class="comment">#åˆ é™¤æ•°æ®æ¡æ•°</span></span><br></pre></td></tr></table></figure>

<h5 id="å…¶å®ƒæ“ä½œ"><a href="#å…¶å®ƒæ“ä½œ" class="headerlink" title="å…¶å®ƒæ“ä½œ"></a>å…¶å®ƒæ“ä½œ</h5><p>find_one_and_deleteã€find_one_and_replaceã€find_one_and_update</p>
<h5 id="å¼‚æ­¥å­˜å‚¨"><a href="#å¼‚æ­¥å­˜å‚¨" class="headerlink" title="å¼‚æ­¥å­˜å‚¨"></a>å¼‚æ­¥å­˜å‚¨</h5><p>è¦å®ç° MongoDB å¼‚æ­¥å­˜å‚¨ï¼Œç¦»ä¸å¼€å¼‚æ­¥å®ç°çš„ MongoDB å­˜å‚¨åº“ motor</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install motor</span><br></pre></td></tr></table></figure>

<p>motor çš„è¿æ¥å£°æ˜å’Œ pymongo ç±»ä¼¼</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> motor.motor_asyncio <span class="keyword">import</span> AsyncIOMotorClient</span><br><span class="line">MONGO_CONNECTION_STRING = <span class="string">&#x27;mongodb://localhost:27017&#x27;</span></span><br><span class="line">MONGO_DB_NAME = <span class="string">&#x27;books&#x27;</span></span><br><span class="line">MONGO_COLLECTION_NAME = <span class="string">&#x27;books&#x27;</span></span><br><span class="line"></span><br><span class="line">client = AsyncIOMotorClient(MONGO_CONNECTION_STRING)</span><br><span class="line">db = client[MONGO_DB_NAME]</span><br><span class="line">collection = db[MONGO_COLLECTION_NAME]</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">save_data</span>(<span class="params">data</span>):</span></span><br><span class="line">  <span class="keyword">if</span> data:</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> collection.update_one(&#123;</span><br><span class="line">      <span class="string">&#x27;id&#x27;</span>: data.get(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">    &#125;,&#123;</span><br><span class="line">      <span class="string">&#x27;$set&#x27;</span>: data</span><br><span class="line">    &#125;, upsert=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>



<h4 id="4-6-Redis-å­˜å‚¨"><a href="#4-6-Redis-å­˜å‚¨" class="headerlink" title="4.6 Redis å­˜å‚¨"></a>4.6 Redis å­˜å‚¨</h4><p>åŸºäºå†…å­˜çš„é«˜æ•ˆçš„é”®å€¼å‹éå…³ç³»å‹æ•°æ®åº“</p>
<p>redis-py åº“æä¾›ä¸¤ä¸ªç±» Redis å’Œ StrictRedis æ¥å®ç° Redis çš„å‘½ä»¤æ“ä½œ</p>
<p>å®˜æ–¹æ¨èä½¿ç”¨ StrictRedis</p>
<h5 id="è¿æ¥Redis"><a href="#è¿æ¥Redis" class="headerlink" title="è¿æ¥Redis"></a>è¿æ¥Redis</h5><p>å…ˆåœ¨æœ¬åœ°å®‰è£…å¥½ Redisï¼Œå¹¶è¿è¡Œåœ¨6379ç«¯å£</p>
<p>å¯åŠ¨æœåŠ¡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server</span><br></pre></td></tr></table></figure>

<p>è¿æ¥Rediså¹¶æµ‹è¯•</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> StrictRedis</span><br><span class="line"><span class="comment">#ä¸ä¼ çš„è¯è¿™å°±æ˜¯4ä¸ªé»˜è®¤å‚æ•°</span></span><br><span class="line">redis = StrictRedis(host=<span class="string">&#x27;localhost&#x27;</span>,port=<span class="number">6379</span>,db=<span class="number">0</span>,password=<span class="literal">None</span>)</span><br><span class="line">redis.<span class="built_in">set</span>(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;Bob&#x27;</span>)</span><br><span class="line">print(redis.get(<span class="string">&#x27;name&#x27;</span>))</span><br><span class="line"><span class="comment">#èƒ½æ‰“å° b&#x27;Bob&#x27; è¯´æ˜è¿æ¥æˆåŠŸï¼Œå¹¶å¯æ‰§è¡Œset()å’Œget()æ“ä½œäº†</span></span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ç”¨ConnectionPoolæ¥æµ‹è¯•</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> redis <span class="keyword">import</span> StrictRedis,ConnectionPool</span><br><span class="line">pool = ConnectionPool(host=<span class="string">&#x27;localhost&#x27;</span>,port=<span class="number">6379</span>,db=<span class="number">0</span>,password=<span class="literal">None</span>)</span><br><span class="line">redis = StrictRedis(connection_pool=pool)</span><br><span class="line"><span class="comment">#å…¬ç½‘è®¿é—®</span></span><br><span class="line">pool = ConnectionPool(host=<span class="string">&#x27;120.79.222.153&#x27;</span>,port=<span class="number">6379</span>,db=<span class="number">0</span>,password=<span class="literal">None</span>)</span><br></pre></td></tr></table></figure>

<p>ConnectionPool è¿˜æ”¯æŒé€šè¿‡ URL æ¥æ„å»º</p>
<p>URL æ”¯æŒçš„æ ¼å¼æœ‰3ç§</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#åˆ›å»ºRedis TCPè¿æ¥ Redis+SSLè¿æ¥ Redis UNIX socketè¿æ¥</span></span><br><span class="line">redis://[:password]@host:port/db </span><br><span class="line">rediss://[:password]@host:port/db</span><br><span class="line">unix://[:password]@/path/to/socket.sock?db=db</span><br></pre></td></tr></table></figure>

<p>password éƒ¨åˆ†æœ‰åˆ™å¯ä»¥å†™ï¼Œæ²¡æœ‰å¯ä»¥çœç•¥</p>
<p>ä½¿ç”¨ç¬¬ä¸€ç§è¿æ¥å­—ç¬¦ä¸²è¿›è¡Œè¿æ¥</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">url = <span class="string">&#x27;redis://@localhost:6379/0&#x27;</span></span><br><span class="line">pool = ConnectionPool.from_url(url)</span><br><span class="line">redis = StrictRedis(connection_pool=pool)</span><br><span class="line">print(redis.get(<span class="string">&#x27;name&#x27;</span>))</span><br></pre></td></tr></table></figure>

<h5 id="é”®æ“ä½œ"><a href="#é”®æ“ä½œ" class="headerlink" title="é”®æ“ä½œ"></a>é”®æ“ä½œ</h5><p>é”®çš„ä¸€äº›åˆ¤æ–­å’Œæ“ä½œæ–¹æ³•</p>
<h5 id="å­—ç¬¦ä¸²æ“ä½œ"><a href="#å­—ç¬¦ä¸²æ“ä½œ" class="headerlink" title="å­—ç¬¦ä¸²æ“ä½œ"></a>å­—ç¬¦ä¸²æ“ä½œ</h5><p>Redisæ”¯æŒæœ€åŸºæœ¬çš„é”®å€¼å¯¹å½¢å¼å­˜å‚¨</p>
<h5 id="åˆ—è¡¨æ“ä½œ"><a href="#åˆ—è¡¨æ“ä½œ" class="headerlink" title="åˆ—è¡¨æ“ä½œ"></a>åˆ—è¡¨æ“ä½œ</h5><p>Redis è¿˜æä¾›äº†åˆ—è¡¨å­˜å‚¨ï¼Œåˆ—è¡¨å†…çš„å…ƒç´ å¯ä»¥é‡å¤ï¼Œè€Œä¸”å¯ä»¥ä»ä¸¤ç«¯å­˜å‚¨</p>
<h5 id="é›†åˆæ“ä½œ"><a href="#é›†åˆæ“ä½œ" class="headerlink" title="é›†åˆæ“ä½œ"></a>é›†åˆæ“ä½œ</h5><p>è¿˜æä¾›äº†é›†åˆå­˜å‚¨ï¼Œé›†åˆä¸­çš„å…ƒç´ éƒ½æ˜¯ä¸é‡å¤çš„</p>
<h5 id="æœ‰åºé›†åˆæ“ä½œ"><a href="#æœ‰åºé›†åˆæ“ä½œ" class="headerlink" title="æœ‰åºé›†åˆæ“ä½œ"></a>æœ‰åºé›†åˆæ“ä½œ</h5><p>æœ‰åºé›†åˆæ¯”é›†åˆå¤šäº†ä¸€ä¸ªåˆ†æ•°å­—æ®µï¼Œåˆ©ç”¨å®ƒå¯ä»¥å¯¹é›†åˆä¸­çš„æ•°æ®è¿›è¡Œæ’åº</p>
<h5 id="æ•£åˆ—æ“ä½œ"><a href="#æ•£åˆ—æ“ä½œ" class="headerlink" title="æ•£åˆ—æ“ä½œ"></a>æ•£åˆ—æ“ä½œ</h5><p>Redis è¿˜æä¾›äº†æ•£åˆ—è¡¨çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥ç”¨nameæŒ‡å®šä¸€ä¸ªæ•£åˆ—è¡¨çš„åç§°ï¼Œè¡¨å†…å­˜å‚¨äº†å„ä¸ªé”®å€¼å¯¹</p>
<h5 id="Redis-Dump"><a href="#Redis-Dump" class="headerlink" title="Redis Dump"></a>Redis Dump</h5><p>æä¾›äº† Redis æ•°æ®çš„å¯¼å…¥å¯¼å‡ºåŠŸèƒ½</p>
<p>redis-dump ç”¨äºå¯¼å‡ºæ•°æ®</p>
<p>redis-load ç”¨äºå¯¼å…¥æ•°æ®</p>
<h5 id="redis-dump"><a href="#redis-dump" class="headerlink" title="redis-dump"></a>redis-dump</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">redis-dump -h #æŸ¥çœ‹ç”¨æ³•</span><br><span class="line">-u #ä»£è¡¨Redisè¿æ¥å­—ç¬¦ä¸²</span><br><span class="line">-d #ä»£è¡¨æ•°æ®åº“ä»£å·</span><br><span class="line">-s #ä»£è¡¨å¯¼å‡ºä¹‹åçš„ä¼‘çœ æ—¶é—´</span><br><span class="line">-c #ä»£è¡¨åˆ†å—å¤§å° é»˜è®¤10000</span><br><span class="line">-f #ä»£è¡¨å¯¼å‡ºæ—¶çš„è¿‡æ»¤å™¨</span><br><span class="line">-0 #ä»£è¡¨ç¦ç”¨è¿è¡Œæ—¶çš„ä¼˜åŒ–</span><br><span class="line">-V #æ˜¾ç¤ºç‰ˆæœ¬</span><br><span class="line">-D #å¼€å¯è°ƒè¯•</span><br></pre></td></tr></table></figure>

<p>å¯¼å‡ºå‘½ä»¤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis-dump -u :xxpassword@localhost:6379</span><br><span class="line">#å¦‚æœæ²¡æœ‰å¯†ç </span><br><span class="line">redis-dump -u localhost:6379</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œä¹‹åå¯ä»¥å°†æœ¬åœ°0è‡³15å·æ•°æ®åº“çš„æ‰€æœ‰æ•°æ®è¾“å‡º</p>
<p>æ¯æ¡æ•°æ®åŒ…å«6ä¸ªå­—æ®µï¼Œdb æ•°æ®åº“ä»£å·ï¼Œkey é”®åï¼Œttl è¯¥é”®å€¼å¯¹çš„æœ‰æ•ˆæ—¶é—´ï¼Œtype é”®å€¼ç±»å‹ï¼Œvalue å†…å®¹ï¼Œsize å ç”¨ç©ºé—´</p>
<p>å¦‚æœæƒ³è¾“å‡º JSON æ–‡ä»¶</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-dump -u :xxpassword@localhost:6379 &gt; .&#x2F;redis_data.jl</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥ -d å‚æ•°ï¼ŒæŒ‡å®šæŸä¸ªæ•°æ®åº“å¯¼å‡º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-dump -u :xxpassword@localhost:6379 -d 1 &gt; .&#x2F;redis_data.jl</span><br></pre></td></tr></table></figure>

<p>-f å‚æ•°è¿‡æ»¤ï¼Œå¦‚æƒ³å¯¼å‡ºä»¥ adsl å¼€å¤´çš„æ•°æ®</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-dump -u :xxpassword@localhost:6379 -f adsl:* &gt; .&#x2F;redis_data.jl</span><br></pre></td></tr></table></figure>

<h5 id="redis-load"><a href="#redis-load" class="headerlink" title="redis-load"></a>redis-load</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-load --help</span><br><span class="line">-n #ä»£è¡¨ä¸æ£€æµ‹UTF-8ç¼–ç </span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å°† JSON è¡Œæ–‡ä»¶å¯¼å…¥åˆ° Redis æ•°æ®åº“</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt; redis_data.json redis-load -u :xxpassword@localhost:6379</span><br><span class="line">#æˆ–è€…</span><br><span class="line">cat redis_data.json | redis-load -u :xxpassword@localhost:6379</span><br></pre></td></tr></table></figure>



<h4 id="4-7-Elasticsearchæœç´¢å¼•æ“å­˜å‚¨"><a href="#4-7-Elasticsearchæœç´¢å¼•æ“å­˜å‚¨" class="headerlink" title="4.7 Elasticsearchæœç´¢å¼•æ“å­˜å‚¨"></a>4.7 Elasticsearchæœç´¢å¼•æ“å­˜å‚¨</h4><p>Elasticsearch æ˜¯ä¸€ä¸ªå¼€æºçš„æœç´¢å¼•æ“</p>
<h4 id="4-8-RabbitMQ"><a href="#4-8-RabbitMQ" class="headerlink" title="4.8 RabbitMQ"></a>4.8 RabbitMQ</h4><p>å¼€æºæ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼Œä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ï¼Œå®ç°è¿›ç¨‹é—´çš„é€šä¿¡</p>
<p>RabbitMQ å°±æ˜¯ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œæˆ‘ä»¬è¦å®ç°è¿›ç¨‹é—´é€šä¿¡ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹ï¼Œå³ä¸€ä¸ªè¿›ç¨‹ä½œä¸ºç”Ÿäº§è€…å¾€æ¶ˆæ¯é˜Ÿåˆ—æ”¾å…¥æ¶ˆæ¯ï¼Œä¸€ä¸ªè¿›ç¨‹ä½œä¸ºæ¶ˆè´¹è€…ç›‘å¬å¹¶å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯</p>
<p>å£°æ˜é˜Ÿåˆ—ï¼šé€šè¿‡æŒ‡å®šä¸€äº›å‚æ•°ï¼Œåˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—</p>
<p>ç”Ÿäº§å†…å®¹ï¼šç”Ÿäº§è€…æ ¹æ®é˜Ÿåˆ—çš„è¿æ¥ä¿¡æ¯è¿æ¥é˜Ÿåˆ—ï¼Œå¾€é˜Ÿåˆ—ä¸­æ”¾å…¥æ¶ˆæ¯</p>
<p>æ¶ˆè´¹å†…å®¹ï¼šæ¶ˆè´¹è€…æ ¹æ®é˜Ÿåˆ—çš„è¿æ¥ä¿¡æ¯è¿æ¥é˜Ÿåˆ—ï¼Œä»é˜Ÿåˆ—ä¸­å–å‡ºæ¶ˆæ¯</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/11/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-3%E8%A7%A3%E6%9E%90%E5%BA%93%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="ç®€å•è®°å½•ä¸‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/11/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-3%E8%A7%A3%E6%9E%90%E5%BA%93%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-3è§£æåº“ä½¿ç”¨</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-04-11 16:37:26" itemprop="dateCreated datePublished" datetime="2022-04-11T16:37:26+08:00">2022-04-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-10-09 08:57:19" itemprop="dateModified" datetime="2022-10-09T08:57:19+08:00">2022-10-09</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="3-è§£æåº“ä½¿ç”¨"><a href="#3-è§£æåº“ä½¿ç”¨" class="headerlink" title="3. è§£æåº“ä½¿ç”¨"></a>3. è§£æåº“ä½¿ç”¨</h4><h4 id="XPath"><a href="#XPath" class="headerlink" title="XPath"></a>XPath</h4><p>æ›´å¤šXPathç”¨æ³• <a target="_blank" rel="noopener" href="http://www.w3school.com.cn/xpath/index.asp">http://www.w3school.com.cn/xpath/index.asp</a></p>
<p>XML è·¯å¾„è¯­è¨€</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install lxml</span><br></pre></td></tr></table></figure>



<ul>
<li>å¸¸ç”¨è§„åˆ™</li>
</ul>
<table>
<thead>
<tr>
<th>è¡¨è¾¾å¼</th>
<th align="left">é€‰å–æ­¤èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹</th>
</tr>
</thead>
<tbody><tr>
<td>/</td>
<td align="left">ä»å½“å‰èŠ‚ç‚¹é€‰å–ç›´æ¥å­èŠ‚ç‚¹</td>
</tr>
<tr>
<td>//</td>
<td align="left">ä»å½“å‰èŠ‚ç‚¹é€‰å–å­å­™èŠ‚ç‚¹</td>
</tr>
<tr>
<td>.</td>
<td align="left">é€‰å–å½“å‰èŠ‚ç‚¹</td>
</tr>
<tr>
<td>..</td>
<td align="left">é€‰å–å½“å‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹</td>
</tr>
<tr>
<td>@</td>
<td align="left">é€‰å–å±æ€§</td>
</tr>
<tr>
<td>nodename</td>
<td align="left">é€‰å–æ­¤èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹</td>
</tr>
</tbody></table>
<p>ä¾‹å¦‚ï¼šæ‰€æœ‰åç§°ä¸º titleï¼ŒåŒæ—¶å±æ€§ lang çš„å€¼ä¸º eng çš„èŠ‚ç‚¹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;title[@lang&#x3D;&#39;eng&#39;]</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line">text = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;div&gt;</span></span><br><span class="line"><span class="string">  &lt;ul&gt;</span></span><br><span class="line"><span class="string">    &lt;li class=&quot;item-0&quot;&gt;&lt;a href=&quot;link1.html&quot;&gt;first item&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">    &lt;li class=&quot;item-1&quot;&gt;&lt;a href=&quot;link2.html&quot;&gt;second item&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">    &lt;li class=&quot;item-inactive&quot;&gt;&lt;a href=&quot;link3.html&quot;&gt;third item&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">    &lt;li class=&quot;item-1&quot;&gt;&lt;a href=&quot;link4.html&quot;&gt;fourth item&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">    &lt;li class=&quot;item-0&quot;&gt;&lt;a href=&quot;link5.html&quot;&gt;fifth item&lt;/a&gt;</span></span><br><span class="line"><span class="string">  &lt;/ul&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">html = etree.HTML(text)</span><br><span class="line">result = etree.tostring(html) <span class="comment"># type: bytes</span></span><br><span class="line">print(result.decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>å¯¼å…¥ lxml åº“çš„ etree æ¨¡å—ï¼Œå£°æ˜ä¸€æ®µ HTML æ–‡æœ¬ï¼Œè°ƒç”¨ HTML ç±»è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™æ ·å°±æˆåŠŸæ„é€ äº†ä¸€ä¸ª XPath è§£æå¯¹è±¡</p>
<p>HTML æ–‡ä»¶æœ€åä¸€ä¸ª li èŠ‚ç‚¹æ˜¯æ²¡æœ‰é—­åˆçš„ï¼Œä½† etree æ¨¡å—å¯ä»¥è‡ªåŠ¨ä¿®æ­£ HTML æ–‡æœ¬ï¼Œå¤„ç†å li èŠ‚ç‚¹è¢«è¡¥å…¨ï¼Œè¿˜è‡ªåŠ¨æ·»åŠ äº† bodyã€html èŠ‚ç‚¹</p>
<p>toString è¾“å‡ºä¿®æ­£åçš„ HTML ä»£ç ï¼Œç»“æœæ˜¯ bytes ç±»å‹ï¼Œåˆ©ç”¨ decode è½¬æˆ str ç±»å‹</p>
<p>ä¹Ÿå¯è¯»å–æ–‡æœ¬è¿›è¡Œè§£æ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">html = etree.parse(<span class="string">&#x27;./test.html&#x27;</span>, etree.HTMLParser())</span><br></pre></td></tr></table></figure>

<h5 id="æ‰€æœ‰ç»“ç‚¹"><a href="#æ‰€æœ‰ç»“ç‚¹" class="headerlink" title="æ‰€æœ‰ç»“ç‚¹"></a>æ‰€æœ‰ç»“ç‚¹</h5><p>ä¸€èˆ¬ç”¨ // å¼€å¤´çš„ XPath è§„åˆ™æ¥é€‰å–æ‰€æœ‰ç¬¦åˆè¦æ±‚çš„èŠ‚ç‚¹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">from</span> lxml.etree <span class="keyword">import</span> _Element</span><br><span class="line">text = <span class="string">&#x27;xxxxx&#x27;</span></span><br><span class="line">html = etree.HTML(text) <span class="comment"># type: _Element</span></span><br><span class="line">result = html.xpath(<span class="string">&#x27;//*&#x27;</span>)</span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>html.xpath ä»£ç æ²¡æç¤ºï¼Œå¯ä»¥å…ˆæ‰“å°ç±»å‹ print(type(html)) -&gt; &lt;class â€˜lxml.etree._Elementâ€™&gt;</p>
<p>å†é€šè¿‡å¯¼åŒ…çš„æ–¹å¼</p>
</blockquote>
<p>è¿™é‡Œä½¿ç”¨ * ä»£è¡¨åŒ¹é…æ‰€æœ‰èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯è·å–æ•´ä¸ª HTML æ–‡æœ¬ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹</p>
<p>è¿”å›å½¢å¼æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯ Element ç±»å‹ï¼Œå…¶åè·Ÿäº†èŠ‚ç‚¹çš„åç§°ï¼Œ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&lt;Element html at <span class="number">0x7f8f63e97280</span>&gt;, &lt;Element body at <span class="number">0x7f8f63f225c0</span>&gt;, &lt;Element div at <span class="number">0x7f8f63f22b40</span>&gt;, &lt;Element ul at <span class="number">0x7f8f63f22b80</span>&gt;, &lt;Element li at <span class="number">0x7f8f63f22bc0</span>&gt;, &lt;Element a at <span class="number">0x7f8f63f22c40</span>&gt;, &lt;Element li at <span class="number">0x7f8f63f22c80</span>&gt;, &lt;Element a at <span class="number">0x7f8f63f22cc0</span>&gt;, &lt;Element li at <span class="number">0x7f8f63f22d00</span>&gt;, &lt;Element a at <span class="number">0x7f8f63f22c00</span>&gt;, &lt;Element li at <span class="number">0x7f8f63f22d40</span>&gt;, &lt;Element a at <span class="number">0x7f8f63f22d80</span>&gt;, &lt;Element li at <span class="number">0x7f8f63f22dc0</span>&gt;, &lt;Element a at <span class="number">0x7f8f63f22e00</span>&gt;]</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ä»¥æŒ‡å®šèŠ‚ç‚¹åç§°ï¼Œä¾‹å¦‚åƒè·å–æ‰€æœ‰ li èŠ‚ç‚¹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = html.xpath(<span class="string">&#x27;//li&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="å­èŠ‚ç‚¹"><a href="#å­èŠ‚ç‚¹" class="headerlink" title="å­èŠ‚ç‚¹"></a>å­èŠ‚ç‚¹</h5><p>/ æˆ– // æŸ¥æ‰¾å…ƒç´ çš„å­èŠ‚ç‚¹æˆ–å­å­™èŠ‚ç‚¹</p>
<p>/ç”¨äºé€‰å–èŠ‚ç‚¹çš„ç›´æ¥å­èŠ‚ç‚¹ï¼Œå¦‚æœè·å–èŠ‚ç‚¹çš„æ‰€æœ‰å­å­™èŠ‚ç‚¹ï¼Œä½¿ç”¨ //</p>
<p>ä¾‹å¦‚ï¼šé€‰æ‹©æ‰€æœ‰ li èŠ‚ç‚¹çš„æ‰€æœ‰ç›´æ¥ a å­èŠ‚ç‚¹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = html.xpath(<span class="string">&#x27;//li/a&#x27;</span>) </span><br></pre></td></tr></table></figure>

<p>ul èŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰å­å­™ a èŠ‚ç‚¹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = html.xpath(<span class="string">&#x27;//ul//a&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="çˆ¶èŠ‚ç‚¹"><a href="#çˆ¶èŠ‚ç‚¹" class="headerlink" title="çˆ¶èŠ‚ç‚¹"></a>çˆ¶èŠ‚ç‚¹</h5><p>href å±æ€§ä¸º link4.html çš„ a èŠ‚ç‚¹ï¼Œç„¶åå†è·å–å…¶çˆ¶ç»“ç‚¹ï¼Œç„¶åå†è·å–å…¶ class å±æ€§</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">result = html.xpath(<span class="string">&#x27;//a[@href=&quot;link4.html&quot;]/../@class&#x27;</span>)</span><br><span class="line"><span class="comment">#ç»“æœï¼šitem-1</span></span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ä»¥é€šè¿‡ parent:: è·å–çˆ¶èŠ‚ç‚¹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = html.xpath(<span class="string">&#x27;//a[@href=link4.html/parent::*/@class]&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="å±æ€§åŒ¹é…"><a href="#å±æ€§åŒ¹é…" class="headerlink" title="å±æ€§åŒ¹é…"></a>å±æ€§åŒ¹é…</h5><p>@ ç¬¦å·è¿›è¡Œå±æ€§è¿‡æ»¤ï¼Œå¦‚æœé€‰å– class ä¸º item-1 çš„ li èŠ‚ç‚¹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = html.xpath(<span class="string">&#x27;//li[@class=&#x27;</span>item<span class="number">-1</span><span class="string">&#x27;]&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="æ–‡æœ¬è·å–"><a href="#æ–‡æœ¬è·å–" class="headerlink" title="æ–‡æœ¬è·å–"></a>æ–‡æœ¬è·å–</h5><p>XPath ä¸­çš„ text() æ–¹æ³•è·å–èŠ‚ç‚¹ä¸­çš„æ–‡æœ¬</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å…ˆé€‰å–aèŠ‚ç‚¹å†è·å–æ–‡æœ¬</span></span><br><span class="line">result = html.xpath(<span class="string">&#x27;//li[@class=&quot;item-0&quot;]/a/text()&#x27;</span>)</span><br><span class="line">ç»“æœï¼š[<span class="string">&#x27;first item&#x27;</span>, <span class="string">&#x27;fifth item&#x27;</span>]</span><br><span class="line"><span class="comment">#æˆ–è€…ä½¿ç”¨//</span></span><br><span class="line">result = html.xpath(<span class="string">&#x27;//li[@class=&quot;item-0&quot;]//text()&#x27;</span>)</span><br><span class="line">ç»“æœï¼š[<span class="string">&#x27;first item&#x27;</span>, <span class="string">&#x27;fifth item&#x27;</span>, <span class="string">&#x27;\n  \t&#x27;</span>] <span class="comment">#å› ä¸ºè‡ªåŠ¨ä¿®æ­£çš„å°¾æ ‡ç­¾æ¢è¡Œäº†</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœæƒ³è·å–æŸäº›ç‰¹å®šå­å­™èŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰æ–‡æœ¬ï¼Œå¯ä»¥å…ˆé€‰å–åˆ°ç‰¹å®šçš„å­å­™èŠ‚ç‚¹ï¼Œå†è°ƒç”¨ text()</p>
<h5 id="å±æ€§è·å–"><a href="#å±æ€§è·å–" class="headerlink" title="å±æ€§è·å–"></a>å±æ€§è·å–</h5><p>è·å– li èŠ‚ç‚¹ä¸‹æ‰€æœ‰ a èŠ‚ç‚¹çš„ href å±æ€§</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">result = html.xpath(<span class="string">&#x27;//li/a/@href&#x27;</span>)</span><br><span class="line">ç»“æœ</span><br><span class="line">[<span class="string">&#x27;link1.html&#x27;</span>, <span class="string">&#x27;link2.html&#x27;</span>, <span class="string">&#x27;link3.html&#x27;</span>, <span class="string">&#x27;link4.html&#x27;</span>, <span class="string">&#x27;link5.html&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h5 id="å±æ€§å¤šå€¼åŒ¹é…"><a href="#å±æ€§å¤šå€¼åŒ¹é…" class="headerlink" title="å±æ€§å¤šå€¼åŒ¹é…"></a>å±æ€§å¤šå€¼åŒ¹é…</h5><p>æŸäº›èŠ‚ç‚¹çš„å±æ€§å¯èƒ½æœ‰å¤šä¸ªå€¼</p>
<p>ä¸‹é¢ html ä¸­ li èŠ‚ç‚¹çš„ class å±æ€§æœ‰ä¸¤ä¸ªå€¼ li å’Œ li-listï¼Œå°±éœ€è¦ç”¨åˆ° cantains() å‡½æ•°äº†</p>
<p>contains ç¬¬ä¸€ä¸ªå‚æ•°ä¼ å±æ€§åç§°ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¼ å±æ€§å€¼ï¼Œä¼ å…¥çš„å±æ€§åŒ…å«å±æ€§å€¼å°±åŒ¹é…</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">text = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;li class=&quot;li li-first&quot;&gt;&lt;a href=&quot;link.html&quot;&gt;first item&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">html = etree.HTML(text)</span><br><span class="line">result = html.xpath(<span class="string">&#x27;//li[contains(@class, &quot;li&quot;)]/a/text()&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="å¤šå±æ€§åŒ¹é…"><a href="#å¤šå±æ€§åŒ¹é…" class="headerlink" title="å¤šå±æ€§åŒ¹é…"></a>å¤šå±æ€§åŒ¹é…</h5><p>å¤šä¸ªå±æ€§ç¡®å®šä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°±éœ€è¦åŒæ—¶åŒ¹é…å¤šä¸ªå±æ€§ï¼Œå¯ä»¥ä½¿ç”¨ and è¿æ¥</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">text = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;li class=&quot;li li-first&quot; name=&quot;item&quot;&gt;&lt;a href=&quot;link.html&quot;&gt;first item&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">html = etree.HTML(text)</span><br><span class="line">result = html.xpath(<span class="string">&#x27;//li[contains(@class, &quot;li&quot;) and @name=&quot;item&quot;]/a/text()&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>è¿ç®—ç¬¦ï¼š</li>
</ul>
<table>
<thead>
<tr>
<th>orã€and</th>
<th>æˆ–ã€ä¸</th>
</tr>
</thead>
<tbody><tr>
<td>+ã€-ã€*ã€divã€mod</td>
<td>åŠ ã€å‡ã€ä¹˜ã€é™¤ã€é™¤æ³•ä½™æ•°</td>
</tr>
<tr>
<td>&gt;ã€=ã€&lt;ã€!=ã€&gt;=ã€&lt;=</td>
<td>å¤§äºã€ç­‰äºã€å°äºã€ä¸ç­‰äºã€å¤§äºç­‰äºã€å°äºç­‰äº</td>
</tr>
</tbody></table>
<h5 id="æŒ‰åºé€‰æ‹©"><a href="#æŒ‰åºé€‰æ‹©" class="headerlink" title="æŒ‰åºé€‰æ‹©"></a>æŒ‰åºé€‰æ‹©</h5><p>æœ‰æ—¶å€™åŒ¹é…äº†å¤šä¸ªèŠ‚ç‚¹ï¼Œåªæƒ³è¦å…¶ä¸­æŸä¸ªèŠ‚ç‚¹</p>
<p>å¯ä»¥åˆ©ç”¨ä¸­æ‹¬å·ä¼ å…¥ç´¢å¼•çš„æ–¹æ³•è·å–ç‰¹å®šæ¬¡åºçš„èŠ‚ç‚¹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">result = html.xpath(<span class="string">&#x27;//li[1]/a/text()&#x27;</span>)  <span class="comment">#ç¬¬ä¸€ä¸ªlièŠ‚ç‚¹ </span></span><br><span class="line">result = html.xpath(<span class="string">&#x27;//li[last()]/a/text()&#x27;</span>) <span class="comment">#æœ€åä¸€ä¸ªlièŠ‚ç‚¹</span></span><br><span class="line">result = html.xpath(<span class="string">&#x27;//li[position()&lt;3]/a/text()&#x27;</span>)<span class="comment">#ä½ç½®å°äº3çš„lièŠ‚ç‚¹</span></span><br><span class="line">result = html.xpath(<span class="string">&#x27;//li[last()-2]/a/text()&#x27;</span>) <span class="comment">#å€’æ•°ç¬¬3ä¸ªèŠ‚ç‚¹</span></span><br></pre></td></tr></table></figure>

<p>Xpath ä¸­æä¾›äº† 100 å¤šä¸ªå‡½æ•°ï¼Œå…·ä½“å‚è€ƒ <a target="_blank" rel="noopener" href="http://www.w3school.com.en/xpath/xpath_functions.asp">http://www.w3school.com.en/xpath/xpath_functions.asp</a></p>
<h5 id="èŠ‚ç‚¹è½´é€‰æ‹©"><a href="#èŠ‚ç‚¹è½´é€‰æ‹©" class="headerlink" title="èŠ‚ç‚¹è½´é€‰æ‹©"></a>èŠ‚ç‚¹è½´é€‰æ‹©</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//è·å–æ‰€æœ‰ç¥–å…ˆèŠ‚ç‚¹</span><br><span class="line">result = html.xpath(<span class="string">&#x27;//li[1]/ancestor::*&#x27;</span>)</span><br><span class="line">//è·å–æ‰€æœ‰ div çš„ç¥–å…ˆèŠ‚ç‚¹</span><br><span class="line">result = html.xpath(<span class="string">&#x27;//li[1]/ancestor::div&#x27;</span>)</span><br><span class="line">//è·å– li èŠ‚ç‚¹æ‰€æœ‰å±æ€§å€¼</span><br><span class="line">result = html.xpath(<span class="string">&#x27;//li[1]/attribute::*&#x27;</span>)</span><br><span class="line">//è·å–ç›´æ¥å­—èŠ‚ç‚¹ï¼Œå– href å±æ€§ä¸º link.html çš„ a èŠ‚ç‚¹</span><br><span class="line">result = html.xpath(<span class="string">&#x27;//li[1]/child::a[@href=&quot;link1.html&quot;]&#x27;</span>)</span><br><span class="line">//è·å–å­å­™èŠ‚ç‚¹ï¼Œå–åŒ…å« span èŠ‚ç‚¹</span><br><span class="line">result = html.xpath(<span class="string">&#x27;//li[1]/descendant::span&#x27;</span>)</span><br><span class="line">//è·å–å½“å‰èŠ‚ç‚¹ä¹‹åæ‰€æœ‰èŠ‚ç‚¹ï¼Œåªè·å–ç¬¬äºŒä¸ªåç»­èŠ‚ç‚¹</span><br><span class="line">result = html.xpath(<span class="string">&#x27;//li[1]/following::*[2]&#x27;</span>)</span><br><span class="line">//è·å–å½“å‰èŠ‚ç‚¹ä¹‹åçš„æ‰€æœ‰åŒçº§èŠ‚ç‚¹</span><br><span class="line">result = html.xpath(<span class="string">&#x27;//li[1]/following-sibling::*&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>XPath è½´ <a target="_blank" rel="noopener" href="http://www.w3school.com.cn/xpath/xpath_axes.asp">http://www.w3school.com.cn/xpath/xpath_axes.asp</a></p>
<h4 id="Beautiful-Soup"><a href="#Beautiful-Soup" class="headerlink" title="Beautiful Soup"></a>Beautiful Soup</h4><p>HTML æˆ– XML çš„è§£æåº“ï¼Œå€ŸåŠ©ç½‘é¡µçš„ç»“æ„å’Œå±æ€§ç­‰ç‰¹æ€§æ¥è§£æç½‘é¡µ</p>
<p>è‡ªåŠ¨å°†è¾“å…¥æ–‡æ¡£è½¬æ¢ä¸º Unicode ç¼–ç ï¼Œè¾“å‡ºæ–‡æ¡£è½¬æ¢ä¸º UTF-8 ç¼–ç ï¼Œä¸éœ€è¦è€ƒè™‘ç¼–ç æ–¹å¼</p>
<p>Beautiful Soup åœ¨è§£ææ—¶ä¾èµ–è§£æå™¨ï¼Œlxml è§£æå™¨æœ‰è§£æ HTML å’Œ XML çš„åŠŸèƒ½ï¼Œä¸”é€Ÿåº¦å¿«ï¼Œå®¹é”™èƒ½åŠ›å¼º</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install beautifulsoup4</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line">soup = BeautifulSoup(<span class="string">&#x27;&lt;p&gt;Hello&lt;/p&gt;&#x27;</span>, <span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line">print(soup.p.string) <span class="comment">#é€‰å–pèŠ‚ç‚¹ï¼Œè°ƒç”¨stringå±æ€§å°±å¯ä»¥å¾—åˆ°é‡Œé¢æ–‡æœ¬äº†</span></span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸€ä¸ªå‚æ•° HTMLå­—ç¬¦ä¸²ï¼Œ ç¬¬äºŒä¸ªå‚æ•°ä¸ºè§£æå™¨çš„ç±»å‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">html = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;html&gt;&lt;head&gt;&lt;title&gt;The Dormouse&#x27;s story&lt;/title&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;p class=&quot;title&quot; name=&quot;dromouse&quot;&gt;&lt;b&gt;The Dormouse&#x27;s story&lt;/b&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;p class=&quot;story&quot; Once upon a time there were three little sisters; and their names were</span></span><br><span class="line"><span class="string">&lt;a href=&quot;http://example.com/elsie&quot; class=&quot;sister&quot; id=&quot;linkl&quot;&gt;&lt;! - Elsie ...&gt;&lt;/a&gt;,</span></span><br><span class="line"><span class="string">&lt;a href=&quot;http://example.com/lacie&quot; class=&quot;sister&quot; id=&quot;link2&quot;&gt;Lacie&lt;/a&gt; and</span></span><br><span class="line"><span class="string">&lt;a href=&quot;http://example.com/tillie&quot; class=&quot;sister&quot; id=&quot;link3&quot;&gt;Tillie&lt;/a&gt;;</span></span><br><span class="line"><span class="string">and they lived at the bottom of a well.&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;p class=&quot;story&quot;&gt;...&lt;/p&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">soup = BeautifulSoup(html, <span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line">print(soup.prettify())</span><br><span class="line">print(soup.title.string)</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨ pretttify() æ–¹æ³•ï¼ŒæŠŠè¦è§£æçš„å­—ç¬¦ä¸²ä»¥æ ‡å‡†çš„ç¼©è¿›æ ¼å¼è¾“å‡ºï¼ŒBeautiful Soup å¯ä»¥è‡ªåŠ¨æ›´æ­£æ ¼å¼</p>
<p>soup.title.string é€‰å– title èŠ‚ç‚¹ï¼Œå†è°ƒç”¨ string å±æ€§å°±å¯ä»¥å¾—åˆ°é‡Œé¢çš„æ–‡æœ¬äº†</p>
<h5 id="èŠ‚ç‚¹é€‰æ‹©å™¨"><a href="#èŠ‚ç‚¹é€‰æ‹©å™¨" class="headerlink" title="èŠ‚ç‚¹é€‰æ‹©å™¨"></a>èŠ‚ç‚¹é€‰æ‹©å™¨</h5><p>ç›´æ¥è°ƒç”¨èŠ‚ç‚¹åç§°å°±å¯ä»¥é€‰æ‹©èŠ‚ç‚¹å…ƒç´ ï¼Œå†è°ƒç”¨ string å±æ€§å°±å¯ä»¥å¾—åˆ°èŠ‚ç‚¹å†…çš„æ–‡æœ¬äº†</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">print(soup.title)</span><br><span class="line">print(<span class="built_in">type</span>(soup.title))</span><br><span class="line">print(soup.title.string)</span><br><span class="line">print(soup.head)</span><br><span class="line">print(soup.p)</span><br><span class="line">ç»“æœ</span><br><span class="line">&lt;title&gt;The Dormouse<span class="string">&#x27;s story&lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;class &#x27;</span>bs4.element.Tag<span class="string">&#x27;&gt;</span></span><br><span class="line"><span class="string">The Dormouse&#x27;</span>s story</span><br><span class="line">&lt;head&gt;&lt;title&gt;The Dormouse<span class="string">&#x27;s story&lt;/title&gt;&lt;/head&gt;</span></span><br><span class="line">&lt;p class=&quot;title&quot; name=&quot;dromouse&quot;&gt;&lt;b&gt;The Dormouse&#x27;s story&lt;/b&gt;&lt;/p&gt;</span><br></pre></td></tr></table></figure>

<p>åªæ‰“å°äº†ç¬¬ä¸€ä¸ª p èŠ‚ç‚¹çš„å†…å®¹ï¼Œå¤šä¸ªèŠ‚ç‚¹æ—¶ï¼Œè¿™ç§é€‰æ‹©æ–¹å¼åªä¼šé€‰æ‹©åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…çš„èŠ‚ç‚¹ï¼Œåé¢çš„å…¶å®ƒèŠ‚ç‚¹éƒ½ä¼šè¢«å¿½ç•¥</p>
<h5 id="æå–ä¿¡æ¯"><a href="#æå–ä¿¡æ¯" class="headerlink" title="æå–ä¿¡æ¯"></a>æå–ä¿¡æ¯</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//è·å–èŠ‚ç‚¹åç§°</span><br><span class="line">print(soup.title.name)  		</span><br><span class="line">title</span><br></pre></td></tr></table></figure>

<p>ä¸€ä¸ªèŠ‚ç‚¹å¯èƒ½æœ‰å¤šä¸ªå±æ€§ï¼Œå¦‚ id å’Œ class ç­‰ï¼Œè°ƒç”¨ attrs è·å–æ‰€æœ‰å±æ€§ï¼Œè¿”å›ç»“æœæ˜¯å­—å…¸å½¢å¼</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//è·å–æ‰€æœ‰å±æ€§</span><br><span class="line">print(soup.p.attrs)			 		</span><br><span class="line">&#123;<span class="string">&#x27;class&#x27;</span>: [<span class="string">&#x27;title&#x27;</span>], <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;dromouse&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//è·å– name å±æ€§</span><br><span class="line">print(soup.p.attrs[<span class="string">&#x27;name&#x27;</span>])	</span><br><span class="line">dromouse</span><br></pre></td></tr></table></figure>

<p>æ¯”è¾ƒç®€å•æ–¹å¼ï¼Œæ³¨æ„è¿”å›æœ‰çš„æ˜¯å­—ç¬¦ä¸²ï¼Œæœ‰çš„æ˜¯å­—ç¬¦ä¸²ç»„æˆçš„åˆ—è¡¨</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">print(soup.p[<span class="string">&#x27;name&#x27;</span>])</span><br><span class="line">print(soup.p[<span class="string">&#x27;class&#x27;</span>])</span><br><span class="line"><span class="comment">#éœ€è¦æ³¨æ„æœ‰çš„è¿”å›å­—ç¬¦ä¸²ï¼Œæœ‰çš„è¿”å›å­—ç¬¦ä¸²ç»„æˆçš„åˆ—è¡¨ï¼Œè¦æ³¨æ„åˆ¤æ–­ç±»å‹</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;è·å–å†…å®¹(æ˜¯ç¬¬ä¸€ä¸ª p èŠ‚ç‚¹)</span><br><span class="line">print(soup.p.string)</span><br></pre></td></tr></table></figure>

<h5 id="åµŒå¥—é€‰æ‹©"><a href="#åµŒå¥—é€‰æ‹©" class="headerlink" title="åµŒå¥—é€‰æ‹©"></a>åµŒå¥—é€‰æ‹©</h5><p>é€‰å–ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¯ä»¥ç»§ç»­è°ƒç”¨èŠ‚ç‚¹è¿›è¡Œä¸‹ä¸€æ­¥é€‰æ‹©</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(soup.head.title.string)</span><br></pre></td></tr></table></figure>

<h5 id="å…³è”é€‰æ‹©"><a href="#å…³è”é€‰æ‹©" class="headerlink" title="å…³è”é€‰æ‹©"></a>å…³è”é€‰æ‹©</h5><p>æœ‰æ—¶å€™ä¸èƒ½ä¸€æ­¥å°±é€‰åˆ°æƒ³è¦çš„èŠ‚ç‚¹å…ƒç´ ï¼Œéœ€è¦å…ˆé€‰ä¸­æŸä¸ªèŠ‚ç‚¹å…ƒç´ ï¼Œç„¶åä»¥å®ƒä¸ºåŸºå‡†å†é€‰æ‹©å®ƒçš„çˆ¶èŠ‚ç‚¹ã€å­èŠ‚ç‚¹ã€å…„å¼ŸèŠ‚ç‚¹</p>
<h6 id="ç›´æ¥å­èŠ‚ç‚¹-contentsã€children"><a href="#ç›´æ¥å­èŠ‚ç‚¹-contentsã€children" class="headerlink" title="ç›´æ¥å­èŠ‚ç‚¹ contentsã€children"></a>ç›´æ¥å­èŠ‚ç‚¹ contentsã€children</h6><p>æ·»åŠ ä¸€ä¸ª p èŠ‚ç‚¹</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;p class=&quot;story&quot;&gt;</span><br><span class="line">	Once upon a time there were three little sisters; <span class="keyword">and</span> their names were</span><br><span class="line">  &lt;a href=&quot;http://example.com/elsie&quot; class=&quot;sister&quot; id=&quot;linkl&quot;&gt; </span><br><span class="line">    &lt;span&gt; Elsie&lt;/span&gt;</span><br><span class="line">  &lt;/a&gt;</span><br><span class="line">&lt;/p&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">html = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line">soup = BeautifulSoup(html,<span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line">print(soup.p.contents)</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨ contents å±æ€§ï¼Œç»“æœè¿”å› p èŠ‚ç‚¹çš„ç›´æ¥å­èŠ‚ç‚¹ï¼Œè¿”å›ç»“æœæ˜¯ä¸€ä¸ªåˆ—è¡¨å½¢å¼</p>
<p>åŒ…å«æ–‡æœ¬å’ŒèŠ‚ç‚¹ï¼Œå¾—åˆ°çš„æ˜¯ç›´æ¥å­èŠ‚ç‚¹çš„åˆ—è¡¨ï¼ˆspanæ˜¯å­å­™èŠ‚ç‚¹åœ¨aèŠ‚ç‚¹é‡Œé¢ï¼Œæ²¡æœ‰å•ç‹¬é€‰å‡ºæ¥ï¼‰</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">print(soup.p.contents)</span><br><span class="line">[&#x27;\n\tOnce upon a time there were three little sisters; and their names were\n\t&#x27;, &lt;a class=&quot;sister&quot; href=&quot;http://example.com/elsie&quot; id=&quot;linkl&quot;&gt;</span><br><span class="line">&lt;span&gt; Elsie&lt;/span&gt;</span><br><span class="line">&lt;/a&gt;, &#x27;\n&#x27;]</span><br></pre></td></tr></table></figure>

<p>åŒæ ·å¯ä»¥ç›´æ¥è°ƒç”¨ children å±æ€§å¾—åˆ°ç›¸åº”çš„ç»“æœï¼Œè¿”å›ç»“æœæ˜¯ç”Ÿæˆå™¨ç±»å‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">print(soup.p.children)</span><br><span class="line"><span class="keyword">for</span> i, child <span class="keyword">in</span> <span class="built_in">enumerate</span>(soup.p.children):</span><br><span class="line">  print(i, child)</span><br></pre></td></tr></table></figure>



<h6 id="å­å­™èŠ‚ç‚¹-descendants"><a href="#å­å­™èŠ‚ç‚¹-descendants" class="headerlink" title="å­å­™èŠ‚ç‚¹ descendants"></a>å­å­™èŠ‚ç‚¹ descendants</h6><p>å¦‚æœè¦è·å–æ‰€æœ‰å­å­™èŠ‚ç‚¹çš„è¯ï¼Œè°ƒç”¨ descendants å±æ€§ï¼Œè¿”å›ç»“æœæ˜¯ç”Ÿæˆå™¨ç±»å‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">print(soup.p.descendants)</span><br><span class="line"><span class="keyword">for</span> i, child <span class="keyword">in</span> <span class="built_in">enumerate</span>(soup.p.descendants):</span><br><span class="line">    print(i, child)</span><br></pre></td></tr></table></figure>



<h6 id="çˆ¶èŠ‚ç‚¹å’Œ-ç¥–å…ˆèŠ‚ç‚¹"><a href="#çˆ¶èŠ‚ç‚¹å’Œ-ç¥–å…ˆèŠ‚ç‚¹" class="headerlink" title="çˆ¶èŠ‚ç‚¹å’Œ ç¥–å…ˆèŠ‚ç‚¹"></a>çˆ¶èŠ‚ç‚¹å’Œ ç¥–å…ˆèŠ‚ç‚¹</h6><p>è·å–çˆ¶èŠ‚ç‚¹ï¼Œè°ƒç”¨ parent å±æ€§</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(soup.a.parent)</span><br></pre></td></tr></table></figure>

<p>æƒ³è¦è·å–æ‰€æœ‰çš„ç¥–å…ˆèŠ‚ç‚¹ï¼Œè°ƒç”¨ parents å±æ€§ï¼Œè¿”å›ç»“æœæ˜¯ç”Ÿæˆå™¨ç±»å‹ï¼Œè¿™é‡Œç”¨åˆ—è¡¨è¾“å‡ºç´¢å¼•å’Œå†…å®¹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(<span class="built_in">list</span>(<span class="built_in">enumerate</span>(soup.a.parents)))</span><br></pre></td></tr></table></figure>



<h6 id="å…„å¼ŸèŠ‚ç‚¹ï¼ˆåŒçº§èŠ‚ç‚¹ï¼‰"><a href="#å…„å¼ŸèŠ‚ç‚¹ï¼ˆåŒçº§èŠ‚ç‚¹ï¼‰" class="headerlink" title="å…„å¼ŸèŠ‚ç‚¹ï¼ˆåŒçº§èŠ‚ç‚¹ï¼‰"></a>å…„å¼ŸèŠ‚ç‚¹ï¼ˆåŒçº§èŠ‚ç‚¹ï¼‰</h6><p>next_sibling èŠ‚ç‚¹ä¸‹ä¸€ä¸ªå…„å¼Ÿå…ƒç´ </p>
<p>previous_sibling èŠ‚ç‚¹ä¸Šä¸€ä¸ªå…„å¼Ÿå…ƒç´ </p>
<p>next_siblings æ‰€æœ‰å‰é¢çš„å…„å¼Ÿå…ƒç´ </p>
<p>previous_siblings æ‰€æœ‰åé¢çš„å…„å¼Ÿå…ƒç´ </p>
<h5 id="æå–ä¿¡æ¯-1"><a href="#æå–ä¿¡æ¯-1" class="headerlink" title="æå–ä¿¡æ¯"></a>æå–ä¿¡æ¯</h5><p>è¿”å›çš„æ˜¯å•ä¸ªèŠ‚ç‚¹ï¼Œç›´æ¥è°ƒç”¨ stringã€attrs ç­‰å±æ€§è·å–æ–‡æœ¬å’Œå±æ€§</p>
<p>å¤šä¸ªèŠ‚ç‚¹çš„ç”Ÿæˆå™¨ï¼Œåˆ™å¯è½¬ä¸ºåˆ—è¡¨åå–å‡ºæŸä¸ªå…ƒç´ ï¼Œç„¶åè°ƒç”¨ stringã€attrs</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">print(soup.a.next_sibling)</span><br><span class="line">print(soup.a.next_sibling.string)</span><br><span class="line">print(<span class="built_in">list</span>(soup.a.parents)[<span class="number">0</span>])</span><br><span class="line">pirnt(<span class="built_in">list</span>(soup.a.parents)[<span class="number">0</span>].attrs[<span class="string">&#x27;class&#x27;</span>])</span><br></pre></td></tr></table></figure>

<h5 id="æ–¹æ³•é€‰æ‹©å™¨"><a href="#æ–¹æ³•é€‰æ‹©å™¨" class="headerlink" title="æ–¹æ³•é€‰æ‹©å™¨"></a>æ–¹æ³•é€‰æ‹©å™¨</h5><p>å‰é¢çš„é€‰æ‹©æ–¹æ³•éƒ½æ˜¯é€šè¿‡å±æ€§æ¥é€‰æ‹©çš„ï¼ŒBeautiful Soup è¿˜æä¾›äº†ä¸€äº›æŸ¥è¯¢æ–¹æ³•</p>
<h6 id="find-all"><a href="#find-all" class="headerlink" title="find_all()"></a>find_all()</h6><p>æŸ¥æ‰¾æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„å…ƒç´ ï¼Œä¼ å…¥å±æ€§æˆ–æ–‡æœ¬ï¼Œå°±å¯ä»¥å¾—åˆ°ç¬¦åˆæ¡ä»¶çš„å…ƒç´ </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find_all(name, attrs, recursive, text, **kwargs)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">html = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">  &lt;div class=&quot;panel&quot;&gt;</span></span><br><span class="line"><span class="string">  &lt;div class=&quot;panel-heading&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;h4&gt;Hello&lt;/h4&gt;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;</span></span><br><span class="line"><span class="string">  &lt;div class=&quot;panel-body&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;ul class=&quot;list&quot; id=&quot;list-1&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;li class=&quot;element&quot;&gt;Foo&lt;/li&gt;</span></span><br><span class="line"><span class="string">      &lt;li class=&quot;element&quot;&gt;Bar&lt;/li&gt;</span></span><br><span class="line"><span class="string">      &lt;li class=&quot;element&quot;&gt;Jay&lt;/li&gt;</span></span><br><span class="line"><span class="string">    &lt;/ul&gt;</span></span><br><span class="line"><span class="string">    &lt;ul class=&quot;list list-small&quot; id=&quot;list-2&quot;&gt;</span></span><br><span class="line"><span class="string">      &lt;li class=&quot;element&quot;&gt;Foo&lt;/li&gt;</span></span><br><span class="line"><span class="string">      &lt;li class=&quot;element&quot;&gt;Bar&lt;/li&gt;</span></span><br><span class="line"><span class="string">    &lt;/ul&gt;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>  (1) name æ ¹æ®èŠ‚ç‚¹åæ¥æŸ¥è¯¢å…ƒç´ </p>
<p>æŸ¥è¯¢æ‰€æœ‰ ul èŠ‚ç‚¹ï¼Œè¿”å›ç»“æœæ˜¯åˆ—è¡¨ç±»å‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">soup = BeautifulSoup(html,<span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line">print(soup.find_all(name=<span class="string">&#x27;ul&#x27;</span>)) </span><br><span class="line"><span class="comment">#ç»“æœåˆ—è¡¨ç±»å‹ï¼Œé•¿åº¦2</span></span><br></pre></td></tr></table></figure>

<p>æŸ¥è¯¢å‡ºæ‰€æœ‰ ul èŠ‚ç‚¹åï¼Œå†ç»§ç»­æŸ¥è¯¢å…¶å†…éƒ¨çš„ li èŠ‚ç‚¹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">soup = BeautifulSoup(html,<span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> ul <span class="keyword">in</span> soup.find_all(name=<span class="string">&#x27;ul&#x27;</span>):</span><br><span class="line">  print(ul.find_all(name=<span class="string">&#x27;li&#x27;</span>))</span><br><span class="line">  <span class="keyword">for</span> li <span class="keyword">in</span> ul.find_all(name=<span class="string">&#x27;li&#x27;</span>):</span><br><span class="line">    print(li.string)</span><br></pre></td></tr></table></figure>



<p>(2)  attrs ä¼ å…¥å±æ€§æŸ¥è¯¢</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">print(soup.find_all(attrs=&#123;<span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;list-1&#x27;</span>&#125;))</span><br><span class="line">print(soup.find_all(attrs=&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;elements&#x27;</span>&#125;))</span><br><span class="line"></span><br><span class="line">print(soup.find_all(<span class="built_in">id</span>=<span class="string">&#x27;list-1&#x27;</span>))</span><br><span class="line">print(soup.find_all(class_=<span class="string">&#x27;element&#x27;</span>)) </span><br><span class="line"><span class="comment">#class æ˜¯ Python å…³é”®å­—ï¼Œéœ€è¦åŠ ä¸‹åˆ’çº¿</span></span><br></pre></td></tr></table></figure>



<p>(3) text åŒ¹é…èŠ‚ç‚¹çš„æ–‡æœ¬ï¼Œå¯ä»¥ä¼ å­—ç¬¦ä¸²æˆ–æ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å‚æ•°ä¸ºæ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡</span></span><br><span class="line">print(soup.find_all(text=re.<span class="built_in">compile</span>(<span class="string">&#x27;link&#x27;</span>)))</span><br></pre></td></tr></table></figure>

<h6 id="find"><a href="#find" class="headerlink" title="find()"></a>find()</h6><p>è¿”å›çš„æ˜¯å•ä¸ªå…ƒç´ ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªåŒ¹é…çš„å…ƒç´ </p>
<ol start="3">
<li>å…¶å®ƒæŸ¥è¯¢æ–¹æ³•</li>
</ol>
<p>find_parents() å’Œ find_parent()ï¼šå‰è€…è¿”å›æ‰€æœ‰ç¥–å…ˆèŠ‚ç‚¹ï¼Œåè€…è¿”å›ç›´æ¥çˆ¶èŠ‚ç‚¹</p>
<p>find_next_siblings() å’Œ find_next_sibling()ï¼šå‰è€…è¿”å›åé¢æ‰€æœ‰å…„å¼ŸèŠ‚ç‚¹ï¼Œåè€…è¿”å›åé¢ç¬¬ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹</p>
<p>find_previous_siblings() å’Œ find_previous_sibling()ï¼šï¼šå‰è€…è¿”å›å‰é¢æ‰€æœ‰å…„å¼ŸèŠ‚ç‚¹ï¼Œåè€…è¿”å›å‰é¢ç¬¬ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹</p>
<p>find_all_next() å’Œ find_next()ï¼šå‰è€…è¿”å›èŠ‚ç‚¹åæ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹ï¼Œåè€…è¿”å›ç¬¬ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹</p>
<p>find_all_previous() å’Œ find_previousï¼š</p>
<h5 id="CSS-é€‰æ‹©å™¨"><a href="#CSS-é€‰æ‹©å™¨" class="headerlink" title="CSS é€‰æ‹©å™¨"></a>CSS é€‰æ‹©å™¨</h5><p>Beautiful Soupè¿˜æä¾›äº†å¦ä¸€ç§é€‰æ‹©å™¨ï¼ŒCSS é€‰æ‹©å™¨</p>
<p>åªéœ€è¦è°ƒç”¨ select ï¼Œä¼ å…¥ç›¸åº” CSS é€‰æ‹©å™¨å³å¯</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">html = &#x27;&#x27;&#x27;</span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;panel&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;panel-heading&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h4</span>&gt;</span>Hello<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;panel-body&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;list&quot;</span> <span class="attr">id</span>=<span class="string">&quot;list-1&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;element&quot;</span>&gt;</span>Foo<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;element&quot;</span>&gt;</span>Bar<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;element&quot;</span>&gt;</span>Jay<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;list list-small&quot;</span> <span class="attr">id</span>=<span class="string">&quot;list-2&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;element&quot;</span>&gt;</span>Foo<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;element&quot;</span>&gt;</span>Bar<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#x27;&#x27;&#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">soup = BeautifulSoup(html, <span class="string">&#x27;lxml&#x27;</span>)</span><br><span class="line">print(soup.select(<span class="string">&#x27;.panel .panel-heading&#x27;</span>))   <span class="comment"># é€‰æ‹©class</span></span><br><span class="line">print(soup.select(<span class="string">&#x27;ul li&#x27;</span>)) <span class="comment">#é€‰æ‹©æ‰€æœ‰ulèŠ‚ç‚¹ä¸‹é¢çš„lièŠ‚ç‚¹</span></span><br><span class="line">print(soup.select(<span class="string">&#x27;#list-2 .element&#x27;</span>)) <span class="comment"># é€‰æ‹©id</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ç»“æœ</span></span><br><span class="line">[&lt;div class=&quot;panel-heading&quot;&gt;</span><br><span class="line">&lt;h4&gt;Hello&lt;/h4&gt;</span><br><span class="line">&lt;/div&gt;]</span><br><span class="line"></span><br><span class="line">[&lt;li class=&quot;element&quot;&gt;Foo&lt;/li&gt;, &lt;li class=&quot;element&quot;&gt;Bar&lt;/li&gt;, &lt;li class=&quot;element&quot;&gt;Jay&lt;/li&gt;, &lt;li class=&quot;element&quot;&gt;Foo&lt;/li&gt;, &lt;li class=&quot;element&quot;&gt;Bar&lt;/li&gt;]</span><br><span class="line"></span><br><span class="line">[&lt;li class=&quot;element&quot;&gt;Foo&lt;/li&gt;, &lt;li class=&quot;element&quot;&gt;Bar&lt;/li&gt;]</span><br></pre></td></tr></table></figure>

<h6 id="åµŒå¥—é€‰æ‹©-1"><a href="#åµŒå¥—é€‰æ‹©-1" class="headerlink" title="åµŒå¥—é€‰æ‹©"></a>åµŒå¥—é€‰æ‹©</h6><p>select() æ–¹æ³•åŒæ ·æ”¯æŒåµŒå¥—é€‰æ‹©ï¼Œå¦‚å…ˆé€‰æ‹©æ‰€æœ‰ ul èŠ‚ç‚¹ï¼Œå†éå†æ¯ä¸ª ul èŠ‚ç‚¹ï¼Œé€‰æ‹©å…¶ li èŠ‚ç‚¹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ul <span class="keyword">in</span> soup.select(<span class="string">&#x27;ul&#x27;</span>):</span><br><span class="line">	print(ul.select(<span class="string">&#x27;li&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºäº†æ‰€æœ‰ ul èŠ‚ç‚¹ä¸‹æ‰€æœ‰ li èŠ‚ç‚¹ç»„æˆçš„åˆ—è¡¨</p>
<h6 id="è·å–å±æ€§"><a href="#è·å–å±æ€§" class="headerlink" title="è·å–å±æ€§"></a>è·å–å±æ€§</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ul <span class="keyword">in</span> soup.select(<span class="string">&#x27;ul&#x27;</span>):</span><br><span class="line">	print(ul[<span class="string">&#x27;id&#x27;</span>])</span><br><span class="line">	print(ul.attrs[<span class="string">&#x27;id&#x27;</span>])</span><br></pre></td></tr></table></figure>

<h6 id="è·å–æ–‡æœ¬"><a href="#è·å–æ–‡æœ¬" class="headerlink" title="è·å–æ–‡æœ¬"></a>è·å–æ–‡æœ¬</h6><p>è·å–æ–‡æœ¬å¯ä»¥ç”¨ string å±æ€§ï¼Œè¿˜æœ‰ä¸ªæ–¹æ³• get_text()</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> li <span class="keyword">in</span> soup.select(<span class="string">&#x27;li&#x27;</span>):</span><br><span class="line">	print(<span class="string">&#x27;Get Text:&#x27;</span>, li.get_text())</span><br><span class="line">	print(<span class="string">&#x27;String:&#x27;</span>, li.string)</span><br></pre></td></tr></table></figure>



<h4 id="pyquery"><a href="#pyquery" class="headerlink" title="pyquery"></a>pyquery</h4><p>å¦‚æœæ¯”è¾ƒå–œæ¬¢ç”¨CSSé€‰æ‹©å™¨ï¼Œå¯¹jQueryæœ‰æ‰€äº†è§£ï¼Œå¯ä»¥ä½¿ç”¨ pyquery</p>
<h5 id="å­—ç¬¦ä¸²åˆå§‹åŒ–"><a href="#å­—ç¬¦ä¸²åˆå§‹åŒ–" class="headerlink" title="å­—ç¬¦ä¸²åˆå§‹åŒ–"></a>å­—ç¬¦ä¸²åˆå§‹åŒ–</h5><p>ä¼ å…¥ HTML å­—ç¬¦ä¸²ï¼ˆå¸¸ç”¨ï¼‰</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pyquery <span class="keyword">import</span> PyQuery <span class="keyword">as</span> pq <span class="comment">#å¼•å…¥ PyQuery å¯¹è±¡ï¼Œå–åˆ«å pq</span></span><br><span class="line">html = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;div&gt;</span></span><br><span class="line"><span class="string">&lt;ul&gt;</span></span><br><span class="line"><span class="string">&lt;li class=&quot;item-0&quot;&gt;first item&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;li class=&quot;item-1&quot;&gt;&lt;a href=&quot;link2.html&quot;&gt;second item&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;li class=&quot;item-0 active&quot;&gt;&lt;a href=&quot;link3.html&quot;&gt;&lt;span class=&quot;bold&quot;&gt;third item&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;li class=&quot;item-1 active&quot;&gt;&lt;a href=&quot;link4.html&quot;&gt;fourth item&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;li class=&quot;item-0&quot;&gt;&lt;a href=&quot;link5.html&quot;&gt;fifth item&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;/ul&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">doc = pq(html)</span><br><span class="line">print(doc(<span class="string">&#x27;li&#x27;</span>)) <span class="comment">#é€‰æ‹©æ‰€æœ‰lièŠ‚ç‚¹</span></span><br></pre></td></tr></table></figure>

<h5 id="URL-åˆå§‹åŒ–"><a href="#URL-åˆå§‹åŒ–" class="headerlink" title="URL åˆå§‹åŒ–"></a>URL åˆå§‹åŒ–</h5><p>å¯ä»¥ä¼ å…¥ç½‘é¡µçš„ URL</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">doc = pq(<span class="string">&#x27;https://cuiqingcai.com&#x27;</span>)</span><br><span class="line">print(doc(<span class="string">&#x27;title&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>PyQueryå¯¹è±¡ä¼šå…ˆè¯·æ±‚è¿™ä¸ªURLï¼Œç„¶åç”¨å¾—åˆ°çš„ HTML å†…å®¹å®Œæˆåˆå§‹åŒ–ï¼Œç›¸å½“äºç½‘é¡µçš„æºç ä»¥å­—ç¬¦ä¸²çš„å½¢å¼ä¼ é€’ç»™ PyQuery ç±»æ¥åˆå§‹åŒ–ï¼Œç›¸å½“äºï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pyquery <span class="keyword">import</span> PyQuery <span class="keyword">as</span> pq</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">doc = pq(requests.get(<span class="string">&#x27;https://cuiqingcai.com&#x27;</span>).text)</span><br><span class="line">print(doc(<span class="string">&#x27;title&#x27;</span>))</span><br></pre></td></tr></table></figure>

<h5 id="æ–‡ä»¶åˆå§‹åŒ–"><a href="#æ–‡ä»¶åˆå§‹åŒ–" class="headerlink" title="æ–‡ä»¶åˆå§‹åŒ–"></a>æ–‡ä»¶åˆå§‹åŒ–</h5><p>å¯ä»¥ä¼ æœ¬åœ°æ–‡ä»¶å</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">doc = pq(filename=<span class="string">&#x27;demo.html&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="åŸºäºCSSé€‰æ‹©å™¨"><a href="#åŸºäºCSSé€‰æ‹©å™¨" class="headerlink" title="åŸºäºCSSé€‰æ‹©å™¨"></a>åŸºäºCSSé€‰æ‹©å™¨</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">html = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;div id=&quot;container&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;ul class=&quot;list&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;li class=&quot;item-0&quot;&gt;first item&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;li class=&quot;item-1&quot;&gt;&lt;a href=&quot;link2.html&quot;&gt;second item&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;li class=&quot;item-0 active&quot;&gt;&lt;a href=&quot;link3.html&quot;&gt;&lt;span class=&quot;bold&quot;&gt;third item&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;li class=&quot;item-1 active&quot;&gt;&lt;a href=&quot;link4.html&quot;&gt;fourth item&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;li class=&quot;item-0&quot;&gt;&lt;a href=&quot;link5.html&quot;&gt;fifth item&lt;/a&gt;&lt;/li&gt;</span></span><br><span class="line"><span class="string">&lt;/ul&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">doc = pq(html)</span><br><span class="line">print(doc(<span class="string">&#x27;#container .list li&#x27;</span>))</span><br><span class="line">print(<span class="built_in">type</span>(doc(<span class="string">&#x27;#container .list li&#x27;</span>))) <span class="comment">#pyquery.pyquery.PyQuery</span></span><br></pre></td></tr></table></figure>

<p>å…ˆé€‰å– id ä¸º container çš„èŠ‚ç‚¹ï¼Œç„¶åå†é€‰å–å…¶å†…éƒ¨çš„ class ä¸º list çš„èŠ‚ç‚¹å†…éƒ¨çš„æ‰€æœ‰ li èŠ‚ç‚¹</p>
<h6 id="æŸ¥æ‰¾èŠ‚ç‚¹"><a href="#æŸ¥æ‰¾èŠ‚ç‚¹" class="headerlink" title="æŸ¥æ‰¾èŠ‚ç‚¹"></a>æŸ¥æ‰¾èŠ‚ç‚¹</h6><p>å¸¸ç”¨æŸ¥è¯¢å‡½æ•°å’Œ jQuery ä¸­å‡½æ•°çš„ç”¨æ³•å®Œå…¨ç›¸åŒ</p>
<h6 id="å­èŠ‚ç‚¹-1"><a href="#å­èŠ‚ç‚¹-1" class="headerlink" title="å­èŠ‚ç‚¹"></a>å­èŠ‚ç‚¹</h6><p>æŸ¥æ‰¾å­èŠ‚ç‚¹éœ€è¦ç”¨åˆ° find() æ–¹æ³•ï¼Œä¼ å…¥å‚æ•°æ˜¯ CSS é€‰æ‹©å™¨</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">items = doc(<span class="string">&#x27;.list&#x27;</span>) <span class="comment">#é€‰å–classä¸ºlistçš„èŠ‚ç‚¹</span></span><br><span class="line">lis = items.find(<span class="string">&#x27;li&#x27;</span>)<span class="comment">#é€‰å–å†…éƒ¨lièŠ‚ç‚¹</span></span><br><span class="line">print(lis)</span><br></pre></td></tr></table></figure>

<p>å…¶å® find() æŸ¥æ‰¾èŒƒå›´æ˜¯èŠ‚ç‚¹çš„æ‰€æœ‰å­å­™èŠ‚ç‚¹ï¼Œå¦‚æœåªæƒ³æŸ¥æ‰¾å­èŠ‚ç‚¹å¯ä»¥ç”¨ children()</p>
<p>å¦‚æœè¦ç­›é€‰æ‰€æœ‰å­èŠ‚ç‚¹ä¸­ç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹ï¼Œæ¯”å¦‚èŠ‚ç‚¹ä¸­ class ä¸º active çš„èŠ‚ç‚¹ï¼Œå¯ä»¥åƒ children() æ–¹æ³•ä¼ å…¥ CSS é€‰æ‹©å™¨ .active</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lis = items.children(<span class="string">&#x27;.active&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h6 id="çˆ¶èŠ‚ç‚¹-1"><a href="#çˆ¶èŠ‚ç‚¹-1" class="headerlink" title="çˆ¶èŠ‚ç‚¹"></a>çˆ¶èŠ‚ç‚¹</h6><p>å¯ä»¥ç”¨ parent() æ–¹æ³•æ¥è·å–æŸä¸ªèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">doc = pq(html)</span><br><span class="line">items = doc(<span class="string">&#x27;.list&#x27;</span>) <span class="comment">#type: pyquery</span></span><br><span class="line">print(<span class="built_in">type</span>(items))</span><br><span class="line">container = items.parent()</span><br><span class="line">print(container)</span><br><span class="line"><span class="comment">#å…ˆé€‰å–classä¸ºlistçš„èŠ‚ç‚¹</span></span><br></pre></td></tr></table></figure>

<p>æƒ³è¦è·å–ç¥–å…ˆèŠ‚ç‚¹ç”¨ parents()</p>
<p>æƒ³è¦ç­›é€‰æŸä¸ªç¥–å…ˆèŠ‚ç‚¹ï¼Œå‘ parents() ä¼ å…¥ CSS é€‰æ‹©å™¨ï¼Œè¿™æ ·å°±ä¼šè¿”å›ç¥–å…ˆèŠ‚ç‚¹ä¸­ç¬¦åˆ CSS é€‰æ‹©å™¨çš„èŠ‚ç‚¹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">parent = items.parents(<span class="string">&#x27;.wrap&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h6 id="å…„å¼ŸèŠ‚ç‚¹"><a href="#å…„å¼ŸèŠ‚ç‚¹" class="headerlink" title="å…„å¼ŸèŠ‚ç‚¹"></a>å…„å¼ŸèŠ‚ç‚¹</h6><p>siblings() æ–¹æ³•</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">li = doc(<span class="string">&#x27;.list .item-0.active&#x27;</span>) <span class="comment">#type: pyquery</span></span><br><span class="line">print(li.siblings())</span><br><span class="line">print(li.siblings(<span class="string">&#x27;.active&#x27;</span>))<span class="comment">#ç­›é€‰classä¸ºactiveçš„èŠ‚ç‚¹</span></span><br></pre></td></tr></table></figure>

<p>é€‰æ‹© class ä¸º list çš„èŠ‚ç‚¹ï¼Œå†…éƒ¨çš„ class ä¸º item-0 å’Œ active çš„èŠ‚ç‚¹</p>
<h6 id="éå†"><a href="#éå†" class="headerlink" title="éå†"></a>éå†</h6><p>pyquery åº“çš„é€‰æ‹©ç»“æœå¯èƒ½æ˜¯å¤šä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿå¯èƒ½æ˜¯å•ä¸ªèŠ‚ç‚¹ï¼Œç±»å‹éƒ½æ˜¯ PyQuery ç±»å‹</p>
<p>å•ä¸ªèŠ‚ç‚¹å¯ä»¥ç›´æ¥æ‰“å°è¾“å‡ºï¼Œä¹Ÿå¯ç›´æ¥è½¬æˆå­—ç¬¦ä¸²</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">li = doc(<span class="string">&#x27;.item-0.active&#x27;</span>)</span><br><span class="line">print(li)</span><br><span class="line">print(<span class="built_in">str</span>(li))</span><br></pre></td></tr></table></figure>

<p>éå†ï¼Œè°ƒç”¨ items() æ–¹æ³•ï¼Œå¾—åˆ°ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œéå†ä¸‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lis = doc(<span class="string">&#x27;li&#x27;</span>).items</span><br><span class="line"><span class="keyword">for</span> li <span class="keyword">in</span> lis:</span><br><span class="line">	print(li)</span><br></pre></td></tr></table></figure>

<h5 id="è·å–ä¿¡æ¯"><a href="#è·å–ä¿¡æ¯" class="headerlink" title="è·å–ä¿¡æ¯"></a>è·å–ä¿¡æ¯</h5><ol>
<li>è·å–å±æ€§</li>
</ol>
<p>è°ƒç”¨ attr() æ–¹æ³•è·å–å±æ€§</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = doc(<span class="string">&#x27;.item-0.active a&#x27;</span>)<span class="comment">#classä¸ºitem-0å’Œactiveçš„lièŠ‚ç‚¹å†…çš„aèŠ‚ç‚¹</span></span><br><span class="line">print(a.attr(<span class="string">&#x27;href&#x27;</span>))<span class="comment">#è°ƒç”¨attræ–¹æ³•ä¼ å…¥å±æ€§çš„åç§°</span></span><br><span class="line"><span class="comment">#ä¹Ÿå¯è°ƒç”¨attrå±æ€§æ¥è·å–</span></span><br><span class="line">print(a.attr.href)</span><br></pre></td></tr></table></figure>

<p>å¤šä¸ªèŠ‚ç‚¹è°ƒç”¨attr()æ–¹æ³•åªè¿”å›ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å±æ€§ï¼Œè·å–æ‰€æœ‰çš„éœ€è¦éå†</p>
<ol start="2">
<li>è·å–æ–‡æœ¬</li>
</ol>
<p>text() æ–¹æ³•</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(a.text())</span><br></pre></td></tr></table></figure>

<p>è·å–å†…éƒ¨ HTML æ–‡æœ¬ï¼Œhtml() æ–¹æ³•</p>
<h5 id="èŠ‚ç‚¹æ“ä½œ"><a href="#èŠ‚ç‚¹æ“ä½œ" class="headerlink" title="èŠ‚ç‚¹æ“ä½œ"></a>èŠ‚ç‚¹æ“ä½œ</h5><p>pyquery æä¾›äº†ä¸€ç³»åˆ—æ–¹æ³•å¯¹èŠ‚ç‚¹è¿›è¡ŒåŠ¨æ€ä¿®æ”¹</p>
<ul>
<li>addClass removeClass</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">li = doc(<span class="string">&#x27;.item-0.active&#x27;</span>)</span><br><span class="line">li.removeClass(<span class="string">&#x27;active&#x27;</span>)</span><br><span class="line">li.addClass(<span class="string">&#x27;active&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>attrã€textã€html</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">li = doc(<span class="string">&#x27;.item-0 .active&#x27;</span>)</span><br><span class="line">li.attr(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;link&#x27;</span>)</span><br><span class="line">li.text(<span class="string">&#x27;change item&#x27;</span>)</span><br><span class="line">li.html(<span class="string">&#x27;&lt;span&gt;change item&lt;/span&gt;&#x27;</span>)</span><br><span class="line"><span class="comment">#è°ƒç”¨ attr æ–¹æ³•å lièŠ‚ç‚¹å¤šäº†ä¸ªåŸæœ¬ä¸å­˜åœ¨å±æ€§ name å€¼ä¸ºlink</span></span><br><span class="line"><span class="comment">#è°ƒç”¨atträ¿®æ”¹å±æ€§ text htmlä¿®æ”¹èŠ‚ç‚¹å†…éƒ¨å†…å®¹</span></span><br></pre></td></tr></table></figure>

<ul>
<li>remove</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">html = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;div class=&quot;wrap&quot;&gt;</span></span><br><span class="line"><span class="string">  Hello,world</span></span><br><span class="line"><span class="string">  &lt;p&gt;This is a paragraph&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">doc = pq(html)</span><br><span class="line">wrap = doc(<span class="string">&#x27;.wrap&#x27;</span>)</span><br><span class="line">print(wrap.text())</span><br><span class="line"><span class="comment">#ç»“æœHello,world This is a paragraph</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wrap.find(<span class="string">&#x27;p&#x27;</span>).remove() <span class="comment">#é€‰å–pèŠ‚ç‚¹ï¼Œç„¶åè°ƒç”¨removeæ–¹æ³•å°†å…¶ç§»é™¤</span></span><br><span class="line">print(wrap.text())</span><br></pre></td></tr></table></figure>

<p>è¿˜æœ‰å…¶å®ƒèŠ‚ç‚¹æ“ä½œæ–¹æ³• append() empty() prepend()</p>
<p>å‚è€ƒ <a target="_blank" rel="noopener" href="http://pyquery.readthedocs.io/en/latest/api.html">http://pyquery.readthedocs.io/en/latest/api.html</a></p>
<ul>
<li>ä¼ªç±»é€‰æ‹©å™¨</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">doc(<span class="string">&#x27;li:first-child&#x27;</span>)<span class="comment">#ç¬¬ä¸€ä¸ªlièŠ‚ç‚¹</span></span><br><span class="line">doc(<span class="string">&#x27;li:last-child&#x27;</span>)<span class="comment">#æœ€åä¸€ä¸ªlièŠ‚ç‚¹</span></span><br><span class="line">doc(<span class="string">&#x27;li:nth-child(2)&#x27;</span>)<span class="comment">#ç¬¬äºŒä¸ªlièŠ‚ç‚¹</span></span><br><span class="line">doc(<span class="string">&#x27;li:gt(2)&#x27;</span>)<span class="comment">#ç¬¬ä¸‰ä¸ªliä¹‹åçš„èŠ‚ç‚¹</span></span><br><span class="line">doc(<span class="string">&#x27;li:nth-child(2n)&#x27;</span>)<span class="comment">#å¶æ•°ä½çš„lièŠ‚ç‚¹</span></span><br><span class="line">doc(<span class="string">&#x27;li:contains(second)&#x27;</span>)<span class="comment">#åŒ…å«secondæ–‡æœ¬çš„lièŠ‚ç‚¹</span></span><br></pre></td></tr></table></figure>

<h4 id=""><a href="#" class="headerlink" title=""></a></h4><h4 id="parsel"><a href="#parsel" class="headerlink" title="parsel"></a>parsel</h4><p>æ”¯æŒä½¿ç”¨ XPath å’Œ CSS é€‰æ‹©å™¨å¯¹å†…å®¹è¿›è¡Œä¿®æ”¹å’Œæå–ï¼ŒåŒæ—¶è¿˜èåˆäº†æ­£åˆ™è¡¨è¾¾å¼çš„æå–åŠŸèƒ½</p>
<p>Scrapy æ¡†æ¶çš„é€‰æ‹©å™¨å°±æ˜¯åŸºäº parsel åšçš„äºŒæ¬¡å°è£…</p>
<h5 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h5><p>ä¸€èˆ¬ä¼šç”¨ parsel åº“é‡Œçš„ Selector å£°æ˜ä¸€ä¸ª Selector å¯¹è±¡</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> parsel <span class="keyword">import</span> Selector</span><br><span class="line">html = <span class="string">&#x27;xxxx&#x27;</span></span><br><span class="line">selector = Selector(text=html)</span><br></pre></td></tr></table></figure>

<p>æœ‰äº† Selector å¯¹è±¡å°±å¯ä»¥ä½¿ç”¨ css he xpath æ–¹æ³•åˆ†åˆ«ä¼ å…¥ CSSé€‰æ‹©å™¨å’ŒXPathè¿›è¡Œæå–</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">items = selector.css(<span class="string">&#x27;.item-0&#x27;</span>)</span><br><span class="line">items2 = selector.xpath(<span class="string">&#x27;//li[contains(@class, &quot;item-0&quot;)]&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>ç»“æœéƒ½æ˜¯ SelectorList å¯¹è±¡</p>
<h5 id="æå–æ–‡æœ¬"><a href="#æå–æ–‡æœ¬" class="headerlink" title="æå–æ–‡æœ¬"></a>æå–æ–‡æœ¬</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> parsel <span class="keyword">import</span> Selector</span><br><span class="line">html = <span class="string">&#x27;xxx&#x27;</span></span><br><span class="line">selector = Selector(text=html)</span><br><span class="line">items = selector.css(<span class="string">&#x27;.item-0&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">  text = item.xpath(<span class="string">&#x27;.//text()&#x27;</span>).get()</span><br><span class="line">  print(text)</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œç”¨ <code>.//text()</code>  è¿™ä¸ª xpath å†™æ³•æå–äº†å½“å‰èŠ‚ç‚¹çš„æ‰€æœ‰å†…å®¹ï¼Œæ­¤æ—¶å¦‚æœä¸å†è°ƒç”¨å…¶å®ƒæ–¹æ³•ï¼Œé‚£ä¹ˆè¿”å›çš„ç»“æœä¾ç„¶ä¸º Selector æ„æˆçš„å¯è¿­ä»£å¯¹è±¡ SelectorList</p>
<p>SelectorList æœ‰ä¸€ä¸ª get æ–¹æ³•ï¼Œå¯ä»¥å°† SelectorList åŒ…å«çš„ Selector å¯¹è±¡ä¸­çš„å†…å®¹æå–å‡ºæ¥</p>
<p>get æ–¹æ³•çš„ä½œç”¨æ˜¯ ä» SelectorList é‡Œé¢æå–ç¬¬ä¸€ä¸ª Selector å¯¹è±¡ï¼Œç„¶åè¾“å‡ºå…¶ä¸­ç»“æœ</p>
<p>å¦‚æœæå–æ‰€æœ‰çš„ Selectorï¼Œä½¿ç”¨ getall æ–¹æ³•ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">result = selector.css(<span class="string">&#x27;.item-0 *::text&#x27;</span>).getall()</span><br><span class="line"><span class="comment">#è¿™é‡Œ *ç”¨æ¥æå–æ‰€æœ‰å­èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬çº¯æ–‡æœ¬èŠ‚ç‚¹ï¼‰æå–æ–‡æœ¬éœ€è¦åŠ ä¸Š ::text</span></span><br></pre></td></tr></table></figure>

<h5 id="æå–å±æ€§"><a href="#æå–å±æ€§" class="headerlink" title="æå–å±æ€§"></a>æå–å±æ€§</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">result = selector.css(<span class="string">&#x27;.item-0.active a::attr(href)&#x27;</span>).get()</span><br><span class="line">result = selector.xpath(<span class="string">&#x27;//li[contains(@class,&quot;item-0&quot;) and contains(@class, &quot;active&quot;)]/a/@href&#x27;</span>).get()</span><br></pre></td></tr></table></figure>

<p>å¯¹äº CSS é€‰æ‹©å™¨ï¼Œé€‰å–å±æ€§éœ€è¦åŠ  ::attr()ï¼Œå¹¶ä¼ å…¥å¯¹åº”çš„å±æ€§åç§°æ‰å¯é€‰å–ï¼Œå¯¹äº XPathï¼Œç›´æ¥ç”¨ /@å†åŠ å±æ€§åç§°å³å¯é€‰å–</p>
<h5 id="æ­£åˆ™æå–"><a href="#æ­£åˆ™æå–" class="headerlink" title="æ­£åˆ™æå–"></a>æ­£åˆ™æå–</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = selector.css(<span class="string">&#x27;.item-0&#x27;</span>).re(<span class="string">&#x27;link.*&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå…ˆç”¨ css æ–¹æ³•æå–äº†æ‰€æœ‰ class åŒ…å« item-0 çš„èŠ‚ç‚¹ï¼Œç„¶åç”¨ re æ–¹æ³•ä¼ å…¥ link.* ç”¨æ¥åŒ¹é…åŒ…å«link çš„æ‰€æœ‰ç»“æœ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = selector.css(<span class="string">&#x27;.item-0 *::text&#x27;</span>).re(<span class="string">&#x27;.*item&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ç”¨ re_first æ–¹æ³•æ¥æå–ç¬¬ä¸€ä¸ªç¬¦åˆè§„åˆ™çš„ç»“æœ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = selector.css(<span class="string">&#x27;.item-0&#x27;</span>).re_first(<span class="string">&#x27;&lt;span class=&quot;bold&quot;&gt;(.*?)&lt;/span&gt;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨äº† re_first æ–¹æ³•ï¼Œæå–çš„æ˜¯è¢« span æ ‡ç­¾åŒ…å«çš„æ–‡æœ¬å€¼ï¼Œæå–ç»“æœç”¨å°æ‹¬å·æ‹¬èµ·æ¥è¡¨ç¤ºä¸€ä¸ªæå–åˆ†ç»„ï¼Œæœ€åè¾“å‡ºçš„ç»“æœå°±æ˜¯å°æ‹¬å·åŒ…å›´çš„éƒ¨åˆ†</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/11/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-2%E5%9F%BA%E6%9C%AC%E5%BA%93%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="daxun">
      <meta itemprop="description" content="ç®€å•è®°å½•ä¸‹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/11/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-2%E5%9F%BA%E6%9C%AC%E5%BA%93%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">Python3ç½‘ç»œçˆ¬è™«å¼€å‘å®æˆ˜-2åŸºæœ¬åº“ä½¿ç”¨</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2022-04-11 16:35:56" itemprop="dateCreated datePublished" datetime="2022-04-11T16:35:56+08:00">2022-04-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-10-09 08:57:19" itemprop="dateModified" datetime="2022-10-09T08:57:19+08:00">2022-10-09</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>urllibã€request</p>
<h4 id="2-åŸºæœ¬åº“ä½¿ç”¨"><a href="#2-åŸºæœ¬åº“ä½¿ç”¨" class="headerlink" title="2. åŸºæœ¬åº“ä½¿ç”¨"></a>2. åŸºæœ¬åº“ä½¿ç”¨</h4><h4 id="urllib"><a href="#urllib" class="headerlink" title="urllib"></a>urllib</h4><p>Pythonå†…ç½® HTTP è¯·æ±‚åº“ï¼ŒåŒ…å«4ä¸ªæ¨¡å—</p>
<ul>
<li>request</li>
</ul>
<p>åŸºæœ¬ HTTP è¯·æ±‚æ¨¡å—ï¼Œç”¨æ¥æ¨¡æ‹Ÿå‘é€è¯·æ±‚</p>
<ul>
<li>error</li>
</ul>
<p>å¼‚å¸¸å¤„ç†ï¼Œå¦‚æœå‡ºç°è¯·æ±‚é”™è¯¯ï¼Œå¯ä»¥æ•è·è¿™äº›å¼‚å¸¸</p>
<ul>
<li>parse</li>
</ul>
<p>å·¥å…·æ¨¡å—ï¼Œæä¾›äº†è®¸å¤š URL å¤„ç†æ–¹æ³• å¦‚æ‹†åˆ†ã€è§£æã€åˆå¹¶</p>
<ul>
<li>robotparser</li>
</ul>
<p>è¯†åˆ«ç½‘ç«™ robots.txt æ–‡ä»¶ï¼Œç„¶ååˆ¤æ–­å“ªäº›ç½‘ç«™å¯ä»¥çˆ¬ï¼Œå®é™…ç”¨çš„å°‘</p>
<h5 id="å‘é€è¯·æ±‚"><a href="#å‘é€è¯·æ±‚" class="headerlink" title="å‘é€è¯·æ±‚"></a>å‘é€è¯·æ±‚</h5><h6 id="urlopen"><a href="#urlopen" class="headerlink" title="urlopen()"></a>urlopen()</h6><p>å¯ä»¥å®Œæˆç®€å•è¯·æ±‚å’Œç½‘é¡µæŠ“å–</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> http.client <span class="keyword">import</span> HTTPResponse</span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"></span><br><span class="line">ssl._create_default_https_context = ssl._create_unverified_context</span><br><span class="line">response = urllib.request.urlopen(<span class="string">&#x27;https://www.python.org&#x27;</span>) <span class="comment">#type: HTTPResponse</span></span><br><span class="line">print(<span class="built_in">type</span>(response)) <span class="comment">#&lt;class &#x27;http.client.HTTPResponse&#x27;&gt;</span></span><br><span class="line">print(response.read().decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">print(response.status) <span class="comment">#200</span></span><br><span class="line">print(response.getheaders())</span><br><span class="line">print(response.getheader(<span class="string">&#x27;Server&#x27;</span>)) <span class="comment">#nginx</span></span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨ read() æ–¹æ³•å¯ä»¥å¾—åˆ°è¿”å›çš„ç½‘é¡µå†…å®¹</p>
<blockquote>
<p>response æ•²å±æ€§ä»£ç æ²¡æç¤ºï¼ŒåŠ ä¸Šç±»å‹æ³¨é‡Š #type: HTTPResponse</p>
<p>æˆ–è€…ä½¿ç”¨ isinstance æŒ‡å®š assert isinstance(response, HTTPResponse)</p>
</blockquote>
<p>urlopen çš„å‚æ•° </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">urlopen(url, data=<span class="literal">None</span>, timeout=socket._GLOBAL_DEFAULT_TIMEOUT,*, cafile=<span class="literal">None</span>, capath=<span class="literal">None</span>, cadefault=<span class="literal">False</span>, context=<span class="literal">None</span>)</span><br></pre></td></tr></table></figure>

<h6 id="dataå‚æ•°"><a href="#dataå‚æ•°" class="headerlink" title="dataå‚æ•°"></a>dataå‚æ•°</h6><p>å¯é€‰ï¼Œéœ€è¦ä½¿ç”¨ bytes() æ–¹æ³•å°†å‚æ•°è½¬åŒ–ä¸ºå­—èŠ‚æµç¼–ç æ ¼å¼çš„å†…å®¹ï¼Œå³ bytes ç±»å‹ã€‚</p>
<p>å¦‚æœä¼ é€’äº†è¿™ä¸ªå‚æ•°ï¼Œé‚£ä¹ˆå®ƒçš„è¯·æ±‚æ–¹å¼ä¸å†æ˜¯ GETï¼Œè€Œæ˜¯ POST äº†</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> http.client <span class="keyword">import</span> HTTPResponse</span><br><span class="line"></span><br><span class="line">data = <span class="built_in">bytes</span>(urllib.parse.urlencode(&#123;<span class="string">&#x27;word&#x27;</span>: <span class="string">&#x27;hello&#x27;</span>&#125;),encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">response = urllib.request.urlopen(<span class="string">&#x27;http://httpbin.org/post&#x27;</span>, data=data) <span class="comment">#type: HTTPResponse</span></span><br><span class="line">print(response.read().decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>byte() æ–¹æ³•ç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦ str ç±»å‹ï¼Œéœ€è¦ç”¨ urllib.parse æ¨¡å—é‡Œçš„ urlencode() æ–¹æ³•å°†å‚æ•°å­—å…¸è½¬åŒ–ä¸ºå­—ç¬¦ä¸²ï¼›ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šç¼–ç æ ¼å¼</p>
<p>ç«™ç‚¹ <a target="_blank" rel="noopener" href="http://httpbin.org/post">http://httpbin.org/post</a>  å¯ä»¥æä¾› HTTP è¯·æ±‚æµ‹è¯•</p>
<h6 id="timeoutå‚æ•°"><a href="#timeoutå‚æ•°" class="headerlink" title="timeoutå‚æ•°"></a>timeoutå‚æ•°</h6><p>è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå•ä½ç§’ï¼Œè¯·æ±‚è¶…å‡ºè®¾ç½®çš„æ—¶é—´è¿˜æ²¡æœ‰å¾—åˆ°å“åº”ï¼ŒæŠ›å‡ºå¼‚å¸¸</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">import</span> urllib.error</span><br><span class="line"><span class="keyword">from</span> http.client <span class="keyword">import</span> HTTPResponse</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = urllib.request.urlopen(<span class="string">&#x27;http://httpbin.org/get&#x27;</span>, timeout=<span class="number">0.1</span>)<span class="comment">#type: HTTPResponse</span></span><br><span class="line"><span class="keyword">except</span> urllib.error.URLError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(e.reason, socket.timeout):</span><br><span class="line">        print(<span class="string">&#x27;TIME OUT&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>å…¶å®ƒå‚æ•°</li>
</ul>
<p>context å‚æ•°ï¼šå¿…é¡»æ˜¯ ssl.SSLContext ç±»å‹ï¼Œç”¨æ¥æŒ‡å®š SSL è®¾ç½®</p>
<p>cafile å’Œ capath ï¼šåˆ†åˆ«æŒ‡å®š CA è¯ä¹¦ å’Œ å®ƒçš„è·¯å¾„ï¼Œè¿™ä¸ªåœ¨è¯·æ±‚ HTTPS é“¾æ¥æ—¶ä¼šæœ‰ç”¨</p>
<h6 id="Request"><a href="#Request" class="headerlink" title="Request"></a>Request</h6><p>åˆ©ç”¨ urlopen æ–¹æ³•å¯ä»¥å‘èµ·æœ€åŸºæœ¬çš„è¯·æ±‚ï¼Œä½†å®ƒå‡ ä¸ªç®€å•çš„å‚æ•°å¹¶ä¸è¶³ä»¥æ„å»ºä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚ï¼Œå¦‚æœéœ€è¦ Headers ç­‰ä¿¡æ¯ï¼Œå¯ä»¥åˆ©ç”¨æ›´åŠ å¼ºå¤§çš„ Resquest ç±»æ¥æ„å»º</p>
<p>åˆ©ç”¨ Request å¯ä»¥å°†è¯·æ±‚ç‹¬ç«‹æˆä¸€ä¸ªå¯¹è±¡ï¼Œæ›´åŠ ä¸°å¯Œçš„é…ç½®å‚æ•°</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"><span class="keyword">from</span> http.client <span class="keyword">import</span> HTTPResponse</span><br><span class="line"></span><br><span class="line">request = urllib.request.Request(<span class="string">&#x27;https://python.org&#x27;</span>)</span><br><span class="line">response = urllib.request.urlopen(request) <span class="comment">#type: HTTPResponse</span></span><br><span class="line">print(response.read().decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>Request å‚æ•°ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url, data=<span class="literal">None</span>, headers=&#123;&#125;,origin_req_host=<span class="literal">None</span>, unverifiable=<span class="literal">False</span>,method=<span class="literal">None</span></span><br></pre></td></tr></table></figure>

<p>urlï¼šå¿…ä¼ å‚æ•°ï¼Œå…¶å®ƒéƒ½æ˜¯å¯é€‰</p>
<p>dataï¼šå¦‚æœè¦ä¼ ï¼Œå¿…é¡»ä¼  bytesï¼ˆå­—èŠ‚æµï¼‰ç±»å‹çš„ï¼Œå¦‚æœå®ƒæ˜¯å­—å…¸ï¼Œå…ˆç”¨ urllib.parse æ¨¡å—é‡Œçš„ urlenode() ç¼–ç </p>
<p>headersï¼š æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œå¯ä»¥åœ¨æ„å»ºè¯·æ±‚æ—¶é€šè¿‡ headers ç›´æ¥æ„å»ºï¼Œä¹Ÿå¯é€šè¿‡è°ƒç”¨è¯·æ±‚å®ä¾‹çš„ add_header()æ–¹æ³•æ·»åŠ ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹ User-Agent æ¥ä¼ªè£…æµè§ˆå™¨ï¼Œé»˜è®¤æ˜¯ Python-urllib</p>
<p>origin_req_hostï¼šè¯·æ±‚æ–¹ host åç§°æˆ– IP åœ°å€</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> http.client <span class="keyword">import</span> HTTPResponse</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://httpbin.org/post&#x27;</span></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/4.0 (compatible)&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Host&#x27;</span>: <span class="string">&#x27;httpbin.org&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">dict</span> = &#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Germey&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">data = <span class="built_in">bytes</span>(urllib.parse.urlencode(<span class="built_in">dict</span>), encoding=<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">req = request.Request(url=url, data=data, headers=headers, method=<span class="string">&#x27;POST&#x27;</span>)</span><br><span class="line">response = request.urlopen(req) <span class="comment"># type:HTTPResponse</span></span><br><span class="line">print(response.read().decode(<span class="string">&#x27;utf-8&#x27;</span>))&#125;</span><br></pre></td></tr></table></figure>

<p>unverifiableï¼šè¿™ä¸ªè¯·æ±‚æ˜¯å¦æ˜¯æ— æ³•éªŒè¯çš„ï¼Œé»˜è®¤ falseï¼Œ</p>
<p>methodï¼šè¯·æ±‚æ–¹æ³• POST GET</p>
<p>headers ä¹Ÿå¯ä»¥ç”¨ add_header() æ–¹æ³•æ·»åŠ </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">req = request.Request(url=url, data=data, method=<span class="string">&#x27;POST&#x27;</span>)</span><br><span class="line">req.add_header(<span class="string">&#x27;User-Agent&#x27;</span>, <span class="string">&#x27;Mozilla/4.0 (compatible; MSIE 5.5; Windows NT)&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h6 id="é«˜çº§ç”¨æ³•"><a href="#é«˜çº§ç”¨æ³•" class="headerlink" title="é«˜çº§ç”¨æ³•"></a>é«˜çº§ç”¨æ³•</h6><p>æ›´é«˜çº§çš„æ“ä½œï¼ˆCookieå¤„ç†ã€è®¾ç½®ä»£ç†ï¼‰è¯¥æ€ä¹ˆæ“ä½œï¼Ÿä½¿ç”¨ Handlerï¼Œå¯ä»¥ç†è§£ä¸ºå„ç§å¤„ç†å™¨</p>
<p>urllib.request æ¨¡å—é‡Œçš„ BaseHandler ç±»æ˜¯æ‰€æœ‰ Handler çš„çˆ¶ç±»</p>
<p>å­ç±»ï¼š</p>
<p>HTTPDefaultErrorHandlerï¼šå¤„ç† HTTP å“åº”é”™è¯¯ï¼Œé”™è¯¯ä¼šæŠ›å‡º HTTPError ç±»å‹å¼‚å¸¸</p>
<p>HTTPRedirectHandlerï¼šç”¨äºå¤„ç†é‡å®šå‘</p>
<p>HTTPCookieProcessorï¼šç”¨äºå¤„ç† Cookies</p>
<p>ProxyHandlerï¼šç”¨äºè®¾ç½®ä»£ç†</p>
<p>HTTPPasswordMgrï¼šç”¨äºç®¡ç†å¯†ç </p>
<p>HTTPBasicAuthHandlerï¼šç”¨äºç®¡ç†è®¤è¯ï¼Œå¦‚æœä¸€ä¸ªé“¾æ¥æ‰“å¼€æ—¶éœ€è¦è®¤è¯ï¼Œå¯ä»¥ç”¨å®ƒæ¥è§£å†³è®¤è¯é—®é¢˜</p>
<p>OpenerDirectorï¼šå¯ä»¥ç§°ä¸º Openerï¼Œä¹‹å‰ç”¨è¿‡çš„ urlopen æ–¹æ³•ï¼Œå®é™…ä¸Šå°±æ˜¯ urllib åº“ä¸ºæˆ‘ä»¬æä¾›çš„ä¸€ä¸ª Opener</p>
<p>ç”¨æ³•ï¼šç™»å½•éªŒè¯ã€ä»£ç†ã€Cookie</p>
<h6 id="ç™»å½•éªŒè¯"><a href="#ç™»å½•éªŒè¯" class="headerlink" title="ç™»å½•éªŒè¯"></a>ç™»å½•éªŒè¯</h6><p>è®¿é—®æŸäº›ç½‘ç«™ï¼š<a target="_blank" rel="noopener" href="https://ssr3.scrape.center/">https://ssr3.scrape.center/</a> å¯èƒ½ä¼šå¼¹å‡ºè¿™æ ·çš„è®¤è¯çª—å£ï¼Œè¡¨ç¤ºè¿™ä¸ªç½‘ç«™å¯ç”¨äº†åŸºæœ¬èº«ä»½è®¤è¯</p>
<p><img src="/Users/caodaxun/hexo/source/_posts/Python3%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E5%BC%80%E5%8F%91%E5%AE%9E%E6%88%98-2%E5%9F%BA%E6%9C%AC%E5%BA%93%E4%BD%BF%E7%94%A8/1.png" alt="1"></p>
<p>çˆ¬å–è¿™æ ·çš„é¡µé¢ï¼Œå€ŸåŠ© HTTPBasicAuthHandler æ¨¡å—å°±å¯ä»¥å®Œæˆ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> HTTPPasswordMgrWithDefaultRealm,HTTPBasicAuthHandler, build_opener</span><br><span class="line"><span class="keyword">from</span> urllib.error <span class="keyword">import</span> URLError</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    username = <span class="string">&#x27;admin&#x27;</span></span><br><span class="line">    password = <span class="string">&#x27;admin&#x27;</span></span><br><span class="line">    url = <span class="string">&#x27;https://ssr3.scrape.center/&#x27;</span></span><br><span class="line">    p = HTTPPasswordMgrWithDefaultRealm()</span><br><span class="line">    p.add_password(<span class="literal">None</span>, url, username, password)</span><br><span class="line">    auth_handler = HTTPBasicAuthHandler(p)</span><br><span class="line">    opener = build_opener(auth_handler)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        result = opener.<span class="built_in">open</span>(url)</span><br><span class="line">        html = result.read().decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        print(html)</span><br><span class="line">    <span class="keyword">except</span> URLError <span class="keyword">as</span> e:</span><br><span class="line">        print(e.reason)</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆå®ä¾‹åŒ– HTTPBasicAuthHandler å¯¹è±¡ auth_handlerï¼Œå‚æ•°æ˜¯ HTTPPasswordMgrWithDefaultRealmï¼Œåˆ©ç”¨ add_password æ–¹æ³•æ·»åŠ ç”¨æˆ·åå’Œå¯†ç ï¼Œè¿™æ ·å°±å»ºç«‹äº†ä¸€ä¸ªç”¨æ¥å¤„ç†éªŒè¯çš„ Handler ç±»</p>
<p>ç„¶åå°† auth_handler å½“ä½œå‚æ•°ä¼ å…¥ build_openerï¼Œæ„å»ºä¸€ä¸ª Openerã€‚æœ€ååˆ©ç”¨ Opener ç±»ä¸­çš„ Open æ–¹æ³•æ‰“å¼€é“¾æ¥ï¼Œå³å¯å®ŒæˆéªŒè¯</p>
<h6 id="ä»£ç†"><a href="#ä»£ç†" class="headerlink" title="ä»£ç†"></a>ä»£ç†</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> ProxyHandler, build_opener</span><br><span class="line"><span class="keyword">from</span> urllib.error <span class="keyword">import</span> URLError</span><br><span class="line"></span><br><span class="line">proxy_handler = ProxyHandler(&#123;</span><br><span class="line">    <span class="string">&#x27;http&#x27;</span>: <span class="string">&#x27;http://127.0.0.1:8080&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;https&#x27;</span>: <span class="string">&#x27;https://127.0.0.1:8080&#x27;</span></span><br><span class="line">&#125;)</span><br><span class="line">opener = build_opener(proxy_handler)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = opener.<span class="built_in">open</span>(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line">    print(response.read().decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"><span class="keyword">except</span> URLError <span class="keyword">as</span> e:</span><br><span class="line">    print(e.reason)</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œäº‹å…ˆåœ¨æœ¬åœ°æ­å»ºä¸€ä¸ª HTTP ä»£ç†ï¼Œå¹¶è®©å…¶è¿è¡Œåœ¨ 8080 ç«¯å£ä¸Š</p>
<p>ProxyHandlerï¼Œå‚æ•°æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œå¥åæ˜¯åè®®ç±»å‹ï¼Œé”®å€¼æ˜¯ä»£ç†é“¾æ¥ï¼Œå¯ä»¥æ·»åŠ å¤šä¸ªä»£ç†</p>
<p>ç„¶ååˆ©ç”¨è¿™ä¸ª Handler å’Œ build_opener æ–¹æ³•æ„å»ºä¸€ä¸ª Openerï¼Œä¹‹åå‘é€è¯·æ±‚å³å¯</p>
<h6 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h6><ul>
<li>è·å–ç½‘ç«™ Cookie</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> http.cookiejar, urllib.request</span><br><span class="line"></span><br><span class="line">cookie = http.cookiejar.CookieJar()</span><br><span class="line">handler = urllib.request.HTTPCookieProcessor(cookie)</span><br><span class="line">opener = urllib.request.build_opener(handler)</span><br><span class="line">response = opener.<span class="built_in">open</span>(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> cookie:</span><br><span class="line">    print(item.name + <span class="string">&#x27;=&#x27;</span> + item.value)</span><br></pre></td></tr></table></figure>

<ul>
<li>æ–‡ä»¶æ ¼å¼è¾“å‡º Cookie</li>
</ul>
<p>Cookie å®é™…ä¸Šä¹Ÿæ˜¯ä»¥æ–‡æœ¬å½¢å¼ä¿å­˜çš„</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> http.cookiejar, urllib.request</span><br><span class="line">    </span><br><span class="line">filename = <span class="string">&#x27;cookie.txt&#x27;</span></span><br><span class="line">cookie = http.cookiejar.MozillaCookieJar(filename)</span><br><span class="line">handler = urllib.request.HTTPCookieProcessor(cookie)</span><br><span class="line">opener = urllib.request.build_opener(handler)</span><br><span class="line">response = opener.<span class="built_in">open</span>(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line">cookie.save(ignore_discard=<span class="literal">True</span>, ignore_expires=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>MozillaCookieJar æ˜¯ CookieJar çš„å­ç±»ï¼Œå¯ä»¥ç”¨æ¥å¤„ç†è·Ÿ Cookie å’Œæ–‡ä»¶ç›¸å…³çš„äº‹ä»¶ï¼Œä¾‹å¦‚è¯»å–å’Œä¿å­˜ Cookieï¼Œå¯ä»¥å°† Cookie ä¿å­˜æˆ Mozilla å‹æµè§ˆå™¨çš„ Cookie æ ¼å¼ã€‚è¿è¡Œä¸Šé¢å®ä¾‹åç”Ÿæˆä¸€ä¸ª cookie.txt æ–‡ä»¶</p>
<ul>
<li>LWPCookieJar</li>
</ul>
<p>LWPCookieJar åŒæ ·å¯ä»¥è¯»å–å’Œä¿å­˜ Cookieï¼Œåªæ˜¯ä¿å­˜æ ¼å¼ä¸ä¸€æ ·ï¼Œä¼šä¿å­˜æˆ LWP æ ¼å¼ï¼Œæ”¹æˆï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cookie = http.cookiejar.LWPCookieJar(filename)</span><br></pre></td></tr></table></figure>

<ul>
<li>è¯»å– Cookie</li>
</ul>
<p>LWPCookieJar ä¸ºä¾‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> http.cookiejar, urllib.request</span><br><span class="line">    </span><br><span class="line">cookie = http.cookiejar.LWPCookieJar()</span><br><span class="line">cookie.load(<span class="string">&#x27;cookie.txt&#x27;</span>, ignore_expires=<span class="literal">True</span>, ignore_discard=<span class="literal">True</span>)</span><br><span class="line">handler = urllib.request.HTTPCookieProcessor(cookie)</span><br><span class="line">opener = urllib.request.build_opener(handler)</span><br><span class="line">response = opener.<span class="built_in">open</span>(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line">print(response.read().decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>åˆ©ç”¨ load æ–¹æ³•è¯»å–æœ¬åœ°çš„ Cookie æ–‡ä»¶è·å– Cookie å†…å®¹</p>
<h5 id="å¤„ç†å¼‚å¸¸"><a href="#å¤„ç†å¼‚å¸¸" class="headerlink" title="å¤„ç†å¼‚å¸¸"></a>å¤„ç†å¼‚å¸¸</h5><p>urllib åº“ä¸­çš„ error æ¨¡å—å®šä¹‰äº†ç”± request æ¨¡å—äº§ç”Ÿçš„å¼‚å¸¸</p>
<h6 id="URLError"><a href="#URLError" class="headerlink" title="URLError"></a>URLError</h6><p>ç”± request æ¨¡å—ç”Ÿæˆçš„å¼‚å¸¸éƒ½å¯ä»¥é€šè¿‡æ•è·è¿™ä¸ªç±»æ¥å¤„ç†ï¼Œæœ‰ä¸€ä¸ª reason å±æ€§ï¼Œè¿”å›é”™è¯¯çš„åŸå› </p>
<p>ä¾‹å­ï¼šæ‰“å¼€ä¸€ä¸ªä¸å­˜åœ¨çš„é¡µé¢</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> request,error</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    response = request.urlopen(<span class="string">&#x27;https://cuiqingcai.com/404&#x27;</span>)</span><br><span class="line"><span class="keyword">except</span> error.URLError <span class="keyword">as</span> e:</span><br><span class="line">    print(e.reason) <span class="comment">#Not Found</span></span><br></pre></td></tr></table></figure>

<h6 id="HTTPError"><a href="#HTTPError" class="headerlink" title="HTTPError"></a>HTTPError</h6><p>URLError çš„å­ç±»ï¼Œä¸“é—¨ç”¨æ¥å¤„ç† HTTP è¯·æ±‚é”™è¯¯ï¼Œæ¯”å¦‚è®¤è¯å¤±è´¥ï¼Œæœ‰3ä¸ªå±æ€§ï¼Œcodeï¼Œreasonï¼Œheaders</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">except</span> error.HTTPError <span class="keyword">as</span> e:</span><br><span class="line">    print(e.code, e.reason, e.headers, seq=<span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>URLError æ˜¯ HTTPError çš„çˆ¶ç±»ï¼Œæ‰€ä»¥å…ˆæ•è·å­ç±»é”™è¯¯å†æ•è·çˆ¶ç±»é”™è¯¯ï¼Œæ›´å¥½å†™æ³•å¦‚ä¸‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">except</span> error.HTTPError <span class="keyword">as</span> e:</span><br><span class="line">    print(e.code, e.reason, e.headers, seq=<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"><span class="keyword">except</span> error.URLError <span class="keyword">as</span> e:</span><br><span class="line">    print(e.reason)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    print(<span class="string">&#x27;success&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>reason è¿”å›çš„ä¸ä¸€å®šæ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> request,error</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">...</span><br><span class="line"><span class="keyword">except</span> error.HTTPError <span class="keyword">as</span> e:</span><br><span class="line">  print(<span class="built_in">type</span>(e.reason)) <span class="comment">#&lt;class&#x27;socket.timeout&#x27;&gt;</span></span><br><span class="line">  <span class="keyword">if</span> <span class="built_in">isinstance</span>(e.reason, socket.timeout): <span class="comment">#é€šè¿‡ isinstance åˆ¤æ–­ç±»å‹</span></span><br><span class="line">    print(<span class="string">&#x27;TIME OUT&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h5 id="è§£æé“¾æ¥"><a href="#è§£æé“¾æ¥" class="headerlink" title="è§£æé“¾æ¥"></a>è§£æé“¾æ¥</h5><p>urllib åº“è¿˜æä¾›äº† parse æ¨¡å—ï¼Œå®šä¹‰äº†å¤„ç† URL çš„æ ‡å‡†æ¥å£ï¼Œä¾‹å¦‚å®ç° URL å„éƒ¨åˆ†çš„æŠ½å–ã€åˆå¹¶åŠé“¾æ¥è½¬æ¢</p>
<h6 id="urlparse"><a href="#urlparse" class="headerlink" title="urlparse"></a>urlparse</h6><p>å®ç° URL çš„è¯†åˆ«å’Œåˆ†æ®µ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse</span><br><span class="line">result = urlparse(<span class="string">&#x27;http://www.baidu.com/index.html;user?id=s#comment&#x27;</span>)</span><br><span class="line">print(<span class="built_in">type</span>(result), result)</span><br></pre></td></tr></table></figure>

<p>è¾“å‡º</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">urllib</span>.<span class="title">parse</span>.<span class="title">ParseResult</span>&#x27;&gt; </span></span><br><span class="line"><span class="class"><span class="title">ParseResult</span>(<span class="params">scheme=<span class="string">&#x27;http&#x27;</span>, netloc=<span class="string">&#x27;www.baidu.com&#x27;</span>, path=<span class="string">&#x27;/index.html&#x27;</span>, params=<span class="string">&#x27;user&#x27;</span>, query=<span class="string">&#x27;id=s&#x27;</span>, fragment=<span class="string">&#x27;comment&#x27;</span></span>)</span></span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœæ˜¯ ParseResult ç±»å‹ï¼ŒåŒ…å« 6 ä¸ªéƒ¨åˆ†ï¼Œschemeã€netloc(åŸŸå)ã€pathã€params(å‚æ•°)ã€query(æŸ¥è¯¢æ¡ä»¶)ã€fragment(é”šç‚¹ï¼Œ#å·åé¢)</p>
<p>å¯ä»¥ç”¨å±æ€§åæˆ–è€…ç´¢å¼•é¡ºåºæ¥è·å–</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(result.scheme, result[<span class="number">0</span>], result.netloc, result[<span class="number">1</span>], sep=<span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><code>#</code> åé¢æ˜¯é”šç‚¹ï¼Œç”¨äºç›´æ¥å®šä½é¡µé¢å†…éƒ¨çš„ä¸‹æ‹‰ä½ç½®</p>
<p>urlparse() æœ‰3ä¸ªå‚æ•°ï¼šurlstringã€schemeã€allow_fragments</p>
<p>schemeï¼šhttpæˆ–httpsç­‰ urlstringä¸­ä¸åŒ…å« scheme ä¿¡æ¯æ—¶æ‰ç”Ÿæ•ˆ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result = urlparse(<span class="string">&#x27;www.baidu.com/index.html;user?id=s#comment&#x27;</span>,scheme=<span class="string">&#x27;https&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>allow_fragmentsï¼šå¦‚æœè¢«è®¾ç½®ä¸º falseï¼Œfragment éƒ¨åˆ†å°±ä¼šè¢«å¿½ç•¥</p>
<h6 id="urlunparse"><a href="#urlunparse" class="headerlink" title="urlunparse"></a>urlunparse</h6><p>å‚æ•°æ˜¯ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ï¼Œé•¿åº¦å¿…é¡»æ˜¯6ï¼Œæ„é€ URL</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlunparse</span><br><span class="line">data = [<span class="string">&#x27;http&#x27;</span>,<span class="string">&#x27;www.baidu.com&#x27;</span>,<span class="string">&#x27;index.html&#x27;</span>,<span class="string">&#x27;user&#x27;</span>,<span class="string">&#x27;a=6&#x27;</span>,<span class="string">&#x27;comment&#x27;</span>]</span><br><span class="line">print(urlunparse(data))</span><br><span class="line"><span class="comment">#ç»“æœ</span></span><br><span class="line">http://www.baidu.com/index.html;user?a=6#comment</span><br><span class="line"><span class="comment">#è¿™é‡Œdataç”¨äº†åˆ—è¡¨ç±»å‹ï¼Œä¹Ÿå¯ä»¥ç”¨å…¶å®ƒç±»å‹æ¯”å¦‚å…ƒç»„æˆ–è€…ç‰¹å®šçš„æ•°æ®ç»“æ„</span></span><br></pre></td></tr></table></figure>

<h6 id="urlsplit"><a href="#urlsplit" class="headerlink" title="urlsplit"></a>urlsplit</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlsplit</span><br><span class="line">result = urlsplit(<span class="string">&#x27;http://www.baidu.com/index.html;user?id=s#comment&#x27;</span>)</span><br><span class="line">print(<span class="built_in">type</span>(result), result)</span><br></pre></td></tr></table></figure>

<p>å’Œ urlparse ä½¿ç”¨ç±»ä¼¼ï¼Œä¸è¿‡ä¸å†å•ç‹¬è§£æ params éƒ¨åˆ†ï¼ˆparamsä¼šåˆå¹¶åˆ°pathä¸­ï¼‰ï¼Œåªè¿”å› 5ä¸ª ç»“æœ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="class"><span class="keyword">class</span> &#x27;<span class="title">urllib</span>.<span class="title">parse</span>.<span class="title">SplitResult</span>&#x27;&gt; <span class="title">SplitResult</span>(<span class="params">scheme=<span class="string">&#x27;http&#x27;</span>, netloc=<span class="string">&#x27;www.baidu.com&#x27;</span>, path=<span class="string">&#x27;/index.html;user&#x27;</span>, query=<span class="string">&#x27;id=s&#x27;</span>, fragment=<span class="string">&#x27;comment&#x27;</span></span>)</span></span><br></pre></td></tr></table></figure>

<h6 id="urlunsplit"><a href="#urlunsplit" class="headerlink" title="urlunsplit"></a>urlunsplit</h6><p>å°†é“¾æ¥å„ä¸ªéƒ¨åˆ†ç»„åˆæˆå®Œæˆé“¾æ¥ï¼Œä¼ å…¥å‚æ•°æ˜¯ä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡ï¼Œå¦‚åˆ—è¡¨ã€å…ƒç»„ï¼Œé•¿åº¦å¿…é¡»æ˜¯5</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlunsplit</span><br><span class="line">data = [<span class="string">&#x27;http&#x27;</span>,<span class="string">&#x27;www.baidu.com&#x27;</span>,<span class="string">&#x27;index.html&#x27;</span>,<span class="string">&#x27;a=6&#x27;</span>,<span class="string">&#x27;comment&#x27;</span>]</span><br><span class="line">print(urlunsplit(data))</span><br><span class="line"><span class="comment">#http://www.baidu.com/index.html?a=6#comment</span></span><br></pre></td></tr></table></figure>



<h6 id="urljoin"><a href="#urljoin" class="headerlink" title="urljoin"></a>urljoin</h6><p>urlunparse å’Œ urlunsplit æˆ‘ä»¬å¯ä»¥å®Œæˆé“¾æ¥çš„åˆå¹¶ï¼Œä¸è¿‡å¿…é¡»æœ‰ç‰¹å®šçš„é•¿åº¦ï¼Œé“¾æ¥çš„æ¯ä¸€éƒ¨åˆ†éƒ½è¦æ¸…æ™°çš„åˆ†å¼€</p>
<p>ç”Ÿæˆé“¾æ¥è¿˜æœ‰ä¸ªæ–¹æ³• urljoin() æ–¹æ³•</p>
<p>å¯ä»¥æä¾›ä¸€ä¸ª base_url åŸºç¡€é“¾æ¥ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå°†æ–°çš„é“¾æ¥ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°</p>
<p>è¯¥æ–¹æ³•ä¼šåˆ†æ base_url çš„ schemeã€netlocã€å’Œpath è¿™3ä¸ªå†…å®¹å¯¹æ–°é“¾æ¥ç¼ºå¤±çš„éƒ¨åˆ†è¿›è¡Œè¡¥å……</p>
<p>å®ç°è¿æ¥æ‹¼åˆä¸ç”Ÿæˆ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urljoin</span><br><span class="line"></span><br><span class="line">print(urljoin(<span class="string">&#x27;http://www.baidu.com&#x27;</span>, <span class="string">&#x27;FAQ.html&#x27;</span>))</span><br><span class="line">print(urljoin(<span class="string">&#x27;http://www.baidu.com&#x27;</span>, <span class="string">&#x27;https://cuiqingcai.com/FAQ.html&#x27;</span>))</span><br><span class="line">print(urljoin(<span class="string">&#x27;http://www.baidu.com/about.html&#x27;</span>, <span class="string">&#x27;https://cuiqingcai.com/FAQ.html&#x27;</span>))</span><br><span class="line">print(urljoin(<span class="string">&#x27;http://www.baidu.com/about.html&#x27;</span>, <span class="string">&#x27;https://cuiqingcai.com/FAQ.html?question=2&#x27;</span>))</span><br><span class="line">print(urljoin(<span class="string">&#x27;http://www.baidu.com?wd=abc&#x27;</span>, <span class="string">&#x27;https://cuiqingcai.com/index.php&#x27;</span>))</span><br><span class="line">print(urljoin(<span class="string">&#x27;http://www.baidu.com&#x27;</span>, <span class="string">&#x27;?category=2#comment&#x27;</span>))</span><br><span class="line">print(urljoin(<span class="string">&#x27;www.baidu.com&#x27;</span>, <span class="string">&#x27;?category=2#comment&#x27;</span>))</span><br><span class="line">print(urljoin(<span class="string">&#x27;www.baidu.com#comment&#x27;</span>, <span class="string">&#x27;?category=2&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>ç»“æœ</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">http://www.baidu.com/FAQ.html</span><br><span class="line">https://cuiqingcai.com/FAQ.html</span><br><span class="line">https://cuiqingcai.com/FAQ.html</span><br><span class="line">https://cuiqingcai.com/FAQ.html?question=2</span><br><span class="line">https://cuiqingcai.com/index.php</span><br><span class="line">http://www.baidu.com?category=2#comment</span><br><span class="line">www.baidu.com?category=2#comment</span><br><span class="line">www.baidu.com?category=2</span><br></pre></td></tr></table></figure>

<p>base_url æä¾›äº†ä¸‰é¡¹å†…å®¹ schemeã€netlocã€path</p>
<p>å¦‚æœ3é¡¹åœ¨æ–°é“¾æ¥ä¸å­˜åœ¨å°±è¡¥å……ï¼Œæ–°é“¾æ¥å­˜åœ¨å°±ä½¿ç”¨æ–°é“¾æ¥éƒ¨åˆ†ï¼Œbase_url é‡Œçš„å°±ä¸èµ·ä½œç”¨äº†ï¼Œä»¥å³è¾¹æ–°é“¾æ¥ä¸ºå‡†</p>
<h6 id="urlencode"><a href="#urlencode" class="headerlink" title="urlencode"></a>urlencode</h6><p>å°†å­—å…¸åºåˆ—åŒ–ä¸º GET è¯·æ±‚å‚æ•°</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlencode</span><br><span class="line">params = &#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;germey&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;age&#x27;</span>: <span class="number">22</span></span><br><span class="line">&#125;</span><br><span class="line">base_url = <span class="string">&#x27;http://www.baidu.com?&#x27;</span></span><br><span class="line">url = base_url + urlencode(params)</span><br><span class="line">print(url)</span><br></pre></td></tr></table></figure>

<h6 id="parse-qs"><a href="#parse-qs" class="headerlink" title="parse_qs"></a>parse_qs</h6><p>å°†è¯·æ±‚å‚æ•°ååºåˆ—åŒ–æˆå­—å…¸ç±»å‹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> parse_qs</span><br><span class="line">query = <span class="string">&#x27;name=germey&amp;age=22&#x27;</span></span><br><span class="line">print(parse_qs(query))</span><br><span class="line"><span class="comment">#ç»“æœ &#123;&#x27;name&#x27;:[&#x27;germey&#x27;],&#x27;age&#x27;:[&#x27;22&#x27;]&#125;</span></span><br></pre></td></tr></table></figure>



<h6 id="parse-sql"><a href="#parse-sql" class="headerlink" title="parse_sql"></a>parse_sql</h6><p>å°†å‚æ•°è½¬åŒ–æˆå…ƒç»„ç»„æˆçš„åˆ—è¡¨</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> parse_qsl</span><br><span class="line">query = <span class="string">&#x27;name=germey&amp;age=2&#x27;</span></span><br><span class="line">print(parse_qsl(query))</span><br><span class="line"><span class="comment">#ç»“æœ [(&#x27;name&#x27;, &#x27;germey&#x27;), (&#x27;age&#x27;, &#x27;2&#x27;)]</span></span><br></pre></td></tr></table></figure>

<h6 id="quote"><a href="#quote" class="headerlink" title="quote"></a>quote</h6><p>å°†å†…å®¹è½¬åŒ–ä¸º URL ç¼–ç æ ¼å¼ï¼ŒURL ä¸­å¸¦ä¸­æ–‡å‚æ•°æ—¶ï¼Œå¯èƒ½å¯¼è‡´ä¹±ç é—®é¢˜ï¼Œç”¨è¿™ä¸ªå¯ä»¥å°†ä¸­æ–‡å­—ç¬¦è½¬åŒ–ä¸º URL ç¼–ç </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line">keyword = <span class="string">&#x27;æµ‹è¯•&#x27;</span></span><br><span class="line">url = <span class="string">&#x27;https://baidu.com/s?wd=&#x27;</span> + quote(keyword)</span><br><span class="line"><span class="comment">#ç»“æœï¼šhttps://baidu.com/s?wd=%E5%joj</span></span><br></pre></td></tr></table></figure>

<h6 id="unquote"><a href="#unquote" class="headerlink" title="unquote"></a>unquote</h6><p>å¯ä»¥è¿›è¡Œ URL è§£ç ï¼Œå°†ç¼–ç åçš„ç»“æœè¿›è¡Œè§£ç </p>
<h5 id="åˆ†æ-Robots-åè®®"><a href="#åˆ†æ-Robots-åè®®" class="headerlink" title="åˆ†æ Robots åè®®"></a>åˆ†æ Robots åè®®</h5><p>urllib çš„ robotparser æ¨¡å—ï¼Œå¯ä»¥å®ç°ç½‘ç«™ Robots åè®®çš„åˆ†æ</p>
<h6 id="Robots-åè®®"><a href="#Robots-åè®®" class="headerlink" title="Robots åè®®"></a>Robots åè®®</h6><p>çˆ¬è™«åè®®ï¼Œå…¨åå«ç½‘ç»œçˆ¬è™«æ’é™¤æ ‡å‡†ï¼Œå‘Šè¯‰çˆ¬è™«å’Œæœç´¢å¼•æ“å“ªäº›é¡µé¢å¯ä»¥æŠ“å–ä¸æŠ“å–ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ª robots.txt åè®®ï¼Œä¸€èˆ¬æ”¾åœ¨ç½‘ç«™æ ¹ç›®å½•ä¸‹ï¼Œæ ·ä¾‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Uaser-agent: *</span><br><span class="line">Disallow: &#x2F;   </span><br><span class="line">Allow: &#x2F;public&#x2F;</span><br></pre></td></tr></table></figure>

<p>è¿™é™å®šäº†æ‰€æœ‰æœç´¢çˆ¬è™«åªèƒ½çˆ¬å– public ç›®å½•ï¼ŒUser-agent æè¿°äº†çˆ¬è™«çš„åç§°ï¼Œè®¾ç½®ä¸º * ä»£è¡¨ Robots åè®®å¯¹æ‰€æœ‰çˆ¬è™«éƒ½æœ‰æ•ˆ</p>
<p>User-agent: Baiduspider ä»£è¡¨è®¾ç½®çš„è§„åˆ™å¯¹ç™¾åº¦æ˜¯æœ‰æ•ˆçš„ï¼Œå¦‚æœæœ‰å¤šæ¡User-agentè®°å½•ï¼Œåˆ™æ„å‘³ç€å¤šä¸ªçˆ¬è™«ä¼šå—åˆ°é™åˆ¶</p>
<p>Disallow: /   ä»£è¡¨ä¸å…è®¸çˆ¬å–æ‰€æœ‰é¡µé¢</p>
<h6 id="robotparser"><a href="#robotparser" class="headerlink" title="robotparser"></a>robotparser</h6><p>äº†è§£ Robots åè®®ä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨ robotparse æ¨¡å—æ¥è§£æ robots.txt äº†ï¼Œè¯¥æ¨¡å—æä¾›äº†ä¸€ä¸ªç±» RobotFileParseï¼Œå®ƒå¯ä»¥æ ¹æ®æŸç½‘ç«™çš„ robots.txt æ–‡ä»¶æ¥åˆ¤æ–­ä¸€ä¸ªçˆ¬è™«æ˜¯å¦æœ‰æƒé™æ¥çˆ¬å–è¿™ä¸ªç½‘é¡µ</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.robotparser <span class="keyword">import</span> RobotFileParser</span><br><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen</span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"></span><br><span class="line">ssl._create_default_https_context = ssl._create_unverified_context</span><br><span class="line">rp = RobotFileParser()</span><br><span class="line">rp.set_url(<span class="string">&#x27;https://www.jianshu.com/robots.txt&#x27;</span>)</span><br><span class="line">rp.read()</span><br><span class="line"><span class="comment">#åˆ¤æ–­ç½‘é¡µæ˜¯å¦å¯ä»¥è¢«æŠ“å–</span></span><br><span class="line">print(rp.can_fetch(<span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;https://www.jianshu.com/p/823596514412&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>å¸¸ç”¨å‡ ä¸ªæ–¹æ³•ï¼š</p>
<p>set_url()ï¼šè®¾ç½® robots.txt æ–‡ä»¶çš„é“¾æ¥</p>
<p>read()ï¼šè¯»å– robots.txt æ–‡ä»¶å¹¶è¿›è¡Œåˆ†æï¼Œä¸ä¼šè¿”å›ä»»ä½•å†…å®¹ï¼Œä½†æ‰§è¡Œäº†è¯»å–æ“ä½œ</p>
<p>parse()ï¼šç”¨æ¥è§£æ robots.txt æ–‡ä»¶ï¼Œä¼ å…¥çš„å‚æ•°æ˜¯ robots.txt æŸäº›è¡Œçš„å†…å®¹</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rp.parse(urlopen(<span class="string">&#x27;https://www.baidu.com/rotots.txt&#x27;</span>).read().decode(<span class="string">&#x27;utf-8&#x27;</span>).split(<span class="string">&#x27;\n&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>can_fetch()ï¼šä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ª User-agentï¼Œç¬¬äºŒä¸ªè¦æŠ“å–çš„URLï¼Œè¿”å›è¯¥æœç´¢å¼•æ“æ˜¯å¦å¯ä»¥æŠ“å–è¿™ä¸ªURL</p>
<p>mtime()ï¼šè¿”å›ä¸Šæ¬¡æŠ“å–å’Œåˆ†æ robots.txt æ—¶é—´</p>
<h4 id="ä½¿ç”¨-Request"><a href="#ä½¿ç”¨-Request" class="headerlink" title="ä½¿ç”¨ Request"></a>ä½¿ç”¨ Request</h4><p>urllib POSTã€PUT ç­‰è¯·æ±‚æ—¶çš„å†™æ³•ä¸å¤ªæ–¹ä¾¿ï¼Œå¤„ç†ç½‘é¡µéªŒè¯å’Œ Cookie æ—¶éœ€å†™ Opener å’Œ Handler ç±»æ¥å¤„ç†</p>
<h5 id="GET-è¯·æ±‚"><a href="#GET-è¯·æ±‚" class="headerlink" title="GET è¯·æ±‚"></a>GET è¯·æ±‚</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">r = requests.get(<span class="string">&#x27;https://www.baidu.com/&#x27;</span>)</span><br><span class="line">print(<span class="built_in">type</span>(r))</span><br><span class="line">print(r.status_code)</span><br><span class="line">print(<span class="built_in">type</span>(r.text))</span><br><span class="line">print(r.text)</span><br><span class="line">print(r.cookies)</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨ get() æ–¹æ³•å®ç°ä¸ urlopen ç›¸åŒçš„æ“ä½œï¼Œå¾—åˆ°ä¸€ä¸ª Response å¯¹è±¡</p>
<h6 id="GETå¸¦å‚æ•°"><a href="#GETå¸¦å‚æ•°" class="headerlink" title="GETå¸¦å‚æ•°"></a>GETå¸¦å‚æ•°</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>  requests</span><br><span class="line">params = &#123;</span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;germey&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;age&#x27;</span>: <span class="number">22</span></span><br><span class="line">&#125;</span><br><span class="line">r = requests.get(<span class="string">&#x27;http://httpbin.org/get&#x27;</span>, params=params)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure>

<p>ç½‘é¡µçš„è¿”å›ç±»å‹å®é™…ä¸Šæ˜¯ str ç±»å‹ï¼Œæ˜¯JSONæ ¼å¼çš„ï¼Œå¦‚æœæƒ³å¾—åˆ°J SON æ ¼å¼æ•°æ®</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">print(r.json())</span><br></pre></td></tr></table></figure>

<p>å¦‚æœè¿”å›ç»“æœä¸æ˜¯ JSON æ ¼å¼ï¼Œä¼šå‡ºç°è§£æé”™è¯¯ï¼ŒæŠ›å‡º json.decoder.JSONDecodeError å¼‚å¸¸</p>
<h6 id="è·å–äºŒè¿›åˆ¶æ•°æ®"><a href="#è·å–äºŒè¿›åˆ¶æ•°æ®" class="headerlink" title="è·å–äºŒè¿›åˆ¶æ•°æ®"></a>è·å–äºŒè¿›åˆ¶æ•°æ®</h6><p>å›¾ç‰‡ã€éŸ³é¢‘ã€è§†é¢‘è¿™äº›æ–‡ä»¶æœ¬è´¨ä¸Šéƒ½æ˜¯äºŒè¿›åˆ¶ç ç»„æˆ</p>
<p>æå–å›¾ç‰‡ä¿å­˜ä¸‹æ¥</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">r = requests.get(<span class="string">&#x27;https://github.com/favicon.ico&#x27;</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;vavicon.ico&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f: <span class="comment">#wbå†™å…¥</span></span><br><span class="line">    f.write(r.content)</span><br><span class="line"><span class="comment">#è°ƒç”¨äº†openæ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ–‡ä»¶åï¼Œç¬¬äºŒä¸ªå‚æ•°ä»£è¡¨ä»¥äºŒè¿›åˆ¶å†™çš„å½¢å¼æ‰“å¼€ï¼Œå¯ä»¥å‘æ–‡ä»¶å†™å…¥äºŒè¿›åˆ¶æ•°æ®</span></span><br></pre></td></tr></table></figure>

<h5 id="POST-è¯·æ±‚"><a href="#POST-è¯·æ±‚" class="headerlink" title="POST è¯·æ±‚"></a>POST è¯·æ±‚</h5><p>request.post(â€¦)</p>
<h5 id="æ–‡ä»¶ä¸Šä¼ "><a href="#æ–‡ä»¶ä¸Šä¼ " class="headerlink" title="æ–‡ä»¶ä¸Šä¼ "></a>æ–‡ä»¶ä¸Šä¼ </h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">files = &#123;<span class="string">&#x27;file&#x27;</span>: <span class="built_in">open</span>(<span class="string">&#x27;favicon.ico&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>)&#125; <span class="comment">#rbè¯»å–</span></span><br><span class="line">r = requests.post(<span class="string">&#x27;https://httpbin.org/post&#x27;</span>, files=files)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure>

<h5 id="Cookies"><a href="#Cookies" class="headerlink" title="Cookies"></a>Cookies</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">r = requests.get(<span class="string">&#x27;https://www.baidu.com&#x27;</span>)</span><br><span class="line">print(r.cookies)<span class="comment">#RequestsCookieJar</span></span><br><span class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> r.cookies.items():</span><br><span class="line">    print(key+<span class="string">&#x27;=&#x27;</span>+value)</span><br></pre></td></tr></table></figure>

<p>æ¨¡æ‹ŸCookiesï¼Œæ”¾ headersé‡Œé¢</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">headers = &#123;</span><br><span class="line">	<span class="string">&#x27;Cookie&#x27;</span>: <span class="string">&#x27;xxx&#x27;</span></span><br><span class="line">  <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;xxx&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">r = request.get(<span class="string">&#x27;https://xxxx&#x27;</span>, headers=headers)</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ä»¥é€šè¿‡ cookies å‚æ•°æ¥è®¾ç½®ï¼Œä¸è¿‡éœ€è¦æ„å»º RequestsCookieJarå¯¹è±¡ï¼Œç„¶åå¤åˆ¶ä¸‹æ¥çš„ cookies åˆ©ç”¨ split æ–¹æ³•åˆ†å‰²ï¼Œå†åˆ©ç”¨ set æ–¹æ³•è®¾ç½®å¥½æ¯ä¸ª Cookie çš„ key å’Œ value</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cookies = <span class="string">&#x27;xxx;xxx;xxx;&#x27;</span></span><br><span class="line">jar = requests.cookies.RequestsCookieJar()</span><br><span class="line"><span class="keyword">for</span> cookies <span class="keyword">in</span> cookies.split(<span class="string">&#x27;;&#x27;</span>):</span><br><span class="line">  key, value = cookie.split(<span class="string">&#x27;=&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">  jar.<span class="built_in">set</span>(key, value)</span><br><span class="line">r = request.get(<span class="string">&#x27;https://xxxx&#x27;</span>, cookies=jar)</span><br></pre></td></tr></table></figure>



<h5 id="ä¼šè¯ç»´æŒ"><a href="#ä¼šè¯ç»´æŒ" class="headerlink" title="ä¼šè¯ç»´æŒ"></a>ä¼šè¯ç»´æŒ</h5><p>æ–¹ä¾¿ç»´æŒä¸€ä¸ªä¼šè¯ï¼Œä¸ç”¨æ‹…å¿ƒ cookies é—®é¢˜</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">requests.get(<span class="string">&#x27;http://httpbin.org/cookies/set/number/123456&#x27;</span>)<span class="comment">#è¯·æ±‚è¿™ä¸ªç½‘å€æ—¶å¯ä»¥è®¾ç½®ä¸€ä¸ªcookie</span></span><br><span class="line">r = requests.get(<span class="string">&#x27;http://httpbin.org/cookies&#x27;</span>)</span><br><span class="line">print(r.text)</span><br><span class="line"><span class="comment">#ç»“æœ&#123;&quot;cookies&quot;: &#123;&#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢æ˜¯ä¸¤ä¸ªä¸ç›¸å…³çš„ä¼šè¯ï¼Œç¬¬ä¸€ä¸ªè®¾ç½®äº† cookiesï¼Œç¬¬äºŒä¸ª cookies ä¸ºç©º</p>
<p>ä½¿ç”¨ session</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s = requests.session()</span><br><span class="line">s.get(<span class="string">&#x27;http://httpbin.org/cookies/set/number/123456&#x27;</span>)</span><br><span class="line">r = s.get(<span class="string">&#x27;http://httpbin.org/cookies&#x27;</span>)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure>

<p>æˆåŠŸè·å–ï¼Œä¸¤ä¸ªè¯·æ±‚åœ¨åŒä¸€ä¼šè¯ï¼Œä¸ç”¨æ‹…å¿ƒ cookies é—®é¢˜</p>
<p>é€šå¸¸ç”¨äºæ¨¡æ‹Ÿç™»å½•æˆåŠŸä¹‹åå†è¿›è¡Œä¸‹ä¸€æ­¥çš„æ“ä½œ</p>
<h5 id="SSL-è¯ä¹¦éªŒè¯"><a href="#SSL-è¯ä¹¦éªŒè¯" class="headerlink" title="SSL è¯ä¹¦éªŒè¯"></a>SSL è¯ä¹¦éªŒè¯</h5><p>è¯·æ±‚ä¸€ä¸ª HTTPS ç«™ç‚¹ï¼Œä½†è¯ä¹¦éªŒè¯é”™è¯¯çš„é¡µé¢ï¼Œä¼šæŠ¥ SSLError é”™è¯¯ï¼Œå¦‚ä½•é¿å…è¿™ä¸ªé”™è¯¯ï¼Ÿ</p>
<p>request æä¾›äº†è¯ä¹¦éªŒè¯çš„åŠŸèƒ½ï¼Œä½¿ç”¨ verify å‚æ•°æ§åˆ¶æ˜¯å¦æ£€æŸ¥è¯ä¹¦</p>
<p>å°† verify å‚æ•°è®¾ç½®ä¸º False å³å¯</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response = requests.get(<span class="string">&#x27;https://www.12306.cn&#x27;</span>, verify=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>ä¸è¿‡ä¼šæŠ¥è­¦å‘Šï¼Œå»ºè®®æˆ‘ä»¬æŒ‡å®šè¯ä¹¦ï¼Œå¯ä»¥è®¾ç½®å¿½ç•¥è­¦å‘Šçš„æ–¹å¼å±è”½è­¦å‘Š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> request.packages <span class="keyword">import</span> urllib3</span><br><span class="line">urllib3.disable.warnings()</span><br><span class="line">response = requests.get(<span class="string">&#x27;https://www.12306.cn&#x27;</span>, verify=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>æˆ–è€…æ•è·è­¦å‘Šåˆ°æ—¥å¿—æ–¹å¼å¿½ç•¥è­¦å‘Š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">logging.captureWarning(<span class="literal">True</span>)</span><br><span class="line">response = requests.get(<span class="string">&#x27;https://www.12306.cn&#x27;</span>, verify=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>å½“ç„¶ä¹Ÿå¯ä»¥æŒ‡å®šæœ¬åœ°è¯ä¹¦ç”¨ä½œå®¢æˆ·ç«¯è¯ä¹¦ï¼Œè¿™å¯ä»¥æ˜¯å•ä¸ªæ–‡ä»¶ï¼ˆåŒ…å«ç§˜é’¥å’Œè¯ä¹¦ï¼‰æˆ–ä¸€ä¸ªåŒ…å«ä¸¤ä¸ªæ–‡ä»¶è·¯å¾„çš„å…ƒç»„</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response = requests.get(<span class="string">&#x27;https://www.12306.cn&#x27;</span>, cert=(<span class="string">&#x27;/path/server.crt&#x27;</span>, <span class="string">&#x27;/path/key&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬éœ€è¦æœ‰ crt å’Œ key æ–‡ä»¶ï¼Œä¸”æŒ‡å®šè·¯å¾„ã€‚æœ¬åœ°ç§æœ‰è¯ä¹¦çš„keyå¿…é¡»æ˜¯è§£å¯†çŠ¶æ€</p>
<h5 id="èº«ä»½è®¤è¯"><a href="#èº«ä»½è®¤è¯" class="headerlink" title="èº«ä»½è®¤è¯"></a>èº«ä»½è®¤è¯</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> requests.auth <span class="keyword">import</span> HTTPBasicAuth</span><br><span class="line"></span><br><span class="line">r = requests.get(<span class="string">&#x27;https://ssr3.scrape.center&#x27;</span>, auth=HTPBasicAuth(<span class="string">&#x27;admin&#x27;</span>,<span class="string">&#x27;admin&#x27;</span>))</span><br><span class="line">print(r.status_code)</span><br></pre></td></tr></table></figure>

<p>æ›´ç®€å•å†™æ³•ï¼Œç›´æ¥ä¼ å…ƒç»„ï¼Œä¼šé»˜è®¤ä½¿ç”¨ HTPBasicAuth ç±»æ¥è®¤è¯</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r = requests.get(<span class="string">&#x27;https://ssr3.scrape.center&#x27;</span>, auth=(<span class="string">&#x27;admin&#x27;</span>,<span class="string">&#x27;admin&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>requests åº“è¿˜æä¾›äº†å…¶ä»–è®¤è¯æ–¹å¼ï¼Œå¦‚ OAuth è®¤è¯ï¼Œéœ€è¦å®‰è£… oauth åŒ…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install requests_oauthlib</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> requests_oauthlib <span class="keyword">import</span> OAuth1</span><br><span class="line">url = <span class="string">&#x27;xxxx&#x27;</span></span><br><span class="line">auth = OAuth1(<span class="string">&#x27;YOUR_APP_KEY&#x27;</span>,<span class="string">&#x27;YOUR_APP_SECRET&#x27;</span>,<span class="string">&#x27;USER_OAUTH_TOKEN&#x27;</span>,<span class="string">&#x27;USER_OAUTH_TOKEN_SECRET&#x27;</span>)</span><br><span class="line">requests.get(url, auth=auth)</span><br></pre></td></tr></table></figure>



<h5 id="ä»£ç†è®¾ç½®"><a href="#ä»£ç†è®¾ç½®" class="headerlink" title="ä»£ç†è®¾ç½®"></a>ä»£ç†è®¾ç½®</h5><p>æŸäº›ç½‘ç«™æµ‹è¯•è¯·æ±‚å‡ æ¬¡èƒ½æ­£å¸¸è·å–ï¼Œä¸€æ—¦å¤§è§„æ¨¡çˆ¬å–ï¼Œç½‘ç«™å¯èƒ½ä¼šå¼¹å‡ºéªŒè¯ç æˆ–è·³è½¬ç™»å½•é¡µé¢å†…</p>
<p>ç”¨ä»£ç†æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±è¦ç”¨åˆ° proxies å‚æ•°</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">proxies = &#123;</span><br><span class="line">  <span class="string">&quot;http&quot;</span>: <span class="string">&quot;http://10.10.1.10:3128&quot;</span>,</span><br><span class="line">  <span class="string">&quot;http&quot;</span>: <span class="string">&quot;http://10.10.1.10:1080&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line">request.get(<span class="string">&quot;https://www.taobao.com&quot;</span>, proxiex=proxies)</span><br></pre></td></tr></table></figure>

<p>è‹¥ä»£ç†éœ€è¦ä½¿ç”¨ HTTP Basic Authï¼Œå¯ä»¥ä½¿ç”¨ç±»ä¼¼ <a href="http://user:pasword@host:port">http://user:pasword@host:port</a> è¿™æ ·çš„è¯­æ³•æ¥è®¾ç½®</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">proxiex = &#123;</span><br><span class="line">	<span class="string">&quot;http&quot;</span>: <span class="string">&quot;http://user:password@10.10.1.10:3128&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é™¤äº† HTTP ä»£ç†å¤–ï¼Œrequest è¿˜æ”¯æŒ SOCKS åè®®çš„ä»£ç†</p>
<p>éœ€è¦å®‰è£… socks è¿™ä¸ªåº“</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install <span class="string">&#x27;requests[socks]&#x27;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">proxies = &#123;</span><br><span class="line">  <span class="string">&quot;http&quot;</span>: <span class="string">&quot;socks5://user:password@host:port&quot;</span>,</span><br><span class="line">  <span class="string">&quot;http&quot;</span>: <span class="string">&quot;socks5://user:password@host:port&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line">request.get(<span class="string">&quot;https://www.httpbin.org/get&quot;</span>, proxiex=proxies)</span><br></pre></td></tr></table></figure>



<h5 id="Prepared-Request"><a href="#Prepared-Request" class="headerlink" title="Prepared Request"></a>Prepared Request</h5><p>ä»‹ç» urllib æ—¶ï¼Œå¯ä»¥å°†è¯·æ±‚è¡¨ç¤ºä¸ºæ•°æ®ç»“æ„ï¼Œå„ä¸ªå‚æ•°é€šè¿‡ä¸€ä¸ª Request å¯¹è±¡æ¥è¡¨ç¤ºã€‚è¿™é‡Œ requests ä¹Ÿå¯ä»¥åšåˆ°ï¼Œè¿™ä¸ªæ•°æ®ç»“æ„å« Prepared Request</p>
<p>æœ‰äº† Request è¿™ä¸ªå¯¹è±¡ï¼Œå°±å¯ä»¥å°†è¯·æ±‚å½“ä½œç‹¬ç«‹çš„å¯¹è±¡æ¥çœ‹å¾…ï¼Œè¿™æ ·åœ¨é˜Ÿåˆ—è°ƒåº¦æ—¶ä¼šéå¸¸æ–¹ä¾¿</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> requests.sessions <span class="keyword">import</span> Session</span><br><span class="line">s = Session()</span><br><span class="line">r = requests.get(<span class="string">&#x27;http://xxx&#x27;</span>)</span><br><span class="line">prepped = s.prepare_request(r)</span><br><span class="line">r = s.send(prepped)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨ Session çš„ prepare_request æ–¹æ³•å°†å…¶è½¬æ¢ä¸ºä¸€ä¸ª Prepared Request å¯¹è±¡ï¼Œç„¶åè°ƒç”¨ send æ–¹æ³•å‘é€å³å¯</p>
<h4 id="æ­£åˆ™è¡¨è¾¾å¼"><a href="#æ­£åˆ™è¡¨è¾¾å¼" class="headerlink" title="æ­£åˆ™è¡¨è¾¾å¼"></a>æ­£åˆ™è¡¨è¾¾å¼</h4><p>æ­£åˆ™è¡¨è¾¾å¼æµ‹è¯•å·¥å…· <a target="_blank" rel="noopener" href="http://tool.oschina.net/regex/">http://tool.oschina.net/regex/</a></p>
<h4 id="httpx"><a href="#httpx" class="headerlink" title="httpx"></a>httpx</h4><p>urllib å’Œ requests ä»…æ”¯æŒ HTTP/1.1ï¼Œä¸æ”¯æŒ HTTP/2.0ï¼Œhyper å’Œ httpx æ”¯æŒ</p>
<p>æ¡ˆä¾‹ï¼š<a target="_blank" rel="noopener" href="https://spa16.scrape.center/">https://spa16.scrape.center/</a> æ˜¯å¼ºåˆ¶ä½¿ç”¨ HTTP/2.0 è®¿é—®çš„ä¸€ä¸ªç½‘ç«™ï¼Œæµè§ˆå™¨æ‰“å¼€æŸ¥çœ‹ Network é¢æ¿ï¼Œçœ‹åˆ° Protocol ä¸€åˆ—éƒ½æ˜¯ h2</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install &#39;httpx[http2]&#39; #å³å®‰è£…äº†httpx åˆå®‰è£…äº†httpxå¯¹HTTP&#x2F;2.0çš„æ”¯æŒ</span><br></pre></td></tr></table></figure>

<p>httpx  å’Œ requests çš„å¾ˆå¤š API å­˜åœ¨ç›¸ä¼¼ä¹‹å¤„</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> httpx</span><br><span class="line">response = httpx.get(<span class="string">&#x27;https://www.httpbin.org/get&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>httpx é»˜è®¤æ˜¯ä¸ä¼šå¼€å¯å¯¹ HTTP/2.0 çš„æ”¯æŒçš„ï¼Œéœ€è¦æ‰‹åŠ¨å£°æ˜ä¸€ä¸‹æ‰èƒ½ä½¿ç”¨ HTTP/2.0 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> httpx</span><br><span class="line">client = httpx.Client(http2=<span class="literal">True</span>)</span><br><span class="line">response = client.get(<span class="string">&#x27;https://spa16.scrape.center/&#x27;</span>)</span><br><span class="line">print(response.text)</span><br></pre></td></tr></table></figure>

<h5 id="Client-å¯¹è±¡"><a href="#Client-å¯¹è±¡" class="headerlink" title="Client å¯¹è±¡"></a>Client å¯¹è±¡</h5><p>æ¨èä½¿ç”¨æ–¹å¼æ˜¯ with as è¯­å¥</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> httpx</span><br><span class="line"><span class="keyword">with</span> httpx.Client() <span class="keyword">as</span> client:</span><br><span class="line">  response = client.get(<span class="string">&#x27;https://www.httpbin.org/get&#x27;</span>)</span><br><span class="line">  print(response)</span><br></pre></td></tr></table></figure>

<p>ç­‰ä»·äº</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">client = httpx.Client()</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">	response = client.get(<span class="string">&#x27;https://www.httpbin.org/get&#x27;</span>)</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">  client.close()</span><br></pre></td></tr></table></figure>

<p>å£°æ˜ Client å¯¹è±¡æ—¶ï¼Œå¯ä»¥é¢å¤–æŒ‡å®šä¸€äº›å‚æ•°</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">headers = &#123;<span class="string">&#x27;User-Agent&#x27;</span>:<span class="string">&#x27;my-app/0.0.1&#x27;</span>&#125;</span><br><span class="line">client = httpx.Client(headers=headers)</span><br></pre></td></tr></table></figure>

<h5 id="æ”¯æŒå¼‚æ­¥è¯·æ±‚"><a href="#æ”¯æŒå¼‚æ­¥è¯·æ±‚" class="headerlink" title="æ”¯æŒå¼‚æ­¥è¯·æ±‚"></a>æ”¯æŒå¼‚æ­¥è¯·æ±‚</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> httpx</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">def</span> <span class="title">fetch</span>(<span class="params">url</span>):</span></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">with</span> httpx.AsyncClient(http2=<span class="literal">True</span>) <span class="keyword">as</span> client:</span><br><span class="line">    response = <span class="keyword">await</span> client.get(url)</span><br><span class="line">    print(response.text)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  asyncio.get_event_loop().run_until_complete(fetch(<span class="string">&#x27;https://www.httpbin.org/get&#x27;</span>))</span><br></pre></td></tr></table></figure>



<h4 id="çˆ¬è™«æ¡ˆä¾‹"><a href="#çˆ¬è™«æ¡ˆä¾‹" class="headerlink" title="çˆ¬è™«æ¡ˆä¾‹"></a>çˆ¬è™«æ¡ˆä¾‹</h4><p>æ¡ˆä¾‹é“¾æ¥ <a target="_blank" rel="noopener" href="https://ssr1.scrape.center/">https://ssr1.scrape.center/</a></p>
<h5 id="å¤šè¿›ç¨‹åŠ é€Ÿ"><a href="#å¤šè¿›ç¨‹åŠ é€Ÿ" class="headerlink" title="å¤šè¿›ç¨‹åŠ é€Ÿ"></a>å¤šè¿›ç¨‹åŠ é€Ÿ</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">page</span>):</span></span><br><span class="line">  index_html = scrape_index(page)</span><br><span class="line">  deatail_urls = parse_index(index_html)</span><br><span class="line">  <span class="keyword">for</span> detail_url <span class="keyword">in</span> detail_urls:</span><br><span class="line">    detail_html = scrape_detail(detail_html)</span><br><span class="line">    data = parse_detail(detail_html)</span><br><span class="line">    logging.info(<span class="string">&#x27;get detail data %s&#x27;</span>, data)</span><br><span class="line">    logging.info(<span class="string">&#x27;saving data to json data&#x27;</span>)</span><br><span class="line">    save_data(data)</span><br><span class="line">    logging.info(<span class="string">&#x27;data save success&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  pool = multiprocessing.Pool()</span><br><span class="line">  pages = <span class="built_in">range</span>(<span class="number">1</span>, TOTAL_PAGE+<span class="number">1</span>)</span><br><span class="line">  pool.<span class="built_in">map</span>(main, pages)</span><br><span class="line">  pool.close()</span><br><span class="line">  pool.join()</span><br></pre></td></tr></table></figure>

<p>å£°æ˜è¿›ç¨‹æ± ï¼Œè°ƒç”¨ map æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯è¦è°ƒç”¨çš„æ–¹æ³•ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯éœ€è¦éå†çš„é¡µç </p>
<p>è¿™æ ·ä¼šä¾æ¬¡éå† pages ä¸­çš„å†…å®¹ï¼ŒæŠŠ 1-10 è¿™ä¸ª10ä¸ªé¡µç åˆ†åˆ«ä¼ é€’ç»™ main æ–¹æ³•ï¼Œå¹¶æŠŠæ¯æ¬¡è°ƒç”¨åˆ†åˆ«å˜æˆä¸€ä¸ªè¿›ç¨‹ï¼ŒåŠ å…¥è¿›ç¨‹æ± ä¸­ï¼Œè¿›ç¨‹æ± ä¼šæ ¹æ®å½“å‰è¿è¡Œç¯å¢ƒæ¥å†³å®šè¿è¡Œå¤šå°‘ä¸ªè¿›ç¨‹</p>
<h4 id="æŠ“å–çŒ«çœ¼ç”µå½±æ’è¡Œ"><a href="#æŠ“å–çŒ«çœ¼ç”µå½±æ’è¡Œ" class="headerlink" title="æŠ“å–çŒ«çœ¼ç”µå½±æ’è¡Œ"></a>æŠ“å–çŒ«çœ¼ç”µå½±æ’è¡Œ</h4><p>(çˆ¬ä¸äº†äº†æœ‰æ»‘å—éªŒè¯)</p>
<p>ä¹¦æœ¬é…å¥—ä»£ç  <a target="_blank" rel="noopener" href="https://github.com/Python3WebSpider/MaoYan">https://github.com/Python3WebSpider/MaoYan</a></p>
<p>æ’è¡Œé“¾æ¥  <a target="_blank" rel="noopener" href="https://maoyan.com/board/4">https://maoyan.com/board/4</a></p>
<p>ç¬¬äºŒé¡µé“¾æ¥  <a target="_blank" rel="noopener" href="https://maoyan.com/board/4?offset=10">https://maoyan.com/board/4?offset=10</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> requests.exceptions <span class="keyword">import</span> RequestException</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_one_page</span>(<span class="params">url</span>):</span></span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		headers = &#123;</span><br><span class="line">			<span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10_6_10; en-us) AppleWebKit/534.50 (KHTML, like Gecko) Version/5.1 Safari/534.50&#x27;</span></span><br><span class="line">		&#125;</span><br><span class="line">		response = requests.get(url, headers=headers)</span><br><span class="line">		<span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">			<span class="keyword">return</span> response.text</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">	<span class="keyword">except</span> RequestException:</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	url = <span class="string">&#x27;https://maoyan.com/board/4&#x27;</span></span><br><span class="line">	html = get_one_page(url)</span><br><span class="line">	print(html)</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥é€šè¿‡æµè§ˆå™¨æŸ¥çœ‹æºç ï¼Œé€‰æ‹©ç½‘ç»œæŸ¥çœ‹åŸå§‹è¯·æ±‚éƒ¨åˆ†</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dd</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;board-index board-index-1&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/films/1200486&quot;</span> <span class="attr">title</span>=<span class="string">&quot;æˆ‘ä¸æ˜¯è¯ç¥&quot;</span> <span class="attr">class</span>=<span class="string">&quot;image-link&quot;</span> <span class="attr">data-act</span>=<span class="string">&quot;boarditem-click&quot;</span> <span class="attr">data-val</span>=<span class="string">&quot;&#123;movieId:1200486&#125;&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;//s3plus.meituan.net/v1/mss_e2821d7f0cfe4ac1bf9202ecf9590e67/cdn-prod/file:5788b470/image/loading_2.e3d934bf.png&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;poster-default&quot;</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">img</span> <span class="attr">data-src</span>=<span class="string">&quot;https://p0.meituan.net/movie/414176cfa3fea8bed9b579e9f42766b9686649.jpg@160w_220h_1e_1c&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;æˆ‘ä¸æ˜¯è¯ç¥&quot;</span> <span class="attr">class</span>=<span class="string">&quot;board-img&quot;</span> /&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;board-item-main&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;board-item-content&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;movie-item-info&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;name&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/films/1200486&quot;</span> <span class="attr">title</span>=<span class="string">&quot;æˆ‘ä¸æ˜¯è¯ç¥&quot;</span> <span class="attr">data-act</span>=<span class="string">&quot;boarditem-click&quot;</span> <span class="attr">data-val</span>=<span class="string">&quot;&#123;movieId:1200486&#125;&quot;</span>&gt;</span>æˆ‘ä¸æ˜¯è¯ç¥<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;star&quot;</span>&gt;</span>ä¸»æ¼”ï¼šå¾å³¥,å‘¨ä¸€å›´,ç‹ä¼ å›<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;releasetime&quot;</span>&gt;</span>ä¸Šæ˜ æ—¶é—´ï¼š2018-07-05<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">		  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  		<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;movie-item-number score-num&quot;</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;score&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;integer&quot;</span>&gt;</span>9.<span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fraction&quot;</span>&gt;</span>6<span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span>        </span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dd</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>ä¸€éƒ¨ç”µå½±ä¿¡æ¯å¯¹åº”æºç æ˜¯ä¸€ä¸ª dd èŠ‚ç‚¹</p>
<p>å…ˆè·å–æ’è¡Œä¿¡æ¯ï¼Œåœ¨ class ä¸º board-index çš„ i èŠ‚ç‚¹å†…ï¼Œæå– i èŠ‚ç‚¹å†…çš„ä¿¡æ¯</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;dd&gt;.*?board-index.*?&gt;(.*?)&lt;/i&gt;</span><br></pre></td></tr></table></figure>

<p>å›¾ç‰‡ä¿¡æ¯ï¼šdd åé¢æœ‰ä¸ª a èŠ‚ç‚¹ï¼Œå†…éƒ¨æœ‰ä¸¤ä¸ª img èŠ‚ç‚¹ï¼Œç¬¬äºŒä¸ª img èŠ‚ç‚¹çš„ data-src å±æ€§æ˜¯å›¾ç‰‡çš„é“¾æ¥ï¼Œæå–ç¬¬äºŒä¸ª img èŠ‚ç‚¹ data-sr å±æ€§</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;dd&gt;.*?board-index.*?&gt;(.*?)&lt;/i&gt;.*?data-src=&quot;(.*?)&quot;</span><br></pre></td></tr></table></figure>

<p>ç”µå½±åç§°ï¼šåé¢ p èŠ‚ç‚¹å†…ï¼Œ class ä¸º name</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;dd&gt;.*?board-index.*?&gt;(.*?)&lt;/i&gt;.*?data-src=&quot;(.*?)&quot;.*?name.*?&gt;(.*?)&lt;/a&gt;</span><br></pre></td></tr></table></figure>

<p>findall æå–</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pattern = re.<span class="built_in">compile</span>(<span class="string">&#x27;&lt;dd&gt;.*?board-index.*?&gt;(.*?)&lt;/i&gt;.*?data-src=&quot;(.*?)&quot;.*?name.*?&gt;(.*?)&lt;/a&gt;&#x27;</span>, re.S)</span><br><span class="line">items = re.findall(pattern, html)</span><br><span class="line">print(items)</span><br></pre></td></tr></table></figure>

<p>ç»“æœï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[(<span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;https://p0.meituan.net/movie/414176cfa3fea8bed9b579e9f42766b9686649.jpg@160w_220h_1e_1c&#x27;</span>, <span class="string">&#x27;&lt;a href=&quot;/films/1200486&quot; title=&quot;æˆ‘ä¸æ˜¯è¯ç¥&quot; data-act=&quot;boarditem-click&quot; data-val=&quot;&#123;movieId:1200486&#125;&quot;&gt;æˆ‘ä¸æ˜¯è¯ç¥&#x27;</span>), (<span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;https://p0.meituan.net/movie/8112a8345d7f1d807d026282f2371008602126.jpg@160w_220h_1e_1c&#x27;</span>, <span class="string">&#x27;&lt;a href=&quot;/films/1297&quot; title=&quot;è‚–ç”³å…‹çš„æ•‘èµ&quot; data-act=&quot;boarditem-click&quot; data-val=&quot;&#123;movieId:1297&#125;&quot;&gt;è‚–ç”³å…‹çš„æ•‘èµ&#x27;</span>), (<span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;https://p1.meituan.net/movie/c9b280de01549fcb71913edec05880585769972.jpg@160w_220h_1e_1c&#x27;</span>, <span class="string">&#x27;&lt;a href=&quot;/films/1206605&quot; title=&quot;ç»¿çš®ä¹¦&quot; data-act=&quot;boarditem-click&quot; data-val=&quot;&#123;movieId:1206605&#125;&quot;&gt;ç»¿çš®ä¹¦&#x27;</span>), (<span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;https://p0.meituan.net/movie/609e45bd40346eb8b927381be8fb27a61760914.jpg@160w_220h_1e_1c&#x27;</span>, <span class="string">&#x27;&lt;a href=&quot;/films/1292&quot; title=&quot;æµ·ä¸Šé’¢ç´å¸ˆ&quot; data-act=&quot;boarditem-click&quot; data-val=&quot;&#123;movieId:1292&#125;&quot;&gt;æµ·ä¸Šé’¢ç´å¸ˆ&#x27;</span>), (<span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;https://p1.meituan.net/movie/ac8f0004928fbce5a038a007b7c73cec746794.jpg@160w_220h_1e_1c&#x27;</span>, <span class="string">&#x27;&lt;a href=&quot;/films/1216365&quot; title=&quot;å°å·å®¶æ—&quot; data-act=&quot;boarditem-click&quot; data-val=&quot;&#123;movieId:1216365&#125;&quot;&gt;å°å·å®¶æ—&#x27;</span>), (<span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;https://p0.meituan.net/movie/61fea77024f83b3700603f6af93bf690585789.jpg@160w_220h_1e_1c&#x27;</span>, <span class="string">&#x27;&lt;a href=&quot;/films/1203&quot; title=&quot;éœ¸ç‹åˆ«å§¬&quot; data-act=&quot;boarditem-click&quot; data-val=&quot;&#123;movieId:1203&#125;&quot;&gt;éœ¸ç‹åˆ«å§¬&#x27;</span>), (<span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;https://p0.meituan.net/movie/005955214d5b3e50c910d7a511b0cb571445301.jpg@160w_220h_1e_1c&#x27;</span>, <span class="string">&#x27;&lt;a href=&quot;/films/1211270&quot; title=&quot;å“ªå’ä¹‹é­”ç«¥é™ä¸–&quot; data-act=&quot;boarditem-click&quot; data-val=&quot;&#123;movieId:1211270&#125;&quot;&gt;å“ªå’ä¹‹é­”ç«¥é™ä¸–&#x27;</span>), (<span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;https://p1.meituan.net/movie/580d81a2c78bf204f45323ddb4244b6c6821175.jpg@160w_220h_1e_1c&#x27;</span>, <span class="string">&#x27;&lt;a href=&quot;/films/1303&quot; title=&quot;ç¾ä¸½äººç”Ÿ&quot; data-act=&quot;boarditem-click&quot; data-val=&quot;&#123;movieId:1303&#125;&quot;&gt;ç¾ä¸½äººç”Ÿ&#x27;</span>), (<span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;https://p1.meituan.net/movie/6bea9af4524dfbd0b668eaa7e187c3df767253.jpg@160w_220h_1e_1c&#x27;</span>, <span class="string">&#x27;&lt;a href=&quot;/films/4055&quot; title=&quot;è¿™ä¸ªæ€æ‰‹ä¸å¤ªå†·&quot; data-act=&quot;boarditem-click&quot; data-val=&quot;&#123;movieId:4055&#125;&quot;&gt;è¿™ä¸ªæ€æ‰‹ä¸å¤ªå†·&#x27;</span>), (<span class="string">&#x27;10&#x27;</span>, <span class="string">&#x27;https://p0.meituan.net/moviemachine/c2496a7290a72eac6081321898c347693550574.jpg@160w_220h_1e_1c&#x27;</span>, <span class="string">&#x27;&lt;a href=&quot;/films/416&quot; title=&quot;ç›—æ¢¦ç©ºé—´&quot; data-act=&quot;boarditem-click&quot; data-val=&quot;&#123;movieId:416&#125;&quot;&gt;ç›—æ¢¦ç©ºé—´&#x27;</span>)]</span><br></pre></td></tr></table></figure>

<p>å†™å…¥æ–‡ä»¶</p>
<p>é€šè¿‡ JSONåº“çš„ dumps() æ–¹æ³•å®ç°å­—å…¸çš„åºåˆ—åŒ–ï¼Œensure_ascii ä¸º Falseï¼Œä¿è¯è¾“å‡ºç»“æœæ˜¯ä¸­æ–‡å½¢å¼è€Œä¸æ˜¯ Unicode ç¼–ç </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_to_file</span>(<span class="params">content</span>):</span></span><br><span class="line">	<span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;result.txt&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f: <span class="comment">#a appendingè¿½åŠ å†™å…¥</span></span><br><span class="line">		print(<span class="built_in">type</span>(json.dumps(content)))</span><br><span class="line">		f.write(json.dumps(content, ensure_ascii=<span class="literal">False</span>)+<span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>åˆ†é¡µçˆ¬å–ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">offset</span>):</span></span><br><span class="line">	url = <span class="string">&#x27;https://maoyan.com/board/4?offset=&#x27;</span> + <span class="built_in">str</span>(offset) </span><br><span class="line">	html = get_one_page(url)</span><br><span class="line">	pattern = re.<span class="built_in">compile</span>(<span class="string">&#x27;&lt;dd&gt;.*?board-index.*?&gt;(.*?)&lt;/i&gt;.*?data-src=&quot;(.*?)&quot;.*?name.*?&gt;(.*?)&lt;/a&gt;&#x27;</span>, re.S)</span><br><span class="line">	items = re.findall(pattern, html)</span><br><span class="line">	print(items)</span><br><span class="line">	write_to_file(items)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">		main(offset=i*<span class="number">10</span>)</span><br><span class="line">		time.sleep(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<h4 id=""><a href="#" class="headerlink" title=""></a></h4>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>





  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="ä¸Šä¸€é¡µ"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>



      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">daxun</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> å¼ºåŠ›é©±åŠ¨
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  <script src="/js/local-search.js"></script>















  








  

  

</body>
</html>
